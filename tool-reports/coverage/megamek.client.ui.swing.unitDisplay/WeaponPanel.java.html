<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="nl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WeaponPanel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">PlayerTest Coverage Results</a> &gt; <a href="index.source.html" class="el_package">megamek.client.ui.swing.unitDisplay</a> &gt; <span class="el_source">WeaponPanel.java</span></div><h1>WeaponPanel.java</h1><pre class="source lang-java linenums">package megamek.client.ui.swing.unitDisplay;

import java.awt.Color;
import java.awt.Dimension;
import java.awt.Font;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.Image;
import java.awt.Rectangle;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.KeyListener;
import java.awt.event.MouseEvent;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Comparator;
import java.util.List;
import java.util.Vector;

import javax.swing.AbstractListModel;
import javax.swing.DefaultComboBoxModel;
import javax.swing.DefaultListModel;
import javax.swing.JComboBox;
import javax.swing.JComponent;
import javax.swing.JLabel;
import javax.swing.JList;
import javax.swing.JScrollPane;
import javax.swing.JTextArea;
import javax.swing.SwingConstants;
import javax.swing.SwingUtilities;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import javax.swing.event.MouseInputAdapter;

import megamek.client.event.MechDisplayEvent;
import megamek.client.ui.GBC;
import megamek.client.ui.Messages;
import megamek.client.ui.swing.ClientGUI;
import megamek.client.ui.swing.FiringDisplay;
import megamek.client.ui.swing.MovementDisplay;
import megamek.client.ui.swing.TargetingPhaseDisplay;
import megamek.client.ui.swing.widget.BackGroundDrawer;
import megamek.client.ui.swing.widget.PMUtil;
import megamek.client.ui.swing.widget.PicMap;
import megamek.client.ui.swing.widget.SkinXMLHandler;
import megamek.client.ui.swing.widget.UnitDisplaySkinSpecification;
import megamek.common.Aero;
import megamek.common.AmmoType;
import megamek.common.BattleArmor;
import megamek.common.Compute;
import megamek.common.Configuration;
import megamek.common.Coords;
import megamek.common.Entity;
import megamek.common.FighterSquadron;
import megamek.common.IGame;
import megamek.common.IHex;
import megamek.common.ILocationExposureStatus;
import megamek.common.Infantry;
import megamek.common.Jumpship;
import megamek.common.LandAirMech;
import megamek.common.Mech;
import megamek.common.Mounted;
import megamek.common.RangeType;
import megamek.common.SmallCraft;
import megamek.common.Targetable;
import megamek.common.Terrains;
import megamek.common.WeaponComparatorArc;
import megamek.common.WeaponComparatorCustom;
import megamek.common.WeaponComparatorDamage;
import megamek.common.WeaponComparatorNum;
import megamek.common.WeaponComparatorRange;
import megamek.common.WeaponType;
import megamek.common.options.OptionsConstants;
import megamek.common.util.fileUtils.MegaMekFile;
import megamek.common.weapons.bayweapons.BayWeapon;
import megamek.common.weapons.gaussrifles.HAGWeapon;
import megamek.common.weapons.infantry.InfantryWeapon;

/**
 * This class contains the all the gizmos for firing the mech's weapons.
 */
public class WeaponPanel extends PicMap implements ListSelectionListener,
        ActionListener {
    
    /**
     * Mouse adaptor for the weapon list.  Supports rearranging the weapons
     * to define a custom ordering.
     *
     * @author arlith
     *
     */
<span class="nc" id="L92">    private class WeaponListMouseAdapter extends MouseInputAdapter {</span>

<span class="nc" id="L94">        private boolean mouseDragging = false;</span>
        private int dragSourceIndex;

        @Override
        public void mousePressed(MouseEvent e) {
<span class="nc bnc" id="L99" title="All 2 branches missed.">            if (SwingUtilities.isLeftMouseButton(e)) {</span>
<span class="nc" id="L100">                Object src = e.getSource();</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">                if (src instanceof JList) {</span>
<span class="nc" id="L102">                    dragSourceIndex = ((JList&lt;?&gt;) src).getSelectedIndex();</span>
<span class="nc" id="L103">                    mouseDragging = true;</span>
                }
            }
<span class="nc" id="L106">        }</span>

        @Override
        public void mouseReleased(MouseEvent e) {
<span class="nc" id="L110">            mouseDragging = false;</span>
<span class="nc" id="L111">        }</span>

        @Override
        public void mouseDragged(MouseEvent e) {
<span class="nc" id="L115">            removeListeners();</span>
            
<span class="nc" id="L117">            Object src = e.getSource();</span>
            // Check to see if we are in a state we care about
<span class="nc bnc" id="L119" title="All 4 branches missed.">            if (!mouseDragging || !(src instanceof JList)) {</span>
<span class="nc" id="L120">                return;</span>
            }
<span class="nc" id="L122">            JList&lt;?&gt; srcList = (JList&lt;?&gt;) src;</span>
<span class="nc" id="L123">            WeaponListModel srcModel = (WeaponListModel) srcList.getModel();</span>
<span class="nc" id="L124">            int currentIndex = srcList.locationToIndex(e.getPoint());</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">            if (currentIndex != dragSourceIndex) {</span>
<span class="nc" id="L126">                int dragTargetIndex = srcList.getSelectedIndex();</span>
<span class="nc" id="L127">                Mounted weap1 = srcModel.getWeaponAt(dragSourceIndex);</span>
<span class="nc" id="L128">                srcModel.swapIdx(dragSourceIndex, dragTargetIndex);</span>
<span class="nc" id="L129">                dragSourceIndex = currentIndex;</span>
<span class="nc" id="L130">                Entity ent = weap1.getEntity();</span>
                // Is the sort order custom?
<span class="nc" id="L132">                int customId = Entity.WeaponSortOrder.CUSTOM.ordinal();</span>
                // Update weap sort order drop down
<span class="nc bnc" id="L134" title="All 2 branches missed.">                if (weapSortOrder.getSelectedIndex() != customId) {</span>
                    // Set the order to custom
<span class="nc" id="L136">                    ent.setWeaponSortOrder(Entity.WeaponSortOrder.CUSTOM);</span>
<span class="nc" id="L137">                    weapSortOrder.setSelectedIndex(customId);</span>
                }
                // Update custom order
<span class="nc bnc" id="L140" title="All 2 branches missed.">                for (int i = 0; i &lt; srcModel.getSize(); i++) {</span>
<span class="nc" id="L141">                    Mounted m = srcModel.getWeaponAt(i);</span>
<span class="nc" id="L142">                    ent.setCustomWeaponOrder(m, i);</span>
                }
<span class="nc bnc" id="L144" title="All 2 branches missed.">                if (unitDisplay.getClientGUI() != null) {</span>
<span class="nc" id="L145">                    unitDisplay.getClientGUI().getMenuBar()</span>
<span class="nc" id="L146">                            .updateSaveWeaponOrderMenuItem();</span>
                }
            }
<span class="nc" id="L149">            addListeners();</span>
<span class="nc" id="L150">        }</span>
    }
    
    /**
     * ListModel implementation that supports keeping track of a list of Mounted
     * instantiations, how to display them in the JList, and an ability to sort
     * the Mounteds given WeaponComparators.
     *
     * @author arlith
     *
     */
    class WeaponListModel extends AbstractListModel&lt;String&gt; {

        /**
         *
         */
        private static final long serialVersionUID = 6312003196674512339L;

        /**
         * A collection of Mounted instantiations.
         */
        private ArrayList&lt;Mounted&gt; weapons;

        /**
         * The Entity that owns the collection of Mounteds.
         */
        private Entity en;

<span class="nc" id="L178">        WeaponListModel(Entity e) {</span>
<span class="nc" id="L179">            en = e;</span>
<span class="nc" id="L180">            weapons = new ArrayList&lt;Mounted&gt;();</span>
<span class="nc" id="L181">        }</span>

        /**
         * Add a new weapon to the list.
         *
         * @param w
         */
        public void addWeapon(Mounted w) {
<span class="nc" id="L189">            weapons.add(w);</span>
<span class="nc" id="L190">            fireIntervalAdded(this,weapons.size()-1, weapons.size()-1);</span>
<span class="nc" id="L191">        }</span>

        /**
         * Given the equipment (weapon) id, return the index in the (possibly
         * sorted) list of Mounteds.
         *
         * @param weaponId
         * @return
         */
        public int getIndex(int weaponId) {
<span class="nc" id="L201">            Mounted mount = en.getEquipment(weaponId);</span>
<span class="nc bnc" id="L202" title="All 2 branches missed.">            for (int i = 0; i &lt; weapons.size(); i++) {</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">                if (weapons.get(i).equals(mount)) {</span>
<span class="nc" id="L204">                    return i;</span>
                }
            }
<span class="nc" id="L207">            return -1;</span>
        }

        public void removeAllElements() {
<span class="nc" id="L211">            int numWeapons = weapons.size() - 1;</span>
<span class="nc" id="L212">            weapons.clear();</span>
<span class="nc" id="L213">            fireIntervalRemoved(this, 0, numWeapons);</span>
<span class="nc" id="L214">        }</span>

        /**
         * Swap the Mounteds at the two specified index values.
         *
         * @param idx1
         * @param idx2
         */
        public void swapIdx(int idx1, int idx2) {
            // Bounds checking
<span class="nc bnc" id="L224" title="All 8 branches missed.">            if ((idx1 &gt;= weapons.size()) || (idx2 &gt;= weapons.size())</span>
                    || (idx1 &lt; 0) || (idx2 &lt; 0)) {
<span class="nc" id="L226">                return;</span>
            }
<span class="nc" id="L228">            Mounted m1 = weapons.get(idx1);</span>
<span class="nc" id="L229">            weapons.set(idx1, weapons.get(idx2));</span>
<span class="nc" id="L230">            weapons.set(idx2, m1);</span>
<span class="nc" id="L231">            fireContentsChanged(this, idx1, idx1);</span>
<span class="nc" id="L232">            fireContentsChanged(this, idx2, idx2);</span>
<span class="nc" id="L233">        }</span>

        public Mounted getWeaponAt(int index) {
<span class="nc" id="L236">            return weapons.get(index);</span>
        }

        /**
         * Given an index into the (possibly sorted) list of Mounted, return a
         * text description.  This consists of the Mounted's description, as
         * well as additional information like location, whether the Mounted is
         * shot/jammed/destroyed, etc.  This is what the JList will display.
         */
        @Override
        public String getElementAt(int index) {
<span class="nc" id="L247">            final Mounted mounted = weapons.get(index);</span>
<span class="nc" id="L248">            final WeaponType wtype = (WeaponType) mounted.getType();</span>
<span class="nc" id="L249">            IGame game = null;</span>
<span class="nc bnc" id="L250" title="All 2 branches missed.">            if (unitDisplay.getClientGUI() != null) {</span>
<span class="nc" id="L251">                game = unitDisplay.getClientGUI().getClient().getGame();</span>
            }

<span class="nc" id="L254">            StringBuilder wn = new StringBuilder(mounted.getDesc());</span>
<span class="nc" id="L255">            wn.append(&quot; [&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L256">            wn.append(en.getLocationAbbr(mounted.getLocation()));</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">            if (mounted.isSplit()) {</span>
<span class="nc" id="L258">                wn.append('/');</span>
<span class="nc" id="L259">                wn.append(en.getLocationAbbr(mounted.getSecondLocation()));</span>
            }
<span class="nc" id="L261">            wn.append(']');</span>
            // determine shots left &amp; total shots left
<span class="nc bnc" id="L263" title="All 2 branches missed.">            if ((wtype.getAmmoType() != AmmoType.T_NA)</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">                    &amp;&amp; (!wtype.hasFlag(WeaponType.F_ONESHOT)</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">                            || wtype.hasFlag(WeaponType.F_BA_INDIVIDUAL))</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">                    &amp;&amp; (wtype.getAmmoType() != AmmoType.T_INFANTRY)) {</span>
<span class="nc" id="L267">                int shotsLeft = 0;</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">                if ((mounted.getLinked() != null)</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">                    &amp;&amp; !mounted.getLinked().isDumping()) {</span>
<span class="nc" id="L270">                    shotsLeft = mounted.getLinked().getUsableShotsLeft();</span>
                }

<span class="nc" id="L273">                int totalShotsLeft = en.getTotalMunitionsOfType(mounted);</span>

<span class="nc" id="L275">                wn.append(&quot; (&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L276">                wn.append(shotsLeft);</span>
<span class="nc" id="L277">                wn.append('/'); //$NON-NLS-1$</span>
<span class="nc" id="L278">                wn.append(totalShotsLeft);</span>
<span class="nc" id="L279">                wn.append(')'); //$NON-NLS-1$</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">            } else if (wtype.hasFlag(WeaponType.F_DOUBLE_ONESHOT)</span>
<span class="nc bnc" id="L281" title="All 4 branches missed.">                    || (en.isSupportVehicle() &amp;&amp; (wtype.getAmmoType() == AmmoType.T_INFANTRY))) {</span>
<span class="nc" id="L282">                int shotsLeft = 0;</span>
<span class="nc" id="L283">                int totalShots = 0;</span>
<span class="nc" id="L284">                long munition = ((AmmoType) mounted.getLinked().getType()).getMunitionType();</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">                for (Mounted current = mounted.getLinked(); current != null; current = current.getLinked()) {</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">                    if (((AmmoType) current.getType()).getMunitionType() == munition) {</span>
<span class="nc" id="L287">                        shotsLeft += current.getUsableShotsLeft();</span>
<span class="nc" id="L288">                        totalShots += current.getOriginalShots();</span>
                    }
                }
<span class="nc" id="L291">                wn.append(&quot; (&quot;).append(shotsLeft) //$NON-NLS-1$</span>
<span class="nc" id="L292">                    .append(&quot;/&quot;).append(totalShots).append(&quot;)&quot;); //$NON-NLS-1$ //$NON-NLS-2$</span>
            }

            // MG rapidfire
<span class="nc bnc" id="L296" title="All 2 branches missed.">            if (mounted.isRapidfire()) {</span>
<span class="nc" id="L297">                wn.append(Messages.getString(&quot;MechDisplay.rapidFire&quot;)); //$NON-NLS-1$</span>
            }

            // Hotloaded Missile Launchers
<span class="nc bnc" id="L301" title="All 2 branches missed.">            if (mounted.isHotLoaded()) {</span>
<span class="nc" id="L302">                wn.append(Messages.getString(&quot;MechDisplay.isHotLoaded&quot;)); //$NON-NLS-1$</span>
            }

            // Fire Mode - lots of things have variable modes
<span class="nc bnc" id="L306" title="All 2 branches missed.">            if (wtype.hasModes()) {</span>
<span class="nc" id="L307">                wn.append(' ');</span>
                
<span class="nc" id="L309">                wn.append(mounted.curMode().getDisplayableName());</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">                if (!mounted.pendingMode().equals(&quot;None&quot;)) {</span>
<span class="nc" id="L311">                    wn.append(&quot; (next turn, &quot;);</span>
<span class="nc" id="L312">                    wn.append(mounted.pendingMode().getDisplayableName());</span>
<span class="nc" id="L313">                    wn.append(')');</span>
                }
            }
<span class="nc bnc" id="L316" title="All 2 branches missed.">            if ((game != null)</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">                    &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_CALLED_SHOTS)) { //$NON-NLS-1$</span>
<span class="nc" id="L318">                wn.append(' ');</span>
<span class="nc" id="L319">                wn.append(mounted.getCalledShot().getDisplayableName());</span>
            }
<span class="nc" id="L321">            return wn.toString();</span>
        }

        /**
         * Returns the number of Mounteds in the list.
         */
        @Override
        public int getSize() {
<span class="nc" id="L329">            return weapons.size();</span>
        }

        /**
         * Sort the Mounteds, generally using a WeaponComparator.
         *
         * @param comparator
         */
        public void sort(Comparator&lt;Mounted&gt; comparator) {
<span class="nc" id="L338">            Collections.sort(weapons, comparator);</span>
<span class="nc" id="L339">            fireContentsChanged(this, 0, weapons.size() - 1);</span>
<span class="nc" id="L340">        }</span>

    }
    
    
    /**
     * 
     */
    private final UnitDisplay unitDisplay;
    
    /**
     *
     */
    private static final long serialVersionUID = -5728839963281503332L;
    private JComboBox&lt;String&gt; weapSortOrder;
    public JList&lt;String&gt; weaponList;
    /**
     * Keep track of the previous target, used for certain weapons (like VGLs)
     * that will force a target.  With this, we can restore the previous target
     * after the forced target.
     */
<span class="nc" id="L361">    private Targetable prevTarget = null;</span>
    private JComboBox&lt;String&gt; m_chAmmo;
    public JComboBox&lt;String&gt; m_chBayWeapon;

    private JLabel wSortOrder;
    private JLabel wAmmo;
    private JLabel wBayWeapon;
    private JLabel wNameL;
    private JLabel wHeatL;
    private JLabel wArcHeatL;
    private JLabel wDamL;
    private JLabel wMinL;
    private JLabel wShortL;
    private JLabel wMedL;
    private JLabel wLongL;
    private JLabel wExtL;
    private JLabel wAVL;
    private JLabel wNameR;
    private JLabel wHeatR;
    private JLabel wArcHeatR;
    private JLabel wDamR;
    private JLabel wMinR;
    private JLabel wShortR;
    private JLabel wMedR;
    private JLabel wLongR;
    private JLabel wExtR;
    private JLabel wShortAVR;
    private JLabel wMedAVR;
    private JLabel wLongAVR;
    private JLabel wExtAVR;
    private JLabel currentHeatBuildupL;
    private JLabel currentHeatBuildupR;

    private JLabel wTargetL;
    private JLabel wRangeL;
    private JLabel wToHitL;
    public JLabel wTargetR;
    public JLabel wRangeR;
    public JLabel wToHitR;

    private JLabel wDamageTrooperL;
    private JLabel wDamageTrooperR;
    private JLabel wInfantryRange0L;
    private JLabel wInfantryRange0R;
    private JLabel wInfantryRange1L;
    private JLabel wInfantryRange1R;
    private JLabel wInfantryRange2L;
    private JLabel wInfantryRange2R;
    private JLabel wInfantryRange3L;
    private JLabel wInfantryRange3R;
    private JLabel wInfantryRange4L;
    private JLabel wInfantryRange4R;
    private JLabel wInfantryRange5L;
    private JLabel wInfantryRange5R;

    public JTextArea toHitText;

    // I need to keep a pointer to the weapon list of the
    // currently selected mech.
    private ArrayList&lt;Mounted&gt; vAmmo;
    private Entity entity;

<span class="nc" id="L423">    private int minTopMargin = 8;</span>
<span class="nc" id="L424">    private int minLeftMargin = 8;</span>

<span class="nc" id="L426">    WeaponPanel(UnitDisplay unitDisplay) {</span>

<span class="nc" id="L428">        this.unitDisplay = unitDisplay;</span>
<span class="nc" id="L429">        setLayout(new GridBagLayout());</span>

<span class="nc" id="L431">        int gridy = 0;</span>
<span class="nc" id="L432">        wSortOrder = new JLabel(</span>
<span class="nc" id="L433">                Messages.getString(&quot;MechDisplay.WeaponSortOrder.label&quot;),</span>
                SwingConstants.LEFT);
<span class="nc" id="L435">        wSortOrder.setOpaque(false);</span>
<span class="nc" id="L436">        wSortOrder.setForeground(Color.WHITE);</span>
<span class="nc" id="L437">        add(wSortOrder, GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L438">               .insets(15, 9, 1, 1).gridy(gridy).gridx(0));</span>
<span class="nc" id="L439">        weapSortOrder = new JComboBox&lt;String&gt;();</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">        for (Entity.WeaponSortOrder s : Entity.WeaponSortOrder.values()) {</span>
<span class="nc" id="L441">            String entry = &quot;MechDisplay.WeaponSortOrder.&quot; + s.i18nEntry;</span>
<span class="nc" id="L442">            weapSortOrder.addItem(Messages.getString(entry));</span>
        }
<span class="nc" id="L444">        add(weapSortOrder,</span>
<span class="nc" id="L445">                GBC.eol().insets(15, 9, 15, 1)</span>
<span class="nc" id="L446">                   .fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L447">                   .anchor(GridBagConstraints.CENTER).gridy(gridy)</span>
<span class="nc" id="L448">                   .gridx(1));</span>
<span class="nc" id="L449">        gridy++;</span>

        // weapon list
<span class="nc" id="L452">        weaponList = new JList&lt;String&gt;(new DefaultListModel&lt;String&gt;());</span>
<span class="nc" id="L453">        WeaponListMouseAdapter mouseAdapter = new WeaponListMouseAdapter();</span>
<span class="nc" id="L454">        weaponList.addMouseListener(mouseAdapter);</span>
<span class="nc" id="L455">        weaponList.addMouseMotionListener(mouseAdapter);</span>
<span class="nc" id="L456">        JScrollPane tWeaponScroll = new JScrollPane(weaponList);</span>
<span class="nc" id="L457">        tWeaponScroll.setMinimumSize(new Dimension(200, 100));</span>
<span class="nc" id="L458">        tWeaponScroll.setPreferredSize(new Dimension(200, 100));</span>
<span class="nc" id="L459">        add(tWeaponScroll,</span>
<span class="nc" id="L460">            GBC.eol().insets(15, 9, 15, 9)</span>
<span class="nc" id="L461">               .fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L462">               .anchor(GridBagConstraints.CENTER).gridy(gridy)</span>
<span class="nc" id="L463">               .gridx(0));</span>
<span class="nc" id="L464">        gridy++;</span>
<span class="nc" id="L465">        weaponList.resetKeyboardActions();</span>
<span class="nc bnc" id="L466" title="All 2 branches missed.">        for (KeyListener key : weaponList.getKeyListeners()) {</span>
<span class="nc" id="L467">            weaponList.removeKeyListener(key);</span>
        }

        // adding Ammo choice + label

<span class="nc" id="L472">        wAmmo = new JLabel(</span>
<span class="nc" id="L473">                Messages.getString(&quot;MechDisplay.Ammo&quot;), SwingConstants.LEFT); //$NON-NLS-1$</span>
<span class="nc" id="L474">        wAmmo.setOpaque(false);</span>
<span class="nc" id="L475">        wAmmo.setForeground(Color.WHITE);</span>
<span class="nc" id="L476">        m_chAmmo = new JComboBox&lt;String&gt;();</span>

<span class="nc" id="L478">        wBayWeapon = new JLabel(</span>
<span class="nc" id="L479">                Messages.getString(&quot;MechDisplay.Weapon&quot;), SwingConstants.LEFT); //$NON-NLS-1$</span>
<span class="nc" id="L480">        wBayWeapon.setOpaque(false);</span>
<span class="nc" id="L481">        wBayWeapon.setForeground(Color.WHITE);</span>
<span class="nc" id="L482">        m_chBayWeapon = new JComboBox&lt;String&gt;();</span>

<span class="nc" id="L484">        add(wBayWeapon, GBC.std().insets(15, 1, 1, 1).gridy(gridy).gridx(0));</span>

<span class="nc" id="L486">        add(m_chBayWeapon, GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L487">                              .insets(1, 1, 15, 1).gridy(gridy).gridx(1));</span>
<span class="nc" id="L488">        gridy++;</span>
<span class="nc" id="L489">        add(wAmmo, GBC.std().insets(15, 9, 1, 1).gridy(gridy).gridx(0));</span>

<span class="nc" id="L491">        add(m_chAmmo,</span>
<span class="nc" id="L492">            GBC.eol().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L493">               .insets(1, 9, 15, 1).gridy(gridy).gridx(1));</span>
<span class="nc" id="L494">        gridy++;</span>
        // Adding Heat Buildup

<span class="nc" id="L497">        currentHeatBuildupL = new JLabel(</span>
<span class="nc" id="L498">                Messages.getString(&quot;MechDisplay.HeatBuildup&quot;), SwingConstants.RIGHT); //$NON-NLS-1$</span>
<span class="nc" id="L499">        currentHeatBuildupL.setOpaque(false);</span>
<span class="nc" id="L500">        currentHeatBuildupL.setForeground(Color.WHITE);</span>
<span class="nc" id="L501">        currentHeatBuildupR = new JLabel(&quot;--&quot;, SwingConstants.LEFT); //$NON-NLS-1$</span>
<span class="nc" id="L502">        currentHeatBuildupR.setOpaque(false);</span>
<span class="nc" id="L503">        currentHeatBuildupR.setForeground(Color.WHITE);</span>

<span class="nc" id="L505">        add(currentHeatBuildupL,</span>
<span class="nc" id="L506">            GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L507">               .anchor(GridBagConstraints.EAST).insets(9, 1, 1, 9)</span>
<span class="nc" id="L508">               .gridy(gridy).gridx(0));</span>

<span class="nc" id="L510">        add(currentHeatBuildupR,</span>
<span class="nc" id="L511">            GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L512">               .insets(1, 1, 9, 9).gridy(gridy).gridx(1));</span>
<span class="nc" id="L513">        gridy++;</span>

        // Adding weapon display labels
<span class="nc" id="L516">        wNameL = new JLabel(</span>
<span class="nc" id="L517">                Messages.getString(&quot;MechDisplay.Name&quot;), SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L518">        wNameL.setOpaque(false);</span>
<span class="nc" id="L519">        wNameL.setForeground(Color.WHITE);</span>
<span class="nc" id="L520">        wHeatL = new JLabel(</span>
<span class="nc" id="L521">                Messages.getString(&quot;MechDisplay.Heat&quot;), SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L522">        wHeatL.setOpaque(false);</span>
<span class="nc" id="L523">        wHeatL.setForeground(Color.WHITE);</span>
<span class="nc" id="L524">        wDamL = new JLabel(</span>
<span class="nc" id="L525">                Messages.getString(&quot;MechDisplay.Damage&quot;), SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L526">        wDamL.setOpaque(false);</span>
<span class="nc" id="L527">        wDamL.setForeground(Color.WHITE);</span>
<span class="nc" id="L528">        wArcHeatL = new JLabel(</span>
<span class="nc" id="L529">                Messages.getString(&quot;MechDisplay.ArcHeat&quot;), SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L530">        wArcHeatL.setOpaque(false);</span>
<span class="nc" id="L531">        wArcHeatL.setForeground(Color.WHITE);</span>
<span class="nc" id="L532">        wNameR = new JLabel(&quot;&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L533">        wNameR.setOpaque(false);</span>
<span class="nc" id="L534">        wNameR.setForeground(Color.WHITE);</span>
<span class="nc" id="L535">        wHeatR = new JLabel(&quot;--&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L536">        wHeatR.setOpaque(false);</span>
<span class="nc" id="L537">        wHeatR.setForeground(Color.WHITE);</span>
<span class="nc" id="L538">        wDamR = new JLabel(&quot;--&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L539">        wDamR.setOpaque(false);</span>
<span class="nc" id="L540">        wDamR.setForeground(Color.WHITE);</span>
<span class="nc" id="L541">        wArcHeatR = new JLabel(&quot;--&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L542">        wArcHeatR.setOpaque(false);</span>
<span class="nc" id="L543">        wArcHeatR.setForeground(Color.WHITE);</span>

<span class="nc" id="L545">        wDamageTrooperL = new JLabel(</span>
<span class="nc" id="L546">                Messages.getString(&quot;MechDisplay.DamageTrooper&quot;), SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L547">        wDamageTrooperL.setOpaque(false);</span>
<span class="nc" id="L548">        wDamageTrooperL.setForeground(Color.WHITE);</span>
<span class="nc" id="L549">        wDamageTrooperR = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L550">        wDamageTrooperR.setOpaque(false);</span>
<span class="nc" id="L551">        wDamageTrooperR.setForeground(Color.WHITE);</span>

<span class="nc" id="L553">        add(wNameL,</span>
<span class="nc" id="L554">            GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L555">               .insets(1, 9, 1, 1).gridy(gridy).gridx(0));</span>

<span class="nc" id="L557">        add(wHeatL,</span>
<span class="nc" id="L558">            GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L559">               .insets(1, 9, 1, 1).gridy(gridy).gridx(1));</span>

<span class="nc" id="L561">        add(wDamL,</span>
<span class="nc" id="L562">            GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L563">               .insets(1, 9, 1, 1).gridy(gridy).gridx(2));</span>

<span class="nc" id="L565">        add(wArcHeatL, GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L566">                          .insets(1, 9, 1, 1).gridy(gridy).gridx(3));</span>

<span class="nc" id="L568">        add(wDamageTrooperL, GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L569">                                .insets(1, 9, 1, 1).gridy(gridy).gridx(3));</span>
<span class="nc" id="L570">        gridy++;</span>
<span class="nc" id="L571">        add(wNameR,</span>
<span class="nc" id="L572">            GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L573">               .insets(1, 9, 1, 1).gridy(gridy).gridx(0));</span>

<span class="nc" id="L575">        add(wHeatR,</span>
<span class="nc" id="L576">            GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L577">               .insets(1, 9, 1, 1).gridy(gridy).gridx(1));</span>

<span class="nc" id="L579">        add(wDamR,</span>
<span class="nc" id="L580">            GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L581">               .insets(1, 9, 1, 1).gridy(gridy).gridx(2));</span>

<span class="nc" id="L583">        add(wArcHeatR, GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L584">                          .insets(1, 9, 1, 1).gridy(gridy).gridx(3));</span>

<span class="nc" id="L586">        add(wDamageTrooperR, GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L587">                                .insets(1, 9, 1, 1).gridy(gridy).gridx(3));</span>
<span class="nc" id="L588">        gridy++;</span>
        // Adding range labels
<span class="nc" id="L590">        wMinL = new JLabel(</span>
<span class="nc" id="L591">                Messages.getString(&quot;MechDisplay.Min&quot;), SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L592">        wMinL.setOpaque(false);</span>
<span class="nc" id="L593">        wMinL.setForeground(Color.WHITE);</span>
<span class="nc" id="L594">        wShortL = new JLabel(</span>
<span class="nc" id="L595">                Messages.getString(&quot;MechDisplay.Short&quot;), SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L596">        wShortL.setOpaque(false);</span>
<span class="nc" id="L597">        wShortL.setForeground(Color.WHITE);</span>
<span class="nc" id="L598">        wMedL = new JLabel(</span>
<span class="nc" id="L599">                Messages.getString(&quot;MechDisplay.Med&quot;), SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L600">        wMedL.setOpaque(false);</span>
<span class="nc" id="L601">        wMedL.setForeground(Color.WHITE);</span>
<span class="nc" id="L602">        wLongL = new JLabel(</span>
<span class="nc" id="L603">                Messages.getString(&quot;MechDisplay.Long&quot;), SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L604">        wLongL.setOpaque(false);</span>
<span class="nc" id="L605">        wLongL.setForeground(Color.WHITE);</span>
<span class="nc" id="L606">        wExtL = new JLabel(</span>
<span class="nc" id="L607">                Messages.getString(&quot;MechDisplay.Ext&quot;), SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L608">        wExtL.setOpaque(false);</span>
<span class="nc" id="L609">        wExtL.setForeground(Color.WHITE);</span>
<span class="nc" id="L610">        wMinR = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L611">        wMinR.setOpaque(false);</span>
<span class="nc" id="L612">        wMinR.setForeground(Color.WHITE);</span>
<span class="nc" id="L613">        wShortR = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L614">        wShortR.setOpaque(false);</span>
<span class="nc" id="L615">        wShortR.setForeground(Color.WHITE);</span>
<span class="nc" id="L616">        wMedR = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L617">        wMedR.setOpaque(false);</span>
<span class="nc" id="L618">        wMedR.setForeground(Color.WHITE);</span>
<span class="nc" id="L619">        wLongR = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L620">        wLongR.setOpaque(false);</span>
<span class="nc" id="L621">        wLongR.setForeground(Color.WHITE);</span>
<span class="nc" id="L622">        wExtR = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L623">        wExtR.setOpaque(false);</span>
<span class="nc" id="L624">        wExtR.setForeground(Color.WHITE);</span>
<span class="nc" id="L625">        wAVL = new JLabel(</span>
<span class="nc" id="L626">                Messages.getString(&quot;MechDisplay.AV&quot;), SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L627">        wAVL.setOpaque(false);</span>
<span class="nc" id="L628">        wAVL.setForeground(Color.WHITE);</span>
<span class="nc" id="L629">        wShortAVR = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L630">        wShortAVR.setOpaque(false);</span>
<span class="nc" id="L631">        wShortAVR.setForeground(Color.WHITE);</span>
<span class="nc" id="L632">        wMedAVR = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L633">        wMedAVR.setOpaque(false);</span>
<span class="nc" id="L634">        wMedAVR.setForeground(Color.WHITE);</span>
<span class="nc" id="L635">        wLongAVR = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L636">        wLongAVR.setOpaque(false);</span>
<span class="nc" id="L637">        wLongAVR.setForeground(Color.WHITE);</span>
<span class="nc" id="L638">        wExtAVR = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L639">        wExtAVR.setOpaque(false);</span>
<span class="nc" id="L640">        wExtAVR.setForeground(Color.WHITE);</span>

<span class="nc" id="L642">        wInfantryRange0L = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L643">        wInfantryRange0L.setOpaque(false);</span>
<span class="nc" id="L644">        wInfantryRange0L.setForeground(Color.WHITE);</span>
<span class="nc" id="L645">        wInfantryRange0R = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L646">        wInfantryRange0R.setOpaque(false);</span>
<span class="nc" id="L647">        wInfantryRange0R.setForeground(Color.WHITE);</span>
<span class="nc" id="L648">        wInfantryRange1L = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L649">        wInfantryRange1L.setOpaque(false);</span>
<span class="nc" id="L650">        wInfantryRange1L.setForeground(Color.WHITE);</span>
<span class="nc" id="L651">        wInfantryRange1R = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L652">        wInfantryRange1R.setOpaque(false);</span>
<span class="nc" id="L653">        wInfantryRange1R.setForeground(Color.WHITE);</span>
<span class="nc" id="L654">        wInfantryRange2L = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L655">        wInfantryRange2L.setOpaque(false);</span>
<span class="nc" id="L656">        wInfantryRange2L.setForeground(Color.WHITE);</span>
<span class="nc" id="L657">        wInfantryRange2R = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L658">        wInfantryRange2R.setOpaque(false);</span>
<span class="nc" id="L659">        wInfantryRange2R.setForeground(Color.WHITE);</span>
<span class="nc" id="L660">        wInfantryRange3L = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L661">        wInfantryRange3L.setOpaque(false);</span>
<span class="nc" id="L662">        wInfantryRange3L.setForeground(Color.WHITE);</span>
<span class="nc" id="L663">        wInfantryRange3R = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L664">        wInfantryRange3R.setOpaque(false);</span>
<span class="nc" id="L665">        wInfantryRange3R.setForeground(Color.WHITE);</span>
<span class="nc" id="L666">        wInfantryRange4L = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L667">        wInfantryRange4L.setOpaque(false);</span>
<span class="nc" id="L668">        wInfantryRange4L.setForeground(Color.WHITE);</span>
<span class="nc" id="L669">        wInfantryRange4R = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L670">        wInfantryRange4R.setOpaque(false);</span>
<span class="nc" id="L671">        wInfantryRange4R.setForeground(Color.WHITE);</span>
<span class="nc" id="L672">        wInfantryRange5L = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L673">        wInfantryRange5L.setOpaque(false);</span>
<span class="nc" id="L674">        wInfantryRange5L.setForeground(Color.WHITE);</span>
<span class="nc" id="L675">        wInfantryRange5R = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L676">        wInfantryRange5R.setOpaque(false);</span>
<span class="nc" id="L677">        wInfantryRange5R.setForeground(Color.WHITE);</span>

<span class="nc" id="L679">        add(wMinL,</span>
<span class="nc" id="L680">            GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L681">               .insets(1, 9, 9, 1).gridy(gridy).gridx(0));</span>

<span class="nc" id="L683">        add(wShortL,</span>
<span class="nc" id="L684">            GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L685">               .insets(1, 9, 9, 1).gridy(gridy).gridx(1));</span>

<span class="nc" id="L687">        add(wMedL,</span>
<span class="nc" id="L688">            GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L689">               .insets(1, 9, 9, 1).gridy(gridy).gridx(2));</span>

<span class="nc" id="L691">        add(wLongL,</span>
<span class="nc" id="L692">            GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L693">               .insets(1, 9, 9, 1).gridy(gridy).gridx(3));</span>

<span class="nc" id="L695">        add(wExtL,</span>
<span class="nc" id="L696">            GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L697">               .insets(1, 9, 9, 1).gridy(gridy).gridx(4));</span>

<span class="nc" id="L699">        add(wInfantryRange0L, GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L700">                .insets(1, 9, 9, 1).gridy(gridy).gridx(0));</span>

<span class="nc" id="L702">        add(wInfantryRange1L, GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L703">                            .insets(1, 9, 9, 1).gridy(gridy).gridx(1));</span>

<span class="nc" id="L705">        add(wInfantryRange2L, GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L706">                            .insets(1, 9, 9, 1).gridy(gridy).gridx(2));</span>

<span class="nc" id="L708">        add(wInfantryRange3L, GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L709">                            .insets(1, 9, 9, 1).gridy(gridy).gridx(3));</span>

<span class="nc" id="L711">        add(wInfantryRange4L, GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L712">                            .insets(1, 9, 9, 1).gridy(gridy).gridx(4));</span>

<span class="nc" id="L714">        add(wInfantryRange5L, GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L715">                            .insets(1, 9, 9, 1).gridy(gridy).gridx(4));</span>

<span class="nc" id="L717">        gridy++;</span>
        // ----------------

<span class="nc" id="L720">        add(wMinR,</span>
<span class="nc" id="L721">            GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L722">               .insets(1, 9, 9, 1).gridy(gridy).gridx(0));</span>

<span class="nc" id="L724">        add(wShortR,</span>
<span class="nc" id="L725">            GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L726">               .insets(1, 9, 9, 1).gridy(gridy).gridx(1));</span>

<span class="nc" id="L728">        add(wMedR,</span>
<span class="nc" id="L729">            GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L730">               .insets(1, 9, 9, 1).gridy(gridy).gridx(2));</span>

<span class="nc" id="L732">        add(wLongR,</span>
<span class="nc" id="L733">            GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L734">               .insets(1, 9, 9, 1).gridy(gridy).gridx(3));</span>

<span class="nc" id="L736">        add(wExtR,</span>
<span class="nc" id="L737">            GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L738">               .insets(1, 9, 9, 1).gridy(gridy).gridx(4));</span>

<span class="nc" id="L740">        add(wInfantryRange0R, GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L741">                .insets(1, 9, 9, 1).gridy(gridy).gridx(0));</span>

<span class="nc" id="L743">        add(wInfantryRange1R, GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L744">                            .insets(1, 9, 9, 1).gridy(gridy).gridx(1));</span>

<span class="nc" id="L746">        add(wInfantryRange2R, GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L747">                            .insets(1, 9, 9, 1).gridy(gridy).gridx(2));</span>

<span class="nc" id="L749">        add(wInfantryRange3R, GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L750">                            .insets(1, 9, 9, 1).gridy(gridy).gridx(3));</span>

<span class="nc" id="L752">        add(wInfantryRange4R, GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L753">                            .insets(1, 9, 9, 1).gridy(gridy).gridx(4));</span>

<span class="nc" id="L755">        add(wInfantryRange5R, GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L756">                            .insets(1, 9, 9, 1).gridy(gridy).gridx(5));</span>

<span class="nc" id="L758">        gridy++;</span>
        // ----------------
<span class="nc" id="L760">        add(wAVL,</span>
<span class="nc" id="L761">            GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L762">               .insets(1, 9, 9, 1).gridy(gridy).gridx(0));</span>

<span class="nc" id="L764">        add(wShortAVR, GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L765">                          .insets(1, 9, 9, 1).gridy(gridy).gridx(1));</span>

<span class="nc" id="L767">        add(wMedAVR,</span>
<span class="nc" id="L768">            GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L769">               .insets(1, 9, 9, 1).gridy(gridy).gridx(2));</span>

<span class="nc" id="L771">        add(wLongAVR,</span>
<span class="nc" id="L772">            GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L773">               .insets(1, 9, 9, 1).gridy(gridy).gridx(3));</span>

<span class="nc" id="L775">        add(wExtAVR,</span>
<span class="nc" id="L776">            GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L777">               .insets(1, 9, 9, 1).gridy(gridy).gridx(4));</span>

<span class="nc" id="L779">        gridy++;</span>



        // target panel
<span class="nc" id="L784">        wTargetL = new JLabel(</span>
<span class="nc" id="L785">                Messages.getString(&quot;MechDisplay.Target&quot;), SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L786">        wTargetL.setOpaque(false);</span>
<span class="nc" id="L787">        wTargetL.setForeground(Color.WHITE);</span>
<span class="nc" id="L788">        wRangeL = new JLabel(</span>
<span class="nc" id="L789">                Messages.getString(&quot;MechDisplay.Range&quot;), SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L790">        wRangeL.setOpaque(false);</span>
<span class="nc" id="L791">        wRangeL.setForeground(Color.WHITE);</span>
<span class="nc" id="L792">        wToHitL = new JLabel(</span>
<span class="nc" id="L793">                Messages.getString(&quot;MechDisplay.ToHit&quot;), SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L794">        wToHitL.setOpaque(false);</span>
<span class="nc" id="L795">        wToHitL.setForeground(Color.WHITE);</span>

<span class="nc" id="L797">        wTargetR = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L798">        wTargetR.setOpaque(false);</span>
<span class="nc" id="L799">        wTargetR.setForeground(Color.WHITE);</span>
<span class="nc" id="L800">        wRangeR = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L801">        wRangeR.setOpaque(false);</span>
<span class="nc" id="L802">        wRangeR.setForeground(Color.WHITE);</span>
<span class="nc" id="L803">        wToHitR = new JLabel(&quot;---&quot;, SwingConstants.CENTER); //$NON-NLS-1$</span>
<span class="nc" id="L804">        wToHitR.setOpaque(false);</span>
<span class="nc" id="L805">        wToHitR.setForeground(Color.WHITE);</span>

<span class="nc" id="L807">        add(wTargetL,</span>
<span class="nc" id="L808">            GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L809">               .insets(1, 9, 1, 1).gridy(gridy).gridx(0));</span>

<span class="nc" id="L811">        add(wTargetR,</span>
<span class="nc" id="L812">            GBC.eol().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L813">               .insets(1, 9, 1, 1).gridy(gridy).gridx(1));</span>
<span class="nc" id="L814">        gridy++;</span>

<span class="nc" id="L816">        add(wRangeL,</span>
<span class="nc" id="L817">            GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L818">               .insets(1, 9, 1, 1).gridy(gridy).gridx(0));</span>

<span class="nc" id="L820">        add(wRangeR,</span>
<span class="nc" id="L821">            GBC.eol().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L822">               .insets(1, 9, 1, 1).gridy(gridy).gridx(1));</span>
<span class="nc" id="L823">        gridy++;</span>

<span class="nc" id="L825">        add(wToHitL,</span>
<span class="nc" id="L826">            GBC.std().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L827">               .insets(1, 9, 1, 1).gridy(gridy).gridx(0));</span>

<span class="nc" id="L829">        add(wToHitR,</span>
<span class="nc" id="L830">            GBC.eol().fill(GridBagConstraints.HORIZONTAL)</span>
<span class="nc" id="L831">               .insets(1, 9, 1, 1).gridy(gridy).gridx(1));</span>
<span class="nc" id="L832">        gridy++;</span>

        // to-hit text
<span class="nc" id="L835">        toHitText = new JTextArea(&quot;&quot;, 2, 20); //$NON-NLS-1$</span>
<span class="nc" id="L836">        toHitText.setEditable(false);</span>
<span class="nc" id="L837">        toHitText.setLineWrap(true);</span>
<span class="nc" id="L838">        toHitText.setFont(new Font(&quot;SansSerif&quot;, Font.PLAIN, 10)); //$NON-NLS-1$</span>
<span class="nc" id="L839">        add(toHitText,</span>
<span class="nc" id="L840">            GBC.eol().fill(GridBagConstraints.BOTH)</span>
<span class="nc" id="L841">               .insets(15, 9, 15, 9).gridy(gridy).gridx(0)</span>
<span class="nc" id="L842">               .gridheight(2));</span>
<span class="nc" id="L843">        gridy++;</span>

<span class="nc" id="L845">        addListeners();</span>
        
<span class="nc" id="L847">        setBackGround();</span>
<span class="nc" id="L848">        onResize();</span>
<span class="nc" id="L849">    }</span>

    @Override
    public void onResize() {
<span class="nc" id="L853">        int w = getSize().width;</span>
<span class="nc" id="L854">        Rectangle r = getContentBounds();</span>
<span class="nc bnc" id="L855" title="All 2 branches missed.">        if (r == null) {</span>
<span class="nc" id="L856">            return;</span>
        }
<span class="nc" id="L858">        int dx = Math.round(((w - r.width) / 2));</span>
<span class="nc bnc" id="L859" title="All 2 branches missed.">        if (dx &lt; minLeftMargin) {</span>
<span class="nc" id="L860">            dx = minLeftMargin;</span>
        }
<span class="nc" id="L862">        int dy = minTopMargin;</span>
<span class="nc" id="L863">        setContentMargins(dx, dy, dx, dy);</span>
<span class="nc" id="L864">    }</span>

    private void setBackGround() {
        UnitDisplaySkinSpecification udSpec = SkinXMLHandler
<span class="nc" id="L868">                .getUnitDisplaySkin();</span>

<span class="nc" id="L870">        Image tile = getToolkit()</span>
<span class="nc" id="L871">                .getImage(</span>
<span class="nc" id="L872">                        new MegaMekFile(Configuration.widgetsDir(), udSpec</span>
<span class="nc" id="L873">                                .getBackgroundTile()).toString());</span>
<span class="nc" id="L874">        PMUtil.setImage(tile, this);</span>
<span class="nc" id="L875">        int b = BackGroundDrawer.TILING_BOTH;</span>
<span class="nc" id="L876">        addBgDrawer(new BackGroundDrawer(tile, b));</span>

<span class="nc" id="L878">        b = BackGroundDrawer.TILING_HORIZONTAL | BackGroundDrawer.VALIGN_TOP;</span>
<span class="nc" id="L879">        tile = getToolkit().getImage(</span>
<span class="nc" id="L880">                new MegaMekFile(Configuration.widgetsDir(), udSpec.getTopLine())</span>
<span class="nc" id="L881">                        .toString());</span>
<span class="nc" id="L882">        PMUtil.setImage(tile, this);</span>
<span class="nc" id="L883">        addBgDrawer(new BackGroundDrawer(tile, b));</span>

<span class="nc" id="L885">        b = BackGroundDrawer.TILING_HORIZONTAL | BackGroundDrawer.VALIGN_BOTTOM;</span>
<span class="nc" id="L886">        tile = getToolkit().getImage(</span>
<span class="nc" id="L887">                new MegaMekFile(Configuration.widgetsDir(), udSpec.getBottomLine())</span>
<span class="nc" id="L888">                        .toString());</span>
<span class="nc" id="L889">        PMUtil.setImage(tile, this);</span>
<span class="nc" id="L890">        addBgDrawer(new BackGroundDrawer(tile, b));</span>

<span class="nc" id="L892">        b = BackGroundDrawer.TILING_VERTICAL | BackGroundDrawer.HALIGN_LEFT;</span>
<span class="nc" id="L893">        tile = getToolkit().getImage(</span>
<span class="nc" id="L894">                new MegaMekFile(Configuration.widgetsDir(), udSpec.getLeftLine())</span>
<span class="nc" id="L895">                        .toString());</span>
<span class="nc" id="L896">        PMUtil.setImage(tile, this);</span>
<span class="nc" id="L897">        addBgDrawer(new BackGroundDrawer(tile, b));</span>

<span class="nc" id="L899">        b = BackGroundDrawer.TILING_VERTICAL | BackGroundDrawer.HALIGN_RIGHT;</span>
<span class="nc" id="L900">        tile = getToolkit().getImage(</span>
<span class="nc" id="L901">                new MegaMekFile(Configuration.widgetsDir(), udSpec.getRightLine())</span>
<span class="nc" id="L902">                        .toString());</span>
<span class="nc" id="L903">        PMUtil.setImage(tile, this);</span>
<span class="nc" id="L904">        addBgDrawer(new BackGroundDrawer(tile, b));</span>

<span class="nc" id="L906">        b = BackGroundDrawer.NO_TILING | BackGroundDrawer.VALIGN_TOP</span>
                | BackGroundDrawer.HALIGN_LEFT;
<span class="nc" id="L908">        tile = getToolkit()</span>
<span class="nc" id="L909">                .getImage(</span>
<span class="nc" id="L910">                        new MegaMekFile(Configuration.widgetsDir(), udSpec</span>
<span class="nc" id="L911">                                .getTopLeftCorner()).toString());</span>
<span class="nc" id="L912">        PMUtil.setImage(tile, this);</span>
<span class="nc" id="L913">        addBgDrawer(new BackGroundDrawer(tile, b));</span>

<span class="nc" id="L915">        b = BackGroundDrawer.NO_TILING | BackGroundDrawer.VALIGN_BOTTOM</span>
                | BackGroundDrawer.HALIGN_LEFT;
<span class="nc" id="L917">        tile = getToolkit().getImage(</span>
<span class="nc" id="L918">                new MegaMekFile(Configuration.widgetsDir(), udSpec</span>
<span class="nc" id="L919">                        .getBottomLeftCorner()).toString());</span>
<span class="nc" id="L920">        PMUtil.setImage(tile, this);</span>
<span class="nc" id="L921">        addBgDrawer(new BackGroundDrawer(tile, b));</span>

<span class="nc" id="L923">        b = BackGroundDrawer.NO_TILING | BackGroundDrawer.VALIGN_TOP</span>
                | BackGroundDrawer.HALIGN_RIGHT;
<span class="nc" id="L925">        tile = getToolkit()</span>
<span class="nc" id="L926">                .getImage(</span>
<span class="nc" id="L927">                        new MegaMekFile(Configuration.widgetsDir(), udSpec</span>
<span class="nc" id="L928">                                .getTopRightCorner()).toString());</span>
<span class="nc" id="L929">        PMUtil.setImage(tile, this);</span>
<span class="nc" id="L930">        addBgDrawer(new BackGroundDrawer(tile, b));</span>

<span class="nc" id="L932">        b = BackGroundDrawer.NO_TILING | BackGroundDrawer.VALIGN_BOTTOM</span>
                | BackGroundDrawer.HALIGN_RIGHT;
<span class="nc" id="L934">        tile = getToolkit().getImage(</span>
<span class="nc" id="L935">                new MegaMekFile(Configuration.widgetsDir(), udSpec</span>
<span class="nc" id="L936">                        .getBottomRightCorner()).toString());</span>
<span class="nc" id="L937">        PMUtil.setImage(tile, this);</span>
<span class="nc" id="L938">        addBgDrawer(new BackGroundDrawer(tile, b));</span>

<span class="nc" id="L940">    }</span>

    /**
     * updates fields for the specified mech
     * &lt;p/&gt;
     * fix the ammo when it's added
     */
    public void displayMech(Entity en) {
<span class="nc" id="L948">        removeListeners();</span>
        
        // Grab a copy of the game.
<span class="nc" id="L951">        IGame game = null;</span>

<span class="nc bnc" id="L953" title="All 2 branches missed.">        if (unitDisplay.getClientGUI() != null) {</span>
<span class="nc" id="L954">            game = unitDisplay.getClientGUI().getClient().getGame();</span>
        }

        // update pointer to weapons
<span class="nc" id="L958">        entity = en;</span>

        // Check Game Options for max external heat
<span class="nc bnc" id="L961" title="All 2 branches missed.">        int max_ext_heat = game != null ? game.getOptions().intOption(OptionsConstants.ADVCOMBAT_MAX_EXTERNAL_HEAT) : 15;</span>
<span class="nc bnc" id="L962" title="All 2 branches missed.">        if (max_ext_heat &lt; 0) {</span>
<span class="nc" id="L963">            max_ext_heat = 15; // Standard value specified in TW p.159</span>
        }

<span class="nc" id="L966">        int currentHeatBuildup = (en.heat // heat from last round                </span>
<span class="nc" id="L967">                + en.getEngineCritHeat() // heat engine crits will add</span>
<span class="nc" id="L968">                + Math.min(max_ext_heat, en.heatFromExternal) // heat from external sources</span>
                + en.heatBuildup) // heat we're building up this round
<span class="nc" id="L970">                - Math.min(9, en.coolFromExternal); // cooling from external</span>
        // sources
<span class="nc bnc" id="L972" title="All 2 branches missed.">        if (en instanceof Mech) {</span>
<span class="nc bnc" id="L973" title="All 2 branches missed.">            if (en.infernos.isStillBurning()) { // hit with inferno ammo</span>
<span class="nc" id="L974">                currentHeatBuildup += en.infernos.getHeat();</span>
            }
<span class="nc bnc" id="L976" title="All 2 branches missed.">            if (!((Mech) en).hasLaserHeatSinks()) {</span>
                // extreme temperatures.
<span class="nc bnc" id="L978" title="All 4 branches missed.">                if ((game != null) &amp;&amp; (game.getPlanetaryConditions().getTemperature() &gt; 0)) {</span>
<span class="nc" id="L979">                    int buildup = game.getPlanetaryConditions()</span>
<span class="nc" id="L980">                                      .getTemperatureDifference(50, -30);</span>
<span class="nc bnc" id="L981" title="All 2 branches missed.">                    if (((Mech) en).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L982">                        buildup /= 2;</span>
                    }
<span class="nc" id="L984">                    currentHeatBuildup += buildup;</span>
<span class="nc bnc" id="L985" title="All 2 branches missed.">                } else if (game != null) {</span>
<span class="nc" id="L986">                    currentHeatBuildup -= game.getPlanetaryConditions()</span>
<span class="nc" id="L987">                                              .getTemperatureDifference(50, -30);</span>
                }
            }
        }
<span class="nc" id="L991">        Coords position = entity.getPosition();</span>
<span class="nc bnc" id="L992" title="All 4 branches missed.">        if (!en.isOffBoard() &amp;&amp; (position != null)) {</span>
<span class="nc" id="L993">            IHex hex = game.getBoard().getHex(position);</span>
<span class="nc bnc" id="L994" title="All 2 branches missed.">            if (hex.containsTerrain(Terrains.FIRE)</span>
<span class="nc bnc" id="L995" title="All 2 branches missed.">                &amp;&amp; (hex.getFireTurn() &gt; 0)) {</span>
                // standing in fire
<span class="nc bnc" id="L997" title="All 2 branches missed.">                if ((en instanceof Mech)</span>
<span class="nc bnc" id="L998" title="All 2 branches missed.">                    &amp;&amp; ((Mech) en).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L999">                    currentHeatBuildup += 2;</span>
                } else {
<span class="nc" id="L1001">                    currentHeatBuildup += 5;</span>
                }
            }
<span class="nc bnc" id="L1004" title="All 2 branches missed.">            if (hex.terrainLevel(Terrains.MAGMA) == 1) {</span>
<span class="nc bnc" id="L1005" title="All 2 branches missed.">                if ((en instanceof Mech)</span>
<span class="nc bnc" id="L1006" title="All 2 branches missed.">                    &amp;&amp; ((Mech) en).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L1007">                    currentHeatBuildup += 2;</span>
                } else {
<span class="nc" id="L1009">                    currentHeatBuildup += 5;</span>
                }
<span class="nc bnc" id="L1011" title="All 2 branches missed.">            } else if (hex.terrainLevel(Terrains.MAGMA) == 2) {</span>
<span class="nc bnc" id="L1012" title="All 2 branches missed.">                if ((en instanceof Mech)</span>
<span class="nc bnc" id="L1013" title="All 2 branches missed.">                    &amp;&amp; ((Mech) en).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L1014">                    currentHeatBuildup += 5;</span>
                } else {
<span class="nc" id="L1016">                    currentHeatBuildup += 10;</span>
                }
            }
        }
<span class="nc bnc" id="L1020" title="All 6 branches missed.">        if ((((en instanceof Mech) || (en instanceof Aero)) &amp;&amp; en.isStealthActive())</span>
<span class="nc bnc" id="L1021" title="All 4 branches missed.">            || en.isNullSigActive() || en.isVoidSigActive()) {</span>
<span class="nc" id="L1022">            currentHeatBuildup += 10; // active stealth/null sig/void sig</span>
            // heat
        }

<span class="nc bnc" id="L1026" title="All 4 branches missed.">        if ((en instanceof Mech) &amp;&amp; en.isChameleonShieldOn()) {</span>
<span class="nc" id="L1027">            currentHeatBuildup += 6;</span>
        }

<span class="nc bnc" id="L1030" title="All 6 branches missed.">        if (((en instanceof Mech) || (en instanceof Aero)) &amp;&amp; en.hasActiveNovaCEWS()) {</span>
<span class="nc" id="L1031">            currentHeatBuildup += 2;</span>
        }

        // update weapon list
<span class="nc" id="L1035">        weaponList.setModel(new WeaponListModel(en));</span>
<span class="nc" id="L1036">        ((DefaultComboBoxModel&lt;String&gt;) m_chAmmo.getModel()).removeAllElements();</span>

<span class="nc" id="L1038">        m_chAmmo.setEnabled(false);</span>
<span class="nc" id="L1039">        m_chBayWeapon.removeAllItems();</span>
<span class="nc" id="L1040">        m_chBayWeapon.setEnabled(false);</span>

        // on large craft we may need to take account of firing arcs
<span class="nc" id="L1043">        boolean[] usedFrontArc = new boolean[entity.locations()];</span>
<span class="nc" id="L1044">        boolean[] usedRearArc = new boolean[entity.locations()];</span>
<span class="nc bnc" id="L1045" title="All 2 branches missed.">        for (int i = 0; i &lt; entity.locations(); i++) {</span>
<span class="nc" id="L1046">            usedFrontArc[i] = false;</span>
<span class="nc" id="L1047">            usedRearArc[i] = false;</span>
        }

<span class="nc" id="L1050">        boolean hasFiredWeapons = false;</span>
<span class="nc bnc" id="L1051" title="All 2 branches missed.">        for (int i = 0; i &lt; entity.getWeaponList().size(); i++) {</span>
<span class="nc" id="L1052">            Mounted mounted = entity.getWeaponList().get(i);</span>

            // Don't add bomb weapons for LAMs in mech mode except RL and TAG.
<span class="nc bnc" id="L1055" title="All 2 branches missed.">            if ((entity instanceof LandAirMech)</span>
<span class="nc bnc" id="L1056" title="All 2 branches missed.">                    &amp;&amp; (entity.getConversionMode() == LandAirMech.CONV_MODE_MECH)</span>
<span class="nc bnc" id="L1057" title="All 2 branches missed.">                    &amp;&amp; mounted.getType().hasFlag(WeaponType.F_BOMB_WEAPON)</span>
<span class="nc bnc" id="L1058" title="All 2 branches missed.">                    &amp;&amp; ((WeaponType)mounted.getType()).getAmmoType() != AmmoType.T_RL_BOMB</span>
<span class="nc bnc" id="L1059" title="All 2 branches missed.">                    &amp;&amp; !mounted.getType().hasFlag(WeaponType.F_TAG)) {</span>
<span class="nc" id="L1060">                continue;</span>
            }
            
<span class="nc" id="L1063">            ((WeaponListModel) weaponList.getModel()).addWeapon(mounted);</span>
<span class="nc bnc" id="L1064" title="All 2 branches missed.">            if (mounted.isUsedThisRound()</span>
<span class="nc bnc" id="L1065" title="All 2 branches missed.">                &amp;&amp; (game.getPhase() == mounted.usedInPhase())</span>
<span class="nc bnc" id="L1066" title="All 2 branches missed.">                &amp;&amp; (game.getPhase() == IGame.Phase.PHASE_FIRING)) {</span>
<span class="nc" id="L1067">                hasFiredWeapons = true;</span>
                // add heat from weapons fire to heat tracker
<span class="nc bnc" id="L1069" title="All 2 branches missed.">                if (entity.usesWeaponBays()) {</span>
                    // if using bay heat option then don't add total arc
<span class="nc bnc" id="L1071" title="All 2 branches missed.">                    if (game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_HEAT_BY_BAY)) {</span>
<span class="nc bnc" id="L1072" title="All 2 branches missed.">                        for (int wId : mounted.getBayWeapons()) {</span>
<span class="nc" id="L1073">                            currentHeatBuildup += entity.getEquipment(wId)</span>
<span class="nc" id="L1074">                                                        .getCurrentHeat();</span>
<span class="nc" id="L1075">                        }</span>
                    } else {
                        // check whether arc has fired
<span class="nc" id="L1078">                        int loc = mounted.getLocation();</span>
<span class="nc" id="L1079">                        boolean rearMount = mounted.isRearMounted();</span>
<span class="nc bnc" id="L1080" title="All 2 branches missed.">                        if (!rearMount) {</span>
<span class="nc bnc" id="L1081" title="All 2 branches missed.">                            if (!usedFrontArc[loc]) {</span>
<span class="nc" id="L1082">                                currentHeatBuildup += entity.getHeatInArc(</span>
                                        loc, rearMount);
<span class="nc" id="L1084">                                usedFrontArc[loc] = true;</span>
                            }
                        } else {
<span class="nc bnc" id="L1087" title="All 2 branches missed.">                            if (!usedRearArc[loc]) {</span>
<span class="nc" id="L1088">                                currentHeatBuildup += entity.getHeatInArc(</span>
                                        loc, rearMount);
<span class="nc" id="L1090">                                usedRearArc[loc] = true;</span>
                            }
                        }
<span class="nc" id="L1093">                    }</span>
                } else {
<span class="nc bnc" id="L1095" title="All 2 branches missed.">                    if (!mounted.isBombMounted()) {</span>
<span class="nc" id="L1096">                        currentHeatBuildup += mounted.getCurrentHeat();</span>
                    }
                }
            }
        }
<span class="nc" id="L1101">        weapSortOrder.setSelectedIndex(entity.getWeaponSortOrder().ordinal());</span>
<span class="nc" id="L1102">        setWeaponComparator(weapSortOrder.getSelectedIndex());</span>

<span class="nc bnc" id="L1104" title="All 4 branches missed.">        if (en.hasDamagedRHS() &amp;&amp; hasFiredWeapons) {</span>
<span class="nc" id="L1105">            currentHeatBuildup++;</span>
        }

        // This code block copied from the MovementPanel class,
        // bad coding practice (duplicate code).
        int heatCap;
<span class="nc bnc" id="L1111" title="All 2 branches missed.">        if (en instanceof Mech) {</span>
<span class="nc" id="L1112">            heatCap = ((Mech) en).getHeatCapacity(true, false);</span>
<span class="nc bnc" id="L1113" title="All 2 branches missed.">        } else if (en instanceof Aero) {</span>
<span class="nc" id="L1114">            heatCap = en.getHeatCapacity(false);</span>
        } else {
<span class="nc" id="L1116">            heatCap = en.getHeatCapacity();</span>
        }
<span class="nc" id="L1118">        int heatCapWater = en.getHeatCapacityWithWater();</span>
<span class="nc bnc" id="L1119" title="All 2 branches missed.">        if (en.getCoolantFailureAmount() &gt; 0) {</span>
<span class="nc" id="L1120">            heatCap -= en.getCoolantFailureAmount();</span>
<span class="nc" id="L1121">            heatCapWater -= en.getCoolantFailureAmount();</span>
        }
<span class="nc bnc" id="L1123" title="All 2 branches missed.">        if (en.hasActivatedRadicalHS()) {</span>
<span class="nc bnc" id="L1124" title="All 2 branches missed.">            if (en instanceof Mech) {</span>
<span class="nc" id="L1125">                heatCap += ((Mech) en).getActiveSinks();</span>
<span class="nc" id="L1126">                heatCapWater += ((Mech) en).getActiveSinks();</span>
<span class="nc bnc" id="L1127" title="All 2 branches missed.">            } else if (en instanceof Aero) {</span>
<span class="nc" id="L1128">                heatCap += ((Aero) en).getHeatSinks();</span>
<span class="nc" id="L1129">                heatCapWater += ((Aero) en).getHeatSinks();</span>
            }
        }
<span class="nc" id="L1132">        String heatCapacityStr = Integer.toString(heatCap);</span>

<span class="nc bnc" id="L1134" title="All 2 branches missed.">        if (heatCap &lt; heatCapWater) {</span>
<span class="nc" id="L1135">            heatCapacityStr = heatCap + &quot; [&quot; + heatCapWater + ']'; //$NON-NLS-1$</span>
        }
        // end duplicate block

        // check for negative values due to extreme temp
<span class="nc bnc" id="L1140" title="All 2 branches missed.">        if (currentHeatBuildup &lt; 0) {</span>
<span class="nc" id="L1141">            currentHeatBuildup = 0;</span>
        }

<span class="nc" id="L1144">        String heatText = Integer.toString(currentHeatBuildup);</span>
<span class="nc bnc" id="L1145" title="All 2 branches missed.">        if (currentHeatBuildup &gt; en.getHeatCapacityWithWater()) {</span>
<span class="nc" id="L1146">            heatText += &quot;*&quot;; // overheat indication //$NON-NLS-1$</span>
        }

<span class="nc" id="L1149">        currentHeatBuildupR.setText(heatText + &quot; (&quot; + heatCapacityStr + ')'); //$NON-NLS-1$</span>

        // change what is visible based on type
<span class="nc bnc" id="L1152" title="All 2 branches missed.">        if (entity.usesWeaponBays()) {</span>
<span class="nc" id="L1153">            wArcHeatL.setVisible(true);</span>
<span class="nc" id="L1154">            wArcHeatR.setVisible(true);</span>
<span class="nc" id="L1155">            m_chBayWeapon.setVisible(true);</span>
<span class="nc" id="L1156">            wBayWeapon.setVisible(true);</span>
        } else {
<span class="nc" id="L1158">            wArcHeatL.setVisible(false);</span>
<span class="nc" id="L1159">            wArcHeatR.setVisible(false);</span>
<span class="nc" id="L1160">            m_chBayWeapon.setVisible(false);</span>
<span class="nc" id="L1161">            wBayWeapon.setVisible(false);</span>
        }

<span class="nc" id="L1164">        wDamageTrooperL.setVisible(false);</span>
<span class="nc" id="L1165">        wDamageTrooperR.setVisible(false);</span>
<span class="nc" id="L1166">        wInfantryRange0L.setVisible(false);</span>
<span class="nc" id="L1167">        wInfantryRange0R.setVisible(false);</span>
<span class="nc" id="L1168">        wInfantryRange1L.setVisible(false);</span>
<span class="nc" id="L1169">        wInfantryRange1R.setVisible(false);</span>
<span class="nc" id="L1170">        wInfantryRange2L.setVisible(false);</span>
<span class="nc" id="L1171">        wInfantryRange2R.setVisible(false);</span>
<span class="nc" id="L1172">        wInfantryRange3L.setVisible(false);</span>
<span class="nc" id="L1173">        wInfantryRange3R.setVisible(false);</span>
<span class="nc" id="L1174">        wInfantryRange4L.setVisible(false);</span>
<span class="nc" id="L1175">        wInfantryRange4R.setVisible(false);</span>
<span class="nc" id="L1176">        wInfantryRange5L.setVisible(false);</span>
<span class="nc" id="L1177">        wInfantryRange5R.setVisible(false);</span>

<span class="nc bnc" id="L1179" title="All 6 branches missed.">        if (entity.isAero() &amp;&amp; (entity.isAirborne() || entity.usesWeaponBays())) {</span>
<span class="nc" id="L1180">            wAVL.setVisible(true);</span>
<span class="nc" id="L1181">            wShortAVR.setVisible(true);</span>
<span class="nc" id="L1182">            wMedAVR.setVisible(true);</span>
<span class="nc" id="L1183">            wLongAVR.setVisible(true);</span>
<span class="nc" id="L1184">            wExtAVR.setVisible(true);</span>
<span class="nc" id="L1185">            wMinL.setVisible(false);</span>
<span class="nc" id="L1186">            wMinR.setVisible(false);</span>
        } else {
<span class="nc" id="L1188">            wAVL.setVisible(false);</span>
<span class="nc" id="L1189">            wShortAVR.setVisible(false);</span>
<span class="nc" id="L1190">            wMedAVR.setVisible(false);</span>
<span class="nc" id="L1191">            wLongAVR.setVisible(false);</span>
<span class="nc" id="L1192">            wExtAVR.setVisible(false);</span>
<span class="nc" id="L1193">            wMinL.setVisible(true);</span>
<span class="nc" id="L1194">            wMinR.setVisible(true);</span>
        }

        // If MaxTech range rules are in play, display the extreme range.
<span class="nc bnc" id="L1198" title="All 4 branches missed.">        if (((game != null) &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_RANGE))</span>
<span class="nc bnc" id="L1199" title="All 6 branches missed.">                || (entity.isAero() &amp;&amp; (entity.isAirborne() || entity.usesWeaponBays()))) { // $NON-NLS-1$</span>
<span class="nc" id="L1200">            wExtL.setVisible(true);</span>
<span class="nc" id="L1201">            wExtR.setVisible(true);</span>
        } else {
<span class="nc" id="L1203">            wExtL.setVisible(false);</span>
<span class="nc" id="L1204">            wExtR.setVisible(false);</span>
        }
<span class="nc" id="L1206">        onResize();</span>
<span class="nc" id="L1207">        addListeners();</span>
<span class="nc" id="L1208">    }</span>

    public int getSelectedEntityId() {
<span class="nc" id="L1211">        return entity.getId();</span>
    }

    /**
     * Selects the weapon with the specified weapon ID.
     */
    public void selectWeapon(int wn) {
<span class="nc bnc" id="L1218" title="All 2 branches missed.">        if (wn == -1) {</span>
<span class="nc" id="L1219">            weaponList.setSelectedIndex(-1);</span>
<span class="nc" id="L1220">            return;</span>
        }
<span class="nc" id="L1222">        int index = ((WeaponListModel)weaponList.getModel()).getIndex(wn);</span>
<span class="nc bnc" id="L1223" title="All 2 branches missed.">        if (index == -1) {</span>
<span class="nc" id="L1224">            weaponList.setSelectedIndex(-1);</span>
<span class="nc" id="L1225">            return;</span>
        }
<span class="nc" id="L1227">        weaponList.setSelectedIndex(index);</span>
<span class="nc" id="L1228">        weaponList.ensureIndexIsVisible(index);</span>
<span class="nc" id="L1229">        displaySelected();</span>
<span class="nc" id="L1230">        weaponList.repaint();</span>
<span class="nc" id="L1231">    }</span>

    /**
     * Returns the Mounted for the selected weapon in the weapon list.
     * @return
     */
    public Mounted getSelectedWeapon() {
<span class="nc" id="L1238">        int selected = weaponList.getSelectedIndex();</span>
<span class="nc bnc" id="L1239" title="All 2 branches missed.">        if (selected == -1) {</span>
<span class="nc" id="L1240">            return null;</span>
        }
<span class="nc" id="L1242">        return ((WeaponListModel) weaponList.getModel())</span>
<span class="nc" id="L1243">                .getWeaponAt(selected);</span>
    }

    /**
     * Returns the equipment ID number for the weapon currently selected
     */
    public int getSelectedWeaponNum() {
<span class="nc" id="L1250">        int selected = weaponList.getSelectedIndex();</span>
<span class="nc bnc" id="L1251" title="All 2 branches missed.">        if (selected == -1) {</span>
<span class="nc" id="L1252">            return -1;</span>
        }
<span class="nc" id="L1254">        return entity.getEquipmentNum(((WeaponListModel) weaponList</span>
<span class="nc" id="L1255">                .getModel()).getWeaponAt(selected));</span>
    }

    /**
     * Selects the first valid weapon in the weapon list.
     * @return The weapon id of the weapon selected
     */
    public int selectFirstWeapon() {
        // Entity has no weapons, return -1;
<span class="nc bnc" id="L1264" title="All 2 branches missed.">        if (entity.getWeaponList().size() == 0</span>
<span class="nc bnc" id="L1265" title="All 2 branches missed.">                || (entity.usesWeaponBays() </span>
<span class="nc bnc" id="L1266" title="All 2 branches missed.">                        &amp;&amp; entity.getWeaponBayList().size() == 0)) {</span>
<span class="nc" id="L1267">            return -1;</span>
        }
<span class="nc" id="L1269">        WeaponListModel weapList = (WeaponListModel)weaponList.getModel();</span>
<span class="nc bnc" id="L1270" title="All 2 branches missed.">        for (int i = 0; i &lt; weaponList.getModel().getSize(); i++) {</span>
<span class="nc" id="L1271">            Mounted selectedWeap = weapList.getWeaponAt(i);</span>
<span class="nc bnc" id="L1272" title="All 2 branches missed.">            if (entity.isWeaponValidForPhase(selectedWeap)) {</span>
<span class="nc" id="L1273">                weaponList.setSelectedIndex(i);</span>
<span class="nc" id="L1274">                weaponList.ensureIndexIsVisible(i);</span>
<span class="nc" id="L1275">                return entity.getEquipmentNum(selectedWeap);</span>
            }
        }
        // Found no valid weapon
<span class="nc" id="L1279">        weaponList.setSelectedIndex(-1);</span>
<span class="nc" id="L1280">        return -1;</span>
    }

    public int getNextWeaponListIdx() {
<span class="nc" id="L1284">        int selected = weaponList.getSelectedIndex();</span>
        // In case nothing was selected
<span class="nc bnc" id="L1286" title="All 2 branches missed.">        if (selected == -1) {</span>
<span class="nc" id="L1287">            selected = weaponList.getModel().getSize() - 1;</span>
        }
        Mounted selectedWeap;
<span class="nc" id="L1290">        int initialSelection = selected;</span>
        
<span class="nc" id="L1292">        boolean hasLooped = false;</span>
        do {
<span class="nc" id="L1294">            selected++;</span>
<span class="nc bnc" id="L1295" title="All 2 branches missed.">            if (selected &gt;= weaponList.getModel().getSize()) {</span>
<span class="nc" id="L1296">                selected = 0;</span>
            }
<span class="nc bnc" id="L1298" title="All 2 branches missed.">            if (selected == initialSelection) {</span>
<span class="nc" id="L1299">                hasLooped = true;</span>
            }
<span class="nc" id="L1301">            selectedWeap = ((WeaponListModel) weaponList.getModel())</span>
<span class="nc" id="L1302">                    .getWeaponAt(selected);</span>
<span class="nc bnc" id="L1303" title="All 4 branches missed.">        } while (!hasLooped &amp;&amp; !entity.isWeaponValidForPhase(selectedWeap));</span>

<span class="nc bnc" id="L1305" title="All 6 branches missed.">        if ((selected &gt;= 0) &amp;&amp; (selected &lt; entity.getWeaponList().size())</span>
                &amp;&amp; !hasLooped) {
<span class="nc" id="L1307">            return selected;</span>
        } else {
<span class="nc" id="L1309">            return -1;</span>
        } 
    }
    
    public int getPrevWeaponListIdx() {
<span class="nc" id="L1314">        int selected = weaponList.getSelectedIndex();</span>
        // In case nothing was selected
<span class="nc bnc" id="L1316" title="All 2 branches missed.">        if (selected == -1) {</span>
<span class="nc" id="L1317">            selected = 0;</span>
        }
        Mounted selectedWeap;
<span class="nc" id="L1320">        int initialSelection = selected;</span>
<span class="nc" id="L1321">        boolean hasLooped = false;</span>
        do {
<span class="nc" id="L1323">            selected--;</span>
<span class="nc bnc" id="L1324" title="All 2 branches missed.">            if (selected &lt; 0) {</span>
<span class="nc" id="L1325">                selected = weaponList.getModel().getSize() - 1;</span>
            }
<span class="nc bnc" id="L1327" title="All 2 branches missed.">            if (selected == initialSelection) {</span>
<span class="nc" id="L1328">                hasLooped = true;</span>
            }
<span class="nc" id="L1330">            selectedWeap = ((WeaponListModel) weaponList.getModel())</span>
<span class="nc" id="L1331">                    .getWeaponAt(selected);</span>
<span class="nc bnc" id="L1332" title="All 4 branches missed.">        } while (!hasLooped &amp;&amp; !entity.isWeaponValidForPhase(selectedWeap));</span>

<span class="nc bnc" id="L1334" title="All 6 branches missed.">        if ((selected &gt;= 0) &amp;&amp; (selected &lt; entity.getWeaponList().size())</span>
                &amp;&amp; !hasLooped) {
<span class="nc" id="L1336">            return selected;</span>
        } else {
<span class="nc" id="L1338">            return -1;</span>
        }
    }
    
    public int getNextWeaponNum() {
<span class="nc" id="L1343">        int selected = getNextWeaponListIdx();</span>
<span class="nc bnc" id="L1344" title="All 4 branches missed.">        if ((selected &gt;= 0) &amp;&amp; (selected &lt; entity.getWeaponList().size())) {</span>
<span class="nc" id="L1345">            return entity.getEquipmentNum(((WeaponListModel) weaponList</span>
<span class="nc" id="L1346">                    .getModel()).getWeaponAt(selected));</span>
        } else {
<span class="nc" id="L1348">            return -1;</span>
        }
    }
    
    /**
     * Selects the next valid weapon in the weapon list.
     *
     * @return The weaponId for the selected weapon
     */
    public int selectNextWeapon() {
<span class="nc" id="L1358">        int selected = getNextWeaponListIdx();</span>
<span class="nc" id="L1359">        weaponList.setSelectedIndex(selected);</span>
<span class="nc" id="L1360">        weaponList.ensureIndexIsVisible(selected);</span>
<span class="nc bnc" id="L1361" title="All 4 branches missed.">        if ((selected &gt;= 0) &amp;&amp; (selected &lt; entity.getWeaponList().size())) {</span>
<span class="nc" id="L1362">            return entity.getEquipmentNum(((WeaponListModel) weaponList</span>
<span class="nc" id="L1363">                    .getModel()).getWeaponAt(selected));</span>
        } else {
<span class="nc" id="L1365">            return -1;</span>
        }
    }

    /**
     * Selects the prevous valid weapon in the weapon list.
     *
     * @return The weaponId for the selected weapon
     */
    public int selectPrevWeapon() {
<span class="nc" id="L1375">        int selected = getPrevWeaponListIdx();</span>
<span class="nc" id="L1376">        weaponList.setSelectedIndex(selected);</span>
<span class="nc" id="L1377">        weaponList.ensureIndexIsVisible(selected);</span>
<span class="nc bnc" id="L1378" title="All 4 branches missed.">        if ((selected &gt;= 0) &amp;&amp; (selected &lt; entity.getWeaponList().size())) {</span>
<span class="nc" id="L1379">            return entity.getEquipmentNum(((WeaponListModel) weaponList</span>
<span class="nc" id="L1380">                    .getModel()).getWeaponAt(selected));</span>
        } else {
<span class="nc" id="L1382">            return -1;</span>
        }
    }


    /**
     * displays the selected item from the list in the weapon display panel.
     */
    private void displaySelected() {
<span class="nc" id="L1391">        removeListeners();</span>
        // short circuit if not selected
<span class="nc bnc" id="L1393" title="All 2 branches missed.">        if (weaponList.getSelectedIndex() == -1) {</span>
<span class="nc" id="L1394">            ((DefaultComboBoxModel&lt;String&gt;) m_chAmmo.getModel())</span>
<span class="nc" id="L1395">                    .removeAllElements();</span>
<span class="nc" id="L1396">            m_chAmmo.setEnabled(false);</span>
<span class="nc" id="L1397">            m_chBayWeapon.removeAllItems();</span>
<span class="nc" id="L1398">            m_chBayWeapon.setEnabled(false);</span>
<span class="nc" id="L1399">            wNameR.setText(&quot;&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1400">            wHeatR.setText(&quot;--&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1401">            wArcHeatR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1402">            wDamR.setText(&quot;--&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1403">            wMinR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1404">            wShortR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1405">            wMedR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1406">            wLongR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1407">            wExtR.setText(&quot;---&quot;); //$NON-NLS-1$</span>

<span class="nc" id="L1409">            wDamageTrooperL.setVisible(false);</span>
<span class="nc" id="L1410">            wDamageTrooperR.setVisible(false);</span>
<span class="nc" id="L1411">            wInfantryRange0L.setVisible(false);</span>
<span class="nc" id="L1412">            wInfantryRange0R.setVisible(false);</span>
<span class="nc" id="L1413">            wInfantryRange1L.setVisible(false);</span>
<span class="nc" id="L1414">            wInfantryRange1R.setVisible(false);</span>
<span class="nc" id="L1415">            wInfantryRange2L.setVisible(false);</span>
<span class="nc" id="L1416">            wInfantryRange2R.setVisible(false);</span>
<span class="nc" id="L1417">            wInfantryRange3L.setVisible(false);</span>
<span class="nc" id="L1418">            wInfantryRange3R.setVisible(false);</span>
<span class="nc" id="L1419">            wInfantryRange4L.setVisible(false);</span>
<span class="nc" id="L1420">            wInfantryRange4R.setVisible(false);</span>
<span class="nc" id="L1421">            wInfantryRange5L.setVisible(false);</span>
<span class="nc" id="L1422">            wInfantryRange5R.setVisible(false);</span>

<span class="nc" id="L1424">            return;</span>
        }

<span class="nc" id="L1427">        Mounted mounted = ((WeaponListModel) weaponList.getModel())</span>
<span class="nc" id="L1428">                .getWeaponAt(weaponList.getSelectedIndex());</span>
<span class="nc" id="L1429">        WeaponType wtype = (WeaponType) mounted.getType();</span>
        // The rules are a bit sparse on airborne (dropping) ground units, but it seems they should
        // still attack like ground units.
<span class="nc bnc" id="L1432" title="All 6 branches missed.">        boolean aerospaceAttack = entity.isAero() &amp;&amp; (entity.isAirborne() || entity.usesWeaponBays());</span>
        // update weapon display
<span class="nc" id="L1434">        wNameR.setText(mounted.getDesc());</span>
<span class="nc" id="L1435">        wHeatR.setText(Integer.toString(mounted.getCurrentHeat()));</span>

<span class="nc" id="L1437">        wArcHeatR.setText(Integer.toString(entity.getHeatInArc(</span>
<span class="nc" id="L1438">                mounted.getLocation(), mounted.isRearMounted())));</span>

<span class="nc bnc" id="L1440" title="All 4 branches missed.">        if (wtype instanceof InfantryWeapon &amp;&amp; !wtype.hasFlag(WeaponType.F_TAG)) {</span>
<span class="nc" id="L1441">            wDamageTrooperL.setVisible(true);</span>
<span class="nc" id="L1442">            wDamageTrooperR.setVisible(true);</span>
<span class="nc" id="L1443">            InfantryWeapon inftype = (InfantryWeapon) wtype;</span>
<span class="nc bnc" id="L1444" title="All 4 branches missed.">            if ((entity instanceof Infantry)</span>
                &amp;&amp; !(entity instanceof BattleArmor)) {
<span class="nc" id="L1446">                wDamageTrooperR</span>
<span class="nc" id="L1447">                        .setText(Double.toString((double) Math</span>
<span class="nc" id="L1448">                                .round(((Infantry) entity)</span>
<span class="nc" id="L1449">                                               .getDamagePerTrooper() * 1000) / 1000));</span>
            } else {
<span class="nc" id="L1451">                wDamageTrooperR.setText(Double.toString(inftype</span>
<span class="nc" id="L1452">                                                                .getInfantryDamage()));</span>
            }
            // what a nightmare to set up all the range info for infantry
            // weapons
<span class="nc" id="L1456">            wMinL.setVisible(false);</span>
<span class="nc" id="L1457">            wShortL.setVisible(false);</span>
<span class="nc" id="L1458">            wMedL.setVisible(false);</span>
<span class="nc" id="L1459">            wLongL.setVisible(false);</span>
<span class="nc" id="L1460">            wExtL.setVisible(false);</span>
<span class="nc" id="L1461">            wMinR.setVisible(false);</span>
<span class="nc" id="L1462">            wShortR.setVisible(false);</span>
<span class="nc" id="L1463">            wMedR.setVisible(false);</span>
<span class="nc" id="L1464">            wLongR.setVisible(false);</span>
<span class="nc" id="L1465">            wExtR.setVisible(false);</span>
<span class="nc" id="L1466">            wInfantryRange0L.setVisible(false);</span>
<span class="nc" id="L1467">            wInfantryRange0R.setVisible(false);</span>
<span class="nc" id="L1468">            wInfantryRange1L.setVisible(false);</span>
<span class="nc" id="L1469">            wInfantryRange1R.setVisible(false);</span>
<span class="nc" id="L1470">            wInfantryRange2L.setVisible(false);</span>
<span class="nc" id="L1471">            wInfantryRange2R.setVisible(false);</span>
<span class="nc" id="L1472">            wInfantryRange3L.setVisible(false);</span>
<span class="nc" id="L1473">            wInfantryRange3R.setVisible(false);</span>
<span class="nc" id="L1474">            wInfantryRange4L.setVisible(false);</span>
<span class="nc" id="L1475">            wInfantryRange4R.setVisible(false);</span>
<span class="nc" id="L1476">            wInfantryRange5L.setVisible(false);</span>
<span class="nc" id="L1477">            wInfantryRange5R.setVisible(false);</span>
<span class="nc" id="L1478">            int zeromods = 0;</span>
<span class="nc bnc" id="L1479" title="All 2 branches missed.">            if (inftype.hasFlag(WeaponType.F_INF_POINT_BLANK)) {</span>
<span class="nc" id="L1480">                zeromods++;</span>
            }

<span class="nc bnc" id="L1483" title="All 2 branches missed.">            if (inftype.hasFlag(WeaponType.F_INF_ENCUMBER)</span>
<span class="nc bnc" id="L1484" title="All 2 branches missed.">                || (inftype.getCrew() &gt; 1)) {</span>
<span class="nc" id="L1485">                zeromods++;</span>
            }

<span class="nc bnc" id="L1488" title="All 2 branches missed.">            if (inftype.hasFlag(WeaponType.F_INF_BURST)) {</span>
<span class="nc" id="L1489">                zeromods--;</span>
            }
            
<span class="nc" id="L1492">            int range = inftype.getInfantryRange();</span>
<span class="nc bnc" id="L1493" title="All 2 branches missed.">            if (entity.getLocationStatus(mounted.getLocation()) == ILocationExposureStatus.WET) {</span>
<span class="nc" id="L1494">            	range /= 2;</span>
            }
<span class="nc bnc" id="L1496" title="All 9 branches missed.">            switch (range) {</span>
                case 0:
<span class="nc" id="L1498">                    wInfantryRange0L.setText(&quot;0&quot;);</span>
<span class="nc" id="L1499">                    wInfantryRange0R.setText(&quot;+&quot; + zeromods);</span>
<span class="nc" id="L1500">                    wInfantryRange0L.setVisible(true);</span>
<span class="nc" id="L1501">                    wInfantryRange0R.setVisible(true);</span>
<span class="nc" id="L1502">                    break;</span>
                case 1:
<span class="nc" id="L1504">                    wInfantryRange0L.setText(&quot;0&quot;);</span>
<span class="nc" id="L1505">                    wInfantryRange0R</span>
<span class="nc" id="L1506">                            .setText(Integer.toString(zeromods - 2));</span>
<span class="nc" id="L1507">                    wInfantryRange0L.setVisible(true);</span>
<span class="nc" id="L1508">                    wInfantryRange0R.setVisible(true);</span>
<span class="nc" id="L1509">                    wInfantryRange1L.setText(&quot;1&quot;);</span>
<span class="nc" id="L1510">                    wInfantryRange1R.setText(&quot;+0&quot;);</span>
<span class="nc" id="L1511">                    wInfantryRange1L.setVisible(true);</span>
<span class="nc" id="L1512">                    wInfantryRange1R.setVisible(true);</span>
<span class="nc" id="L1513">                    wInfantryRange2L.setText(&quot;2&quot;);</span>
<span class="nc" id="L1514">                    wInfantryRange2R.setText(&quot;+2&quot;);</span>
<span class="nc" id="L1515">                    wInfantryRange2L.setVisible(true);</span>
<span class="nc" id="L1516">                    wInfantryRange2R.setVisible(true);</span>
<span class="nc" id="L1517">                    wInfantryRange3L.setText(&quot;3&quot;);</span>
<span class="nc" id="L1518">                    wInfantryRange3R.setText(&quot;+4&quot;);</span>
<span class="nc" id="L1519">                    wInfantryRange3L.setVisible(true);</span>
<span class="nc" id="L1520">                    wInfantryRange3R.setVisible(true);</span>
<span class="nc" id="L1521">                    break;</span>
                case 2:
<span class="nc" id="L1523">                    wInfantryRange0L.setText(&quot;0&quot;);</span>
<span class="nc" id="L1524">                    wInfantryRange0R</span>
<span class="nc" id="L1525">                            .setText(Integer.toString(zeromods - 2));</span>
<span class="nc" id="L1526">                    wInfantryRange0L.setVisible(true);</span>
<span class="nc" id="L1527">                    wInfantryRange0R.setVisible(true);</span>
<span class="nc" id="L1528">                    wInfantryRange1L.setText(&quot;1-2&quot;);</span>
<span class="nc" id="L1529">                    wInfantryRange1R.setText(&quot;+0&quot;);</span>
<span class="nc" id="L1530">                    wInfantryRange1L.setVisible(true);</span>
<span class="nc" id="L1531">                    wInfantryRange1R.setVisible(true);</span>
<span class="nc" id="L1532">                    wInfantryRange2L.setText(&quot;3-4&quot;);</span>
<span class="nc" id="L1533">                    wInfantryRange2R.setText(&quot;+2&quot;);</span>
<span class="nc" id="L1534">                    wInfantryRange2L.setVisible(true);</span>
<span class="nc" id="L1535">                    wInfantryRange2R.setVisible(true);</span>
<span class="nc" id="L1536">                    wInfantryRange3L.setText(&quot;5-6&quot;);</span>
<span class="nc" id="L1537">                    wInfantryRange3R.setText(&quot;+4&quot;);</span>
<span class="nc" id="L1538">                    wInfantryRange3L.setVisible(true);</span>
<span class="nc" id="L1539">                    wInfantryRange3R.setVisible(true);</span>
<span class="nc" id="L1540">                    break;</span>
                case 3:
<span class="nc" id="L1542">                    wInfantryRange0L.setText(&quot;0&quot;);</span>
<span class="nc" id="L1543">                    wInfantryRange0R</span>
<span class="nc" id="L1544">                            .setText(Integer.toString(zeromods - 2));</span>
<span class="nc" id="L1545">                    wInfantryRange0L.setVisible(true);</span>
<span class="nc" id="L1546">                    wInfantryRange0R.setVisible(true);</span>
<span class="nc" id="L1547">                    wInfantryRange1L.setText(&quot;1-3&quot;);</span>
<span class="nc" id="L1548">                    wInfantryRange1R.setText(&quot;+0&quot;);</span>
<span class="nc" id="L1549">                    wInfantryRange1L.setVisible(true);</span>
<span class="nc" id="L1550">                    wInfantryRange1R.setVisible(true);</span>
<span class="nc" id="L1551">                    wInfantryRange2L.setText(&quot;4-6&quot;);</span>
<span class="nc" id="L1552">                    wInfantryRange2R.setText(&quot;+2&quot;);</span>
<span class="nc" id="L1553">                    wInfantryRange2L.setVisible(true);</span>
<span class="nc" id="L1554">                    wInfantryRange2R.setVisible(true);</span>
<span class="nc" id="L1555">                    wInfantryRange3L.setText(&quot;7-9&quot;);</span>
<span class="nc" id="L1556">                    wInfantryRange3R.setText(&quot;+4&quot;);</span>
<span class="nc" id="L1557">                    wInfantryRange3L.setVisible(true);</span>
<span class="nc" id="L1558">                    wInfantryRange3R.setVisible(true);</span>
<span class="nc" id="L1559">                    break;</span>
                case 4:
<span class="nc" id="L1561">                    wInfantryRange0L.setText(&quot;0&quot;);</span>
<span class="nc" id="L1562">                    wInfantryRange0R</span>
<span class="nc" id="L1563">                            .setText(Integer.toString(zeromods - 2));</span>
<span class="nc" id="L1564">                    wInfantryRange0L.setVisible(true);</span>
<span class="nc" id="L1565">                    wInfantryRange0R.setVisible(true);</span>
<span class="nc" id="L1566">                    wInfantryRange1L.setText(&quot;1-4&quot;);</span>
<span class="nc" id="L1567">                    wInfantryRange1R.setText(&quot;+0&quot;);</span>
<span class="nc" id="L1568">                    wInfantryRange1L.setVisible(true);</span>
<span class="nc" id="L1569">                    wInfantryRange1R.setVisible(true);</span>
<span class="nc" id="L1570">                    wInfantryRange2L.setText(&quot;5-6&quot;);</span>
<span class="nc" id="L1571">                    wInfantryRange2R.setText(&quot;+1&quot;);</span>
<span class="nc" id="L1572">                    wInfantryRange2L.setVisible(true);</span>
<span class="nc" id="L1573">                    wInfantryRange2R.setVisible(true);</span>
<span class="nc" id="L1574">                    wInfantryRange3L.setText(&quot;7-8&quot;);</span>
<span class="nc" id="L1575">                    wInfantryRange3R.setText(&quot;+2&quot;);</span>
<span class="nc" id="L1576">                    wInfantryRange3L.setVisible(true);</span>
<span class="nc" id="L1577">                    wInfantryRange3R.setVisible(true);</span>
<span class="nc" id="L1578">                    wInfantryRange4L.setText(&quot;9-10&quot;);</span>
<span class="nc" id="L1579">                    wInfantryRange4R.setText(&quot;+3&quot;);</span>
<span class="nc" id="L1580">                    wInfantryRange4L.setVisible(true);</span>
<span class="nc" id="L1581">                    wInfantryRange4R.setVisible(true);</span>
<span class="nc" id="L1582">                    wInfantryRange5L.setText(&quot;11-12&quot;);</span>
<span class="nc" id="L1583">                    wInfantryRange5R.setText(&quot;+4&quot;);</span>
<span class="nc" id="L1584">                    wInfantryRange5L.setVisible(true);</span>
<span class="nc" id="L1585">                    wInfantryRange5R.setVisible(true);</span>
<span class="nc" id="L1586">                    break;</span>
                case 5:
<span class="nc" id="L1588">                    wInfantryRange0L.setText(&quot;0&quot;);</span>
<span class="nc" id="L1589">                    wInfantryRange0R</span>
<span class="nc" id="L1590">                            .setText(Integer.toString(zeromods - 1));</span>
<span class="nc" id="L1591">                    wInfantryRange0L.setVisible(true);</span>
<span class="nc" id="L1592">                    wInfantryRange0R.setVisible(true);</span>
<span class="nc" id="L1593">                    wInfantryRange1L.setText(&quot;1-5&quot;);</span>
<span class="nc" id="L1594">                    wInfantryRange1R.setText(&quot;+0&quot;);</span>
<span class="nc" id="L1595">                    wInfantryRange1L.setVisible(true);</span>
<span class="nc" id="L1596">                    wInfantryRange1R.setVisible(true);</span>
<span class="nc" id="L1597">                    wInfantryRange2L.setText(&quot;6-7&quot;);</span>
<span class="nc" id="L1598">                    wInfantryRange2R.setText(&quot;+1&quot;);</span>
<span class="nc" id="L1599">                    wInfantryRange2L.setVisible(true);</span>
<span class="nc" id="L1600">                    wInfantryRange2R.setVisible(true);</span>
<span class="nc" id="L1601">                    wInfantryRange3L.setText(&quot;8-10&quot;);</span>
<span class="nc" id="L1602">                    wInfantryRange3R.setText(&quot;+2&quot;);</span>
<span class="nc" id="L1603">                    wInfantryRange3L.setVisible(true);</span>
<span class="nc" id="L1604">                    wInfantryRange3R.setVisible(true);</span>
<span class="nc" id="L1605">                    wInfantryRange4L.setText(&quot;11-12&quot;);</span>
<span class="nc" id="L1606">                    wInfantryRange4R.setText(&quot;+3&quot;);</span>
<span class="nc" id="L1607">                    wInfantryRange4L.setVisible(true);</span>
<span class="nc" id="L1608">                    wInfantryRange4R.setVisible(true);</span>
<span class="nc" id="L1609">                    wInfantryRange5L.setText(&quot;13-15&quot;);</span>
<span class="nc" id="L1610">                    wInfantryRange5R.setText(&quot;+4&quot;);</span>
<span class="nc" id="L1611">                    wInfantryRange5L.setVisible(true);</span>
<span class="nc" id="L1612">                    wInfantryRange5R.setVisible(true);</span>
<span class="nc" id="L1613">                    break;</span>
                case 6:
<span class="nc" id="L1615">                    wInfantryRange0L.setText(&quot;0&quot;);</span>
<span class="nc" id="L1616">                    wInfantryRange0R</span>
<span class="nc" id="L1617">                            .setText(Integer.toString(zeromods - 1));</span>
<span class="nc" id="L1618">                    wInfantryRange0L.setVisible(true);</span>
<span class="nc" id="L1619">                    wInfantryRange0R.setVisible(true);</span>
<span class="nc" id="L1620">                    wInfantryRange1L.setText(&quot;1-6&quot;);</span>
<span class="nc" id="L1621">                    wInfantryRange1R.setText(&quot;+0&quot;);</span>
<span class="nc" id="L1622">                    wInfantryRange1L.setVisible(true);</span>
<span class="nc" id="L1623">                    wInfantryRange1R.setVisible(true);</span>
<span class="nc" id="L1624">                    wInfantryRange2L.setText(&quot;7-9&quot;);</span>
<span class="nc" id="L1625">                    wInfantryRange2R.setText(&quot;+1&quot;);</span>
<span class="nc" id="L1626">                    wInfantryRange2L.setVisible(true);</span>
<span class="nc" id="L1627">                    wInfantryRange2R.setVisible(true);</span>
<span class="nc" id="L1628">                    wInfantryRange3L.setText(&quot;10-12&quot;);</span>
<span class="nc" id="L1629">                    wInfantryRange3R.setText(&quot;+2&quot;);</span>
<span class="nc" id="L1630">                    wInfantryRange3L.setVisible(true);</span>
<span class="nc" id="L1631">                    wInfantryRange3R.setVisible(true);</span>
<span class="nc" id="L1632">                    wInfantryRange4L.setText(&quot;13-15&quot;);</span>
<span class="nc" id="L1633">                    wInfantryRange4R.setText(&quot;+4&quot;);</span>
<span class="nc" id="L1634">                    wInfantryRange4L.setVisible(true);</span>
<span class="nc" id="L1635">                    wInfantryRange4R.setVisible(true);</span>
<span class="nc" id="L1636">                    wInfantryRange5L.setText(&quot;16-18&quot;);</span>
<span class="nc" id="L1637">                    wInfantryRange5R.setText(&quot;+5&quot;);</span>
<span class="nc" id="L1638">                    wInfantryRange5L.setVisible(true);</span>
<span class="nc" id="L1639">                    wInfantryRange5R.setVisible(true);</span>
<span class="nc" id="L1640">                    break;</span>
                case 7:
<span class="nc" id="L1642">                    wInfantryRange0L.setText(&quot;0&quot;);</span>
<span class="nc" id="L1643">                    wInfantryRange0R</span>
<span class="nc" id="L1644">                            .setText(Integer.toString(zeromods - 1));</span>
<span class="nc" id="L1645">                    wInfantryRange0L.setVisible(true);</span>
<span class="nc" id="L1646">                    wInfantryRange0R.setVisible(true);</span>
<span class="nc" id="L1647">                    wInfantryRange1L.setText(&quot;1-7&quot;);</span>
<span class="nc" id="L1648">                    wInfantryRange1R.setText(&quot;+0&quot;);</span>
<span class="nc" id="L1649">                    wInfantryRange1L.setVisible(true);</span>
<span class="nc" id="L1650">                    wInfantryRange1R.setVisible(true);</span>
<span class="nc" id="L1651">                    wInfantryRange2L.setText(&quot;8-10&quot;);</span>
<span class="nc" id="L1652">                    wInfantryRange2R.setText(&quot;+1&quot;);</span>
<span class="nc" id="L1653">                    wInfantryRange2L.setVisible(true);</span>
<span class="nc" id="L1654">                    wInfantryRange2R.setVisible(true);</span>
<span class="nc" id="L1655">                    wInfantryRange3L.setText(&quot;11-14&quot;);</span>
<span class="nc" id="L1656">                    wInfantryRange3R.setText(&quot;+2&quot;);</span>
<span class="nc" id="L1657">                    wInfantryRange3L.setVisible(true);</span>
<span class="nc" id="L1658">                    wInfantryRange3R.setVisible(true);</span>
<span class="nc" id="L1659">                    wInfantryRange4L.setText(&quot;15-17&quot;);</span>
<span class="nc" id="L1660">                    wInfantryRange4R.setText(&quot;+4&quot;);</span>
<span class="nc" id="L1661">                    wInfantryRange4L.setVisible(true);</span>
<span class="nc" id="L1662">                    wInfantryRange4R.setVisible(true);</span>
<span class="nc" id="L1663">                    wInfantryRange5L.setText(&quot;18-21&quot;);</span>
<span class="nc" id="L1664">                    wInfantryRange5R.setText(&quot;+6&quot;);</span>
<span class="nc" id="L1665">                    wInfantryRange5L.setVisible(true);</span>
<span class="nc" id="L1666">                    wInfantryRange5R.setVisible(true);</span>
                    break;
            }
<span class="nc" id="L1669">        } else {</span>
<span class="nc" id="L1670">            wDamageTrooperL.setVisible(false);</span>
<span class="nc" id="L1671">            wDamageTrooperR.setVisible(false);</span>
<span class="nc" id="L1672">            wInfantryRange0L.setVisible(false);</span>
<span class="nc" id="L1673">            wInfantryRange0R.setVisible(false);</span>
<span class="nc" id="L1674">            wInfantryRange1L.setVisible(false);</span>
<span class="nc" id="L1675">            wInfantryRange1R.setVisible(false);</span>
<span class="nc" id="L1676">            wInfantryRange2L.setVisible(false);</span>
<span class="nc" id="L1677">            wInfantryRange2R.setVisible(false);</span>
<span class="nc" id="L1678">            wInfantryRange3L.setVisible(false);</span>
<span class="nc" id="L1679">            wInfantryRange3R.setVisible(false);</span>
<span class="nc" id="L1680">            wInfantryRange4L.setVisible(false);</span>
<span class="nc" id="L1681">            wInfantryRange4R.setVisible(false);</span>
<span class="nc" id="L1682">            wInfantryRange5L.setVisible(false);</span>
<span class="nc" id="L1683">            wInfantryRange5R.setVisible(false);</span>
<span class="nc" id="L1684">            wShortL.setVisible(true);</span>
<span class="nc" id="L1685">            wMedL.setVisible(true);</span>
<span class="nc" id="L1686">            wLongL.setVisible(true);</span>

<span class="nc" id="L1688">            wMinR.setVisible(true);</span>
<span class="nc" id="L1689">            wShortR.setVisible(true);</span>
<span class="nc" id="L1690">            wMedR.setVisible(true);</span>
<span class="nc" id="L1691">            wLongR.setVisible(true);</span>

<span class="nc bnc" id="L1693" title="All 2 branches missed.">            if (!aerospaceAttack) {</span>
<span class="nc" id="L1694">                wMinL.setVisible(true);</span>
<span class="nc" id="L1695">                wMinR.setVisible(true);</span>
            }
<span class="nc bnc" id="L1697" title="All 2 branches missed.">            if (((entity.getGame() != null)</span>
<span class="nc bnc" id="L1698" title="All 4 branches missed.">                    &amp;&amp; entity.getGame().getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_RANGE))</span>
                    || aerospaceAttack) {
<span class="nc" id="L1700">                wExtL.setVisible(true);</span>
<span class="nc" id="L1701">                wExtR.setVisible(true);</span>
            }
        }

<span class="nc bnc" id="L1705" title="All 2 branches missed.">        if (wtype.getDamage() == WeaponType.DAMAGE_BY_CLUSTERTABLE) {</span>
<span class="nc bnc" id="L1706" title="All 2 branches missed.">            if (wtype instanceof HAGWeapon) {</span>
<span class="nc" id="L1707">                wDamR.setText(Messages.getString(&quot;MechDisplay.Variable&quot;)); //$NON-NLS-1$</span>
            } else {
<span class="nc" id="L1709">                wDamR.setText(Messages.getString(&quot;MechDisplay.Missile&quot;)); //$NON-NLS-1$</span>
            }
<span class="nc bnc" id="L1711" title="All 2 branches missed.">        } else if (wtype.getDamage() == WeaponType.DAMAGE_VARIABLE) {</span>
<span class="nc" id="L1712">            wDamR.setText(Messages.getString(&quot;MechDisplay.Variable&quot;)); //$NON-NLS-1$</span>
<span class="nc bnc" id="L1713" title="All 2 branches missed.">        } else if (wtype.getDamage() == WeaponType.DAMAGE_SPECIAL) {</span>
<span class="nc" id="L1714">            wDamR.setText(Messages.getString(&quot;MechDisplay.Special&quot;)); //$NON-NLS-1$</span>
<span class="nc bnc" id="L1715" title="All 2 branches missed.">        } else if (wtype.getDamage() == WeaponType.DAMAGE_ARTILLERY) {</span>
<span class="nc" id="L1716">            StringBuffer damage = new StringBuffer();</span>
<span class="nc" id="L1717">            int artyDamage = wtype.getRackSize();</span>
<span class="nc" id="L1718">            damage.append(Integer.toString(artyDamage));</span>
<span class="nc" id="L1719">            artyDamage -= 10;</span>
<span class="nc bnc" id="L1720" title="All 2 branches missed.">            while (artyDamage &gt; 0) {</span>
<span class="nc" id="L1721">                damage.append('/').append(Integer.toString(artyDamage));</span>
<span class="nc" id="L1722">                artyDamage -= 10;</span>
            }
<span class="nc" id="L1724">            wDamR.setText(damage.toString());</span>
<span class="nc bnc" id="L1725" title="All 2 branches missed.">        } else if (wtype.hasFlag(WeaponType.F_ENERGY)</span>
<span class="nc bnc" id="L1726" title="All 2 branches missed.">                   &amp;&amp; wtype.hasModes()</span>
<span class="nc bnc" id="L1727" title="All 4 branches missed.">                   &amp;&amp; (unitDisplay.getClientGUI() != null) &amp;&amp; unitDisplay.getClientGUI().getClient().getGame().getOptions().booleanOption(</span>
                OptionsConstants.ADVCOMBAT_TACOPS_ENERGY_WEAPONS)) {
<span class="nc bnc" id="L1729" title="All 2 branches missed.">            if (mounted.hasChargedCapacitor() != 0) {</span>
<span class="nc bnc" id="L1730" title="All 2 branches missed.">                if (mounted.hasChargedCapacitor() == 1) {</span>
<span class="nc" id="L1731">                    wDamR.setText(Integer.toString(Compute.dialDownDamage(</span>
                            mounted, wtype) + 5));
                }
<span class="nc bnc" id="L1734" title="All 2 branches missed.">                if (mounted.hasChargedCapacitor() == 2) {</span>
<span class="nc" id="L1735">                    wDamR.setText(Integer.toString(Compute.dialDownDamage(</span>
                            mounted, wtype) + 10));
                }
            } else {
<span class="nc" id="L1739">                wDamR.setText(Integer.toString(Compute.dialDownDamage(</span>
                        mounted, wtype)));
            }
        } else {
<span class="nc" id="L1743">            wDamR.setText(Integer.toString(wtype.getDamage()));</span>
        }

        // update range
<span class="nc" id="L1747">        int shortR = wtype.getShortRange();</span>
<span class="nc" id="L1748">        int mediumR = wtype.getMediumRange();</span>
<span class="nc" id="L1749">        int longR = wtype.getLongRange();</span>
<span class="nc" id="L1750">        int extremeR = wtype.getExtremeRange();</span>
<span class="nc bnc" id="L1751" title="All 2 branches missed.">        if (mounted.isInBearingsOnlyMode()) {</span>
<span class="nc" id="L1752">            extremeR = RangeType.RANGE_BEARINGS_ONLY_OUT;</span>
        }
<span class="nc bnc" id="L1754" title="All 4 branches missed.">        if ((entity.getLocationStatus(mounted.getLocation()) == ILocationExposureStatus.WET)</span>
            || (longR == 0)) {
<span class="nc" id="L1756">            shortR = wtype.getWShortRange();</span>
<span class="nc" id="L1757">            mediumR = wtype.getWMediumRange();</span>
<span class="nc" id="L1758">            longR = wtype.getWLongRange();</span>
<span class="nc" id="L1759">            extremeR = wtype.getWExtremeRange();</span>
<span class="nc bnc" id="L1760" title="All 2 branches missed.">        } else if (wtype.hasFlag(WeaponType.F_PDBAY)) {</span>
        //Point Defense bays have a variable range, depending on the mode they're in
<span class="nc bnc" id="L1762" title="All 4 branches missed.">            if (wtype.hasModes() &amp;&amp; mounted.curMode().equals(&quot;Point Defense&quot;)) {</span>
<span class="nc" id="L1763">                shortR = 1;</span>
<span class="nc" id="L1764">                wShortR.setText(&quot;1&quot;); //$NON-NLS-1$</span>
            } else {
<span class="nc" id="L1766">                shortR = 6;</span>
<span class="nc" id="L1767">                wShortR.setText(&quot;1-6&quot;); //$NON-NLS-1$</span>
            }
        }
        // We need to adjust the ranges for Centurion Weapon Systems: it's
        //  default range is 6/12/18 but that's only for units that are
        //  susceptible to CWS, for those that aren't the ranges are 1/2/3
<span class="nc bnc" id="L1773" title="All 2 branches missed.">        if (wtype.hasFlag(WeaponType.F_CWS)) {</span>
<span class="nc" id="L1774">            Entity target = null;</span>
<span class="nc bnc" id="L1775" title="All 2 branches missed.">            if ((unitDisplay.getClientGUI() != null)</span>
<span class="nc bnc" id="L1776" title="All 2 branches missed.">                &amp;&amp; (unitDisplay.getClientGUI().getCurrentPanel() instanceof FiringDisplay)) {</span>
<span class="nc" id="L1777">                Targetable t =</span>
<span class="nc" id="L1778">                        ((FiringDisplay) unitDisplay.getClientGUI().getCurrentPanel()).getTarget();</span>
<span class="nc bnc" id="L1779" title="All 2 branches missed.">                if (t instanceof Entity) {</span>
<span class="nc" id="L1780">                    target = (Entity) t;</span>
                }
            }
<span class="nc bnc" id="L1783" title="All 4 branches missed.">            if ((target == null) || !target.hasQuirk(&quot;susceptible_cws&quot;)) {</span>
<span class="nc" id="L1784">                shortR = 1;</span>
<span class="nc" id="L1785">                mediumR = 2;</span>
<span class="nc" id="L1786">                longR = 3;</span>
<span class="nc" id="L1787">                extremeR = 4;</span>
            }
        }
<span class="nc bnc" id="L1790" title="All 2 branches missed.">        if (wtype.getMinimumRange() &gt; 0) {</span>
<span class="nc" id="L1791">            wMinR.setText(Integer.toString(wtype.getMinimumRange()));</span>
        } else {
<span class="nc" id="L1793">            wMinR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
        }
<span class="nc bnc" id="L1795" title="All 2 branches missed.">        if (shortR &gt; 1) {</span>
<span class="nc" id="L1796">            wShortR.setText(&quot;1 - &quot; + shortR); //$NON-NLS-1$</span>
        } else {
<span class="nc" id="L1798">            wShortR.setText(&quot;&quot; + shortR); //$NON-NLS-1$</span>
        }
<span class="nc bnc" id="L1800" title="All 2 branches missed.">        if ((mediumR - shortR) &gt; 1) {</span>
<span class="nc" id="L1801">            wMedR.setText(shortR + 1 + &quot; - &quot; + mediumR); //$NON-NLS-1$</span>
        } else {
<span class="nc" id="L1803">            wMedR.setText(&quot;&quot; + mediumR); //$NON-NLS-1$</span>
        }
<span class="nc bnc" id="L1805" title="All 2 branches missed.">        if ((longR - mediumR) &gt; 1) {</span>
<span class="nc" id="L1806">            wLongR.setText(mediumR + 1 + &quot; - &quot; + longR); //$NON-NLS-1$</span>
        } else {
<span class="nc" id="L1808">            wLongR.setText(&quot;&quot; + longR); //$NON-NLS-1$</span>
        }
<span class="nc bnc" id="L1810" title="All 2 branches missed.">        if ((extremeR - longR) &gt; 1) {</span>
<span class="nc" id="L1811">            wExtR.setText(longR + 1 + &quot; - &quot; + extremeR); //$NON-NLS-1$</span>
        } else {
<span class="nc" id="L1813">            wExtR.setText(&quot;&quot; + extremeR); //$NON-NLS-1$</span>
        }

        // Update the range display to account for the weapon's loaded ammo.
<span class="nc bnc" id="L1817" title="All 2 branches missed.">        if (mounted.getLinked() != null) {</span>
<span class="nc" id="L1818">            updateRangeDisplayForAmmo(mounted.getLinked());</span>
        }

<span class="nc bnc" id="L1821" title="All 2 branches missed.">        if (aerospaceAttack) {</span>
            // change damage report to a statement of standard or capital
<span class="nc bnc" id="L1823" title="All 2 branches missed.">            if (wtype.isCapital()) {</span>
<span class="nc" id="L1824">                wDamR.setText(Messages.getString(&quot;MechDisplay.CapitalD&quot;)); //$NON-NLS-1$</span>
            } else {
<span class="nc" id="L1826">                wDamR.setText(Messages.getString(&quot;MechDisplay.StandardD&quot;)); //$NON-NLS-1$</span>
            }

            // if this is a weapons bay, then I need to compile it to get
            // accurate results
<span class="nc bnc" id="L1831" title="All 2 branches missed.">            if (wtype instanceof BayWeapon) {</span>
<span class="nc" id="L1832">                compileWeaponBay(mounted, wtype.isCapital());</span>
            } else {
                // otherwise I need to replace range display with standard
                // ranges and attack values
<span class="nc" id="L1836">                updateAttackValues(mounted, mounted.getLinked());</span>
            }

        }

        // update weapon bay selector
<span class="nc" id="L1842">        int chosen = m_chBayWeapon.getSelectedIndex();</span>
<span class="nc" id="L1843">        m_chBayWeapon.removeAllItems();</span>
<span class="nc bnc" id="L1844" title="All 4 branches missed.">        if (!(wtype instanceof BayWeapon) || !entity.usesWeaponBays()) {</span>
<span class="nc" id="L1845">            m_chBayWeapon.setEnabled(false);</span>
        } else {
<span class="nc" id="L1847">            m_chBayWeapon.setEnabled(true);</span>
<span class="nc bnc" id="L1848" title="All 2 branches missed.">            for (int wId : mounted.getBayWeapons()) {</span>
<span class="nc" id="L1849">                Mounted curWeapon = entity.getEquipment(wId);</span>
<span class="nc bnc" id="L1850" title="All 2 branches missed.">                if (null == curWeapon) {</span>
<span class="nc" id="L1851">                    continue;</span>
                }

<span class="nc" id="L1854">                m_chBayWeapon.addItem(formatBayWeapon(curWeapon));</span>
<span class="nc" id="L1855">            }</span>

<span class="nc bnc" id="L1857" title="All 4 branches missed.">            if (chosen == -1 || chosen &gt;= m_chBayWeapon.getItemCount()) {</span>
<span class="nc" id="L1858">                m_chBayWeapon.setSelectedIndex(0);</span>
            } else {
<span class="nc" id="L1860">                m_chBayWeapon.setSelectedIndex(chosen);</span>
            }
        }

        // update ammo selector
<span class="nc" id="L1865">        ((DefaultComboBoxModel&lt;String&gt;) m_chAmmo.getModel()).removeAllElements();</span>
<span class="nc" id="L1866">        Mounted oldmount = mounted;</span>
<span class="nc bnc" id="L1867" title="All 2 branches missed.">        if (wtype instanceof BayWeapon) {</span>
<span class="nc" id="L1868">            int n = m_chBayWeapon.getSelectedIndex();</span>
<span class="nc bnc" id="L1869" title="All 2 branches missed.">            if (n == -1) {</span>
<span class="nc" id="L1870">                n = 0;</span>
            }
<span class="nc" id="L1872">            mounted = entity.getEquipment(mounted.getBayWeapons()</span>
<span class="nc" id="L1873">                                                 .elementAt(n));</span>
<span class="nc" id="L1874">            wtype = (WeaponType) mounted.getType();</span>
        }
        
<span class="nc bnc" id="L1877" title="All 2 branches missed.">        if (wtype.getAmmoType() == AmmoType.T_NA) {</span>
<span class="nc" id="L1878">            m_chAmmo.setEnabled(false);</span>
<span class="nc bnc" id="L1879" title="All 2 branches missed.">        } else if (wtype.hasFlag(WeaponType.F_DOUBLE_ONESHOT)</span>
<span class="nc bnc" id="L1880" title="All 4 branches missed.">                || (entity.isSupportVehicle() &amp;&amp; (wtype.getAmmoType() == AmmoType.T_INFANTRY))) {</span>
<span class="nc" id="L1881">            int count = 0;</span>
<span class="nc" id="L1882">            vAmmo = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1883" title="All 2 branches missed.">            for (Mounted current = mounted.getLinked(); current != null; current = current.getLinked()) {</span>
<span class="nc bnc" id="L1884" title="All 2 branches missed.">                if (current.getUsableShotsLeft() &gt; 0) {</span>
<span class="nc" id="L1885">                    vAmmo.add(current);</span>
<span class="nc" id="L1886">                    m_chAmmo.addItem(formatAmmo(current));</span>
<span class="nc" id="L1887">                    count++;</span>
                }
            }
            // If there is no remaining ammo, show the last one linked and disable
<span class="nc bnc" id="L1891" title="All 2 branches missed.">            if (count == 0) {</span>
<span class="nc" id="L1892">                m_chAmmo.addItem(formatAmmo(mounted.getLinked()));</span>
            }
<span class="nc" id="L1894">            m_chAmmo.setSelectedIndex(0);</span>
<span class="nc bnc" id="L1895" title="All 2 branches missed.">            m_chAmmo.setEnabled(count &gt; 0);</span>

        // this is the situation where there's some kind of ammo but it's not changeable
<span class="nc bnc" id="L1898" title="All 2 branches missed.">        } else if (wtype.hasFlag(WeaponType.F_ONESHOT)) {</span>
<span class="nc" id="L1899">            m_chAmmo.setEnabled(false);</span>
<span class="nc" id="L1900">            Mounted mountedAmmo = mounted.getLinked();</span>
<span class="nc bnc" id="L1901" title="All 2 branches missed.">            if (mountedAmmo != null) {</span>
<span class="nc" id="L1902">                m_chAmmo.addItem(formatAmmo(mountedAmmo));</span>
            }
<span class="nc" id="L1904">        } else {</span>
<span class="nc" id="L1905">            m_chAmmo.setEnabled(true);</span>
<span class="nc" id="L1906">            vAmmo = new ArrayList&lt;Mounted&gt;();</span>
<span class="nc" id="L1907">            int nCur = -1;</span>
<span class="nc" id="L1908">            int i = 0;</span>
            //Ammo sharing between adjacent trailers
<span class="nc" id="L1910">            List&lt;Mounted&gt; fullAmmoList = new ArrayList&lt;Mounted&gt;(entity.getAmmo());</span>
<span class="nc bnc" id="L1911" title="All 2 branches missed.">            if (entity.getTowedBy() != Entity.NONE) {</span>
<span class="nc" id="L1912">                Entity ahead = entity.getGame().getEntity(entity.getTowedBy());</span>
<span class="nc" id="L1913">                fullAmmoList.addAll(ahead.getAmmo());</span>
            }
<span class="nc bnc" id="L1915" title="All 2 branches missed.">            if (entity.getTowing() != Entity.NONE) {</span>
<span class="nc" id="L1916">                Entity behind = entity.getGame().getEntity(entity.getTowing());</span>
<span class="nc" id="L1917">                fullAmmoList.addAll(behind.getAmmo());</span>
            }
<span class="nc bnc" id="L1919" title="All 2 branches missed.">            for (Mounted mountedAmmo : fullAmmoList) {</span>
<span class="nc" id="L1920">                AmmoType atype = (AmmoType) mountedAmmo.getType();</span>
                // for all aero units other than fighters,
                // ammo must be located in the same place to be usable
<span class="nc" id="L1923">                boolean same = true;</span>
<span class="nc bnc" id="L1924" title="All 4 branches missed.">                if ((entity instanceof SmallCraft)</span>
                    || (entity instanceof Jumpship)) {
<span class="nc" id="L1926">                    same = (mounted.getLocation() == mountedAmmo</span>
<span class="nc bnc" id="L1927" title="All 2 branches missed.">                            .getLocation());</span>
                }

<span class="nc" id="L1930">                boolean rightBay = true;</span>
<span class="nc bnc" id="L1931" title="All 4 branches missed.">                if (entity.usesWeaponBays() &amp;&amp; !(entity instanceof FighterSquadron)) {</span>
<span class="nc" id="L1932">                    rightBay = oldmount.ammoInBay(entity.getEquipmentNum(mountedAmmo));</span>
                }
                
                // covers the situation where a weapon using non-caseless ammo should 
                // not be able to switch to caseless on the fly and vice versa
<span class="nc" id="L1937">                boolean canSwitchToAmmo = AmmoType.canSwitchToAmmo(mounted, atype);</span>

<span class="nc bnc" id="L1939" title="All 8 branches missed.">                if (mountedAmmo.isAmmoUsable() &amp;&amp; same &amp;&amp; rightBay &amp;&amp; canSwitchToAmmo</span>
<span class="nc bnc" id="L1940" title="All 2 branches missed.">                    &amp;&amp; (atype.getAmmoType() == wtype.getAmmoType())</span>
<span class="nc bnc" id="L1941" title="All 2 branches missed.">                    &amp;&amp; (atype.getRackSize() == wtype.getRackSize())) {</span>

<span class="nc" id="L1943">                    vAmmo.add(mountedAmmo);</span>
<span class="nc" id="L1944">                    m_chAmmo.addItem(formatAmmo(mountedAmmo));</span>
<span class="nc bnc" id="L1945" title="All 2 branches missed.">                    if ((mounted.getLinked() != null) &amp;&amp;</span>
<span class="nc bnc" id="L1946" title="All 2 branches missed.">                        mounted.getLinked().equals(mountedAmmo)) {</span>
<span class="nc" id="L1947">                        nCur = i;</span>
                    }
<span class="nc" id="L1949">                    i++;</span>
                }
<span class="nc" id="L1951">            }</span>
<span class="nc bnc" id="L1952" title="All 2 branches missed.">            if (nCur != -1) {</span>
<span class="nc" id="L1953">                m_chAmmo.setSelectedIndex(nCur);</span>
            }
        }

        // send event to other parts of the UI which care
<span class="nc bnc" id="L1958" title="All 2 branches missed.">        if (oldmount.isInWaypointLaunchMode()) {</span>
<span class="nc" id="L1959">            setFieldofFire(oldmount);</span>
        } else {
<span class="nc" id="L1961">            setFieldofFire(mounted);</span>
        }
<span class="nc" id="L1963">        unitDisplay.processMechDisplayEvent(new MechDisplayEvent(this, entity, mounted));</span>
<span class="nc" id="L1964">        onResize();</span>
<span class="nc" id="L1965">        addListeners();</span>
<span class="nc" id="L1966">    }</span>
    
    // this gathers all the range data 
    // it is a boiled down version of displaySelected,
    // updateAttackValues, updateRangeDisplayforAmmo
    private void setFieldofFire(Mounted mounted) {
        // No field of fire without ClientGUI
<span class="nc bnc" id="L1973" title="All 2 branches missed.">        if (unitDisplay.getClientGUI() == null) </span>
<span class="nc" id="L1974">            return;</span>
        
<span class="nc" id="L1976">        ClientGUI gui = unitDisplay.getClientGUI();</span>

<span class="nc" id="L1978">        WeaponType wtype = (WeaponType) mounted.getType();</span>
<span class="nc" id="L1979">        int[][] ranges = new int[2][5];</span>
<span class="nc" id="L1980">        ranges[0] = wtype.getRanges(mounted);</span>

<span class="nc" id="L1982">        AmmoType atype = null;</span>
<span class="nc bnc" id="L1983" title="All 2 branches missed.">        if (mounted.getLinked() != null) </span>
<span class="nc" id="L1984">            atype = (AmmoType) mounted.getLinked().getType();</span>

        // gather underwater ranges
<span class="nc" id="L1987">        ranges[1] = wtype.getWRanges();</span>
<span class="nc bnc" id="L1988" title="All 2 branches missed.">        if (atype != null) {</span>
<span class="nc bnc" id="L1989" title="All 2 branches missed.">            if ((wtype.getAmmoType() == AmmoType.T_SRM)</span>
<span class="nc bnc" id="L1990" title="All 2 branches missed.">                    || (wtype.getAmmoType() == AmmoType.T_SRM_IMP)</span>
<span class="nc bnc" id="L1991" title="All 2 branches missed.">                    || (wtype.getAmmoType() == AmmoType.T_MRM)</span>
<span class="nc bnc" id="L1992" title="All 2 branches missed.">                    || (wtype.getAmmoType() == AmmoType.T_LRM)</span>
<span class="nc bnc" id="L1993" title="All 2 branches missed.">                    || (wtype.getAmmoType() == AmmoType.T_LRM_IMP)</span>
<span class="nc bnc" id="L1994" title="All 2 branches missed.">                    || (wtype.getAmmoType() == AmmoType.T_MML)) {</span>
<span class="nc bnc" id="L1995" title="All 2 branches missed.">                if (atype.getMunitionType() == AmmoType.M_TORPEDO) {</span>
<span class="nc" id="L1996">                    ranges[1] = wtype.getRanges(mounted);</span>
<span class="nc bnc" id="L1997" title="All 2 branches missed.">                } else if (atype.getMunitionType() == AmmoType.M_MULTI_PURPOSE) {</span>
<span class="nc" id="L1998">                    ranges[1] = wtype.getRanges(mounted);</span>
                }
            }
        }

        // Infantry range types 4+ are simplified to 
        // the usual range types as displaying 5 range circles
        // would be visual overkill (and besides this makes
        // things easier)
<span class="nc bnc" id="L2007" title="All 2 branches missed.">        if (wtype instanceof InfantryWeapon) {</span>
<span class="nc" id="L2008">            InfantryWeapon inftype = (InfantryWeapon) wtype;</span>
<span class="nc" id="L2009">            int iR = inftype.getInfantryRange();</span>
<span class="nc" id="L2010">            ranges[0] = </span>
                    new int[] { 0, iR, iR * 2, iR * 3, 0 };
<span class="nc" id="L2012">            ranges[1] =</span>
            		new int[] { 0, iR / 2, (iR / 2) * 2, (iR / 2) * 3, 0 }; 
        }

        // Artillery gets fixed ranges, 100 as an arbitrary
        // large range for the targeting phase and
        // 6 to 17 in the other phases as it will be
        // direct fire then
<span class="nc bnc" id="L2020" title="All 2 branches missed.">        if (wtype.hasFlag(WeaponType.F_ARTILLERY)) {</span>
<span class="nc bnc" id="L2021" title="All 2 branches missed.">            if (gui.getCurrentPanel() instanceof TargetingPhaseDisplay) {</span>
<span class="nc" id="L2022">                ranges[0] = new int[] { 0, 0, 0, 100, 0 };  </span>
<span class="nc" id="L2023">                ranges[1] = new int[] { 0, 0, 0, 0, 0 };</span>
            } else {
<span class="nc" id="L2025">                ranges[0] = new int[] { 6, 0, 0, 17, 0 };  </span>
<span class="nc" id="L2026">                ranges[1] = new int[] { 0, 0, 0, 0, 0 };</span>
            }
        }

        // Override for the various ATM and MML ammos
<span class="nc bnc" id="L2031" title="All 2 branches missed.">        if (atype != null) {</span>
<span class="nc bnc" id="L2032" title="All 2 branches missed.">            if (atype.getAmmoType() == AmmoType.T_ATM) {</span>
<span class="nc bnc" id="L2033" title="All 2 branches missed.">                if (atype.getMunitionType() == AmmoType.M_EXTENDED_RANGE) </span>
<span class="nc" id="L2034">                    ranges[0] = new int[] { 4, 9, 18, 27, 36 }; </span>
<span class="nc bnc" id="L2035" title="All 2 branches missed.">                else if (atype.getMunitionType() == AmmoType.M_HIGH_EXPLOSIVE) </span>
<span class="nc" id="L2036">                    ranges[0] = new int[] { 0, 3, 6, 9, 12 };</span>
                else 
<span class="nc" id="L2038">                    ranges[0] = new int[] { 4, 5, 10, 15, 20 };</span>
            } 
<span class="nc bnc" id="L2040" title="All 2 branches missed.">            else if (atype.getAmmoType() == AmmoType.T_MML) {</span>
<span class="nc bnc" id="L2041" title="All 2 branches missed.">                if (atype.hasFlag(AmmoType.F_MML_LRM)) </span>
<span class="nc" id="L2042">                    ranges[0] = new int[] { 6, 7, 14, 21, 28 };</span>
                else 
<span class="nc" id="L2044">                    ranges[0] = new int[] { 0, 3, 6, 9, 12 };</span>
<span class="nc bnc" id="L2045" title="All 2 branches missed.">            } else if (atype.getAmmoType() == AmmoType.T_IATM) {</span>
<span class="nc bnc" id="L2046" title="All 2 branches missed.">                if (atype.getMunitionType() == AmmoType.M_EXTENDED_RANGE) </span>
<span class="nc" id="L2047">                    ranges[0] = new int[] { 4, 9, 18, 27, 36 };</span>
<span class="nc bnc" id="L2048" title="All 2 branches missed.">                else if (atype.getMunitionType() == AmmoType.M_HIGH_EXPLOSIVE) </span>
<span class="nc" id="L2049">                    ranges[0] = new int[] { 0, 3, 6, 9, 12 };</span>
<span class="nc bnc" id="L2050" title="All 2 branches missed.">                else if (atype.getMunitionType() == AmmoType.M_IATM_IMP) </span>
<span class="nc" id="L2051">                    ranges[0] = new int[] { 0, 3, 6, 9, 12 };</span>
                else  
<span class="nc" id="L2053">                    ranges[0] = new int[] { 4, 5, 10, 15, 20 };</span>
            }
        }

        // No minimum range for hotload
<span class="nc bnc" id="L2058" title="All 4 branches missed.">        if ((mounted.getLinked() != null) &amp;&amp; mounted.getLinked().isHotLoaded()) {</span>
<span class="nc" id="L2059">            ranges[0][0] = 0;</span>
        }

        // Aero
<span class="nc bnc" id="L2063" title="All 2 branches missed.">        if (entity.isAirborne()) {</span>

            // prepare fresh ranges, no underwater
<span class="nc" id="L2066">            ranges[0] = new int[] { 0, 0, 0, 0, 0 };  </span>
<span class="nc" id="L2067">            ranges[1] = new int[] { 0, 0, 0, 0, 0 };</span>
<span class="nc" id="L2068">            int maxr = WeaponType.RANGE_SHORT;</span>
            
            // In the WeaponPanel, when the weapon is out of ammo
            // or otherwise nonfunctional, SHORT range will be listed;
            // the field of fire is instead disabled
            // Here as well as in WeaponPanel, choosing a specific ammo
            // only works for the current player's units
<span class="nc bnc" id="L2075" title="All 4 branches missed.">            if (!mounted.isBreached() &amp;&amp; !mounted.isMissing() </span>
<span class="nc bnc" id="L2076" title="All 4 branches missed.">                    &amp;&amp; !mounted.isDestroyed() &amp;&amp; !mounted.isJammed() </span>
<span class="nc bnc" id="L2077" title="All 2 branches missed.">                    &amp;&amp; ((mounted.getLinked() == null) </span>
<span class="nc bnc" id="L2078" title="All 2 branches missed.">                            || (mounted.getLinked().getUsableShotsLeft() &gt; 0))) {</span>
<span class="nc" id="L2079">                maxr = wtype.getMaxRange(mounted);</span>

<span class="nc bnc" id="L2081" title="All 2 branches missed.">                if (atype != null) {</span>
<span class="nc bnc" id="L2082" title="All 2 branches missed.">                    if (atype.getAmmoType() == AmmoType.T_ATM) {</span>
<span class="nc bnc" id="L2083" title="All 2 branches missed.">                        if (atype.getMunitionType() == AmmoType.M_EXTENDED_RANGE) {</span>
<span class="nc" id="L2084">                            maxr = WeaponType.RANGE_EXT;</span>
<span class="nc bnc" id="L2085" title="All 2 branches missed.">                        } else if (atype.getMunitionType() == AmmoType.M_HIGH_EXPLOSIVE) {</span>
<span class="nc" id="L2086">                            maxr = WeaponType.RANGE_SHORT;</span>
                        }
<span class="nc bnc" id="L2088" title="All 2 branches missed.">                    } else if (atype.getAmmoType() == AmmoType.T_MML) {</span>
<span class="nc bnc" id="L2089" title="All 2 branches missed.">                        if (!atype.hasFlag(AmmoType.F_MML_LRM)) {</span>
<span class="nc" id="L2090">                            maxr = WeaponType.RANGE_SHORT; </span>
                        }
                    } 
                }

                // set the standard ranges, depending on capital or no
                //boolean isCap = wtype.isCapital();
<span class="nc bnc" id="L2097" title="All 2 branches missed.">                int rangeMultiplier = wtype.isCapital() ? 2 : 1;</span>
<span class="nc" id="L2098">                final IGame game = unitDisplay.getClientGUI().getClient().getGame();</span>
<span class="nc bnc" id="L2099" title="All 2 branches missed.">                if (game.getBoard().onGround()) {</span>
<span class="nc" id="L2100">                    rangeMultiplier *= 8;</span>
                }
                
<span class="nc bnc" id="L2103" title="All 2 branches missed.">                for(int rangeIndex = RangeType.RANGE_MINIMUM; rangeIndex &lt;= RangeType.RANGE_EXTREME; rangeIndex++) {</span>
<span class="nc bnc" id="L2104" title="All 2 branches missed.">                    if(maxr &gt;= rangeIndex) {</span>
<span class="nc" id="L2105">                        ranges[0][rangeIndex] = WeaponType.AIRBORNE_WEAPON_RANGES[rangeIndex] * rangeMultiplier;</span>
                    }
                }
            }
        }
        
        // pass all this to the Displays
<span class="nc" id="L2112">        int arc = entity.getWeaponArc(entity.getEquipmentNum(mounted));</span>
<span class="nc" id="L2113">        int loc = mounted.getLocation();</span>
        
<span class="nc bnc" id="L2115" title="All 2 branches missed.">        if (gui.getCurrentPanel() instanceof FiringDisplay) {</span>
            // twisting
<span class="nc" id="L2117">            int facing = entity.getFacing();</span>
<span class="nc bnc" id="L2118" title="All 2 branches missed.">            if (entity.isSecondaryArcWeapon(entity.getEquipmentNum(mounted))) </span>
<span class="nc" id="L2119">                facing = entity.getSecondaryFacing();</span>
<span class="nc" id="L2120">            ((FiringDisplay) gui.getCurrentPanel()).FieldofFire(entity, ranges, arc, loc, facing);</span>
<span class="nc bnc" id="L2121" title="All 2 branches missed.">        } else if (gui.getCurrentPanel() instanceof TargetingPhaseDisplay) {</span>
            // twisting
<span class="nc" id="L2123">            int facing = entity.getFacing();</span>
<span class="nc bnc" id="L2124" title="All 2 branches missed.">            if (entity.isSecondaryArcWeapon(entity.getEquipmentNum(mounted))) </span>
<span class="nc" id="L2125">                facing = entity.getSecondaryFacing();</span>
<span class="nc" id="L2126">            ((TargetingPhaseDisplay) gui.getCurrentPanel()).FieldofFire(entity, ranges, arc, loc, facing);</span>
<span class="nc bnc" id="L2127" title="All 2 branches missed.">        } else if (gui.getCurrentPanel() instanceof MovementDisplay) {</span>
            // no twisting here
<span class="nc" id="L2129">            ((MovementDisplay)gui.getCurrentPanel()).FieldofFire(entity, ranges, arc, loc);</span>
        }
<span class="nc" id="L2131">    }</span>

    private String formatAmmo(Mounted m) {
<span class="nc" id="L2134">        StringBuffer sb = new StringBuffer(64);</span>
<span class="nc" id="L2135">        int ammoIndex = m.getDesc().indexOf(</span>
<span class="nc" id="L2136">                Messages.getString(&quot;MechDisplay.0&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L2137">        int loc = m.getLocation();</span>
<span class="nc bnc" id="L2138" title="All 2 branches missed.">        if (!m.getEntity().equals(entity)) {</span>
<span class="nc" id="L2139">            sb.append(&quot;[TR] &quot;); //$NON-NLS-1$</span>
<span class="nc bnc" id="L2140" title="All 2 branches missed.">        } else if (loc != Entity.LOC_NONE) {</span>
<span class="nc" id="L2141">            sb.append('[').append(entity.getLocationAbbr(loc)).append(&quot;] &quot;); //$NON-NLS-1$</span>
        }
<span class="nc bnc" id="L2143" title="All 2 branches missed.">        if (ammoIndex == -1) {</span>
<span class="nc" id="L2144">            sb.append(m.getDesc());</span>
        } else {
<span class="nc" id="L2146">            sb.append(m.getDesc().substring(0, ammoIndex));</span>
<span class="nc" id="L2147">            sb.append(m.getDesc().substring(ammoIndex + 4));</span>
        }
<span class="nc bnc" id="L2149" title="All 2 branches missed.">        if (m.isHotLoaded()) {</span>
<span class="nc" id="L2150">            sb.append(Messages.getString(&quot;MechDisplay.isHotLoaded&quot;));</span>
        }
<span class="nc" id="L2152">        return sb.toString();</span>
    }

    private String formatBayWeapon(Mounted m) {
<span class="nc" id="L2156">        StringBuffer sb = new StringBuffer(64);</span>
<span class="nc" id="L2157">        sb.append(m.getDesc());</span>
<span class="nc" id="L2158">        return sb.toString();</span>
    }

    /**
     * Update the range display for the selected ammo.
     *
     * @param mAmmo - the &lt;code&gt;AmmoType&lt;/code&gt; of the weapon's loaded ammo.
     */
    private void updateRangeDisplayForAmmo(Mounted mAmmo) {
<span class="nc bnc" id="L2167" title="All 2 branches missed.">        if (!(mAmmo.getType() instanceof AmmoType)) {</span>
<span class="nc" id="L2168">            return;</span>
        }
<span class="nc" id="L2170">        AmmoType atype = (AmmoType) mAmmo.getType();</span>
        // Only override the display for the various ATM and MML ammos
<span class="nc bnc" id="L2172" title="All 2 branches missed.">        if (atype.getAmmoType() == AmmoType.T_ATM) {</span>
<span class="nc bnc" id="L2173" title="All 2 branches missed.">            if (atype.getMunitionType() == AmmoType.M_EXTENDED_RANGE) {</span>
<span class="nc" id="L2174">                wMinR.setText(&quot;4&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2175">                wShortR.setText(&quot;1 - 9&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2176">                wMedR.setText(&quot;10 - 18&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2177">                wLongR.setText(&quot;19 - 27&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2178">                wExtR.setText(&quot;28 - 36&quot;); //$NON-NLS-1$</span>
<span class="nc bnc" id="L2179" title="All 2 branches missed.">            } else if (atype.getMunitionType() == AmmoType.M_HIGH_EXPLOSIVE) {</span>
<span class="nc" id="L2180">                wMinR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2181">                wShortR.setText(&quot;1 - 3&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2182">                wMedR.setText(&quot;4 - 6&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2183">                wLongR.setText(&quot;7 - 9&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2184">                wExtR.setText(&quot;10 - 12&quot;); //$NON-NLS-1$</span>
            } else {
<span class="nc" id="L2186">                wMinR.setText(&quot;4&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2187">                wShortR.setText(&quot;1 - 5&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2188">                wMedR.setText(&quot;6 - 10&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2189">                wLongR.setText(&quot;11 - 15&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2190">                wExtR.setText(&quot;16 - 20&quot;); //$NON-NLS-1$</span>
            }
        } // End weapon-is-ATM
<span class="nc bnc" id="L2193" title="All 2 branches missed.">        else if (atype.getAmmoType() == AmmoType.T_MML) {</span>
<span class="nc bnc" id="L2194" title="All 2 branches missed.">            if (atype.hasFlag(AmmoType.F_MML_LRM)) {</span>
<span class="nc" id="L2195">                wMinR.setText(&quot;6&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2196">                wShortR.setText(&quot;1 - 7&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2197">                wMedR.setText(&quot;8 - 14&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2198">                wLongR.setText(&quot;15 - 21&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2199">                wExtR.setText(&quot;21 - 28&quot;); //$NON-NLS-1$</span>
            } else {
<span class="nc" id="L2201">                wMinR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2202">                wShortR.setText(&quot;1 - 3&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2203">                wMedR.setText(&quot;4 - 6&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2204">                wLongR.setText(&quot;7 - 9&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2205">                wExtR.setText(&quot;10 - 12&quot;); //$NON-NLS-1$</span>
            }
<span class="nc bnc" id="L2207" title="All 2 branches missed.">        } else if (atype.getAmmoType() == AmmoType.T_IATM) {</span>
<span class="nc bnc" id="L2208" title="All 2 branches missed.">            if (atype.getMunitionType() == AmmoType.M_EXTENDED_RANGE) {</span>
<span class="nc" id="L2209">                wMinR.setText(&quot;4&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2210">                wShortR.setText(&quot;1 - 9&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2211">                wMedR.setText(&quot;10 - 18&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2212">                wLongR.setText(&quot;19 - 27&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2213">                wExtR.setText(&quot;28 - 36&quot;); //$NON-NLS-1$</span>
<span class="nc bnc" id="L2214" title="All 2 branches missed.">            } else if (atype.getMunitionType() == AmmoType.M_HIGH_EXPLOSIVE) {</span>
<span class="nc" id="L2215">                wMinR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2216">                wShortR.setText(&quot;1 - 3&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2217">                wMedR.setText(&quot;4 - 6&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2218">                wLongR.setText(&quot;7 - 9&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2219">                wExtR.setText(&quot;10 - 12&quot;); //$NON-NLS-1$</span>
<span class="nc bnc" id="L2220" title="All 2 branches missed.">            } else if (atype.getMunitionType() == AmmoType.M_IATM_IIW) {</span>
<span class="nc" id="L2221">                wMinR.setText(&quot;4&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2222">                wShortR.setText(&quot;1 - 5&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2223">                wMedR.setText(&quot;6 - 10&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2224">                wLongR.setText(&quot;11 - 15&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2225">                wExtR.setText(&quot;16 - 20&quot;); //$NON-NLS-1$</span>
<span class="nc bnc" id="L2226" title="All 2 branches missed.">            } else if (atype.getMunitionType() == AmmoType.M_IATM_IMP) {</span>
<span class="nc" id="L2227">                wMinR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2228">                wShortR.setText(&quot;1 - 3&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2229">                wMedR.setText(&quot;4 - 6&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2230">                wLongR.setText(&quot;7 - 9&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2231">                wExtR.setText(&quot;10 - 12&quot;); //$NON-NLS-1$</span>
            } else /* standard */ {
<span class="nc" id="L2233">                wMinR.setText(&quot;4&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2234">                wShortR.setText(&quot;1 - 5&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2235">                wMedR.setText(&quot;6 - 10&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2236">                wLongR.setText(&quot;11 - 15&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2237">                wExtR.setText(&quot;16 - 20&quot;); //$NON-NLS-1$</span>
            }           
        }

        // Min range 0 for hotload
<span class="nc bnc" id="L2242" title="All 2 branches missed.">        if (mAmmo.isHotLoaded()) {</span>
<span class="nc" id="L2243">            wMinR.setText(&quot;---&quot;);</span>
        }

<span class="nc" id="L2246">        onResize();</span>
<span class="nc" id="L2247">    } // End private void updateRangeDisplayForAmmo( AmmoType )</span>

    private void updateAttackValues(Mounted weapon, Mounted ammo) {
<span class="nc" id="L2250">        WeaponType wtype = (WeaponType) weapon.getType();</span>
        // update Attack Values and change range
<span class="nc" id="L2252">        int avShort = wtype.getRoundShortAV();</span>
<span class="nc" id="L2253">        int avMed = wtype.getRoundMedAV();</span>
<span class="nc" id="L2254">        int avLong = wtype.getRoundLongAV();</span>
<span class="nc" id="L2255">        int avExt = wtype.getRoundExtAV();</span>
<span class="nc" id="L2256">        int maxr = wtype.getMaxRange(weapon);</span>

        // change range and attack values based upon ammo
<span class="nc bnc" id="L2259" title="All 2 branches missed.">        if (null != ammo) {</span>
<span class="nc" id="L2260">            AmmoType atype = (AmmoType) ammo.getType();</span>
<span class="nc" id="L2261">            double[] changes = changeAttackValues(atype, avShort, avMed,</span>
                                                  avLong, avExt, maxr);
<span class="nc" id="L2263">            avShort = (int) changes[0];</span>
<span class="nc" id="L2264">            avMed = (int) changes[1];</span>
<span class="nc" id="L2265">            avLong = (int) changes[2];</span>
<span class="nc" id="L2266">            avExt = (int) changes[3];</span>
<span class="nc" id="L2267">            maxr = (int) changes[4];</span>
        }

<span class="nc bnc" id="L2270" title="All 4 branches missed.">        if (entity.getGame().getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY) &amp;&amp; wtype.isCapital()) {</span>
<span class="nc" id="L2271">            avShort *= 10;</span>
<span class="nc" id="L2272">            avMed *= 10;</span>
<span class="nc" id="L2273">            avLong *= 10;</span>
<span class="nc" id="L2274">            avExt *= 10;</span>
        }

        // set default values in case if statement stops
<span class="nc" id="L2278">        wShortAVR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2279">        wMedAVR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2280">        wLongAVR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2281">        wExtAVR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2282">        wShortR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2283">        wMedR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2284">        wLongR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2285">        wExtR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
        // every weapon gets at least short range
<span class="nc" id="L2287">        wShortAVR.setText(Integer.toString(avShort));</span>
<span class="nc bnc" id="L2288" title="All 2 branches missed.">        if (wtype.isCapital()) {</span>
<span class="nc" id="L2289">            wShortR.setText(&quot;1-12&quot;); //$NON-NLS-1$</span>
<span class="nc bnc" id="L2290" title="All 2 branches missed.">        } else if (wtype.hasFlag(WeaponType.F_PDBAY)) {</span>
                //Point Defense bays have a variable range too, depending on the mode they're in
<span class="nc bnc" id="L2292" title="All 4 branches missed.">                if (wtype.hasModes() &amp;&amp; weapon.curMode().equals(&quot;Point Defense&quot;)) {</span>
<span class="nc" id="L2293">                    wShortR.setText(&quot;1&quot;); //$NON-NLS-1$</span>
                } else {
<span class="nc" id="L2295">                    wShortR.setText(&quot;1-6&quot;); //$NON-NLS-1$</span>
                }
        } else {
<span class="nc" id="L2298">            wShortR.setText(&quot;1-6&quot;); //$NON-NLS-1$</span>
        }
<span class="nc bnc" id="L2300" title="All 2 branches missed.">        if (maxr &gt; WeaponType.RANGE_SHORT) {</span>
<span class="nc" id="L2301">            wMedAVR.setText(Integer.toString(avMed));</span>
<span class="nc bnc" id="L2302" title="All 2 branches missed.">            if (wtype.isCapital()) {</span>
<span class="nc" id="L2303">                wMedR.setText(&quot;13-24&quot;); //$NON-NLS-1$</span>
            } else {
<span class="nc" id="L2305">                wMedR.setText(&quot;7-12&quot;); //$NON-NLS-1$</span>
            }
        }
<span class="nc bnc" id="L2308" title="All 2 branches missed.">        if (maxr &gt; WeaponType.RANGE_MED) {</span>
<span class="nc" id="L2309">            wLongAVR.setText(Integer.toString(avLong));</span>
<span class="nc bnc" id="L2310" title="All 2 branches missed.">            if (wtype.isCapital()) {</span>
<span class="nc" id="L2311">                wLongR.setText(&quot;25-40&quot;); //$NON-NLS-1$</span>
            } else {
<span class="nc" id="L2313">                wLongR.setText(&quot;13-20&quot;); //$NON-NLS-1$</span>
            }
        }
<span class="nc bnc" id="L2316" title="All 2 branches missed.">        if (maxr &gt; WeaponType.RANGE_LONG) {</span>
<span class="nc" id="L2317">            wExtAVR.setText(Integer.toString(avExt));</span>
<span class="nc bnc" id="L2318" title="All 2 branches missed.">            if (wtype.isCapital()) {</span>
<span class="nc" id="L2319">                wExtR.setText(&quot;41-50&quot;); //$NON-NLS-1$</span>
            } else {
<span class="nc" id="L2321">                wExtR.setText(&quot;21-25&quot;); //$NON-NLS-1$</span>
            }
        }

<span class="nc" id="L2325">        onResize();</span>
<span class="nc" id="L2326">    }</span>

    private double[] changeAttackValues(AmmoType atype, double avShort,
                                        double avMed, double avLong, double avExt, int maxr) {

<span class="nc bnc" id="L2331" title="All 2 branches missed.">        if (AmmoType.T_ATM == atype.getAmmoType()) {</span>
<span class="nc bnc" id="L2332" title="All 2 branches missed.">            if (atype.getMunitionType() == AmmoType.M_EXTENDED_RANGE) {</span>
<span class="nc" id="L2333">                maxr = WeaponType.RANGE_EXT;</span>
<span class="nc" id="L2334">                avShort = avShort / 2;</span>
<span class="nc" id="L2335">                avMed = avMed / 2;</span>
<span class="nc" id="L2336">                avLong = avMed;</span>
<span class="nc" id="L2337">                avExt = avMed;</span>
<span class="nc bnc" id="L2338" title="All 2 branches missed.">            } else if (atype.getMunitionType() == AmmoType.M_HIGH_EXPLOSIVE) {</span>
<span class="nc" id="L2339">                maxr = WeaponType.RANGE_SHORT;</span>
<span class="nc" id="L2340">                avShort = avShort + (avShort / 2);</span>
<span class="nc" id="L2341">                avMed = 0;</span>
<span class="nc" id="L2342">                avLong = 0;</span>
<span class="nc" id="L2343">                avExt = 0;</span>
            }
        } // End weapon-is-ATM
<span class="nc bnc" id="L2346" title="All 2 branches missed.">        else if (atype.getAmmoType() == AmmoType.T_MML) {</span>
            // first check for artemis
<span class="nc" id="L2348">            int bonus = 0;</span>
<span class="nc bnc" id="L2349" title="All 2 branches missed.">            if (atype.getMunitionType() == AmmoType.M_ARTEMIS_CAPABLE) {</span>
<span class="nc" id="L2350">                int rack = atype.getRackSize();</span>
<span class="nc bnc" id="L2351" title="All 2 branches missed.">                if (rack == 5) {</span>
<span class="nc" id="L2352">                    bonus += 1;</span>
<span class="nc bnc" id="L2353" title="All 2 branches missed.">                } else if (rack &gt;= 7) {</span>
<span class="nc" id="L2354">                    bonus += 2;</span>
                }
<span class="nc" id="L2356">                avShort = avShort + bonus;</span>
<span class="nc" id="L2357">                avMed = avMed + bonus;</span>
<span class="nc" id="L2358">                avLong = avLong + bonus;</span>
            }
<span class="nc bnc" id="L2360" title="All 2 branches missed.">            if (!atype.hasFlag(AmmoType.F_MML_LRM)) {</span>
<span class="nc" id="L2361">                maxr = WeaponType.RANGE_SHORT;</span>
<span class="nc" id="L2362">                avShort = avShort * 2;</span>
<span class="nc" id="L2363">                avMed = 0;</span>
<span class="nc" id="L2364">                avLong = 0;</span>
<span class="nc" id="L2365">                avExt = 0;</span>
            }
<span class="nc" id="L2367">        } // end weapon is MML</span>
<span class="nc bnc" id="L2368" title="All 2 branches missed.">        else if ((atype.getAmmoType() == AmmoType.T_LRM) </span>
<span class="nc bnc" id="L2369" title="All 2 branches missed.">                || (atype.getAmmoType() == AmmoType.T_LRM_IMP)</span>
<span class="nc bnc" id="L2370" title="All 2 branches missed.">                || (atype.getAmmoType() == AmmoType.T_SRM)</span>
<span class="nc bnc" id="L2371" title="All 2 branches missed.">                || (atype.getAmmoType() == AmmoType.T_SRM_IMP)) {</span>

<span class="nc bnc" id="L2373" title="All 2 branches missed.">            if (atype.getMunitionType() == AmmoType.M_ARTEMIS_CAPABLE) {</span>
<span class="nc bnc" id="L2374" title="All 4 branches missed.">                if ((atype.getAmmoType() == AmmoType.T_LRM) || (atype.getAmmoType() == AmmoType.T_LRM_IMP)) {</span>
<span class="nc" id="L2375">                    int bonus = (int) Math.ceil(atype.getRackSize() / 5.0);</span>
<span class="nc" id="L2376">                    avShort = avShort + bonus;</span>
<span class="nc" id="L2377">                    avMed = avMed + bonus;</span>
<span class="nc" id="L2378">                    avLong = avLong + bonus;</span>
                }
<span class="nc bnc" id="L2380" title="All 4 branches missed.">                if ((atype.getAmmoType() == AmmoType.T_SRM) || (atype.getAmmoType() == AmmoType.T_SRM_IMP)) {</span>
<span class="nc" id="L2381">                    avShort = avShort + 2;</span>
                }
            }
<span class="nc bnc" id="L2384" title="All 2 branches missed.">        } else if (atype.getAmmoType() == AmmoType.T_AC_LBX) {</span>
<span class="nc bnc" id="L2385" title="All 2 branches missed.">            if (atype.getMunitionType() == AmmoType.M_CLUSTER) {</span>
<span class="nc" id="L2386">                int newAV = (int) Math.floor(0.6 * atype.getRackSize());</span>
<span class="nc" id="L2387">                avShort = newAV;</span>
<span class="nc bnc" id="L2388" title="All 2 branches missed.">                if (avMed &gt; 0) {</span>
<span class="nc" id="L2389">                    avMed = newAV;</span>
                }
<span class="nc bnc" id="L2391" title="All 2 branches missed.">                if (avLong &gt; 0) {</span>
<span class="nc" id="L2392">                    avLong = newAV;</span>
                }
<span class="nc bnc" id="L2394" title="All 2 branches missed.">                if (avExt &gt; 0) {</span>
<span class="nc" id="L2395">                    avExt = newAV;</span>
                }
<span class="nc" id="L2397">            }</span>
<span class="nc bnc" id="L2398" title="All 2 branches missed.">        } else if (atype.getAmmoType() == AmmoType.T_AR10) {</span>
<span class="nc bnc" id="L2399" title="All 2 branches missed.">            if (atype.hasFlag(AmmoType.F_AR10_KILLER_WHALE)) {</span>
<span class="nc" id="L2400">                avShort = 4;</span>
<span class="nc" id="L2401">                avMed = 4;</span>
<span class="nc" id="L2402">                avLong = 4;</span>
<span class="nc" id="L2403">                avExt = 4;</span>
<span class="nc bnc" id="L2404" title="All 2 branches missed.">            } else if (atype.hasFlag(AmmoType.F_AR10_WHITE_SHARK)) {</span>
<span class="nc" id="L2405">                avShort = 3;</span>
<span class="nc" id="L2406">                avMed = 3;</span>
<span class="nc" id="L2407">                avLong = 3;</span>
<span class="nc" id="L2408">                avExt = 3;</span>
<span class="nc bnc" id="L2409" title="All 2 branches missed.">            } else if (atype.hasFlag(AmmoType.F_SANTA_ANNA)) {</span>
<span class="nc" id="L2410">                avShort = 100;</span>
<span class="nc" id="L2411">                avMed = 100;</span>
<span class="nc" id="L2412">                avLong = 100;</span>
<span class="nc" id="L2413">                avExt = 100;</span>
<span class="nc bnc" id="L2414" title="All 2 branches missed.">            } else if (atype.hasFlag(AmmoType.F_PEACEMAKER)) {</span>
<span class="nc" id="L2415">                avShort = 1000;</span>
<span class="nc" id="L2416">                avMed = 1000;</span>
<span class="nc" id="L2417">                avLong = 1000;</span>
<span class="nc" id="L2418">                avExt = 1000;</span>
            } else {
<span class="nc" id="L2420">                avShort = 2;</span>
<span class="nc" id="L2421">                avMed = 2;</span>
<span class="nc" id="L2422">                avLong = 2;</span>
<span class="nc" id="L2423">                avExt = 2;</span>
            }
<span class="nc bnc" id="L2425" title="All 2 branches missed.">        } else if (atype.getAmmoType() == AmmoType.T_KILLER_WHALE) {</span>
<span class="nc bnc" id="L2426" title="All 2 branches missed.">            if (atype.hasFlag(AmmoType.F_PEACEMAKER)) {</span>
<span class="nc" id="L2427">                avShort = 1000;</span>
<span class="nc" id="L2428">                avMed = 1000;</span>
<span class="nc" id="L2429">                avLong = 1000;</span>
<span class="nc" id="L2430">                avExt = 1000; </span>
            } else {
<span class="nc" id="L2432">                avShort = 4;</span>
<span class="nc" id="L2433">                avMed = 4;</span>
<span class="nc" id="L2434">                avLong = 4;</span>
<span class="nc" id="L2435">                avExt = 4;</span>
            }
<span class="nc bnc" id="L2437" title="All 2 branches missed.">        } else if (atype.getAmmoType() == AmmoType.T_WHITE_SHARK) {</span>
<span class="nc bnc" id="L2438" title="All 2 branches missed.">            if (atype.hasFlag(AmmoType.F_SANTA_ANNA)) {</span>
<span class="nc" id="L2439">                avShort = 100;</span>
<span class="nc" id="L2440">                avMed = 100;</span>
<span class="nc" id="L2441">                avLong = 100;</span>
<span class="nc" id="L2442">                avExt = 100; </span>
            } else {
<span class="nc" id="L2444">                avShort = 3;</span>
<span class="nc" id="L2445">                avMed = 3;</span>
<span class="nc" id="L2446">                avLong = 3;</span>
<span class="nc" id="L2447">                avExt = 3;</span>
            }
        }

<span class="nc" id="L2451">        double[] result = {avShort, avMed, avLong, avExt, maxr};</span>
<span class="nc" id="L2452">        return result;</span>

    }

    private void compileWeaponBay(Mounted weapon, boolean isCapital) {

<span class="nc" id="L2458">        Vector&lt;Integer&gt; bayWeapons = weapon.getBayWeapons();</span>
<span class="nc" id="L2459">        WeaponType wtype = (WeaponType) weapon.getType();</span>

        // set default values in case if statement stops
<span class="nc" id="L2462">        wShortAVR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2463">        wMedAVR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2464">        wLongAVR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2465">        wExtAVR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2466">        wShortR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2467">        wMedR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2468">        wLongR.setText(&quot;---&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L2469">        wExtR.setText(&quot;---&quot;); //$NON-NLS-1$</span>

<span class="nc" id="L2471">        int heat = 0;</span>
<span class="nc" id="L2472">        double avShort = 0;</span>
<span class="nc" id="L2473">        double avMed = 0;</span>
<span class="nc" id="L2474">        double avLong = 0;</span>
<span class="nc" id="L2475">        double avExt = 0;</span>
<span class="nc" id="L2476">        int maxr = WeaponType.RANGE_SHORT;</span>

<span class="nc bnc" id="L2478" title="All 2 branches missed.">        for (int wId : bayWeapons) {</span>
<span class="nc" id="L2479">            Mounted m = entity.getEquipment(wId);</span>
<span class="nc bnc" id="L2480" title="All 2 branches missed.">            if (!m.isBreached()</span>
<span class="nc bnc" id="L2481" title="All 2 branches missed.">                &amp;&amp; !m.isMissing()</span>
<span class="nc bnc" id="L2482" title="All 2 branches missed.">                &amp;&amp; !m.isDestroyed()</span>
<span class="nc bnc" id="L2483" title="All 2 branches missed.">                &amp;&amp; !m.isJammed()</span>
<span class="nc bnc" id="L2484" title="All 2 branches missed.">                &amp;&amp; ((m.getLinked() == null) || (m.getLinked()</span>
<span class="nc bnc" id="L2485" title="All 2 branches missed.">                                                 .getUsableShotsLeft() &gt; 0))) {</span>
<span class="nc" id="L2486">                WeaponType bayWType = ((WeaponType) m.getType());</span>
<span class="nc" id="L2487">                heat = heat + m.getCurrentHeat();</span>
<span class="nc" id="L2488">                double mAVShort = bayWType.getShortAV();</span>
<span class="nc" id="L2489">                double mAVMed = bayWType.getMedAV();</span>
<span class="nc" id="L2490">                double mAVLong = bayWType.getLongAV();</span>
<span class="nc" id="L2491">                double mAVExt = bayWType.getExtAV();</span>
<span class="nc" id="L2492">                int mMaxR = bayWType.getMaxRange(m);</span>

                // deal with any ammo adjustments
<span class="nc bnc" id="L2495" title="All 2 branches missed.">                if (null != m.getLinked()) {</span>
<span class="nc" id="L2496">                    double[] changes = changeAttackValues((AmmoType) m</span>
<span class="nc" id="L2497">                                                                  .getLinked().getType(), mAVShort, mAVMed,</span>
                                                          mAVLong, mAVExt, mMaxR);
<span class="nc" id="L2499">                    mAVShort = changes[0];</span>
<span class="nc" id="L2500">                    mAVMed = changes[1];</span>
<span class="nc" id="L2501">                    mAVLong = changes[2];</span>
<span class="nc" id="L2502">                    mAVExt = changes[3];</span>
<span class="nc" id="L2503">                    mMaxR = (int) changes[4];</span>
                }

<span class="nc" id="L2506">                avShort = avShort + mAVShort;</span>
<span class="nc" id="L2507">                avMed = avMed + mAVMed;</span>
<span class="nc" id="L2508">                avLong = avLong + mAVLong;</span>
<span class="nc" id="L2509">                avExt = avExt + mAVExt;</span>
<span class="nc bnc" id="L2510" title="All 2 branches missed.">                if (mMaxR &gt; maxr) {</span>
<span class="nc" id="L2511">                    maxr = mMaxR;</span>
                }
            }
<span class="nc" id="L2514">        }</span>
        // check for bracketing
<span class="nc" id="L2516">        double mult = 1.0;</span>
<span class="nc bnc" id="L2517" title="All 4 branches missed.">        if (wtype.hasModes() &amp;&amp; weapon.curMode().equals(&quot;Bracket 80%&quot;)) {</span>
<span class="nc" id="L2518">            mult = 0.8;</span>
        }
<span class="nc bnc" id="L2520" title="All 4 branches missed.">        if (wtype.hasModes() &amp;&amp; weapon.curMode().equals(&quot;Bracket 60%&quot;)) {</span>
<span class="nc" id="L2521">            mult = 0.6;</span>
        }
<span class="nc bnc" id="L2523" title="All 4 branches missed.">        if (wtype.hasModes() &amp;&amp; weapon.curMode().equals(&quot;Bracket 40%&quot;)) {</span>
<span class="nc" id="L2524">            mult = 0.4;</span>
        }
<span class="nc" id="L2526">        avShort = mult * avShort;</span>
<span class="nc" id="L2527">        avMed = mult * avMed;</span>
<span class="nc" id="L2528">        avLong = mult * avLong;</span>
<span class="nc" id="L2529">        avExt = mult * avExt;</span>

<span class="nc bnc" id="L2531" title="All 4 branches missed.">        if (entity.getGame().getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY) &amp;&amp; wtype.isCapital()) {</span>
<span class="nc" id="L2532">            avShort *= 10;</span>
<span class="nc" id="L2533">            avMed *= 10;</span>
<span class="nc" id="L2534">            avLong *= 10;</span>
<span class="nc" id="L2535">            avExt *= 10;</span>
        }

<span class="nc" id="L2538">        wHeatR.setText(Integer.toString(heat));</span>
<span class="nc" id="L2539">        wShortAVR.setText(Integer.toString((int) Math.ceil(avShort)));</span>
<span class="nc bnc" id="L2540" title="All 2 branches missed.">        if (isCapital) {</span>
<span class="nc" id="L2541">            wShortR.setText(&quot;1-12&quot;); //$NON-NLS-1$</span>
        } else {
<span class="nc" id="L2543">            wShortR.setText(&quot;1-6&quot;); //$NON-NLS-1$</span>
        }
<span class="nc bnc" id="L2545" title="All 2 branches missed.">        if (maxr &gt; WeaponType.RANGE_SHORT) {</span>
<span class="nc" id="L2546">            wMedAVR.setText(Integer.toString((int) Math.ceil(avMed)));</span>
<span class="nc bnc" id="L2547" title="All 2 branches missed.">            if (isCapital) {</span>
<span class="nc" id="L2548">                wMedR.setText(&quot;13-24&quot;); //$NON-NLS-1$</span>
            } else {
<span class="nc" id="L2550">                wMedR.setText(&quot;7-12&quot;); //$NON-NLS-1$</span>
            }
        }
<span class="nc bnc" id="L2553" title="All 2 branches missed.">        if (maxr &gt; WeaponType.RANGE_MED) {</span>
<span class="nc" id="L2554">            wLongAVR.setText(Integer.toString((int) Math.ceil(avLong)));</span>
<span class="nc bnc" id="L2555" title="All 2 branches missed.">            if (isCapital) {</span>
<span class="nc" id="L2556">                wLongR.setText(&quot;25-40&quot;); //$NON-NLS-1$</span>
            } else {
<span class="nc" id="L2558">                wLongR.setText(&quot;13-20&quot;); //$NON-NLS-1$</span>
            }
        }
<span class="nc bnc" id="L2561" title="All 2 branches missed.">        if (maxr &gt; WeaponType.RANGE_LONG) {</span>
<span class="nc" id="L2562">            wExtAVR.setText(Integer.toString((int) Math.ceil(avExt)));</span>
<span class="nc bnc" id="L2563" title="All 2 branches missed.">            if (isCapital) {</span>
<span class="nc" id="L2564">                wExtR.setText(&quot;41-50&quot;); //$NON-NLS-1$</span>
            } else {
<span class="nc" id="L2566">                wExtR.setText(&quot;21-25&quot;); //$NON-NLS-1$</span>
            }
        }
<span class="nc" id="L2569">        onResize();</span>
<span class="nc" id="L2570">    }</span>

    public void valueChanged(ListSelectionEvent event) {
<span class="nc bnc" id="L2573" title="All 2 branches missed.">        if (event.getValueIsAdjusting()) {</span>
<span class="nc" id="L2574">            return;</span>
        }
<span class="nc bnc" id="L2576" title="All 2 branches missed.">        if (event.getSource().equals(weaponList)) {</span>
<span class="nc" id="L2577">            displaySelected();</span>
            
            // Can't do anything if ClientGUI is null
<span class="nc bnc" id="L2580" title="All 2 branches missed.">            if (unitDisplay.getClientGUI() == null) {</span>
<span class="nc" id="L2581">                return;</span>
            }
            
<span class="nc" id="L2584">            JComponent currPanel = unitDisplay.getClientGUI().getCurrentPanel();</span>
            // When in the Firing Phase, update the targeting information.
<span class="nc bnc" id="L2586" title="All 2 branches missed.">            if (currPanel instanceof FiringDisplay) {</span>
<span class="nc" id="L2587">                FiringDisplay firingDisplay = (FiringDisplay)currPanel;</span>

<span class="nc" id="L2589">                Mounted mounted = null;</span>
<span class="nc" id="L2590">                WeaponListModel weaponModel = (WeaponListModel) weaponList</span>
<span class="nc" id="L2591">                        .getModel();</span>
<span class="nc bnc" id="L2592" title="All 2 branches missed.">                if (weaponList.getSelectedIndex() != -1) {</span>
<span class="nc" id="L2593">                    mounted = weaponModel.getWeaponAt(weaponList</span>
<span class="nc" id="L2594">                            .getSelectedIndex());</span>
                }
<span class="nc" id="L2596">                Mounted prevMounted = null;</span>
<span class="nc bnc" id="L2597" title="All 2 branches missed.">                if ((event.getLastIndex() != -1) </span>
<span class="nc bnc" id="L2598" title="All 2 branches missed.">                        &amp;&amp; (event.getLastIndex() &lt; weaponModel.getSize())) {</span>
<span class="nc" id="L2599">                    prevMounted = weaponModel.getWeaponAt(event.getLastIndex());</span>
                }
                // Some weapons have a specific target, which gets handled
                // in the target method
<span class="nc bnc" id="L2603" title="All 2 branches missed.">                if (mounted != null</span>
<span class="nc bnc" id="L2604" title="All 2 branches missed.">                        &amp;&amp; mounted.getType().hasFlag(WeaponType.F_VGL)) {</span>
                    // Store previous target, if it's a weapon that doesn't 
                    // have a forced target
<span class="nc bnc" id="L2607" title="All 2 branches missed.">                    if ((prevMounted != null)</span>
<span class="nc bnc" id="L2608" title="All 2 branches missed.">                            &amp;&amp; !prevMounted.getType().hasFlag(WeaponType.F_VGL)) {</span>
<span class="nc" id="L2609">                        prevTarget = firingDisplay.getTarget();</span>
                    }                    
<span class="nc" id="L2611">                    firingDisplay.target(null);</span>
                } else {
<span class="nc bnc" id="L2613" title="All 2 branches missed.">                    if (prevTarget != null) {</span>
<span class="nc" id="L2614">                        firingDisplay.target(prevTarget);</span>
<span class="nc" id="L2615">                        unitDisplay.getClientGUI().getBoardView()</span>
<span class="nc" id="L2616">                                .select(prevTarget.getPosition());</span>
<span class="nc" id="L2617">                        prevTarget = null;</span>
                    } else {
<span class="nc" id="L2619">                        firingDisplay.updateTarget();</span>
                    }
                }
<span class="nc bnc" id="L2622" title="All 2 branches missed.">            } else if (currPanel instanceof TargetingPhaseDisplay) {</span>
<span class="nc" id="L2623">                ((TargetingPhaseDisplay) currPanel).updateTarget();</span>
            }
            
            // Tell the &lt;Phase&gt;Display to update the 
            // firing arc info when a weapon has been de-selected
<span class="nc bnc" id="L2628" title="All 2 branches missed.">            if (weaponList.getSelectedIndex() == -1) {</span>
<span class="nc" id="L2629">                unitDisplay.getClientGUI().bv.clearFieldofF();</span>
            }
        }
<span class="nc" id="L2632">        onResize();</span>
<span class="nc" id="L2633">    }</span>

    public void actionPerformed(ActionEvent ev) {
<span class="nc" id="L2636">        ClientGUI clientgui = unitDisplay.getClientGUI();</span>
<span class="nc bnc" id="L2637" title="All 2 branches missed.">        if (ev.getSource().equals(m_chAmmo)</span>
<span class="nc bnc" id="L2638" title="All 4 branches missed.">                &amp;&amp; (m_chAmmo.getSelectedIndex() != -1)</span>
                &amp;&amp; (clientgui != null)) {
            // only change our own units
<span class="nc" id="L2641">            if (!clientgui.getClient().getLocalPlayer()</span>
<span class="nc bnc" id="L2642" title="All 2 branches missed.">                    .equals(entity.getOwner())) {</span>
<span class="nc" id="L2643">                return;</span>
            }
<span class="nc" id="L2645">            int n = weaponList.getSelectedIndex();</span>
<span class="nc bnc" id="L2646" title="All 2 branches missed.">            if (weaponList.getSelectedIndex() == -1) {</span>
<span class="nc" id="L2647">                return;</span>
            }
<span class="nc" id="L2649">            Mounted mWeap = ((WeaponListModel) weaponList.getModel())</span>
<span class="nc" id="L2650">                    .getWeaponAt(n);</span>
<span class="nc" id="L2651">            Mounted oldWeap = mWeap;</span>
<span class="nc" id="L2652">            Mounted oldAmmo = mWeap.getLinked();</span>
<span class="nc" id="L2653">            Mounted mAmmo = vAmmo.get(m_chAmmo.getSelectedIndex());</span>
            // if this is a weapon bay, then this is not what we want
<span class="nc" id="L2655">            boolean isBay = false;</span>
<span class="nc bnc" id="L2656" title="All 2 branches missed.">            if (mWeap.getType() instanceof BayWeapon) {</span>
<span class="nc" id="L2657">                isBay = true;</span>
<span class="nc" id="L2658">                n = m_chBayWeapon.getSelectedIndex();</span>
<span class="nc bnc" id="L2659" title="All 2 branches missed.">                if (n == -1) {</span>
<span class="nc" id="L2660">                    return;</span>
                }
                //
<span class="nc" id="L2663">                Mounted sWeap = entity.getEquipment(mWeap.getBayWeapons()</span>
<span class="nc" id="L2664">                        .elementAt(n));</span>
                // cycle through all weapons of the same type and load with
                // this ammo
<span class="nc bnc" id="L2667" title="All 2 branches missed.">                for (int wid : mWeap.getBayWeapons()) {</span>
<span class="nc" id="L2668">                    Mounted bWeap = entity.getEquipment(wid);</span>
                    // FIXME: Consider new AmmoType::equals / BombType::equals
<span class="nc bnc" id="L2670" title="All 2 branches missed.">                    if (bWeap.getType().equals(sWeap.getType())) {</span>
<span class="nc" id="L2671">                        entity.loadWeapon(bWeap, mAmmo);</span>
                        // Alert the server of the update.
<span class="nc" id="L2673">                        clientgui.getClient().sendAmmoChange(</span>
<span class="nc" id="L2674">                                entity.getId(),</span>
<span class="nc" id="L2675">                                entity.getEquipmentNum(bWeap),</span>
<span class="nc" id="L2676">                                entity.getEquipmentNum(mAmmo));</span>
                    }
<span class="nc" id="L2678">                }</span>
<span class="nc" id="L2679">            } else {</span>
<span class="nc" id="L2680">                entity.loadWeapon(mWeap, mAmmo);</span>
                // Alert the server of the update.
<span class="nc" id="L2682">                clientgui.getClient().sendAmmoChange(entity.getId(),</span>
<span class="nc" id="L2683">                        entity.getEquipmentNum(mWeap),</span>
<span class="nc" id="L2684">                        entity.getEquipmentNum(mAmmo));</span>
            }

            // Refresh for hot load change
<span class="nc bnc" id="L2688" title="All 4 branches missed.">            if ((((oldAmmo == null) || !oldAmmo.isHotLoaded()) &amp;&amp; mAmmo</span>
<span class="nc bnc" id="L2689" title="All 4 branches missed.">                    .isHotLoaded())</span>
<span class="nc bnc" id="L2690" title="All 2 branches missed.">                    || ((oldAmmo != null) &amp;&amp; oldAmmo.isHotLoaded() &amp;&amp; !mAmmo</span>
<span class="nc bnc" id="L2691" title="All 2 branches missed.">                            .isHotLoaded())) {</span>
<span class="nc" id="L2692">                displayMech(entity);</span>
<span class="nc" id="L2693">                weaponList.setSelectedIndex(n);</span>
<span class="nc" id="L2694">                weaponList.ensureIndexIsVisible(n);</span>
<span class="nc" id="L2695">                displaySelected();</span>
            }

            // Update the range display to account for the weapon's loaded
            // ammo.
<span class="nc" id="L2700">            updateRangeDisplayForAmmo(mAmmo);</span>
<span class="nc bnc" id="L2701" title="All 4 branches missed.">            if (entity.isAirborne() || entity.usesWeaponBays()) {</span>
<span class="nc" id="L2702">                WeaponType wtype = (WeaponType) mWeap.getType();</span>
<span class="nc bnc" id="L2703" title="All 2 branches missed.">                if (isBay) {</span>
<span class="nc" id="L2704">                    compileWeaponBay(oldWeap, wtype.isCapital());</span>
                } else {
                    // otherwise I need to replace range display with
                    // standard ranges and attack values
<span class="nc" id="L2708">                    updateAttackValues(mWeap, mAmmo);</span>
                }
            }

            // When in the Firing Phase, update the targeting information.
<span class="nc bnc" id="L2713" title="All 2 branches missed.">            if (clientgui.getCurrentPanel() instanceof FiringDisplay) {</span>
<span class="nc" id="L2714">                ((FiringDisplay) clientgui.getCurrentPanel()).updateTarget();</span>
<span class="nc bnc" id="L2715" title="All 2 branches missed.">            } else if (clientgui.getCurrentPanel() instanceof TargetingPhaseDisplay) {</span>
<span class="nc" id="L2716">                ((TargetingPhaseDisplay) clientgui.getCurrentPanel()).updateTarget();</span>
            }
<span class="nc" id="L2718">            displaySelected();</span>
<span class="nc bnc" id="L2719" title="All 2 branches missed.">        } else if (ev.getSource().equals(m_chBayWeapon)</span>
<span class="nc bnc" id="L2720" title="All 2 branches missed.">                   &amp;&amp; (m_chBayWeapon.getItemCount() &gt; 0)) {</span>
<span class="nc" id="L2721">            int n = weaponList.getSelectedIndex();</span>
<span class="nc bnc" id="L2722" title="All 2 branches missed.">            if (n == -1) {</span>
<span class="nc" id="L2723">                return;</span>
            }
<span class="nc" id="L2725">            displaySelected();</span>
<span class="nc bnc" id="L2726" title="All 2 branches missed.">        } else if (ev.getSource().equals(weapSortOrder)) {</span>
<span class="nc" id="L2727">            setWeaponComparator(weapSortOrder.getSelectedIndex());</span>
        }
<span class="nc" id="L2729">        onResize();</span>
<span class="nc" id="L2730">    }</span>

    void setWeaponComparator(int sortIdx) {
        Comparator&lt;Mounted&gt; weapComparator;
<span class="nc bnc" id="L2734" title="All 2 branches missed.">        if (sortIdx == Entity.WeaponSortOrder.RANGE_LH.ordinal()) {</span>
<span class="nc" id="L2735">            entity.setWeaponSortOrder(Entity.WeaponSortOrder.RANGE_LH);</span>
<span class="nc" id="L2736">            weapComparator = new WeaponComparatorRange(true);</span>
<span class="nc bnc" id="L2737" title="All 2 branches missed.">        } else if (sortIdx == Entity.WeaponSortOrder.RANGE_HL.ordinal()) {</span>
<span class="nc" id="L2738">            entity.setWeaponSortOrder(Entity.WeaponSortOrder.RANGE_HL);</span>
<span class="nc" id="L2739">            weapComparator = new WeaponComparatorRange(false);</span>
<span class="nc bnc" id="L2740" title="All 2 branches missed.">        } else if (sortIdx == Entity.WeaponSortOrder.DAMAGE_LH.ordinal()) {</span>
<span class="nc" id="L2741">            entity.setWeaponSortOrder(Entity.WeaponSortOrder.DAMAGE_LH);</span>
<span class="nc" id="L2742">            weapComparator = new WeaponComparatorDamage(true);</span>
<span class="nc bnc" id="L2743" title="All 2 branches missed.">        } else if (sortIdx == Entity.WeaponSortOrder.DAMAGE_HL.ordinal()) {</span>
<span class="nc" id="L2744">            entity.setWeaponSortOrder(Entity.WeaponSortOrder.DAMAGE_HL);</span>
<span class="nc" id="L2745">            weapComparator = new WeaponComparatorDamage(false);</span>
<span class="nc bnc" id="L2746" title="All 2 branches missed.">        } else if (sortIdx == Entity.WeaponSortOrder.CUSTOM.ordinal()) {</span>
<span class="nc" id="L2747">            entity.setWeaponSortOrder(Entity.WeaponSortOrder.CUSTOM);</span>
<span class="nc" id="L2748">            weapComparator = new WeaponComparatorCustom(entity);</span>
<span class="nc bnc" id="L2749" title="All 2 branches missed.">        } else if (sortIdx == Entity.WeaponSortOrder.ARC.ordinal()) {</span>
<span class="nc" id="L2750">            entity.setWeaponSortOrder(Entity.WeaponSortOrder.ARC);</span>
<span class="nc" id="L2751">            weapComparator = new WeaponComparatorArc(entity);</span>
        } else { // Default
<span class="nc" id="L2753">            entity.setWeaponSortOrder(Entity.WeaponSortOrder.DEFAULT);</span>
<span class="nc" id="L2754">            weapComparator = new WeaponComparatorNum(entity);</span>
        }
<span class="nc bnc" id="L2756" title="All 2 branches missed.">        if (unitDisplay.getClientGUI() != null) {</span>
<span class="nc" id="L2757">            unitDisplay.getClientGUI().getMenuBar()</span>
<span class="nc" id="L2758">                    .updateSaveWeaponOrderMenuItem();</span>
        }
<span class="nc" id="L2760">        ((WeaponListModel)weaponList.getModel()).sort(weapComparator);</span>
<span class="nc" id="L2761">    }</span>
    
    private void addListeners() {
<span class="nc" id="L2764">        weapSortOrder.addActionListener(this);</span>
<span class="nc" id="L2765">        m_chAmmo.addActionListener(this);</span>
<span class="nc" id="L2766">        m_chBayWeapon.addActionListener(this);</span>
        
<span class="nc" id="L2768">        weaponList.addListSelectionListener(this);</span>
<span class="nc" id="L2769">    }</span>
    
    private void removeListeners() {
<span class="nc" id="L2772">        weapSortOrder.removeActionListener(this);</span>
<span class="nc" id="L2773">        m_chAmmo.removeActionListener(this);</span>
<span class="nc" id="L2774">        m_chBayWeapon.removeActionListener(this);</span>
        
<span class="nc" id="L2776">        weaponList.removeListSelectionListener(this);</span>
<span class="nc" id="L2777">    }</span>

    public Targetable getPrevTarget() {
<span class="nc" id="L2780">        return prevTarget;</span>
    }

    public void setPrevTarget(Targetable prevTarget) {
<span class="nc" id="L2784">        this.prevTarget = prevTarget;</span>
<span class="nc" id="L2785">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>