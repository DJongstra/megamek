<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="nl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BoardEditor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">PlayerTest Coverage Results</a> &gt; <a href="index.source.html" class="el_package">megamek.client.ui.swing</a> &gt; <span class="el_source">BoardEditor.java</span></div><h1>BoardEditor.java</h1><pre class="source lang-java linenums">/*
 * MegaMek - Copyright (C) 2000-2003 Ben Mazur (bmazur@sev.org)
 *
 *  This program is free software; you can redistribute it and/or modify it
 *  under the terms of the GNU General Public License as published by the Free
 *  Software Foundation; either version 2 of the License, or (at your option)
 *  any later version.
 *
 *  This program is distributed in the hope that it will be useful, but
 *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
 *  for more details.
 */
package megamek.client.ui.swing;

import java.awt.BorderLayout;
import java.awt.Color;
import java.awt.Component;
import java.awt.Cursor;
import java.awt.Desktop;
import java.awt.Dimension;
import java.awt.FlowLayout;
import java.awt.Font;
import java.awt.Graphics;
import java.awt.Graphics2D;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.GridLayout;
import java.awt.Image;
import java.awt.Insets;
import java.awt.Point;
import java.awt.RenderingHints;
import java.awt.SystemColor;
import java.awt.event.*;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.HashSet;
import java.util.LinkedList;
import java.util.List;
import java.util.Set;
import java.util.Stack;

import javax.imageio.ImageIO;
import javax.swing.Box;
import javax.swing.ButtonGroup;
import javax.swing.DefaultListCellRenderer;
import javax.swing.DefaultListModel;
import javax.swing.ImageIcon;
import javax.swing.JButton;
import javax.swing.JCheckBox;
import javax.swing.JComboBox;
import javax.swing.JComponent;
import javax.swing.JDialog;
import javax.swing.JFileChooser;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JList;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JScrollPane;
import javax.swing.ScrollPaneConstants;
import javax.swing.JTextArea;
import javax.swing.JTextField;
import javax.swing.JToggleButton;
import javax.swing.SwingConstants;
import javax.swing.WindowConstants;
import javax.swing.border.LineBorder;
import javax.swing.border.TitledBorder;
import javax.swing.event.DocumentEvent;
import javax.swing.event.DocumentListener;
import javax.swing.event.ListSelectionEvent;
import javax.swing.event.ListSelectionListener;
import javax.swing.filechooser.FileFilter;

import megamek.MegaMek;
import megamek.client.event.BoardViewEvent;
import megamek.client.event.BoardViewListenerAdapter;
import megamek.client.ui.Messages;
import megamek.client.ui.swing.boardview.BoardView1;
import megamek.client.ui.swing.tileset.TilesetManager;
import megamek.client.ui.swing.util.MegaMekController;
import megamek.common.*;
import megamek.common.util.BoardUtilities;
import megamek.common.util.ImageUtil;
import megamek.common.util.fileUtils.MegaMekFile;

// TODO: center map
// TODO: background on the whole screen
// TODO: restrict terrains to those with images?
// TODO: Allow drawing of invalid terrain as an override?
// TODO: Allow adding/changing board background images
// TODO: sluggish hex drawing?
// TODO: the board validation after a board load seems to be influenced by the former board...
// TODO: copy/paste hexes

public class BoardEditor extends JComponent
        implements ItemListener, ListSelectionListener, ActionListener, DocumentListener, IMapSettingsObserver {
    
    /**
     * Class to make terrains in JComboBoxes easier.  This enables keeping the terrain type int separate from the name
     * that gets displayed and also provides a way to get tooltips.
     * 
     * @author arlith
     */
    private static class TerrainHelper implements Comparable&lt;TerrainHelper&gt; {
        private int terrainType;

<span class="nc" id="L115">        TerrainHelper (int terrain) {</span>
<span class="nc" id="L116">            terrainType = terrain;</span>
<span class="nc" id="L117">        }</span>

        public int getTerrainType() {
<span class="nc" id="L120">            return terrainType;</span>
        }

        public String toString() {
<span class="nc" id="L124">            return Terrains.getEditorName(terrainType);</span>
        }

        public String getTerrainTooltip() {
<span class="nc" id="L128">            return Terrains.getEditorTooltip(terrainType);</span>
        }

        @Override
        public int compareTo(TerrainHelper o) {
<span class="nc" id="L133">            return toString().compareTo(o.toString());</span>
        }
        
        @Override
        public boolean equals(Object other) {
<span class="nc bnc" id="L138" title="All 2 branches missed.">            if (other instanceof Integer) {</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">                return getTerrainType() == (Integer) other;</span>
            }
<span class="nc bnc" id="L141" title="All 2 branches missed.">            if (!(other instanceof TerrainHelper)) {</span>
<span class="nc" id="L142">                return false;</span>
            }
<span class="nc bnc" id="L144" title="All 2 branches missed.">            return getTerrainType() == ((TerrainHelper)other).getTerrainType();</span>
        }
    }

    /**
     * Class to make it easier to display a &lt;code&gt;Terrain&lt;/code&gt; in a JList or JComboBox.
     *
     * @author arlith
     */
    private static class TerrainTypeHelper implements Comparable&lt;TerrainTypeHelper&gt; {

        ITerrain terrain;

<span class="nc" id="L157">        TerrainTypeHelper(ITerrain terrain) {</span>
<span class="nc" id="L158">            this.terrain = terrain;</span>
<span class="nc" id="L159">        }</span>

        public ITerrain getTerrain() {
<span class="nc" id="L162">            return terrain;</span>
        }

        @Override
        public String toString() {
<span class="nc" id="L167">            String baseString = Terrains.getDisplayName(terrain.getType(), terrain.getLevel());</span>
<span class="nc bnc" id="L168" title="All 2 branches missed.">            if (baseString == null) {</span>
<span class="nc" id="L169">                baseString = Terrains.getEditorName(terrain.getType());</span>
<span class="nc" id="L170">                baseString += &quot; &quot; + terrain.getLevel();</span>
            }
<span class="nc bnc" id="L172" title="All 2 branches missed.">            if (terrain.hasExitsSpecified()) {</span>
<span class="nc" id="L173">                baseString += &quot; (Exits: &quot; + terrain.getExits() + &quot;)&quot;;</span>
            }
<span class="nc" id="L175">            return baseString; </span>
        }

        public String getTooltip() {
<span class="nc" id="L179">            return terrain.toString();</span>
        }

        @Override
        public int compareTo(TerrainTypeHelper o) {
<span class="nc" id="L184">            return toString().compareTo(o.toString());</span>
        }
    }
    
    /**
     *  ListCellRenderer for rendering tooltips for each item in a list or combobox.  Code from SourceForge:
     *  https://stackoverflow.com/questions/480261/java-swing-mouseover-text-on-jcombobox-items 
     */
    private static class ComboboxToolTipRenderer extends DefaultListCellRenderer {
        /**
         * 
         */
        private static final long serialVersionUID = 7428395938750335593L;

        TerrainHelper[] terrains;
        
        List&lt;TerrainTypeHelper&gt; terrainTypes;

        @Override
        public Component getListCellRendererComponent(JList&lt;?&gt; list, Object value, int index, boolean isSelected,
                boolean cellHasFocus) {

<span class="nc" id="L206">            JComponent comp = (JComponent) super.getListCellRendererComponent(list, value, index, isSelected,</span>
                    cellHasFocus);

<span class="nc bnc" id="L209" title="All 6 branches missed.">            if (-1 &lt; index &amp;&amp; null != value &amp;&amp; null != terrains) {</span>
<span class="nc" id="L210">                list.setToolTipText(terrains[index].getTerrainTooltip());</span>
            }
<span class="nc bnc" id="L212" title="All 6 branches missed.">            if (-1 &lt; index &amp;&amp; null != value &amp;&amp; null != terrainTypes) {</span>
<span class="nc" id="L213">                list.setToolTipText(terrainTypes.get(index).getTooltip());</span>
            }
<span class="nc" id="L215">            return comp;</span>
        }

        public void setTerrains(TerrainHelper[] terrains) {
<span class="nc" id="L219">            this.terrains = terrains;</span>
<span class="nc" id="L220">        }</span>
        
        public void setTerrainTypes(List&lt;TerrainTypeHelper&gt; terrainTypes) {
<span class="nc" id="L223">            this.terrainTypes = terrainTypes;</span>
<span class="nc" id="L224">        }</span>
    }
 
    private static final long serialVersionUID = 4689863639249616192L;
    
<span class="nc" id="L229">    GUIPreferences guip = GUIPreferences.getInstance();</span>

    //region action commands
    private static final String FILE_BOARD_EDITOR_EXPAND = &quot;fileBoardExpand&quot;;
    private static final String FILE_BOARD_EDITOR_VALIDATE = &quot;fileBoardValidate&quot;;
    private static final String FILE_SOURCEFILE = &quot;fileSource&quot;;
    //endregion action commands

    // Components
<span class="nc" id="L238">    JFrame frame = new JFrame();</span>
    JScrollPane scrollPane;
<span class="nc" id="L240">    private Game game = new Game();</span>
<span class="nc" id="L241">    IBoard board = game.getBoard();</span>
    BoardView1 bv;
<span class="nc" id="L243">    public static final int [] allDirections = {0,1,2,3,4,5};</span>
<span class="nc" id="L244">    boolean isDragging = false;</span>
    private Component bvc;
<span class="nc" id="L246">    private CommonMenuBar menuBar = new CommonMenuBar();</span>
    private CommonAboutDialog about;
    private CommonHelpDialog help;
    private CommonSettingsDialog setdlg;
<span class="nc" id="L250">    private ITerrainFactory TF = Terrains.getTerrainFactory();</span>
    private JDialog minimapW;
    private MiniMap minimap;
    MegaMekController controller;
    
    // The current files
    private File curfileImage;
    private File curBoardFile;

    // The active hex &quot;brush&quot;
    private HexCanvas canHex;
<span class="nc" id="L261">    IHex curHex = new Hex();</span>
    
    // Easy terrain access buttons
    private JButton buttonLW, buttonLJ;
    private JButton buttonOW, buttonOJ;
    private JButton buttonWa, buttonSw, buttonRo;
    private JButton buttonRd, buttonCl, buttonBu;
    private JButton buttonMd, buttonPv, buttonSn;
    private JButton buttonIc, buttonTu, buttonMg;
    private JButton buttonBr, buttonFT;
    private JToggleButton buttonBrush1, buttonBrush2, buttonBrush3;
    private JToggleButton buttonUpDn, buttonOOC;
    // The brush size: 1 = 1 hex, 2 = radius 1, 3 = radius 2  
<span class="nc" id="L274">    int brushSize = 1;</span>
<span class="nc" id="L275">    int hexLeveltoDraw = -1000;</span>
<span class="nc" id="L276">    private Font fontElev = new Font(&quot;SansSerif&quot;, Font.BOLD, 20); //$NON-NLS-1$</span>
<span class="nc" id="L277">    private Font fontComboTerr = new Font(&quot;SansSerif&quot;, Font.BOLD, 12); //$NON-NLS-1$</span>
    private EditorTextField texElev;
    private JButton butElevUp;
    private JButton butElevDown;
    private JList&lt;TerrainTypeHelper&gt; lisTerrain;
    private ComboboxToolTipRenderer lisTerrainRenderer;
    private JButton butDelTerrain;
    private JComboBox&lt;TerrainHelper&gt; choTerrainType;
    private EditorTextField texTerrainLevel;
    private JCheckBox cheTerrExitSpecified;
    private EditorTextField texTerrExits;
    private JButton butTerrExits;
    private JCheckBox cheRoadsAutoExit;
    private JButton butExitUp, butExitDown;
    private JComboBox&lt;String&gt; choTheme;
    private JButton butTerrDown, butTerrUp;
    private JButton butAddTerrain;
    private JButton butBoardNew;
    private JButton butBoardOpen;
    private JButton butBoardSave;
    private JButton butBoardSaveAs;
    private JButton butBoardSaveAsImage;
    private JButton butMiniMap;
    private JButton butBoardValidate;
    private JButton butSourceFile;
<span class="nc" id="L302">    private MapSettings mapSettings = MapSettings.getInstance();</span>
    private JButton butExpandMap;
    private Coords lastClicked;
    
    // Undo / Redo
    JButton buttonUndo, buttonRedo;
<span class="nc" id="L308">    private Stack&lt;HashSet&lt;IHex&gt;&gt; undoStack = new Stack&lt;&gt;();</span>
<span class="nc" id="L309">    private Stack&lt;HashSet&lt;IHex&gt;&gt; redoStack = new Stack&lt;&gt;();</span>
    private HashSet&lt;IHex&gt; currentUndoSet;
    private HashSet&lt;Coords&gt; currentUndoCoords;
    
    // Tracker for board changes; unfortunately this is not equal to 
    // undoStack == empty because saving the board doesn't empty the 
    // undo stack but makes the board unchanged.
    /** Tracks if the board has changes over the last saved version. */
<span class="nc" id="L317">    private boolean hasChanges = false;</span>
    /** Tracks if the board can return to the last saved version. */
<span class="nc" id="L319">    private boolean canReturnToSaved = true;</span>
    /** The undo stack size at the last save. Used to track saved status of the board. */
<span class="nc" id="L321">    private int savedUndoStackSize = 0;</span>
    
    // Misc
<span class="nc" id="L324">    private File loadPath = Configuration.boardsDir();</span>
    
    /**
     * Special purpose indicator, keeps terrain list 
     * from de-selecting when clicking it
     */
<span class="nc" id="L330">    private boolean terrListBlocker = false;</span>
    
    /**
     * Special purpose indicator, prevents an update
     * loop when the terrain level or exits field is changed
     */
<span class="nc" id="L336">    private boolean noTextFieldUpdate = false;</span>
    
    /**
     * A MouseAdapter that closes a JLabel when clicked 
     */
<span class="nc" id="L341">    private MouseAdapter clickToHide = new MouseAdapter() {</span>
        @Override
        public void mouseReleased(MouseEvent e) {
<span class="nc bnc" id="L344" title="All 2 branches missed.">            if (e.getSource() instanceof JLabel)</span>
<span class="nc" id="L345">                ((JLabel) e.getSource()).setVisible(false);</span>
<span class="nc" id="L346">        }</span>
    };

    /**
     * Flag that indicates whether hotkeys should be ignored or not.  This is
     * used for disabling hot keys when various dialogs are displayed.
     */
<span class="nc" id="L353">    private boolean ignoreHotKeys = false;</span>

    /**
     * Creates and lays out a new Board Editor frame.
     */
<span class="nc" id="L358">    public BoardEditor(MegaMekController c) {</span>
<span class="nc" id="L359">        controller = c;</span>
        try {
<span class="nc" id="L361">            bv = new BoardView1(game, controller, null);</span>
<span class="nc" id="L362">            bvc = bv.getComponent(true);</span>
<span class="nc" id="L363">            bv.setDisplayInvalidHexInfo(true);</span>
<span class="nc" id="L364">        } catch (IOException e) {</span>
<span class="nc" id="L365">            JOptionPane</span>
<span class="nc" id="L366">                    .showMessageDialog(</span>
                            frame,
<span class="nc" id="L368">                            Messages.getString(&quot;BoardEditor.CouldntInitialize&quot;) + e,</span>
<span class="nc" id="L369">                            Messages.getString(&quot;BoardEditor.FatalError&quot;), JOptionPane.ERROR_MESSAGE); //$NON-NLS-1$</span>
            //$NON-NLS-2$
<span class="nc" id="L371">            frame.dispose();</span>
<span class="nc" id="L372">        }</span>

        // Add a mouse listener for mouse button release 
        // to handle Undo
<span class="nc" id="L376">        bv.addMouseListener(new MouseAdapter() {</span>
            @Override
            public void mouseReleased(MouseEvent e) {
<span class="nc bnc" id="L379" title="All 2 branches missed.">                if (e.getButton() == MouseEvent.BUTTON1) {</span>
                    // Act only if the user actually drew something
<span class="nc bnc" id="L381" title="All 2 branches missed.">                    if ((currentUndoSet != null) &amp;&amp;</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">                            !currentUndoSet.isEmpty()) {</span>
                        // Since this draw action is finished, push the
                        // drawn hexes onto the Undo Stack and get ready
                        // for a new draw action
<span class="nc" id="L386">                        undoStack.push(currentUndoSet);</span>
<span class="nc" id="L387">                        currentUndoSet = null;</span>
<span class="nc" id="L388">                        buttonUndo.setEnabled(true);</span>
                        // Drawing something disables any redo actions
<span class="nc" id="L390">                        redoStack.clear();</span>
<span class="nc" id="L391">                        buttonRedo.setEnabled(false);</span>
                        // When Undo (without Redo) has been used after saving
                        // and the user draws on the board, then it can
                        // no longer know if it's been returned to the saved state
                        // and it will always be treated as changed.
<span class="nc bnc" id="L396" title="All 2 branches missed.">                        if (savedUndoStackSize &gt; undoStack.size()) {</span>
<span class="nc" id="L397">                            canReturnToSaved = false;</span>
                        }
<span class="nc bnc" id="L399" title="All 4 branches missed.">                        hasChanges = !canReturnToSaved | (undoStack.size() != savedUndoStackSize);</span>
                    }
                    // Mark the title when the board has changes
<span class="nc" id="L402">                    setFrameTitle();</span>
                }
<span class="nc" id="L404">            }</span>
        });
<span class="nc" id="L406">        bv.addBoardViewListener(new BoardViewListenerAdapter() {</span>
            @Override
            public void hexMoused(BoardViewEvent b) {
<span class="nc" id="L409">                Coords c = b.getCoords();</span>
                // return if there are no or no valid coords or if we click the same hex again
                // unless Raise/Lower Terrain is active which should let us click the same hex 
<span class="nc bnc" id="L412" title="All 6 branches missed.">                if ((c == null) || (c.equals(lastClicked) &amp;&amp; !buttonUpDn.isSelected())</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">                        || !board.contains(c)) {</span>
<span class="nc" id="L414">                    return;</span>
                }
<span class="nc" id="L416">                lastClicked = c;</span>
<span class="nc" id="L417">                bv.cursor(c);</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">                boolean isALT = (b.getModifiers() &amp; ActionEvent.ALT_MASK) != 0;</span>
<span class="nc bnc" id="L419" title="All 2 branches missed.">                boolean isSHIFT = (b.getModifiers() &amp; ActionEvent.SHIFT_MASK) != 0;</span>
<span class="nc bnc" id="L420" title="All 2 branches missed.">                boolean isCTRL = (b.getModifiers() &amp; ActionEvent.CTRL_MASK) != 0;</span>
<span class="nc bnc" id="L421" title="All 2 branches missed.">                boolean isLMB = (b.getModifiers() &amp; InputEvent.BUTTON1_MASK) != 0;</span>

                // Raise/Lower Terrain is selected
<span class="nc bnc" id="L424" title="All 2 branches missed.">                if (buttonUpDn.isSelected()) {</span>
                    
                    // Mouse Button released
<span class="nc bnc" id="L427" title="All 2 branches missed.">                    if (b.getType() == BoardViewEvent.BOARD_HEX_CLICKED) {</span>
<span class="nc" id="L428">                        hexLeveltoDraw = -1000;</span>
<span class="nc" id="L429">                        isDragging = false;</span>
                    }

                    // Mouse Button clicked or dragged
<span class="nc bnc" id="L433" title="All 4 branches missed.">                    if ((b.getType() == BoardViewEvent.BOARD_HEX_DRAGGED) &amp;&amp; isLMB) {</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">                        if (!isDragging) {</span>
<span class="nc" id="L435">                            hexLeveltoDraw = board.getHex(c).getLevel();</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">                            if (isALT) hexLeveltoDraw--;</span>
<span class="nc bnc" id="L437" title="All 2 branches missed.">                            else if (isSHIFT) hexLeveltoDraw++;</span>
<span class="nc" id="L438">                            isDragging = true;</span>
                        }
                    }

                    // CORRECTION, click outside the board then drag inside???
<span class="nc bnc" id="L443" title="All 2 branches missed.">                    if (hexLeveltoDraw != -1000) {</span>
<span class="nc" id="L444">                        LinkedList&lt;Coords&gt; allBrushHexes = getBrushCoords(c) ;</span>
<span class="nc bnc" id="L445" title="All 2 branches missed.">                        for (Coords h: allBrushHexes) {</span>
<span class="nc bnc" id="L446" title="All 4 branches missed.">                            if (!buttonOOC.isSelected() || board.getHex(h).isClearHex())</span>
                            {
<span class="nc" id="L448">                                saveToUndo(h);</span>
<span class="nc" id="L449">                                relevelHex(h);</span>
                            }   
<span class="nc" id="L451">                        }</span>
<span class="nc" id="L452">                    }</span>
                    // ------- End Raise/Lower Terrain
                } else {
                    // Normal texture paint
<span class="nc bnc" id="L456" title="All 2 branches missed.">                    if (isALT) { // ALT-Click</span>
<span class="nc" id="L457">                        setCurrentHex(board.getHex(b.getCoords()));</span>
                    } else {
<span class="nc" id="L459">                        LinkedList&lt;Coords&gt; allBrushHexes = getBrushCoords(c);</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">                        for (Coords h: allBrushHexes) {</span>
                            // test if texture overwriting is active
<span class="nc bnc" id="L462" title="All 6 branches missed.">                            if ((!buttonOOC.isSelected() || board.getHex(h).isClearHex()) &amp;&amp; curHex.isValid(null))</span>
                            {
<span class="nc" id="L464">                                saveToUndo(h);</span>
<span class="nc bnc" id="L465" title="All 2 branches missed.">                                if (isCTRL) { // CTRL-Click</span>
<span class="nc" id="L466">                                    paintHex(h);</span>
<span class="nc bnc" id="L467" title="All 2 branches missed.">                                } else if (isSHIFT) { // SHIFT-Click</span>
<span class="nc" id="L468">                                    addToHex(h);</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">                                } else if (isLMB) { // Normal click</span>
<span class="nc" id="L470">                                    retextureHex(h);</span>
                                }
                            }
<span class="nc" id="L473">                        }</span>
                    }
                }
<span class="nc" id="L476">            }</span>
        });
        
<span class="nc" id="L479">        bv.setUseLOSTool(false);</span>
<span class="nc" id="L480">        setupEditorPanel();</span>
<span class="nc" id="L481">        setupFrame();</span>
<span class="nc" id="L482">        frame.setVisible(true);</span>
<span class="nc bnc" id="L483" title="All 2 branches missed.">        if (GUIPreferences.getInstance().getNagForMapEdReadme()) {</span>
<span class="nc" id="L484">            String title = Messages.getString(&quot;BoardEditor.readme.title&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L485">            String body = Messages.getString(&quot;BoardEditor.readme.message&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L486">            ConfirmDialog confirm = new ConfirmDialog(frame, title, body, true);</span>
<span class="nc" id="L487">            confirm.setVisible(true);</span>
<span class="nc bnc" id="L488" title="All 2 branches missed.">            if (!confirm.getShowAgain()) {</span>
<span class="nc" id="L489">                GUIPreferences.getInstance().setNagForMapEdReadme(false);</span>
            }
<span class="nc bnc" id="L491" title="All 2 branches missed.">            if (confirm.getAnswer()) {</span>
<span class="nc" id="L492">                showHelp();</span>
            }
        }
<span class="nc" id="L495">    }</span>

    /**
     * Sets up the frame that will display the editor.
     */
    private void setupFrame() {
<span class="nc" id="L501">        scrollPane = new JScrollPane(this, ScrollPaneConstants.VERTICAL_SCROLLBAR_AS_NEEDED,</span>
                ScrollPaneConstants.HORIZONTAL_SCROLLBAR_NEVER);
<span class="nc" id="L503">        scrollPane.getVerticalScrollBar().setUnitIncrement(12);</span>

<span class="nc" id="L505">        setFrameTitle();</span>
<span class="nc" id="L506">        frame.getContentPane().setLayout(new BorderLayout());</span>

<span class="nc" id="L508">        frame.getContentPane().add(bvc, BorderLayout.CENTER);</span>
<span class="nc" id="L509">        frame.getContentPane().add(scrollPane, BorderLayout.EAST);</span>
<span class="nc" id="L510">        menuBar.addActionListener(this);</span>
<span class="nc" id="L511">        frame.setJMenuBar(menuBar);</span>
<span class="nc" id="L512">        frame.setBackground(SystemColor.menu);</span>
<span class="nc" id="L513">        frame.setForeground(SystemColor.menuText);</span>
<span class="nc bnc" id="L514" title="All 2 branches missed.">        if (GUIPreferences.getInstance().getWindowSizeHeight() != 0) {</span>
<span class="nc" id="L515">            frame.setLocation(GUIPreferences.getInstance().getWindowPosX(),</span>
<span class="nc" id="L516">                              GUIPreferences.getInstance().getWindowPosY());</span>
<span class="nc" id="L517">            frame.setSize(GUIPreferences.getInstance().getWindowSizeWidth(),</span>
<span class="nc" id="L518">                          GUIPreferences.getInstance().getWindowSizeHeight());</span>
        } else {
<span class="nc" id="L520">            frame.setSize(800, 600);</span>
        }

<span class="nc" id="L523">        frame.setDefaultCloseOperation(WindowConstants.DO_NOTHING_ON_CLOSE);</span>
<span class="nc" id="L524">        frame.addWindowListener(new WindowAdapter() {</span>
            @Override
            public void windowClosing(WindowEvent e) {
                // When the board has changes, ask the user 
<span class="nc bnc" id="L528" title="All 2 branches missed.">                if (hasChanges) {</span>
<span class="nc" id="L529">                    ignoreHotKeys = true;</span>
<span class="nc" id="L530">                    int savePrompt = JOptionPane.showConfirmDialog(null,</span>
<span class="nc" id="L531">                            Messages.getString(&quot;BoardEditor.exitprompt&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L532">                            Messages.getString(&quot;BoardEditor.exittitle&quot;), //$NON-NLS-1$</span>
                            JOptionPane.YES_NO_CANCEL_OPTION,
                            JOptionPane.WARNING_MESSAGE);
<span class="nc" id="L535">                    ignoreHotKeys = false;</span>

                    // When the user cancels or did not actually save the board, don't close 
<span class="nc bnc" id="L538" title="All 6 branches missed.">                    if (((savePrompt == JOptionPane.YES_OPTION) &amp;&amp; !boardSave(false)) || </span>
                            (savePrompt == JOptionPane.CANCEL_OPTION)) {
<span class="nc" id="L540">                        return;</span>
                    } 
                }

                // otherwise: exit the Map Editor
<span class="nc" id="L545">                minimapW.setVisible(false);</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">                if (controller != null) {</span>
<span class="nc" id="L547">                    controller.removeAllActions();</span>
<span class="nc" id="L548">                    controller.boardEditor = null;</span>
                }
<span class="nc" id="L550">                frame.dispose();</span>
<span class="nc" id="L551">            }</span>
        });
<span class="nc" id="L553">    }</span>

    /**
     * Sets up JButtons
     */
    private JButton prepareButton(String iconName, String buttonName, ArrayList&lt;JButton&gt; bList) {
<span class="nc" id="L559">        JButton button = new JButton(buttonName);</span>
<span class="nc" id="L560">        button.addActionListener(this);</span>
        // Get the normal icon
<span class="nc" id="L562">        File file = new MegaMekFile(Configuration.widgetsDir(), &quot;/MapEditor/&quot;+iconName+&quot;.png&quot;).getFile(); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L563">        Image imageButton = ImageUtil.loadImageFromFile(file.getAbsolutePath());</span>
<span class="nc bnc" id="L564" title="All 2 branches missed.">        if (imageButton != null) {</span>
<span class="nc" id="L565">            button.setIcon(new ImageIcon(imageButton));</span>
            // When there is an icon, then the text can be removed
<span class="nc" id="L567">            button.setText(&quot;&quot;);</span>
        }

        // Get the hover icon
<span class="nc" id="L571">        file = new MegaMekFile(Configuration.widgetsDir(), &quot;/MapEditor/&quot;+iconName+&quot;_H.png&quot;).getFile(); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L572">        imageButton = ImageUtil.loadImageFromFile(file.getAbsolutePath());</span>
<span class="nc bnc" id="L573" title="All 2 branches missed.">        if (imageButton != null) {</span>
<span class="nc" id="L574">            button.setRolloverIcon(new ImageIcon(imageButton));</span>
        }
        
        // Get the disabled icon, if any
<span class="nc" id="L578">        file = new MegaMekFile(Configuration.widgetsDir(), &quot;/MapEditor/&quot;+iconName+&quot;_G.png&quot;).getFile(); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L579">        imageButton = ImageUtil.loadImageFromFile(file.getAbsolutePath());</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">        if (imageButton != null) {</span>
<span class="nc" id="L581">            button.setDisabledIcon(new ImageIcon(imageButton));</span>
        }

<span class="nc" id="L584">        String tt = Messages.getString(&quot;BoardEditor.&quot;+iconName+&quot;TT&quot;);</span>
<span class="nc bnc" id="L585" title="All 2 branches missed.">        if (tt.length() != 0) {</span>
<span class="nc" id="L586">            button.setToolTipText(tt); //$NON-NLS-1$ //$NON-NLS-2$</span>
        }
<span class="nc" id="L588">        button.setMargin(new Insets(0,0,0,0));</span>
<span class="nc bnc" id="L589" title="All 2 branches missed.">        if (bList != null) bList.add(button);</span>
<span class="nc" id="L590">        return button;</span>
    }
    
    /**
     * Sets up JToggleButtons
     */
    private JToggleButton addTerrainTButton(String iconName, String buttonName, ArrayList&lt;JToggleButton&gt; bList) {
<span class="nc" id="L597">        JToggleButton button = new JToggleButton(buttonName);</span>
<span class="nc" id="L598">        button.addActionListener(this);</span>
        
        // Get the normal icon
<span class="nc" id="L601">        File file = new MegaMekFile(Configuration.widgetsDir(), &quot;/MapEditor/&quot;+iconName+&quot;.png&quot;).getFile(); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L602">        Image imageButton = ImageUtil.loadImageFromFile(file.getAbsolutePath());</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">        if (imageButton != null) {</span>
<span class="nc" id="L604">            button.setIcon(new ImageIcon(imageButton));</span>
            // When there is an icon, then the text can be removed
<span class="nc" id="L606">            button.setText(&quot;&quot;);</span>
        }
        
        // Get the hover icon
<span class="nc" id="L610">        file = new MegaMekFile(Configuration.widgetsDir(), &quot;/MapEditor/&quot;+iconName+&quot;_H.png&quot;).getFile(); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L611">        imageButton = ImageUtil.loadImageFromFile(file.getAbsolutePath());</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">        if (imageButton != null)</span>
<span class="nc" id="L613">            button.setRolloverIcon(new ImageIcon(imageButton));</span>
        
        // Get the selected icon
<span class="nc" id="L616">        file = new MegaMekFile(Configuration.widgetsDir(), &quot;/MapEditor/&quot;+iconName+&quot;_S.png&quot;).getFile(); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L617">        imageButton = ImageUtil.loadImageFromFile(file.getAbsolutePath());</span>
<span class="nc bnc" id="L618" title="All 2 branches missed.">        if (imageButton != null)</span>
<span class="nc" id="L619">            button.setSelectedIcon(new ImageIcon(imageButton));</span>
        
<span class="nc" id="L621">        button.setToolTipText(Messages.getString(&quot;BoardEditor.&quot;+iconName+&quot;TT&quot;)); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc bnc" id="L622" title="All 2 branches missed.">        if (bList != null) bList.add(button);</span>
<span class="nc" id="L623">        return button;</span>
    }

    /**
     * Sets up the editor panel, which goes on the right of the map and has
     * controls for editing the current square.
     */
    private void setupEditorPanel() {
        // Help Texts
<span class="nc" id="L632">        JLabel genHelpText1 = new JLabel(Messages.getString(&quot;BoardEditor.helpText&quot;),SwingConstants.LEFT); //$NON-NLS-1$</span>
<span class="nc" id="L633">        JLabel terrainButtonHelp = new JLabel(Messages.getString(&quot;BoardEditor.helpText2&quot;),SwingConstants.LEFT); //$NON-NLS-1$</span>
<span class="nc" id="L634">        genHelpText1.addMouseListener(clickToHide);</span>
<span class="nc" id="L635">        terrainButtonHelp.addMouseListener(clickToHide);</span>

        // Buttons to ease setting common terrain types
<span class="nc" id="L638">        ArrayList&lt;JButton&gt; terrainButtons = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L639">        buttonLW = prepareButton(&quot;ButtonLW&quot;, &quot;Woods&quot;, terrainButtons);</span>
<span class="nc" id="L640">        buttonLJ = prepareButton(&quot;ButtonLJ&quot;, &quot;Jungle&quot;, terrainButtons);</span>
<span class="nc" id="L641">        buttonOW = prepareButton(&quot;ButtonLLW&quot;, &quot;Low Woods&quot;, terrainButtons);</span>
<span class="nc" id="L642">        buttonOJ = prepareButton(&quot;ButtonLLJ&quot;, &quot;Low Jungle&quot;, terrainButtons);</span>
<span class="nc" id="L643">        buttonWa = prepareButton(&quot;ButtonWa&quot;, &quot;Water&quot;, terrainButtons);</span>
<span class="nc" id="L644">        buttonSw = prepareButton(&quot;ButtonSw&quot;, &quot;Swamp&quot;, terrainButtons);</span>
<span class="nc" id="L645">        buttonRo = prepareButton(&quot;ButtonRo&quot;, &quot;Rough&quot;, terrainButtons);</span>
<span class="nc" id="L646">        buttonMd = prepareButton(&quot;ButtonMd&quot;, &quot;Mud&quot;, terrainButtons); </span>
<span class="nc" id="L647">        buttonPv = prepareButton(&quot;ButtonPv&quot;, &quot;Pavement&quot;, terrainButtons);</span>
<span class="nc" id="L648">        buttonSn = prepareButton(&quot;ButtonSn&quot;, &quot;Snow&quot;, terrainButtons); </span>
<span class="nc" id="L649">        buttonBu = prepareButton(&quot;ButtonBu&quot;, &quot;Buildings&quot;, terrainButtons);</span>
<span class="nc" id="L650">        buttonRd = prepareButton(&quot;ButtonRd&quot;, &quot;Roads&quot;, terrainButtons);</span>
<span class="nc" id="L651">        buttonBr = prepareButton(&quot;ButtonBr&quot;, &quot;Bridges&quot;, terrainButtons);</span>
<span class="nc" id="L652">        buttonFT = prepareButton(&quot;ButtonFT&quot;, &quot;Fuel Tanks&quot;, terrainButtons);</span>
<span class="nc" id="L653">        buttonIc = prepareButton(&quot;ButtonIc&quot;, &quot;Ice&quot;, terrainButtons);</span>
<span class="nc" id="L654">        buttonTu = prepareButton(&quot;ButtonTu&quot;, &quot;Tundra&quot;, terrainButtons);</span>
<span class="nc" id="L655">        buttonMg = prepareButton(&quot;ButtonMg&quot;, &quot;Magma&quot;, terrainButtons);</span>
<span class="nc" id="L656">        buttonCl = prepareButton(&quot;ButtonCl&quot;, &quot;Clear&quot;, terrainButtons);</span>

<span class="nc" id="L658">        ArrayList&lt;JToggleButton&gt; brushButtons = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L659">        buttonBrush1 = addTerrainTButton(&quot;ButtonHex1&quot;, &quot;Brush1&quot;, brushButtons); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L660">        buttonBrush2 = addTerrainTButton(&quot;ButtonHex7&quot;, &quot;Brush2&quot;, brushButtons); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L661">        buttonBrush3 = addTerrainTButton(&quot;ButtonHex19&quot;, &quot;Brush3&quot;, brushButtons); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L662">        ButtonGroup brushGroup = new ButtonGroup();</span>
<span class="nc" id="L663">        brushGroup.add(buttonBrush1);</span>
<span class="nc" id="L664">        brushGroup.add(buttonBrush2);</span>
<span class="nc" id="L665">        brushGroup.add(buttonBrush3);</span>
<span class="nc" id="L666">        buttonOOC = addTerrainTButton(&quot;ButtonOOC&quot;, &quot;OOC&quot;, brushButtons); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L667">        buttonUpDn = addTerrainTButton(&quot;ButtonUpDn&quot;, &quot;UpDown&quot;, brushButtons); //$NON-NLS-1$ //$NON-NLS-2$</span>

<span class="nc" id="L669">        ArrayList&lt;JButton&gt; undoButtons = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L670">        buttonUndo = prepareButton(&quot;ButtonUndo&quot;, &quot;Undo&quot;, undoButtons); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L671">        buttonRedo = prepareButton(&quot;ButtonRedo&quot;, &quot;Redo&quot;, undoButtons); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L672">        buttonUndo.setEnabled(false);</span>
<span class="nc" id="L673">        buttonRedo.setEnabled(false);</span>

<span class="nc" id="L675">        MouseWheelListener wheelListener = e -&gt; {</span>
<span class="nc" id="L676">            int terrain = Integer.MIN_VALUE;</span>
<span class="nc bnc" id="L677" title="All 2 branches missed.">            if (e.getSource() == buttonRo) terrain = Terrains.ROUGH;</span>
<span class="nc bnc" id="L678" title="All 2 branches missed.">            else if (e.getSource() == buttonSw) terrain = Terrains.SWAMP;</span>
<span class="nc bnc" id="L679" title="All 2 branches missed.">            else if (e.getSource() == buttonWa) terrain = Terrains.WATER;</span>
<span class="nc bnc" id="L680" title="All 2 branches missed.">            else if (e.getSource() == buttonLW) terrain = Terrains.WOODS;</span>
<span class="nc bnc" id="L681" title="All 2 branches missed.">            else if (e.getSource() == buttonLJ) terrain = Terrains.JUNGLE;</span>
<span class="nc bnc" id="L682" title="All 2 branches missed.">            else if (e.getSource() == buttonOW) terrain = Terrains.WOODS;</span>
<span class="nc bnc" id="L683" title="All 2 branches missed.">            else if (e.getSource() == buttonOJ) terrain = Terrains.JUNGLE;</span>
<span class="nc bnc" id="L684" title="All 2 branches missed.">            else if (e.getSource() == buttonMd) terrain = Terrains.MUD;</span>
<span class="nc bnc" id="L685" title="All 2 branches missed.">            else if (e.getSource() == buttonPv) terrain = Terrains.PAVEMENT;</span>
<span class="nc bnc" id="L686" title="All 2 branches missed.">            else if (e.getSource() == buttonIc) terrain = Terrains.ICE;</span>
<span class="nc bnc" id="L687" title="All 2 branches missed.">            else if (e.getSource() == buttonSn) terrain = Terrains.SNOW;</span>
<span class="nc bnc" id="L688" title="All 2 branches missed.">            else if (e.getSource() == buttonTu) terrain = Terrains.TUNDRA;</span>
<span class="nc bnc" id="L689" title="All 2 branches missed.">            else if (e.getSource() == buttonMg) terrain = Terrains.MAGMA;</span>
            else {
<span class="nc" id="L691">                return;</span>
            }

<span class="nc" id="L694">            IHex saveHex = curHex.duplicate();</span>
            // change the terrain level by wheel direction if present,
            // or set to 1 if not present
<span class="nc" id="L697">            int newLevel = 1;</span>
<span class="nc bnc" id="L698" title="All 2 branches missed.">            if (curHex.containsTerrain(terrain)) {</span>
<span class="nc bnc" id="L699" title="All 2 branches missed.">                newLevel = curHex.terrainLevel(terrain) + (e.getWheelRotation() &lt; 0 ? 1 : -1);</span>
            } else {
<span class="nc bnc" id="L701" title="All 2 branches missed.">                if (!e.isShiftDown()) {</span>
<span class="nc" id="L702">                    curHex.removeAllTerrains();</span>
                }
            }
<span class="nc" id="L705">            addSetTerrainEasy(terrain, newLevel);</span>
            // Add or adapt elevation helper terrain for foliage
            // When the elevation was 1, it stays 1 (L1 Foliage, TO p.36)
            // Otherwise, it is set to 3 for Ultra W/J and 2 otherwise (TW foliage)
<span class="nc bnc" id="L709" title="All 4 branches missed.">            if (terrain == Terrains.WOODS || terrain == Terrains.JUNGLE) {</span>
<span class="nc" id="L710">                int elev = curHex.terrainLevel(Terrains.FOLIAGE_ELEV);</span>
<span class="nc bnc" id="L711" title="All 4 branches missed.">                if (elev != 1 &amp;&amp; newLevel == 3) {</span>
<span class="nc" id="L712">                    elev = 3;</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">                } else if (elev != 1) {</span>
<span class="nc" id="L714">                    elev = 2;</span>
                }
<span class="nc" id="L716">                curHex.addTerrain(Terrains.getTerrainFactory().createTerrain(Terrains.FOLIAGE_ELEV, elev));</span>
            }
            // Reset the terrain to the former state
            // if the new would be invalid.
<span class="nc bnc" id="L720" title="All 2 branches missed.">            if (!curHex.isValid(null)) {</span>
<span class="nc" id="L721">                curHex = saveHex;</span>
            }
            
<span class="nc" id="L724">            refreshTerrainList();</span>
<span class="nc" id="L725">            repaintWorkingHex();</span>
<span class="nc" id="L726">        };</span>

<span class="nc" id="L728">        buttonSw.addMouseWheelListener(wheelListener);</span>
<span class="nc" id="L729">        buttonWa.addMouseWheelListener(wheelListener);</span>
<span class="nc" id="L730">        buttonRo.addMouseWheelListener(wheelListener);</span>
<span class="nc" id="L731">        buttonLJ.addMouseWheelListener(wheelListener);</span>
<span class="nc" id="L732">        buttonLW.addMouseWheelListener(wheelListener);</span>
<span class="nc" id="L733">        buttonOJ.addMouseWheelListener(wheelListener);</span>
<span class="nc" id="L734">        buttonOW.addMouseWheelListener(wheelListener);</span>
<span class="nc" id="L735">        buttonMd.addMouseWheelListener(wheelListener);</span>
<span class="nc" id="L736">        buttonPv.addMouseWheelListener(wheelListener);</span>
<span class="nc" id="L737">        buttonSn.addMouseWheelListener(wheelListener);</span>
<span class="nc" id="L738">        buttonIc.addMouseWheelListener(wheelListener);</span>
<span class="nc" id="L739">        buttonTu.addMouseWheelListener(wheelListener);</span>
<span class="nc" id="L740">        buttonMg.addMouseWheelListener(wheelListener);</span>

        // Mouse wheel behaviour for the BUILDINGS button
        // Always ADDS the building. 
<span class="nc" id="L744">        buttonBu.addMouseWheelListener(e -&gt; {</span>
            // Restore mandatory building parts if some are missing
<span class="nc" id="L746">            setBasicBuilding(false);</span>
<span class="nc bnc" id="L747" title="All 2 branches missed.">            int wheelDir = (e.getWheelRotation() &lt; 0) ? 1 : -1;</span>

<span class="nc bnc" id="L749" title="All 2 branches missed.">            if (e.isShiftDown()) {</span>
<span class="nc" id="L750">                int oldLevel = curHex.getTerrain(Terrains.BLDG_CF).getLevel();</span>
<span class="nc" id="L751">                int newLevel = Math.max(10, oldLevel + wheelDir*5);</span>
<span class="nc" id="L752">                curHex.addTerrain(TF.createTerrain(Terrains.BLDG_CF, newLevel));</span>
<span class="nc" id="L753">            }</span>
<span class="nc bnc" id="L754" title="All 2 branches missed.">            else if (e.isControlDown()) {</span>
<span class="nc" id="L755">                int oldLevel = curHex.getTerrain(Terrains.BUILDING).getLevel();</span>
<span class="nc" id="L756">                int newLevel = Math.max(1, Math.min(4, oldLevel + wheelDir)); // keep between 1 and 4</span>

<span class="nc bnc" id="L758" title="All 2 branches missed.">                if (newLevel != oldLevel) {</span>
<span class="nc" id="L759">                    ITerrain curTerr = curHex.getTerrain(Terrains.BUILDING);</span>
<span class="nc" id="L760">                    curHex.addTerrain(TF.createTerrain(Terrains.BUILDING, </span>
<span class="nc" id="L761">                            newLevel, curTerr.hasExitsSpecified(), curTerr.getExits()));</span>

                    // Set the CF to the appropriate standard value *IF* it is the appropriate value now,
                    // i.e. if the user has not manually set it to something else
<span class="nc" id="L765">                    int curCF = curHex.getTerrain(Terrains.BLDG_CF).getLevel();</span>
<span class="nc bnc" id="L766" title="All 2 branches missed.">                    if (curCF == Building.getDefaultCF(oldLevel)) </span>
<span class="nc" id="L767">                        curHex.addTerrain(TF.createTerrain(Terrains.BLDG_CF, Building.getDefaultCF(newLevel)));</span>
                }
<span class="nc" id="L769">            }</span>
            else {
<span class="nc" id="L771">                int oldLevel = curHex.getTerrain(Terrains.BLDG_ELEV).getLevel();</span>
<span class="nc" id="L772">                int newLevel = Math.max(1, oldLevel + wheelDir);</span>
<span class="nc" id="L773">                curHex.addTerrain(TF.createTerrain(Terrains.BLDG_ELEV, newLevel));</span>
            }

<span class="nc" id="L776">            refreshTerrainList();</span>
<span class="nc" id="L777">            repaintWorkingHex();</span>
<span class="nc" id="L778">        });</span>

        // Mouse wheel behaviour for the BRIDGE button
<span class="nc" id="L781">        buttonBr.addMouseWheelListener(e -&gt; {</span>
<span class="nc" id="L782">            setBasicBridge();</span>
<span class="nc bnc" id="L783" title="All 2 branches missed.">            int wheelDir = (e.getWheelRotation() &lt; 0) ? 1 : -1;</span>
            int terrainType;
            int newLevel;

<span class="nc bnc" id="L787" title="All 2 branches missed.">            if (e.isShiftDown()) {</span>
<span class="nc" id="L788">                terrainType = Terrains.BRIDGE_CF;</span>
<span class="nc" id="L789">                int oldLevel = curHex.getTerrain(terrainType).getLevel();</span>
<span class="nc" id="L790">                newLevel = Math.max(10, oldLevel + wheelDir*10);</span>
<span class="nc" id="L791">                curHex.addTerrain(TF.createTerrain(terrainType, newLevel));</span>
<span class="nc" id="L792">            }</span>
<span class="nc bnc" id="L793" title="All 2 branches missed.">            else if (e.isControlDown()) {</span>
<span class="nc" id="L794">                ITerrain terrain = curHex.getTerrain(Terrains.BRIDGE);</span>
<span class="nc" id="L795">                boolean hasExits = terrain.hasExitsSpecified();</span>
<span class="nc" id="L796">                int exits = terrain.getExits();</span>
<span class="nc" id="L797">                newLevel = Math.max(1, terrain.getLevel() + wheelDir);</span>
<span class="nc" id="L798">                curHex.addTerrain(TF.createTerrain(Terrains.BRIDGE, newLevel, hasExits, exits));</span>
<span class="nc" id="L799">            }</span>
            else {
<span class="nc" id="L801">                terrainType = Terrains.BRIDGE_ELEV;</span>
<span class="nc" id="L802">                int oldLevel = curHex.getTerrain(terrainType).getLevel();</span>
<span class="nc" id="L803">                newLevel = Math.max(0, oldLevel + wheelDir);</span>
<span class="nc" id="L804">                curHex.addTerrain(TF.createTerrain(terrainType, newLevel));</span>
            }

<span class="nc" id="L807">            refreshTerrainList();</span>
<span class="nc" id="L808">            repaintWorkingHex();</span>
<span class="nc" id="L809">        });</span>

        // Mouse wheel behaviour for the FUELTANKS button
<span class="nc" id="L812">        buttonFT.addMouseWheelListener(e -&gt; {</span>
<span class="nc" id="L813">            setBasicFuelTank();</span>
<span class="nc bnc" id="L814" title="All 2 branches missed.">            int wheelDir = (e.getWheelRotation() &lt; 0) ? 1 : -1;</span>
            int terrainType;
            int newLevel;

<span class="nc bnc" id="L818" title="All 2 branches missed.">            if (e.isShiftDown()) {</span>
<span class="nc" id="L819">                terrainType = Terrains.FUEL_TANK_CF;</span>
<span class="nc" id="L820">                int oldLevel = curHex.getTerrain(terrainType).getLevel();</span>
<span class="nc" id="L821">                newLevel = Math.max(10, oldLevel + wheelDir*10);</span>
<span class="nc" id="L822">            }</span>
<span class="nc bnc" id="L823" title="All 2 branches missed.">            else if (e.isControlDown()) {</span>
<span class="nc" id="L824">                terrainType = Terrains.FUEL_TANK_MAGN;</span>
<span class="nc" id="L825">                int oldLevel = curHex.getTerrain(terrainType).getLevel();</span>
<span class="nc" id="L826">                newLevel = Math.max(10, oldLevel + wheelDir*10);</span>
<span class="nc" id="L827">            }</span>
            else {
<span class="nc" id="L829">                terrainType = Terrains.FUEL_TANK_ELEV;</span>
<span class="nc" id="L830">                int oldLevel = curHex.getTerrain(terrainType).getLevel();</span>
<span class="nc" id="L831">                newLevel = Math.max(1, oldLevel + wheelDir);</span>
            }

<span class="nc" id="L834">            curHex.addTerrain(TF.createTerrain(terrainType, newLevel));</span>
<span class="nc" id="L835">            refreshTerrainList();</span>
<span class="nc" id="L836">            repaintWorkingHex();</span>
<span class="nc" id="L837">        });</span>

<span class="nc" id="L839">        JPanel terrainButtonPanel = new JPanel(new GridLayout(0, 4, 2, 2));</span>
<span class="nc" id="L840">        addManyButtons(terrainButtonPanel, terrainButtons);</span>

<span class="nc" id="L842">        JPanel brushButtonPanel = new JPanel(new GridLayout(0, 3, 2, 2));</span>
<span class="nc" id="L843">        addManyTButtons(brushButtonPanel, brushButtons);</span>
<span class="nc" id="L844">        buttonBrush1.setSelected(true);</span>

<span class="nc" id="L846">        JPanel undoButtonPanel = new JPanel(new GridLayout(1, 2, 2, 2));</span>
<span class="nc" id="L847">        addManyButtons(undoButtonPanel, buttonUndo, buttonRedo);</span>

        // Hex Elevation Control
<span class="nc" id="L850">        texElev = new EditorTextField(&quot;0&quot;, 3); //$NON-NLS-1$</span>
<span class="nc" id="L851">        texElev.addActionListener(this);</span>
<span class="nc" id="L852">        texElev.getDocument().addDocumentListener(this);</span>

<span class="nc" id="L854">        butElevUp = prepareButton(&quot;ButtonHexUP&quot;, &quot;Raise Hex Elevation&quot;, null); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L855">        butElevUp.setName(&quot;butElevUp&quot;);</span>
<span class="nc" id="L856">        butElevUp.setToolTipText(Messages.getString(&quot;BoardEditor.butElevUp.toolTipText&quot;));</span>

<span class="nc" id="L858">        butElevDown = prepareButton(&quot;ButtonHexDN&quot;, &quot;Lower Hex Elevation&quot;, null); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L859">        butElevDown.setName(&quot;butElevDown&quot;);</span>
<span class="nc" id="L860">        butElevDown.setToolTipText(Messages.getString(&quot;BoardEditor.butElevDown.toolTipText&quot;));</span>

        // Terrain List
<span class="nc" id="L863">        lisTerrainRenderer = new ComboboxToolTipRenderer();</span>
<span class="nc" id="L864">        lisTerrain = new JList&lt;&gt;(new DefaultListModel&lt;&gt;());</span>
<span class="nc" id="L865">        lisTerrain.addListSelectionListener(this);</span>
<span class="nc" id="L866">        lisTerrain.setCellRenderer(lisTerrainRenderer);</span>
<span class="nc" id="L867">        lisTerrain.setVisibleRowCount(6);</span>
<span class="nc" id="L868">        lisTerrain.setFixedCellWidth(180);</span>
<span class="nc" id="L869">        refreshTerrainList();</span>

        // Terrain List, Preview, Delete
<span class="nc" id="L872">        JPanel panlisHex = new JPanel(new FlowLayout(FlowLayout.LEFT,4,4));</span>
<span class="nc" id="L873">        butDelTerrain = prepareButton(&quot;buttonRemT&quot;, &quot;Delete Terrain&quot;, null);</span>
<span class="nc" id="L874">        butDelTerrain.setEnabled(false);</span>
<span class="nc" id="L875">        canHex = new HexCanvas();</span>
<span class="nc" id="L876">        panlisHex.add(butDelTerrain);</span>
<span class="nc" id="L877">        panlisHex.add(new JScrollPane(lisTerrain));</span>
<span class="nc" id="L878">        panlisHex.add(canHex);</span>

        // Build the terrain list for the chooser ComboBox,
        // excluding terrains that are handled internally
<span class="nc" id="L882">        ArrayList&lt;TerrainHelper&gt; tList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L883" title="All 2 branches missed.">        for (int i = 1; i &lt; Terrains.SIZE; i++) {</span>
<span class="nc bnc" id="L884" title="All 2 branches missed.">            if (!Terrains.AUTOMATIC.contains(i)) {</span>
<span class="nc" id="L885">                tList.add(new TerrainHelper(i));</span>
            }
        }
<span class="nc" id="L888">        TerrainHelper[] terrains = new TerrainHelper[tList.size()]; </span>
<span class="nc" id="L889">        tList.toArray(terrains);</span>
<span class="nc" id="L890">        Arrays.sort(terrains);</span>
<span class="nc" id="L891">        texTerrainLevel = new EditorTextField(&quot;0&quot;, 2, 0); //$NON-NLS-1$</span>
<span class="nc" id="L892">        texTerrainLevel.addActionListener(this);</span>
<span class="nc" id="L893">        texTerrainLevel.getDocument().addDocumentListener(this);</span>
<span class="nc" id="L894">        choTerrainType = new JComboBox&lt;&gt;(terrains);</span>
<span class="nc" id="L895">        ComboboxToolTipRenderer renderer = new ComboboxToolTipRenderer();</span>
<span class="nc" id="L896">        renderer.setTerrains(terrains);</span>
<span class="nc" id="L897">        choTerrainType.setRenderer(renderer);</span>
        // Selecting a terrain type in the Dropdown should deselect
        // all in the terrain overview list except when selected from there
<span class="nc bnc" id="L900" title="All 2 branches missed.">        choTerrainType.addActionListener(e -&gt; { if (!terrListBlocker) lisTerrain.clearSelection(); });</span>
<span class="nc" id="L901">        choTerrainType.setFont(fontComboTerr);</span>
<span class="nc" id="L902">        butAddTerrain = new JButton(Messages.getString(&quot;BoardEditor.butAddTerrain&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L903">        butTerrUp = prepareButton(&quot;ButtonTLUP&quot;, &quot;Increase Terrain Level&quot;, null); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L904">        butTerrDown = prepareButton(&quot;ButtonTLDN&quot;, &quot;Decrease Terrain Level&quot;, null); //$NON-NLS-1$ //$NON-NLS-2$</span>

        // Minimap Toggle
<span class="nc" id="L907">        butMiniMap = new JButton(Messages.getString(&quot;BoardEditor.butMiniMap&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L908">        butMiniMap.setActionCommand(ClientGUI.VIEW_MINI_MAP);</span>

        // Exits
<span class="nc" id="L911">        cheTerrExitSpecified = new JCheckBox(Messages.getString(&quot;BoardEditor.cheTerrExitSpecified&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L912">        cheTerrExitSpecified.addActionListener(e -&gt; {</span>
<span class="nc" id="L913">            noTextFieldUpdate = true;</span>
<span class="nc" id="L914">            updateWhenSelected();</span>
<span class="nc" id="L915">            noTextFieldUpdate = false;</span>
<span class="nc" id="L916">        });</span>
<span class="nc" id="L917">        butTerrExits = prepareButton(&quot;ButtonExitA&quot;, Messages.getString(&quot;BoardEditor.butTerrExits&quot;), null); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L918">        texTerrExits = new EditorTextField(&quot;0&quot;, 2, 0); //$NON-NLS-1$</span>
<span class="nc" id="L919">        texTerrExits.addActionListener(this);</span>
<span class="nc" id="L920">        texTerrExits.getDocument().addDocumentListener(this);</span>
<span class="nc" id="L921">        butExitUp = prepareButton(&quot;ButtonEXUP&quot;, &quot;Increase Exit / Gfx&quot;, null); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L922">        butExitDown = prepareButton(&quot;ButtonEXDN&quot;, &quot;Decrease Exit / Gfx&quot;, null); //$NON-NLS-1$ //$NON-NLS-2$</span>

        // Arrows and text fields for type and exits
<span class="nc" id="L925">        JPanel panUP = new JPanel(new GridLayout(1,0,4,4));</span>
<span class="nc" id="L926">        panUP.add(butTerrUp);</span>
<span class="nc" id="L927">        panUP.add(butExitUp);</span>
<span class="nc" id="L928">        panUP.add(butTerrExits);</span>
<span class="nc" id="L929">        JPanel panTex = new JPanel(new GridLayout(1,0,4,4));</span>
<span class="nc" id="L930">        panTex.add(texTerrainLevel);</span>
<span class="nc" id="L931">        panTex.add(texTerrExits);</span>
<span class="nc" id="L932">        panTex.add(cheTerrExitSpecified);</span>
<span class="nc" id="L933">        JPanel panDN = new JPanel(new GridLayout(1,0,4,4));</span>
<span class="nc" id="L934">        panDN.add(butTerrDown);</span>
<span class="nc" id="L935">        panDN.add(butExitDown);</span>
<span class="nc" id="L936">        panDN.add(Box.createHorizontalStrut(5));</span>

        // Auto Exits to Pavement
<span class="nc" id="L939">        cheRoadsAutoExit = new JCheckBox(Messages.getString(&quot;BoardEditor.cheRoadsAutoExit&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L940">        cheRoadsAutoExit.addItemListener(this);</span>
<span class="nc" id="L941">        cheRoadsAutoExit.setSelected(true);</span>

        // Theme
<span class="nc" id="L944">        JPanel panTheme = new JPanel(new FlowLayout(FlowLayout.LEFT, 4, 4));</span>
<span class="nc" id="L945">        JLabel labTheme = new JLabel(Messages.getString(&quot;BoardEditor.labTheme&quot;), SwingConstants.LEFT); //$NON-NLS-1$</span>
<span class="nc" id="L946">        choTheme = new JComboBox&lt;&gt;();</span>
<span class="nc" id="L947">        TilesetManager tileMan = bv.getTilesetManager();</span>
<span class="nc" id="L948">        Set&lt;String&gt; themes = tileMan.getThemes();</span>
<span class="nc bnc" id="L949" title="All 2 branches missed.">        for (String s: themes) choTheme.addItem(s);</span>
<span class="nc" id="L950">        choTheme.addActionListener(this);</span>
<span class="nc" id="L951">        panTheme.add(labTheme);</span>
<span class="nc" id="L952">        panTheme.add(choTheme);</span>

        // The hex settings panel (elevation, theme)
<span class="nc" id="L955">        JPanel panelHexSettings = new JPanel();</span>
<span class="nc" id="L956">        panelHexSettings.setBorder(new TitledBorder(new LineBorder(Color.BLUE, 1), &quot;Hex Settings&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L957">        panelHexSettings.add(butElevUp);</span>
<span class="nc" id="L958">        panelHexSettings.add(texElev);</span>
<span class="nc" id="L959">        panelHexSettings.add(butElevDown);</span>
<span class="nc" id="L960">        panelHexSettings.add(panTheme);</span>

        // The terrain settings panel (type, level, exits)
<span class="nc" id="L963">        JPanel panelTerrSettings = new JPanel(new GridLayout(0, 2, 4, 4));</span>
<span class="nc" id="L964">        panelTerrSettings.setBorder(new TitledBorder(new LineBorder(Color.BLUE, 1), &quot;Terrain Settings&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L965">        panelTerrSettings.add(Box.createVerticalStrut(5));</span>
<span class="nc" id="L966">        panelTerrSettings.add(panUP);</span>

<span class="nc" id="L968">        panelTerrSettings.add(choTerrainType);</span>
<span class="nc" id="L969">        panelTerrSettings.add(panTex);</span>

<span class="nc" id="L971">        panelTerrSettings.add(butAddTerrain);</span>
<span class="nc" id="L972">        panelTerrSettings.add(panDN);</span>

        // The board settings panel (Auto exit roads to pavement)
<span class="nc" id="L975">        JPanel panelBoardSettings = new JPanel();</span>
<span class="nc" id="L976">        panelBoardSettings.setBorder(new TitledBorder(new LineBorder(Color.BLUE, 1), &quot;Board Settings&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L977">        panelBoardSettings.add(cheRoadsAutoExit);</span>

        // Board Buttons (Save, Load...)
<span class="nc" id="L980">        butBoardNew = new JButton(Messages.getString(&quot;BoardEditor.butBoardNew&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L981">        butBoardNew.setActionCommand(ClientGUI.FILE_BOARD_NEW);</span>

<span class="nc" id="L983">        butExpandMap = new JButton(Messages.getString(&quot;BoardEditor.butExpandMap&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L984">        butExpandMap.setActionCommand(FILE_BOARD_EDITOR_EXPAND);</span>

<span class="nc" id="L986">        butBoardOpen = new JButton(Messages.getString(&quot;BoardEditor.butBoardOpen&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L987">        butBoardOpen.setActionCommand(ClientGUI.FILE_BOARD_OPEN);</span>

<span class="nc" id="L989">        butBoardSave = new JButton(Messages.getString(&quot;BoardEditor.butBoardSave&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L990">        butBoardSave.setActionCommand(ClientGUI.FILE_BOARD_SAVE);</span>

<span class="nc" id="L992">        butBoardSaveAs = new JButton(Messages.getString(&quot;BoardEditor.butBoardSaveAs&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L993">        butBoardSaveAs.setActionCommand(ClientGUI.FILE_BOARD_SAVE_AS);</span>

<span class="nc" id="L995">        butBoardSaveAsImage = new JButton(Messages.getString(&quot;BoardEditor.butBoardSaveAsImage&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L996">        butBoardSaveAsImage.setActionCommand(ClientGUI.FILE_BOARD_SAVE_AS_IMAGE);</span>

<span class="nc" id="L998">        butBoardValidate = new JButton(Messages.getString(&quot;BoardEditor.butBoardValidate&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L999">        butBoardValidate.setActionCommand(FILE_BOARD_EDITOR_VALIDATE);</span>
        
<span class="nc" id="L1001">        butSourceFile = new JButton(Messages.getString(&quot;BoardEditor.butSourceFile&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1002">        butSourceFile.setActionCommand(FILE_SOURCEFILE);</span>

<span class="nc" id="L1004">        addManyActionListeners(butBoardValidate, butBoardSaveAsImage, butBoardSaveAs, butBoardSave);</span>
<span class="nc" id="L1005">        addManyActionListeners(butBoardOpen, butExpandMap, butBoardNew, butMiniMap);</span>
<span class="nc" id="L1006">        addManyActionListeners(butDelTerrain, butAddTerrain, butSourceFile);</span>
        

<span class="nc" id="L1009">        JPanel panButtons = new JPanel(new GridLayout(4, 2, 2, 2));</span>
<span class="nc" id="L1010">        addManyButtons(panButtons, butBoardNew, butBoardSave, butBoardOpen,</span>
                butExpandMap, butBoardSaveAs, butBoardSaveAsImage);
<span class="nc" id="L1012">        panButtons.add(butBoardValidate);</span>
<span class="nc" id="L1013">        panButtons.add(butMiniMap);</span>
<span class="nc bnc" id="L1014" title="All 2 branches missed.">        if (Desktop.isDesktopSupported()) {</span>
<span class="nc" id="L1015">            panButtons.add(butSourceFile);</span>
        }

        // ------------------
        // Arrange everything
        //
<span class="nc" id="L1021">        setLayout(new GridBagLayout());</span>
<span class="nc" id="L1022">        GridBagConstraints cfullLine = new GridBagConstraints();</span>
<span class="nc" id="L1023">        GridBagConstraints cYFiller = new GridBagConstraints();</span>

<span class="nc" id="L1025">        cfullLine.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L1026">        cfullLine.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L1027">        cfullLine.gridx = 0;</span>
<span class="nc" id="L1028">        cfullLine.insets = new Insets(4, 4, 1, 1);</span>

<span class="nc" id="L1030">        cYFiller.fill = GridBagConstraints.HORIZONTAL;</span>
<span class="nc" id="L1031">        cYFiller.gridwidth = GridBagConstraints.REMAINDER;</span>
<span class="nc" id="L1032">        cYFiller.gridx = 0;</span>
<span class="nc" id="L1033">        cYFiller.weighty = 1;</span>
<span class="nc" id="L1034">        cYFiller.insets = new Insets(4, 4, 1, 1);</span>

        // Easy Access Terrain Buttons
<span class="nc" id="L1037">        add(genHelpText1, cfullLine);</span>
<span class="nc" id="L1038">        add(terrainButtonHelp, cfullLine);</span>
<span class="nc" id="L1039">        add(terrainButtonPanel, cfullLine);</span>
<span class="nc" id="L1040">        add(brushButtonPanel, cfullLine);</span>
<span class="nc" id="L1041">        add(new JLabel(&quot;&quot;), cYFiller); //$NON-NLS-1$</span>
<span class="nc" id="L1042">        add(undoButtonPanel, cfullLine);</span>
<span class="nc" id="L1043">        add(new JLabel(&quot;&quot;), cYFiller); //$NON-NLS-1$</span>

        // Terrain and Hex Control
<span class="nc" id="L1046">        add(panelBoardSettings, cfullLine);</span>
<span class="nc" id="L1047">        add(panelHexSettings, cfullLine);</span>
<span class="nc" id="L1048">        add(panelTerrSettings, cfullLine);</span>

        // Terrain List and Preview Hex
<span class="nc" id="L1051">        add(panlisHex, cfullLine);</span>

        // Board buttons
<span class="nc" id="L1054">        add(panButtons, cfullLine);</span>

<span class="nc" id="L1056">        minimapW = new JDialog(frame, Messages</span>
<span class="nc" id="L1057">                .getString(&quot;BoardEditor.minimapW&quot;), false); //$NON-NLS-1$</span>
<span class="nc" id="L1058">        minimapW.setLocation(GUIPreferences.getInstance().getMinimapPosX(),</span>
<span class="nc" id="L1059">                             GUIPreferences.getInstance().getMinimapPosY());</span>
        try {
<span class="nc" id="L1061">            minimap = new MiniMap(minimapW, game, bv);</span>
<span class="nc" id="L1062">        } catch (IOException e) {</span>
<span class="nc" id="L1063">            JOptionPane</span>
<span class="nc" id="L1064">                    .showMessageDialog(</span>
                            frame,
                            Messages
<span class="nc" id="L1067">                                    .getString(&quot;BoardEditor.CouldNotInitialiseMinimap&quot;) + e,</span>
<span class="nc" id="L1068">                            Messages.getString(&quot;BoardEditor.FatalError&quot;), JOptionPane.ERROR_MESSAGE); //$NON-NLS-1$</span>
            //$NON-NLS-2$
<span class="nc" id="L1070">            frame.dispose();</span>
<span class="nc" id="L1071">        }</span>
<span class="nc" id="L1072">        minimapW.add(minimap);</span>
<span class="nc" id="L1073">        minimapW.setVisible(true);</span>
<span class="nc" id="L1074">    }</span>
    
    /**
     * Returns coords that the active brush will paint on;
     * returns only coords that are valid, i.e. on the board
     */
    private LinkedList&lt;Coords&gt; getBrushCoords(Coords center) {
<span class="nc" id="L1081">        LinkedList&lt;Coords&gt; coords = new LinkedList&lt;&gt;();</span>
        // The center hex itself is always part of the brush
<span class="nc" id="L1083">        coords.add(center);</span>
        // Add surrounding hexes for the big brush
<span class="nc bnc" id="L1085" title="All 2 branches missed.">        if (brushSize &gt; 1) {</span>
<span class="nc bnc" id="L1086" title="All 2 branches missed.">            for (int dir: allDirections) </span>
<span class="nc" id="L1087">                coords.add(center.translated(dir));</span>
        } 
        // Add the surrounding hexes, radius 2 for the very big brush
<span class="nc bnc" id="L1090" title="All 2 branches missed.">        if (brushSize &gt; 2) {</span>
<span class="nc bnc" id="L1091" title="All 2 branches missed.">            for (int dir: allDirections) {</span>
<span class="nc" id="L1092">                Coords candC = center.translated(dir, 2);</span>
<span class="nc" id="L1093">                coords.add(candC);</span>
<span class="nc" id="L1094">                coords.add(candC.translated((dir+2)%6));</span>
            }
        } 
        // Remove coords that are not on the board
<span class="nc" id="L1098">        LinkedList&lt;Coords&gt; finalCoords = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L1099" title="All 4 branches missed.">        for (Coords c: coords) if (board.contains(c)) finalCoords.add(c);</span>
<span class="nc" id="L1100">        return finalCoords;</span>
    }

    // Helper to shorten the code
    private void addManyActionListeners(JButton... buttons) {
<span class="nc bnc" id="L1105" title="All 2 branches missed.">        for (JButton button: buttons) button.addActionListener(this);</span>
<span class="nc" id="L1106">    }</span>
    
    // Helper to shorten the code
    private void addManyButtons(JPanel panel, JButton... buttons) {
<span class="nc bnc" id="L1110" title="All 2 branches missed.">        for (JButton button: buttons) panel.add(button);</span>
<span class="nc" id="L1111">    }</span>
    
    // Helper to shorten the code
    private void addManyButtons(JPanel panel, ArrayList&lt;JButton&gt; buttonList) {
<span class="nc bnc" id="L1115" title="All 2 branches missed.">        for (JButton button: buttonList) panel.add(button);</span>
<span class="nc" id="L1116">    }</span>
    
    // Helper to shorten the code
    private void addManyTButtons(JPanel panel, ArrayList&lt;JToggleButton&gt; buttonList) {
<span class="nc bnc" id="L1120" title="All 2 branches missed.">        for (JToggleButton button: buttonList) panel.add(button);</span>
<span class="nc" id="L1121">    }</span>
    
    /**
     * Save the hex at c into the current undo Set
     */
    private void saveToUndo(Coords c) {
        // Create a new set of hexes to save for undoing
        // This will be filled as long as the mouse is dragged
<span class="nc bnc" id="L1129" title="All 2 branches missed.">        if (currentUndoSet == null) {</span>
<span class="nc" id="L1130">            currentUndoSet = new HashSet&lt;&gt;();</span>
<span class="nc" id="L1131">            currentUndoCoords = new HashSet&lt;&gt;();</span>
        }
<span class="nc bnc" id="L1133" title="All 2 branches missed.">        if (!currentUndoCoords.contains(c)) {</span>
<span class="nc" id="L1134">            IHex hex = board.getHex(c).duplicate();</span>
            // Newly drawn board hexes do not know their Coords
<span class="nc" id="L1136">            hex.setCoords(c);</span>
<span class="nc" id="L1137">            currentUndoSet.add(hex);</span>
<span class="nc" id="L1138">            currentUndoCoords.add(c);</span>
        }
<span class="nc" id="L1140">    }</span>
    
    private void resetUndo() {
<span class="nc" id="L1143">        currentUndoSet = null;</span>
<span class="nc" id="L1144">        currentUndoCoords = null;</span>
<span class="nc" id="L1145">        undoStack.clear();</span>
<span class="nc" id="L1146">        redoStack.clear();</span>
<span class="nc" id="L1147">        buttonUndo.setEnabled(false);</span>
<span class="nc" id="L1148">        buttonRedo.setEnabled(false);</span>
<span class="nc" id="L1149">    }</span>
    
    /**
     * Changes the hex level at Coords c. Expects c 
     * to be on the board.
     */
    private void relevelHex(Coords c) {
<span class="nc" id="L1156">        IHex newHex = board.getHex(c).duplicate(); </span>
<span class="nc" id="L1157">        newHex.setLevel(hexLeveltoDraw);</span>
<span class="nc" id="L1158">        board.resetStoredElevation();</span>
<span class="nc" id="L1159">        board.setHex(c, newHex);</span>
        
<span class="nc" id="L1161">    }</span>

    /**
     * Apply the current Hex to the Board at the specified location.
     */
    void paintHex(Coords c) {
<span class="nc" id="L1167">        board.resetStoredElevation();</span>
<span class="nc" id="L1168">        board.setHex(c, curHex.duplicate());</span>
<span class="nc" id="L1169">    } </span>
    
    /**
     * Apply the current Hex to the Board at the specified location.
     */
    public void retextureHex(Coords c) {
<span class="nc bnc" id="L1175" title="All 2 branches missed.">        if (board.contains(c)) {</span>
<span class="nc" id="L1176">            IHex newHex = curHex.duplicate();</span>
<span class="nc" id="L1177">            newHex.setLevel(board.getHex(c).getLevel());</span>
<span class="nc" id="L1178">            board.resetStoredElevation();</span>
<span class="nc" id="L1179">            board.setHex(c, newHex);</span>
        }
<span class="nc" id="L1181">    }</span>

    /**
     * Apply the current Hex to the Board at the specified location.
     */
    public void addToHex(Coords c) {
<span class="nc bnc" id="L1187" title="All 2 branches missed.">        if (board.contains(c)) {</span>
<span class="nc" id="L1188">            IHex newHex = curHex.duplicate();</span>
<span class="nc" id="L1189">            IHex oldHex = board.getHex(c);</span>
<span class="nc" id="L1190">            newHex.setLevel(oldHex.getLevel());</span>
<span class="nc" id="L1191">            int[] terrainTypes = oldHex.getTerrainTypes();</span>
<span class="nc bnc" id="L1192" title="All 2 branches missed.">            for (int terrainID : terrainTypes) {</span>
<span class="nc bnc" id="L1193" title="All 4 branches missed.">                if (!newHex.containsTerrain(terrainID) &amp;&amp; oldHex.containsTerrain(terrainID)) {</span>
<span class="nc" id="L1194">                    newHex.addTerrain(oldHex.getTerrain(terrainID));</span>
                }
            }
<span class="nc" id="L1197">            board.resetStoredElevation();</span>
<span class="nc" id="L1198">            board.setHex(c, newHex);</span>
        }
<span class="nc" id="L1200">    }</span>

    /**
     * Sets the working hex to &lt;code&gt;hex&lt;/code&gt;;
     * used for mouse ALT-click (eyedropper function).
     *
     * @param hex hex to set.
     */
    void setCurrentHex(IHex hex) {
<span class="nc" id="L1209">        curHex = hex.duplicate();</span>
<span class="nc" id="L1210">        texElev.setText(Integer.toString(curHex.getLevel()));</span>
<span class="nc" id="L1211">        refreshTerrainList();</span>
<span class="nc bnc" id="L1212" title="All 2 branches missed.">        if (lisTerrain.getModel().getSize() &gt; 0) {</span>
<span class="nc" id="L1213">            lisTerrain.setSelectedIndex(0);</span>
<span class="nc" id="L1214">            refreshTerrainFromList();</span>
        }
<span class="nc" id="L1216">        choTheme.setSelectedItem(curHex.getTheme());</span>
<span class="nc" id="L1217">        repaint();</span>
<span class="nc" id="L1218">        repaintWorkingHex();</span>
<span class="nc" id="L1219">    }</span>

    private void repaintWorkingHex() {
<span class="nc bnc" id="L1222" title="All 2 branches missed.">        if (curHex != null) {</span>
<span class="nc" id="L1223">            TilesetManager tm = bv.getTilesetManager();</span>
<span class="nc" id="L1224">            tm.clearHex(curHex);</span>
        }
<span class="nc" id="L1226">        canHex.repaint();</span>
<span class="nc" id="L1227">        lastClicked = null;</span>
<span class="nc" id="L1228">    }</span>

    /**
     * Refreshes the terrain list to match the current hex
     */
    private void refreshTerrainList() {
        
<span class="nc" id="L1235">        ((DefaultListModel&lt;TerrainTypeHelper&gt;)lisTerrain.getModel()).removeAllElements();</span>
<span class="nc" id="L1236">        lisTerrainRenderer.setTerrainTypes(null);</span>
<span class="nc" id="L1237">        int[] terrainTypes = curHex.getTerrainTypes();</span>
<span class="nc" id="L1238">        List&lt;TerrainTypeHelper&gt; types = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1239" title="All 2 branches missed.">        for (int terrainType : terrainTypes) {</span>
<span class="nc" id="L1240">            ITerrain terrain = curHex.getTerrain(terrainType);</span>
<span class="nc bnc" id="L1241" title="All 4 branches missed.">            if (terrain != null &amp;&amp; !Terrains.AUTOMATIC.contains(terrainType)) {</span>
<span class="nc" id="L1242">                TerrainTypeHelper tth = new TerrainTypeHelper(terrain);</span>
<span class="nc" id="L1243">                types.add(tth);</span>
            }
        }
<span class="nc" id="L1246">        Collections.sort(types);</span>
<span class="nc bnc" id="L1247" title="All 2 branches missed.">        for (TerrainTypeHelper tth : types) {</span>
<span class="nc" id="L1248">            ((DefaultListModel&lt;TerrainTypeHelper&gt;) lisTerrain.getModel()).addElement(tth);</span>
<span class="nc" id="L1249">        }</span>
<span class="nc" id="L1250">        lisTerrainRenderer.setTerrainTypes(types);</span>
<span class="nc" id="L1251">    }</span>

    /**
     * Returns a new instance of the terrain that is currently entered in the
     * terrain input fields
     */
    private ITerrain enteredTerrain() {
<span class="nc" id="L1258">        int type = ((TerrainHelper)choTerrainType.getSelectedItem()).getTerrainType();</span>
<span class="nc" id="L1259">        int level = texTerrainLevel.getNumber();  </span>
        // For the terrain subtypes that only add to a main terrain type exits make no
        // sense at all. Therefore simply do not add them
<span class="nc bnc" id="L1262" title="All 22 branches missed.">        if ((type == Terrains.BLDG_ARMOR) || (type == Terrains.BLDG_CF) </span>
                || (type == Terrains.BLDG_ELEV) || (type == Terrains.BLDG_CLASS)  
                || (type == Terrains.BLDG_BASE_COLLAPSED) || (type == Terrains.BLDG_BASEMENT_TYPE)
                || (type == Terrains.BRIDGE_CF) || (type == Terrains.BRIDGE_ELEV)
                || (type == Terrains.FUEL_TANK_CF) || (type == Terrains.FUEL_TANK_ELEV)
                || (type == Terrains.FUEL_TANK_MAGN)) 
        {
<span class="nc" id="L1269">            return Terrains.getTerrainFactory().createTerrain(type, level, false, 0);</span>
        } else {
<span class="nc" id="L1271">            boolean exitsSpecified = cheTerrExitSpecified.isSelected();</span>
<span class="nc" id="L1272">            int exits = texTerrExits.getNumber();</span>
<span class="nc" id="L1273">            return Terrains.getTerrainFactory().createTerrain(type, level, exitsSpecified, exits);</span>
        }
    }

    /**
     * Add or set the terrain to the list based on the fields.
     */
    private void addSetTerrain() {
<span class="nc" id="L1281">        ITerrain toAdd = enteredTerrain();</span>
<span class="nc bnc" id="L1282" title="All 2 branches missed.">        if (((toAdd.getType() == Terrains.BLDG_ELEV) </span>
<span class="nc bnc" id="L1283" title="All 2 branches missed.">                || (toAdd.getType() == Terrains.BRIDGE_ELEV))</span>
<span class="nc bnc" id="L1284" title="All 2 branches missed.">                &amp;&amp; toAdd.getLevel() &lt; 0) {</span>
<span class="nc" id="L1285">            texTerrainLevel.setNumber(0);</span>
<span class="nc" id="L1286">            JOptionPane.showMessageDialog(frame,</span>
<span class="nc" id="L1287">                    Messages.getString(&quot;BoardEditor.BridgeBuildingElevError&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L1288">                    Messages.getString(&quot;BoardEditor.invalidTerrainTitle&quot;), //$NON-NLS-1$ </span>
                    JOptionPane.ERROR_MESSAGE);
<span class="nc" id="L1290">            return;</span>
        }
<span class="nc" id="L1292">        curHex.addTerrain(toAdd);</span>
<span class="nc" id="L1293">        int formerSelection = lisTerrain.getSelectedIndex();</span>
<span class="nc" id="L1294">        noTextFieldUpdate = true;</span>
<span class="nc" id="L1295">        refreshTerrainList();</span>
<span class="nc" id="L1296">        lisTerrain.setSelectedIndex(formerSelection);</span>
<span class="nc" id="L1297">        lisTerrain.ensureIndexIsVisible(formerSelection);</span>
<span class="nc" id="L1298">        repaintWorkingHex();</span>
<span class="nc" id="L1299">        noTextFieldUpdate = false;</span>
<span class="nc" id="L1300">    }</span>
    
    /**
     * Add to the terrain from one of the easy access buttons
     */
    private void addSetTerrainEasy(int type, int level) {
<span class="nc" id="L1306">        boolean exitsSpecified = cheTerrExitSpecified.isSelected();</span>
<span class="nc" id="L1307">        int exits = texTerrExits.getNumber();</span>
<span class="nc" id="L1308">        ITerrain toAdd = Terrains.getTerrainFactory().createTerrain(type, level, exitsSpecified, exits);</span>
<span class="nc" id="L1309">        curHex.addTerrain(toAdd);</span>
<span class="nc" id="L1310">        TerrainTypeHelper toSelect = new TerrainTypeHelper(toAdd);</span>
<span class="nc" id="L1311">        refreshTerrainList();</span>
<span class="nc" id="L1312">        lisTerrain.setSelectedValue(toSelect, true);</span>
<span class="nc" id="L1313">        repaintWorkingHex();</span>
<span class="nc" id="L1314">    }</span>
    
    /**
     * Sets valid basic Fuel Tank values as far as they are missing
     */
    private void setBasicFuelTank() {
        // There is only fuel_tank:1, so this can be set
<span class="nc" id="L1321">        curHex.addTerrain(TF.createTerrain(Terrains.FUEL_TANK, 1, true, 0));</span>

<span class="nc bnc" id="L1323" title="All 2 branches missed.">        if (!curHex.containsTerrain(Terrains.FUEL_TANK_CF)) </span>
<span class="nc" id="L1324">         curHex.addTerrain(TF.createTerrain(Terrains.FUEL_TANK_CF, 40, false, 0));</span>
        
<span class="nc bnc" id="L1326" title="All 2 branches missed.">        if (!curHex.containsTerrain(Terrains.FUEL_TANK_ELEV)) </span>
<span class="nc" id="L1327">            curHex.addTerrain(TF.createTerrain(Terrains.FUEL_TANK_ELEV, 1, false, 0));</span>
        
<span class="nc bnc" id="L1329" title="All 2 branches missed.">        if (!curHex.containsTerrain(Terrains.FUEL_TANK_MAGN)) </span>
<span class="nc" id="L1330">            curHex.addTerrain(TF.createTerrain(Terrains.FUEL_TANK_MAGN, 100, false, 0));</span>
        
<span class="nc" id="L1332">        refreshTerrainList();</span>
<span class="nc" id="L1333">        repaintWorkingHex();</span>
<span class="nc" id="L1334">    }</span>
    
    /**
     * Sets valid basic bridge values as far as they are missing
     */
    private void setBasicBridge() {
<span class="nc bnc" id="L1340" title="All 2 branches missed.">        if (!curHex.containsTerrain(Terrains.BRIDGE_CF)) </span>
<span class="nc" id="L1341">         curHex.addTerrain(TF.createTerrain(Terrains.BRIDGE_CF, 40, false, 0));</span>
        
<span class="nc bnc" id="L1343" title="All 2 branches missed.">        if (!curHex.containsTerrain(Terrains.BRIDGE_ELEV)) </span>
<span class="nc" id="L1344">            curHex.addTerrain(TF.createTerrain(Terrains.BRIDGE_ELEV, 1, false, 0));</span>
        
<span class="nc bnc" id="L1346" title="All 2 branches missed.">        if (!curHex.containsTerrain(Terrains.BRIDGE)) </span>
<span class="nc" id="L1347">            curHex.addTerrain(TF.createTerrain(Terrains.BRIDGE, 1, false, 0));</span>
        
<span class="nc" id="L1349">        refreshTerrainList();</span>
<span class="nc" id="L1350">        repaintWorkingHex();</span>
<span class="nc" id="L1351">    }</span>
    
    /**
     * Sets valid basic Building values as far as they are missing
     */
    private void setBasicBuilding(boolean ALT_Held) {
<span class="nc bnc" id="L1357" title="All 2 branches missed.">        if (!curHex.containsTerrain(Terrains.BLDG_CF)) </span>
<span class="nc" id="L1358">            curHex.addTerrain(TF.createTerrain(Terrains.BLDG_CF, 15, false, 0));</span>

<span class="nc bnc" id="L1360" title="All 2 branches missed.">        if (!curHex.containsTerrain(Terrains.BLDG_ELEV)) </span>
<span class="nc" id="L1361">            curHex.addTerrain(TF.createTerrain(Terrains.BLDG_ELEV, 1, false, 0));</span>

<span class="nc bnc" id="L1363" title="All 2 branches missed.">        if (!curHex.containsTerrain(Terrains.BUILDING))</span>
<span class="nc" id="L1364">            curHex.addTerrain(TF.createTerrain(Terrains.BUILDING, 1, ALT_Held, 0));</span>

        // When clicked with ALT and a Building is present, only toggle the exits
<span class="nc bnc" id="L1367" title="All 4 branches missed.">        if (curHex.containsTerrain(Terrains.BUILDING) &amp;&amp; ALT_Held) {</span>
<span class="nc" id="L1368">            ITerrain curTerr = curHex.getTerrain(Terrains.BUILDING);</span>
<span class="nc" id="L1369">            curHex.addTerrain(TF.createTerrain(Terrains.BUILDING, </span>
<span class="nc bnc" id="L1370" title="All 2 branches missed.">                    curTerr.getLevel(), !curTerr.hasExitsSpecified(), curTerr.getExits()));</span>
        }

<span class="nc" id="L1373">        refreshTerrainList();</span>
<span class="nc" id="L1374">        repaintWorkingHex();</span>
<span class="nc" id="L1375">    }</span>

    /**
     * Set all the appropriate terrain fields to match the currently selected
     * terrain in the list.
     */
    private void refreshTerrainFromList() {
<span class="nc bnc" id="L1382" title="All 2 branches missed.">        if (lisTerrain.isSelectionEmpty()) {</span>
<span class="nc" id="L1383">            butDelTerrain.setEnabled(false);</span>
        } else {
<span class="nc" id="L1385">            butDelTerrain.setEnabled(true);</span>
<span class="nc" id="L1386">            ITerrain terrain = Terrains.getTerrainFactory().createTerrain(</span>
<span class="nc" id="L1387">                    lisTerrain.getSelectedValue().getTerrain());</span>
<span class="nc" id="L1388">            terrain = curHex.getTerrain(terrain.getType());</span>
<span class="nc" id="L1389">            TerrainHelper terrainHelper = new TerrainHelper(terrain.getType());</span>
<span class="nc" id="L1390">            terrListBlocker = true;</span>
<span class="nc" id="L1391">            choTerrainType.setSelectedItem(terrainHelper);</span>
<span class="nc" id="L1392">            texTerrainLevel.setText(Integer.toString(terrain.getLevel()));</span>
<span class="nc" id="L1393">            cheTerrExitSpecified.setSelected(terrain.hasExitsSpecified());</span>
<span class="nc" id="L1394">            texTerrExits.setNumber(terrain.getExits());</span>
<span class="nc" id="L1395">            terrListBlocker = false;</span>
        }
<span class="nc" id="L1397">    }</span>

    /**
     * Updates the selected terrain in the terrain list if
     * a terrain is actually selected
     */
    private void updateWhenSelected() {
<span class="nc bnc" id="L1404" title="All 2 branches missed.">        if (!lisTerrain.isSelectionEmpty())</span>
<span class="nc" id="L1405">            addSetTerrain();</span>
<span class="nc" id="L1406">    }</span>

    public void boardNew(boolean showDialog) {
<span class="nc" id="L1409">        boolean userCancel = false;</span>
<span class="nc bnc" id="L1410" title="All 2 branches missed.">        if (showDialog) {</span>
<span class="nc" id="L1411">            RandomMapDialog rmd = new RandomMapDialog(frame, this, null, mapSettings);</span>
<span class="nc" id="L1412">            userCancel = rmd.activateDialog(bv.getTilesetManager().getThemes());</span>
        }
<span class="nc bnc" id="L1414" title="All 2 branches missed.">        if (!userCancel) {</span>
<span class="nc" id="L1415">            board = BoardUtilities.generateRandom(mapSettings);</span>
            // &quot;Initialize&quot; all hexes to add internally handled terrains
<span class="nc" id="L1417">            correctExits();</span>
<span class="nc" id="L1418">            game.setBoard(board);</span>
<span class="nc" id="L1419">            curBoardFile = null;</span>
<span class="nc" id="L1420">            choTheme.setSelectedItem(mapSettings.getTheme());</span>
<span class="nc" id="L1421">            setupUiFreshBoard();</span>
        }
<span class="nc" id="L1423">    }</span>

    public void boardResize() {
<span class="nc" id="L1426">        ResizeMapDialog emd = new ResizeMapDialog(frame, this, null, mapSettings);</span>
<span class="nc" id="L1427">        boolean userCancel = emd.activateDialog(bv.getTilesetManager().getThemes());</span>
<span class="nc bnc" id="L1428" title="All 2 branches missed.">        if (!userCancel) {</span>
<span class="nc" id="L1429">            board = BoardUtilities.generateRandom(mapSettings);</span>

            // Implant the old board
<span class="nc" id="L1432">            int west = emd.getExpandWest();</span>
<span class="nc" id="L1433">            int north = emd.getExpandNorth();</span>
<span class="nc" id="L1434">            int east = emd.getExpandEast();</span>
<span class="nc" id="L1435">            int south = emd.getExpandSouth();</span>
<span class="nc" id="L1436">            board = implantOldBoard(game, west, north, east, south);</span>

<span class="nc" id="L1438">            game.setBoard(board);</span>
<span class="nc" id="L1439">            curBoardFile = null;</span>
<span class="nc" id="L1440">            setupUiFreshBoard();</span>
        }
<span class="nc" id="L1442">    }</span>

    // When we resize a board, implant the old board's hexes where they should be in the new board
    public IBoard implantOldBoard(IGame game, int west, int north, int east, int south) {
<span class="nc" id="L1446">        IBoard oldBoard = game.getBoard();</span>
<span class="nc bnc" id="L1447" title="All 2 branches missed.">        for (int x = 0; x &lt; oldBoard.getWidth(); x++) {</span>
<span class="nc bnc" id="L1448" title="All 2 branches missed.">            for (int y = 0; y &lt; oldBoard.getHeight(); y++) {</span>
<span class="nc" id="L1449">                int newX = x+west;</span>
<span class="nc" id="L1450">                int odd = x &amp; 1 &amp; west;</span>
<span class="nc" id="L1451">                int newY = y+north + odd;</span>
<span class="nc bnc" id="L1452" title="All 4 branches missed.">                if (oldBoard.contains(x, y) &amp;&amp; board.contains(newX, newY)) {</span>
<span class="nc" id="L1453">                    IHex oldHex = oldBoard.getHex(x, y);</span>
<span class="nc" id="L1454">                    IHex hex = board.getHex(newX, newY);</span>
<span class="nc" id="L1455">                    hex.removeAllTerrains();</span>
<span class="nc" id="L1456">                        hex.setLevel(oldHex.getLevel());</span>
<span class="nc" id="L1457">                    int[] terrainTypes = oldHex.getTerrainTypes();</span>
<span class="nc bnc" id="L1458" title="All 2 branches missed.">                    for (int terrainID : terrainTypes) {</span>
<span class="nc bnc" id="L1459" title="All 2 branches missed.">                        if (!hex.containsTerrain(terrainID) &amp;&amp;</span>
<span class="nc bnc" id="L1460" title="All 2 branches missed.">                                oldHex.containsTerrain(terrainID)) {</span>
<span class="nc" id="L1461">                            hex.addTerrain(oldHex.getTerrain(terrainID));</span>
                        }
                    }
<span class="nc" id="L1464">                    hex.setTheme(oldHex.getTheme());</span>
<span class="nc" id="L1465">                    board.setHex(newX, newY, hex);</span>
<span class="nc" id="L1466">                    board.resetStoredElevation();</span>
                }
            }
        }
<span class="nc" id="L1470">        return board;</span>
    }

    public void updateMapSettings(MapSettings newSettings) {
<span class="nc" id="L1474">        mapSettings = newSettings;</span>
<span class="nc" id="L1475">    }</span>

    public void boardLoad() {
<span class="nc" id="L1478">        JFileChooser fc = new JFileChooser(loadPath);</span>
<span class="nc" id="L1479">        setDialogSize(fc);</span>
<span class="nc" id="L1480">        fc.setDialogTitle(Messages.getString(&quot;BoardEditor.loadBoard&quot;));</span>
<span class="nc" id="L1481">        fc.setFileFilter(new BoardFileFilter());</span>
<span class="nc" id="L1482">        int returnVal = fc.showOpenDialog(frame);</span>
<span class="nc" id="L1483">        saveDialogSize(fc);</span>
<span class="nc bnc" id="L1484" title="All 4 branches missed.">        if ((returnVal != JFileChooser.APPROVE_OPTION) || (fc.getSelectedFile() == null)) {</span>
            // I want a file, y'know!
<span class="nc" id="L1486">            return;</span>
        }
<span class="nc" id="L1488">        curBoardFile = fc.getSelectedFile();</span>
<span class="nc" id="L1489">        loadPath = curBoardFile.getParentFile();</span>
        // load!
<span class="nc" id="L1491">        try (InputStream is = new FileInputStream(fc.getSelectedFile())) {            </span>
            // tell the board to load!
<span class="nc" id="L1493">            board.load(is, null, true);</span>
            // Board generation in a game always calls BoardUtilities.combine
            // This serves no purpose here, but is necessary to create 
            // flipBGVert/flipBGHoriz lists for the board, which is necessary 
            // for the background image to work in the BoardEditor
<span class="nc" id="L1498">            board = BoardUtilities.combine(board.getWidth(), board.getHeight(), 1, 1, </span>
<span class="nc" id="L1499">                    new IBoard[]{board}, Collections.singletonList(false), MapSettings.MEDIUM_GROUND);</span>
<span class="nc" id="L1500">            game.setBoard(board);</span>
<span class="nc" id="L1501">            cheRoadsAutoExit.setSelected(board.getRoadsAutoExit());</span>
<span class="nc" id="L1502">            mapSettings.setBoardSize(board.getWidth(), board.getHeight());</span>
            
            // Now, *after* initialization of the board which will correct some errors,
            // do a board validation
<span class="nc" id="L1506">            validateBoard(false);</span>
            
<span class="nc" id="L1508">            refreshTerrainList();</span>
<span class="nc" id="L1509">            setupUiFreshBoard();</span>
<span class="nc" id="L1510">        } catch (IOException ex) {</span>
<span class="nc" id="L1511">            MegaMek.getLogger().error(ex);</span>
<span class="nc" id="L1512">        }</span>
<span class="nc" id="L1513">    }</span>
    
    /**
     * Will do board.initializeHex() for all hexes, correcting 
     * building and road connection issues for those hexes that do not have
     * the exits check set.
     */
    private void correctExits() {
<span class="nc bnc" id="L1521" title="All 2 branches missed.">        for (int x = 0; x &lt; board.getWidth(); x++) {</span>
<span class="nc bnc" id="L1522" title="All 2 branches missed.">            for (int y = 0; y &lt; board.getHeight(); y++) {</span>
<span class="nc" id="L1523">                board.initializeHex(x, y);</span>
            }
        }
<span class="nc" id="L1526">    }</span>

    /**
     * Saves the board in PNG image format.
     */
    private void boardSaveImage(boolean ignoreUnits) {
<span class="nc bnc" id="L1532" title="All 2 branches missed.">        if (curfileImage == null) {</span>
<span class="nc" id="L1533">            boardSaveAsImage(ignoreUnits);</span>
<span class="nc" id="L1534">            return;</span>
        }
<span class="nc" id="L1536">        JDialog waitD = new JDialog(frame, Messages.getString(&quot;BoardEditor.waitDialog.title&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1537">        waitD.add(new JLabel(Messages.getString(&quot;BoardEditor.waitDialog.message&quot;))); //$NON-NLS-1$</span>
<span class="nc" id="L1538">        waitD.setSize(250, 130);</span>
        // move to middle of screen
<span class="nc" id="L1540">        waitD.setLocation(</span>
<span class="nc" id="L1541">                (frame.getSize().width / 2) - (waitD.getSize().width / 2),</span>
<span class="nc" id="L1542">                (frame.getSize().height / 2) - (waitD.getSize().height / 2));</span>
<span class="nc" id="L1543">        waitD.setVisible(true);</span>
<span class="nc" id="L1544">        frame.setCursor(Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR));</span>
<span class="nc" id="L1545">        waitD.setCursor(Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR));</span>
        // save!
        try {
<span class="nc" id="L1548">            ImageIO.write(bv.getEntireBoardImage(ignoreUnits), &quot;png&quot;, curfileImage);</span>
<span class="nc" id="L1549">        } catch (IOException e) {</span>
<span class="nc" id="L1550">            e.printStackTrace();</span>
<span class="nc" id="L1551">        }</span>
<span class="nc" id="L1552">        waitD.setVisible(false);</span>
<span class="nc" id="L1553">        frame.setCursor(Cursor.getDefaultCursor());</span>
<span class="nc" id="L1554">    }</span>

    /**
     * Saves the board to a .board file. 
     * When saveAs is true, acts as a Save As... by opening a file chooser dialog.
     * When saveAs is false, it will directly save to the current board file name,
     * if it is known and otherwise act as Save As... 
     */
    private boolean boardSave(boolean saveAs) {
        // Correct connection issues and do a validation.
<span class="nc" id="L1564">        correctExits();</span>
<span class="nc" id="L1565">        validateBoard(false); </span>
        
        // Choose a board file to save to if this was
        // called as &quot;Save As...&quot; or there is no current filename
<span class="nc bnc" id="L1569" title="All 4 branches missed.">        if (curBoardFile == null || saveAs) {</span>
<span class="nc bnc" id="L1570" title="All 2 branches missed.">            if (!chooseSaveBoardFile()) {</span>
<span class="nc" id="L1571">                return false;</span>
            }
        }

        // write the board
<span class="nc" id="L1576">        try (OutputStream os = new FileOutputStream(curBoardFile)) {</span>
<span class="nc" id="L1577">            board.save(os);</span>
            
            // Adapt to successful save
<span class="nc" id="L1580">            butSourceFile.setEnabled(true);</span>
<span class="nc" id="L1581">            savedUndoStackSize = undoStack.size();</span>
<span class="nc" id="L1582">            hasChanges = false;</span>
<span class="nc" id="L1583">            setFrameTitle();</span>
<span class="nc" id="L1584">            return true;</span>
<span class="nc" id="L1585">        } catch (IOException ex) {</span>
<span class="nc" id="L1586">            MegaMek.getLogger().error(ex);</span>
<span class="nc" id="L1587">            return false;</span>
        }
    }
    
    /** 
     * Shows a dialog for choosing a .board file to save to. 
     * Sets curBoardFile and returns true when a valid file was chosen.
     * Returns false otherwise.
     */
    private boolean chooseSaveBoardFile() {
<span class="nc" id="L1597">        JFileChooser fc = new JFileChooser(loadPath);</span>
<span class="nc" id="L1598">        setDialogSize(fc);</span>
<span class="nc" id="L1599">        fc.setLocation(frame.getLocation().x + 150, frame.getLocation().y + 100);</span>
<span class="nc" id="L1600">        fc.setDialogTitle(Messages.getString(&quot;BoardEditor.saveBoardAs&quot;));</span>
<span class="nc" id="L1601">        fc.setFileFilter(new BoardFileFilter());</span>
<span class="nc" id="L1602">        int returnVal = fc.showSaveDialog(frame);</span>
<span class="nc" id="L1603">        saveDialogSize(fc);</span>
<span class="nc bnc" id="L1604" title="All 4 branches missed.">        if ((returnVal != JFileChooser.APPROVE_OPTION) || (fc.getSelectedFile() == null)) {</span>
<span class="nc" id="L1605">            return false; </span>
        }
<span class="nc" id="L1607">        File choice = fc.getSelectedFile();</span>
        // make sure the file ends in board
<span class="nc bnc" id="L1609" title="All 2 branches missed.">        if (!choice.getName().toLowerCase().endsWith(&quot;.board&quot;)) {</span>
            try {
<span class="nc" id="L1611">                choice = new File(choice.getCanonicalPath() + &quot;.board&quot;);</span>
<span class="nc" id="L1612">            } catch (IOException ie) {</span>
<span class="nc" id="L1613">                return false;</span>
<span class="nc" id="L1614">            }</span>
        }
<span class="nc" id="L1616">        curBoardFile = choice;</span>
<span class="nc" id="L1617">        return true;</span>
    }
    
    /**
     * Opens a file dialog box to select a file to save as; saves the board to
     * the file as an image. Useful for printing boards.
     */
    private void boardSaveAsImage(boolean ignoreUnits) {
<span class="nc" id="L1625">        JFileChooser fc = new JFileChooser(&quot;.&quot;);</span>
<span class="nc" id="L1626">        setDialogSize(fc);</span>
<span class="nc" id="L1627">        fc.setLocation(frame.getLocation().x + 150, frame.getLocation().y + 100);</span>
<span class="nc" id="L1628">        fc.setDialogTitle(Messages.getString(&quot;BoardEditor.saveAsImage&quot;));</span>
<span class="nc" id="L1629">        fc.setFileFilter(new FileFilter() {</span>
            @Override
            public boolean accept(File dir) {
<span class="nc bnc" id="L1632" title="All 4 branches missed.">                return (dir.getName().endsWith(&quot;.png&quot;) || dir.isDirectory()); //$NON-NLS-1$</span>
            }

            @Override
            public String getDescription() {
<span class="nc" id="L1637">                return &quot;.png&quot;;</span>
            }
        });
<span class="nc" id="L1640">        int returnVal = fc.showSaveDialog(frame);</span>
<span class="nc" id="L1641">        saveDialogSize(fc);</span>
<span class="nc bnc" id="L1642" title="All 2 branches missed.">        if ((returnVal != JFileChooser.APPROVE_OPTION)</span>
<span class="nc bnc" id="L1643" title="All 2 branches missed.">            || (fc.getSelectedFile() == null)) {</span>
            // I want a file, y'know!
<span class="nc" id="L1645">            return;</span>
        }
<span class="nc" id="L1647">        curfileImage = fc.getSelectedFile();</span>

        // make sure the file ends in png
<span class="nc bnc" id="L1650" title="All 2 branches missed.">        if (!curfileImage.getName().toLowerCase().endsWith(&quot;.png&quot;)) { //$NON-NLS-1$</span>
            try {
<span class="nc" id="L1652">                curfileImage = new File(curfileImage.getCanonicalPath() + &quot;.png&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1653">            } catch (IOException ie) {</span>
                // failure!
<span class="nc" id="L1655">                return;</span>
<span class="nc" id="L1656">            }</span>
        }
<span class="nc" id="L1658">        boardSaveImage(ignoreUnits);</span>
<span class="nc" id="L1659">    }</span>

    //
    // ItemListener
    //
    public void itemStateChanged(ItemEvent ie) {
<span class="nc bnc" id="L1665" title="All 2 branches missed.">        if (ie.getSource().equals(cheRoadsAutoExit)) {</span>
            // Set the new value for the option, and refresh the board.
<span class="nc" id="L1667">            board.setRoadsAutoExit(cheRoadsAutoExit.isSelected());</span>
<span class="nc" id="L1668">            bv.updateBoard();</span>
<span class="nc" id="L1669">            repaintWorkingHex();</span>
        }
<span class="nc" id="L1671">    }</span>

    //
    // TextListener
    //
    public void changedUpdate(DocumentEvent te) {
<span class="nc bnc" id="L1677" title="All 2 branches missed.">        if (te.getDocument().equals(texElev.getDocument())) {</span>
            int value;
            try {
<span class="nc" id="L1680">                value = Integer.parseInt(texElev.getText());</span>
<span class="nc" id="L1681">            } catch (NumberFormatException ex) {</span>
<span class="nc" id="L1682">                return;</span>
<span class="nc" id="L1683">            }</span>
<span class="nc bnc" id="L1684" title="All 2 branches missed.">            if (value != curHex.getLevel()) {</span>
<span class="nc" id="L1685">                curHex.setLevel(value);</span>
<span class="nc" id="L1686">                repaintWorkingHex();</span>
            }
<span class="nc bnc" id="L1688" title="All 2 branches missed.">        } else if (te.getDocument().equals(texTerrainLevel.getDocument())) {</span>
            // prevent updating the terrain from looping back to
            // update the text fields that have just been edited
<span class="nc bnc" id="L1691" title="All 2 branches missed.">            if (!terrListBlocker) {</span>
<span class="nc" id="L1692">                noTextFieldUpdate = true;</span>
<span class="nc" id="L1693">                updateWhenSelected();</span>
<span class="nc" id="L1694">                noTextFieldUpdate = false;</span>
            }
<span class="nc bnc" id="L1696" title="All 2 branches missed.">        } else if (te.getDocument().equals(texTerrExits.getDocument())) {</span>
            // prevent updating the terrain from looping back to
            // update the text fields that have just been edited
<span class="nc bnc" id="L1699" title="All 2 branches missed.">            if (!terrListBlocker) {</span>
<span class="nc" id="L1700">                noTextFieldUpdate = true;</span>
<span class="nc" id="L1701">                cheTerrExitSpecified.setSelected(true);</span>
<span class="nc" id="L1702">                updateWhenSelected();</span>
<span class="nc" id="L1703">                noTextFieldUpdate = false;</span>
            }
        }  
<span class="nc" id="L1706">    }</span>
    
    public void insertUpdate(DocumentEvent event) {
<span class="nc" id="L1709">        changedUpdate(event);</span>
<span class="nc" id="L1710">    }</span>

    public void removeUpdate(DocumentEvent event) {
<span class="nc" id="L1713">        changedUpdate(event);</span>
<span class="nc" id="L1714">    }</span>

    /** Called when the user selects the &quot;Help-&gt;About&quot; menu item. */
    private void showAbout() {
        // Do we need to create the &quot;about&quot; dialog?
<span class="nc bnc" id="L1719" title="All 2 branches missed.">        if (about == null) {</span>
<span class="nc" id="L1720">            about = new CommonAboutDialog(frame);</span>
        }

        // Show the about dialog.
<span class="nc" id="L1724">        about.setVisible(true);</span>
<span class="nc" id="L1725">    }</span>

    /** Called when the user selects the &quot;Help-&gt;Contents&quot; menu item. */
    private void showHelp() {
        // Do we need to create the &quot;help&quot; dialog?
<span class="nc bnc" id="L1730" title="All 2 branches missed.">        if (help == null) {</span>
<span class="nc" id="L1731">            File helpFile = new File(&quot;docs\\Boards Stuff&quot;, &quot;Map Editor-readme.txt&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1732">            help = new CommonHelpDialog(frame, helpFile);</span>
        }

        // Show the help dialog.
<span class="nc" id="L1736">        help.setVisible(true);</span>
<span class="nc" id="L1737">    }</span>

    /** Called when the user selects the &quot;View-&gt;Client Settings&quot; menu item. */
    private void showSettings() {
        // Do we need to create the &quot;settings&quot; dialog?
<span class="nc bnc" id="L1742" title="All 2 branches missed.">        if (setdlg == null) {</span>
<span class="nc" id="L1743">            setdlg = new CommonSettingsDialog(frame);</span>
        }

        // Show the settings dialog.
<span class="nc" id="L1747">        setdlg.setVisible(true);</span>
<span class="nc" id="L1748">    }</span>
    
    /** 
     * Adjusts some UI and internal settings for a freshly 
     * loaded or freshly generated board.
     */
    private void setupUiFreshBoard() {
        // Reset the Undo stack and the board has no changes
<span class="nc" id="L1756">        savedUndoStackSize = 0;</span>
<span class="nc" id="L1757">        canReturnToSaved = true;</span>
<span class="nc" id="L1758">        resetUndo();</span>
<span class="nc" id="L1759">        hasChanges = false;</span>
        // When a board was loaded, we have a file, otherwise not
<span class="nc bnc" id="L1761" title="All 2 branches missed.">        butSourceFile.setEnabled(curBoardFile != null);</span>
        // Adjust the UI
<span class="nc" id="L1763">        menuBar.setBoard(true);</span>
<span class="nc" id="L1764">        bvc.doLayout();</span>
<span class="nc" id="L1765">        setFrameTitle();</span>
<span class="nc" id="L1766">    }</span>
    
    /** 
     * Performs board validation. When showPositiveResult is true,
     * the result of the validation will be shown in a dialog. 
     * Otherwise, only a negative result (the board has errors) will 
     * be shown.
     */
    private void validateBoard(boolean showPositiveResult) {
<span class="nc" id="L1775">        StringBuffer errBuff = new StringBuffer();</span>
<span class="nc" id="L1776">        board.isValid(errBuff);</span>
<span class="nc bnc" id="L1777" title="All 4 branches missed.">        if ((errBuff.length() &gt; 0) || showPositiveResult) {</span>
<span class="nc" id="L1778">            showBoardValidationReport(errBuff);</span>
        }
<span class="nc" id="L1780">    }</span>

    /**
     * Shows a board validation report dialog, reporting either
     * the contents of errBuff or that the board has no errors.
     */
    private void showBoardValidationReport(StringBuffer errBuff) {
<span class="nc" id="L1787">        ignoreHotKeys = true;</span>
<span class="nc bnc" id="L1788" title="All 4 branches missed.">        if ((errBuff != null) &amp;&amp; errBuff.length() &gt; 0) {</span>
<span class="nc" id="L1789">            String title = Messages.getString(&quot;BoardEditor.invalidBoard.title&quot;);</span>
<span class="nc" id="L1790">            String msg = Messages.getString(&quot;BoardEditor.invalidBoard.report&quot;);</span>
<span class="nc" id="L1791">            msg += errBuff;</span>
<span class="nc" id="L1792">            JTextArea textArea = new JTextArea(msg);</span>
<span class="nc" id="L1793">            JScrollPane scrollPane = new JScrollPane(textArea);</span>
<span class="nc" id="L1794">            textArea.setLineWrap(true);</span>
<span class="nc" id="L1795">            textArea.setWrapStyleWord(true);</span>
<span class="nc" id="L1796">            scrollPane.setPreferredSize(new Dimension(getWidth(), getHeight() / 2));</span>
<span class="nc" id="L1797">            JOptionPane.showMessageDialog(frame, scrollPane, title, JOptionPane.ERROR_MESSAGE);</span>
<span class="nc" id="L1798">        } else {</span>
<span class="nc" id="L1799">            String title =  Messages.getString(&quot;BoardEditor.validBoard.title&quot;);</span>
<span class="nc" id="L1800">            String msg = Messages.getString(&quot;BoardEditor.validBoard.report&quot;);</span>
<span class="nc" id="L1801">            JOptionPane.showMessageDialog(frame, msg, title, JOptionPane.INFORMATION_MESSAGE);</span>
        }
<span class="nc" id="L1803">        ignoreHotKeys = false;</span>
<span class="nc" id="L1804">    }</span>

    //
    // ActionListener
    //
    public void actionPerformed(ActionEvent ae) {
<span class="nc bnc" id="L1810" title="All 2 branches missed.">        if (ae.getActionCommand().equals(ClientGUI.FILE_BOARD_NEW)) {</span>
<span class="nc" id="L1811">            ignoreHotKeys = true;</span>
<span class="nc" id="L1812">            boardNew(true);</span>
<span class="nc" id="L1813">            ignoreHotKeys = false;</span>
<span class="nc bnc" id="L1814" title="All 2 branches missed.">        } else if (ae.getActionCommand().equals(FILE_BOARD_EDITOR_EXPAND)) {</span>
<span class="nc" id="L1815">            ignoreHotKeys = true;</span>
<span class="nc" id="L1816">            boardResize();</span>
<span class="nc" id="L1817">            ignoreHotKeys = false;</span>
<span class="nc bnc" id="L1818" title="All 2 branches missed.">        } else if (ae.getActionCommand().equals(ClientGUI.FILE_BOARD_OPEN)) {</span>
<span class="nc" id="L1819">            ignoreHotKeys = true;</span>
<span class="nc" id="L1820">            boardLoad();</span>
<span class="nc" id="L1821">            ignoreHotKeys = false;</span>
<span class="nc bnc" id="L1822" title="All 2 branches missed.">        } else if (ae.getActionCommand().equals(ClientGUI.FILE_BOARD_SAVE)) {</span>
<span class="nc" id="L1823">            ignoreHotKeys = true;</span>
<span class="nc" id="L1824">            boardSave(false);</span>
<span class="nc" id="L1825">            ignoreHotKeys = false;</span>
<span class="nc bnc" id="L1826" title="All 2 branches missed.">        } else if (ae.getActionCommand().equals(ClientGUI.FILE_BOARD_SAVE_AS)) {</span>
<span class="nc" id="L1827">            ignoreHotKeys = true;</span>
<span class="nc" id="L1828">            boardSave(true);</span>
<span class="nc" id="L1829">            ignoreHotKeys = false;</span>
<span class="nc bnc" id="L1830" title="All 2 branches missed.">        } else if (ae.getActionCommand().equals(ClientGUI.FILE_BOARD_SAVE_AS_IMAGE)) {</span>
<span class="nc" id="L1831">            ignoreHotKeys = true;</span>
<span class="nc" id="L1832">            boardSaveAsImage(false);</span>
<span class="nc" id="L1833">            ignoreHotKeys = false;</span>
<span class="nc bnc" id="L1834" title="All 2 branches missed.">        } else if (ae.getActionCommand().equals(FILE_SOURCEFILE)) {</span>
<span class="nc bnc" id="L1835" title="All 2 branches missed.">            if (curBoardFile != null) {</span>
                try {
<span class="nc" id="L1837">                    Desktop.getDesktop().open(curBoardFile);</span>
<span class="nc" id="L1838">                } catch (IOException e) {</span>
<span class="nc" id="L1839">                    ignoreHotKeys = true;</span>
<span class="nc" id="L1840">                    JOptionPane.showMessageDialog(</span>
                            frame,
<span class="nc" id="L1842">                            Messages.getString(&quot;BoardEditor.OpenFileError&quot;, curBoardFile.toString())</span>
<span class="nc" id="L1843">                             + e.getMessage());</span>
<span class="nc" id="L1844">                    e.printStackTrace();</span>
<span class="nc" id="L1845">                    ignoreHotKeys = false;</span>
<span class="nc" id="L1846">                }</span>
            }
<span class="nc bnc" id="L1848" title="All 2 branches missed.">        } else if (ae.getActionCommand().equals(FILE_BOARD_EDITOR_VALIDATE)) {</span>
<span class="nc" id="L1849">            correctExits();</span>
<span class="nc" id="L1850">            validateBoard(true);</span>
<span class="nc bnc" id="L1851" title="All 2 branches missed.">        } else if (ae.getSource().equals(butDelTerrain)</span>
<span class="nc bnc" id="L1852" title="All 2 branches missed.">                   &amp;&amp; (!lisTerrain.isSelectionEmpty())) {</span>
<span class="nc" id="L1853">            ITerrain toRemove = Terrains.getTerrainFactory().createTerrain(</span>
<span class="nc" id="L1854">                    lisTerrain.getSelectedValue().getTerrain());</span>
<span class="nc" id="L1855">            curHex.removeTerrain(toRemove.getType());</span>
<span class="nc" id="L1856">            refreshTerrainList();</span>
<span class="nc" id="L1857">            repaintWorkingHex();</span>
<span class="nc bnc" id="L1858" title="All 2 branches missed.">        } else if (ae.getSource().equals(butAddTerrain)) {</span>
<span class="nc" id="L1859">            addSetTerrain();</span>
<span class="nc bnc" id="L1860" title="All 4 branches missed.">        } else if (ae.getSource().equals(butElevUp) &amp;&amp; (curHex.getLevel() &lt; 9)) {</span>
<span class="nc" id="L1861">            curHex.setLevel(curHex.getLevel() + 1);</span>
<span class="nc" id="L1862">            texElev.incValue();</span>
<span class="nc" id="L1863">            repaintWorkingHex();</span>
<span class="nc bnc" id="L1864" title="All 4 branches missed.">        } else if (ae.getSource().equals(butElevDown) &amp;&amp; (curHex.getLevel() &gt; -5)) {</span>
<span class="nc" id="L1865">            curHex.setLevel(curHex.getLevel() - 1);</span>
<span class="nc" id="L1866">            texElev.decValue();</span>
<span class="nc" id="L1867">            repaintWorkingHex();</span>
<span class="nc bnc" id="L1868" title="All 2 branches missed.">        } else if (ae.getSource().equals(butTerrUp)) {</span>
<span class="nc" id="L1869">            texTerrainLevel.incValue();</span>
<span class="nc" id="L1870">            updateWhenSelected();</span>
<span class="nc bnc" id="L1871" title="All 2 branches missed.">        } else if (ae.getSource().equals(butTerrDown)) {</span>
<span class="nc" id="L1872">            texTerrainLevel.decValue();</span>
<span class="nc" id="L1873">            updateWhenSelected();</span>
<span class="nc bnc" id="L1874" title="All 2 branches missed.">        } else if (ae.getSource().equals(texTerrainLevel)) {</span>
<span class="nc" id="L1875">            updateWhenSelected();</span>
<span class="nc bnc" id="L1876" title="All 2 branches missed.">        } else if (ae.getSource().equals(texTerrExits)) {</span>
<span class="nc" id="L1877">            int exitsVal = texTerrExits.getNumber();</span>
<span class="nc bnc" id="L1878" title="All 2 branches missed.">            if (exitsVal == 0) {</span>
<span class="nc" id="L1879">                cheTerrExitSpecified.setSelected(false);</span>
<span class="nc bnc" id="L1880" title="All 2 branches missed.">            } else if (exitsVal &gt; 63) {</span>
<span class="nc" id="L1881">                texTerrExits.setNumber(63);</span>
            }
<span class="nc" id="L1883">            updateWhenSelected();</span>
<span class="nc bnc" id="L1884" title="All 2 branches missed.">        } else if (ae.getSource().equals(butTerrExits)) {</span>
<span class="nc" id="L1885">            ExitsDialog ed = new ExitsDialog(frame);</span>
<span class="nc" id="L1886">            int exitsVal = texTerrExits.getNumber();</span>
<span class="nc" id="L1887">            ed.setExits(exitsVal);</span>
<span class="nc" id="L1888">            ed.setVisible(true);</span>
<span class="nc" id="L1889">            exitsVal = ed.getExits();</span>
<span class="nc" id="L1890">            texTerrExits.setNumber(exitsVal);</span>
<span class="nc bnc" id="L1891" title="All 2 branches missed.">            cheTerrExitSpecified.setSelected(exitsVal != 0);</span>
<span class="nc" id="L1892">            updateWhenSelected();</span>
<span class="nc bnc" id="L1893" title="All 2 branches missed.">        } else if (ae.getSource().equals(butExitUp)) {</span>
<span class="nc" id="L1894">            cheTerrExitSpecified.setSelected(true);</span>
<span class="nc bnc" id="L1895" title="All 2 branches missed.">            if (texTerrExits.getNumber() &lt; 63) {</span>
<span class="nc" id="L1896">                texTerrExits.incValue();</span>
            }
<span class="nc" id="L1898">            updateWhenSelected();</span>
<span class="nc bnc" id="L1899" title="All 2 branches missed.">        } else if (ae.getSource().equals(butExitDown)) {</span>
<span class="nc" id="L1900">            texTerrExits.decValue();</span>
<span class="nc bnc" id="L1901" title="All 2 branches missed.">            cheTerrExitSpecified.setSelected(texTerrExits.getNumber() != 0);</span>
<span class="nc" id="L1902">            updateWhenSelected();</span>
<span class="nc bnc" id="L1903" title="All 2 branches missed.">        } else if (ae.getActionCommand().equals(ClientGUI.VIEW_MINI_MAP)) {</span>
<span class="nc bnc" id="L1904" title="All 2 branches missed.">            minimapW.setVisible(!minimapW.isVisible());</span>
<span class="nc bnc" id="L1905" title="All 2 branches missed.">        } else if (ae.getActionCommand().equals(ClientGUI.HELP_ABOUT)) {</span>

<span class="nc" id="L1907">            showAbout();</span>
<span class="nc bnc" id="L1908" title="All 2 branches missed.">        } else if (ae.getActionCommand().equals(ClientGUI.HELP_CONTENTS)) {</span>
<span class="nc" id="L1909">            showHelp();</span>
<span class="nc bnc" id="L1910" title="All 2 branches missed.">        } else if (ae.getActionCommand().equals(ClientGUI.VIEW_CLIENT_SETTINGS)) {</span>
<span class="nc" id="L1911">            showSettings();</span>
<span class="nc bnc" id="L1912" title="All 2 branches missed.">        } else if (ae.getActionCommand().equals(ClientGUI.VIEW_ZOOM_IN)) {</span>
<span class="nc" id="L1913">            bv.zoomIn();</span>
<span class="nc bnc" id="L1914" title="All 2 branches missed.">        } else if (ae.getActionCommand().equals(ClientGUI.VIEW_ZOOM_OUT)) {</span>
<span class="nc" id="L1915">            bv.zoomOut();</span>
<span class="nc bnc" id="L1916" title="All 2 branches missed.">        } else if (ae.getActionCommand().equals(ClientGUI.VIEW_TOGGLE_ISOMETRIC)) {</span>
<span class="nc" id="L1917">            bv.toggleIsometric();</span>
<span class="nc bnc" id="L1918" title="All 2 branches missed.">        } else if (ae.getActionCommand().equals(ClientGUI.VIEW_CHANGE_THEME)) {</span>
<span class="nc" id="L1919">            bv.changeTheme();</span>
<span class="nc bnc" id="L1920" title="All 2 branches missed.">        } else if (ae.getSource().equals(choTheme) ) { </span>
<span class="nc" id="L1921">            curHex.setTheme((String)choTheme.getSelectedItem());</span>
<span class="nc" id="L1922">            repaintWorkingHex();</span>
<span class="nc bnc" id="L1923" title="All 2 branches missed.">        } else if (ae.getSource().equals(buttonLW)) {</span>
<span class="nc bnc" id="L1924" title="All 2 branches missed.">            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</span>
<span class="nc" id="L1925">                curHex.removeAllTerrains();</span>
            }  
<span class="nc" id="L1927">            buttonUpDn.setSelected(false);</span>
<span class="nc" id="L1928">            curHex.addTerrain(TF.createTerrain(Terrains.WOODS, 1));</span>
<span class="nc" id="L1929">            curHex.addTerrain(TF.createTerrain(Terrains.FOLIAGE_ELEV, 2));</span>
<span class="nc" id="L1930">            refreshTerrainList();</span>
<span class="nc" id="L1931">            repaintWorkingHex();</span>
            
<span class="nc bnc" id="L1933" title="All 2 branches missed.">        } else if (ae.getSource().equals(buttonOW)) {</span>
<span class="nc bnc" id="L1934" title="All 2 branches missed.">            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</span>
<span class="nc" id="L1935">                curHex.removeAllTerrains();</span>
            }  
<span class="nc" id="L1937">            buttonUpDn.setSelected(false);</span>
<span class="nc" id="L1938">            curHex.addTerrain(TF.createTerrain(Terrains.WOODS, 1));</span>
<span class="nc" id="L1939">            curHex.addTerrain(Terrains.getTerrainFactory().createTerrain(Terrains.FOLIAGE_ELEV, 1));</span>
<span class="nc" id="L1940">            refreshTerrainList();</span>
<span class="nc" id="L1941">            repaintWorkingHex();</span>
            
<span class="nc bnc" id="L1943" title="All 2 branches missed.">        } else if (ae.getSource().equals(buttonMg)) {</span>
<span class="nc bnc" id="L1944" title="All 2 branches missed.">            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</span>
<span class="nc" id="L1945">                curHex.removeAllTerrains();</span>
            }
<span class="nc" id="L1947">            buttonUpDn.setSelected(false);</span>
<span class="nc" id="L1948">            curHex.addTerrain(TF.createTerrain(Terrains.MAGMA, 1));</span>
<span class="nc" id="L1949">            refreshTerrainList();</span>
<span class="nc" id="L1950">            repaintWorkingHex();</span>
            
<span class="nc bnc" id="L1952" title="All 2 branches missed.">        } else if (ae.getSource().equals(buttonLJ)) {</span>
<span class="nc bnc" id="L1953" title="All 2 branches missed.">            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</span>
<span class="nc" id="L1954">                curHex.removeAllTerrains();</span>
            }
<span class="nc" id="L1956">            buttonUpDn.setSelected(false);</span>
<span class="nc" id="L1957">            curHex.addTerrain(TF.createTerrain(Terrains.JUNGLE, 1));</span>
<span class="nc" id="L1958">            curHex.addTerrain(Terrains.getTerrainFactory().createTerrain(Terrains.FOLIAGE_ELEV, 2));</span>
<span class="nc" id="L1959">            refreshTerrainList();</span>
<span class="nc" id="L1960">            repaintWorkingHex();</span>
            
<span class="nc bnc" id="L1962" title="All 2 branches missed.">        } else if (ae.getSource().equals(buttonOJ)) {</span>
<span class="nc bnc" id="L1963" title="All 2 branches missed.">            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</span>
<span class="nc" id="L1964">                curHex.removeAllTerrains();</span>
            }
<span class="nc" id="L1966">            buttonUpDn.setSelected(false);</span>
<span class="nc" id="L1967">            curHex.addTerrain(TF.createTerrain(Terrains.JUNGLE, 1));</span>
<span class="nc" id="L1968">            curHex.addTerrain(Terrains.getTerrainFactory().createTerrain(Terrains.FOLIAGE_ELEV, 1));</span>
<span class="nc" id="L1969">            refreshTerrainList();</span>
<span class="nc" id="L1970">            repaintWorkingHex();</span>
            
<span class="nc bnc" id="L1972" title="All 2 branches missed.">        } else if (ae.getSource().equals(buttonWa)) {</span>
<span class="nc" id="L1973">            buttonUpDn.setSelected(false);</span>
<span class="nc bnc" id="L1974" title="All 2 branches missed.">            if ((ae.getModifiers() &amp; ActionEvent.CTRL_MASK) != 0) {</span>
<span class="nc bnc" id="L1975" title="All 2 branches missed.">                if (curHex.containsTerrain(Terrains.RAPIDS, 1))</span>
<span class="nc" id="L1976">                    addSetTerrainEasy(Terrains.RAPIDS, 2);</span>
                else
<span class="nc" id="L1978">                    addSetTerrainEasy(Terrains.RAPIDS, 1);</span>
<span class="nc bnc" id="L1979" title="All 2 branches missed.">                if (!curHex.containsTerrain(Terrains.WATER) ||</span>
<span class="nc bnc" id="L1980" title="All 2 branches missed.">                        curHex.getTerrain(Terrains.WATER).getLevel() == 0)</span>
<span class="nc" id="L1981">                    addSetTerrainEasy(Terrains.WATER, 1);</span>
            } else {
<span class="nc bnc" id="L1983" title="All 2 branches missed.">                if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</span>
<span class="nc" id="L1984">                    curHex.removeAllTerrains();</span>
                }
<span class="nc" id="L1986">                addSetTerrainEasy(Terrains.WATER, 1);</span>
            }
            
<span class="nc bnc" id="L1989" title="All 2 branches missed.">        } else if (ae.getSource().equals(buttonSw)) {</span>
<span class="nc bnc" id="L1990" title="All 2 branches missed.">            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</span>
<span class="nc" id="L1991">                curHex.removeAllTerrains();</span>
            }
<span class="nc" id="L1993">            buttonUpDn.setSelected(false);</span>
<span class="nc" id="L1994">            curHex.addTerrain(TF.createTerrain(Terrains.SWAMP, 1));</span>
<span class="nc" id="L1995">            refreshTerrainList();</span>
<span class="nc" id="L1996">            repaintWorkingHex();</span>
            
<span class="nc bnc" id="L1998" title="All 2 branches missed.">        } else if (ae.getSource().equals(buttonRo)) {</span>
<span class="nc bnc" id="L1999" title="All 2 branches missed.">            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</span>
<span class="nc" id="L2000">                curHex.removeAllTerrains();</span>
            }
<span class="nc" id="L2002">            buttonUpDn.setSelected(false);</span>
<span class="nc" id="L2003">            curHex.addTerrain(TF.createTerrain(Terrains.ROUGH, 1));</span>
<span class="nc" id="L2004">            refreshTerrainList();</span>
<span class="nc" id="L2005">            repaintWorkingHex();</span>
            
<span class="nc bnc" id="L2007" title="All 2 branches missed.">        } else if (ae.getSource().equals(buttonPv)) {</span>
<span class="nc bnc" id="L2008" title="All 2 branches missed.">            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</span>
<span class="nc" id="L2009">                curHex.removeAllTerrains();</span>
            }
<span class="nc" id="L2011">            buttonUpDn.setSelected(false);</span>
<span class="nc" id="L2012">            curHex.addTerrain(TF.createTerrain(Terrains.PAVEMENT, 1));</span>
<span class="nc" id="L2013">            refreshTerrainList();</span>
<span class="nc" id="L2014">            repaintWorkingHex();</span>
            
<span class="nc bnc" id="L2016" title="All 2 branches missed.">        } else if (ae.getSource().equals(buttonMd)) {</span>
<span class="nc bnc" id="L2017" title="All 2 branches missed.">            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</span>
<span class="nc" id="L2018">                curHex.removeAllTerrains();</span>
            }
<span class="nc" id="L2020">            buttonUpDn.setSelected(false);</span>
<span class="nc" id="L2021">            curHex.addTerrain(TF.createTerrain(Terrains.MUD, 1));</span>
<span class="nc" id="L2022">            refreshTerrainList();</span>
<span class="nc" id="L2023">            repaintWorkingHex();</span>
            
<span class="nc bnc" id="L2025" title="All 2 branches missed.">        } else if (ae.getSource().equals(buttonTu)) {</span>
<span class="nc bnc" id="L2026" title="All 2 branches missed.">            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</span>
<span class="nc" id="L2027">                curHex.removeAllTerrains();</span>
            }
<span class="nc" id="L2029">            buttonUpDn.setSelected(false);</span>
<span class="nc" id="L2030">            curHex.addTerrain(TF.createTerrain(Terrains.TUNDRA, 1));</span>
<span class="nc" id="L2031">            refreshTerrainList();</span>
<span class="nc" id="L2032">            repaintWorkingHex();</span>
            
<span class="nc bnc" id="L2034" title="All 2 branches missed.">        } else if (ae.getSource().equals(buttonIc)) {</span>
<span class="nc bnc" id="L2035" title="All 2 branches missed.">            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</span>
<span class="nc" id="L2036">                curHex.removeAllTerrains();</span>
            }
<span class="nc" id="L2038">            buttonUpDn.setSelected(false);</span>
<span class="nc" id="L2039">            curHex.addTerrain(TF.createTerrain(Terrains.ICE, 1));</span>
<span class="nc" id="L2040">            refreshTerrainList();</span>
<span class="nc" id="L2041">            repaintWorkingHex();</span>
            
<span class="nc bnc" id="L2043" title="All 2 branches missed.">        } else if (ae.getSource().equals(buttonSn)) {</span>
<span class="nc bnc" id="L2044" title="All 2 branches missed.">            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</span>
<span class="nc" id="L2045">                curHex.removeAllTerrains();</span>
            }
<span class="nc" id="L2047">            buttonUpDn.setSelected(false);</span>
<span class="nc" id="L2048">            curHex.addTerrain(TF.createTerrain(Terrains.SNOW, 1));</span>
<span class="nc" id="L2049">            refreshTerrainList();</span>
<span class="nc" id="L2050">            repaintWorkingHex();</span>
            
<span class="nc bnc" id="L2052" title="All 2 branches missed.">        } else if (ae.getSource().equals(buttonCl)) {</span>
<span class="nc" id="L2053">            curHex.removeAllTerrains();</span>
<span class="nc" id="L2054">            buttonUpDn.setSelected(false);</span>
<span class="nc" id="L2055">            refreshTerrainList();</span>
<span class="nc" id="L2056">            repaintWorkingHex();</span>
            
<span class="nc bnc" id="L2058" title="All 2 branches missed.">        } else if (ae.getSource().equals(buttonBrush1)) {</span>
<span class="nc" id="L2059">            brushSize = 1;</span>
<span class="nc" id="L2060">            lastClicked = null;</span>
<span class="nc bnc" id="L2061" title="All 2 branches missed.">        } else if (ae.getSource().equals(buttonBrush2)) {</span>
<span class="nc" id="L2062">            brushSize = 2;</span>
<span class="nc" id="L2063">            lastClicked = null;</span>
<span class="nc bnc" id="L2064" title="All 2 branches missed.">        } else if (ae.getSource().equals(buttonBrush3)) {</span>
<span class="nc" id="L2065">            brushSize = 3;</span>
<span class="nc" id="L2066">            lastClicked = null;</span>
<span class="nc bnc" id="L2067" title="All 2 branches missed.">        } else if (ae.getSource().equals(buttonBu)) { </span>
<span class="nc" id="L2068">            buttonUpDn.setSelected(false);</span>
<span class="nc bnc" id="L2069" title="All 4 branches missed.">            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0 &amp;&amp; (ae.getModifiers() &amp; ActionEvent.ALT_MASK) == 0) </span>
<span class="nc" id="L2070">                curHex.removeAllTerrains();</span>
<span class="nc bnc" id="L2071" title="All 2 branches missed.">            if ((ae.getModifiers() &amp; ActionEvent.ALT_MASK) != 0) {</span>
<span class="nc" id="L2072">                setBasicBuilding(true);</span>
            } else {
<span class="nc" id="L2074">                setBasicBuilding(false);</span>
            }
<span class="nc bnc" id="L2076" title="All 2 branches missed.">        } else if (ae.getSource().equals(buttonBr)) {</span>
<span class="nc bnc" id="L2077" title="All 2 branches missed.">            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</span>
<span class="nc" id="L2078">                curHex.removeAllTerrains();</span>
            }
<span class="nc" id="L2080">            buttonUpDn.setSelected(false);</span>
<span class="nc" id="L2081">            setBasicBridge();</span>
            
<span class="nc bnc" id="L2083" title="All 2 branches missed.">        } else if (ae.getSource().equals(buttonFT)) {</span>
<span class="nc bnc" id="L2084" title="All 2 branches missed.">            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</span>
<span class="nc" id="L2085">                curHex.removeAllTerrains();</span>
            }
<span class="nc" id="L2087">            buttonUpDn.setSelected(false);</span>
<span class="nc" id="L2088">            setBasicFuelTank();</span>
            
<span class="nc bnc" id="L2090" title="All 2 branches missed.">        } else if (ae.getSource().equals(buttonRd)) {</span>
<span class="nc bnc" id="L2091" title="All 2 branches missed.">            if ((ae.getModifiers() &amp; ActionEvent.SHIFT_MASK) == 0) {</span>
<span class="nc" id="L2092">                curHex.removeAllTerrains();</span>
            }
<span class="nc" id="L2094">            buttonUpDn.setSelected(false);</span>
<span class="nc" id="L2095">            curHex.addTerrain(TF.createTerrain(Terrains.ROAD, 1));</span>
<span class="nc" id="L2096">            refreshTerrainList();</span>
<span class="nc" id="L2097">            repaintWorkingHex();</span>
            
<span class="nc bnc" id="L2099" title="All 2 branches missed.">        } else if (ae.getSource().equals(buttonUpDn)) {</span>
            // Not so useful to only do on clear terrain
<span class="nc" id="L2101">            buttonOOC.setSelected(false);</span>
            
<span class="nc bnc" id="L2103" title="All 2 branches missed.">        } else if (ae.getSource().equals(buttonUndo)) {</span>
            // The button should not be active when the stack is empty, but
            // let's check nevertheless
<span class="nc bnc" id="L2106" title="All 2 branches missed.">            if (undoStack.isEmpty()) { </span>
<span class="nc" id="L2107">                buttonUndo.setEnabled(false);</span>
            } else {
<span class="nc" id="L2109">                HashSet&lt;IHex&gt; recentHexes = undoStack.pop();</span>
<span class="nc" id="L2110">                HashSet&lt;IHex&gt; redoHexes = new HashSet&lt;&gt;(); </span>
<span class="nc bnc" id="L2111" title="All 2 branches missed.">                for (IHex hex: recentHexes) {</span>
                    // Retrieve the board hex for Redo
<span class="nc" id="L2113">                    IHex rHex = board.getHex(hex.getCoords()).duplicate();</span>
<span class="nc" id="L2114">                    rHex.setCoords(hex.getCoords());</span>
<span class="nc" id="L2115">                    redoHexes.add(rHex);</span>
                    // and undo the board hex
<span class="nc" id="L2117">                    board.setHex(hex.getCoords(), hex);</span>
<span class="nc" id="L2118">                }</span>
<span class="nc" id="L2119">                redoStack.push(redoHexes);</span>
<span class="nc bnc" id="L2120" title="All 2 branches missed.">                if (undoStack.isEmpty()) {</span>
<span class="nc" id="L2121">                    buttonUndo.setEnabled(false);</span>
                }
<span class="nc bnc" id="L2123" title="All 4 branches missed.">                hasChanges = !canReturnToSaved | (undoStack.size() != savedUndoStackSize);</span>
<span class="nc" id="L2124">                buttonRedo.setEnabled(true);</span>
<span class="nc" id="L2125">                currentUndoSet = null; // should be anyway</span>
            }
<span class="nc" id="L2127">            setFrameTitle();</span>
            
<span class="nc bnc" id="L2129" title="All 2 branches missed.">        } else if (ae.getSource().equals(buttonRedo)) {</span>
            // The button should not be active when the stack is empty, but
            // let's check nevertheless
<span class="nc bnc" id="L2132" title="All 2 branches missed.">            if (redoStack.isEmpty()) { </span>
<span class="nc" id="L2133">                buttonRedo.setEnabled(false); </span>
            } else {
<span class="nc" id="L2135">                HashSet&lt;IHex&gt; recentHexes = redoStack.pop();</span>
<span class="nc" id="L2136">                HashSet&lt;IHex&gt; undoHexes = new HashSet&lt;&gt;(); </span>
<span class="nc bnc" id="L2137" title="All 2 branches missed.">                for (IHex hex: recentHexes) {</span>
<span class="nc" id="L2138">                    IHex rHex = board.getHex(hex.getCoords()).duplicate();</span>
<span class="nc" id="L2139">                    rHex.setCoords(hex.getCoords());</span>
<span class="nc" id="L2140">                    undoHexes.add(rHex);</span>
<span class="nc" id="L2141">                    board.setHex(hex.getCoords(), hex);</span>
<span class="nc" id="L2142">                }</span>
<span class="nc" id="L2143">                undoStack.push(undoHexes);</span>
<span class="nc bnc" id="L2144" title="All 2 branches missed.">                if (redoStack.isEmpty()) buttonRedo.setEnabled(false);</span>
<span class="nc" id="L2145">                buttonUndo.setEnabled(true);</span>
<span class="nc bnc" id="L2146" title="All 4 branches missed.">                hasChanges = !canReturnToSaved | (undoStack.size() != savedUndoStackSize);</span>
<span class="nc" id="L2147">                currentUndoSet = null; // should be anyway</span>
            }
<span class="nc" id="L2149">            setFrameTitle();</span>
        }
<span class="nc" id="L2151">    }</span>

    public void valueChanged(ListSelectionEvent event) {
<span class="nc bnc" id="L2154" title="All 2 branches missed.">        if (event.getValueIsAdjusting()) {</span>
<span class="nc" id="L2155">            return;</span>
        }
<span class="nc bnc" id="L2157" title="All 2 branches missed.">        if (event.getSource().equals(lisTerrain)) {</span>
<span class="nc bnc" id="L2158" title="All 2 branches missed.">            if (!noTextFieldUpdate)</span>
<span class="nc" id="L2159">                refreshTerrainFromList();</span>
        }
<span class="nc" id="L2161">    }</span>

    /**
     * Displays the currently selected hex picture, in component form
     */
    private class HexCanvas extends JPanel {
        /**
         *
         */
        private static final long serialVersionUID = 3201928357525361191L;

<span class="nc" id="L2172">        HexCanvas() {</span>
<span class="nc" id="L2173">            setPreferredSize(new Dimension(90, 90));</span>
<span class="nc" id="L2174">        }</span>
        
        /** Returns list or an empty list when list is null. */
        private List&lt;Image&gt; safeList(List&lt;Image&gt; list) {
<span class="nc bnc" id="L2178" title="All 2 branches missed.">            return list == null ? Collections.emptyList() : list;</span>
        }

        @Override
        public void paintComponent(Graphics g) {
<span class="nc" id="L2183">            super.paintComponent(g);</span>
<span class="nc bnc" id="L2184" title="All 2 branches missed.">            if (curHex != null) {</span>
                // draw the terrain images
<span class="nc" id="L2186">                TilesetManager tm = bv.getTilesetManager();</span>
<span class="nc" id="L2187">                g.drawImage(tm.baseFor(curHex), 0, 0, BoardView1.HEX_W, BoardView1.HEX_H, this);</span>
<span class="nc bnc" id="L2188" title="All 2 branches missed.">                for (final Image newVar : safeList(tm.supersFor(curHex))) {</span>
<span class="nc" id="L2189">                    g.drawImage(newVar, 0, 0, this);</span>
<span class="nc" id="L2190">                }</span>
<span class="nc bnc" id="L2191" title="All 2 branches missed.">                for (final Image newVar : safeList(tm.orthoFor(curHex))) {</span>
<span class="nc" id="L2192">                    g.drawImage(newVar, 0, 0, this);</span>
<span class="nc" id="L2193">                }</span>
                // add level and INVALID if necessary
<span class="nc bnc" id="L2195" title="All 2 branches missed.">                if (guip.getAntiAliasing()) {</span>
<span class="nc" id="L2196">                    ((Graphics2D) g).setRenderingHint(</span>
                            RenderingHints.KEY_ANTIALIASING,
                            RenderingHints.VALUE_ANTIALIAS_ON);
                }
<span class="nc" id="L2200">                g.setColor(getForeground());</span>
<span class="nc" id="L2201">                g.setFont(new Font(&quot;SansSerif&quot;, Font.PLAIN, 9)); //$NON-NLS-1$</span>
<span class="nc" id="L2202">                g.drawString(Messages.getString(&quot;BoardEditor.LEVEL&quot;) + curHex.getLevel(), 24, 70); //$NON-NLS-1$</span>
<span class="nc" id="L2203">                StringBuffer errBuf = new StringBuffer();</span>
<span class="nc bnc" id="L2204" title="All 2 branches missed.">                if (!curHex.isValid(errBuf)) {</span>
<span class="nc" id="L2205">                    g.setFont(new Font(&quot;SansSerif&quot;, Font.BOLD, 14)); //$NON-NLS-1$</span>
<span class="nc" id="L2206">                    Point hexCenter = new Point(BoardView1.HEX_W / 2, BoardView1.HEX_H / 2);</span>
<span class="nc" id="L2207">                    bv.drawCenteredText((Graphics2D) g, </span>
<span class="nc" id="L2208">                            Messages.getString(&quot;BoardEditor.INVALID&quot;), //$NON-NLS-1$</span>
                            hexCenter, 
<span class="nc" id="L2210">                            guip.getWarningColor(),</span>
                            false);
<span class="nc" id="L2212">                    String tooltip = Messages.getString(&quot;BoardEditor.invalidHex&quot;) + errBuf; //$NON-NLS-1$</span>
<span class="nc" id="L2213">                    tooltip = tooltip.replace(&quot;\n&quot;, &quot;&lt;br&gt;&quot;); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L2214">                    setToolTipText(tooltip);</span>
<span class="nc" id="L2215">                } else {</span>
<span class="nc" id="L2216">                    setToolTipText(null);</span>
                }
<span class="nc" id="L2218">            } else {</span>
<span class="nc" id="L2219">                g.clearRect(0, 0, 72, 72);</span>
            }
<span class="nc" id="L2221">        }</span>

        // Make the hex stubborn when resizing the frame
        @Override
        public Dimension getPreferredSize() {
<span class="nc" id="L2226">            return new Dimension(90, 90);</span>
        }
        
        @Override
        public Dimension getMinimumSize() {
<span class="nc" id="L2231">            return new Dimension(90, 90);</span>
        }
    }

    /**
     * @return the frame this is displayed in
     */
    public JFrame getFrame() {
<span class="nc" id="L2239">        return frame;</span>
    }

    /**
     * Returns true if a dialog is visible on top of the &lt;code&gt;ClientGUI&lt;/code&gt;.
     * For example, the &lt;code&gt;MegaMekController&lt;/code&gt; should ignore hotkeys
     * if there is a dialog, like the &lt;code&gt;CommonSettingsDialog&lt;/code&gt;, open.
     *
     * @return
     */
    public boolean shouldIgnoreHotKeys() {
<span class="nc bnc" id="L2250" title="All 8 branches missed.">        return ignoreHotKeys || (about != null &amp;&amp; about.isVisible())</span>
<span class="nc bnc" id="L2251" title="All 4 branches missed.">                || (help != null &amp;&amp; help.isVisible())</span>
<span class="nc bnc" id="L2252" title="All 4 branches missed.">                || (setdlg != null &amp;&amp; setdlg.isVisible()) || texElev.hasFocus()</span>
<span class="nc bnc" id="L2253" title="All 4 branches missed.">                || texTerrainLevel.hasFocus() || texTerrExits.hasFocus();</span>
    }
    
    private void setDialogSize(JFileChooser dialog) {
<span class="nc" id="L2257">        int width = guip.getBoardEditLoadWidth();</span>
<span class="nc" id="L2258">        int height = guip.getBoardEditLoadHeight();</span>
<span class="nc" id="L2259">        dialog.setPreferredSize(new Dimension(width, height));   </span>
<span class="nc" id="L2260">    }</span>
    
    private void saveDialogSize(JComponent dialog) {
<span class="nc" id="L2263">        guip.setBoardEditLoadHeight(dialog.getHeight());</span>
<span class="nc" id="L2264">        guip.setBoardEditLoadWidth(dialog.getWidth());</span>
<span class="nc" id="L2265">    }</span>
    
    /** 
     *  Sets the Board Editor frame title, adding the current file name if any
     *  and a &quot;*&quot; if the board has unsaved changes.
     */
    private void setFrameTitle() {
<span class="nc" id="L2272">        String title = Messages.getString(&quot;BoardEditor.title&quot;); //$NON-NLS-1$</span>
<span class="nc bnc" id="L2273" title="All 2 branches missed.">        if (curBoardFile != null) {</span>
<span class="nc" id="L2274">            title = Messages.getString(&quot;BoardEditor.title0&quot;, curBoardFile);  //$NON-NLS-1$ </span>
        }
<span class="nc bnc" id="L2276" title="All 2 branches missed.">        frame.setTitle(title + (hasChanges ? &quot;*&quot; : &quot;&quot;)); //$NON-NLS-1$ //$NON-NLS-2$</span>
<span class="nc" id="L2277">    }</span>
    
    
    /**
     * Specialized field for the BoardEditor that supports 
     * MouseWheel changes.
     * 
     * @author Simon
     */
    private class EditorTextField extends JTextField {

        /**
         * 
         */
        private static final long serialVersionUID = 4706926692515844105L;

<span class="nc" id="L2293">        private int minValue = Integer.MIN_VALUE;</span>
        
        /**
         * Creates an EditorTextField based on JTextField. This is a 
         * specialized field for the BoardEditor that supports 
         * MouseWheel changes.
         * 
         * @param text the initial text
         * @param columns as in JTextField
         * 
         * @see javax.swing.JTextField#JTextField(String, int)
         */
<span class="nc" id="L2305">        public EditorTextField(String text, int columns) {</span>
<span class="nc" id="L2306">            super(text, columns);</span>
            // Automatically select all text when clicking the text field
<span class="nc" id="L2308">            addMouseListener(new MouseAdapter() {</span>
                @Override public void mouseReleased(MouseEvent e) {
<span class="nc" id="L2310">                    selectAll();</span>
<span class="nc" id="L2311">                }</span>
            });

<span class="nc" id="L2314">            addMouseWheelListener(new MouseWheelListener() {</span>
                @Override
                public void mouseWheelMoved(MouseWheelEvent e) {
<span class="nc bnc" id="L2317" title="All 2 branches missed.">                    if (e.getWheelRotation() &lt; 0)</span>
<span class="nc" id="L2318">                        incValue();</span>
                    else 
<span class="nc" id="L2320">                        decValue();</span>
<span class="nc" id="L2321">                }</span>
            });
<span class="nc" id="L2323">            setMargin(new Insets(1,1,1,1));</span>
<span class="nc" id="L2324">            setHorizontalAlignment(JTextField.CENTER);</span>
<span class="nc" id="L2325">            setFont(fontElev);</span>
<span class="nc" id="L2326">            setCursor(Cursor.getDefaultCursor());</span>
<span class="nc" id="L2327">        }</span>
        
        /**
         * Creates an EditorTextField based on JTextField. This is a 
         * specialized field for the BoardEditor that supports 
         * MouseWheel changes.
         * 
         * @param text the initial text
         * @param columns as in JTextField
         * @param minimum a minimum value that the EditorTextField
         * will generally adhere to when its own methods are used
         * to change its value.
         * 
         * @see javax.swing.JTextField#JTextField(String, int)
         * 
         * @author Simon/Juliez
         */
        public EditorTextField(String text, int columns, int minimum) {
<span class="nc" id="L2345">            this(text, columns);</span>
<span class="nc" id="L2346">            minValue = minimum;</span>
<span class="nc" id="L2347">        }</span>
        
        /**
         * Increases the EditorTextField's number by one, if a number
         * is present.
         */
        public void incValue() {
<span class="nc" id="L2354">            int newValue = getNumber() + 1;</span>
<span class="nc" id="L2355">            setNumber(newValue);</span>
<span class="nc" id="L2356">        }</span>

        /**
         * Lowers the EditorTextField's number by one, if a number
         * is present and if that number is higher than the minimum
         * value.
         */
        public void decValue() {
<span class="nc" id="L2364">            setNumber(getNumber() - 1);</span>
<span class="nc" id="L2365">        }</span>

        /**
         * Sets the text to &lt;code&gt;newValue&lt;/code&gt;. If &lt;code&gt;newValue&lt;/code&gt; is lower
         * than the EditorTextField's minimum value, the minimum value will
         * be set instead.
         * 
         * @param newValue the value to be set
         */
        public void setNumber(int newValue) {
<span class="nc" id="L2375">            int value = Math.max(newValue, minValue);</span>
<span class="nc" id="L2376">            setText(Integer.toString(value));</span>
<span class="nc" id="L2377">        }</span>
        
        /**
         * Returns the text in the EditorTextField's as an int. 
         * Returns 0 when no parsable number (only letters) are present. 
         */
        public int getNumber() {
            try {
<span class="nc" id="L2385">                return Integer.parseInt(getText());</span>
<span class="nc" id="L2386">            } catch (NumberFormatException ex) {</span>
<span class="nc" id="L2387">                return 0;</span>
            }
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>