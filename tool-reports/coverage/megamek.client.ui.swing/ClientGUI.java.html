<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="nl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ClientGUI.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">PlayerTest Coverage Results</a> &gt; <a href="index.source.html" class="el_package">megamek.client.ui.swing</a> &gt; <span class="el_source">ClientGUI.java</span></div><h1>ClientGUI.java</h1><pre class="source lang-java linenums">/*
 * MegaMek - Copyright (C) 2000,2001,2002,2003,2004 Ben Mazur (bmazur@sev.org)
 * Copyright 2013 Edward Cullen (eddy@obsessedcomputers.co.uk)
 *
 * This program is free software; you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by the Free
 * Software Foundation; either version 2 of the License, or (at your option)
 * any later version.
 *
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 * or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
 * for more details.
 */
package megamek.client.ui.swing;

import java.applet.Applet;
import java.applet.AudioClip;
import java.awt.BorderLayout;
import java.awt.CardLayout;
import java.awt.Component;
import java.awt.Cursor;
import java.awt.Dimension;
import java.awt.GraphicsConfiguration;
import java.awt.GraphicsDevice;
import java.awt.GraphicsEnvironment;
import java.awt.GridBagConstraints;
import java.awt.Image;
import java.awt.Rectangle;
import java.awt.SystemColor;
import java.awt.event.*;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.OutputStream;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.*;

import javax.imageio.ImageIO;
import javax.swing.*;
import javax.swing.filechooser.FileFilter;
import javax.swing.filechooser.FileNameExtensionFilter;

import megamek.MegaMek;
import megamek.client.Client;
import megamek.client.TimerSingleton;
import megamek.client.bot.BotClient;
import megamek.client.bot.TestBot;
import megamek.client.bot.princess.Princess;
import megamek.client.event.BoardViewEvent;
import megamek.client.event.BoardViewListener;
import megamek.client.ui.GBC;
import megamek.client.ui.IBoardView;
import megamek.client.ui.Messages;
import megamek.client.ui.swing.boardview.BoardView1;
import megamek.client.ui.swing.dialog.AbstractUnitSelectorDialog;
import megamek.client.ui.swing.dialog.MegaMekUnitSelectorDialog;
import megamek.client.ui.swing.unitDisplay.UnitDisplay;
import megamek.client.ui.swing.util.BASE64ToolKit;
import megamek.client.ui.swing.util.MegaMekController;
import megamek.common.Configuration;
import megamek.common.Coords;
import megamek.common.Entity;
import megamek.common.EntityListFile;
import megamek.common.IBomber;
import megamek.common.IGame;
import megamek.common.IGame.Phase;
import megamek.common.IPlayer;
import megamek.common.MechSummaryCache;
import megamek.common.Mounted;
import megamek.common.MovePath;
import megamek.common.MovePath.MoveStepType;
import megamek.common.Targetable;
import megamek.common.WeaponOrderHandler;
import megamek.common.actions.WeaponAttackAction;
import megamek.common.event.GameCFREvent;
import megamek.common.event.GameEndEvent;
import megamek.common.event.GameListener;
import megamek.common.event.GameListenerAdapter;
import megamek.common.event.GameMapQueryEvent;
import megamek.common.event.GamePhaseChangeEvent;
import megamek.common.event.GamePlayerChangeEvent;
import megamek.common.event.GamePlayerChatEvent;
import megamek.common.event.GamePlayerConnectedEvent;
import megamek.common.event.GamePlayerDisconnectedEvent;
import megamek.common.event.GameReportEvent;
import megamek.common.event.GameSettingsChangeEvent;
import megamek.common.icons.Camouflage;
import megamek.common.net.Packet;
import megamek.common.preference.PreferenceManager;
import megamek.common.util.AddBotUtil;
import megamek.common.util.Distractable;
import megamek.common.util.fileUtils.MegaMekFile;
import megamek.common.util.SharedConfiguration;
import megamek.common.util.StringUtil;

public class ClientGUI extends JPanel implements WindowListener, BoardViewListener, ActionListener, ComponentListener {
    //region Variable Declarations
    private static final long serialVersionUID = 3913466735610109147L;

    private static final String FILENAME_ICON_16X16 = &quot;megamek-icon-16x16.png&quot;;
    private static final String FILENAME_ICON_32X32 = &quot;megamek-icon-32x32.png&quot;;
    private static final String FILENAME_ICON_48X48 = &quot;megamek-icon-48x48.png&quot;;
    private static final String FILENAME_ICON_256X256 = &quot;megamek-icon-256x256.png&quot;;

    //region action commands
    //region main menu
    //Note: anything located in menu bars is not located here but in their menu
    public static final String MAIN_SKIN_NEW = &quot;mainSkinNew&quot;;
    public static final String MAIN_QUIT = &quot;mainQuit&quot;;
    //region file menu
    //game submenu
    public static final String FILE_GAME_NEW = &quot;fileGameNew&quot;;
    public static final String FILE_GAME_OPEN = &quot;fileGameOpen&quot;;
    public static final String FILE_GAME_SAVE = &quot;fileGameSave&quot;;
    public static final String FILE_GAME_SAVE_SERVER = &quot;fileGameSaveServer&quot;;
    public static final String FILE_GAME_SCENARIO = &quot;fileGameScenario&quot;;
    public static final String FILE_GAME_CONNECT_BOT = &quot;fileGameConnectBot&quot;;
    public static final String FILE_GAME_CONNECT = &quot;fileGameConnect&quot;;
    public static final String FILE_GAME_REPLACE_PLAYER = &quot;replacePlayer&quot;;
    //board submenu
    public static final String FILE_BOARD_NEW = &quot;fileBoardNew&quot;;
    public static final String FILE_BOARD_OPEN = &quot;fileBoardOpen&quot;;
    public static final String FILE_BOARD_SAVE = &quot;fileBoardSave&quot;;
    public static final String FILE_BOARD_SAVE_AS = &quot;fileBoardSaveAs&quot;;
    public static final String FILE_BOARD_SAVE_AS_IMAGE = &quot;fileBoardSaveAsImage&quot;;
    public static final String FILE_BOARD_SAVE_AS_IMAGE_UNITS = &quot;fileBoardSaveAsImageUnits&quot;;
    //unit list submenu
    public static final String FILE_UNITS_REINFORCE = &quot;fileUnitsReinforce&quot;;
    public static final String FILE_UNITS_REINFORCE_RAT = &quot;fileUnitsReinforceRAT&quot;;
    public static final String FILE_UNITS_OPEN = &quot;fileUnitsOpen&quot;;
    public static final String FILE_UNITS_CLEAR = &quot;fileUnitsClear&quot;;
    public static final String FILE_UNITS_SAVE = &quot;fileUnitsSave&quot;;
    //file menu
    public static final String FILE_PRINT = &quot;filePrint&quot;;
    //endregion file menu

    //region view menu
    public static final String VIEW_MEK_DISPLAY = &quot;viewMekDisplay&quot;;
    public static final String VIEW_ACCESSIBILITY_WINDOW = &quot;viewAccessibilityWindow&quot;;
    public static final String VIEW_KEYBINDS_OVERLAY = &quot;viewKeyboardShortcuts&quot;;
    public static final String VIEW_MINI_MAP = &quot;viewMiniMap&quot;;
    public static final String VIEW_UNIT_OVERVIEW = &quot;viewUnitOverview&quot;;
    public static final String VIEW_ZOOM_IN = &quot;viewZoomIn&quot;;
    public static final String VIEW_ZOOM_OUT = &quot;viewZoomOut&quot;;
    public static final String VIEW_TOGGLE_ISOMETRIC = &quot;viewToggleIsometric&quot;;
    public static final String VIEW_TOGGLE_FIELD_OF_FIRE = &quot;viewToggleFieldOfFire&quot;;
    public static final String VIEW_TOGGLE_FOV_DARKEN = &quot;viewToggleFovDarken&quot;;
    public static final String VIEW_TOGGLE_FOV_HIGHLIGHT = &quot;viewToggleFovHighlight&quot;;
    public static final String VIEW_TOGGLE_FIRING_SOLUTIONS = &quot;viewToggleFiringSolutions&quot;;
    public static final String VIEW_MOVE_ENV = &quot;viewMovementEnvelope&quot;;
    public static final String VIEW_MOVE_MOD_ENV = &quot;viewMovModEnvelope&quot;;
    public static final String VIEW_CHANGE_THEME = &quot;viewChangeTheme&quot;;
    public static final String VIEW_ROUND_REPORT = &quot;viewRoundReport&quot;;
    public static final String VIEW_GAME_OPTIONS = &quot;viewGameOptions&quot;;
    public static final String VIEW_CLIENT_SETTINGS = &quot;viewClientSettings&quot;;
    public static final String VIEW_LOS_SETTING = &quot;viewLOSSetting&quot;;
    public static final String VIEW_PLAYER_SETTINGS = &quot;viewPlayerSettings&quot;;
    public static final String VIEW_PLAYER_LIST = &quot;viewPlayerList&quot;;
    public static final String VIEW_RESET_WINDOW_POSITIONS = &quot;viewResetWindowPos&quot;;
    //endregion view menu

    //region fire menu
    public static final String FIRE_SAVE_WEAPON_ORDER = &quot;saveWeaponOrder&quot;;
    //endregion fire menu

    //region help menu
    public static final String HELP_CONTENTS = &quot;helpContents&quot;;
    public static final String HELP_SKINNING = &quot;helpSkinning&quot;;
    public static final String HELP_ABOUT = &quot;helpAbout&quot;;
    //endregion help menu
    //endregion action commands

    // a frame, to show stuff in
    public JFrame frame;

    // A menu bar to contain all actions.
    protected CommonMenuBar menuBar;
    private CommonAboutDialog about;
    private CommonHelpDialog help;
    private CommonSettingsDialog setdlg;
    private AccessibilityWindow aw;
<span class="nc" id="L184">    private String helpFileName =</span>
<span class="nc" id="L185">            SharedConfiguration.getInstance().getProperty(&quot;megamek.CommonMenuBar.helpFilePath&quot;,</span>
<span class="nc" id="L186">                    Messages.getString(&quot;CommonMenuBar.helpFilePath&quot;));</span>

    public MegaMekController controller;
    private ChatterBox cb;
    public ChatterBox2 cb2;
    public BoardView1 bv;
    private Component bvc;
    public JDialog mechW;
    public UnitDisplay mechD;
    public JDialog minimapW;
    public MiniMap minimap;
    private MapMenu popup;
    private UnitOverview uo;
    private Ruler ruler;
    protected JComponent curPanel;
    public ChatLounge chatlounge;
    private OffBoardTargetOverlay offBoardOverlay;

    // some dialogs...
    private GameOptionsDialog gameOptionsDialog;
    private AbstractUnitSelectorDialog mechSelectorDialog;
    private StartingPositionDialog startingPositionDialog;
    private PlayerListDialog playerListDialog;
    private RandomArmyDialog randomArmyDialog;
    private RandomSkillDialog randomSkillDialog;
    private PlanetaryConditionsDialog conditionsDialog;
    /**
     * Save and Open dialogs for MegaMek Unit List (mul) files.
     */
    private JFileChooser dlgLoadList;
    private JFileChooser dlgSaveList;
    private Client client;

    private File curfileBoardImage;
    private File curfileBoard;

    /**
     * Cache for the &quot;bing&quot; soundclip.
     */
    private AudioClip bingClip;

    /**
     * Map each phase to the name of the card for the main display area.
     */
<span class="nc" id="L230">    private Map&lt;String, String&gt; mainNames = new HashMap&lt;&gt;();</span>

    /**
     * The &lt;code&gt;JPanel&lt;/code&gt; containing the main display area.
     */
<span class="nc" id="L235">    private JPanel panMain = new JPanel();</span>

    /**
     * The &lt;code&gt;CardLayout&lt;/code&gt; of the main display area.
     */
<span class="nc" id="L240">    private CardLayout cardsMain = new CardLayout();</span>

    /**
     * Map each phase to the name of the card for the secondary area.
     */
<span class="nc" id="L245">    private Map&lt;String, String&gt; secondaryNames = new HashMap&lt;&gt;();</span>

    /**
     * The &lt;code&gt;JPanel&lt;/code&gt; containing the secondary display area.
     */
<span class="nc" id="L250">    private JPanel panSecondary = new JPanel();</span>

    private StatusBarPhaseDisplay currPhaseDisplay;

    /**
     * The &lt;code&gt;CardLayout&lt;/code&gt; of the secondary display area.
     */
<span class="nc" id="L257">    private CardLayout cardsSecondary = new CardLayout();</span>

    /**
     * Map phase component names to phase component objects.
     */
<span class="nc" id="L262">    private Map&lt;String, JComponent&gt; phaseComponents = new HashMap&lt;&gt;();</span>

    /**
     * Current Selected entity
     */
<span class="nc" id="L267">    private int selectedEntityNum = Entity.NONE;</span>

    /**
     * Flag that indicates whether hotkeys should be ignored or not.  This is
     * used for disabling hot keys when various dialogs are displayed.
     */
<span class="nc" id="L273">    private boolean ignoreHotKeys = false;</span>

    /**
     * Keeps track of the Entity ID for the entity currently taking a pointblank
     * shot.
     */
<span class="nc" id="L279">    private int pointblankEID = Entity.NONE;</span>
    //endregion Variable Declarations

    /**
     * Construct a client which will display itself in a new frame. It will not
     * try to connect to a server yet. When the frame closes, this client will
     * clean up after itself as much as possible, but will not call
     * System.exit().
     */
    public ClientGUI(Client client, MegaMekController c) {
<span class="nc" id="L289">        super(new BorderLayout());</span>
<span class="nc" id="L290">        this.addComponentListener(this);</span>
<span class="nc" id="L291">        this.client = client;</span>
<span class="nc" id="L292">        controller = c;</span>
<span class="nc" id="L293">        loadSoundClip();</span>
<span class="nc" id="L294">        panMain.setLayout(cardsMain);</span>
<span class="nc" id="L295">        panSecondary.setLayout(cardsSecondary);</span>
<span class="nc" id="L296">        JPanel panDisplay = new JPanel(new BorderLayout());</span>
<span class="nc" id="L297">        panDisplay.add(panMain, BorderLayout.CENTER);</span>
<span class="nc" id="L298">        panDisplay.add(panSecondary, BorderLayout.SOUTH);</span>
<span class="nc" id="L299">        add(panDisplay, BorderLayout.CENTER);</span>
<span class="nc" id="L300">    }</span>

    public IBoardView getBoardView() {
<span class="nc" id="L303">        return bv;</span>
    }

    /**
     * Try to load the &quot;bing&quot; sound clip.
     */
    private void loadSoundClip() {
<span class="nc bnc" id="L310" title="All 2 branches missed.">        if (GUIPreferences.getInstance().getSoundBingFilename() == null) {</span>
<span class="nc" id="L311">            return;</span>
        }
        try {
<span class="nc" id="L314">            File file = new File(GUIPreferences.getInstance().getSoundBingFilename());</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">            if (!file.exists()) {</span>
<span class="nc" id="L316">                MegaMek.getLogger().error(&quot;Failed to load audio file: &quot; + GUIPreferences.getInstance().getSoundBingFilename());</span>
<span class="nc" id="L317">                return;</span>
            }
<span class="nc" id="L319">            bingClip = Applet.newAudioClip(file.toURI().toURL());</span>
<span class="nc" id="L320">        } catch (Exception e) {</span>
<span class="nc" id="L321">            MegaMek.getLogger().error(e);</span>
<span class="nc" id="L322">        }</span>
<span class="nc" id="L323">    }</span>

    /**
     * Display a system message in the chat box.
     *
     * @param message the &lt;code&gt;String&lt;/code&gt; message to be shown.
     */
    public void systemMessage(String message) {
<span class="nc" id="L331">        cb.systemMessage(message);</span>
<span class="nc" id="L332">        cb2.addChatMessage(&quot;Megamek: &quot; + message);</span>
<span class="nc" id="L333">    }</span>

    /**
     * @return the 'virtual bounds' of the screen. That is, the union of the displayable space on
     * all available screen devices.
     */
    private Rectangle getVirtualBounds() {
<span class="nc" id="L340">        Rectangle virtualBounds = new Rectangle();</span>
<span class="nc" id="L341">        GraphicsEnvironment ge = GraphicsEnvironment.getLocalGraphicsEnvironment();</span>
<span class="nc" id="L342">        GraphicsDevice[] gs = ge.getScreenDevices();</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">        for (GraphicsDevice gd : gs) {</span>
<span class="nc" id="L344">            GraphicsConfiguration[] gc = gd.getConfigurations();</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">            for (GraphicsConfiguration element : gc) {</span>
<span class="nc" id="L346">                virtualBounds = virtualBounds.union(element.getBounds());</span>
            }
        }
<span class="nc" id="L349">        return virtualBounds;</span>
    }

    /**
     * Initializes a number of things about this frame.
     */
    private void initializeFrame() {
<span class="nc" id="L356">        frame = new JFrame(Messages.getString(&quot;ClientGUI.title&quot;));</span>
<span class="nc" id="L357">        menuBar.setGame(client.getGame());</span>
<span class="nc" id="L358">        frame.setJMenuBar(menuBar);</span>
<span class="nc" id="L359">        Rectangle virtualBounds = getVirtualBounds();</span>
<span class="nc bnc" id="L360" title="All 2 branches missed.">        if (GUIPreferences.getInstance().getWindowSizeHeight() != 0) {</span>
<span class="nc" id="L361">            int x = GUIPreferences.getInstance().getWindowPosX();</span>
<span class="nc" id="L362">            int y = GUIPreferences.getInstance().getWindowPosY();</span>
<span class="nc" id="L363">            int w = GUIPreferences.getInstance().getWindowSizeWidth();</span>
<span class="nc" id="L364">            int h = GUIPreferences.getInstance().getWindowSizeHeight();</span>
<span class="nc bnc" id="L365" title="All 4 branches missed.">            if ((x &lt; virtualBounds.getMinX()) || ((x + w) &gt; virtualBounds.getMaxX())) {</span>
<span class="nc" id="L366">                x = 0;</span>
            }
<span class="nc bnc" id="L368" title="All 4 branches missed.">            if ((y &lt; virtualBounds.getMinY()) || ((y + h) &gt; virtualBounds.getMaxY())) {</span>
<span class="nc" id="L369">                y = 0;</span>
            }
<span class="nc bnc" id="L371" title="All 2 branches missed.">            if (w &gt; virtualBounds.getWidth()) {</span>
<span class="nc" id="L372">                w = (int) virtualBounds.getWidth();</span>
            }
<span class="nc bnc" id="L374" title="All 2 branches missed.">            if (h &gt; virtualBounds.getHeight()) {</span>
<span class="nc" id="L375">                h = (int) virtualBounds.getHeight();</span>
            }
<span class="nc" id="L377">            frame.setLocation(x, y);</span>
<span class="nc" id="L378">            frame.setSize(w, h);</span>
<span class="nc" id="L379">        } else {</span>
<span class="nc" id="L380">            frame.setSize(800, 600);</span>
        }
<span class="nc" id="L382">        frame.setMinimumSize(new Dimension(640,480));</span>
<span class="nc" id="L383">        frame.setBackground(SystemColor.menu);</span>
<span class="nc" id="L384">        frame.setForeground(SystemColor.menuText);</span>
<span class="nc" id="L385">        List&lt;Image&gt; iconList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L386">        iconList.add(frame.getToolkit().getImage(</span>
<span class="nc" id="L387">                new MegaMekFile(Configuration.miscImagesDir(), FILENAME_ICON_16X16).toString()</span>
        ));
<span class="nc" id="L389">        iconList.add(frame.getToolkit().getImage(</span>
<span class="nc" id="L390">                new MegaMekFile(Configuration.miscImagesDir(), FILENAME_ICON_32X32).toString()</span>
        ));
<span class="nc" id="L392">        iconList.add(frame.getToolkit().getImage(</span>
<span class="nc" id="L393">                new MegaMekFile(Configuration.miscImagesDir(), FILENAME_ICON_48X48).toString()</span>
        ));
<span class="nc" id="L395">        iconList.add(frame.getToolkit().getImage(</span>
<span class="nc" id="L396">                new MegaMekFile(Configuration.miscImagesDir(), FILENAME_ICON_256X256).toString()</span>
        ));
<span class="nc" id="L398">        frame.setIconImages(iconList);</span>
<span class="nc" id="L399">    }</span>

    /**
     * Lays out the frame by setting this Client object to take up the full
     * frame display area.
     */
    private void layoutFrame() {
<span class="nc" id="L406">        frame.setTitle(client.getName() + Messages.getString(&quot;ClientGUI.clientTitleSuffix&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L407">        frame.getContentPane().setLayout(new BorderLayout());</span>
<span class="nc" id="L408">        frame.getContentPane().add(this, BorderLayout.CENTER);</span>
<span class="nc" id="L409">        frame.validate();</span>
<span class="nc" id="L410">    }</span>

    /**
     * Have the client register itself as a listener wherever it's needed.
     * &lt;p/&gt;
     * According to
     * http://www-106.ibm.com/developerworks/java/library/j-jtp0618.html it is a
     * major bad no-no to perform these registrations before the constructor
     * finishes, so this function has to be called after the &lt;code&gt;Client&lt;/code&gt;
     * is created.
     */
    public void initialize() {
<span class="nc" id="L422">        menuBar = new CommonMenuBar(getClient());</span>
<span class="nc" id="L423">        initializeFrame();</span>
        try {
<span class="nc" id="L425">            client.getGame().addGameListener(gameListener);</span>
            // Create the board viewer.
<span class="nc" id="L427">            bv = new BoardView1(client.getGame(), controller, this);</span>
<span class="nc" id="L428">            bv.setPreferredSize(getSize());</span>
<span class="nc" id="L429">            bvc = bv.getComponent();</span>
<span class="nc" id="L430">            bvc.setName(&quot;BoardView&quot;);</span>
<span class="nc" id="L431">            bv.addBoardViewListener(this);</span>
<span class="nc" id="L432">            client.setBoardView(bv);</span>
<span class="nc" id="L433">        } catch (Exception e) {</span>
<span class="nc" id="L434">            MegaMek.getLogger().fatal(e);</span>
<span class="nc" id="L435">            doAlertDialog(Messages.getString(&quot;ClientGUI.FatalError.title&quot;),</span>
<span class="nc" id="L436">                    Messages.getString(&quot;ClientGUI.FatalError.message&quot;) + e);</span>
<span class="nc" id="L437">            die();</span>
<span class="nc" id="L438">        }</span>

<span class="nc" id="L440">        layoutFrame();</span>
<span class="nc" id="L441">        menuBar.addActionListener(this);</span>
<span class="nc" id="L442">        frame.setDefaultCloseOperation(WindowConstants.DO_NOTHING_ON_CLOSE);</span>
<span class="nc" id="L443">        frame.addWindowListener(new WindowAdapter() {</span>
            @Override
            public void windowClosing(WindowEvent e) {
<span class="nc" id="L446">                ignoreHotKeys = true;</span>
<span class="nc" id="L447">                int savePrompt = JOptionPane.showConfirmDialog(null,</span>
                        &quot;Do you want to save the game before quitting MegaMek?&quot;,
                        &quot;Save First?&quot;,
                        JOptionPane.YES_NO_CANCEL_OPTION,
                        JOptionPane.WARNING_MESSAGE);
<span class="nc" id="L452">                ignoreHotKeys = false;</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">                if (savePrompt == JOptionPane.YES_OPTION) {</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">                    if (!saveGame()) {</span>
                        // When the user did not actually save the game, don't close MM
<span class="nc" id="L456">                        return;</span>
                    }
                }
<span class="nc bnc" id="L459" title="All 4 branches missed.">                if ((savePrompt == JOptionPane.NO_OPTION) || (savePrompt == JOptionPane.YES_OPTION)) {</span>
<span class="nc" id="L460">                    frame.setVisible(false);</span>
<span class="nc" id="L461">                    saveSettings();</span>
<span class="nc" id="L462">                    die();</span>
                }
<span class="nc" id="L464">            }</span>
        });
<span class="nc" id="L466">        cb2 = new ChatterBox2(this, bv, controller);</span>
<span class="nc" id="L467">        bv.addDisplayable(cb2);</span>
<span class="nc" id="L468">        bv.addKeyListener(cb2);</span>
<span class="nc" id="L469">        uo = new UnitOverview(this);</span>
<span class="nc" id="L470">        offBoardOverlay = new OffBoardTargetOverlay(this);</span>

<span class="nc" id="L472">        aw = new AccessibilityWindow(this);</span>
<span class="nc" id="L473">        aw.setLocation(0, 0);</span>
<span class="nc" id="L474">        aw.addWindowListener(this);</span>
<span class="nc" id="L475">        aw.setSize(300, 300);</span>

<span class="nc" id="L477">        bv.addDisplayable(uo);</span>
<span class="nc" id="L478">        bv.addDisplayable(offBoardOverlay);</span>
        int x;
        int y;
        int h;
        int w;
<span class="nc" id="L483">        mechW = new JDialog(frame, Messages.getString(&quot;ClientGUI.MechDisplay&quot;), false) {</span>
            /**
             * In addition to the default Dialog processKeyEvent, this method
             * dispatches a KeyEvent to the client gui.
             * This enables all of the gui hotkeys.
             */
            @Override
            protected void processKeyEvent(KeyEvent e) {
                //menuBar.dispatchEvent(e);
                // Make the source be the ClientGUI and not the dialog
                // This prevents a ClassCastException in ToolTipManager
<span class="nc" id="L494">                e.setSource(ClientGUI.this);</span>
<span class="nc" id="L495">                curPanel.dispatchEvent(e);</span>
<span class="nc bnc" id="L496" title="All 2 branches missed.">                if (!e.isConsumed()) {</span>
<span class="nc" id="L497">                    super.processKeyEvent(e);</span>
                }
<span class="nc" id="L499">            }</span>
        };
<span class="nc" id="L501">        Rectangle virtualBounds = getVirtualBounds();</span>
<span class="nc" id="L502">        x = GUIPreferences.getInstance().getDisplayPosX();</span>
<span class="nc" id="L503">        y = GUIPreferences.getInstance().getDisplayPosY();</span>
<span class="nc" id="L504">        h = GUIPreferences.getInstance().getDisplaySizeHeight();</span>
<span class="nc" id="L505">        w = GUIPreferences.getInstance().getDisplaySizeWidth();</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">        if ((x + w) &gt; virtualBounds.getWidth()) {</span>
<span class="nc" id="L507">            x = 0;</span>
<span class="nc" id="L508">            w = Math.min(w, (int)virtualBounds.getWidth());</span>
        }
<span class="nc bnc" id="L510" title="All 2 branches missed.">        if ((y + h) &gt; virtualBounds.getHeight()) {</span>
<span class="nc" id="L511">            y = 0;</span>
<span class="nc" id="L512">            h = Math.min(h, (int)virtualBounds.getHeight());</span>
        }
<span class="nc" id="L514">        mechW.setLocation(x, y);</span>
<span class="nc" id="L515">        mechW.setSize(w, h);</span>
<span class="nc" id="L516">        mechW.setResizable(true);</span>
<span class="nc" id="L517">        mechW.addWindowListener(this);</span>
<span class="nc" id="L518">        mechD = new UnitDisplay(this, controller);</span>
<span class="nc" id="L519">        mechD.addMechDisplayListener(bv);</span>
<span class="nc" id="L520">        mechW.add(mechD);</span>

<span class="nc" id="L522">        Ruler.color1 = GUIPreferences.getInstance().getRulerColor1();</span>
<span class="nc" id="L523">        Ruler.color2 = GUIPreferences.getInstance().getRulerColor2();</span>
<span class="nc" id="L524">        ruler = new Ruler(frame, client, bv);</span>
<span class="nc" id="L525">        x = GUIPreferences.getInstance().getRulerPosX();</span>
<span class="nc" id="L526">        y = GUIPreferences.getInstance().getRulerPosY();</span>
<span class="nc" id="L527">        h = GUIPreferences.getInstance().getRulerSizeHeight();</span>
<span class="nc" id="L528">        w = GUIPreferences.getInstance().getRulerSizeWidth();</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">        if ((x + w) &gt; virtualBounds.getWidth()) {</span>
<span class="nc" id="L530">            x = 0;</span>
<span class="nc" id="L531">            w = Math.min(w, (int)virtualBounds.getWidth());</span>
        }
<span class="nc bnc" id="L533" title="All 2 branches missed.">        if ((y + h) &gt; virtualBounds.getHeight()) {</span>
<span class="nc" id="L534">            y = 0;</span>
<span class="nc" id="L535">            h = Math.min(h, (int)virtualBounds.getHeight());</span>
        }
<span class="nc" id="L537">        ruler.setLocation(x, y);</span>
<span class="nc" id="L538">        ruler.setSize(w, h);</span>
        // minimap
<span class="nc" id="L540">        minimapW = new JDialog(frame, Messages.getString(&quot;ClientGUI.MiniMap&quot;), false) {</span>
            /**
             * In addition to the default Dialog processKeyEvent, this method
             * dispatches a KeyEvent to the client gui.
             * This enables all of the gui hotkeys.
             */
            @Override
            protected void processKeyEvent(KeyEvent e) {
                //menuBar.dispatchEvent(e);
<span class="nc" id="L549">                e.setSource(ClientGUI.this);// avoid ClassCastException in TooltipManager</span>
<span class="nc" id="L550">                curPanel.dispatchEvent(e);</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">                if (!e.isConsumed()) {</span>
<span class="nc" id="L552">                    super.processKeyEvent(e);</span>
                }
<span class="nc" id="L554">            }</span>
        };

<span class="nc" id="L557">        x = GUIPreferences.getInstance().getMinimapPosX();</span>
<span class="nc" id="L558">        y = GUIPreferences.getInstance().getMinimapPosY();</span>
        try {
<span class="nc" id="L560">            minimap = new MiniMap(minimapW, this, bv);</span>
<span class="nc" id="L561">        } catch (IOException e) {</span>
<span class="nc" id="L562">            MegaMek.getLogger().fatal(e);</span>
<span class="nc" id="L563">            doAlertDialog(Messages.getString(&quot;ClientGUI.FatalError.title&quot;),</span>
<span class="nc" id="L564">                    Messages.getString(&quot;ClientGUI.FatalError.message1&quot;) + e);</span>
<span class="nc" id="L565">            die();</span>
<span class="nc" id="L566">        }</span>
<span class="nc" id="L567">        h = minimap.getSize().height;</span>
<span class="nc" id="L568">        w = minimap.getSize().width;</span>
<span class="nc bnc" id="L569" title="All 4 branches missed.">        if (((x + 10) &gt;= virtualBounds.getWidth()) || ((x + w) &lt; 10)) {</span>
<span class="nc" id="L570">            x = (int)virtualBounds.getWidth() - w;</span>
        }
<span class="nc bnc" id="L572" title="All 4 branches missed.">        if (((y + 10) &gt; virtualBounds.getHeight()) || ((y + h) &lt; 10)) {</span>
<span class="nc" id="L573">            y = (int)virtualBounds.getHeight() - h;</span>
        }
<span class="nc" id="L575">        minimapW.setLocation(x, y);</span>
<span class="nc" id="L576">        minimapW.addWindowListener(this);</span>
<span class="nc" id="L577">        minimapW.add(minimap);</span>
<span class="nc" id="L578">        cb = new ChatterBox(this);</span>
<span class="nc" id="L579">        cb.setChatterBox2(cb2);</span>
<span class="nc" id="L580">        cb2.setChatterBox(cb);</span>
<span class="nc" id="L581">        client.changePhase(IGame.Phase.PHASE_UNKNOWN);</span>
<span class="nc" id="L582">        UnitLoadingDialog unitLoadingDialog = new UnitLoadingDialog(frame);</span>
<span class="nc bnc" id="L583" title="All 2 branches missed.">        if (!MechSummaryCache.getInstance().isInitialized()) {</span>
<span class="nc" id="L584">            unitLoadingDialog.setVisible(true);</span>
        }
<span class="nc" id="L586">        mechSelectorDialog = new MegaMekUnitSelectorDialog(this, unitLoadingDialog);</span>
<span class="nc" id="L587">        randomArmyDialog = new RandomArmyDialog(this);</span>
<span class="nc" id="L588">        randomSkillDialog = new RandomSkillDialog(this);</span>
<span class="nc" id="L589">        new Thread(mechSelectorDialog, &quot;Mech Selector Dialog&quot;).start();</span>
<span class="nc" id="L590">        frame.setVisible(true);</span>
<span class="nc" id="L591">    }</span>

    /**
     * Get the menu bar for this client.
     *
     * @return the &lt;code&gt;CommonMenuBar&lt;/code&gt; of this client.
     */
    public CommonMenuBar getMenuBar() {
<span class="nc" id="L599">        return menuBar;</span>
    }

    /**
     * Called when the user selects the &quot;Help-&gt;About&quot; menu item.
     */
    private void showAbout() {
        // Do we need to create the &quot;about&quot; dialog?
<span class="nc bnc" id="L607" title="All 2 branches missed.">        if (about == null) {</span>
<span class="nc" id="L608">            about = new CommonAboutDialog(frame);</span>
        }

        // Show the about dialog.
<span class="nc" id="L612">        about.setVisible(true);</span>
<span class="nc" id="L613">    }</span>

    /**
     * Called when the user selects the &quot;Help-&gt;Contents&quot; menu item.
     * &lt;p/&gt;
     * This method can be called by subclasses.
     */
    private void showHelp() {
        // Do we need to create the &quot;help&quot; dialog?
<span class="nc bnc" id="L622" title="All 2 branches missed.">        if (help == null) {</span>
<span class="nc" id="L623">            help = new CommonHelpDialog(frame, new File(helpFileName));</span>
        }
        // Show the help dialog.
<span class="nc" id="L626">        help.setVisible(true);</span>
<span class="nc" id="L627">    }</span>

    private void showSkinningHowTo(){
        try {
            // Get the correct help file.
<span class="nc" id="L632">            StringBuilder helpPath = new StringBuilder(&quot;file:///&quot;);</span>
<span class="nc" id="L633">            helpPath.append(System.getProperty(&quot;user.dir&quot;));</span>
<span class="nc bnc" id="L634" title="All 2 branches missed.">            if (!helpPath.toString().endsWith(File.separator)) {</span>
<span class="nc" id="L635">                helpPath.append(File.separator);</span>
            }
<span class="nc" id="L637">            helpPath.append(Messages.getString(&quot;ClientGUI.skinningHelpPath&quot;));</span>
<span class="nc" id="L638">            URL helpUrl = new URL(helpPath.toString());</span>

            // Launch the help dialog.
<span class="nc" id="L641">            HelpDialog helpDialog = new HelpDialog(</span>
<span class="nc" id="L642">                    Messages.getString(&quot;ClientGUI.skinningHelpPath.title&quot;),</span>
                    helpUrl);
<span class="nc" id="L644">            helpDialog.setVisible(true);</span>
<span class="nc" id="L645">        } catch (MalformedURLException e) {</span>
<span class="nc" id="L646">            JOptionPane.showMessageDialog(this, e.getMessage(), &quot;ERROR&quot;,</span>
                    JOptionPane.ERROR_MESSAGE);
<span class="nc" id="L648">            MegaMek.getLogger().error(e);</span>
<span class="nc" id="L649">        }</span>
<span class="nc" id="L650">    }</span>

    /**
     * Called when the user selects the &quot;View-&gt;Client Settings&quot; menu item.
     */
    private void showSettings() {
        // Do we need to create the &quot;settings&quot; dialog?
<span class="nc bnc" id="L657" title="All 2 branches missed.">        if (setdlg == null) {</span>
<span class="nc" id="L658">            setdlg = new CommonSettingsDialog(frame, this);</span>
        }

        // Show the settings dialog.
<span class="nc" id="L662">        setdlg.setVisible(true);</span>
<span class="nc" id="L663">    }</span>

    /**
     * Called when the user selects the &quot;View-&gt;Game Options&quot; menu item.
     */
    private void showOptions() {
<span class="nc bnc" id="L669" title="All 2 branches missed.">        if (client.getGame().getPhase() == IGame.Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L670">            getGameOptionsDialog().setEditable(true);</span>
        } else {
<span class="nc" id="L672">            getGameOptionsDialog().setEditable(false);</span>
        }
        // Display the game options dialog.
<span class="nc" id="L675">        getGameOptionsDialog().update(client.getGame().getOptions());</span>
<span class="nc" id="L676">        getGameOptionsDialog().setVisible(true);</span>
<span class="nc" id="L677">    }</span>

    public void customizePlayer() {
<span class="nc" id="L680">        PlayerSettingsDialog psd = new PlayerSettingsDialog(this, client);</span>
<span class="nc" id="L681">        psd.setVisible(true);</span>
<span class="nc" id="L682">    }</span>

    /**
     * Called when the user selects the &quot;View-&gt;Player List&quot; menu item.
     */
    private void showPlayerList() {
<span class="nc bnc" id="L688" title="All 2 branches missed.">        if (playerListDialog == null) {</span>
<span class="nc" id="L689">            playerListDialog = new PlayerListDialog(frame, client);</span>
        }
<span class="nc" id="L691">        playerListDialog.setVisible(true);</span>
<span class="nc" id="L692">    }</span>

    /**
     * Called when the user selects the &quot;View-&gt;Round Report&quot; menu item.
     */
    private void showRoundReport() {
<span class="nc" id="L698">        ignoreHotKeys = true;</span>
<span class="nc" id="L699">        new MiniReportDisplay(frame, client).setVisible(true);</span>
<span class="nc" id="L700">        ignoreHotKeys = false;</span>
<span class="nc" id="L701">    }</span>

    /**
     * Implement the &lt;code&gt;ActionListener&lt;/code&gt; interface.
     */
    public void actionPerformed(ActionEvent event) {
<span class="nc bnc" id="L707" title="All 39 branches missed.">        switch (event.getActionCommand()) {</span>
            case VIEW_RESET_WINDOW_POSITIONS:
<span class="nc" id="L709">                minimapW.setBounds(0, 0, minimapW.getWidth(), minimapW.getHeight());</span>
<span class="nc" id="L710">                mechW.setBounds(0, 0, mechD.getWidth(), mechD.getHeight());</span>
<span class="nc" id="L711">                break;</span>
            case FILE_GAME_SAVE:
<span class="nc" id="L713">                saveGame();</span>
<span class="nc" id="L714">                break;</span>
            case FILE_GAME_SAVE_SERVER:
<span class="nc" id="L716">                ignoreHotKeys = true;</span>
<span class="nc" id="L717">                String filename = (String) JOptionPane.showInputDialog(frame, Messages.getString(&quot;ClientGUI.FileSaveServerDialog.message&quot;), Messages.getString(&quot;ClientGUI.FileSaveServerDialog.title&quot;), JOptionPane.QUESTION_MESSAGE, null, null, &quot;savegame.sav&quot;);</span>
<span class="nc bnc" id="L718" title="All 2 branches missed.">                if (filename != null) {</span>
<span class="nc" id="L719">                    client.sendChat(&quot;/save &quot; + filename);</span>
                }
<span class="nc" id="L721">                ignoreHotKeys = false;</span>
<span class="nc" id="L722">                break;</span>
            case HELP_ABOUT:
<span class="nc" id="L724">                showAbout();</span>
<span class="nc" id="L725">                break;</span>
            case HELP_SKINNING:
<span class="nc" id="L727">                showSkinningHowTo();</span>
<span class="nc" id="L728">                break;</span>
            case HELP_CONTENTS:
<span class="nc" id="L730">                showHelp();</span>
<span class="nc" id="L731">                break;</span>
            case FILE_UNITS_SAVE:
<span class="nc" id="L733">                ignoreHotKeys = true;</span>
<span class="nc" id="L734">                doSaveUnit();</span>
<span class="nc" id="L735">                ignoreHotKeys = false;</span>
<span class="nc" id="L736">                break;</span>
            case FILE_UNITS_OPEN:
<span class="nc" id="L738">                ignoreHotKeys = true;</span>
<span class="nc" id="L739">                loadListFile();</span>
<span class="nc" id="L740">                ignoreHotKeys = false;</span>
<span class="nc" id="L741">                break;</span>
            case FILE_UNITS_CLEAR:
<span class="nc" id="L743">                deleteAllUnits(client);</span>
<span class="nc" id="L744">                break;</span>
            case FILE_UNITS_REINFORCE:
<span class="nc" id="L746">                ignoreHotKeys = true;</span>
<span class="nc" id="L747">                loadListFile(client.getLocalPlayer(), true);</span>
<span class="nc" id="L748">                ignoreHotKeys = false;</span>
<span class="nc" id="L749">                break;</span>
            case FILE_UNITS_REINFORCE_RAT:
<span class="nc" id="L751">                ignoreHotKeys = true;</span>
<span class="nc bnc" id="L752" title="All 2 branches missed.">                if (client.getLocalPlayer().getTeam() == IPlayer.TEAM_UNASSIGNED) {</span>
<span class="nc" id="L753">                    String title = Messages.getString(</span>
                            &quot;ClientGUI.openUnitListFileDialog.noReinforceTitle&quot;); //$NON-NLS-1$
<span class="nc" id="L755">                    String msg = Messages.getString(</span>
                            &quot;ClientGUI.openUnitListFileDialog.noReinforceMessage&quot;);  //$NON-NLS-1$
<span class="nc" id="L757">                    JOptionPane.showMessageDialog(frame, msg, title,</span>
                            JOptionPane.OK_OPTION, null);
<span class="nc" id="L759">                    return;</span>
                }
<span class="nc" id="L761">                getRandomArmyDialog().setVisible(true);</span>
<span class="nc" id="L762">                ignoreHotKeys = false;</span>
<span class="nc" id="L763">                break;</span>
            case VIEW_CLIENT_SETTINGS:
<span class="nc" id="L765">                showSettings();</span>
<span class="nc" id="L766">                break;</span>
            case VIEW_GAME_OPTIONS:
<span class="nc" id="L768">                showOptions();</span>
<span class="nc" id="L769">                break;</span>
            case VIEW_PLAYER_SETTINGS:
<span class="nc" id="L771">                customizePlayer();</span>
<span class="nc" id="L772">                break;</span>
            case VIEW_PLAYER_LIST:
<span class="nc" id="L774">                showPlayerList();</span>
<span class="nc" id="L775">                break;</span>
            case VIEW_ROUND_REPORT:
<span class="nc" id="L777">                showRoundReport();</span>
<span class="nc" id="L778">                break;</span>
            case FILE_BOARD_SAVE:
<span class="nc" id="L780">                ignoreHotKeys = true;</span>
<span class="nc" id="L781">                boardSave();</span>
<span class="nc" id="L782">                ignoreHotKeys = false;</span>
<span class="nc" id="L783">                break;</span>
            case FILE_BOARD_SAVE_AS:
<span class="nc" id="L785">                ignoreHotKeys = true;</span>
<span class="nc" id="L786">                boardSaveAs();</span>
<span class="nc" id="L787">                ignoreHotKeys = false;</span>
<span class="nc" id="L788">                break;</span>
            case FILE_BOARD_SAVE_AS_IMAGE:
<span class="nc" id="L790">                ignoreHotKeys = true;</span>
<span class="nc" id="L791">                boardSaveAsImage(true);</span>
<span class="nc" id="L792">                ignoreHotKeys = false;</span>
<span class="nc" id="L793">                break;</span>
            case FILE_BOARD_SAVE_AS_IMAGE_UNITS:
<span class="nc" id="L795">                ignoreHotKeys = true;</span>
<span class="nc" id="L796">                boardSaveAsImage(false);</span>
<span class="nc" id="L797">                ignoreHotKeys = false;</span>
<span class="nc" id="L798">                break;</span>
            case FILE_GAME_REPLACE_PLAYER:
<span class="nc" id="L800">                replacePlayer();</span>
<span class="nc" id="L801">                break;</span>
            case VIEW_MEK_DISPLAY:
<span class="nc" id="L803">                toggleDisplay();</span>
<span class="nc" id="L804">                break;</span>
            case VIEW_ACCESSIBILITY_WINDOW:
<span class="nc" id="L806">                toggleAccessibilityWindow();</span>
<span class="nc" id="L807">                break;</span>
            case VIEW_KEYBINDS_OVERLAY:
<span class="nc" id="L809">                bv.toggleKeybindsOverlay();</span>
<span class="nc" id="L810">                break;</span>
            case VIEW_MINI_MAP:
<span class="nc" id="L812">                toggleMap();</span>
<span class="nc" id="L813">                break;</span>
            case VIEW_UNIT_OVERVIEW:
<span class="nc" id="L815">                toggleUnitOverview();</span>
<span class="nc" id="L816">                break;</span>
            case VIEW_LOS_SETTING:
<span class="nc" id="L818">                showLOSSettingDialog();</span>
<span class="nc" id="L819">                break;</span>
            case VIEW_ZOOM_IN:
<span class="nc" id="L821">                bv.zoomIn();</span>
<span class="nc" id="L822">                break;</span>
            case VIEW_ZOOM_OUT:
<span class="nc" id="L824">                bv.zoomOut();</span>
<span class="nc" id="L825">                break;</span>
            case VIEW_TOGGLE_ISOMETRIC:
<span class="nc" id="L827">                GUIPreferences.getInstance().setIsometricEnabled(bv.toggleIsometric());</span>
<span class="nc" id="L828">                break;</span>
            case VIEW_TOGGLE_FOV_HIGHLIGHT:
<span class="nc" id="L830">                GUIPreferences.getInstance().setFovHighlight(</span>
<span class="nc bnc" id="L831" title="All 2 branches missed.">                        !GUIPreferences.getInstance().getFovHighlight());</span>
<span class="nc" id="L832">                bv.refreshDisplayables();</span>
<span class="nc bnc" id="L833" title="All 2 branches missed.">                if (client.getGame().getPhase() == Phase.PHASE_MOVEMENT) {</span>
<span class="nc" id="L834">                    bv.clearHexImageCache();</span>
                }
                break;
            case VIEW_TOGGLE_FIELD_OF_FIRE:
<span class="nc" id="L838">                GUIPreferences.getInstance().setShowFieldOfFire(</span>
<span class="nc bnc" id="L839" title="All 2 branches missed.">                        !GUIPreferences.getInstance().getShowFieldOfFire());</span>
<span class="nc" id="L840">                bv.repaint();</span>
<span class="nc" id="L841">                break;</span>
            case VIEW_TOGGLE_FOV_DARKEN:
<span class="nc bnc" id="L843" title="All 2 branches missed.">                GUIPreferences.getInstance().setFovDarken(!GUIPreferences.getInstance().getFovDarken());</span>
<span class="nc" id="L844">                bv.refreshDisplayables();</span>
<span class="nc bnc" id="L845" title="All 2 branches missed.">                if (client.getGame().getPhase() == Phase.PHASE_MOVEMENT) {</span>
<span class="nc" id="L846">                    bv.clearHexImageCache();</span>
                }
                break;
            case VIEW_TOGGLE_FIRING_SOLUTIONS:
<span class="nc" id="L850">                GUIPreferences.getInstance().setFiringSolutions(</span>
<span class="nc bnc" id="L851" title="All 2 branches missed.">                        !GUIPreferences.getInstance().getFiringSolutions());</span>
<span class="nc bnc" id="L852" title="All 2 branches missed.">                if (!GUIPreferences.getInstance().getFiringSolutions()) {</span>
<span class="nc" id="L853">                    bv.clearFiringSolutionData();</span>
                } else {
<span class="nc bnc" id="L855" title="All 2 branches missed.">                    if (curPanel instanceof FiringDisplay) {</span>
<span class="nc" id="L856">                        ((FiringDisplay) curPanel).setFiringSolutions();</span>
                    }
                }
<span class="nc" id="L859">                bv.refreshDisplayables();</span>
<span class="nc" id="L860">                break;</span>
            case VIEW_MOVE_ENV:
<span class="nc bnc" id="L862" title="All 2 branches missed.">                if (curPanel instanceof MovementDisplay) {</span>
<span class="nc" id="L863">                    GUIPreferences.getInstance().setMoveEnvelope(</span>
<span class="nc bnc" id="L864" title="All 2 branches missed.">                            !GUIPreferences.getInstance().getMoveEnvelope());</span>
<span class="nc" id="L865">                    ((MovementDisplay) curPanel).computeMovementEnvelope(mechD.getCurrentEntity());</span>
                }
                break;
            case VIEW_MOVE_MOD_ENV:
<span class="nc bnc" id="L869" title="All 2 branches missed.">                if (curPanel instanceof MovementDisplay) {</span>
<span class="nc" id="L870">                    ((MovementDisplay) curPanel).computeModifierEnvelope();</span>
                }
                break;
            case VIEW_CHANGE_THEME:
<span class="nc" id="L874">                bv.changeTheme();</span>
<span class="nc" id="L875">                break;</span>
            case FIRE_SAVE_WEAPON_ORDER:
<span class="nc" id="L877">                Entity ent = mechD.getCurrentEntity();</span>
<span class="nc bnc" id="L878" title="All 2 branches missed.">                if (ent != null) {</span>
<span class="nc" id="L879">                    WeaponOrderHandler.setWeaponOrder(ent.getChassis(),</span>
<span class="nc" id="L880">                            ent.getModel(), ent.getWeaponSortOrder(),</span>
<span class="nc" id="L881">                            ent.getCustomWeaponOrder());</span>
<span class="nc" id="L882">                    getMenuBar().updateSaveWeaponOrderMenuItem();</span>
<span class="nc" id="L883">                    client.sendEntityWeaponOrderUpdate(ent);</span>
                }
                break;
        }
<span class="nc" id="L887">    }</span>

    /**
     * Save all the current in use Entities each grouped by
     * player name
     * &lt;p/&gt;
     * and a file for salvage
     */
    public void doSaveUnit() {
<span class="nc bnc" id="L896" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; iter = getClient().getGame().getPlayers(); iter.hasMoreElements(); ) {</span>
<span class="nc" id="L897">            IPlayer p = iter.nextElement();</span>
<span class="nc" id="L898">            ArrayList&lt;Entity&gt; l = getClient().getGame().getPlayerEntities(p, false);</span>
            // Be sure to include all units that have retreated.
<span class="nc bnc" id="L900" title="All 2 branches missed.">            for (Enumeration&lt;Entity&gt; iter2 = getClient().getGame().getRetreatedEntities(); iter2.hasMoreElements(); ) {</span>
<span class="nc" id="L901">                Entity e = iter2.nextElement();</span>
<span class="nc bnc" id="L902" title="All 2 branches missed.">                if (e.getOwnerId() == p.getId()) {</span>
<span class="nc" id="L903">                    l.add(e);</span>
                }
<span class="nc" id="L905">            }</span>
<span class="nc" id="L906">            saveListFile(l, p.getName());</span>
<span class="nc" id="L907">        }</span>

        // save all destroyed units in a separate &quot;salvage MUL&quot;
<span class="nc" id="L910">        ArrayList&lt;Entity&gt; destroyed = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L911">        Enumeration&lt;Entity&gt; graveyard = getClient().getGame().getGraveyardEntities();</span>
<span class="nc bnc" id="L912" title="All 2 branches missed.">        while (graveyard.hasMoreElements()) {</span>
<span class="nc" id="L913">            Entity entity = graveyard.nextElement();</span>
<span class="nc bnc" id="L914" title="All 2 branches missed.">            if (entity.isSalvage()) {</span>
<span class="nc" id="L915">                destroyed.add(entity);</span>
            }
<span class="nc" id="L917">        }</span>
<span class="nc bnc" id="L918" title="All 2 branches missed.">        if (destroyed.size() &gt; 0) {</span>
<span class="nc" id="L919">            String sLogDir = PreferenceManager.getClientPreferences().getLogDirectory();</span>
<span class="nc" id="L920">            File logDir = new File(sLogDir);</span>
<span class="nc bnc" id="L921" title="All 2 branches missed.">            if (!logDir.exists()) {</span>
<span class="nc" id="L922">                logDir.mkdir();</span>
            }
<span class="nc" id="L924">            String fileName = &quot;salvage.mul&quot;;</span>
<span class="nc bnc" id="L925" title="All 2 branches missed.">            if (PreferenceManager.getClientPreferences().stampFilenames()) {</span>
<span class="nc" id="L926">                fileName = StringUtil.addDateTimeStamp(fileName);</span>
            }
<span class="nc" id="L928">            File unitFile = new File(sLogDir + File.separator + fileName);</span>
            try {
                // Save the destroyed entities to the file.
<span class="nc" id="L931">                EntityListFile.saveTo(unitFile, destroyed);</span>
<span class="nc" id="L932">            } catch (IOException e) {</span>
<span class="nc" id="L933">                MegaMek.getLogger().error(e);</span>
<span class="nc" id="L934">                doAlertDialog(Messages.getString(&quot;ClientGUI.errorSavingFile&quot;), e.getMessage());</span>
<span class="nc" id="L935">            }</span>
        }
<span class="nc" id="L937">    }</span>


    /**
     * Saves the current settings to the cfg file.
     */
    void saveSettings() {
        // save frame location
<span class="nc" id="L945">        GUIPreferences.getInstance().setWindowPosX(frame.getLocation().x);</span>
<span class="nc" id="L946">        GUIPreferences.getInstance().setWindowPosY(frame.getLocation().y);</span>
<span class="nc" id="L947">        GUIPreferences.getInstance().setWindowSizeWidth(frame.getSize().width);</span>
<span class="nc" id="L948">        GUIPreferences.getInstance().setWindowSizeHeight(frame.getSize().height);</span>

        // also minimap
<span class="nc bnc" id="L951" title="All 4 branches missed.">        if ((minimapW != null) &amp;&amp; ((minimapW.getSize().width * minimapW.getSize().height) &gt; 0)) {</span>
<span class="nc" id="L952">            GUIPreferences.getInstance().setMinimapPosX(minimapW.getLocation().x);</span>
<span class="nc" id="L953">            GUIPreferences.getInstance().setMinimapPosY(minimapW.getLocation().y);</span>
<span class="nc" id="L954">            GUIPreferences.getInstance().setMinimapZoom(minimap.getZoom());</span>
        }

        // also mech display
<span class="nc bnc" id="L958" title="All 4 branches missed.">        if ((mechW != null) &amp;&amp; ((mechW.getSize().width * mechW.getSize().height) &gt; 0)) {</span>
<span class="nc" id="L959">            GUIPreferences.getInstance().setDisplayPosX(mechW.getLocation().x);</span>
<span class="nc" id="L960">            GUIPreferences.getInstance().setDisplayPosY(mechW.getLocation().y);</span>
<span class="nc" id="L961">            GUIPreferences.getInstance().setDisplaySizeWidth(mechW.getSize().width);</span>
<span class="nc" id="L962">            GUIPreferences.getInstance().setDisplaySizeHeight(mechW.getSize().height);</span>
        }

        // also ruler display
<span class="nc bnc" id="L966" title="All 6 branches missed.">        if ((ruler != null) &amp;&amp; (ruler.getSize().width != 0) &amp;&amp; (ruler.getSize().height != 0)) {</span>
<span class="nc" id="L967">            GUIPreferences.getInstance().setRulerPosX(ruler.getLocation().x);</span>
<span class="nc" id="L968">            GUIPreferences.getInstance().setRulerPosY(ruler.getLocation().y);</span>
<span class="nc" id="L969">            GUIPreferences.getInstance().setRulerSizeWidth(ruler.getSize().width);</span>
<span class="nc" id="L970">            GUIPreferences.getInstance().setRulerSizeHeight(ruler.getSize().height);</span>
        }
<span class="nc" id="L972">    }</span>

    /**
     * Shuts down threads and sockets
     */
    void die() {
        // Tell all the displays to remove themselves as listeners.
<span class="nc" id="L979">        boolean reportHandled = false;</span>
<span class="nc bnc" id="L980" title="All 2 branches missed.">        if (bv != null) {</span>
            //cleanup our timers first
<span class="nc" id="L982">            bv.die();</span>
        }
<span class="nc bnc" id="L984" title="All 2 branches missed.">        for (String s : phaseComponents.keySet()) {</span>
<span class="nc" id="L985">            JComponent component = phaseComponents.get(s);</span>
<span class="nc bnc" id="L986" title="All 2 branches missed.">            if (component instanceof ReportDisplay) {</span>
<span class="nc bnc" id="L987" title="All 2 branches missed.">                if (reportHandled) {</span>
<span class="nc" id="L988">                    continue;</span>
                }
<span class="nc" id="L990">                reportHandled = true;</span>
            }
<span class="nc bnc" id="L992" title="All 2 branches missed.">            if (component instanceof Distractable) {</span>
<span class="nc" id="L993">                ((Distractable) component).removeAllListeners();</span>
            }
<span class="nc" id="L995">        } // Handle the next component</span>
<span class="nc" id="L996">        phaseComponents.clear();</span>

<span class="nc" id="L998">        frame.removeAll();</span>
<span class="nc" id="L999">        frame.setVisible(false);</span>
        try {
<span class="nc" id="L1001">            frame.dispose();</span>
<span class="nc" id="L1002">        } catch (Throwable error) {</span>
<span class="nc" id="L1003">            error.printStackTrace();</span>
<span class="nc" id="L1004">        }</span>
<span class="nc" id="L1005">        client.die();</span>

        // TODO Is there a better solution?
        // This is required because the ChatLounge adds the listener to the
        // MechSummaryCache that must be removed explicitly.
<span class="nc bnc" id="L1010" title="All 2 branches missed.">        if (chatlounge != null) {</span>
<span class="nc" id="L1011">            chatlounge.die();</span>
        }
<span class="nc" id="L1013">        TimerSingleton.getInstance().killTimer();</span>

<span class="nc bnc" id="L1015" title="All 2 branches missed.">        if (controller != null) {</span>
<span class="nc" id="L1016">            controller.removeAllActions();</span>
<span class="nc" id="L1017">            controller.clientgui = null;</span>
        }

<span class="nc bnc" id="L1020" title="All 2 branches missed.">        if (menuBar != null) {</span>
<span class="nc" id="L1021">            menuBar.die();</span>
<span class="nc" id="L1022">            menuBar = null;</span>
        }
<span class="nc" id="L1024">    }</span>

    public GameOptionsDialog getGameOptionsDialog() {
<span class="nc bnc" id="L1027" title="All 2 branches missed.">        if (gameOptionsDialog == null) {</span>
<span class="nc" id="L1028">            gameOptionsDialog = new GameOptionsDialog(this);</span>
        }
<span class="nc" id="L1030">        return gameOptionsDialog;</span>
    }

    public AbstractUnitSelectorDialog getMechSelectorDialog() {
<span class="nc" id="L1034">        return mechSelectorDialog;</span>
    }

    public StartingPositionDialog getStartingPositionDialog() {
<span class="nc bnc" id="L1038" title="All 2 branches missed.">        if (startingPositionDialog == null) {</span>
<span class="nc" id="L1039">            startingPositionDialog = new StartingPositionDialog(this);</span>
        }
<span class="nc" id="L1041">        return startingPositionDialog;</span>
    }

    public PlanetaryConditionsDialog getPlanetaryConditionsDialog() {
<span class="nc bnc" id="L1045" title="All 2 branches missed.">        if (conditionsDialog == null) {</span>
<span class="nc" id="L1046">            conditionsDialog = new PlanetaryConditionsDialog(this);</span>
        }
<span class="nc" id="L1048">        return conditionsDialog;</span>
    }

    void switchPanel(IGame.Phase phase) {
        // Clear the old panel's listeners.
<span class="nc bnc" id="L1053" title="All 2 branches missed.">        if (curPanel instanceof BoardViewListener) {</span>
<span class="nc" id="L1054">            bv.removeBoardViewListener((BoardViewListener) curPanel);</span>
        }
<span class="nc bnc" id="L1056" title="All 2 branches missed.">        if (curPanel instanceof ActionListener) {</span>
<span class="nc" id="L1057">            menuBar.removeActionListener((ActionListener) curPanel);</span>
        }
<span class="nc bnc" id="L1059" title="All 2 branches missed.">        if (curPanel instanceof Distractable) {</span>
<span class="nc" id="L1060">            ((Distractable) curPanel).setIgnoringEvents(true);</span>
        }

        // Get the new panel.
<span class="nc" id="L1064">        String name = String.valueOf(phase);</span>
<span class="nc" id="L1065">        curPanel = phaseComponents.get(name);</span>
<span class="nc bnc" id="L1066" title="All 2 branches missed.">        if (curPanel == null) {</span>
<span class="nc" id="L1067">            curPanel = initializePanel(phase);</span>
        }

        // Handle phase-specific items.
<span class="nc bnc" id="L1071" title="All 4 branches missed.">        switch (phase) {</span>
            case PHASE_LOUNGE:
                // reset old report tabs and images, if any
<span class="nc" id="L1074">                ReportDisplay rD = (ReportDisplay) phaseComponents.get(String.valueOf(IGame.Phase.PHASE_INITIATIVE_REPORT));</span>
<span class="nc bnc" id="L1075" title="All 2 branches missed.">                if (rD != null) {</span>
<span class="nc" id="L1076">                    rD.resetTabs();</span>
                }
<span class="nc" id="L1078">                ChatLounge cl = (ChatLounge) phaseComponents.get(String.valueOf(IGame.Phase.PHASE_LOUNGE));</span>
<span class="nc" id="L1079">                cb.setDoneButton(cl.butDone);</span>
<span class="nc" id="L1080">                cl.add(cb.getComponent(), BorderLayout.SOUTH);</span>
<span class="nc" id="L1081">                getBoardView().getTilesetManager().reset();</span>
<span class="nc" id="L1082">                mechW.setVisible(false);</span>
<span class="nc" id="L1083">                setMapVisible(false);</span>
<span class="nc" id="L1084">                break;</span>
            case PHASE_POINTBLANK_SHOT:
            case PHASE_SET_ARTYAUTOHITHEXES:
            case PHASE_DEPLOY_MINEFIELDS:
            case PHASE_DEPLOYMENT:
            case PHASE_TARGETING:
            case PHASE_MOVEMENT:
            case PHASE_OFFBOARD:
            case PHASE_FIRING:
            case PHASE_PHYSICAL:
<span class="nc bnc" id="L1094" title="All 4 branches missed.">                if (GUIPreferences.getInstance().getMinimapEnabled() &amp;&amp; !minimapW.isVisible()) {</span>
<span class="nc" id="L1095">                    setMapVisible(true);</span>
                }
                break;
            case PHASE_INITIATIVE_REPORT:
            case PHASE_TARGETING_REPORT:
            case PHASE_MOVEMENT_REPORT:
            case PHASE_OFFBOARD_REPORT:
            case PHASE_FIRING_REPORT:
            case PHASE_PHYSICAL_REPORT:
            case PHASE_END_REPORT:
            case PHASE_VICTORY:
<span class="nc" id="L1106">                rD = (ReportDisplay) phaseComponents.get(String.valueOf(IGame.Phase.PHASE_INITIATIVE_REPORT));</span>
<span class="nc" id="L1107">                cb.setDoneButton(rD.butDone);</span>
<span class="nc" id="L1108">                rD.add(cb.getComponent(), GBC.eol().fill(GridBagConstraints.HORIZONTAL));</span>
<span class="nc" id="L1109">                setMapVisible(false);</span>
<span class="nc" id="L1110">                mechW.setVisible(false);</span>
<span class="nc" id="L1111">                break;</span>
            default:
                break;
        }

<span class="nc" id="L1116">        cardsMain.show(panMain, mainNames.get(name));</span>
<span class="nc" id="L1117">        String secondaryToShow = secondaryNames.get(name);</span>
        // only show the secondary component if there is one to show
<span class="nc bnc" id="L1119" title="All 2 branches missed.">        if (secondaryToShow != null) {</span>
<span class="nc" id="L1120">            panSecondary.setVisible(true);</span>
<span class="nc" id="L1121">            cardsSecondary.show(panSecondary, secondaryNames.get(name));</span>
        } else {
            // otherwise, hide the panel
<span class="nc" id="L1124">            panSecondary.setVisible(false);</span>
        }

        // Set the new panel's listeners
<span class="nc bnc" id="L1128" title="All 2 branches missed.">        if (curPanel instanceof BoardViewListener) {</span>
<span class="nc" id="L1129">            bv.addBoardViewListener((BoardViewListener) curPanel);</span>
        }
<span class="nc bnc" id="L1131" title="All 2 branches missed.">        if (curPanel instanceof ActionListener) {</span>
<span class="nc" id="L1132">            menuBar.addActionListener((ActionListener) curPanel);</span>
        }
<span class="nc bnc" id="L1134" title="All 2 branches missed.">        if (curPanel instanceof Distractable) {</span>
<span class="nc" id="L1135">            ((Distractable) curPanel).setIgnoringEvents(false);</span>
        }

        // Make the new panel the focus, if the Client option says so
<span class="nc bnc" id="L1139" title="All 4 branches missed.">        if (GUIPreferences.getInstance().getFocus() &amp;&amp; !(client instanceof TestBot)) {</span>
<span class="nc" id="L1140">            curPanel.requestFocus();</span>
        }
<span class="nc" id="L1142">    }</span>

    public void updateButtonPanel(IGame.Phase phase) {
<span class="nc bnc" id="L1145" title="All 2 branches missed.">        if ((currPhaseDisplay != null)</span>
<span class="nc bnc" id="L1146" title="All 2 branches missed.">                &amp;&amp; client.getGame().getPhase().equals(phase)) {</span>
<span class="nc" id="L1147">            currPhaseDisplay.setupButtonPanel();</span>
        }
<span class="nc" id="L1149">    }</span>

    private JComponent initializePanel(IGame.Phase phase) {
        // Create the components for this phase.
<span class="nc" id="L1153">        String name = String.valueOf(phase);</span>
        JComponent component;
<span class="nc" id="L1155">        String secondary = null;</span>
        String main;
<span class="nc bnc" id="L1157" title="All 15 branches missed.">        switch (phase) {</span>
            case PHASE_LOUNGE:
<span class="nc" id="L1159">                component = new ChatLounge(this);</span>
<span class="nc" id="L1160">                chatlounge = (ChatLounge) component;</span>
<span class="nc" id="L1161">                main = &quot;ChatLounge&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1162">                component.setName(main);</span>
<span class="nc" id="L1163">                panMain.add(component, main);</span>
<span class="nc" id="L1164">                break;</span>
            case PHASE_STARTING_SCENARIO:
<span class="nc" id="L1166">                component = new JLabel(Messages.getString(&quot;ClientGUI.StartingScenario&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1167">                main = &quot;JLabel-StartingScenario&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1168">                component.setName(main);</span>
<span class="nc" id="L1169">                panMain.add(component, main);</span>
<span class="nc" id="L1170">                break;</span>
            case PHASE_EXCHANGE:
<span class="nc" id="L1172">                component = new JLabel(Messages.getString(&quot;ClientGUI.TransmittingData&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1173">                main = &quot;JLabel-Exchange&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1174">                component.setName(main);</span>
<span class="nc" id="L1175">                panMain.add(component, main);</span>
<span class="nc" id="L1176">                break;</span>
            case PHASE_SET_ARTYAUTOHITHEXES:
<span class="nc" id="L1178">                component = new SelectArtyAutoHitHexDisplay(this);</span>
<span class="nc" id="L1179">                main = &quot;BoardView&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1180">                secondary = &quot;SelectArtyAutoHitHexDisplay&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1181">                component.setName(secondary);</span>
<span class="nc bnc" id="L1182" title="All 2 branches missed.">                if (!mainNames.containsValue(main)) {</span>
<span class="nc" id="L1183">                    panMain.add(bvc, main);</span>
                }
<span class="nc" id="L1185">                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</span>
<span class="nc" id="L1186">                panSecondary.add(component, secondary);</span>
<span class="nc" id="L1187">                break;</span>
            case PHASE_DEPLOY_MINEFIELDS:
<span class="nc" id="L1189">                component = new DeployMinefieldDisplay(this);</span>
<span class="nc" id="L1190">                main = &quot;BoardView&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1191">                secondary = &quot;DeployMinefieldDisplay&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1192">                component.setName(secondary);</span>
<span class="nc bnc" id="L1193" title="All 2 branches missed.">                if (!mainNames.containsValue(main)) {</span>
<span class="nc" id="L1194">                    panMain.add(bvc, main);</span>
                }
<span class="nc" id="L1196">                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</span>
<span class="nc" id="L1197">                panSecondary.add(component, secondary);</span>
<span class="nc" id="L1198">                break;</span>
            case PHASE_DEPLOYMENT:
<span class="nc" id="L1200">                component = new DeploymentDisplay(this);</span>
<span class="nc" id="L1201">                main = &quot;BoardView&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1202">                secondary = &quot;DeploymentDisplay&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1203">                component.setName(secondary);</span>
<span class="nc bnc" id="L1204" title="All 2 branches missed.">                if (!mainNames.containsValue(main)) {</span>
<span class="nc" id="L1205">                    panMain.add(bvc, main);</span>
                }
<span class="nc" id="L1207">                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</span>
<span class="nc" id="L1208">                panSecondary.add(component, secondary);</span>
<span class="nc" id="L1209">                break;</span>
            case PHASE_TARGETING:
<span class="nc" id="L1211">                component = new TargetingPhaseDisplay(this, false);</span>
<span class="nc" id="L1212">                ((TargetingPhaseDisplay) component).initializeListeners();</span>
<span class="nc" id="L1213">                main = &quot;BoardView&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1214">                secondary = &quot;TargetingPhaseDisplay&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1215">                component.setName(secondary);</span>
<span class="nc bnc" id="L1216" title="All 2 branches missed.">                if (!mainNames.containsValue(main)) {</span>
<span class="nc" id="L1217">                    panMain.add(bvc, main);</span>
                }
<span class="nc" id="L1219">                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</span>
<span class="nc" id="L1220">                panSecondary.add(component, secondary);</span>
<span class="nc" id="L1221">                offBoardOverlay.setTargetingPhaseDisplay((TargetingPhaseDisplay) component);</span>
<span class="nc" id="L1222">                break;</span>
            case PHASE_MOVEMENT:
<span class="nc" id="L1224">                component = new MovementDisplay(this);</span>
<span class="nc" id="L1225">                main = &quot;BoardView&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1226">                secondary = &quot;MovementDisplay&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1227">                component.setName(secondary);</span>
<span class="nc bnc" id="L1228" title="All 2 branches missed.">                if (!mainNames.containsValue(main)) {</span>
<span class="nc" id="L1229">                    panMain.add(bvc, main);</span>
                }
<span class="nc" id="L1231">                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</span>
<span class="nc" id="L1232">                panSecondary.add(component, secondary);</span>
<span class="nc" id="L1233">                break;</span>
            case PHASE_OFFBOARD:
<span class="nc" id="L1235">                component = new TargetingPhaseDisplay(this, true);</span>
<span class="nc" id="L1236">                ((TargetingPhaseDisplay) component).initializeListeners();</span>
<span class="nc" id="L1237">                main = &quot;BoardView&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1238">                secondary = &quot;OffboardDisplay&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1239">                component.setName(secondary);</span>
<span class="nc bnc" id="L1240" title="All 2 branches missed.">                if (!mainNames.containsValue(main)) {</span>
<span class="nc" id="L1241">                    panMain.add(bvc, main);</span>
                }
<span class="nc" id="L1243">                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</span>
<span class="nc" id="L1244">                panSecondary.add(component, secondary);</span>
<span class="nc" id="L1245">                break;</span>
            case PHASE_FIRING:
<span class="nc" id="L1247">                component = new FiringDisplay(this);</span>
<span class="nc" id="L1248">                main = &quot;BoardView&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1249">                secondary = &quot;FiringDisplay&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1250">                component.setName(secondary);</span>
<span class="nc bnc" id="L1251" title="All 2 branches missed.">                if (!mainNames.containsValue(main)) {</span>
<span class="nc" id="L1252">                    panMain.add(bvc, main);</span>
                }
<span class="nc" id="L1254">                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</span>
<span class="nc" id="L1255">                panSecondary.add(component, secondary);</span>
<span class="nc" id="L1256">                break;</span>
            case PHASE_POINTBLANK_SHOT:
<span class="nc" id="L1258">                component = new PointblankShotDisplay(this);</span>
<span class="nc" id="L1259">                main = &quot;BoardView&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1260">                secondary = &quot;PointblankShotDisplay&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1261">                component.setName(secondary);</span>
<span class="nc bnc" id="L1262" title="All 2 branches missed.">                if (!mainNames.containsValue(main)) {</span>
<span class="nc" id="L1263">                    panMain.add(bvc, main);</span>
                }
<span class="nc" id="L1265">                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</span>
<span class="nc" id="L1266">                panSecondary.add(component, secondary);</span>
<span class="nc" id="L1267">                break;</span>
            case PHASE_PHYSICAL:
<span class="nc" id="L1269">                component = new PhysicalDisplay(this);</span>
<span class="nc" id="L1270">                main = &quot;BoardView&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1271">                secondary = &quot;PhysicalDisplay&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1272">                component.setName(secondary);</span>
<span class="nc bnc" id="L1273" title="All 2 branches missed.">                if (!mainNames.containsValue(main)) {</span>
<span class="nc" id="L1274">                    panMain.add(bvc, main);</span>
                }
<span class="nc" id="L1276">                currPhaseDisplay = (StatusBarPhaseDisplay)(component);</span>
<span class="nc" id="L1277">                panSecondary.add(component, secondary);</span>
<span class="nc" id="L1278">                break;</span>
            case PHASE_INITIATIVE_REPORT:
<span class="nc" id="L1280">                component = new ReportDisplay(this);</span>
<span class="nc" id="L1281">                main = &quot;ReportDisplay&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1282">                component.setName(main);</span>
<span class="nc" id="L1283">                panMain.add(main, component);</span>
<span class="nc" id="L1284">                break;</span>
            case PHASE_TARGETING_REPORT:
            case PHASE_MOVEMENT_REPORT:
            case PHASE_OFFBOARD_REPORT:
            case PHASE_FIRING_REPORT:
            case PHASE_PHYSICAL_REPORT:
            case PHASE_END_REPORT:
            case PHASE_VICTORY:
                // Try to reuse the ReportDisplay for other phases...
<span class="nc" id="L1293">                component = phaseComponents.get(String.valueOf(IGame.Phase.PHASE_INITIATIVE_REPORT));</span>
<span class="nc bnc" id="L1294" title="All 2 branches missed.">                if (component == null) {</span>
                    // no ReportDisplay to reuse -- get a new one
<span class="nc" id="L1296">                    component = initializePanel(IGame.Phase.PHASE_INITIATIVE_REPORT);</span>
                }
<span class="nc" id="L1298">                main = &quot;ReportDisplay&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1299">                break;</span>
            default:
<span class="nc" id="L1301">                component = new JLabel(Messages.getString(&quot;ClientGUI.waitingOnTheServer&quot;)); //$NON-NLS-1$</span>
<span class="nc" id="L1302">                main = &quot;JLabel-Default&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L1303">                secondary = main;</span>
<span class="nc" id="L1304">                component.setName(main);</span>
<span class="nc" id="L1305">                panMain.add(main, component);</span>
        }
<span class="nc" id="L1307">        phaseComponents.put(name, component);</span>
<span class="nc" id="L1308">        mainNames.put(name, main);</span>
<span class="nc bnc" id="L1309" title="All 2 branches missed.">        if (secondary != null) {</span>
<span class="nc" id="L1310">            secondaryNames.put(name, secondary);</span>
        }
<span class="nc" id="L1312">        return component;</span>
    }

    protected void showBoardPopup(Coords c) {
<span class="nc bnc" id="L1316" title="All 2 branches missed.">        if (fillPopup(c)) {</span>
<span class="nc" id="L1317">            bv.showPopup(popup, c);</span>
        }
<span class="nc" id="L1319">    }</span>

    /** Switches the Minimap and the MechDisplay an and off together.
     *  If the MechDisplay is active, both will be hidden, else
     *  both will be shown.
     */
    public void toggleMMUDDisplays() {
<span class="nc bnc" id="L1326" title="All 2 branches missed.">        if (mechW.isVisible()) {</span>
<span class="nc" id="L1327">            setDisplayVisible(false);</span>
<span class="nc" id="L1328">            setMapVisible(false);</span>
        } else {
<span class="nc" id="L1330">            setDisplayVisible(true);</span>
<span class="nc" id="L1331">            setMapVisible(true);</span>
        }
<span class="nc" id="L1333">    }</span>

    /**
     * Toggles the entity display window
     */
    private void toggleDisplay() {
<span class="nc bnc" id="L1339" title="All 2 branches missed.">        mechW.setVisible(!mechW.isVisible());</span>
<span class="nc bnc" id="L1340" title="All 2 branches missed.">        if (mechW.isVisible()) {</span>
<span class="nc" id="L1341">            frame.requestFocus();</span>
        }
<span class="nc" id="L1343">    }</span>

    /**
     * Toggles the accessibility window
     */
    private void toggleAccessibilityWindow() {
<span class="nc bnc" id="L1349" title="All 2 branches missed.">        aw.setVisible(!aw.isVisible());</span>
<span class="nc bnc" id="L1350" title="All 2 branches missed.">        if (aw.isVisible()) {</span>
<span class="nc" id="L1351">            frame.requestFocus();</span>
        }
<span class="nc" id="L1353">    }</span>

    /**
     * Sets the visibility of the entity display window
     */
    public void setDisplayVisible(boolean visible) {
        // If no unit displayed, select a unit so display can be safely shown
        // This can happen when using mouse button 4
<span class="nc" id="L1361">        Entity unitToSelect = null;</span>
<span class="nc bnc" id="L1362" title="All 2 branches missed.">        IGame game = (getClient() != null) ? getClient().getGame() : null;</span>
<span class="nc bnc" id="L1363" title="All 4 branches missed.">        if ((mechD.getCurrentEntity() == null) &amp;&amp; (game != null)) {</span>
<span class="nc" id="L1364">            List&lt;Entity&gt; es = getClient().getGame().getEntitiesVector();</span>
<span class="nc bnc" id="L1365" title="All 4 branches missed.">            if ((es != null) &amp;&amp; (es.size() &gt; 0)) {</span>
<span class="nc" id="L1366">                unitToSelect = es.get(0);</span>
            }
        }

<span class="nc" id="L1370">        mechW.setVisible(visible);</span>
<span class="nc bnc" id="L1371" title="All 2 branches missed.">        if (unitToSelect != null) {</span>
<span class="nc" id="L1372">            mechD.displayEntity(unitToSelect);</span>
        }
<span class="nc bnc" id="L1374" title="All 2 branches missed.">        if (visible) {</span>
<span class="nc" id="L1375">            frame.requestFocus();</span>
        }
<span class="nc" id="L1377">    }</span>

    private void toggleUnitOverview() {
<span class="nc bnc" id="L1380" title="All 2 branches missed.">        uo.setVisible(!uo.isVisible());</span>
<span class="nc" id="L1381">        GUIPreferences.getInstance().setShowUnitOverview(uo.isVisible());</span>
<span class="nc" id="L1382">        bv.refreshDisplayables();</span>
<span class="nc" id="L1383">    }</span>

    /**
     * Toggles the minimap window Also, toggles the minimap enabled setting
     */
    private void toggleMap() {
<span class="nc bnc" id="L1389" title="All 2 branches missed.">        minimapW.setVisible(!minimapW.isVisible());</span>
<span class="nc" id="L1390">        GUIPreferences.getInstance().setMinimapEnabled(minimapW.isVisible());</span>
<span class="nc bnc" id="L1391" title="All 2 branches missed.">        if (minimapW.isVisible()) {</span>
<span class="nc" id="L1392">            frame.requestFocus();</span>
        }
<span class="nc" id="L1394">    }</span>

    /**
     * Sets the visibility of the minimap window
     */
    void setMapVisible(boolean visible) {
<span class="nc" id="L1400">        minimapW.setVisible(visible);</span>
<span class="nc bnc" id="L1401" title="All 2 branches missed.">        if (visible) {</span>
<span class="nc" id="L1402">            frame.requestFocus();</span>
        }
<span class="nc" id="L1404">    }</span>

    private boolean fillPopup(Coords coords) {
<span class="nc" id="L1407">        popup = new MapMenu(coords, client, curPanel, this);</span>
<span class="nc" id="L1408">        return popup.getHasMenu();</span>
    }

    /**
     * Pops up a dialog box giving the player a series of choices that are not
     * mutually exclusive.
     *
     * @param title    the &lt;code&gt;String&lt;/code&gt; title of the dialog box.
     * @param question the &lt;code&gt;String&lt;/code&gt; question that has a &quot;Yes&quot; or &quot;No&quot;
     *                 answer. The question will be split across multiple line on the
     *                 '\n' characters.
     * @param choices  the array of &lt;code&gt;String&lt;/code&gt; choices that the player can
     *                 select from.
     * @return The array of the &lt;code&gt;int&lt;/code&gt; indexes of the from the input
     *         array that match the selected choices. If no choices were
     *         available, if the player did not select a choice, or if the
     *         player canceled the choice, a &lt;code&gt;null&lt;/code&gt; value is
     *         returned.
     */
    public int[] doChoiceDialog(String title, String question, String[] choices) {
<span class="nc" id="L1428">        ChoiceDialog choice = new ChoiceDialog(frame, title, question, choices);</span>
<span class="nc" id="L1429">        choice.setVisible(true);</span>
<span class="nc" id="L1430">        return choice.getChoices();</span>
    }

    /**
     * Pops up a dialog box showing an alert
     */
    public void doAlertDialog(String title, String message) {
<span class="nc" id="L1437">        JTextPane textArea = new JTextPane();</span>
<span class="nc" id="L1438">        ReportDisplay.setupStylesheet(textArea);</span>
<span class="nc" id="L1439">        BASE64ToolKit toolKit = new BASE64ToolKit();</span>
<span class="nc" id="L1440">        textArea.setEditorKit(toolKit);</span>
<span class="nc" id="L1441">        textArea.setEditable(false);</span>
<span class="nc" id="L1442">        JScrollPane scrollPane = new JScrollPane(textArea,</span>
                ScrollPaneConstants.VERTICAL_SCROLLBAR_AS_NEEDED,
                ScrollPaneConstants.HORIZONTAL_SCROLLBAR_AS_NEEDED);
<span class="nc" id="L1445">        textArea.setText(&quot;&lt;pre&gt;&quot; + message + &quot;&lt;/pre&gt;&quot;);</span>
<span class="nc" id="L1446">        scrollPane.setPreferredSize(new Dimension(</span>
<span class="nc" id="L1447">                (int) (getSize().getWidth() / 1.5), (int) (getSize()</span>
<span class="nc" id="L1448">                        .getHeight() / 1.5)));</span>
<span class="nc" id="L1449">        JOptionPane.showMessageDialog(frame, scrollPane, title,</span>
                JOptionPane.ERROR_MESSAGE);
<span class="nc" id="L1451">    }</span>

    /**
     * Pops up a dialog box asking a yes/no question
     *
     * @param title    the &lt;code&gt;String&lt;/code&gt; title of the dialog box.
     * @param question the &lt;code&gt;String&lt;/code&gt; question that has a &quot;Yes&quot; or &quot;No&quot;
     *                 answer. The question will be split across multiple line on the
     *                 '\n' characters.
     * @return &lt;code&gt;true&lt;/code&gt; if yes
     */
    public boolean doYesNoDialog(String title, String question) {
<span class="nc" id="L1463">        ConfirmDialog confirm = new ConfirmDialog(frame, title, question);</span>
<span class="nc" id="L1464">        confirm.setVisible(true);</span>
<span class="nc" id="L1465">        return confirm.getAnswer();</span>
    }

    /**
     * Pops up a dialog box asking a yes/no question
     * &lt;p/&gt;
     * The player will be given a chance to not show the dialog again.
     *
     * @param title    the &lt;code&gt;String&lt;/code&gt; title of the dialog box.
     * @param question the &lt;code&gt;String&lt;/code&gt; question that has a &quot;Yes&quot; or &quot;No&quot;
     *                 answer. The question will be split across multiple line on the
     *                 '\n' characters.
     * @return the &lt;code&gt;ConfirmDialog&lt;/code&gt; containing the player's responses.
     *         The dialog will already have been shown to the player, and is
     *         only being returned so the calling function can see the answer to
     *         the question and the state of the &quot;Show again?&quot; question.
     */
    public ConfirmDialog doYesNoBotherDialog(String title, String question) {
<span class="nc" id="L1483">        ConfirmDialog confirm = new ConfirmDialog(frame, title, question, true);</span>
<span class="nc" id="L1484">        confirm.setVisible(true);</span>
<span class="nc" id="L1485">        return confirm;</span>
    }

    /**
     * Allow the player to select a MegaMek Unit List file to load. The
     * &lt;code&gt;Entity&lt;/code&gt;s in the file will replace any that the player has
     * already selected. As such, this method should only be called in the chat
     * lounge. The file can record damage sustained, non- standard munitions
     * selected, and ammunition expended in a prior engagement.
     */
    protected void loadListFile() {
<span class="nc" id="L1496">        loadListFile(client.getLocalPlayer());</span>
<span class="nc" id="L1497">    }</span>

    /**
     * Allow the player to select a MegaMek Unit List file to load. The
     * &lt;code&gt;Entity&lt;/code&gt;s in the file will replace any that the player has
     * already selected. As such, this method should only be called in the chat
     * lounge. The file can record damage sustained, non- standard munitions
     * selected, and ammunition expended in a prior engagement.
     *
     * @param c
     */
    protected void loadListFile(Client c) {
<span class="nc" id="L1509">        loadListFile(c.getLocalPlayer());</span>
<span class="nc" id="L1510">    }</span>

    /**
     * Allow the player to select a MegaMek Unit List file to load. The
     * &lt;code&gt;Entity&lt;/code&gt;s in the file will replace any that the player has
     * already selected. As such, this method should only be called in the chat
     * lounge. The file can record damage sustained, non- standard munitions
     * selected, and ammunition expended in a prior engagement.
     *
     * @param player
     */
    protected void loadListFile(IPlayer player) {
<span class="nc" id="L1522">        loadListFile(player, false);</span>
<span class="nc" id="L1523">    }</span>

    /**
     * Allow the player to select a MegaMek Unit List file to load. The
     * &lt;code&gt;Entity&lt;/code&gt;s in the file will replace any that the player has
     * already selected. As such, this method should only be called in the chat
     * lounge. The file can record damage sustained, non- standard munitions
     * selected, and ammunition expended in a prior engagement.
     *
     * @param player
     */
    protected void loadListFile(IPlayer player, boolean reinforce) {
<span class="nc" id="L1535">        boolean addedUnits = false;</span>

<span class="nc bnc" id="L1537" title="All 4 branches missed.">        if (reinforce &amp;&amp; player.getTeam() == IPlayer.TEAM_UNASSIGNED){</span>
<span class="nc" id="L1538">            String title = Messages.getString(</span>
                    &quot;ClientGUI.openUnitListFileDialog.noReinforceTitle&quot;); //$NON-NLS-1$
<span class="nc" id="L1540">            String msg = Messages.getString(</span>
                    &quot;ClientGUI.openUnitListFileDialog.noReinforceMessage&quot;);  //$NON-NLS-1$
<span class="nc" id="L1542">            JOptionPane.showMessageDialog(frame, msg, title,</span>
                    JOptionPane.OK_OPTION, null);
<span class="nc" id="L1544">            return;</span>
        }
        // Build the &quot;load unit&quot; dialog, if necessary.
<span class="nc bnc" id="L1547" title="All 2 branches missed.">        if (dlgLoadList == null) {</span>
<span class="nc" id="L1548">            dlgLoadList = new JFileChooser(&quot;.&quot;);</span>
<span class="nc" id="L1549">            dlgLoadList.setLocation(frame.getLocation().x + 150, frame.getLocation().y + 100);</span>
<span class="nc" id="L1550">            dlgLoadList.setDialogTitle(Messages.getString(&quot;ClientGUI.openUnitListFileDialog.title&quot;));</span>
<span class="nc" id="L1551">            dlgLoadList.setFileFilter(new FileFilter() {</span>
                @Override
                public boolean accept(File dir) {
<span class="nc bnc" id="L1554" title="All 4 branches missed.">                    return (dir.getName().endsWith(&quot;.mul&quot;) || dir.isDirectory()); //$NON-NLS-1$</span>
                }

                @Override
                public String getDescription() {
<span class="nc" id="L1559">                    return &quot;*.mul&quot;;</span>
                }
            });
            // Default to the player's name.
<span class="nc" id="L1563">            dlgLoadList.setSelectedFile(new File(player.getName() + &quot;.mul&quot;)); //$NON-NLS-1$</span>
        }

<span class="nc" id="L1566">        int returnVal = dlgLoadList.showOpenDialog(frame);</span>
<span class="nc bnc" id="L1567" title="All 4 branches missed.">        if ((returnVal != JFileChooser.APPROVE_OPTION) || (dlgLoadList.getSelectedFile() == null)) {</span>
            // I want a file, y'know!
<span class="nc" id="L1569">            return;</span>
        }

        // Did the player select a file?
<span class="nc" id="L1573">        File unitFile = dlgLoadList.getSelectedFile();</span>
<span class="nc bnc" id="L1574" title="All 2 branches missed.">        if (unitFile != null) {</span>
            try {
                // Read the units from the file.
<span class="nc" id="L1577">                Vector&lt;Entity&gt; loadedUnits = EntityListFile.loadFrom(unitFile);</span>

                // Add the units from the file.
<span class="nc bnc" id="L1580" title="All 2 branches missed.">                for (Entity entity : loadedUnits) {</span>
<span class="nc" id="L1581">                    entity.setOwner(player);</span>
<span class="nc bnc" id="L1582" title="All 2 branches missed.">                    if (reinforce) {</span>
<span class="nc" id="L1583">                        entity.setDeployRound(client.getGame().getRoundCount()+1);</span>
<span class="nc" id="L1584">                        entity.setGame(client.getGame());</span>
                        // Set these to true, otherwise units reinforced in
                        // the movement turn are considered selectable
<span class="nc" id="L1587">                        entity.setDone(true);</span>
<span class="nc" id="L1588">                        entity.setUnloaded(true);</span>
<span class="nc bnc" id="L1589" title="All 2 branches missed.">                        if (entity instanceof IBomber) {</span>
<span class="nc" id="L1590">                            ((IBomber)entity).applyBombs();</span>
                        }
                    }
<span class="nc" id="L1593">                }</span>
<span class="nc bnc" id="L1594" title="All 2 branches missed.">                if (loadedUnits.size() &gt; 0){</span>
<span class="nc" id="L1595">                    client.sendAddEntity(loadedUnits);</span>
<span class="nc" id="L1596">                    addedUnits = true;</span>
                }
<span class="nc" id="L1598">            } catch (IOException excep) {</span>
<span class="nc" id="L1599">                excep.printStackTrace(System.err);</span>
<span class="nc" id="L1600">                doAlertDialog(Messages.getString(&quot;ClientGUI.errorLoadingFile&quot;), excep.getMessage()); //$NON-NLS-1$</span>
<span class="nc" id="L1601">            }</span>
        }

        // If we've added reinforcements, then we need to set the round deployment up again.
<span class="nc bnc" id="L1605" title="All 4 branches missed.">        if (addedUnits &amp;&amp; reinforce) {</span>
<span class="nc" id="L1606">            client.getGame().setupRoundDeployment();</span>
<span class="nc" id="L1607">            client.sendResetRoundDeployment();</span>
        }
<span class="nc" id="L1609">    }</span>

    public void deleteAllUnits(Client c) {
<span class="nc" id="L1612">        ArrayList&lt;Entity&gt; currentUnits = c.getGame().getPlayerEntities(</span>
<span class="nc" id="L1613">                c.getLocalPlayer(), false);</span>
<span class="nc" id="L1614">        ArrayList&lt;Integer&gt; ids = new ArrayList&lt;&gt;(currentUnits.size());</span>
<span class="nc bnc" id="L1615" title="All 2 branches missed.">        for (Entity e : currentUnits){</span>
<span class="nc" id="L1616">            ids.add(e.getId());</span>
<span class="nc" id="L1617">        }</span>
<span class="nc" id="L1618">        c.sendDeleteEntities(ids);</span>
<span class="nc" id="L1619">    }</span>

    private boolean saveGame() {
<span class="nc" id="L1622">        ignoreHotKeys = true;</span>
<span class="nc" id="L1623">        JFileChooser fc = new JFileChooser(&quot;./savegames&quot;);</span>
<span class="nc" id="L1624">        fc.setLocation(frame.getLocation().x + 150, frame.getLocation().y + 100);</span>
<span class="nc" id="L1625">        fc.setDialogTitle(Messages.getString(&quot;ClientGUI.FileSaveDialog.title&quot;));</span>

<span class="nc" id="L1627">        int returnVal = fc.showSaveDialog(frame);</span>
<span class="nc" id="L1628">        ignoreHotKeys = false;</span>
<span class="nc bnc" id="L1629" title="All 4 branches missed.">        if ((returnVal != JFileChooser.APPROVE_OPTION) || (fc.getSelectedFile() == null)) {</span>
            // I want a file, y'know!
<span class="nc" id="L1631">            return false;</span>
        }
<span class="nc bnc" id="L1633" title="All 2 branches missed.">        if (fc.getSelectedFile() != null) {</span>
<span class="nc" id="L1634">            String file = fc.getSelectedFile().getName();</span>
            // stupid hack to allow for savegames in folders with spaces in
            // the name
<span class="nc" id="L1637">            String path = fc.getSelectedFile().getParentFile().getPath();</span>
<span class="nc" id="L1638">            path = path.replace(&quot; &quot;, &quot;|&quot;);</span>
<span class="nc" id="L1639">            client.sendChat(&quot;/localsave &quot; + file + &quot; &quot; + path); //$NON-NLS-1$</span>
<span class="nc" id="L1640">            return true;</span>
        }
<span class="nc" id="L1642">        return false;</span>
    }

    /**
     * Allow the player to save a list of entities to a MegaMek Unit List file.
     * A &quot;Save As&quot; dialog will be displayed that allows the user to select the
     * file's name and directory. The player can later load this file to quickly
     * select the units for a new game. The file will record damage sustained,
     * non-standard munitions selected, and ammunition expended during the
     * course of the current engagement.
     *
     * @param unitList - the &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Entity&lt;/code&gt;s to be saved
     *                 to a file. If this value is &lt;code&gt;null&lt;/code&gt; or empty, the
     *                 &quot;Save As&quot; dialog will not be displayed.
     */
    protected void saveListFile(ArrayList&lt;Entity&gt; unitList) {
<span class="nc" id="L1658">        saveListFile(unitList, client.getLocalPlayer().getName());</span>
<span class="nc" id="L1659">    }</span>

    protected void saveListFile(ArrayList&lt;Entity&gt; unitList, String filename) {
        // Handle empty lists.
<span class="nc bnc" id="L1663" title="All 4 branches missed.">        if ((unitList == null) || unitList.isEmpty()) {</span>
<span class="nc" id="L1664">            return;</span>
        }

        // Build the &quot;save unit&quot; dialog, if necessary.
<span class="nc bnc" id="L1668" title="All 2 branches missed.">        if (dlgSaveList == null) {</span>
<span class="nc" id="L1669">            dlgSaveList = new JFileChooser(&quot;.&quot;);</span>
<span class="nc" id="L1670">            dlgSaveList.setLocation(frame.getLocation().x + 150, frame.getLocation().y + 100);</span>
<span class="nc" id="L1671">            dlgSaveList.setDialogTitle(Messages.getString(&quot;ClientGUI.saveUnitListFileDialog.title&quot;));</span>
<span class="nc" id="L1672">            FileNameExtensionFilter filter = new FileNameExtensionFilter(&quot;Mul Files&quot;, &quot;mul&quot;);</span>
<span class="nc" id="L1673">            dlgSaveList.setFileFilter(filter);</span>
        }
        // Default to the player's name.
<span class="nc" id="L1676">        dlgSaveList.setSelectedFile(new File(filename + &quot;.mul&quot;)); //$NON-NLS-1$</span>

<span class="nc" id="L1678">        int returnVal = dlgSaveList.showSaveDialog(frame);</span>
<span class="nc bnc" id="L1679" title="All 4 branches missed.">        if ((returnVal != JFileChooser.APPROVE_OPTION) || (dlgSaveList.getSelectedFile() == null)) {</span>
            // I want a file, y'know!
<span class="nc" id="L1681">            return;</span>
        }

        // Did the player select a file?
<span class="nc" id="L1685">        File unitFile = dlgSaveList.getSelectedFile();</span>
<span class="nc bnc" id="L1686" title="All 2 branches missed.">        if (unitFile != null) {</span>
<span class="nc bnc" id="L1687" title="All 2 branches missed.">            if (!(unitFile.getName().toLowerCase().endsWith(&quot;.mul&quot;) //$NON-NLS-1$</span>
<span class="nc bnc" id="L1688" title="All 2 branches missed.">                    || unitFile.getName().toLowerCase().endsWith(&quot;.xml&quot;))) { //$NON-NLS-1$</span>
                try {
<span class="nc" id="L1690">                    unitFile = new File(unitFile.getCanonicalPath() + &quot;.mul&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1691">                } catch (IOException ie) {</span>
                    // nothing needs to be done here
<span class="nc" id="L1693">                    return;</span>
<span class="nc" id="L1694">                }</span>
            }
            try {
                // Save the player's entities to the file.
<span class="nc" id="L1698">                EntityListFile.saveTo(unitFile, unitList);</span>
<span class="nc" id="L1699">            } catch (IOException excep) {</span>
<span class="nc" id="L1700">                excep.printStackTrace(System.err);</span>
<span class="nc" id="L1701">                doAlertDialog(Messages.getString(&quot;ClientGUI.errorSavingFile&quot;), excep.getMessage()); //$NON-NLS-1$</span>
<span class="nc" id="L1702">            }</span>
        }
<span class="nc" id="L1704">    }</span>

    protected void saveVictoryList() {
<span class="nc" id="L1707">        String filename = client.getLocalPlayer().getName();</span>

        // Build the &quot;save unit&quot; dialog, if necessary.
<span class="nc bnc" id="L1710" title="All 2 branches missed.">        if (dlgSaveList == null) {</span>
<span class="nc" id="L1711">            dlgSaveList = new JFileChooser(&quot;.&quot;);</span>
<span class="nc" id="L1712">            dlgSaveList.setLocation(frame.getLocation().x + 150, frame.getLocation().y + 100);</span>
<span class="nc" id="L1713">            dlgSaveList.setDialogTitle(Messages.getString(&quot;ClientGUI.saveUnitListFileDialog.title&quot;));</span>
<span class="nc" id="L1714">            FileNameExtensionFilter filter = new FileNameExtensionFilter(&quot;Mul Files&quot;, &quot;mul&quot;);</span>
<span class="nc" id="L1715">            dlgSaveList.setFileFilter(filter);</span>
        }
        // Default to the player's name.
<span class="nc" id="L1718">        dlgSaveList.setSelectedFile(new File(filename + &quot;.mul&quot;)); //$NON-NLS-1$</span>

<span class="nc" id="L1720">        int returnVal = dlgSaveList.showSaveDialog(frame);</span>
<span class="nc bnc" id="L1721" title="All 4 branches missed.">        if ((returnVal != JFileChooser.APPROVE_OPTION) || (dlgSaveList.getSelectedFile() == null)) {</span>
            // I want a file, y'know!
<span class="nc" id="L1723">            return;</span>
        }

        // Did the player select a file?
<span class="nc" id="L1727">        File unitFile = dlgSaveList.getSelectedFile();</span>
<span class="nc bnc" id="L1728" title="All 2 branches missed.">        if (unitFile != null) {</span>
<span class="nc bnc" id="L1729" title="All 2 branches missed.">            if (!(unitFile.getName().toLowerCase().endsWith(&quot;.mul&quot;) //$NON-NLS-1$</span>
<span class="nc bnc" id="L1730" title="All 2 branches missed.">                    || unitFile.getName().toLowerCase().endsWith(&quot;.xml&quot;))) { //$NON-NLS-1$</span>
                try {
<span class="nc" id="L1732">                    unitFile = new File(unitFile.getCanonicalPath() + &quot;.mul&quot;); //$NON-NLS-1$</span>
<span class="nc" id="L1733">                } catch (IOException ie) {</span>
                    // nothing needs to be done here
<span class="nc" id="L1735">                    return;</span>
<span class="nc" id="L1736">                }</span>
            }
            try {
                // Save the player's entities to the file.
<span class="nc" id="L1740">                EntityListFile.saveTo(unitFile, getClient());</span>
<span class="nc" id="L1741">            } catch (IOException excep) {</span>
<span class="nc" id="L1742">                excep.printStackTrace(System.err);</span>
<span class="nc" id="L1743">                doAlertDialog(Messages.getString(&quot;ClientGUI.errorSavingFile&quot;), excep.getMessage()); //$NON-NLS-1$</span>
<span class="nc" id="L1744">            }</span>
        }
<span class="nc" id="L1746">    }</span>

    //region Window Listeners
    @Override
    public void windowActivated(WindowEvent windowEvent) {
        // ignored
<span class="nc" id="L1752">    }</span>

    @Override
    public void windowClosed(WindowEvent windowEvent) {
        // ignored
<span class="nc" id="L1757">    }</span>

    @Override
    public void windowClosing(WindowEvent windowEvent) {
<span class="nc bnc" id="L1761" title="All 2 branches missed.">        if (windowEvent.getWindow().equals(minimapW)) {</span>
<span class="nc" id="L1762">            setMapVisible(false);</span>
<span class="nc bnc" id="L1763" title="All 2 branches missed.">        } else if (windowEvent.getWindow().equals(mechW)) {</span>
<span class="nc" id="L1764">            setDisplayVisible(false);</span>
        }
<span class="nc" id="L1766">    }</span>

    @Override
    public void windowDeactivated(WindowEvent windowEvent) {
        // ignored
<span class="nc" id="L1771">    }</span>

    @Override
    public void windowDeiconified(WindowEvent windowEvent) {
        // ignored
<span class="nc" id="L1776">    }</span>

    @Override
    public void windowIconified(WindowEvent windowEvent) {
        // ignored
<span class="nc" id="L1781">    }</span>

    @Override
    public void windowOpened(WindowEvent windowEvent) {
        // ignored
<span class="nc" id="L1786">    }</span>
    //endregion Window Listeners

    /**
     * @return the frame this client is displayed in
     */
    public JFrame getFrame() {
<span class="nc" id="L1793">        return frame;</span>
    }

    /**
     * Shows a dialog where the player can select the entity types
     * used in the LOS tool.
     */
    private void showLOSSettingDialog() {
<span class="nc" id="L1801">        GUIPreferences gp = GUIPreferences.getInstance();</span>
<span class="nc" id="L1802">        LOSDialog ld = new LOSDialog(frame, gp.getMechInFirst(), gp.getMechInSecond());</span>
<span class="nc" id="L1803">        ld.setVisible(true);</span>
<span class="nc" id="L1804">        gp.setMechInFirst(ld.getMechInFirst());</span>
<span class="nc" id="L1805">        gp.setMechInSecond(ld.getMechInSecond());</span>
<span class="nc" id="L1806">    }</span>

    /**
     * Loads a preview image of the unit into the BufferedPanel.
     *
     * @param bp
     * @param entity
     */
    public void loadPreviewImage(JLabel bp, Entity entity) {
<span class="nc" id="L1815">        IPlayer player = client.getGame().getPlayer(entity.getOwnerId());</span>
<span class="nc" id="L1816">        loadPreviewImage(bp, entity, player);</span>
<span class="nc" id="L1817">    }</span>

    public void loadPreviewImage(JLabel bp, Entity entity, IPlayer player) {
<span class="nc" id="L1820">        final Camouflage camouflage = entity.getCamouflageOrElse(player.getCamouflage());</span>
<span class="nc" id="L1821">        Image icon = bv.getTilesetManager().loadPreviewImage(entity, camouflage, bp);</span>
<span class="nc bnc" id="L1822" title="All 2 branches missed.">        bp.setIcon((icon == null) ? null : new ImageIcon(icon));</span>
<span class="nc" id="L1823">    }</span>

    /**
     * Make a &quot;bing&quot; sound.
     */
    void bing() {
<span class="nc bnc" id="L1829" title="All 4 branches missed.">        if (!GUIPreferences.getInstance().getSoundMute() &amp;&amp; (bingClip != null)) {</span>
<span class="nc" id="L1830">            bingClip.play();</span>
        }
<span class="nc" id="L1832">    }</span>

<span class="nc" id="L1834">    private GameListener gameListener = new GameListenerAdapter() {</span>
        @Override
        public void gamePlayerChange(GamePlayerChangeEvent e){
<span class="nc bnc" id="L1837" title="All 2 branches missed.">             if (playerListDialog != null) {</span>
<span class="nc" id="L1838">                 playerListDialog.refreshPlayerList();</span>
             }

<span class="nc bnc" id="L1841" title="All 4 branches missed.">             if ((curPanel instanceof ReportDisplay) &amp;&amp; !client.getLocalPlayer().isDone()) {</span>
<span class="nc" id="L1842">                 ((ReportDisplay) curPanel).resetReadyButton();</span>
             }
<span class="nc" id="L1844">        }</span>

        @Override
        public void gamePlayerDisconnected(GamePlayerDisconnectedEvent e) {
<span class="nc" id="L1848">            JOptionPane.showMessageDialog(frame,</span>
<span class="nc" id="L1849">                Messages.getString(&quot;ClientGUI.Disconnected.message&quot;),</span>
<span class="nc" id="L1850">                Messages.getString(&quot;ClientGUI.Disconnected.title&quot;),</span>
                JOptionPane.ERROR_MESSAGE);
<span class="nc" id="L1852">            frame.setVisible(false);</span>
<span class="nc" id="L1853">            die();</span>
<span class="nc" id="L1854">        }</span>

        @Override
        public void gamePlayerChat(GamePlayerChatEvent e) {
<span class="nc" id="L1858">            bing();</span>
<span class="nc" id="L1859">        }</span>

        @Override
        public void gamePhaseChange(GamePhaseChangeEvent e) {
            // This is a really lame place for this, but I couldn't find a
            // better one without making massive changes (which didn't seem
            // worth it for one little feature).
<span class="nc bnc" id="L1866" title="All 2 branches missed.">            if (bv.getLocalPlayer() != client.getLocalPlayer()) {</span>
                // The adress based comparison is somewhat important.
                //  Use of the /reset command can cause the player to get reset,
                //  and the equals function of Player isn't powerful enough.
<span class="nc" id="L1870">                bv.setLocalPlayer(client.getLocalPlayer());</span>
            }
            // Make sure the ChatterBox starts out deactived.
<span class="nc" id="L1873">            bv.setChatterBoxActive(false);            </span>

            // Swap to this phase's panel.
<span class="nc" id="L1876">            switchPanel(getClient().getGame().getPhase());</span>

<span class="nc" id="L1878">            menuBar.setPhase(getClient().getGame().getPhase());</span>
<span class="nc" id="L1879">            validate();</span>
<span class="nc" id="L1880">            cb.moveToEnd();</span>
<span class="nc" id="L1881">        }</span>

        @Override
        public void gamePlayerConnected(GamePlayerConnectedEvent e) {
<span class="nc" id="L1885">            System.err.println(&quot;gamePlayerConnected&quot;);</span>
<span class="nc" id="L1886">            System.err.flush();</span>
<span class="nc bnc" id="L1887" title="All 2 branches missed.">            if (curPanel instanceof ReportDisplay) {</span>
<span class="nc" id="L1888">                ((ReportDisplay) curPanel).resetReadyButton();</span>
<span class="nc" id="L1889">                System.err.println(&quot;resetReadyButton&quot;);</span>
<span class="nc" id="L1890">                System.err.flush();</span>
            }
<span class="nc" id="L1892">        }</span>

        @Override
        public void gameReport(GameReportEvent e) {
            // Normally the Report Display is updated when the panel is
            // switched during a phase change.
            // This update is for reports that get sent at odd times,
            // currently Tactical Genius reroll requests and when
            // a player wishes to continue moving after a fall.
<span class="nc bnc" id="L1901" title="All 2 branches missed.">            if (curPanel instanceof ReportDisplay) {</span>
                // Tactical Genius
<span class="nc" id="L1903">                ((ReportDisplay) curPanel).appendReportTab(getClient().phaseReport);</span>
<span class="nc" id="L1904">                ((ReportDisplay) curPanel).resetReadyButton();</span>
                // Check if the player deserves an active reroll button
                // (possible, if he gets one which he didn't use, and his
                // opponent got and used one) and if so activates it.
<span class="nc bnc" id="L1908" title="All 2 branches missed.">                if (getClient().getGame().hasTacticalGenius(getClient().getLocalPlayer())) {</span>
<span class="nc bnc" id="L1909" title="All 2 branches missed.">                    if (!((ReportDisplay) curPanel).hasRerolled()) {</span>
<span class="nc" id="L1910">                        ((ReportDisplay) curPanel).resetRerollButton();</span>
                    }
                }
                // Show a popup to the players so that we know whats up!
<span class="nc bnc" id="L1914" title="All 2 branches missed.">                if (!(getClient() instanceof TestBot)) {</span>
<span class="nc" id="L1915">                    doAlertDialog(&quot;Tactical Genius Report&quot;, e.getReport());</span>
                }
            } else {
                // Continued movement after getting up
<span class="nc bnc" id="L1919" title="All 2 branches missed.">                if (!(getClient() instanceof TestBot)) {</span>
<span class="nc" id="L1920">                    doAlertDialog(&quot;Movement Report&quot;, e.getReport());</span>
                }
            }
<span class="nc" id="L1923">        }</span>


        @Override
        public void gameEnd(GameEndEvent e) {
<span class="nc" id="L1928">            bv.clearMovementData();</span>
<span class="nc" id="L1929">            bv.clearFieldofF();</span>
<span class="nc bnc" id="L1930" title="All 2 branches missed.">            for (Client client2 : getBots().values()) {</span>
<span class="nc" id="L1931">                client2.die();</span>
<span class="nc" id="L1932">            }</span>
<span class="nc" id="L1933">            getBots().clear();</span>

            // Make a list of the player's living units.
<span class="nc" id="L1936">            ArrayList&lt;Entity&gt; living = getClient().getGame().getPlayerEntities(getClient().getLocalPlayer(), false);</span>

            // Be sure to include all units that have retreated.
<span class="nc bnc" id="L1939" title="All 2 branches missed.">            for (Enumeration&lt;Entity&gt; iter = getClient().getGame().getRetreatedEntities(); iter.hasMoreElements(); ) {</span>
<span class="nc" id="L1940">                Entity ent = iter.nextElement();</span>
<span class="nc bnc" id="L1941" title="All 2 branches missed.">                if (ent.getOwnerId() == getClient().getLocalPlayer().getId()) {</span>
<span class="nc" id="L1942">                    living.add(ent);</span>
                }
<span class="nc" id="L1944">            }</span>

            // Allow players to save their living units to a file.
            // Don't bother asking if none survived.
<span class="nc bnc" id="L1948" title="All 4 branches missed.">            if (!living.isEmpty() &amp;&amp; doYesNoDialog(Messages.getString(&quot;ClientGUI.SaveUnitsDialog.title&quot;), //$NON-NLS-1$</span>
<span class="nc" id="L1949">                    Messages.getString(&quot;ClientGUI.SaveUnitsDialog.message&quot;))) { //$NON-NLS-1$</span>

                // Allow the player to save the units to a file.
<span class="nc" id="L1952">                saveVictoryList();</span>
            } // End user-wants-a-MUL

            // save all destroyed units in a separate &quot;salvage MUL&quot;
<span class="nc" id="L1956">            ArrayList&lt;Entity&gt; destroyed = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1957">            Enumeration&lt;Entity&gt; graveyard = getClient().getGame().getGraveyardEntities();</span>
<span class="nc bnc" id="L1958" title="All 2 branches missed.">            while (graveyard.hasMoreElements()) {</span>
<span class="nc" id="L1959">                Entity entity = graveyard.nextElement();</span>
<span class="nc bnc" id="L1960" title="All 2 branches missed.">                if (entity.isSalvage()) {</span>
<span class="nc" id="L1961">                    destroyed.add(entity);</span>
                }
<span class="nc" id="L1963">            }</span>
<span class="nc bnc" id="L1964" title="All 2 branches missed.">            if (destroyed.size() &gt; 0) {</span>
<span class="nc" id="L1965">                String sLogDir = PreferenceManager.getClientPreferences().getLogDirectory();</span>
<span class="nc" id="L1966">                File logDir = new File(sLogDir);</span>
<span class="nc bnc" id="L1967" title="All 2 branches missed.">                if (!logDir.exists()) {</span>
<span class="nc" id="L1968">                    logDir.mkdir();</span>
                }
<span class="nc" id="L1970">                String fileName = &quot;salvage.mul&quot;;</span>
<span class="nc bnc" id="L1971" title="All 2 branches missed.">                if (PreferenceManager.getClientPreferences().stampFilenames()) {</span>
<span class="nc" id="L1972">                    fileName = StringUtil.addDateTimeStamp(fileName);</span>
                }
<span class="nc" id="L1974">                File unitFile = new File(sLogDir + File.separator + fileName);</span>
                try {
                    // Save the destroyed entities to the file.
<span class="nc" id="L1977">                    EntityListFile.saveTo(unitFile, destroyed);</span>
<span class="nc" id="L1978">                } catch (IOException ex) {</span>
<span class="nc" id="L1979">                    MegaMek.getLogger().error(ex);</span>
<span class="nc" id="L1980">                    doAlertDialog(Messages.getString(&quot;ClientGUI.errorSavingFile&quot;), ex.getMessage());</span>
<span class="nc" id="L1981">                }</span>
            }

<span class="nc" id="L1984">        }</span>

        @Override
        public void gameSettingsChange(GameSettingsChangeEvent e) {
<span class="nc bnc" id="L1988" title="All 4 branches missed.">            if ((gameOptionsDialog != null) &amp;&amp; gameOptionsDialog.isVisible() &amp;&amp;</span>
<span class="nc bnc" id="L1989" title="All 2 branches missed.">                    !e.isMapSettingsOnlyChange()) {</span>
<span class="nc" id="L1990">                gameOptionsDialog.update(getClient().getGame().getOptions());</span>
            }
<span class="nc bnc" id="L1992" title="All 2 branches missed.">            if (curPanel instanceof ChatLounge) {</span>
<span class="nc" id="L1993">                ChatLounge cl = (ChatLounge) curPanel;</span>
<span class="nc" id="L1994">                cl.updateMapSettings(getClient().getMapSettings());</span>
            }
<span class="nc" id="L1996">        }</span>

        @Override
        public void gameMapQuery(GameMapQueryEvent e) {

<span class="nc" id="L2001">        }</span>
        
        @Override
        public void gameClientFeedbackRequest(GameCFREvent evt) {
<span class="nc" id="L2005">            Entity e = client.getGame().getEntity(evt.getEntityId());</span>
            Object result;
<span class="nc bnc" id="L2007" title="All 7 branches missed.">            switch (evt.getCFRType()){</span>
                case Packet.COMMAND_CFR_DOMINO_EFFECT:                    
                    // If the client connects to a game as a bot, it's possible
                    // to have the bot respond AND have the client ask the
                    // player. This is bad, ignore this if the client is a bot
<span class="nc bnc" id="L2012" title="All 2 branches missed.">                    if (client instanceof BotClient){</span>
<span class="nc" id="L2013">                        return;</span>
                    }
<span class="nc" id="L2015">                    MovePath stepForward = new MovePath(client.getGame(), e);</span>
<span class="nc" id="L2016">                    MovePath stepBackward = new MovePath(client.getGame(), e);</span>
<span class="nc" id="L2017">                    stepForward.addStep(MoveStepType.FORWARDS);</span>
<span class="nc" id="L2018">                    stepBackward.addStep(MoveStepType.BACKWARDS);</span>
<span class="nc" id="L2019">                    stepForward.compile(client.getGame(), e, false);</span>
<span class="nc" id="L2020">                    stepBackward.compile(client.getGame(), e, false);</span>
                    
<span class="nc" id="L2022">                    String title = Messages.getString(&quot;CFRDomino.Title&quot;);</span>
<span class="nc" id="L2023">                    String msg = Messages.getString(&quot;CFRDomino.Message&quot;, e.getDisplayName());</span>
                    int choice;
                    Object[] options;
                    MovePath[] paths;
                    int optionType;
<span class="nc bnc" id="L2028" title="All 2 branches missed.">                    if (stepForward.isMoveLegal() </span>
<span class="nc bnc" id="L2029" title="All 2 branches missed.">                            &amp;&amp; stepBackward.isMoveLegal()){</span>
<span class="nc" id="L2030">                        options = new Object[3];</span>
<span class="nc" id="L2031">                        paths = new MovePath[3];</span>
<span class="nc" id="L2032">                        options[0] = Messages.getString(&quot;CFRDomino.Forward&quot;, stepForward.getMpUsed());</span>
<span class="nc" id="L2033">                        options[1] = Messages.getString(&quot;CFRDomino.Backward&quot;, stepForward.getMpUsed());</span>
<span class="nc" id="L2034">                        options[2] = Messages.getString(&quot;CFRDomino.NoAction&quot;);</span>
<span class="nc" id="L2035">                        paths[0] = stepForward;</span>
<span class="nc" id="L2036">                        paths[1] = stepBackward;</span>
<span class="nc" id="L2037">                        paths[2] = null;</span>
<span class="nc" id="L2038">                        optionType = JOptionPane.YES_NO_CANCEL_OPTION;</span>
<span class="nc bnc" id="L2039" title="All 2 branches missed.">                    } else if (stepForward.isMoveLegal()){</span>
<span class="nc" id="L2040">                        options = new Object[2];</span>
<span class="nc" id="L2041">                        paths = new MovePath[2];</span>
<span class="nc" id="L2042">                        options[0] = Messages.getString(&quot;CFRDomino.Forward&quot;,</span>
<span class="nc" id="L2043">                                new Object[] { stepForward.getMpUsed() });</span>
<span class="nc" id="L2044">                        options[1] = Messages.getString(&quot;CFRDomino.NoAction&quot;);</span>
<span class="nc" id="L2045">                        paths[0] = stepForward;</span>
<span class="nc" id="L2046">                        paths[1] = null;</span>
<span class="nc" id="L2047">                        optionType = JOptionPane.YES_NO_OPTION;</span>
                    } else { // No request is sent if both moves are illegal
<span class="nc" id="L2049">                        options = new Object[2];</span>
<span class="nc" id="L2050">                        paths = new MovePath[2];</span>
<span class="nc" id="L2051">                        options[0] = Messages.getString(&quot;CFRDomino.Backward&quot;,</span>
<span class="nc" id="L2052">                                new Object[] { stepForward.getMpUsed() });</span>
<span class="nc" id="L2053">                        options[1] = Messages.getString(&quot;CFRDomino.NoAction&quot;);</span>
<span class="nc" id="L2054">                        paths[0] = stepBackward;</span>
<span class="nc" id="L2055">                        paths[1] = null;</span>
<span class="nc" id="L2056">                        optionType = JOptionPane.YES_NO_OPTION;</span>
                    }            
<span class="nc" id="L2058">                    choice = JOptionPane.showOptionDialog(frame, msg, title, </span>
                            optionType, JOptionPane.QUESTION_MESSAGE, null, 
                            options, options[0]);
                    // If they closed it, assume no action
<span class="nc bnc" id="L2062" title="All 2 branches missed.">                    if (choice == JOptionPane.CLOSED_OPTION){</span>
<span class="nc" id="L2063">                        choice = options.length - 1;</span>
                    }
<span class="nc" id="L2065">                    client.sendDominoCFRResponse(paths[choice]);</span>
<span class="nc" id="L2066">                    break;</span>
                case Packet.COMMAND_CFR_AMS_ASSIGN:
<span class="nc" id="L2068">                    ArrayList&lt;String&gt; amsOptions = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2069">                    amsOptions.add(&quot;None&quot;);</span>
<span class="nc bnc" id="L2070" title="All 2 branches missed.">                    for (WeaponAttackAction waa : evt.getWAAs()) {</span>
<span class="nc" id="L2071">                        Entity ae = waa.getEntity(client.getGame());</span>
                        String waaMsg;
<span class="nc bnc" id="L2073" title="All 2 branches missed.">                        if (ae != null) {</span>
<span class="nc" id="L2074">                            Mounted weapon = ae.getEquipment(waa.getWeaponId());</span>
<span class="nc" id="L2075">                            waaMsg = weapon.getDesc() + &quot; from &quot;</span>
<span class="nc" id="L2076">                                    + ae.getDisplayName();</span>
<span class="nc" id="L2077">                        } else {</span>
<span class="nc" id="L2078">                            waaMsg = &quot;Missiles from unknown attacker&quot;;</span>
                        }
<span class="nc" id="L2080">                        amsOptions.add(waaMsg);</span>
<span class="nc" id="L2081">                    }</span>
                    
<span class="nc" id="L2083">                    optionType = JOptionPane.OK_CANCEL_OPTION;</span>
<span class="nc" id="L2084">                    title = Messages.getString(&quot;CFRAMSAssign.Title&quot;,</span>
<span class="nc" id="L2085">                            new Object[] { e.getDisplayName() });</span>
<span class="nc" id="L2086">                    msg = Messages.getString(&quot;CFRAMSAssign.Message&quot;,</span>
<span class="nc" id="L2087">                            new Object[] { e.getDisplayName() });</span>
<span class="nc" id="L2088">                    result = JOptionPane.showInputDialog(frame, msg, title,</span>
                            JOptionPane.QUESTION_MESSAGE, null, 
<span class="nc" id="L2090">                           amsOptions.toArray(), null);</span>
                    // If they closed it, assume no action
<span class="nc bnc" id="L2092" title="All 4 branches missed.">                    if ((result == null) || result.equals(&quot;None&quot;)) {</span>
<span class="nc" id="L2093">                        client.sendAMSAssignCFRResponse(null);</span>
                    } else {
<span class="nc" id="L2095">                        client.sendAMSAssignCFRResponse(</span>
<span class="nc" id="L2096">                                amsOptions.indexOf(result) - 1);                 </span>
                    }
<span class="nc" id="L2098">                    break;</span>
                case Packet.COMMAND_CFR_APDS_ASSIGN:
<span class="nc" id="L2100">                    ArrayList&lt;String&gt; apdsOptions = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2101">                    apdsOptions.add(&quot;None&quot;);</span>
<span class="nc" id="L2102">                    Iterator&lt;Integer&gt; distIt = evt.getApdsDists().iterator();</span>
<span class="nc bnc" id="L2103" title="All 2 branches missed.">                    for (WeaponAttackAction waa : evt.getWAAs()) {</span>
<span class="nc" id="L2104">                        Entity ae = waa.getEntity(client.getGame());</span>
<span class="nc" id="L2105">                        int dist = distIt.next();</span>
                        String waaMsg;
<span class="nc bnc" id="L2107" title="All 2 branches missed.">                        if (ae != null) {</span>
<span class="nc" id="L2108">                            Mounted weapon = ae.getEquipment(waa.getWeaponId());</span>
<span class="nc" id="L2109">                            waaMsg = weapon.getDesc() + &quot; from &quot;</span>
<span class="nc" id="L2110">                                    + ae.getDisplayName() + &quot; (distance: &quot;</span>
                                    + dist + &quot;)&quot;;
<span class="nc" id="L2112">                        } else {</span>
<span class="nc" id="L2113">                            waaMsg = &quot;Missiles from unknown attacker&quot;;</span>
                        }
<span class="nc" id="L2115">                        apdsOptions.add(waaMsg);</span>
<span class="nc" id="L2116">                    }</span>

<span class="nc" id="L2118">                    optionType = JOptionPane.OK_CANCEL_OPTION;</span>
<span class="nc" id="L2119">                    title = Messages.getString(&quot;CFRAPDSAssign.Title&quot;,</span>
<span class="nc" id="L2120">                            new Object[] { e.getDisplayName() });</span>
<span class="nc" id="L2121">                    msg = Messages.getString(&quot;CFRAPDSAssign.Message&quot;,</span>
<span class="nc" id="L2122">                            new Object[] { e.getDisplayName() });</span>
<span class="nc" id="L2123">                    result = JOptionPane.showInputDialog(frame, msg, title,</span>
                            JOptionPane.QUESTION_MESSAGE, null,
<span class="nc" id="L2125">                            apdsOptions.toArray(), null);</span>
                    // If they closed it, assume no action
<span class="nc bnc" id="L2127" title="All 4 branches missed.">                    if ((result == null) || result.equals(&quot;None&quot;)) {</span>
<span class="nc" id="L2128">                        client.sendAPDSAssignCFRResponse(null);</span>
                    } else {
<span class="nc" id="L2130">                        client.sendAPDSAssignCFRResponse(</span>
<span class="nc" id="L2131">                                apdsOptions.indexOf(result) - 1);</span>
                    }
<span class="nc" id="L2133">                    break;</span>
                case Packet.COMMAND_CFR_HIDDEN_PBS:
<span class="nc" id="L2135">                    Entity attacker = client.getGame().getEntity(</span>
<span class="nc" id="L2136">                            evt.getEntityId());</span>
<span class="nc" id="L2137">                    Entity target = client.getGame().getEntity(</span>
<span class="nc" id="L2138">                            evt.getTargetId());</span>
                    // Are we not the client handling the PBS?
<span class="nc bnc" id="L2140" title="All 4 branches missed.">                    if ((attacker == null) || (target == null)) {</span>
<span class="nc bnc" id="L2141" title="All 2 branches missed.">                        if (curPanel instanceof StatusBarPhaseDisplay) {</span>
<span class="nc" id="L2142">                            ((StatusBarPhaseDisplay) curPanel)</span>
<span class="nc" id="L2143">                                    .setStatusBarText(Messages</span>
<span class="nc" id="L2144">                                            .getString(&quot;StatusBarPhaseDisplay.pointblankShot&quot;));</span>
                        }
<span class="nc" id="L2146">                        return;</span>
                    }
                    // If this is the client to handle the PBS, take care of it
<span class="nc" id="L2149">                    bv.centerOnHex(attacker.getPosition());</span>
<span class="nc" id="L2150">                    bv.highlight(attacker.getPosition());</span>
<span class="nc" id="L2151">                    bv.select(target.getPosition());</span>
<span class="nc" id="L2152">                    bv.cursor(target.getPosition());</span>
<span class="nc" id="L2153">                    msg = Messages.getString(&quot;ClientGUI.PointBlankShot.Message&quot;,</span>
<span class="nc" id="L2154">                            target.getShortName(), attacker.getShortName());</span>
<span class="nc" id="L2155">                    title = Messages.getString(&quot;ClientGUI.PointBlankShot.Title&quot;);</span>
                    // Ask whether the player wants to take a PBS or not
<span class="nc" id="L2157">                    int pbsChoice = JOptionPane.showConfirmDialog(frame, msg,</span>
                            title, JOptionPane.YES_NO_OPTION,
                            JOptionPane.QUESTION_MESSAGE);
                    // Process the PBS - switch to PointblankShotDisplay
<span class="nc bnc" id="L2161" title="All 2 branches missed.">                    if (pbsChoice == JOptionPane.YES_OPTION) {</span>
                        // Send a non-null response to indicate PBS is accepted
                        // This allows the servers to notify the clients,
                        // as they may be in for a wait
<span class="nc" id="L2165">                        client.sendHiddenPBSCFRResponse(new Vector&lt;&gt;());</span>
                        // Used to indicate it's this player's turn
<span class="nc" id="L2167">                        setPointblankEID(evt.getEntityId());</span>
                        // Switch to the right display
<span class="nc" id="L2169">                        switchPanel(IGame.Phase.PHASE_POINTBLANK_SHOT);</span>
<span class="nc" id="L2170">                        PointblankShotDisplay curDisp = ((PointblankShotDisplay) curPanel);</span>
                        // Set targeting info
<span class="nc" id="L2172">                        curDisp.beginMyTurn();</span>
<span class="nc" id="L2173">                        curDisp.selectEntity(evt.getEntityId());</span>
<span class="nc" id="L2174">                        curDisp.target(target);</span>
<span class="nc" id="L2175">                        bv.select(target.getPosition());</span>
<span class="nc" id="L2176">                    } else { // PBS declined</span>
<span class="nc" id="L2177">                        client.sendHiddenPBSCFRResponse(null);</span>
                    }
<span class="nc" id="L2179">                    break;</span>
                case Packet.COMMAND_CFR_TELEGUIDED_TARGET:
<span class="nc" id="L2181">                    List&lt;Integer&gt; targetIds = evt.getTelemissileTargetIds();</span>
<span class="nc" id="L2182">                    List&lt;Integer&gt; toHitValues = evt.getTmToHitValues();</span>
<span class="nc" id="L2183">                    List&lt;String&gt; targetDescriptions = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L2184" title="All 2 branches missed.">                    for (int i = 0; i &lt; targetIds.size(); i++) {</span>
<span class="nc" id="L2185">                        int id = targetIds.get(i);</span>
<span class="nc" id="L2186">                        int th = toHitValues.get(i);</span>
<span class="nc" id="L2187">                        Entity tgt = client.getGame().getEntity(id);</span>
<span class="nc bnc" id="L2188" title="All 2 branches missed.">                        if (tgt != null) {</span>
<span class="nc" id="L2189">                            targetDescriptions.add(String.format(Messages.getString(&quot;TeleMissileTargetDialog.target&quot;), tgt.getDisplayName(), th));</span>
                        }
                    }
                    //Set up the selection pane
<span class="nc" id="L2193">                    String i18nString = &quot;TeleMissileTargetDialog.message&quot;; //$NON-NLS-1$;</span>
<span class="nc" id="L2194">                    msg = Messages.getString(i18nString);</span>
<span class="nc" id="L2195">                    i18nString = &quot;TeleMissileTargetDialog.title&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L2196">                    title = Messages.getString(i18nString);</span>
<span class="nc" id="L2197">                    String input = (String) JOptionPane.showInputDialog(frame, msg,</span>
                            title, JOptionPane.QUESTION_MESSAGE, null,
<span class="nc" id="L2199">                            targetDescriptions.toArray(), targetDescriptions.get(0));</span>
<span class="nc bnc" id="L2200" title="All 2 branches missed.">                    if (input != null) {</span>
<span class="nc bnc" id="L2201" title="All 2 branches missed.">                        for (int i = 0; i &lt; targetDescriptions.size(); i++) {</span>
<span class="nc bnc" id="L2202" title="All 2 branches missed.">                            if (input.equals(targetDescriptions.get(i))) {</span>
<span class="nc" id="L2203">                                client.sendTelemissileTargetCFRResponse(i);</span>
<span class="nc" id="L2204">                                break;</span>
                            }
                        }
                    } else {
                        //If input IS null, as in the case of pressing the close or cancel buttons...
                        //Just pick the first target in the list, or server will be left waiting indefinitely.
<span class="nc" id="L2210">                        client.sendTelemissileTargetCFRResponse(0);</span>
                    }
                case Packet.COMMAND_CFR_TAG_TARGET:
<span class="nc" id="L2213">                    List&lt;Integer&gt; TAGTargets = evt.getTAGTargets();</span>
<span class="nc" id="L2214">                    List&lt;Integer&gt; TAGTargetTypes = evt.getTAGTargetTypes();</span>
<span class="nc" id="L2215">                    List&lt;String&gt; TAGTargetDescriptions = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L2216" title="All 2 branches missed.">                    for (int i = 0; i &lt; TAGTargets.size(); i++) {</span>
<span class="nc" id="L2217">                        int id = TAGTargets.get(i);</span>
<span class="nc" id="L2218">                        int nType = TAGTargetTypes.get(i);</span>
<span class="nc" id="L2219">                        Targetable tgt = client.getGame().getTarget(nType, id);</span>
<span class="nc bnc" id="L2220" title="All 2 branches missed.">                        if (tgt != null) {</span>
<span class="nc" id="L2221">                            TAGTargetDescriptions.add(tgt.getDisplayName());</span>
                        }
                    }
                    //Set up the selection pane
<span class="nc" id="L2225">                    i18nString = &quot;TAGTargetDialog.message&quot;; //$NON-NLS-1$;</span>
<span class="nc" id="L2226">                    msg = Messages.getString(i18nString);</span>
<span class="nc" id="L2227">                    i18nString = &quot;TAGTargetDialog.title&quot;; //$NON-NLS-1$</span>
<span class="nc" id="L2228">                    title = Messages.getString(i18nString);</span>
<span class="nc" id="L2229">                    input = (String) JOptionPane.showInputDialog(frame, msg,</span>
                            title, JOptionPane.QUESTION_MESSAGE, null,
<span class="nc" id="L2231">                            TAGTargetDescriptions.toArray(), TAGTargetDescriptions.get(0));</span>
<span class="nc bnc" id="L2232" title="All 2 branches missed.">                    if (input != null) {</span>
<span class="nc bnc" id="L2233" title="All 2 branches missed.">                        for (int i = 0; i &lt; TAGTargetDescriptions.size(); i++) {</span>
<span class="nc bnc" id="L2234" title="All 2 branches missed.">                            if (input.equals(TAGTargetDescriptions.get(i))) {</span>
<span class="nc" id="L2235">                                client.sendTAGTargetCFRResponse(i);</span>
<span class="nc" id="L2236">                                break;</span>
                            }
                        }
                    } else {
                        //If input IS null, as in the case of pressing the close or cancel buttons...
                        //Just pick the first target in the list, or server will be left waiting indefinitely.
<span class="nc" id="L2242">                        client.sendTAGTargetCFRResponse(0);</span>
                    }
            }
<span class="nc" id="L2245">        }</span>
    };

    public Client getClient() {
<span class="nc" id="L2249">        return client;</span>
    }

    public Map&lt;String, Client&gt; getBots() {
<span class="nc" id="L2253">        return client.bots;</span>
    }

    /**
     * @return Returns the selectedEntityNum.
     */
    public int getSelectedEntityNum() {
<span class="nc" id="L2260">        return selectedEntityNum;</span>
    }

    /**
     * @param selectedEntityNum The selectedEntityNum to set.
     */
    public void setSelectedEntityNum(int selectedEntityNum) {
<span class="nc" id="L2267">        this.selectedEntityNum = selectedEntityNum;</span>
<span class="nc" id="L2268">        bv.selectEntity(client.getGame().getEntity(selectedEntityNum));</span>
<span class="nc" id="L2269">    }</span>

    public RandomArmyDialog getRandomArmyDialog() {
<span class="nc" id="L2272">        return randomArmyDialog;</span>
    }

    public RandomSkillDialog getRandomSkillDialog() {
<span class="nc" id="L2276">        return randomSkillDialog;</span>
    }

    public RandomNameDialog getRandomNameDialog() {
<span class="nc" id="L2280">        return new RandomNameDialog(this);</span>
    }

    /**
     * Checks to see if there is already a path and name stored; if not, calls
     * &quot;save as&quot;; otherwise, saves the board to the specified file.
     */
    private void boardSave() {
<span class="nc bnc" id="L2288" title="All 2 branches missed.">        if (curfileBoard == null) {</span>
<span class="nc" id="L2289">            boardSaveAs();</span>
<span class="nc" id="L2290">            return;</span>
        }
        // save!
<span class="nc" id="L2293">        try (OutputStream os = new FileOutputStream(curfileBoard)) {</span>
<span class="nc" id="L2294">            client.getGame().getBoard().save(os);</span>
<span class="nc" id="L2295">        } catch (IOException e) {</span>
<span class="nc" id="L2296">            MegaMek.getLogger().error(&quot;Error opening file to save!&quot;, e);</span>
<span class="nc" id="L2297">        }</span>
<span class="nc" id="L2298">    }</span>

    /**
     * Saves the board in PNG image format.
     */
    private void boardSaveImage(boolean ignoreUnits) {
<span class="nc bnc" id="L2304" title="All 2 branches missed.">        if (curfileBoardImage == null) {</span>
<span class="nc" id="L2305">            boardSaveAsImage(ignoreUnits);</span>
<span class="nc" id="L2306">            return;</span>
        }
<span class="nc" id="L2308">        JDialog waitD = new JDialog(frame, Messages.getString(&quot;BoardEditor.waitDialog.title&quot;));</span>
<span class="nc" id="L2309">        waitD.add(new JLabel(Messages.getString(&quot;BoardEditor.waitDialog.message&quot;)));</span>
<span class="nc" id="L2310">        waitD.setSize(250, 130);</span>
        // move to middle of screen
<span class="nc" id="L2312">        waitD.setLocation(</span>
<span class="nc" id="L2313">                (frame.getSize().width / 2) - (waitD.getSize().width / 2), (frame</span>
<span class="nc" id="L2314">                .getSize().height</span>
<span class="nc" id="L2315">                / 2) - (waitD.getSize().height / 2));</span>
<span class="nc" id="L2316">        waitD.setVisible(true);</span>
<span class="nc" id="L2317">        frame.setCursor(Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR));</span>
<span class="nc" id="L2318">        waitD.setCursor(Cursor.getPredefinedCursor(Cursor.WAIT_CURSOR));</span>
        // save!
        try {
<span class="nc" id="L2321">            ImageIO.write(bv.getEntireBoardImage(ignoreUnits), &quot;png&quot;, curfileBoardImage);</span>
<span class="nc" id="L2322">        } catch (IOException e) {</span>
<span class="nc" id="L2323">            e.printStackTrace();</span>
<span class="nc" id="L2324">        }</span>
<span class="nc" id="L2325">        waitD.setVisible(false);</span>
<span class="nc" id="L2326">        frame.setCursor(Cursor.getDefaultCursor());</span>
<span class="nc" id="L2327">    }</span>

    /**
     * Opens a file dialog box to select a file to save as; saves the board to
     * the file.
     */
    private void boardSaveAs() {
<span class="nc" id="L2334">        JFileChooser fc = new JFileChooser(&quot;data&quot; + File.separator + &quot;boards&quot;);</span>
<span class="nc" id="L2335">        fc.setLocation(frame.getLocation().x + 150, frame.getLocation().y + 100);</span>
<span class="nc" id="L2336">        fc.setDialogTitle(Messages.getString(&quot;BoardEditor.saveBoardAs&quot;));</span>
<span class="nc" id="L2337">        fc.setFileFilter(new BoardFileFilter());</span>
<span class="nc" id="L2338">        int returnVal = fc.showSaveDialog(frame);</span>
<span class="nc bnc" id="L2339" title="All 4 branches missed.">        if ((returnVal != JFileChooser.APPROVE_OPTION) || (fc.getSelectedFile() == null)) {</span>
            // I want a file, y'know!
<span class="nc" id="L2341">            return;</span>
        }
<span class="nc" id="L2343">        curfileBoard = fc.getSelectedFile();</span>

        // make sure the file ends in board
<span class="nc bnc" id="L2346" title="All 2 branches missed.">        if (!curfileBoard.getName().toLowerCase(Locale.ENGLISH).endsWith(&quot;.board&quot;)) {</span>
            try {
<span class="nc" id="L2348">                curfileBoard = new File(curfileBoard.getCanonicalPath() + &quot;.board&quot;);</span>
<span class="nc" id="L2349">            } catch (IOException ie) {</span>
                // failure!
<span class="nc" id="L2351">                return;</span>
<span class="nc" id="L2352">            }</span>
        }
<span class="nc" id="L2354">        boardSave();</span>
<span class="nc" id="L2355">    }</span>

    /**
     * Opens a file dialog box to select a file to save as; saves the board to
     * the file as an image. Useful for printing boards.
     */
    private void boardSaveAsImage(boolean ignoreUnits) {
<span class="nc" id="L2362">        JFileChooser fc = new JFileChooser(&quot;.&quot;);</span>
<span class="nc" id="L2363">        fc.setLocation(frame.getLocation().x + 150, frame.getLocation().y + 100);</span>
<span class="nc" id="L2364">        fc.setDialogTitle(Messages.getString(&quot;BoardEditor.saveAsImage&quot;));</span>
<span class="nc" id="L2365">        fc.setFileFilter(new FileFilter() {</span>
            @Override
            public boolean accept(File dir) {
<span class="nc bnc" id="L2368" title="All 4 branches missed.">                return (dir.getName().endsWith(&quot;.png&quot;) || dir.isDirectory());</span>
            }

            @Override
            public String getDescription() {
<span class="nc" id="L2373">                return &quot;.png&quot;;</span>
            }
        });
<span class="nc" id="L2376">        int returnVal = fc.showSaveDialog(frame);</span>
<span class="nc bnc" id="L2377" title="All 4 branches missed.">        if ((returnVal != JFileChooser.APPROVE_OPTION) || (fc.getSelectedFile() == null)) {</span>
            // I want a file, y'know!
<span class="nc" id="L2379">            return;</span>
        }
<span class="nc" id="L2381">        curfileBoardImage = fc.getSelectedFile();</span>

        // make sure the file ends in png
<span class="nc bnc" id="L2384" title="All 2 branches missed.">        if (!curfileBoardImage.getName().toLowerCase(Locale.ENGLISH).endsWith(&quot;.png&quot;)) {</span>
            try {
<span class="nc" id="L2386">                curfileBoardImage = new File(curfileBoardImage.getCanonicalPath() + &quot;.png&quot;);</span>
<span class="nc" id="L2387">            } catch (IOException ie) {</span>
                // failure!
<span class="nc" id="L2389">                return;</span>
<span class="nc" id="L2390">            }</span>
        }
<span class="nc" id="L2392">        boardSaveImage(ignoreUnits);</span>
<span class="nc" id="L2393">    }</span>

    @Override
    public void hexMoused(BoardViewEvent b) {
<span class="nc bnc" id="L2397" title="All 2 branches missed.">        if (b.getType() == BoardViewEvent.BOARD_HEX_POPUP) {</span>
<span class="nc" id="L2398">            showBoardPopup(b.getCoords());</span>
        }
<span class="nc" id="L2400">    }</span>

    @Override
    public void hexCursor(BoardViewEvent b) {
        // ignored
<span class="nc" id="L2405">    }</span>

    @Override
    public void boardHexHighlighted(BoardViewEvent b) {
        // ignored
<span class="nc" id="L2410">    }</span>

    @Override
    public void hexSelected(BoardViewEvent b) {
        // ignored
<span class="nc" id="L2415">    }</span>

    @Override
    public void firstLOSHex(BoardViewEvent b) {
        // ignored
<span class="nc" id="L2420">    }</span>

    @Override
    public void secondLOSHex(BoardViewEvent b, Coords c) {
        // ignored
<span class="nc" id="L2425">    }</span>

    @Override
    public void finishedMovingUnits(BoardViewEvent b) {
        // ignored
<span class="nc" id="L2430">    }</span>

    @Override
    public void unitSelected(BoardViewEvent b) {
        // ignored
<span class="nc" id="L2435">    }</span>
    
    /**
     * Returns true if a dialog is visible on top of the &lt;code&gt;ClientGUI&lt;/code&gt;.
     * For example, the &lt;code&gt;MegaMekController&lt;/code&gt; should ignore hotkeys
     * if there is a dialog, like the &lt;code&gt;CommonSettingsDialog&lt;/code&gt;, open.
     * @return
     */
    public boolean shouldIgnoreHotKeys(){
<span class="nc bnc" id="L2444" title="All 4 branches missed.">        return ignoreHotKeys </span>
<span class="nc bnc" id="L2445" title="All 4 branches missed.">                || ((gameOptionsDialog != null) &amp;&amp; gameOptionsDialog.isVisible())</span>
<span class="nc bnc" id="L2446" title="All 4 branches missed.">                || ((about != null) &amp;&amp; about.isVisible())</span>
<span class="nc bnc" id="L2447" title="All 4 branches missed.">                || ((help != null) &amp;&amp; help.isVisible())</span>
<span class="nc bnc" id="L2448" title="All 4 branches missed.">                || ((setdlg != null) &amp;&amp; setdlg.isVisible())</span>
<span class="nc bnc" id="L2449" title="All 2 branches missed.">                || ((aw != null) &amp;&amp; aw.isVisible());</span>
    }

    @Override
    public void componentHidden(ComponentEvent arg0) {

<span class="nc" id="L2455">    }</span>

    @Override
    public void componentMoved(ComponentEvent arg0) {

<span class="nc" id="L2460">    }</span>

    @Override
    public void componentResized(ComponentEvent arg0) {
<span class="nc" id="L2464">        bv.setPreferredSize(getSize());        </span>
<span class="nc" id="L2465">    }</span>

    @Override
    public void componentShown(ComponentEvent arg0) {

<span class="nc" id="L2470">    }</span>

    void replacePlayer() {
<span class="nc" id="L2473">        Set&lt;IPlayer&gt; ghostPlayers = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L2474" title="All 2 branches missed.">        for (IPlayer p : client.getGame().getPlayersVector()) {</span>
<span class="nc bnc" id="L2475" title="All 2 branches missed.">            if (p.isGhost()) {</span>
<span class="nc" id="L2476">                ghostPlayers.add(p);</span>
            }
<span class="nc" id="L2478">        }</span>
<span class="nc bnc" id="L2479" title="All 2 branches missed.">        if (ghostPlayers.isEmpty()) {</span>
<span class="nc" id="L2480">            JOptionPane.showMessageDialog(this, &quot;No ghost players to replace.&quot;, &quot;No Ghosts&quot;,</span>
                                          JOptionPane.INFORMATION_MESSAGE);
<span class="nc" id="L2482">            return;</span>
        }

<span class="nc" id="L2485">        BotConfigDialog botConfigDialog = new BotConfigDialog(this.frame, ghostPlayers);</span>
<span class="nc" id="L2486">        botConfigDialog.setModal(true);</span>
<span class="nc" id="L2487">        botConfigDialog.setVisible(true);</span>
<span class="nc bnc" id="L2488" title="All 2 branches missed.">        if (botConfigDialog.dialogAborted) {</span>
<span class="nc" id="L2489">            return;</span>
        }
<span class="nc" id="L2491">        AddBotUtil util = new AddBotUtil();</span>
<span class="nc" id="L2492">        BotClient botClient = botConfigDialog.getSelectedBot(client.getHost(), client.getPort());</span>
        String[] args;
<span class="nc" id="L2494">        Collection&lt;String&gt; playersToReplace = botConfigDialog.getPlayerToReplace();</span>
<span class="nc" id="L2495">        Collection&lt;String[]&gt; replaceCommands = new HashSet&lt;&gt;(playersToReplace.size());</span>
<span class="nc bnc" id="L2496" title="All 2 branches missed.">        if (botClient instanceof Princess) {</span>
<span class="nc bnc" id="L2497" title="All 2 branches missed.">            for (String player : playersToReplace) {</span>
<span class="nc" id="L2498">                args = new String[]{</span>
                        &quot;/replacePlayer&quot;,
                        &quot;-b:Princess&quot;,
<span class="nc" id="L2501">                        &quot;-c:&quot; + ((Princess) botClient).getBehaviorSettings().getDescription(),</span>
<span class="nc" id="L2502">                        &quot;-v:&quot; + ((Princess) botClient).getVerbosity(),</span>
                        &quot;-p:&quot; + player
                };
<span class="nc" id="L2505">                replaceCommands.add(args);</span>
<span class="nc" id="L2506">            }</span>
        } else {
<span class="nc bnc" id="L2508" title="All 2 branches missed.">            for (String player : playersToReplace) {</span>
<span class="nc" id="L2509">                args = new String[]{</span>
                        &quot;/replacePlayer&quot;,
                        player
                };
<span class="nc" id="L2513">                replaceCommands.add(args);</span>
<span class="nc" id="L2514">            }</span>
        }
<span class="nc" id="L2516">        botClient.die();</span>
<span class="nc bnc" id="L2517" title="All 2 branches missed.">        for (String[] cmd : replaceCommands) {</span>
<span class="nc" id="L2518">            util.addBot(cmd, client.getGame(), client.getHost(), client.getPort());</span>
<span class="nc" id="L2519">        }</span>
<span class="nc" id="L2520">    }</span>
    
    /**
     * Returns the panel for the current phase.  The ClientGUI is split into
     * the main panel (view) at the top, which takes up the majority of the view
     * and the the &quot;current panel&quot; which has different controls  based on the
     * phase.
     * 
     * @return
     */
    public JComponent getCurrentPanel() {
<span class="nc" id="L2531">        return curPanel;</span>
    }

    public boolean isProcessingPointblankShot() {
<span class="nc bnc" id="L2535" title="All 2 branches missed.">        return pointblankEID != Entity.NONE;</span>
    }

    public void setPointblankEID(int eid) {
<span class="nc" id="L2539">        this.pointblankEID = eid;</span>
<span class="nc" id="L2540">    }</span>

    public int getPointblankEID() {
<span class="nc" id="L2543">        return pointblankEID;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>