<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="nl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WeaponAttackAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">PlayerTest Coverage Results</a> &gt; <a href="index.source.html" class="el_package">megamek.common.actions</a> &gt; <span class="el_source">WeaponAttackAction.java</span></div><h1>WeaponAttackAction.java</h1><pre class="source lang-java linenums">/*
 * MegaMek - Copyright (C) 2000,2001,2002,2003,2004 Ben Mazur (bmazur@sev.org)
 *
 *  This program is free software; you can redistribute it and/or modify it
 *  under the terms of the GNU General Public License as published by the Free
 *  Software Foundation; either version 2 of the License, or (at your option)
 *  any later version.
 *
 *  This program is distributed in the hope that it will be useful, but
 *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
 *  for more details.
 */

package megamek.common.actions;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.Enumeration;
import java.util.List;
import java.util.Vector;

import megamek.client.ui.Messages;
import megamek.common.Aero;
import megamek.common.AmmoType;
import megamek.common.BattleArmor;
import megamek.common.BipedMech;
import megamek.common.Board;
import megamek.common.BombType;
import megamek.common.CalledShot;
import megamek.common.Compute;
import megamek.common.ComputeECM;
import megamek.common.Coords;
import megamek.common.Crew;
import megamek.common.CriticalSlot;
import megamek.common.Dropship;
import megamek.common.ECMInfo;
import megamek.common.Entity;
import megamek.common.EntityMovementMode;
import megamek.common.EntityMovementType;
import megamek.common.EquipmentType;
import megamek.common.GunEmplacement;
import megamek.common.HexTarget;
import megamek.common.IAero;
import megamek.common.IAimingModes;
import megamek.common.IGame;
import megamek.common.IHex;
import megamek.common.ILocationExposureStatus;
import megamek.common.INarcPod;
import megamek.common.Infantry;
import megamek.common.Jumpship;
import megamek.common.LandAirMech;
import megamek.common.LosEffects;
import megamek.common.Mech;
import megamek.common.MechWarrior;
import megamek.common.MinefieldTarget;
import megamek.common.MiscType;
import megamek.common.Mounted;
import megamek.common.PlanetaryConditions;
import megamek.common.Protomech;
import megamek.common.QuadMech;
import megamek.common.QuadVee;
import megamek.common.RangeType;
import megamek.common.SpaceStation;
import megamek.common.SpecialResolutionTracker;
import megamek.common.SupportTank;
import megamek.common.SupportVTOL;
import megamek.common.TagInfo;
import megamek.common.Tank;
import megamek.common.TargetRoll;
import megamek.common.Targetable;
import megamek.common.Terrains;
import megamek.common.ToHitData;
import megamek.common.TripodMech;
import megamek.common.VTOL;
import megamek.common.Warship;
import megamek.common.WeaponType;
import megamek.common.options.OptionsConstants;
import megamek.common.weapons.DiveBombAttack;
import megamek.common.weapons.InfantryAttack;
import megamek.common.weapons.Weapon;
import megamek.common.weapons.artillery.ArtilleryCannonWeapon;
import megamek.common.weapons.artillery.ArtilleryWeapon;
import megamek.common.weapons.bayweapons.LaserBayWeapon;
import megamek.common.weapons.bayweapons.PPCBayWeapon;
import megamek.common.weapons.bayweapons.PulseLaserBayWeapon;
import megamek.common.weapons.bayweapons.ScreenLauncherBayWeapon;
import megamek.common.weapons.capitalweapons.CapitalMissileWeapon;
import megamek.common.weapons.gaussrifles.GaussWeapon;
import megamek.common.weapons.gaussrifles.ISHGaussRifle;
import megamek.common.weapons.lasers.ISBombastLaser;
import megamek.common.weapons.lasers.VariableSpeedPulseLaserWeapon;
import megamek.common.weapons.lrms.LRTWeapon;
import megamek.common.weapons.mortars.MekMortarWeapon;
import megamek.common.weapons.other.TSEMPWeapon;
import megamek.common.weapons.srms.SRTWeapon;

/**
 * Represents intention to fire a weapon at the target.
 */
public class WeaponAttackAction extends AbstractAttackAction implements Serializable {
    /**
     *
     */
    private static final long serialVersionUID = -9096603813317359351L;
    
    public static final int STRATOPS_SENSOR_SHADOW_WEIGHT_DIFF = 100000;
    
    private int weaponId;
<span class="nc" id="L110">    private int ammoId = -1;</span>
<span class="nc" id="L111">    private int ammoCarrier = -1;</span>
<span class="nc" id="L112">    private int aimedLocation = Entity.LOC_NONE;</span>
<span class="nc" id="L113">    private int aimMode = IAimingModes.AIM_MODE_NONE;</span>
<span class="nc" id="L114">    private int otherAttackInfo = -1; //</span>
    private boolean nemesisConfused;
    private boolean swarmingMissiles;
<span class="nc" id="L117">    protected int launchVelocity = 50;</span>
    /**
     * Keeps track of the ID of the current primary target for a swarm missile
     * attack.
     */
<span class="nc" id="L122">    private int oldTargetId = -1;</span>

    /**
     * Keeps track of the Targetable type for the current primary target for a
     * swarm missile attack.
     */
    private int oldTargetType;

    /**
     * Keeps track of the ID of the original target for a swarm missile attack.
     */
<span class="nc" id="L133">    private int originalTargetId = Entity.NONE;</span>

    /**
     * Keeps track of the type of the original target for a swarm missile
     * attack.
     */
    private int originalTargetType;

<span class="nc" id="L141">    private int swarmMissiles = 0;</span>

    // bomb stuff
<span class="nc" id="L144">    private int[] bombPayload = new int[BombType.B_NUM];</span>

    // equipment that affects this attack (AMS, ECM?, etc)
    // only used server-side
    private transient ArrayList&lt;Mounted&gt; vCounterEquipment;

    /**
     * Boolean flag that determines whether or not this attack is part of a
     * strafing run.
     */
<span class="nc" id="L154">    private boolean isStrafing = false;</span>

    /**
     * Boolean flag that determines if this shot was the first one by a
     * particular weapon in a strafing run. Used to ensure that heat is only
     * added once.
     */
<span class="nc" id="L161">    protected boolean isStrafingFirstShot = false;</span>

    /**
     * Boolean flag that determines if this shot was fired as part of a
     * pointblank shot from a hidden unit. In this case, to-hit numbers should
     * not be modified for terrain or movement. See TW pg 260
     */
<span class="nc" id="L168">    protected boolean isPointblankShot = false;</span>
    
    /**
     * Boolean flag that determines if this shot was fired using homing ammunition.
     * Can be checked to allow casting of attack handlers to the proper homing handler.
     */
<span class="nc" id="L174">    protected boolean isHomingShot = false;</span>

    // default to attacking an entity
    public WeaponAttackAction(int entityId, int targetId, int weaponId) {
<span class="nc" id="L178">        super(entityId, targetId);</span>
<span class="nc" id="L179">        this.weaponId = weaponId;</span>
<span class="nc" id="L180">    }</span>

    public WeaponAttackAction(int entityId, int targetType, int targetId, int weaponId) {
<span class="nc" id="L183">        super(entityId, targetType, targetId);</span>
<span class="nc" id="L184">        this.weaponId = weaponId;</span>
<span class="nc" id="L185">    }</span>

    public int getWeaponId() {
<span class="nc" id="L188">        return weaponId;</span>
    }

    public int getAmmoId() {
<span class="nc" id="L192">        return ammoId;</span>
    }
    
    /**
     * Returns the entity id of the unit carrying the ammo used by this attack
     * @return
     */
    public int getAmmoCarrier() {
<span class="nc" id="L200">        return ammoCarrier;</span>
    }

    public int getAimedLocation() {
<span class="nc" id="L204">        return aimedLocation;</span>
    }

    public int getAimingMode() {
<span class="nc" id="L208">        return aimMode;</span>
    }

    public ArrayList&lt;Mounted&gt; getCounterEquipment() {
<span class="nc" id="L212">        return vCounterEquipment;</span>
    }

    public void setWeaponId(int weaponId) {
<span class="nc" id="L216">        this.weaponId = weaponId;</span>
<span class="nc" id="L217">    }</span>

    public void setAmmoId(int ammoId) {
<span class="nc" id="L220">        this.ammoId = ammoId;</span>
<span class="nc" id="L221">    }</span>
    
    /**
     * Sets the entity id of the ammo carrier for this shot, if different than the firing entity
     * @param entityId
     */
    public void setAmmoCarrier(int entityId) {
<span class="nc" id="L228">        this.ammoCarrier = entityId;</span>
<span class="nc" id="L229">    }</span>

    public void setAimedLocation(int aimedLocation) {
<span class="nc" id="L232">        this.aimedLocation = aimedLocation;</span>
<span class="nc" id="L233">    }</span>

    public void setAimingMode(int aimMode) {
<span class="nc" id="L236">        this.aimMode = aimMode;</span>
<span class="nc" id="L237">    }</span>

    public void addCounterEquipment(Mounted m) {
<span class="nc bnc" id="L240" title="All 2 branches missed.">        if (vCounterEquipment == null) {</span>
<span class="nc" id="L241">            vCounterEquipment = new ArrayList&lt;Mounted&gt;();</span>
        }
<span class="nc" id="L243">        vCounterEquipment.add(m);</span>
<span class="nc" id="L244">    }</span>

    public void setOtherAttackInfo(int newInfo) {
<span class="nc" id="L247">        otherAttackInfo = newInfo;</span>
<span class="nc" id="L248">    }</span>

    public int getOtherAttackInfo() {
<span class="nc" id="L251">        return otherAttackInfo;</span>
    }

    public boolean isAirToGround(IGame game) {
<span class="nc" id="L255">        return Compute.isAirToGround(getEntity(game), getTarget(game));</span>
    }

    public boolean isAirToAir(IGame game) {
<span class="nc" id="L259">        return Compute.isAirToAir(getEntity(game), getTarget(game));</span>
    }

    public boolean isGroundToAir(IGame game) {
<span class="nc" id="L263">        return Compute.isGroundToAir(getEntity(game), getTarget(game));</span>
    }

    public boolean isDiveBomb(IGame game) {
<span class="nc" id="L267">        return ((WeaponType) getEntity(game).getEquipment(getWeaponId()).getType()).hasFlag(WeaponType.F_DIVE_BOMB);</span>
    }

    public int getAltitudeLoss(IGame game) {
<span class="nc bnc" id="L271" title="All 2 branches missed.">        if (isAirToGround(game)) {</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">            if (((WeaponType) getEntity(game).getEquipment(getWeaponId()).getType()).hasFlag(WeaponType.F_DIVE_BOMB)) {</span>
<span class="nc" id="L273">                return 2;</span>
            }
<span class="nc bnc" id="L275" title="All 2 branches missed.">            if (((WeaponType) getEntity(game).getEquipment(getWeaponId()).getType()).hasFlag(WeaponType.F_ALT_BOMB)) {</span>
<span class="nc" id="L276">                return 0;</span>
            }
<span class="nc bnc" id="L278" title="All 2 branches missed.">            if (isStrafing) {</span>
<span class="nc" id="L279">                return 0;</span>
            } else {
<span class="nc" id="L281">                return 1;</span>
            }
        }
<span class="nc" id="L284">        return 0;</span>
    }

    public ToHitData toHit(IGame game) {
<span class="nc" id="L288">        return WeaponAttackAction.toHit(game, getEntityId(), game.getTarget(getTargetType(), getTargetId()),</span>
<span class="nc" id="L289">                getWeaponId(), getAimedLocation(), getAimingMode(), nemesisConfused, swarmingMissiles,</span>
<span class="nc" id="L290">                game.getTarget(getOldTargetType(), getOldTargetId()),</span>
<span class="nc" id="L291">                game.getTarget(getOriginalTargetType(), getOriginalTargetId()), isStrafing(), isPointblankShot());</span>
    }

    public ToHitData toHit(IGame game, List&lt;ECMInfo&gt; allECMInfo) {
<span class="nc" id="L295">        return WeaponAttackAction.toHit(game, getEntityId(), game.getTarget(getTargetType(), getTargetId()),</span>
<span class="nc" id="L296">                getWeaponId(), getAimedLocation(), getAimingMode(), nemesisConfused, swarmingMissiles,</span>
<span class="nc" id="L297">                game.getTarget(getOldTargetType(), getOldTargetId()),</span>
<span class="nc" id="L298">                game.getTarget(getOriginalTargetType(), getOriginalTargetId()), isStrafing(), isPointblankShot(),</span>
                allECMInfo);
    }

    public static ToHitData toHit(IGame game, int attackerId, Targetable target, int weaponId, boolean isStrafing) {
<span class="nc" id="L303">        return WeaponAttackAction.toHit(game, attackerId, target, weaponId, Entity.LOC_NONE, IAimingModes.AIM_MODE_NONE,</span>
                false, false, null, null, isStrafing, false);
    }

    public static ToHitData toHit(IGame game, int attackerId, Targetable target, int weaponId, int aimingAt,
            int aimingMode, boolean isStrafing) {
<span class="nc" id="L309">        return WeaponAttackAction.toHit(game, attackerId, target, weaponId, aimingAt, aimingMode, false, false, null,</span>
                null, isStrafing, false);
    }

    public static ToHitData toHit(IGame game, int attackerId, Targetable target, int weaponId, int aimingAt,
            int aimingMode, boolean isNemesisConfused, boolean exchangeSwarmTarget, Targetable oldTarget,
            Targetable originalTarget, boolean isStrafing, boolean isPointblankShot) {
<span class="nc" id="L316">        return WeaponAttackAction.toHit(game, attackerId, target, weaponId, aimingAt, aimingMode, isNemesisConfused,</span>
                exchangeSwarmTarget, oldTarget, originalTarget, isStrafing, isPointblankShot, null);
    }

    /**
     * To-hit number for attacker firing a weapon at the target.
     */
    private static ToHitData toHit(IGame game, int attackerId, Targetable target, int weaponId, int aimingAt,
            int aimingMode, boolean isNemesisConfused, boolean exchangeSwarmTarget, Targetable oldTarget,
            Targetable originalTarget, boolean isStrafing, boolean isPointblankShot, List&lt;ECMInfo&gt; allECMInfo) {
<span class="nc" id="L326">        final Entity ae = game.getEntity(attackerId);</span>
<span class="nc" id="L327">        final Mounted weapon = ae.getEquipment(weaponId);</span>
        
<span class="nc" id="L329">        final WeaponType wtype = (WeaponType) weapon.getType();</span>
        
        // This is ok to keep here. No need to process anything further if we're not using a weapon somehow
<span class="nc bnc" id="L332" title="All 2 branches missed.">        if (!(wtype instanceof WeaponType)) {</span>
<span class="nc" id="L333">            return new ToHitData(TargetRoll.AUTOMATIC_FAIL, Messages.getString(&quot;WeaponAttackAction.NotAWeapon&quot;));</span>
        }

<span class="nc" id="L336">        Targetable swarmSecondaryTarget = target;</span>
<span class="nc" id="L337">        Targetable swarmPrimaryTarget = oldTarget;</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">        if (exchangeSwarmTarget) {</span>
            // this is a swarm attack against a new target
            // first, exchange original and new targets to get all mods
            // as if firing against original target.
            // at the end of this function, we remove target terrain
            // and movement mods, and add those for the new target
<span class="nc" id="L344">            Targetable tempTarget = target;</span>
<span class="nc" id="L345">            target = originalTarget;</span>
<span class="nc" id="L346">            originalTarget = tempTarget;</span>
        }
<span class="nc" id="L348">        Entity te = null;</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">        if (target.getTargetType() == Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L350">            te = (Entity) target;</span>
        }
<span class="nc" id="L352">        boolean isAttackerInfantry = ae instanceof Infantry;</span>
        
<span class="nc bnc" id="L354" title="All 4 branches missed.">        boolean isWeaponInfantry = wtype.hasFlag(WeaponType.F_INFANTRY) &amp;&amp; !ae.isSupportVehicle();</span>
        
<span class="nc bnc" id="L356" title="All 4 branches missed.">        boolean isWeaponFieldGuns = isAttackerInfantry &amp;&amp; (weapon.getLocation() == Infantry.LOC_FIELD_GUNS);</span>
        // 2003-01-02 BattleArmor MG and Small Lasers have unlimited ammo.
        // 2002-09-16 Infantry weapons have unlimited ammo.
        
<span class="nc bnc" id="L360" title="All 4 branches missed.">        final boolean usesAmmo = (wtype.getAmmoType() != AmmoType.T_NA) &amp;&amp; !isWeaponInfantry;</span>
        
<span class="nc bnc" id="L362" title="All 2 branches missed.">        final Mounted ammo = usesAmmo ? weapon.getLinked() : null;</span>
        
<span class="nc bnc" id="L364" title="All 2 branches missed.">        final AmmoType atype = ammo == null ? null : (AmmoType) ammo.getType();</span>
        
<span class="nc" id="L366">        long munition = AmmoType.M_STANDARD;</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">        if (atype != null) {</span>
<span class="nc" id="L368">            munition = atype.getMunitionType();</span>
        }
        
<span class="nc" id="L371">        final boolean targetInBuilding = Compute.isInBuilding(game, te);</span>
        
<span class="nc" id="L373">        boolean bMekTankStealthActive = false;</span>
<span class="nc bnc" id="L374" title="All 4 branches missed.">        if ((ae instanceof Mech) || (ae instanceof Tank)) {</span>
<span class="nc" id="L375">            bMekTankStealthActive = ae.isStealthActive();</span>
        }
        
<span class="nc bnc" id="L378" title="All 4 branches missed.">        boolean isFlakAttack = !game.getBoard().inSpace() &amp;&amp; (te != null)</span>
<span class="nc bnc" id="L379" title="All 6 branches missed.">                &amp;&amp; (te.isAirborne() || te.isAirborneVTOLorWIGE()) &amp;&amp; (atype != null)</span>
<span class="nc bnc" id="L380" title="All 4 branches missed.">                &amp;&amp; ((((atype.getAmmoType() == AmmoType.T_AC_LBX) || (atype.getAmmoType() == AmmoType.T_AC_LBX_THB)</span>
<span class="nc bnc" id="L381" title="All 6 branches missed.">                        || (atype.getAmmoType() == AmmoType.T_SBGAUSS))</span>
                        &amp;&amp; (munition == AmmoType.M_CLUSTER))
<span class="nc bnc" id="L383" title="All 2 branches missed.">                        || (munition == AmmoType.M_FLAK) || (atype.getAmmoType() == AmmoType.T_HAG));</span>
        
<span class="nc bnc" id="L385" title="All 4 branches missed.">        boolean isIndirect = (wtype.hasModes() &amp;&amp; weapon.curMode().equals(Weapon.MODE_MISSILE_INDIRECT));</span>
        
<span class="nc bnc" id="L387" title="All 2 branches missed.">        boolean isInferno = ((atype != null)</span>
<span class="nc bnc" id="L388" title="All 2 branches missed.">                &amp;&amp; ((atype.getAmmoType() == AmmoType.T_SRM)</span>
<span class="nc bnc" id="L389" title="All 2 branches missed.">                        || (atype.getAmmoType() == AmmoType.T_SRM_IMP)</span>
<span class="nc bnc" id="L390" title="All 2 branches missed.">                        || (atype.getAmmoType() == AmmoType.T_MML))</span>
<span class="nc bnc" id="L391" title="All 4 branches missed.">                &amp;&amp; (atype.getMunitionType() == AmmoType.M_INFERNO))</span>
<span class="nc bnc" id="L392" title="All 2 branches missed.">                || (isWeaponInfantry &amp;&amp; (wtype.hasFlag(WeaponType.F_INFERNO)));</span>
        
<span class="nc bnc" id="L394" title="All 4 branches missed.">        boolean isArtilleryDirect = (wtype.hasFlag(WeaponType.F_ARTILLERY) ||</span>
                (wtype instanceof CapitalMissileWeapon
<span class="nc bnc" id="L396" title="All 2 branches missed.">                        &amp;&amp; Compute.isGroundToGround(ae, target)))</span>
<span class="nc bnc" id="L397" title="All 2 branches missed.">                &amp;&amp; (game.getPhase() == IGame.Phase.PHASE_FIRING);</span>
        
<span class="nc bnc" id="L399" title="All 4 branches missed.">        boolean isArtilleryIndirect = (wtype.hasFlag(WeaponType.F_ARTILLERY) ||</span>
                (wtype instanceof CapitalMissileWeapon
<span class="nc bnc" id="L401" title="All 2 branches missed.">                        &amp;&amp; Compute.isGroundToGround(ae, target)))</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">                &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_TARGETING)</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">                        || (game.getPhase() == IGame.Phase.PHASE_OFFBOARD));</span>
        
<span class="nc bnc" id="L405" title="All 2 branches missed.">        boolean isBearingsOnlyMissile = (weapon.isInBearingsOnlyMode())</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">                            &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_TARGETING)</span>
<span class="nc bnc" id="L407" title="All 2 branches missed.">                                    || (game.getPhase() == IGame.Phase.PHASE_FIRING));</span>
        
<span class="nc bnc" id="L409" title="All 4 branches missed.">        boolean isCruiseMissile = (weapon.getType().hasFlag(WeaponType.F_CRUISE_MISSILE)</span>
                        || (wtype instanceof CapitalMissileWeapon
<span class="nc bnc" id="L411" title="All 2 branches missed.">                                &amp;&amp; Compute.isGroundToGround(ae, target)));</span>
        
        // hack, otherwise when actually resolves shot labeled impossible.
<span class="nc bnc" id="L414" title="All 4 branches missed.">        boolean isArtilleryFLAK = isArtilleryDirect &amp;&amp; (te != null)</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">                &amp;&amp; ((((te.getMovementMode() == EntityMovementMode.VTOL)</span>
<span class="nc bnc" id="L416" title="All 4 branches missed.">                        || (te.getMovementMode() == EntityMovementMode.WIGE)) &amp;&amp; te.isAirborneVTOLorWIGE())</span>
<span class="nc bnc" id="L417" title="All 6 branches missed.">                        || (te.isAirborne()))</span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">                &amp;&amp; (atype != null) &amp;&amp; (usesAmmo &amp;&amp; (atype.getMunitionType() == AmmoType.M_STANDARD));</span>
        
<span class="nc" id="L420">        boolean isHaywireINarced = ae.isINarcedWith(INarcPod.HAYWIRE);</span>
        
<span class="nc" id="L422">        boolean isINarcGuided = false;</span>
        
        // for attacks where ECM along flight path makes a difference
<span class="nc" id="L425">        boolean isECMAffected = ComputeECM.isAffectedByECM(ae, ae.getPosition(), target.getPosition(), allECMInfo);</span>
        
        // for attacks where only ECM on the target hex makes a difference
<span class="nc" id="L428">        boolean isTargetECMAffected = ComputeECM.isAffectedByECM(ae, target.getPosition(), target.getPosition(),</span>
                allECMInfo);
        
<span class="nc" id="L431">        boolean isTAG = wtype.hasFlag(WeaponType.F_TAG);</span>
        
        // target type checked later because its different for
        // direct/indirect (BMRr p77 on board arrow IV)
<span class="nc bnc" id="L435" title="All 4 branches missed.">        boolean isHoming = ammo != null &amp;&amp; ammo.isHomingAmmoInHomingMode();</span>

<span class="nc bnc" id="L437" title="All 2 branches missed.">        boolean bHeatSeeking = (atype != null)</span>
<span class="nc bnc" id="L438" title="All 2 branches missed.">                &amp;&amp; ((atype.getAmmoType() == AmmoType.T_SRM)</span>
<span class="nc bnc" id="L439" title="All 2 branches missed.">                        || (atype.getAmmoType() == AmmoType.T_SRM_IMP)</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">                        || (atype.getAmmoType() == AmmoType.T_MML)</span>
<span class="nc bnc" id="L441" title="All 2 branches missed.">                        || (atype.getAmmoType() == AmmoType.T_LRM)</span>
<span class="nc bnc" id="L442" title="All 4 branches missed.">                        || (atype.getAmmoType() == AmmoType.T_LRM_IMP))</span>
                &amp;&amp; (munition == AmmoType.M_HEAT_SEEKING);
        
<span class="nc bnc" id="L445" title="All 2 branches missed.">        boolean bFTL = (atype != null)</span>
<span class="nc bnc" id="L446" title="All 2 branches missed.">                &amp;&amp; ((atype.getAmmoType() == AmmoType.T_MML) </span>
<span class="nc bnc" id="L447" title="All 2 branches missed.">                        || (atype.getAmmoType() == AmmoType.T_LRM)</span>
<span class="nc bnc" id="L448" title="All 4 branches missed.">                        || (atype.getAmmoType() == AmmoType.T_LRM_IMP))</span>
                &amp;&amp; (munition == AmmoType.M_FOLLOW_THE_LEADER);

<span class="nc" id="L451">        Mounted mLinker = weapon.getLinkedBy();</span>
               
<span class="nc bnc" id="L453" title="All 6 branches missed.">        boolean bApollo = ((mLinker != null) &amp;&amp; (mLinker.getType() instanceof MiscType) &amp;&amp; !mLinker.isDestroyed()</span>
<span class="nc bnc" id="L454" title="All 8 branches missed.">                &amp;&amp; !mLinker.isMissing() &amp;&amp; !mLinker.isBreached() &amp;&amp; mLinker.getType().hasFlag(MiscType.F_APOLLO))</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">                &amp;&amp; (atype != null) &amp;&amp; (atype.getAmmoType() == AmmoType.T_MRM);</span>
        
<span class="nc bnc" id="L457" title="All 6 branches missed.">        boolean bArtemisV = ((mLinker != null) &amp;&amp; (mLinker.getType() instanceof MiscType) &amp;&amp; !mLinker.isDestroyed()</span>
<span class="nc bnc" id="L458" title="All 14 branches missed.">                &amp;&amp; !mLinker.isMissing() &amp;&amp; !mLinker.isBreached() &amp;&amp; mLinker.getType().hasFlag(MiscType.F_ARTEMIS_V)</span>
                &amp;&amp; !isECMAffected &amp;&amp; !bMekTankStealthActive &amp;&amp; (atype != null)
                &amp;&amp; (munition == AmmoType.M_ARTEMIS_V_CAPABLE));
        
<span class="nc bnc" id="L462" title="All 2 branches missed.">        if (ae.usesWeaponBays()) {</span>
<span class="nc bnc" id="L463" title="All 2 branches missed.">            for (int wId : weapon.getBayWeapons()) {</span>
<span class="nc" id="L464">                Mounted bayW = ae.getEquipment(wId);</span>
<span class="nc" id="L465">                Mounted bayWAmmo = bayW.getLinked();</span>

<span class="nc bnc" id="L467" title="All 2 branches missed.">                if (bayWAmmo == null) {</span>
                    //At present, all weapons below using mLinker use ammo, so this won't be a problem
<span class="nc" id="L469">                    continue;</span>
                }
<span class="nc" id="L471">                AmmoType bAmmo = (AmmoType) bayWAmmo.getType();</span>
                
                //If we're using optional rules and firing Arrow Homing missiles from a bay...
<span class="nc bnc" id="L474" title="All 4 branches missed.">                isHoming = bAmmo != null &amp;&amp; bAmmo.getMunitionType() == AmmoType.M_HOMING;</span>
                
                //If the artillery bay is firing cruise missiles, they have some special rules
                //It is possible to combine cruise missiles and other artillery in a bay, so
                //set this to true if any of the weapons are cruise missile launchers.
<span class="nc bnc" id="L479" title="All 2 branches missed.">                if (bayW.getType().hasFlag(WeaponType.F_CRUISE_MISSILE)) {</span>
<span class="nc" id="L480">                    isCruiseMissile = true;</span>
                }

<span class="nc" id="L483">                mLinker = bayW.getLinkedBy();</span>
<span class="nc bnc" id="L484" title="All 6 branches missed.">                bApollo = ((mLinker != null) &amp;&amp; (mLinker.getType() instanceof MiscType) &amp;&amp; !mLinker.isDestroyed()</span>
<span class="nc bnc" id="L485" title="All 8 branches missed.">                        &amp;&amp; !mLinker.isMissing() &amp;&amp; !mLinker.isBreached() &amp;&amp; mLinker.getType().hasFlag(MiscType.F_APOLLO))</span>
<span class="nc bnc" id="L486" title="All 2 branches missed.">                        &amp;&amp; (bAmmo != null) &amp;&amp; (bAmmo.getAmmoType() == AmmoType.T_MRM);</span>
                
<span class="nc bnc" id="L488" title="All 6 branches missed.">                bArtemisV = ((mLinker != null) &amp;&amp; (mLinker.getType() instanceof MiscType) &amp;&amp; !mLinker.isDestroyed()</span>
<span class="nc bnc" id="L489" title="All 14 branches missed.">                        &amp;&amp; !mLinker.isMissing() &amp;&amp; !mLinker.isBreached() &amp;&amp; mLinker.getType().hasFlag(MiscType.F_ARTEMIS_V)</span>
                        &amp;&amp; !isECMAffected &amp;&amp; !bMekTankStealthActive &amp;&amp; (atype != null)
<span class="nc bnc" id="L491" title="All 2 branches missed.">                        &amp;&amp; (bAmmo != null) &amp;&amp; (bAmmo.getMunitionType() == AmmoType.M_ARTEMIS_V_CAPABLE));</span>
<span class="nc" id="L492">            }</span>
        }
        
<span class="nc" id="L495">        boolean inSameBuilding = Compute.isInSameBuilding(game, ae, te);</span>
        
        //Set up the target's relative elevation/depth
        int targEl;

<span class="nc bnc" id="L500" title="All 2 branches missed.">        if (te == null) {</span>
<span class="nc" id="L501">            targEl = -game.getBoard().getHex(target.getPosition()).depth();</span>
        } else {
<span class="nc" id="L503">            targEl = te.relHeight();</span>
        }

        // is this attack originating from underwater
        // TODO: assuming that torpedoes are underwater attacks even if fired
        // from surface vessel, awaiting rules clarification
        // http://www.classicbattletech.com/forums/index.php/topic,48744.0.html
<span class="nc bnc" id="L510" title="All 6 branches missed.">        boolean underWater = (ae.getLocationStatus(weapon.getLocation()) == ILocationExposureStatus.WET)</span>
                || (wtype instanceof SRTWeapon) || (wtype instanceof LRTWeapon);

<span class="nc bnc" id="L513" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc bnc" id="L514" title="All 6 branches missed.">            if (!isTargetECMAffected &amp;&amp; te.isINarcedBy(ae.getOwner().getTeam()) &amp;&amp; (atype != null)</span>
<span class="nc bnc" id="L515" title="All 2 branches missed.">                    &amp;&amp; ((atype.getAmmoType() == AmmoType.T_LRM)</span>
<span class="nc bnc" id="L516" title="All 2 branches missed.">                            || (atype.getAmmoType() == AmmoType.T_LRM_IMP)</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">                            || (atype.getAmmoType() == AmmoType.T_MML)</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">                            || (atype.getAmmoType() == AmmoType.T_SRM)</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">                            || (atype.getAmmoType() == AmmoType.T_SRM_IMP) </span>
<span class="nc bnc" id="L520" title="All 4 branches missed.">                            || (atype.getAmmoType() == AmmoType.T_NLRM))</span>
                    &amp;&amp; (munition == AmmoType.M_NARC_CAPABLE)) {
<span class="nc" id="L522">                isINarcGuided = true;</span>
            }
        }
<span class="nc" id="L525">        int toSubtract = 0;</span>
        
        //Convenience variable to test the targetable type value
<span class="nc" id="L528">        final int ttype = target.getTargetType();</span>
      
        // if we're doing indirect fire, find a spotter
<span class="nc" id="L531">        Entity spotter = null;</span>
<span class="nc" id="L532">        boolean narcSpotter = false;</span>
<span class="nc bnc" id="L533" title="All 4 branches missed.">        if (isIndirect &amp;&amp; !ae.hasAbility(OptionsConstants.GUNNERY_OBLIQUE_ATTACKER)) {</span>
<span class="nc bnc" id="L534" title="All 12 branches missed.">            if ((target instanceof Entity) &amp;&amp; !isTargetECMAffected &amp;&amp; (te != null) &amp;&amp; (atype != null) &amp;&amp; usesAmmo</span>
                    &amp;&amp; (munition == AmmoType.M_NARC_CAPABLE)
<span class="nc bnc" id="L536" title="All 4 branches missed.">                    &amp;&amp; (te.isNarcedBy(ae.getOwner().getTeam()) || te.isINarcedBy(ae.getOwner().getTeam()))) {</span>
<span class="nc" id="L537">                spotter = te;</span>
<span class="nc" id="L538">                narcSpotter = true;</span>
            } else {
<span class="nc" id="L540">                spotter = Compute.findSpotter(game, ae, target);</span>
            }
<span class="nc bnc" id="L542" title="All 4 branches missed.">            if ((spotter == null) &amp;&amp; (atype != null)</span>
<span class="nc bnc" id="L543" title="All 2 branches missed.">                    &amp;&amp; ((atype.getAmmoType() == AmmoType.T_LRM)</span>
<span class="nc bnc" id="L544" title="All 2 branches missed.">                            || (atype.getAmmoType() == AmmoType.T_LRM_IMP)</span>
<span class="nc bnc" id="L545" title="All 2 branches missed.">                            || (atype.getAmmoType() == AmmoType.T_MML)</span>
<span class="nc bnc" id="L546" title="All 2 branches missed.">                            || (atype.getAmmoType() == AmmoType.T_NLRM)</span>
<span class="nc bnc" id="L547" title="All 4 branches missed.">                            || (atype.getAmmoType() == AmmoType.T_MEK_MORTAR))</span>
                    &amp;&amp; (munition == AmmoType.M_SEMIGUIDED)) {
<span class="nc bnc" id="L549" title="All 2 branches missed.">                for (TagInfo ti : game.getTagInfo()) {</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">                    if (target.getTargetId() == ti.target.getTargetId()) {</span>
<span class="nc" id="L551">                        spotter = game.getEntity(ti.attackerId);</span>
                    }
<span class="nc" id="L553">                }</span>
            }
        }

        // EI system
        // 0 if no EI (or switched off)
        // 1 if no intervening light woods
        // 2 if intervening light woods (because target in woods + intervening
        // woods is only +1 total)
<span class="nc" id="L562">        int eistatus = 0;</span>

<span class="nc" id="L564">        boolean mpMelevationHack = false;</span>
<span class="nc bnc" id="L565" title="All 2 branches missed.">        if (usesAmmo </span>
<span class="nc bnc" id="L566" title="All 8 branches missed.">                &amp;&amp; ((wtype.getAmmoType() == AmmoType.T_LRM) || (wtype.getAmmoType() == AmmoType.T_LRM_IMP))  </span>
                &amp;&amp; (atype != null)
                &amp;&amp; (munition == AmmoType.M_MULTI_PURPOSE) 
<span class="nc bnc" id="L569" title="All 2 branches missed.">                &amp;&amp; (ae.getElevation() == -1)</span>
<span class="nc bnc" id="L570" title="All 2 branches missed.">                &amp;&amp; (ae.getLocationStatus(weapon.getLocation()) == ILocationExposureStatus.WET)) {</span>
<span class="nc" id="L571">            mpMelevationHack = true;</span>
            // surface to fire
<span class="nc" id="L573">            ae.setElevation(0);</span>
        }
        
        // check LOS (indirect LOS is from the spotter)
        LosEffects los;
        ToHitData losMods;
<span class="nc bnc" id="L579" title="All 6 branches missed.">        if (isIndirect &amp;&amp; ae.hasAbility(OptionsConstants.GUNNERY_OBLIQUE_ATTACKER)</span>
                &amp;&amp; !underWater) {
<span class="nc" id="L581">            los = new LosEffects();</span>
<span class="nc" id="L582">            losMods = new ToHitData();</span>
<span class="nc bnc" id="L583" title="All 4 branches missed.">        } else if (!isIndirect || (spotter == null)) {</span>
<span class="nc bnc" id="L584" title="All 2 branches missed.">            if (!exchangeSwarmTarget) {</span>
<span class="nc" id="L585">                los = LosEffects.calculateLos(game, attackerId, target);</span>
            } else {
                // Swarm should draw LoS between targets, not attacker, since
                // we don't want LoS to be blocked
<span class="nc bnc" id="L589" title="All 2 branches missed.">                if (swarmPrimaryTarget.getTargetType() == Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L590">                    los = LosEffects.calculateLos(game, swarmPrimaryTarget.getTargetId(), swarmSecondaryTarget);</span>
                } else {
<span class="nc" id="L592">                    los = LosEffects.calculateLos(game, swarmSecondaryTarget.getTargetId(), swarmPrimaryTarget);</span>
                }
            }

<span class="nc bnc" id="L596" title="All 2 branches missed.">            if (ae.hasActiveEiCockpit()) {</span>
<span class="nc bnc" id="L597" title="All 2 branches missed.">                if (los.getLightWoods() &gt; 0) {</span>
<span class="nc" id="L598">                    eistatus = 2;</span>
                } else {
<span class="nc" id="L600">                    eistatus = 1;</span>
                }
            }

<span class="nc bnc" id="L604" title="All 4 branches missed.">            if ((wtype instanceof MekMortarWeapon) &amp;&amp; isIndirect) {</span>
<span class="nc" id="L605">                los.setArcedAttack(true);</span>
            }

<span class="nc" id="L608">            losMods = los.losModifiers(game, eistatus, underWater);</span>
        } else {
<span class="nc bnc" id="L610" title="All 2 branches missed.">            if (exchangeSwarmTarget) {</span>
                // Swarm should draw LoS between targets, not attacker, since
                // we don't want LoS to be blocked
<span class="nc bnc" id="L613" title="All 2 branches missed.">                if (swarmPrimaryTarget.getTargetType() == Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L614">                    los = LosEffects.calculateLos(game, swarmPrimaryTarget.getTargetId(), swarmSecondaryTarget);</span>
                } else {
<span class="nc" id="L616">                    los = LosEffects.calculateLos(game, swarmSecondaryTarget.getTargetId(), swarmPrimaryTarget);</span>
                }
            } else {
                //For everything else, set up a plain old LOS
<span class="nc" id="L620">                los = LosEffects.calculateLos(game, spotter.getId(), target, true);</span>
            }

            // do not count attacker partial cover in indirect fire
<span class="nc" id="L624">            los.setAttackerCover(LosEffects.COVER_NONE);</span>

<span class="nc bnc" id="L626" title="All 4 branches missed.">            if (!narcSpotter &amp;&amp; spotter.hasActiveEiCockpit()) {</span>
<span class="nc bnc" id="L627" title="All 2 branches missed.">                if (los.getLightWoods() &gt; 0) {</span>
<span class="nc" id="L628">                    eistatus = 2;</span>
                } else {
<span class="nc" id="L630">                    eistatus = 1;</span>
                }
            }

<span class="nc bnc" id="L634" title="All 2 branches missed.">            if (wtype instanceof MekMortarWeapon) {</span>
<span class="nc" id="L635">                los.setArcedAttack(true);</span>
            }

<span class="nc" id="L638">            losMods = los.losModifiers(game, underWater);</span>
        }
<span class="nc bnc" id="L640" title="All 2 branches missed.">        if (mpMelevationHack) {</span>
            // return to depth 1
<span class="nc" id="L642">            ae.setElevation(-1);</span>
        }
        
        // determine some more variables
<span class="nc" id="L646">        int aElev = ae.getElevation();</span>
<span class="nc" id="L647">        int tElev = target.getElevation();</span>
<span class="nc" id="L648">        int distance = Compute.effectiveDistance(game, ae, target);</span>
        
        //Set up our initial toHit data
<span class="nc" id="L651">        ToHitData toHit = new ToHitData();</span>
        
        //Check to see if this attack is impossible and return the reason code
<span class="nc" id="L654">        String reasonImpossible = WeaponAttackAction.toHitIsImpossible(game, ae, attackerId, target, ttype, los, losMods,</span>
                toHit, distance, spotter, wtype, weapon, weaponId, atype, ammo, munition,
                isArtilleryDirect, isArtilleryFLAK, isArtilleryIndirect, isAttackerInfantry, isBearingsOnlyMissile,
                isCruiseMissile, exchangeSwarmTarget, isHoming, isInferno, isIndirect, isStrafing, isTAG,  
                targetInBuilding, usesAmmo, underWater);
<span class="nc bnc" id="L659" title="All 2 branches missed.">        if (reasonImpossible != null) {</span>
<span class="nc" id="L660">            return new ToHitData(TargetRoll.IMPOSSIBLE, reasonImpossible);</span>
        }
        
        //Check to see if this attack is automatically successful and return the reason code
<span class="nc" id="L664">        String reasonAutoHit = WeaponAttackAction.toHitIsAutomatic(game, ae, target, ttype, los, distance,</span>
                wtype, weapon, isBearingsOnlyMissile);
<span class="nc bnc" id="L666" title="All 2 branches missed.">        if (reasonAutoHit != null) {</span>
<span class="nc" id="L667">            return new ToHitData(TargetRoll.AUTOMATIC_SUCCESS, reasonAutoHit);</span>
        }
        
<span class="nc" id="L670">        SpecialResolutionTracker srt = new SpecialResolutionTracker();</span>
<span class="nc" id="L671">        srt.setSpecialResolution(false);</span>
        //Is this an infantry leg/swarm attack?
<span class="nc" id="L673">        toHit = handleInfantrySwarmAttacks(game, ae, target, ttype, toHit, wtype, srt);</span>
<span class="nc bnc" id="L674" title="All 2 branches missed.">        if (srt.isSpecialResolution()) {</span>
<span class="nc" id="L675">            return toHit;</span>
        }
        
        //Check to see if this attack was made with a weapon that has special to-hit rules
<span class="nc" id="L679">        toHit = handleSpecialWeaponAttacks(game, ae, target, ttype, los, toHit, wtype, atype, srt);</span>
<span class="nc bnc" id="L680" title="All 2 branches missed.">        if (srt.isSpecialResolution()) {</span>
<span class="nc" id="L681">            return toHit;</span>
        }
        
        //This attack has now tested possible and doesn't follow any weird special rules,
        //so let's start adding up the to-hit numbers
        
        //Start with the attacker's weapon skill
<span class="nc" id="L688">        toHit = new ToHitData(ae.getCrew().getGunnery(), Messages.getString(&quot;WeaponAttackAction.GunSkill&quot;));</span>
<span class="nc bnc" id="L689" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.RPG_RPG_GUNNERY)) {</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_ENERGY)) {</span>
<span class="nc" id="L691">                toHit = new ToHitData(ae.getCrew().getGunneryL(), Messages.getString(&quot;WeaponAttackAction.GunLSkill&quot;));</span>
            }
<span class="nc bnc" id="L693" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_MISSILE)) {</span>
<span class="nc" id="L694">                toHit = new ToHitData(ae.getCrew().getGunneryM(), Messages.getString(&quot;WeaponAttackAction.GunMSkill&quot;));</span>
            }
<span class="nc bnc" id="L696" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_BALLISTIC)) {</span>
<span class="nc" id="L697">                toHit = new ToHitData(ae.getCrew().getGunneryB(), Messages.getString(&quot;WeaponAttackAction.GunBSkill&quot;));</span>
            }
        }
<span class="nc bnc" id="L700" title="All 4 branches missed.">        if (wtype.hasFlag(WeaponType.F_ARTILLERY) &amp;&amp; game.getOptions().booleanOption(OptionsConstants.RPG_ARTILLERY_SKILL)) {</span>
<span class="nc" id="L701">            toHit = new ToHitData(ae.getCrew().getArtillery(), Messages.getString(&quot;WeaponAttackAction.ArtySkill&quot;));</span>
        }
        
        // Is this an Artillery attack?
<span class="nc bnc" id="L705" title="All 4 branches missed.">        if (isArtilleryDirect || isArtilleryIndirect) {</span>
<span class="nc" id="L706">            toHit = handleArtilleryAttacks(game, ae, target, ttype, losMods, toHit, wtype, weapon, atype, isArtilleryDirect,</span>
                    isArtilleryFLAK, isArtilleryIndirect, isHoming, usesAmmo, srt);
        }
<span class="nc bnc" id="L709" title="All 2 branches missed.">        if (srt.isSpecialResolution()) {</span>
<span class="nc" id="L710">            return toHit;</span>
        }
        
        //Mine launchers have their own base to-hit, but can still be affected by terrain and movement modifiers
        //thus, they don't qualify for special weapon handling
<span class="nc bnc" id="L715" title="All 2 branches missed.">        if (BattleArmor.MINE_LAUNCHER.equals(wtype.getInternalName())) {</span>
<span class="nc" id="L716">            toHit = new ToHitData(8, Messages.getString(&quot;WeaponAttackAction.MagMine&quot;));</span>
        }

        // TODO: mech making DFA could be higher if DFA target hex is higher
        // BMRr pg. 43, &quot;attacking unit is considered to be in the air
        // above the hex, standing on an elevation 1 level higher than
        // the target hex or the elevation of the hex the attacker is
        // in, whichever is higher.&quot;
            // Ancient rules - have we implemented this per TW?
        
        // Store the thruBldg state, for later processing
<span class="nc" id="L727">        toHit.setThruBldg(los.getThruBldg());</span>
        
        // Collect the modifiers for the environment
<span class="nc" id="L730">        toHit = compileEnvironmentalToHitMods(game, ae, target, wtype, atype, toHit, isArtilleryIndirect);</span>
        
        // Collect the modifiers for the crew/pilot
<span class="nc" id="L733">        toHit = compileCrewToHitMods(game, ae, te, toHit, wtype);</span>
        
        // Collect the modifiers for the attacker's condition/actions
<span class="nc bnc" id="L736" title="All 2 branches missed.">        if (ae != null) {</span>
            //Conventional fighter, Aerospace and fighter LAM attackers
<span class="nc bnc" id="L738" title="All 2 branches missed.">            if (ae.isAero()) {</span>
<span class="nc" id="L739">                toHit = compileAeroAttackerToHitMods(game, ae, target, ttype, toHit, aimingAt, aimingMode, eistatus,</span>
                            wtype, weapon, atype, munition, isArtilleryIndirect, isFlakAttack, isNemesisConfused, isStrafing,
                            usesAmmo);
            //Everyone else
            } else {
<span class="nc" id="L744">                toHit = compileAttackerToHitMods(game, ae, target, los, toHit, toSubtract, aimingAt, aimingMode, wtype,</span>
                        weapon, weaponId, atype, munition, isFlakAttack, isHaywireINarced, isNemesisConfused,
                        isWeaponFieldGuns, usesAmmo);
            }
        }
        
        // Collect the modifiers for the target's condition/actions 
<span class="nc" id="L751">        toHit = compileTargetToHitMods(game, ae, target, ttype, los, toHit, toSubtract, aimingAt, aimingMode, distance,</span>
                    wtype, weapon, atype, munition, isArtilleryDirect, isArtilleryIndirect, isAttackerInfantry,
                    exchangeSwarmTarget, isIndirect, isPointblankShot, usesAmmo);
        
        // Collect the modifiers for terrain and line-of-sight. This includes any related to-hit table changes
<span class="nc" id="L756">        toHit = compileTerrainAndLosToHitMods(game, ae, target, ttype, aElev, tElev, targEl, distance, los, toHit,</span>
                    losMods, toSubtract, eistatus, wtype, weapon, weaponId, atype, munition, isAttackerInfantry,
                    inSameBuilding, isIndirect, isPointblankShot, underWater);
        
        // If this is a swarm LRM secondary attack, remove old target movement and terrain mods, then
        // add those for new target.
<span class="nc bnc" id="L762" title="All 2 branches missed.">        if (exchangeSwarmTarget) {</span>
<span class="nc" id="L763">            toHit = handleSwarmSecondaryAttacks(game, ae, target, swarmPrimaryTarget, swarmSecondaryTarget, toHit,</span>
                    toSubtract, eistatus, aimingAt, aimingMode, weapon, atype, munition, isECMAffected,
                    inSameBuilding, underWater);
        }

        // Collect the modifiers specific to the weapon the attacker is using
<span class="nc" id="L769">        toHit = compileWeaponToHitMods(game, ae, spotter, target, ttype, toHit, wtype, weapon, atype, munition,</span>
                    isFlakAttack, isIndirect, narcSpotter);
        
        // Collect the modifiers specific to the ammo the attacker is using
<span class="nc" id="L773">        toHit = compileAmmoToHitMods(game, ae, target, ttype, toHit, wtype, weapon, atype, munition, bApollo,</span>
                    bArtemisV, bFTL, bHeatSeeking, isECMAffected, isINarcGuided);
        
        // okay!
<span class="nc" id="L777">        return toHit;</span>
    }

    /**
     * To-hit number for attacker firing a generic weapon at the target. Does
     * not factor in any special weapon or ammo considerations, including range
     * modifiers. Also does not include gunnery skill.
     */
    public static ToHitData toHit(IGame game, int attackerId, Targetable target) {
<span class="nc" id="L786">        final Entity ae = game.getEntity(attackerId);</span>

<span class="nc" id="L788">        Entity te = null;</span>
<span class="nc" id="L789">        int ttype = target.getTargetType();</span>
<span class="nc bnc" id="L790" title="All 2 branches missed.">        if (ttype == Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L791">            te = (Entity) target;</span>
        }

<span class="nc" id="L794">        int aElev = ae.getElevation();</span>
<span class="nc" id="L795">        int tElev = target.getElevation();</span>
        int targEl;
<span class="nc bnc" id="L797" title="All 2 branches missed.">        if (te == null) {</span>
<span class="nc" id="L798">            targEl = game.getBoard().getHex(target.getPosition()).floor();</span>
        } else {
<span class="nc" id="L800">            targEl = te.relHeight();</span>
        }
        
<span class="nc" id="L803">        int toSubtract = 0;</span>
<span class="nc" id="L804">        int distance = Compute.effectiveDistance(game, ae, target);</span>
        
        // EI system
        // 0 if no EI (or switched off)
        // 1 if no intervening light woods
        // 2 if intervening light woods (because target in woods + intervening
        // woods is only +1 total)
<span class="nc" id="L811">        int eistatus = 0;</span>
        
        // Bogus value, since this method doesn't account for weapons but some of its calls do
<span class="nc" id="L814">        int weaponId = WeaponType.WEAPON_NA;</span>
        
<span class="nc" id="L816">        boolean isAttackerInfantry = ae instanceof Infantry;</span>
<span class="nc" id="L817">        boolean inSameBuilding = Compute.isInSameBuilding(game, ae, te);</span>

        // check LOS
<span class="nc" id="L820">        LosEffects los = LosEffects.calculateLos(game, attackerId, target);</span>

<span class="nc bnc" id="L822" title="All 2 branches missed.">        if (ae.hasActiveEiCockpit()) {</span>
<span class="nc bnc" id="L823" title="All 2 branches missed.">            if (los.getLightWoods() &gt; 0) {</span>
<span class="nc" id="L824">                eistatus = 2;</span>
            } else {
<span class="nc" id="L826">                eistatus = 1;</span>
            }
        }

<span class="nc" id="L830">        ToHitData losMods = los.losModifiers(game, eistatus, ae.isUnderwater());</span>
<span class="nc" id="L831">        ToHitData toHit = new ToHitData(0, Messages.getString(&quot;WeaponAttackAction.BaseToHit&quot;));</span>
        
        // Collect the modifiers for the environment
<span class="nc" id="L834">        toHit = compileEnvironmentalToHitMods(game, ae, target, null, null, toHit, false);</span>
        
        // Collect the modifiers for the crew/pilot
<span class="nc" id="L837">        toHit = compileCrewToHitMods(game, ae, te, toHit, null);</span>
        
        // Collect the modifiers for the attacker's condition/actions
<span class="nc bnc" id="L840" title="All 2 branches missed.">        if (ae != null) {</span>
            //Conventional fighter, Aerospace and fighter LAM attackers
<span class="nc bnc" id="L842" title="All 2 branches missed.">            if (ae.isAero()) {</span>
<span class="nc" id="L843">                toHit = compileAeroAttackerToHitMods(game, ae, target, ttype, toHit, Entity.LOC_NONE,</span>
                            IAimingModes.AIM_MODE_NONE, eistatus,
                            null, null, null, AmmoType.M_STANDARD, false, false, false, false,
                            false);
            //Everyone else
            } else {
<span class="nc" id="L849">                toHit = compileAttackerToHitMods(game, ae, target, los, toHit, toSubtract, Entity.LOC_NONE,</span>
                            IAimingModes.AIM_MODE_NONE, null,
                            null, weaponId, null, AmmoType.M_STANDARD, false, false, false,
                        false, false);
            }
        }
        
        // Collect the modifiers for the target's condition/actions 
<span class="nc" id="L857">        toHit = compileTargetToHitMods(game, ae, target, ttype, los, toHit, toSubtract, Entity.LOC_NONE,</span>
                    IAimingModes.AIM_MODE_NONE, distance,
                    null, null, null, AmmoType.M_STANDARD, false, false, isAttackerInfantry,
                    false, false, false, false);
        
        // Collect the modifiers for terrain and line-of-sight. This includes any related to-hit table changes
<span class="nc" id="L863">        toHit = compileTerrainAndLosToHitMods(game, ae, target, ttype, aElev, tElev, targEl, distance, los, toHit,</span>
                    losMods, toSubtract, eistatus, null, null, weaponId, null, AmmoType.M_STANDARD, isAttackerInfantry,
                    inSameBuilding, false, false, false);

        // okay!
<span class="nc" id="L868">        return toHit;</span>
    }
    
    
    /**
     * Method that tests each attack to see if it's impossible.
     * If so, a reason string will be returned. A null return means we can continue
     * processing the attack
     * 
     * @param game The current game
     * @param ae The Entity making this attack
     * @param attackerId  The ID number of the attacking entity
     * @param target The Targetable object being attacked
     * @param ttype  The targetable object type
     * @param los The calculated LOS between attacker and target
     * @param losMods ToHitData calculated from the spotter for indirect fire scenarios
     * @param toHit The running total ToHitData for this WeaponAttackAction
     * 
     * @param distance  The distance in hexes from attacker to target
     * @param spotter  The spotting entity for indirect fire, if present
     * 
     * @param wtype The WeaponType of the weapon being used
     * @param weapon The Mounted weapon being used
     * @param atype The AmmoType being used for this attack
     * @param ammo The Mounted ammo being used
     * @param munition  Long indicating the munition type flag being used, if applicable
     * 
     * @param isArtilleryDirect  flag that indicates whether this is a direct-fire artillery attack
     * @param isArtilleryFLAK  flag that indicates whether or not this is an artillery flak attack against an entity
     * @param isArtilleryIndirect  flag that indicates whether this is an indirect-fire artillery attack
     * @param isAttackerInfantry  flag that indicates whether the attacker is an infantry/BA unit
     * @param isBearingsOnlyMissile  flag that indicates whether this is a bearings-only capital missile attack
     * @param isCruiseMissile  flag that indicates whether this is a cruise missile artillery attack
     * @param exchangeSwarmTarget  flag that indicates whether this is the secondary target of Swarm LRMs
     * @param isHoming  flag that indicates whether this is a homing artillery attack
     * @param isIndirect  flag that indicates whether this is an indirect attack (LRM, mortar...)
     * @param isInferno  flag that indicates whether this is an inferno munition attack
     * @param isStrafing  flag that indicates whether this is an aero strafing attack
     * @param isTAG  flag that indicates whether this is a TAG attack
     * @param targetInBuilding  flag that indicates whether or not the target occupies a building hex
     * @param usesAmmo  flag that indicates whether or not the WeaponType being used is ammo-fed
     * @param underWater  flag that indicates whether or not the weapon being used is underwater
     */
    private static String toHitIsImpossible(IGame game, Entity ae, int attackerId, Targetable target, int ttype,
            LosEffects los, ToHitData losMods, ToHitData toHit, int distance, Entity spotter,
            WeaponType wtype, Mounted weapon, int weaponId, AmmoType atype, Mounted ammo, long munition,
            boolean isArtilleryDirect, boolean isArtilleryFLAK, boolean isArtilleryIndirect, boolean isAttackerInfantry,
            boolean isBearingsOnlyMissile, boolean isCruiseMissile, boolean exchangeSwarmTarget, boolean isHoming,
            boolean isInferno, boolean isIndirect, boolean isStrafing, boolean isTAG, boolean targetInBuilding,
            boolean usesAmmo, boolean underWater) {
        
        // Block the shot if the attacker is null
<span class="nc bnc" id="L920" title="All 2 branches missed.">        if (ae == null) {</span>
<span class="nc" id="L921">            return Messages.getString(&quot;WeaponAttackAction.NoAttacker&quot;);</span>
        }
        // Or if the target is null
<span class="nc bnc" id="L924" title="All 2 branches missed.">        if (target == null) {</span>
<span class="nc" id="L925">            return Messages.getString(&quot;WeaponAttackAction.NoTarget&quot;);</span>
        }
        // Without valid toHit data, the rest of this will fail
<span class="nc bnc" id="L928" title="All 2 branches missed.">        if (toHit == null) {</span>
<span class="nc" id="L929">            toHit = new ToHitData();</span>
        }
        
<span class="nc" id="L932">        Entity te = null;</span>
<span class="nc bnc" id="L933" title="All 2 branches missed.">        if (ttype == Targetable.TYPE_ENTITY) {</span>
            //Some weapons only target valid entities
<span class="nc" id="L935">            te = (Entity) target;</span>
        }
        
        // If the attacker and target are in the same building &amp; hex, they can
        // always attack each other, TW pg 175.
<span class="nc bnc" id="L940" title="All 4 branches missed.">        if ((los.getThruBldg() != null) &amp;&amp; los.getTargetPosition().equals(ae.getPosition())) {</span>
<span class="nc" id="L941">            return null;</span>
        }
        
        // got ammo?
<span class="nc bnc" id="L945" title="All 6 branches missed.">        if (usesAmmo &amp;&amp; ((ammo == null) || (ammo.getUsableShotsLeft() == 0))) {</span>
<span class="nc" id="L946">            return Messages.getString(&quot;WeaponAttackAction.OutOfAmmo&quot;);</span>
        }
        
        // Ammo-specific Reasons
<span class="nc bnc" id="L950" title="All 2 branches missed.">        if (atype != null) {</span>
            // Are we dumping that ammo?
<span class="nc bnc" id="L952" title="All 6 branches missed.">            if (usesAmmo &amp;&amp; ammo != null &amp;&amp; ammo.isDumping()) {</span>
<span class="nc" id="L953">                ae.loadWeaponWithSameAmmo(weapon);</span>
<span class="nc bnc" id="L954" title="All 4 branches missed.">                if ((ammo.getUsableShotsLeft() == 0) || ammo.isDumping()) {</span>
<span class="nc" id="L955">                    return Messages.getString(&quot;WeaponAttackAction.DumpingAmmo&quot;);</span>
                }
            }
            // make sure weapon can deliver flares
<span class="nc bnc" id="L959" title="All 4 branches missed.">            if ((target.getTargetType() == Targetable.TYPE_FLARE_DELIVER) &amp;&amp; !(usesAmmo</span>
<span class="nc bnc" id="L960" title="All 2 branches missed.">                    &amp;&amp; ((atype.getAmmoType() == AmmoType.T_LRM) </span>
<span class="nc bnc" id="L961" title="All 2 branches missed.">                            || (atype.getAmmoType() == AmmoType.T_MML)</span>
<span class="nc bnc" id="L962" title="All 2 branches missed.">                            || (atype.getAmmoType() == AmmoType.T_LRM_IMP)</span>
<span class="nc bnc" id="L963" title="All 4 branches missed.">                            || (atype.getAmmoType() == AmmoType.T_MEK_MORTAR))</span>
                    &amp;&amp; (munition == AmmoType.M_FLARE))) {
<span class="nc" id="L965">                return Messages.getString(&quot;WeaponAttackAction.NoFlares&quot;);</span>
            }
            
            // These ammo types can only target hexes for flare delivery
<span class="nc bnc" id="L969" title="All 2 branches missed.">            if (((atype.getAmmoType() == AmmoType.T_LRM)</span>
<span class="nc bnc" id="L970" title="All 2 branches missed.">                    || (atype.getAmmoType() == AmmoType.T_LRM_IMP)</span>
<span class="nc bnc" id="L971" title="All 2 branches missed.">                    || (atype.getAmmoType() == AmmoType.T_MML))</span>
<span class="nc bnc" id="L972" title="All 2 branches missed.">                    &amp;&amp; (atype.getMunitionType() == AmmoType.M_FLARE)</span>
<span class="nc bnc" id="L973" title="All 2 branches missed.">                    &amp;&amp; (target.getTargetType() != Targetable.TYPE_FLARE_DELIVER)) {</span>
<span class="nc" id="L974">                return Messages.getString(&quot;WeaponAttackAction.OnlyFlare&quot;);</span>
            }

            // Aeros must have enough ammo for the maximum rate of fire because
            // they cannot lower it
<span class="nc bnc" id="L979" title="All 8 branches missed.">            if (ae.isAero() &amp;&amp; usesAmmo &amp;&amp; ammo != null &amp;&amp; weapon != null</span>
<span class="nc bnc" id="L980" title="All 2 branches missed.">                    &amp;&amp; (ae.getTotalAmmoOfType(ammo.getType()) &lt; weapon.getCurrentShots())) {</span>
<span class="nc" id="L981">                return Messages.getString(&quot;WeaponAttackAction.InsufficientAmmo&quot;);</span>
            }
            
            // Some Mek mortar ammo types can only be aimed at a hex
<span class="nc bnc" id="L985" title="All 4 branches missed.">            if (wtype != null &amp;&amp; wtype.hasFlag(WeaponType.F_MEK_MORTAR)</span>
<span class="nc bnc" id="L986" title="All 4 branches missed.">                    &amp;&amp; ((atype.getMunitionType() == AmmoType.M_AIRBURST) || (atype.getMunitionType() == AmmoType.M_FLARE)</span>
<span class="nc bnc" id="L987" title="All 2 branches missed.">                            || (atype.getMunitionType() == AmmoType.M_SMOKE_WARHEAD))) {</span>
<span class="nc bnc" id="L988" title="All 2 branches missed.">                if (!(target instanceof HexTarget)) {</span>
<span class="nc" id="L989">                    return String.format(Messages.getString(&quot;WeaponAttackAction.AmmoAtHexOnly&quot;), atype.getSubMunitionName());</span>
                }
            }
            
            // make sure weapon can deliver minefield
<span class="nc bnc" id="L994" title="All 2 branches missed.">            if ((target.getTargetType() == Targetable.TYPE_MINEFIELD_DELIVER) </span>
<span class="nc bnc" id="L995" title="All 2 branches missed.">                    &amp;&amp; !AmmoType.canDeliverMinefield(atype)) {</span>
<span class="nc" id="L996">                return Messages.getString(&quot;WeaponAttackAction.NoMinefields&quot;);</span>
            }
            
            // These ammo types can only target hexes for minefield delivery
<span class="nc bnc" id="L1000" title="All 2 branches missed.">            if (((atype.getAmmoType() == AmmoType.T_LRM) </span>
<span class="nc bnc" id="L1001" title="All 2 branches missed.">                    || (atype.getAmmoType() == AmmoType.T_LRM_IMP)</span>
<span class="nc bnc" id="L1002" title="All 2 branches missed.">                    || (atype.getAmmoType() == AmmoType.T_MML)</span>
<span class="nc bnc" id="L1003" title="All 2 branches missed.">                    || (atype.getAmmoType() == AmmoType.T_MEK_MORTAR))</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">                    &amp;&amp; ((atype.getMunitionType() == AmmoType.M_THUNDER)</span>
<span class="nc bnc" id="L1005" title="All 2 branches missed.">                            || (atype.getMunitionType() == AmmoType.M_THUNDER_ACTIVE)</span>
<span class="nc bnc" id="L1006" title="All 2 branches missed.">                            || (atype.getMunitionType() == AmmoType.M_THUNDER_INFERNO)</span>
<span class="nc bnc" id="L1007" title="All 2 branches missed.">                            || (atype.getMunitionType() == AmmoType.M_THUNDER_VIBRABOMB)</span>
<span class="nc bnc" id="L1008" title="All 2 branches missed.">                            || (atype.getMunitionType() == AmmoType.M_THUNDER_AUGMENTED))</span>
<span class="nc bnc" id="L1009" title="All 2 branches missed.">                    &amp;&amp; (target.getTargetType() != Targetable.TYPE_MINEFIELD_DELIVER)) {</span>
<span class="nc" id="L1010">                return Messages.getString(&quot;WeaponAttackAction.OnlyMinefields&quot;);</span>
            }
        }
        
        // Attacker Action Reasons

        // If the attacker is actively using a shield, weapons in the same location are blocked
<span class="nc bnc" id="L1017" title="All 6 branches missed.">        if (weapon != null &amp;&amp; ae.hasShield() &amp;&amp; ae.hasActiveShield(weapon.getLocation(), weapon.isRearMounted())) {</span>
<span class="nc" id="L1018">            return Messages.getString(&quot;WeaponAttackAction.ActiveShieldBlocking&quot;);</span>
        }

        //is the attacker even active?
<span class="nc bnc" id="L1022" title="All 4 branches missed.">        if (ae.isShutDown() || !ae.getCrew().isActive()) {</span>
<span class="nc" id="L1023">            return Messages.getString(&quot;WeaponAttackAction.AttackerNotReady&quot;);</span>
        }
        
        // If the attacker is involved in a grapple
<span class="nc bnc" id="L1027" title="All 2 branches missed.">        if (ae.getGrappled() != Entity.NONE) {</span>
<span class="nc" id="L1028">            int grapple = ae.getGrappled();</span>
            // It can only target the unit it is grappling with
<span class="nc bnc" id="L1030" title="All 2 branches missed.">            if (grapple != target.getTargetId()) {</span>
<span class="nc" id="L1031">                return Messages.getString(&quot;WeaponAttackAction.MustTargetGrappled&quot;);</span>
            }
<span class="nc bnc" id="L1033" title="All 2 branches missed.">            if (weapon != null) {</span>
<span class="nc" id="L1034">                int loc = weapon.getLocation();</span>
                // Can't fire arm and leg-mounted weapons while grappling
<span class="nc bnc" id="L1036" title="All 12 branches missed.">                if (((ae instanceof Mech) &amp;&amp; (ae.getGrappleSide() == Entity.GRAPPLE_BOTH)</span>
                        &amp;&amp; ((loc != Mech.LOC_CT) &amp;&amp; (loc != Mech.LOC_LT) &amp;&amp; (loc != Mech.LOC_RT) &amp;&amp; (loc != Mech.LOC_HEAD)))
<span class="nc bnc" id="L1038" title="All 2 branches missed.">                        || weapon.isRearMounted()) {</span>
<span class="nc" id="L1039">                    return Messages.getString(&quot;WeaponAttackAction.CantFireWhileGrappled&quot;);</span>
                }
                // If caught by a chain whip, can't use weapons in the affected arm
<span class="nc bnc" id="L1042" title="All 6 branches missed.">                if ((ae instanceof Mech) &amp;&amp; (ae.getGrappleSide() == Entity.GRAPPLE_LEFT) &amp;&amp; (loc == Mech.LOC_LARM)) {</span>
<span class="nc" id="L1043">                    return Messages.getString(&quot;WeaponAttackAction.CantShootWhileChained&quot;);</span>
                }
<span class="nc bnc" id="L1045" title="All 6 branches missed.">                if ((ae instanceof Mech) &amp;&amp; (ae.getGrappleSide() == Entity.GRAPPLE_RIGHT) &amp;&amp; (loc == Mech.LOC_RARM)) {</span>
<span class="nc" id="L1046">                    return Messages.getString(&quot;WeaponAttackAction.CantShootWhileChained&quot;);</span>
                }
            }
        }
        
        // Only large spacecraft can shoot while evading
<span class="nc bnc" id="L1052" title="All 6 branches missed.">        if (ae.isEvading() &amp;&amp; !(ae instanceof Dropship) &amp;&amp; !(ae instanceof Jumpship)) {</span>
<span class="nc" id="L1053">            return Messages.getString(&quot;WeaponAttackAction.AeEvading&quot;);</span>
        }

        //If we're lying mines, we can't shoot.
<span class="nc bnc" id="L1057" title="All 2 branches missed.">        if (ae.isLayingMines()) {</span>
<span class="nc" id="L1058">            return Messages.getString(&quot;WeaponAttackAction.BusyLayingMines&quot;);</span>
        }
        
        // Attacker prone and unable to fire?
<span class="nc" id="L1062">        ToHitData ProneMods = Compute.getProneMods(game, ae, weaponId);</span>
<span class="nc bnc" id="L1063" title="All 4 branches missed.">        if ((ProneMods != null) &amp;&amp; ProneMods.getValue() == ToHitData.IMPOSSIBLE) {</span>
<span class="nc" id="L1064">            return ProneMods.getDesc();</span>
        }
        
        // WiGE vehicles cannot fire at 0-range targets as they fly overhead
<span class="nc bnc" id="L1068" title="All 4 branches missed.">        if ((ae.getMovementMode() == EntityMovementMode.WIGE) &amp;&amp; (ae.getPosition() == target.getPosition())) {</span>
<span class="nc" id="L1069">            return Messages.getString(&quot;WeaponAttackAction.ZeroRangeTarget&quot;);</span>
        }

        // Crew Related Reasons

        // Stunned vehicle crews can't make attacks
<span class="nc bnc" id="L1075" title="All 4 branches missed.">        if (ae instanceof Tank &amp;&amp; ((Tank) ae).getStunnedTurns() &gt; 0) {</span>
<span class="nc" id="L1076">            return Messages.getString(&quot;WeaponAttackAction.CrewStunned&quot;);</span>
        }
        // Vehicles with a single crewman can't shoot and unjam a RAC in the same turn (like mechs...) 
<span class="nc bnc" id="L1079" title="All 4 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_TANK_CREWS) </span>
<span class="nc bnc" id="L1080" title="All 2 branches missed.">                &amp;&amp; (ae instanceof Tank) &amp;&amp; ae.isUnjammingRAC()</span>
<span class="nc bnc" id="L1081" title="All 2 branches missed.">                &amp;&amp; (ae.getCrew().getSize() == 1)) {</span>
<span class="nc" id="L1082">            return Messages.getString(&quot;WeaponAttackAction.VeeSingleCrew&quot;);</span>
        }
        
        // Critical Damage Reasons


        // Aerospace units can't fire if the FCS/CIC is destroyed
<span class="nc bnc" id="L1089" title="All 2 branches missed.">        if (ae instanceof Aero) {</span>
<span class="nc" id="L1090">            Aero aero = (Aero) ae;</span>
            // FCS hits
<span class="nc" id="L1092">            int fcs = aero.getFCSHits();</span>
<span class="nc bnc" id="L1093" title="All 2 branches missed.">            if (fcs &gt; 2) {</span>
<span class="nc" id="L1094">                return Messages.getString(&quot;WeaponAttackAction.FCSDestroyed&quot;);</span>
            }
            // JS/WS/SS have CIC instead of FCS
<span class="nc bnc" id="L1097" title="All 2 branches missed.">            if (aero instanceof Jumpship) {</span>
<span class="nc" id="L1098">                Jumpship js = (Jumpship) aero;</span>
<span class="nc" id="L1099">                int cic = js.getCICHits();</span>
<span class="nc bnc" id="L1100" title="All 2 branches missed.">                if (cic &gt; 2) {</span>
<span class="nc" id="L1101">                    return Messages.getString(&quot;WeaponAttackAction.CICDestroyed&quot;);</span>
                }
            }
        }
        // Are the sensors operational?
        // Battlemech sensors are destroyed after 2 hits, unless they have a torso-mounted cockpit
<span class="nc" id="L1107">        int sensorHits = ae.getBadCriticals(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_SENSORS, Mech.LOC_HEAD);</span>
<span class="nc bnc" id="L1108" title="All 4 branches missed.">        if ((ae instanceof Mech) &amp;&amp; (((Mech) ae).getCockpitType() == Mech.COCKPIT_TORSO_MOUNTED)) {</span>
<span class="nc" id="L1109">            sensorHits += ae.getBadCriticals(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_SENSORS, Mech.LOC_CT);</span>
<span class="nc bnc" id="L1110" title="All 2 branches missed.">            if (sensorHits &gt; 2) {</span>
<span class="nc" id="L1111">                return Messages.getString(&quot;WeaponAttackAction.SensorsDestroyed&quot;);</span>
            }
        // Vehicles Sensor Hits
<span class="nc bnc" id="L1114" title="All 2 branches missed.">        } else if (ae instanceof Tank) {</span>
<span class="nc" id="L1115">            sensorHits = ((Tank) ae).getSensorHits();</span>
<span class="nc bnc" id="L1116" title="All 2 branches missed.">            if (sensorHits &gt; 3) {</span>
<span class="nc" id="L1117">                return Messages.getString(&quot;WeaponAttackAction.SensorsDestroyed&quot;);</span>
            }
        // Industrialmechs and other unit types have destroyed sensors with 2 or more hits
<span class="nc bnc" id="L1120" title="All 4 branches missed.">        } else if ((sensorHits &gt; 1)</span>
<span class="nc bnc" id="L1121" title="All 4 branches missed.">                || ((ae instanceof Mech) &amp;&amp; (((Mech) ae).isIndustrial() &amp;&amp; (sensorHits == 1)))) {</span>
<span class="nc" id="L1122">            return Messages.getString(&quot;WeaponAttackAction.SensorsDestroyed&quot;);</span>
        }

        // Invalid Target Reasons
        
        //a friendly unit can never be the target of a direct attack.
        // but we do allow vehicle flamers to cool. Also swarm missile secondary targets and strafing are exempt.
<span class="nc bnc" id="L1129" title="All 6 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.BASE_FRIENDLY_FIRE) &amp;&amp; !isStrafing &amp;&amp; !exchangeSwarmTarget) {</span>
<span class="nc bnc" id="L1130" title="All 4 branches missed.">            if (te != null &amp;&amp; !te.getOwner().isEnemyOf(ae.getOwner())) {</span>
<span class="nc bnc" id="L1131" title="All 6 branches missed.">                if (!(usesAmmo &amp;&amp; atype != null &amp;&amp; (atype.getMunitionType() == AmmoType.M_COOLANT))) {</span>
<span class="nc" id="L1132">                    return Messages.getString(&quot;WeaponAttackAction.NoFriendlyTarget&quot;);</span>
                }
            }
        }

        // Can't fire at hidden targets
<span class="nc bnc" id="L1138" title="All 4 branches missed.">        if ((target instanceof Entity) &amp;&amp; ((Entity)target).isHidden()) {</span>
<span class="nc" id="L1139">            return Messages.getString(&quot;WeaponAttackAction.NoFireAtHidden&quot;);</span>
        }
        
        // Infantry can't clear woods.
<span class="nc bnc" id="L1143" title="All 4 branches missed.">        if (isAttackerInfantry &amp;&amp; (Targetable.TYPE_HEX_CLEAR == target.getTargetType())) {</span>
<span class="nc" id="L1144">            IHex hexTarget = game.getBoard().getHex(target.getPosition());</span>
<span class="nc bnc" id="L1145" title="All 2 branches missed.">            if (hexTarget.containsTerrain(Terrains.WOODS)) {</span>
<span class="nc" id="L1146">                return Messages.getString(&quot;WeaponAttackAction.NoInfantryWoodsClearing&quot;);</span>
            }
        }
        
        // Can't target infantry with Inferno rounds (BMRr, pg. 141).
        // Also, enforce options for keeping vehicles and protos safe
        // if those options are checked.
<span class="nc bnc" id="L1153" title="All 4 branches missed.">        if (isInferno &amp;&amp; (((te instanceof Tank)</span>
<span class="nc bnc" id="L1154" title="All 4 branches missed.">                &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_VEHICLES_SAFE_FROM_INFERNOS))</span>
                || ((te instanceof Protomech)
<span class="nc bnc" id="L1156" title="All 2 branches missed.">                        &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_PROTOS_SAFE_FROM_INFERNOS)))) {</span>
<span class="nc" id="L1157">            return Messages.getString(&quot;WeaponAttackAction.CantShootWithInferno&quot;);</span>
        }
        
        // Only weapons allowed to clear minefields can target a hex for minefield clearance
<span class="nc bnc" id="L1161" title="All 4 branches missed.">        if ((target.getTargetType() == Targetable.TYPE_MINEFIELD_CLEAR) &amp;&amp; </span>
<span class="nc bnc" id="L1162" title="All 2 branches missed.">                ((atype == null) || !AmmoType.canClearMinefield(atype))) {</span>
<span class="nc" id="L1163">            return Messages.getString(&quot;WeaponAttackAction.CantClearMines&quot;);</span>
        }
        
        // Mine Clearance munitions can only target hexes for minefield clearance
<span class="nc bnc" id="L1167" title="All 4 branches missed.">        if (!(target instanceof HexTarget) &amp;&amp; (atype != null)</span>
<span class="nc bnc" id="L1168" title="All 2 branches missed.">                &amp;&amp; (atype.getMunitionType() == AmmoType.M_MINE_CLEARANCE)) {</span>
<span class="nc" id="L1169">            return Messages.getString(&quot;WeaponAttackAction.MineClearHexOnly&quot;);</span>
        }
        
        // Only screen launchers may target a hex for screen launch
<span class="nc bnc" id="L1173" title="All 2 branches missed.">        if (Targetable.TYPE_HEX_SCREEN == target.getTargetType()) {</span>
<span class="nc bnc" id="L1174" title="All 2 branches missed.">            if (wtype != null &amp;&amp; </span>
<span class="nc bnc" id="L1175" title="All 4 branches missed.">                    (!((wtype.getAmmoType() == AmmoType.T_SCREEN_LAUNCHER) || (wtype instanceof ScreenLauncherBayWeapon)))) {</span>
<span class="nc" id="L1176">                return Messages.getString(&quot;WeaponAttackAction.ScreenLauncherOnly&quot;);</span>
            }
        }

        // Screen Launchers can only target hexes
<span class="nc bnc" id="L1181" title="All 4 branches missed.">        if ((Targetable.TYPE_HEX_SCREEN != target.getTargetType())</span>
<span class="nc bnc" id="L1182" title="All 4 branches missed.">                &amp;&amp; (wtype != null &amp;&amp; ((wtype.getAmmoType() == AmmoType.T_SCREEN_LAUNCHER)</span>
                        || (wtype instanceof ScreenLauncherBayWeapon)))) {
<span class="nc" id="L1184">            return Messages.getString(&quot;WeaponAttackAction.ScreenHexOnly&quot;);</span>
        }
        
        // Can't target an entity conducting a swarm attack.
<span class="nc bnc" id="L1188" title="All 4 branches missed.">        if ((te != null) &amp;&amp; (Entity.NONE != te.getSwarmTargetId())) {</span>
<span class="nc" id="L1189">            return Messages.getString(&quot;WeaponAttackAction.TargetSwarming&quot;);</span>
        }
        
        //Tasers must target units and can't target flying units
<span class="nc bnc" id="L1193" title="All 4 branches missed.">        if (wtype != null &amp;&amp; wtype.hasFlag(WeaponType.F_TASER)) {</span>
<span class="nc bnc" id="L1194" title="All 2 branches missed.">            if (te != null) {</span>
<span class="nc bnc" id="L1195" title="All 4 branches missed.">                if (te.isAirborne() || te.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L1196">                    return Messages.getString(&quot;WeaponAttackAction.NoTaserAtAirborne&quot;);</span>
                }
            } else {
<span class="nc" id="L1199">                return Messages.getString(&quot;WeaponAttackAction.TaserOnlyAtUnit&quot;);</span>
            }
        }
        
        // can't target yourself intentionally, but swarm missiles can come back to bite you
<span class="nc bnc" id="L1204" title="All 6 branches missed.">        if (!exchangeSwarmTarget &amp;&amp; te != null &amp;&amp; ae.equals(te)) {</span>
<span class="nc" id="L1205">            return Messages.getString(&quot;WeaponAttackAction.NoSelfTarget&quot;);</span>
        }
        
        // Line of Sight and Range Reasons


        //attacker partial cover means no leg weapons
<span class="nc bnc" id="L1212" title="All 8 branches missed.">        if (los.isAttackerCover() &amp;&amp; weapon != null &amp;&amp; ae.locationIsLeg(weapon.getLocation()) &amp;&amp; !underWater) {</span>
<span class="nc" id="L1213">            return Messages.getString(&quot;WeaponAttackAction.LegBlockedByTerrain&quot;);</span>
        }

        // Must target infantry in buildings from the inside.
<span class="nc bnc" id="L1217" title="All 4 branches missed.">        if (targetInBuilding &amp;&amp; (te instanceof Infantry)</span>
<span class="nc bnc" id="L1218" title="All 2 branches missed.">                &amp;&amp; (null == los.getThruBldg())) {</span>
<span class="nc" id="L1219">            return Messages.getString(&quot;WeaponAttackAction.CantShootThruBuilding&quot;);</span>
        }

        //if LOS is blocked, block the shot except in the case of indirect artillery fire
<span class="nc bnc" id="L1223" title="All 4 branches missed.">        if ((losMods.getValue() == TargetRoll.IMPOSSIBLE) &amp;&amp; !isArtilleryIndirect) {</span>
<span class="nc" id="L1224">                return losMods.getDesc();</span>
        }

        //If using SO advanced sensors, the firing unit or one on its NC3 network must have a valid firing solution
<span class="nc bnc" id="L1228" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ADVANCED_SENSORS)</span>
<span class="nc bnc" id="L1229" title="All 2 branches missed.">                &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVANCED_DOUBLE_BLIND)</span>
<span class="nc bnc" id="L1230" title="All 2 branches missed.">                &amp;&amp; ae.isSpaceborne()) {</span>
<span class="nc" id="L1231">            boolean networkFiringSolution = false;</span>
            //Check to see if the attacker has a firing solution. Naval C3 networks share targeting data
<span class="nc bnc" id="L1233" title="All 2 branches missed.">            if (ae.hasNavalC3()) {</span>
<span class="nc bnc" id="L1234" title="All 2 branches missed.">                for (Entity en : game.getC3NetworkMembers(ae)) {</span>
<span class="nc bnc" id="L1235" title="All 4 branches missed.">                    if (te != null &amp;&amp; en.hasFiringSolutionFor(te.getId())) {</span>
<span class="nc" id="L1236">                        networkFiringSolution = true;</span>
<span class="nc" id="L1237">                        break;</span>
                    }
<span class="nc" id="L1239">                }</span>
            }
<span class="nc bnc" id="L1241" title="All 2 branches missed.">            if (!networkFiringSolution) {</span>
                //If we don't check for target type here, we can't fire screens and missiles at hexes...
<span class="nc bnc" id="L1243" title="All 6 branches missed.">                if (target.getTargetType() == Targetable.TYPE_ENTITY &amp;&amp; (te != null &amp;&amp; !ae.hasFiringSolutionFor(te.getId())))  {</span>
<span class="nc" id="L1244">                    return Messages.getString(&quot;WeaponAttackAction.NoFiringSolution&quot;);</span>
                }
            }
        }
        
        // http://www.classicbattletech.com/forums/index.php/topic,47618.0.html
        // anything outside of visual range requires a &quot;sensor lock&quot; in order to
        // direct fire. Note that this is for ground combat with tacops sensors rules
<span class="nc bnc" id="L1252" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_DOUBLE_BLIND)</span>
<span class="nc bnc" id="L1253" title="All 2 branches missed.">                &amp;&amp; !ae.isSpaceborne()</span>
<span class="nc bnc" id="L1254" title="All 2 branches missed.">                &amp;&amp; !Compute.inVisualRange(game, ae, target)</span>
<span class="nc bnc" id="L1255" title="All 4 branches missed.">                &amp;&amp; !(Compute.inSensorRange(game, ae, target, null) </span>
                        // Can shoot at something in sensor range if it has
                        // been spotted by another unit
<span class="nc bnc" id="L1258" title="All 8 branches missed.">                        &amp;&amp; (te != null) &amp;&amp; te.hasSeenEntity(ae.getOwner())) </span>
                &amp;&amp; !isArtilleryIndirect &amp;&amp; !isIndirect &amp;&amp; !isBearingsOnlyMissile) {
<span class="nc" id="L1260">            boolean networkSee = false;</span>
<span class="nc bnc" id="L1261" title="All 6 branches missed.">            if (ae.hasC3() || ae.hasC3i() || ae.hasActiveNovaCEWS()) {</span>
                // c3 units can fire if any other unit in their network is in
                // visual or sensor range
<span class="nc bnc" id="L1264" title="All 2 branches missed.">                for (Entity en : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L1265" title="All 6 branches missed.">                    if (!en.isEnemyOf(ae) &amp;&amp; en.onSameC3NetworkAs(ae) &amp;&amp; Compute.canSee(game, en, target)) {</span>
<span class="nc" id="L1266">                        networkSee = true;</span>
<span class="nc" id="L1267">                        break;</span>
                    }
<span class="nc" id="L1269">                }</span>
            }
<span class="nc bnc" id="L1271" title="All 2 branches missed.">            if (!networkSee) {</span>
<span class="nc bnc" id="L1272" title="All 2 branches missed.">                if (!Compute.inSensorRange(game, ae, target, null)) {</span>
<span class="nc" id="L1273">                    return Messages.getString(&quot;WeaponAttackAction.NoSensorTarget&quot;);</span>
                } else {
<span class="nc" id="L1275">                    return Messages.getString(&quot;WeaponAttackAction.TargetNotSpotted&quot;);</span>
                }
            }
        }

        //Torpedos must remain in the water over their whole path to the target
<span class="nc bnc" id="L1281" title="All 2 branches missed.">        if ((atype != null)</span>
<span class="nc bnc" id="L1282" title="All 2 branches missed.">                &amp;&amp; ((atype.getAmmoType() == AmmoType.T_LRM_TORPEDO)</span>
<span class="nc bnc" id="L1283" title="All 2 branches missed.">                        || (atype.getAmmoType() == AmmoType.T_SRM_TORPEDO)</span>
<span class="nc bnc" id="L1284" title="All 2 branches missed.">                        || (((atype.getAmmoType() == AmmoType.T_SRM)</span>
<span class="nc bnc" id="L1285" title="All 2 branches missed.">                                || (atype.getAmmoType() == AmmoType.T_SRM_IMP)</span>
<span class="nc bnc" id="L1286" title="All 2 branches missed.">                                || (atype.getAmmoType() == AmmoType.T_MRM)</span>
<span class="nc bnc" id="L1287" title="All 2 branches missed.">                                || (atype.getAmmoType() == AmmoType.T_LRM)</span>
<span class="nc bnc" id="L1288" title="All 2 branches missed.">                                || (atype.getAmmoType() == AmmoType.T_LRM_IMP)</span>
<span class="nc bnc" id="L1289" title="All 4 branches missed.">                                || (atype.getAmmoType() == AmmoType.T_MML)) &amp;&amp; (atype.getMunitionType() == AmmoType.M_TORPEDO)))</span>
<span class="nc bnc" id="L1290" title="All 2 branches missed.">                &amp;&amp; (los.getMinimumWaterDepth() &lt; 1)) {</span>
<span class="nc" id="L1291">            return Messages.getString(&quot;WeaponAttackAction.TorpOutOfWater&quot;);</span>
        }

        //Is the weapon blocked by a passenger?
<span class="nc bnc" id="L1295" title="All 4 branches missed.">        if (weapon != null &amp;&amp; (ae.isWeaponBlockedAt(weapon.getLocation(), weapon.isRearMounted()))) {</span>
<span class="nc" id="L1296">            return Messages.getString(&quot;WeaponAttackAction.PassengerBlock&quot;);</span>
        }

        //Is the weapon blocked by a tractor/trailer?
<span class="nc bnc" id="L1300" title="All 6 branches missed.">        if (weapon != null &amp;&amp; (ae.getTowing() != Entity.NONE || ae.getTowedBy() != Entity.NONE)) {</span>
<span class="nc bnc" id="L1301" title="All 2 branches missed.">            if (ae.isWeaponBlockedByTowing(weapon.getLocation(), ae.getSecondaryFacing(), weapon.isRearMounted())) {</span>
<span class="nc" id="L1302">                return Messages.getString(&quot;WeaponAttackAction.TrailerBlock&quot;);</span>
            }
        }

        // Phase Reasons

        // Only bearings-only capital missiles and indirect fire artillery can be fired in the targeting phase
<span class="nc bnc" id="L1309" title="All 6 branches missed.">        if ((game.getPhase() == IGame.Phase.PHASE_TARGETING) &amp;&amp; (!(isArtilleryIndirect || isBearingsOnlyMissile))) {</span>
<span class="nc" id="L1310">            return Messages.getString(&quot;WeaponAttackAction.NotValidForTargPhase&quot;);</span>
        }
        // Only TAG can be fired in the offboard phase
<span class="nc bnc" id="L1313" title="All 4 branches missed.">        if ((game.getPhase() == IGame.Phase.PHASE_OFFBOARD) &amp;&amp; !isTAG) {</span>
<span class="nc" id="L1314">            return Messages.getString(&quot;WeaponAttackAction.OnlyTagInOffboard&quot;);</span>
        }
        // TAG can't be fired in any phase but offboard
<span class="nc bnc" id="L1317" title="All 4 branches missed.">        if ((game.getPhase() != IGame.Phase.PHASE_OFFBOARD) &amp;&amp; isTAG) {</span>
<span class="nc" id="L1318">            return Messages.getString(&quot;WeaponAttackAction.TagOnlyInOffboard&quot;);</span>
        }
        
        // Unit-specific Reasons
        
        // Airborne units cannot tag and attack
        // http://bg.battletech.com/forums/index.php?topic=17613.new;topicseen#new
<span class="nc bnc" id="L1325" title="All 4 branches missed.">        if (ae.isAirborne() &amp;&amp; ae.usedTag()) {</span>
<span class="nc" id="L1326">            return Messages.getString(&quot;WeaponAttackAction.AeroCantTAGAndShoot&quot;);</span>
        }

        // Hull Down

        // Hull down mechs cannot fire any leg weapons
<span class="nc bnc" id="L1332" title="All 4 branches missed.">        if (ae.isHullDown() &amp;&amp; weapon != null) {</span>
<span class="nc bnc" id="L1333" title="All 2 branches missed.">            if (((ae instanceof BipedMech)</span>
<span class="nc bnc" id="L1334" title="All 6 branches missed.">                    &amp;&amp; ((weapon.getLocation() == Mech.LOC_LLEG) || (weapon.getLocation() == Mech.LOC_RLEG)))</span>
<span class="nc bnc" id="L1335" title="All 2 branches missed.">                    || ((ae instanceof QuadMech) &amp;&amp; ((weapon.getLocation() == Mech.LOC_LLEG)</span>
<span class="nc bnc" id="L1336" title="All 4 branches missed.">                            || (weapon.getLocation() == Mech.LOC_RLEG) || (weapon.getLocation() == Mech.LOC_LARM)</span>
<span class="nc bnc" id="L1337" title="All 2 branches missed.">                            || (weapon.getLocation() == Mech.LOC_RARM)))) {</span>
<span class="nc" id="L1338">                return Messages.getString(&quot;WeaponAttackAction.NoLegHullDown&quot;);</span>
            }
        }

        // hull down vees can't fire front weapons
<span class="nc bnc" id="L1343" title="All 8 branches missed.">        if ((ae instanceof Tank) &amp;&amp; ae.isHullDown() &amp;&amp; weapon != null &amp;&amp; (weapon.getLocation() == Tank.LOC_FRONT)) {</span>
<span class="nc" id="L1344">            return Messages.getString(&quot;WeaponAttackAction.FrontBlockedByTerrain&quot;);</span>
        }

        // LAMs in fighter mode are restricted to only the ammo types that Aeros can use
<span class="nc bnc" id="L1348" title="All 8 branches missed.">        if ((ae instanceof LandAirMech) &amp;&amp; (ae.getConversionMode() == LandAirMech.CONV_MODE_FIGHTER)</span>
                &amp;&amp; usesAmmo &amp;&amp; ammo != null 
<span class="nc bnc" id="L1350" title="All 2 branches missed.">                &amp;&amp; !((AmmoType)ammo.getType()).canAeroUse(game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_ARTILLERY_MUNITIONS))) {</span>
<span class="nc" id="L1351">            return Messages.getString(&quot;WeaponAttackAction.InvalidAmmoForFighter&quot;);</span>
        }
        
        // LAMs carrying certain types of bombs that require a weapon have attacks that cannot
        // be used in mech mode.
<span class="nc bnc" id="L1356" title="All 4 branches missed.">        if ((ae instanceof LandAirMech)</span>
                &amp;&amp; wtype != null
<span class="nc bnc" id="L1358" title="All 2 branches missed.">                &amp;&amp; (ae.getConversionMode() == LandAirMech.CONV_MODE_MECH)</span>
<span class="nc bnc" id="L1359" title="All 2 branches missed.">                &amp;&amp; wtype.hasFlag(WeaponType.F_BOMB_WEAPON)</span>
<span class="nc bnc" id="L1360" title="All 2 branches missed.">                &amp;&amp; wtype.getAmmoType() != AmmoType.T_RL_BOMB</span>
<span class="nc bnc" id="L1361" title="All 2 branches missed.">                &amp;&amp; !wtype.hasFlag(WeaponType.F_TAG)) {</span>
<span class="nc" id="L1362">            return Messages.getString(&quot;WeaponAttackAction.NoBombInMechMode&quot;);</span>
        }
        
        // limit large craft to zero net heat and to heat by arc
<span class="nc" id="L1366">        final int heatcap = ae.getHeatCapacity();</span>
<span class="nc bnc" id="L1367" title="All 6 branches missed.">        if (ae.usesWeaponBays() &amp;&amp; weapon != null &amp;&amp; (weapon.getBayWeapons().size() &gt; 0)) {</span>
<span class="nc" id="L1368">            int totalheat = 0;</span>

            // first check to see if there are any usable weapons
<span class="nc" id="L1371">            boolean useable = false;</span>
<span class="nc bnc" id="L1372" title="All 2 branches missed.">            for (int wId : weapon.getBayWeapons()) {</span>
<span class="nc" id="L1373">                Mounted m = ae.getEquipment(wId);</span>
<span class="nc" id="L1374">                WeaponType bayWType = ((WeaponType) m.getType());</span>
<span class="nc bnc" id="L1375" title="All 2 branches missed.">                boolean bayWUsesAmmo = (bayWType.getAmmoType() != AmmoType.T_NA);</span>
<span class="nc bnc" id="L1376" title="All 2 branches missed.">                if (m.canFire()) {</span>
<span class="nc bnc" id="L1377" title="All 2 branches missed.">                    if (bayWUsesAmmo) {</span>
<span class="nc bnc" id="L1378" title="All 4 branches missed.">                        if ((m.getLinked() != null) &amp;&amp; (m.getLinked().getUsableShotsLeft() &gt; 0)) {</span>
<span class="nc" id="L1379">                            useable = true;</span>
<span class="nc" id="L1380">                            break;</span>
                        }
                    } else {
<span class="nc" id="L1383">                        useable = true;</span>
<span class="nc" id="L1384">                        break;</span>
                    }
                }
<span class="nc" id="L1387">            }</span>
<span class="nc bnc" id="L1388" title="All 2 branches missed.">            if (!useable) {</span>
<span class="nc" id="L1389">                return Messages.getString(&quot;WeaponAttackAction.BayNotReady&quot;);</span>
            }

            // create an array of booleans of locations
<span class="nc" id="L1393">            boolean[] usedFrontArc = new boolean[ae.locations()];</span>
<span class="nc" id="L1394">            boolean[] usedRearArc = new boolean[ae.locations()];</span>
<span class="nc bnc" id="L1395" title="All 2 branches missed.">            for (int i = 0; i &lt; ae.locations(); i++) {</span>
<span class="nc" id="L1396">                usedFrontArc[i] = false;</span>
<span class="nc" id="L1397">                usedRearArc[i] = false;</span>
            }

<span class="nc bnc" id="L1400" title="All 2 branches missed.">            for (Enumeration&lt;EntityAction&gt; i = game.getActions(); i.hasMoreElements();) {</span>
<span class="nc" id="L1401">                Object o = i.nextElement();</span>
<span class="nc bnc" id="L1402" title="All 2 branches missed.">                if (!(o instanceof WeaponAttackAction)) {</span>
<span class="nc" id="L1403">                    continue;</span>
                }
<span class="nc" id="L1405">                WeaponAttackAction prevAttack = (WeaponAttackAction) o;</span>
                // Strafing attacks only count heat for first shot
<span class="nc bnc" id="L1407" title="All 4 branches missed.">                if (prevAttack.isStrafing() &amp;&amp; !prevAttack.isStrafingFirstShot()) {</span>
<span class="nc" id="L1408">                    continue;</span>
                }
<span class="nc bnc" id="L1410" title="All 4 branches missed.">                if ((prevAttack.getEntityId() == attackerId) &amp;&amp; (weaponId != prevAttack.getWeaponId())) {</span>
<span class="nc" id="L1411">                    Mounted prevWeapon = ae.getEquipment(prevAttack.getWeaponId());</span>
<span class="nc bnc" id="L1412" title="All 2 branches missed.">                    if (prevWeapon != null) {</span>
<span class="nc" id="L1413">                        int loc = prevWeapon.getLocation();</span>
<span class="nc" id="L1414">                        boolean rearMount = prevWeapon.isRearMounted();</span>
<span class="nc bnc" id="L1415" title="All 2 branches missed.">                        if (game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_HEAT_BY_BAY)) {</span>
<span class="nc bnc" id="L1416" title="All 2 branches missed.">                            for (int bwId : prevWeapon.getBayWeapons()) {</span>
<span class="nc" id="L1417">                                totalheat += ae.getEquipment(bwId).getCurrentHeat();</span>
<span class="nc" id="L1418">                            }</span>
                        } else {
<span class="nc bnc" id="L1420" title="All 2 branches missed.">                            if (!rearMount) {</span>
<span class="nc bnc" id="L1421" title="All 2 branches missed.">                                if (!usedFrontArc[loc]) {</span>
<span class="nc" id="L1422">                                    totalheat += ae.getHeatInArc(loc, rearMount);</span>
<span class="nc" id="L1423">                                    usedFrontArc[loc] = true;</span>
                                }
                            } else {
<span class="nc bnc" id="L1426" title="All 2 branches missed.">                                if (!usedRearArc[loc]) {</span>
<span class="nc" id="L1427">                                    totalheat += ae.getHeatInArc(loc, rearMount);</span>
<span class="nc" id="L1428">                                    usedRearArc[loc] = true;</span>
                                }
                            }
                        }
                    }
                }
<span class="nc" id="L1434">            }</span>

            // now check the current heat
<span class="nc" id="L1437">            int loc = weapon.getLocation();</span>
<span class="nc" id="L1438">            boolean rearMount = weapon.isRearMounted();</span>
<span class="nc" id="L1439">            int currentHeat = ae.getHeatInArc(loc, rearMount);</span>
<span class="nc bnc" id="L1440" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_HEAT_BY_BAY)) {</span>
<span class="nc" id="L1441">                currentHeat = 0;</span>
<span class="nc bnc" id="L1442" title="All 2 branches missed.">                for (int bwId : weapon.getBayWeapons()) {</span>
<span class="nc" id="L1443">                    currentHeat += ae.getEquipment(bwId).getCurrentHeat();</span>
<span class="nc" id="L1444">                }</span>
            }
            // check to see if this is currently the only arc being fired
<span class="nc" id="L1447">            boolean onlyArc = true;</span>
<span class="nc bnc" id="L1448" title="All 2 branches missed.">            for (int nLoc = 0; nLoc &lt; ae.locations(); nLoc++) {</span>
<span class="nc bnc" id="L1449" title="All 2 branches missed.">                if (nLoc == loc) {</span>
<span class="nc" id="L1450">                    continue;</span>
                }
<span class="nc bnc" id="L1452" title="All 4 branches missed.">                if (usedFrontArc[nLoc] || usedRearArc[nLoc]) {</span>
<span class="nc" id="L1453">                    onlyArc = false;</span>
<span class="nc" id="L1454">                    break;</span>
                }
            }

<span class="nc bnc" id="L1458" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_HEAT_BY_BAY)) {</span>
<span class="nc bnc" id="L1459" title="All 2 branches missed.">                if ((totalheat + currentHeat) &gt; heatcap) {</span>
                    // FIXME: This is causing weird problems (try firing all the
                    // Suffen's nose weapons)
<span class="nc" id="L1462">                    return Messages.getString(&quot;WeaponAttackAction.HeatOverCap&quot;);</span>
                }
            } else {
<span class="nc bnc" id="L1465" title="All 2 branches missed.">                if (!rearMount) {</span>
<span class="nc bnc" id="L1466" title="All 6 branches missed.">                    if (!usedFrontArc[loc] &amp;&amp; ((totalheat + currentHeat) &gt; heatcap) &amp;&amp; !onlyArc) {</span>
<span class="nc" id="L1467">                        return Messages.getString(&quot;WeaponAttackAction.HeatOverCap&quot;);</span>
                    }
                } else {
<span class="nc bnc" id="L1470" title="All 6 branches missed.">                    if (!usedRearArc[loc] &amp;&amp; ((totalheat + currentHeat) &gt; heatcap) &amp;&amp; !onlyArc) {</span>
<span class="nc" id="L1471">                        return Messages.getString(&quot;WeaponAttackAction.HeatOverCap&quot;);</span>
                    }
                }
            }
<span class="nc bnc" id="L1475" title="All 2 branches missed.">        } else if (ae instanceof Dropship) {</span>
<span class="nc" id="L1476">            int totalheat = 0;</span>

<span class="nc bnc" id="L1478" title="All 2 branches missed.">            for (Enumeration&lt;EntityAction&gt; i = game.getActions(); i.hasMoreElements();) {</span>
<span class="nc" id="L1479">                Object o = i.nextElement();</span>
<span class="nc bnc" id="L1480" title="All 2 branches missed.">                if (!(o instanceof WeaponAttackAction)) {</span>
<span class="nc" id="L1481">                    continue;</span>
                }
<span class="nc" id="L1483">                WeaponAttackAction prevAttack = (WeaponAttackAction) o;</span>
<span class="nc bnc" id="L1484" title="All 4 branches missed.">                if ((prevAttack.getEntityId() == attackerId) &amp;&amp; (weaponId != prevAttack.getWeaponId())) {</span>
<span class="nc" id="L1485">                    Mounted prevWeapon = ae.getEquipment(prevAttack.getWeaponId());</span>
<span class="nc" id="L1486">                    totalheat += prevWeapon.getCurrentHeat();</span>
                }
<span class="nc" id="L1488">            }</span>

<span class="nc bnc" id="L1490" title="All 4 branches missed.">            if (weapon != null &amp;&amp; ((totalheat + weapon.getCurrentHeat()) &gt; heatcap)) {</span>
<span class="nc" id="L1491">                return Messages.getString(&quot;WeaponAttackAction.HeatOverCap&quot;);</span>
            }
        }

        // Protomechs can't fire energy weapons while charging EDP armor
<span class="nc bnc" id="L1496" title="All 6 branches missed.">        if ((ae instanceof Protomech) &amp;&amp; ((Protomech) ae).isEDPCharging() </span>
<span class="nc bnc" id="L1497" title="All 2 branches missed.">                &amp;&amp; wtype != null &amp;&amp; wtype.hasFlag(WeaponType.F_ENERGY)) {</span>
<span class="nc" id="L1498">            return Messages.getString(&quot;WeaponAttackAction.ChargingEDP&quot;);</span>
        }
        
        // for spheroid dropships in atmosphere (and on ground), the rules about
        // firing arcs are more complicated
        // TW errata 2.1
<span class="nc bnc" id="L1504" title="All 2 branches missed.">        if ((Compute.useSpheroidAtmosphere(game, ae) ||</span>
<span class="nc bnc" id="L1505" title="All 10 branches missed.">                (ae.isAero() &amp;&amp; ((IAero) ae).isSpheroid() &amp;&amp; (ae.getAltitude() == 0) &amp;&amp; game.getBoard().onGround()))</span>
                &amp;&amp; weapon != null) {
<span class="nc" id="L1507">            int altDif = target.getAltitude() - ae.getAltitude();</span>
<span class="nc" id="L1508">            int range = Compute.effectiveDistance(game, ae, target, false);</span>
            // Only aft-mounted weapons can be fired at range 0 (targets directly underneath)
<span class="nc bnc" id="L1510" title="All 6 branches missed.">            if (!ae.isAirborne() &amp;&amp; (range == 0) &amp;&amp; (weapon.getLocation() != Aero.LOC_AFT)) {</span>
<span class="nc" id="L1511">                return Messages.getString(&quot;WeaponAttackAction.OnlyAftAtZero&quot;);</span>
            }
            // Nose-mounted weapons can only be fired at targets at least 1 altitude higher
<span class="nc bnc" id="L1514" title="All 8 branches missed.">            if ((weapon.getLocation() == Aero.LOC_NOSE) &amp;&amp; (altDif &lt; 1)</span>
                    &amp;&amp; wtype != null
                    // Unless the weapon is used as artillery
<span class="nc bnc" id="L1517" title="All 2 branches missed.">                    &amp;&amp; (!(wtype instanceof ArtilleryWeapon || wtype.hasFlag(WeaponType.F_ARTILLERY)</span>
<span class="nc bnc" id="L1518" title="All 4 branches missed.">                            || (ae.getAltitude() == 0 &amp;&amp; wtype instanceof CapitalMissileWeapon)))) {</span>
<span class="nc" id="L1519">                return Messages.getString(&quot;WeaponAttackAction.TooLowForNose&quot;);</span>
            }
            // Front-side-mounted weapons can only be fired at targets at the same altitude or higher
<span class="nc bnc" id="L1522" title="All 10 branches missed.">            if ((!weapon.isRearMounted() &amp;&amp; (weapon.getLocation() != Aero.LOC_AFT)) &amp;&amp; (altDif &lt; 0)</span>
                    &amp;&amp; wtype != null
<span class="nc bnc" id="L1524" title="All 2 branches missed.">                    &amp;&amp; !((wtype instanceof ArtilleryWeapon) || wtype.hasFlag(WeaponType.F_ARTILLERY))) {</span>
<span class="nc" id="L1525">                return Messages.getString(&quot;WeaponAttackAction.TooLowForFrontSide&quot;);</span>
            }
            // Aft-mounted weapons can only be fired at targets at least 1 altitude lower
            // For grounded spheroids, weapons can only be fired at targets in occupied hexes, 
            // but it's not actually possible for a unit to occupy the same hex as a grounded spheroid so
            // we simplify the calculation a bit
<span class="nc bnc" id="L1531" title="All 2 branches missed.">            if (weapon.getLocation() == Aero.LOC_AFT) {</span>
<span class="nc bnc" id="L1532" title="All 2 branches missed.">                if(altDif &gt; -1) {</span>
<span class="nc" id="L1533">                    return Messages.getString(&quot;WeaponAttackAction.TooHighForAft&quot;);</span>
                } 
                
                // if both targets are on the ground
                // and the target is below the attacker 
                // and the attacker is in one of the target's occupied hexes
                // then we can shoot aft weapons at it
                // note that this cannot actually happen in MegaMek currently but is left here for the possible eventuality
                // that overhanging dropships are implemented
<span class="nc bnc" id="L1542" title="All 4 branches missed.">                if(!ae.isAirborne() &amp;&amp; !target.isAirborne()) {</span>
<span class="nc bnc" id="L1543" title="All 2 branches missed.">                    boolean targetInAttackerHex = ae.getOccupiedCoords().contains(target.getPosition()) ||</span>
<span class="nc bnc" id="L1544" title="All 2 branches missed.">                            ae.getPosition().equals(target.getPosition());</span>
<span class="nc" id="L1545">                    boolean targetBelowAttacker = game.getBoard().getHex(ae.getPosition()).surface() &gt;</span>
<span class="nc bnc" id="L1546" title="All 2 branches missed.">                            game.getBoard().getHex(target.getPosition()).surface() + target.getElevation();</span>
                    
<span class="nc bnc" id="L1548" title="All 4 branches missed.">                    if(!targetInAttackerHex || !targetBelowAttacker) {</span>
<span class="nc" id="L1549">                        return Messages.getString(&quot;WeaponAttackAction.GroundedSpheroidDropshipAftWeaponRestriction&quot;);</span>
                    }
                }
            }
            // and aft-side-mounted weapons can only be fired at targets at the same or lower altitude
<span class="nc bnc" id="L1554" title="All 4 branches missed.">            if ((weapon.isRearMounted()) &amp;&amp; (altDif &gt; 0)) {</span>
<span class="nc" id="L1555">                return Messages.getString(&quot;WeaponAttackAction.TooHighForAftSide&quot;);</span>
            }
<span class="nc bnc" id="L1557" title="All 2 branches missed.">            if (Compute.inDeadZone(game, ae, target)) {</span>
                // Only nose weapons can fire at targets in the dead zone at higher altitude
<span class="nc bnc" id="L1559" title="All 4 branches missed.">                if ((altDif &gt; 0) &amp;&amp; (weapon.getLocation() != Aero.LOC_NOSE)) {</span>
<span class="nc" id="L1560">                    return Messages.getString(&quot;WeaponAttackAction.OnlyNoseInDeadZone&quot;);</span>
                }
                // and only aft weapons can fire at targets in the dead zone at lower altitude
<span class="nc bnc" id="L1563" title="All 4 branches missed.">                if ((altDif &lt; 0) &amp;&amp; (weapon.getLocation() != Aero.LOC_AFT)) {</span>
<span class="nc" id="L1564">                    return Messages.getString(&quot;WeaponAttackAction.OnlyAftInDeadZone&quot;);</span>
                }
            }

        }
        
        // Weapon-specific Reasons
        
<span class="nc bnc" id="L1572" title="All 4 branches missed.">        if (weapon != null &amp;&amp; wtype != null) {</span>
            // Variable setup
            
            // &quot;Cool&quot; mode for vehicle flamer requires coolant ammo
<span class="nc" id="L1576">            boolean vf_cool = false;</span>
<span class="nc bnc" id="L1577" title="All 6 branches missed.">            if (atype != null &amp;&amp; ammo != null &amp;&amp; (((AmmoType) ammo.getType()).getMunitionType() == AmmoType.M_COOLANT)) {</span>
<span class="nc" id="L1578">                vf_cool = true;</span>
            }
            
            // Anti-Infantry weapons can only target infantry
<span class="nc bnc" id="L1582" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_INFANTRY_ONLY)) {</span>
<span class="nc bnc" id="L1583" title="All 4 branches missed.">                if ((te != null) &amp;&amp; !(te instanceof Infantry)) {</span>
<span class="nc" id="L1584">                    return Messages.getString(&quot;WeaponAttackAction.TargetOnlyInf&quot;);</span>
                }
            }
            
            // Air-to-ground attacks
<span class="nc bnc" id="L1589" title="All 6 branches missed.">            if (Compute.isAirToGround(ae, target) &amp;&amp; !isArtilleryIndirect &amp;&amp; !ae.isDropping()) {</span>
                // Can't strike from above altitude 5. Dive bombing uses a different test below
<span class="nc bnc" id="L1591" title="All 2 branches missed.">                if ((ae.getAltitude() &gt; 5) </span>
<span class="nc bnc" id="L1592" title="All 4 branches missed.">                        &amp;&amp; !wtype.hasFlag(WeaponType.F_DIVE_BOMB) &amp;&amp; !wtype.hasFlag(WeaponType.F_ALT_BOMB)) {</span>
<span class="nc" id="L1593">                    return Messages.getString(&quot;WeaponAttackAction.AttackerTooHigh&quot;);</span>
                }
                // Can't strafe from above altitude 3
<span class="nc bnc" id="L1596" title="All 4 branches missed.">                if ((ae.getAltitude() &gt; 3) &amp;&amp; isStrafing) {</span>
<span class="nc" id="L1597">                    return Messages.getString(&quot;WeaponAttackAction.AttackerTooHigh&quot;);</span>
                }
                // Additional Nape-of-Earth restrictions for strafing
<span class="nc bnc" id="L1600" title="All 4 branches missed.">                if (ae.getAltitude() == 1 &amp;&amp; isStrafing) {</span>
<span class="nc" id="L1601">                    Vector&lt;Coords&gt; passedThrough = ae.getPassedThrough();</span>
<span class="nc bnc" id="L1602" title="All 4 branches missed.">                    if ((passedThrough.size() == 0) || passedThrough.get(0).equals(target.getPosition())) {</span>
                        // TW pg 243 says units flying at NOE have a harder time
                        // establishing LoS while strafing and hence have to
                        // consider the adjacent hex along the flight place in the
                        // direction of the attack. What if there is no adjacent
                        // hex? The rules don't address this. We could
                        // theoretically consider last turns movement, but that's
                        // cumbersome, so we'll just assume it's impossible - Arlith
<span class="nc" id="L1610">                        return Messages.getString(&quot;WeaponAttackAction.TooCloseForStrafe&quot;);</span>
                    }
                    // Otherwise, check for a dead-zone, TW pg 243
<span class="nc" id="L1613">                    Coords prevCoords = ae.passedThroughPrevious(target.getPosition());</span>
<span class="nc" id="L1614">                    IHex prevHex = game.getBoard().getHex(prevCoords);</span>
<span class="nc" id="L1615">                    IHex currHex = game.getBoard().getHex(target.getPosition());</span>
<span class="nc" id="L1616">                    int prevElev = prevHex.getLevel();</span>
<span class="nc" id="L1617">                    int currElev = currHex.getLevel();</span>
<span class="nc bnc" id="L1618" title="All 2 branches missed.">                    if ((prevElev - currElev - target.relHeight()) &gt; 2) {</span>
<span class="nc" id="L1619">                        return Messages.getString(&quot;WeaponAttackAction.DeadZone&quot;);</span>
                    }
                }

                // Only direct-fire energy weapons can strafe
<span class="nc bnc" id="L1624" title="All 2 branches missed.">                boolean isDirectFireEnergy = (wtype.hasFlag(WeaponType.F_DIRECT_FIRE)</span>
<span class="nc bnc" id="L1625" title="All 4 branches missed.">                        &amp;&amp; (wtype.hasFlag(WeaponType.F_LASER) || wtype.hasFlag(WeaponType.F_PPC)</span>
<span class="nc bnc" id="L1626" title="All 4 branches missed.">                                || wtype.hasFlag(WeaponType.F_PLASMA) || wtype.hasFlag(WeaponType.F_PLASMA_MFUK)))</span>
<span class="nc bnc" id="L1627" title="All 2 branches missed.">                        || wtype.hasFlag(WeaponType.F_FLAMER);</span>
                // Note: flamers are direct fire energy, but don't have the flag,
                // so they won't work with targeting computers
<span class="nc bnc" id="L1630" title="All 6 branches missed.">                boolean isEnergyBay = (wtype instanceof LaserBayWeapon) || (wtype instanceof PPCBayWeapon)</span>
                        || (wtype instanceof PulseLaserBayWeapon);
<span class="nc bnc" id="L1632" title="All 6 branches missed.">                if (isStrafing &amp;&amp; !isDirectFireEnergy &amp;&amp; !isEnergyBay) {</span>
<span class="nc" id="L1633">                    return Messages.getString(&quot;WeaponAttackAction.StrafeDirectEnergyOnly&quot;);</span>
                }

                // only certain weapons can be used for air to ground attacks
<span class="nc bnc" id="L1637" title="All 2 branches missed.">                if (ae.isAero()) {</span>
                    // Spheroids can't strafe
<span class="nc bnc" id="L1639" title="All 4 branches missed.">                    if (isStrafing &amp;&amp; ((IAero) ae).isSpheroid()) {</span>
<span class="nc" id="L1640">                        return Messages.getString(&quot;WeaponAttackAction.NoSpheroidStrafing&quot;);</span>
                    }
                    // Spheroid craft can only use aft or aft-side mounted weapons for strike attacks
<span class="nc bnc" id="L1643" title="All 2 branches missed.">                    if (((IAero) ae).isSpheroid()) {</span>
<span class="nc bnc" id="L1644" title="All 4 branches missed.">                        if ((weapon.getLocation() != Aero.LOC_AFT) &amp;&amp; !weapon.isRearMounted()) {</span>
<span class="nc" id="L1645">                            return Messages.getString(&quot;WeaponAttackAction.InvalidDSAtgArc&quot;);</span>
                        }
                    // LAMs can't use leg or rear-mounted weapons
<span class="nc bnc" id="L1648" title="All 2 branches missed.">                    } else if (ae instanceof LandAirMech) {</span>
<span class="nc bnc" id="L1649" title="All 2 branches missed.">                        if ((weapon.getLocation() == Mech.LOC_LLEG)</span>
<span class="nc bnc" id="L1650" title="All 2 branches missed.">                                || (weapon.getLocation() == Mech.LOC_RLEG)</span>
<span class="nc bnc" id="L1651" title="All 2 branches missed.">                                || weapon.isRearMounted()) {</span>
<span class="nc" id="L1652">                            return Messages.getString(&quot;WeaponAttackAction.InvalidAeroDSAtgArc&quot;);</span>
                        }
                    } else {
                        // and other types of aero can't use aft or rear-mounted weapons
<span class="nc bnc" id="L1656" title="All 4 branches missed.">                        if ((weapon.getLocation() == Aero.LOC_AFT) || weapon.isRearMounted()) {</span>
<span class="nc" id="L1657">                            return Messages.getString(&quot;WeaponAttackAction.InvalidAeroDSAtgArc&quot;);</span>
                        }
                    }
                }

                // for air to ground attacks, the target's position must be within
                // the flight path, unless it is an artillery weapon in the nose.
                // http://www.classicbattletech.com/forums/index.php?topic=65110.0
<span class="nc bnc" id="L1665" title="All 2 branches missed.">                if (!ae.passedOver(target)) {</span>
<span class="nc bnc" id="L1666" title="All 2 branches missed.">                    if (!wtype.hasFlag(WeaponType.F_ARTILLERY)) {</span>
<span class="nc" id="L1667">                        return Messages.getString(&quot;WeaponAttackAction.NotOnFlightPath&quot;);</span>
<span class="nc bnc" id="L1668" title="All 2 branches missed.">                    } else if (weapon.getLocation() != Aero.LOC_NOSE) {</span>
<span class="nc" id="L1669">                        return Messages.getString(&quot;WeaponAttackAction.NotOnFlightPath&quot;);</span>
                    }
                }

                // Strike attacks cost the attacker 1 altitude
<span class="nc" id="L1674">                int altitudeLoss = 1;</span>
                // Dive bombing costs 2 altitude
<span class="nc bnc" id="L1676" title="All 2 branches missed.">                if (wtype.hasFlag(WeaponType.F_DIVE_BOMB)) {</span>
<span class="nc" id="L1677">                    altitudeLoss = 2;</span>
                }
                // Altitude bombing and strafing cost nothing
<span class="nc bnc" id="L1680" title="All 4 branches missed.">                if (wtype.hasFlag(WeaponType.F_ALT_BOMB) || isStrafing) {</span>
<span class="nc" id="L1681">                    altitudeLoss = 0;</span>
                }
<span class="nc" id="L1683">                int altLossThisRound = 0;</span>
<span class="nc bnc" id="L1684" title="All 2 branches missed.">                if (ae.isAero()) {</span>
<span class="nc" id="L1685">                    altLossThisRound = ((IAero) ae).getAltLossThisRound();</span>
                }
                // you cant make attacks that would lower you to zero altitude
<span class="nc bnc" id="L1688" title="All 2 branches missed.">                if (altitudeLoss &gt;= (ae.getAltitude() + altLossThisRound)) {</span>
<span class="nc" id="L1689">                    return Messages.getString(&quot;WeaponAttackAction.TooMuchAltLoss&quot;);</span>
                }

                // can only make a strike attack against a single target
<span class="nc bnc" id="L1693" title="All 2 branches missed.">                if (!isStrafing) {</span>
<span class="nc bnc" id="L1694" title="All 2 branches missed.">                    for (Enumeration&lt;EntityAction&gt; i = game.getActions(); i.hasMoreElements();) {</span>
<span class="nc" id="L1695">                        EntityAction ea = i.nextElement();</span>
<span class="nc bnc" id="L1696" title="All 2 branches missed.">                        if (!(ea instanceof WeaponAttackAction)) {</span>
<span class="nc" id="L1697">                            continue;</span>
                        }

<span class="nc" id="L1700">                        WeaponAttackAction prevAttk = (WeaponAttackAction) ea;</span>
<span class="nc bnc" id="L1701" title="All 4 branches missed.">                        if ((prevAttk.getEntityId() == ae.getId()) &amp;&amp; (prevAttk.getTargetId() != target.getTargetId())</span>
<span class="nc bnc" id="L1702" title="All 2 branches missed.">                                &amp;&amp; !wtype.hasFlag(WeaponType.F_ALT_BOMB)) {</span>
<span class="nc" id="L1703">                            return Messages.getString(&quot;WeaponAttackAction.CantSplitFire&quot;);</span>
                        }
<span class="nc" id="L1705">                    }</span>
                }
            // VTOL Strafing
<span class="nc bnc" id="L1708" title="All 4 branches missed.">            } else if ((ae instanceof VTOL) &amp;&amp; isStrafing) {</span>
<span class="nc bnc" id="L1709" title="All 2 branches missed.">                if (!(wtype.hasFlag(WeaponType.F_DIRECT_FIRE)</span>
<span class="nc bnc" id="L1710" title="All 4 branches missed.">                        &amp;&amp; (wtype.hasFlag(WeaponType.F_LASER) || wtype.hasFlag(WeaponType.F_PPC)</span>
<span class="nc bnc" id="L1711" title="All 4 branches missed.">                                || wtype.hasFlag(WeaponType.F_PLASMA) || wtype.hasFlag(WeaponType.F_PLASMA_MFUK)))</span>
<span class="nc bnc" id="L1712" title="All 2 branches missed.">                        || wtype.hasFlag(WeaponType.F_FLAMER)) {</span>
<span class="nc" id="L1713">                    return Messages.getString(&quot;WeaponAttackAction.StrafeDirectEnergyOnly&quot;);</span>
                }
<span class="nc bnc" id="L1715" title="All 2 branches missed.">                if (weapon.getLocation() != VTOL.LOC_FRONT</span>
<span class="nc bnc" id="L1716" title="All 2 branches missed.">                        &amp;&amp; weapon.getLocation() != VTOL.LOC_TURRET</span>
<span class="nc bnc" id="L1717" title="All 2 branches missed.">                        &amp;&amp; weapon.getLocation() != VTOL.LOC_TURRET_2) {</span>
<span class="nc" id="L1718">                    return Messages.getString(&quot;WeaponAttackAction.InvalidStrafingArc&quot;);</span>
                }
            }
            
            // Artillery
            
            // Arty shots have to be with arty, non arty shots with non arty.
<span class="nc bnc" id="L1725" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_ARTILLERY)) {</span>
                // check artillery is targeted appropriately for its ammo
                // Artillery only targets hexes unless making a direct fire flak shot or using
                // homing ammo.
                
<span class="nc bnc" id="L1730" title="All 8 branches missed.">                if ((ttype != Targetable.TYPE_HEX_ARTILLERY) &amp;&amp; (ttype != Targetable.TYPE_MINEFIELD_CLEAR)</span>
<span class="nc bnc" id="L1731" title="All 2 branches missed.">                        &amp;&amp; !isArtilleryFLAK &amp;&amp; !isHoming &amp;&amp; !target.isOffBoard()) {</span>
<span class="nc" id="L1732">                    return Messages.getString(&quot;WeaponAttackAction.ArtyAttacksOnly&quot;);</span>
                }
                // Airborne units can't make direct-fire artillery attacks
<span class="nc bnc" id="L1735" title="All 2 branches missed.">                if (ae.isAirborne()) {</span>
<span class="nc bnc" id="L1736" title="All 2 branches missed.">                    if (isArtilleryDirect) {</span>
<span class="nc" id="L1737">                        return Messages.getString(&quot;WeaponAttackAction.NoAeroDirectArty&quot;);</span>
<span class="nc bnc" id="L1738" title="All 2 branches missed.">                    } else if (isArtilleryIndirect) {</span>
                        // and can only make indirect artillery attacks at altitude 9 or below
<span class="nc bnc" id="L1740" title="All 2 branches missed.">                        if (ae.getAltitude() &gt; 9) {</span>
<span class="nc" id="L1741">                            return Messages.getString(&quot;WeaponAttackAction.TooHighForArty&quot;);</span>
                        }
                        // and finally, can only use Arrow IV artillery
<span class="nc bnc" id="L1744" title="All 2 branches missed.">                        if (ae.usesWeaponBays()) {</span>
                            //For Dropships
<span class="nc bnc" id="L1746" title="All 2 branches missed.">                            for (int wId : weapon.getBayWeapons()) {</span>
<span class="nc" id="L1747">                                Mounted bayW = ae.getEquipment(wId);</span>
                                // check the loaded ammo for the Arrow IV flag
<span class="nc" id="L1749">                                Mounted bayWAmmo = bayW.getLinked();</span>
<span class="nc" id="L1750">                                AmmoType bAType = (AmmoType) bayWAmmo.getType();</span>
<span class="nc bnc" id="L1751" title="All 2 branches missed.">                                if (bAType.getAmmoType() != AmmoType.T_ARROW_IV) {</span>
<span class="nc" id="L1752">                                    return Messages.getString(&quot;WeaponAttackAction.OnlyArrowArty&quot;);</span>
                                }
<span class="nc" id="L1754">                            }</span>
<span class="nc bnc" id="L1755" title="All 2 branches missed.">                        } else if (wtype.getAmmoType() != AmmoType.T_ARROW_IV) {</span>
                            //For Fighters, LAMs, Small Craft and VTOLs
<span class="nc" id="L1757">                            return Messages.getString(&quot;WeaponAttackAction.OnlyArrowArty&quot;);</span>
                        }
                    }
                }
<span class="nc bnc" id="L1761" title="All 2 branches missed.">            } else if (weapon.isInBearingsOnlyMode()) {</span>
                // We don't really need to do anything here. This just prevents these weapons
                // from passing the next test erroneously.
<span class="nc bnc" id="L1764" title="All 2 branches missed.">            } else if (wtype instanceof CapitalMissileWeapon</span>
<span class="nc bnc" id="L1765" title="All 2 branches missed.">                        &amp;&amp; Compute.isGroundToGround(ae, target)) {</span>
                // Grounded units firing capital missiles at ground targets must do so as artillery
<span class="nc bnc" id="L1767" title="All 2 branches missed.">                if (ttype != Targetable.TYPE_HEX_ARTILLERY) {</span>
<span class="nc" id="L1768">                    return Messages.getString(&quot;WeaponAttackAction.ArtyAttacksOnly&quot;);</span>
                }
            } else {
                // weapon is not artillery
<span class="nc bnc" id="L1772" title="All 2 branches missed.">                if (ttype == Targetable.TYPE_HEX_ARTILLERY) {</span>
<span class="nc" id="L1773">                    return Messages.getString(&quot;WeaponAttackAction.NoArtyAttacks&quot;);</span>
                }
            }
            
            // Direct-fire artillery attacks.
<span class="nc bnc" id="L1778" title="All 2 branches missed.">            if (isArtilleryDirect) {</span>
                // Cruise missiles cannot make direct-fire attacks
<span class="nc bnc" id="L1780" title="All 2 branches missed.">                if (isCruiseMissile) {</span>
<span class="nc" id="L1781">                    return Messages.getString(&quot;WeaponAttackAction.NoDirectCruiseMissile&quot;);</span>
                }
                // Direct fire artillery cannot be fired at less than 6 hexes
<span class="nc bnc" id="L1784" title="All 6 branches missed.">                if (isArtilleryDirect &amp;&amp; !target.isAirborne() &amp;&amp; (Compute.effectiveDistance(game, ae, target) &lt;= 6)) {</span>
<span class="nc" id="L1785">                    return Messages.getString(&quot;WeaponAttackAction.TooShortForDirectArty&quot;);</span>
                }
                // ...or more than 17 hexes
<span class="nc bnc" id="L1788" title="All 2 branches missed.">                if (distance &gt; Board.DEFAULT_BOARD_HEIGHT) {</span>
<span class="nc" id="L1789">                    return Messages.getString(&quot;WeaponAttackAction.TooLongForDirectArty&quot;);</span>
                }
<span class="nc bnc" id="L1791" title="All 2 branches missed.">                if (isHoming) {</span>
<span class="nc bnc" id="L1792" title="All 4 branches missed.">                    if ((te == null) || (te.getTaggedBy() == -1)) {</span>
                        // Homing missiles must target a tagged entity
<span class="nc" id="L1794">                        return Messages.getString(&quot;WeaponAttackAction.MustTargetTagged&quot;);</span>
                    }
                }
            }
            
            // Indirect artillery attacks
<span class="nc bnc" id="L1800" title="All 2 branches missed.">            if (isArtilleryIndirect) {</span>
<span class="nc" id="L1801">                int boardRange = (int) Math.ceil(distance / 17f);</span>
<span class="nc" id="L1802">                int maxRange = wtype.getLongRange();</span>
                // Capital/subcapital missiles have a board range equal to their max space hex range
<span class="nc bnc" id="L1804" title="All 2 branches missed.">                if (wtype instanceof CapitalMissileWeapon) {</span>
<span class="nc bnc" id="L1805" title="All 2 branches missed.">                    if (wtype.getMaxRange(weapon) == WeaponType.RANGE_EXT) {</span>
<span class="nc" id="L1806">                        maxRange = 50;</span>
                    }
<span class="nc bnc" id="L1808" title="All 2 branches missed.">                    if (wtype.getMaxRange(weapon) == WeaponType.RANGE_LONG) {</span>
<span class="nc" id="L1809">                        maxRange = 40;</span>
                    }
<span class="nc bnc" id="L1811" title="All 2 branches missed.">                    if (wtype.getMaxRange(weapon) == WeaponType.RANGE_MED) {</span>
<span class="nc" id="L1812">                        maxRange = 24;</span>
                    }
<span class="nc bnc" id="L1814" title="All 2 branches missed.">                    if (wtype.getMaxRange(weapon) == WeaponType.RANGE_SHORT) {</span>
<span class="nc" id="L1815">                        maxRange = 12;</span>
                    }
                }
                // Maximum range is measured in mapsheets
<span class="nc bnc" id="L1819" title="All 2 branches missed.">                if (boardRange &gt; maxRange) {</span>
<span class="nc" id="L1820">                    return Messages.getString(&quot;WeaponAttackAction.OutOfRange&quot;);</span>
                }
                // Indirect shots cannot be made at less than 17 hexes range unless
                // the attacker is airborne or has no line-of-sight
<span class="nc bnc" id="L1824" title="All 4 branches missed.">                if (((distance &lt;= Board.DEFAULT_BOARD_HEIGHT) &amp;&amp; !ae.isAirborne()) </span>
<span class="nc bnc" id="L1825" title="All 2 branches missed.">                        &amp;&amp; !(losMods.getValue() == TargetRoll.IMPOSSIBLE)) {</span>
<span class="nc" id="L1826">                    return Messages.getString(&quot;WeaponAttackAction.TooShortForIndirectArty&quot;);</span>
                }
<span class="nc bnc" id="L1828" title="All 2 branches missed.">                if (isHoming) {</span>
                    // Homing missiles must target a hex (mapsheet)
<span class="nc bnc" id="L1830" title="All 2 branches missed.">                    if (ttype != Targetable.TYPE_HEX_ARTILLERY) {</span>
<span class="nc" id="L1831">                        return Messages.getString(&quot;WeaponAttackAction.HomingMapsheetOnly&quot;);</span>
                    }
                }
            }
            
            // Ballistic and Missile weapons are subject to wind conditions
<span class="nc" id="L1837">            int windCond = game.getPlanetaryConditions().getWindStrength();</span>
<span class="nc bnc" id="L1838" title="All 4 branches missed.">            if ((windCond == PlanetaryConditions.WI_TORNADO_F13) &amp;&amp; wtype.hasFlag(WeaponType.F_MISSILE)</span>
<span class="nc bnc" id="L1839" title="All 2 branches missed.">                    &amp;&amp; !game.getBoard().inSpace()) {</span>
<span class="nc" id="L1840">                return Messages.getString(&quot;WeaponAttackAction.NoMissileTornado&quot;);</span>
            }

<span class="nc bnc" id="L1843" title="All 4 branches missed.">            if ((windCond == PlanetaryConditions.WI_TORNADO_F4) &amp;&amp; !game.getBoard().inSpace()</span>
<span class="nc bnc" id="L1844" title="All 4 branches missed.">                    &amp;&amp; (wtype.hasFlag(WeaponType.F_MISSILE) || wtype.hasFlag(WeaponType.F_BALLISTIC))) {</span>
<span class="nc" id="L1845">                return Messages.getString(&quot;WeaponAttackAction.F4Tornado&quot;);</span>
            }
            
            // Battle Armor
            
            // BA can only make one AP attack
<span class="nc bnc" id="L1851" title="All 4 branches missed.">            if ((ae instanceof BattleArmor) &amp;&amp; wtype.hasFlag(WeaponType.F_INFANTRY)) {</span>
<span class="nc" id="L1852">                final int weapId = ae.getEquipmentNum(weapon);</span>
                // See if this unit has made a previous AP attack
<span class="nc bnc" id="L1854" title="All 2 branches missed.">                for (Enumeration&lt;EntityAction&gt; i = game.getActions(); i.hasMoreElements();) {</span>
<span class="nc" id="L1855">                    Object o = i.nextElement();</span>
<span class="nc bnc" id="L1856" title="All 2 branches missed.">                    if (!(o instanceof WeaponAttackAction)) {</span>
<span class="nc" id="L1857">                        continue;</span>
                    }
<span class="nc" id="L1859">                    WeaponAttackAction prevAttack = (WeaponAttackAction) o;</span>
                    // Is this an attack from this entity
<span class="nc bnc" id="L1861" title="All 2 branches missed.">                    if (prevAttack.getEntityId() == ae.getId()) {</span>
<span class="nc" id="L1862">                        Mounted prevWeapon = ae.getEquipment(prevAttack.getWeaponId());</span>
<span class="nc" id="L1863">                        WeaponType prevWtype = (WeaponType) prevWeapon.getType();</span>
<span class="nc bnc" id="L1864" title="All 4 branches missed.">                        if (prevWtype.hasFlag(WeaponType.F_INFANTRY) &amp;&amp; (prevAttack.getWeaponId() != weapId)) {</span>
<span class="nc" id="L1865">                            return Messages.getString(&quot;WeaponAttackAction.OnlyOneBAAPAttack&quot;);</span>
                        }
                    }
<span class="nc" id="L1868">                }</span>
            }
            
            // BA compact narc: we have one weapon for each trooper, but you
            // can fire only at one target at a time
<span class="nc bnc" id="L1873" title="All 2 branches missed.">            if (wtype.getName().equals(&quot;Compact Narc&quot;)) {</span>
<span class="nc bnc" id="L1874" title="All 2 branches missed.">                for (Enumeration&lt;EntityAction&gt; i = game.getActions(); i.hasMoreElements();) {</span>
<span class="nc" id="L1875">                    EntityAction ea = i.nextElement();</span>
<span class="nc bnc" id="L1876" title="All 2 branches missed.">                    if (!(ea instanceof WeaponAttackAction)) {</span>
<span class="nc" id="L1877">                        continue;</span>
                    }
<span class="nc" id="L1879">                    final WeaponAttackAction prevAttack = (WeaponAttackAction) ea;</span>
<span class="nc bnc" id="L1880" title="All 2 branches missed.">                    if (prevAttack.getEntityId() == attackerId) {</span>
<span class="nc" id="L1881">                        Mounted prevWeapon = ae.getEquipment(prevAttack.getWeaponId());</span>
<span class="nc bnc" id="L1882" title="All 2 branches missed.">                        if (prevWeapon.getType().getName().equals(&quot;Compact Narc&quot;)) {</span>
<span class="nc bnc" id="L1883" title="All 2 branches missed.">                            if (prevAttack.getTargetId() != target.getTargetId()) {</span>
<span class="nc" id="L1884">                                return Messages.getString(&quot;WeaponAttackAction.OneTargetForCNarc&quot;);</span>
                            }
                        }
                    }
<span class="nc" id="L1888">                }</span>
            }
            
            // BA Mine launchers can not hit infantry
<span class="nc bnc" id="L1892" title="All 2 branches missed.">            if (BattleArmor.MINE_LAUNCHER.equals(wtype.getInternalName())) {</span>
<span class="nc bnc" id="L1893" title="All 2 branches missed.">                if (te instanceof Infantry) {</span>
<span class="nc" id="L1894">                    return Messages.getString(&quot;WeaponAttackAction.CantShootInfantry&quot;);</span>
                }
            }
            
            // BA NARCs and Tasers can only fire at one target in a round
<span class="nc bnc" id="L1899" title="All 2 branches missed.">            if ((ae instanceof BattleArmor)</span>
<span class="nc bnc" id="L1900" title="All 4 branches missed.">                    &amp;&amp; (wtype.hasFlag(WeaponType.F_TASER) || wtype.getAmmoType() == AmmoType.T_NARC)) {</span>
                // Go through all of the current actions to see if a NARC or Taser
                // has been fired
<span class="nc bnc" id="L1903" title="All 2 branches missed.">                for (Enumeration&lt;EntityAction&gt; i = game.getActions(); i.hasMoreElements();) {</span>
<span class="nc" id="L1904">                    Object o = i.nextElement();</span>
<span class="nc bnc" id="L1905" title="All 2 branches missed.">                    if (!(o instanceof WeaponAttackAction)) {</span>
<span class="nc" id="L1906">                        continue;</span>
                    }
<span class="nc" id="L1908">                    WeaponAttackAction prevAttack = (WeaponAttackAction) o;</span>
                    // Is this an attack from this entity to a different target?
<span class="nc bnc" id="L1910" title="All 4 branches missed.">                    if (prevAttack.getEntityId() == ae.getId() &amp;&amp; prevAttack.getTargetId() != target.getTargetId()) {</span>
<span class="nc" id="L1911">                        Mounted prevWeapon = ae.getEquipment(prevAttack.getWeaponId());</span>
<span class="nc" id="L1912">                        WeaponType prevWtype = (WeaponType) prevWeapon.getType();</span>
<span class="nc bnc" id="L1913" title="All 2 branches missed.">                        if (prevWeapon.getType().hasFlag(WeaponType.F_TASER)</span>
<span class="nc bnc" id="L1914" title="All 2 branches missed.">                                &amp;&amp; weapon.getType().hasFlag(WeaponType.F_TASER)) {</span>
<span class="nc" id="L1915">                            return Messages.getString(&quot;WeaponAttackAction.BATaserSameTarget&quot;);</span>
                        }
<span class="nc bnc" id="L1917" title="All 4 branches missed.">                        if (prevWtype.getAmmoType() == AmmoType.T_NARC &amp;&amp; wtype.getAmmoType() == AmmoType.T_NARC) {</span>
<span class="nc" id="L1918">                            return Messages.getString(&quot;WeaponAttackAction.BANarcSameTarget&quot;);</span>
                        }
                    }
<span class="nc" id="L1921">                }</span>
            }
            
            // BA squad support weapons require that Trooper 1 be alive to use
<span class="nc bnc" id="L1925" title="All 4 branches missed.">            if (weapon.isSquadSupportWeapon() &amp;&amp; (ae instanceof BattleArmor)) {</span>
<span class="nc bnc" id="L1926" title="All 2 branches missed.">                if (!((BattleArmor) ae).isTrooperActive(BattleArmor.LOC_TROOPER_1)) {</span>
<span class="nc" id="L1927">                    return Messages.getString(&quot;WeaponAttackAction.NoSquadSupport&quot;);</span>
                }
            }
            
            // Bombs and such
            
            // Anti ship missiles can't be launched from altitude 3 or lower
<span class="nc bnc" id="L1934" title="All 6 branches missed.">            if (wtype.hasFlag(WeaponType.F_ANTI_SHIP) &amp;&amp; !game.getBoard().inSpace() &amp;&amp; (ae.getAltitude() &lt; 4)) {</span>
<span class="nc" id="L1935">                return Messages.getString(&quot;WeaponAttackAction.TooLowForASM&quot;);</span>
            }
            
            // ASEW Missiles cannot be launched in an atmosphere
<span class="nc bnc" id="L1939" title="All 2 branches missed.">            if ((wtype.getAmmoType() == AmmoType.T_ASEW_MISSILE)</span>
<span class="nc bnc" id="L1940" title="All 2 branches missed.">                    &amp;&amp; !ae.isSpaceborne()) {</span>
<span class="nc" id="L1941">                return Messages.getString(&quot;WeaponAttackAction.ASEWAtmo&quot;);</span>
            }
            
<span class="nc bnc" id="L1944" title="All 2 branches missed.">            if (ae.isAero()) {</span>
                // Can't mix bombing with other attack types
                // also for altitude bombing, the target hex must either be the first in a line
                // adjacent to a prior one
<span class="nc" id="L1948">                boolean adjacentAltBomb = false;</span>
<span class="nc" id="L1949">                boolean firstAltBomb = true;</span>
<span class="nc bnc" id="L1950" title="All 2 branches missed.">                for (Enumeration&lt;EntityAction&gt; i = game.getActions(); i.hasMoreElements();) {</span>
<span class="nc" id="L1951">                    Object o = i.nextElement();</span>
<span class="nc bnc" id="L1952" title="All 2 branches missed.">                    if (!(o instanceof WeaponAttackAction)) {</span>
<span class="nc" id="L1953">                        continue;</span>
                    }
<span class="nc" id="L1955">                    WeaponAttackAction prevAttack = (WeaponAttackAction) o;</span>
<span class="nc bnc" id="L1956" title="All 2 branches missed.">                    if (prevAttack.getEntityId() == attackerId) {</span>
                        // You also can't mix and match the 3 different types of bombing:  Space, Dive and Altitude
<span class="nc bnc" id="L1958" title="All 2 branches missed.">                        if ((weaponId != prevAttack.getWeaponId())</span>
<span class="nc bnc" id="L1959" title="All 2 branches missed.">                                &amp;&amp; ae.getEquipment(prevAttack.getWeaponId()).getType().hasFlag(WeaponType.F_SPACE_BOMB)) {</span>
<span class="nc" id="L1960">                            return Messages.getString(&quot;WeaponAttackAction.BusySpaceBombing&quot;);</span>
                        }
<span class="nc bnc" id="L1962" title="All 2 branches missed.">                        if ((weaponId != prevAttack.getWeaponId())</span>
<span class="nc bnc" id="L1963" title="All 2 branches missed.">                                &amp;&amp; ae.getEquipment(prevAttack.getWeaponId()).getType().hasFlag(WeaponType.F_DIVE_BOMB)) {</span>
<span class="nc" id="L1964">                            return Messages.getString(&quot;WeaponAttackAction.BusyDiveBombing&quot;);</span>
                        }
<span class="nc bnc" id="L1966" title="All 2 branches missed.">                        if ((weaponId != prevAttack.getWeaponId())</span>
<span class="nc bnc" id="L1967" title="All 2 branches missed.">                                &amp;&amp; ae.getEquipment(prevAttack.getWeaponId()).getType().hasFlag(WeaponType.F_ALT_BOMB)) {</span>
<span class="nc bnc" id="L1968" title="All 2 branches missed.">                            if (!wtype.hasFlag(WeaponType.F_ALT_BOMB)) {</span>
<span class="nc" id="L1969">                                return Messages.getString(&quot;WeaponAttackAction.BusyAltBombing&quot;);</span>
                            }
<span class="nc" id="L1971">                            firstAltBomb = false;</span>
<span class="nc" id="L1972">                            int bombDistance = prevAttack.getTarget(game).getPosition().distance(target.getPosition());</span>
<span class="nc bnc" id="L1973" title="All 2 branches missed.">                            if (bombDistance == 1) {</span>
<span class="nc" id="L1974">                                adjacentAltBomb = true;</span>
                            }
                            // For altitude bombing, prevent targeting the same hex twice
<span class="nc bnc" id="L1977" title="All 2 branches missed.">                            if (bombDistance == 0) {</span>
<span class="nc" id="L1978">                                return Messages.getString(&quot;WeaponAttackAction.AlreadyBombingHex&quot;);</span>
                            }

                        }
                    }
<span class="nc" id="L1983">                }</span>
<span class="nc bnc" id="L1984" title="All 6 branches missed.">                if (wtype.hasFlag(WeaponType.F_ALT_BOMB) &amp;&amp; !firstAltBomb &amp;&amp; !adjacentAltBomb) {</span>
<span class="nc" id="L1985">                    return Messages.getString(&quot;WeaponAttackAction.BombNotInLine&quot;);</span>
                }
            }
            
            // Altitude and dive bombing attacks...
<span class="nc bnc" id="L1990" title="All 4 branches missed.">            if (wtype.hasFlag(WeaponType.F_DIVE_BOMB) || wtype.hasFlag(WeaponType.F_ALT_BOMB)) {</span>
                // Can't fire if the unit is out of bombs
<span class="nc bnc" id="L1992" title="All 2 branches missed.">                if (ae.getBombs(AmmoType.F_GROUND_BOMB).isEmpty()) {</span>
<span class="nc" id="L1993">                    return Messages.getString(&quot;WeaponAttackAction.OutOfBombs&quot;);</span>
                }
                // Spheroid Aeros can't bomb
<span class="nc bnc" id="L1996" title="All 4 branches missed.">                if (ae.isAero() &amp;&amp; ((IAero) ae).isSpheroid()) {</span>
<span class="nc" id="L1997">                    return Messages.getString(&quot;WeaponAttackAction.NoSpheroidBombing&quot;);</span>
                }
                // Grounded Aeros can't bomb
<span class="nc bnc" id="L2000" title="All 4 branches missed.">                if (!ae.isAirborne() &amp;&amp; !ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L2001">                    return Messages.getString(&quot;WeaponAttackAction.GroundedAeroCantBomb&quot;);</span>
                }
                // Bomb attacks can only target hexes
<span class="nc bnc" id="L2004" title="All 2 branches missed.">                if (target.getTargetType() != Targetable.TYPE_HEX_AERO_BOMB) {</span>
<span class="nc" id="L2005">                    return Messages.getString(&quot;WeaponAttackAction.BombTargetHexOnly&quot;);</span>
                }
                // Can't target a hex that isn't on the flight path
<span class="nc bnc" id="L2008" title="All 2 branches missed.">                if (!ae.passedOver(target)) {</span>
<span class="nc" id="L2009">                    return Messages.getString(&quot;WeaponAttackAction.CantBombOffFlightPath&quot;);</span>
                }
                // Dive Bombing can only be conducted if starting between altitude 5 and altitude 3
<span class="nc bnc" id="L2012" title="All 2 branches missed.">                if (wtype.hasFlag(WeaponType.F_DIVE_BOMB)) {</span>
<span class="nc bnc" id="L2013" title="All 2 branches missed.">                    if (ae.getAltitude() &gt; DiveBombAttack.DIVE_BOMB_MAX_ALTITUDE) {</span>
<span class="nc" id="L2014">                        return Messages.getString(&quot;WeaponAttackAction.TooHighForDiveBomb&quot;);</span>
                    }
<span class="nc bnc" id="L2016" title="All 2 branches missed.">                    if (ae.isAero()) {</span>
<span class="nc" id="L2017">                        int altLoss = ((IAero) ae).getAltLossThisRound();</span>
<span class="nc bnc" id="L2018" title="All 2 branches missed.">                        if ((ae.getAltitude() + altLoss) &lt; DiveBombAttack.DIVE_BOMB_MIN_ALTITUDE) {</span>
<span class="nc" id="L2019">                            return Messages.getString(&quot;WeaponAttackAction.TooLowForDiveBomb&quot;);</span>
                        }
                    }
                }
            }
            
            // Can't attack bomb hex targets with weapons other than alt/dive bombs
<span class="nc bnc" id="L2026" title="All 4 branches missed.">            if ((target.getTargetType() == Targetable.TYPE_HEX_AERO_BOMB) &amp;&amp; !wtype.hasFlag(WeaponType.F_DIVE_BOMB)</span>
<span class="nc bnc" id="L2027" title="All 2 branches missed.">                    &amp;&amp; !wtype.hasFlag(WeaponType.F_ALT_BOMB)) {</span>
<span class="nc" id="L2028">                return Messages.getString(&quot;WeaponAttackAction.InvalidForBombing&quot;);</span>
            }
            
            // BA Micro bombs only when flying
<span class="nc bnc" id="L2032" title="All 4 branches missed.">            if ((atype != null) &amp;&amp; (atype.getAmmoType() == AmmoType.T_BA_MICRO_BOMB)) {</span>
<span class="nc bnc" id="L2033" title="All 2 branches missed.">                if (!ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L2034">                    return Messages.getString(&quot;WeaponAttackAction.MinimumAlt1&quot;);</span>
                // and can only target hexes
<span class="nc bnc" id="L2036" title="All 2 branches missed.">                } else if (target.getTargetType() != Targetable.TYPE_HEX_BOMB) {</span>
<span class="nc" id="L2037">                    return Messages.getString(&quot;WeaponAttackAction.BombTargetHexOnly&quot;);</span>
                // and can only be dropped at exactly altitude 1
<span class="nc bnc" id="L2039" title="All 2 branches missed.">                } else if (ae.getElevation() != 1) {</span>
<span class="nc" id="L2040">                    return Messages.getString(&quot;WeaponAttackAction.ExactlyAlt1&quot;);</span>
                }
            }
            
            // Can't attack a Micro Bomb hex target with other weapons
<span class="nc bnc" id="L2045" title="All 6 branches missed.">            if ((target.getTargetType() == Targetable.TYPE_HEX_BOMB)</span>
<span class="nc bnc" id="L2046" title="All 2 branches missed.">                    &amp;&amp; !(usesAmmo &amp;&amp; atype != null &amp;&amp; (atype.getAmmoType() == AmmoType.T_BA_MICRO_BOMB))) {</span>
<span class="nc" id="L2047">                return Messages.getString(&quot;WeaponAttackAction.InvalidForBombing&quot;);</span>
            }
            
            // Space bombing attacks
<span class="nc bnc" id="L2051" title="All 4 branches missed.">            if (wtype.hasFlag(WeaponType.F_SPACE_BOMB) &amp;&amp; te != null) {</span>
<span class="nc" id="L2052">                toHit = Compute.getSpaceBombBaseToHit(ae, te, game);</span>
                // Return if the attack is impossible.
<span class="nc bnc" id="L2054" title="All 2 branches missed.">                if (TargetRoll.IMPOSSIBLE == toHit.getValue()) {</span>
<span class="nc" id="L2055">                    return toHit.getDesc();</span>
                }
            }
            
            // B-Pods

<span class="nc bnc" id="L2061" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_B_POD)) {</span>
                // B-Pods are only effective against infantry
<span class="nc bnc" id="L2063" title="All 2 branches missed.">                if (!(target instanceof Infantry)) {</span>
<span class="nc" id="L2064">                    return Messages.getString(&quot;WeaponAttackAction.BPodOnlyAtInf&quot;);</span>
                }
                // Leg-mounted B-Pods can be fired at infantry in the attacker's hex, other locations
                // can only be fired in response to leg/swarm attacks
<span class="nc bnc" id="L2068" title="All 2 branches missed.">                if (ae instanceof BipedMech) {</span>
<span class="nc bnc" id="L2069" title="All 4 branches missed.">                    if (!((weapon.getLocation() == Mech.LOC_LLEG) || (weapon.getLocation() == Mech.LOC_RLEG))) {</span>
<span class="nc" id="L2070">                        return Messages.getString(&quot;WeaponAttackAction.OnlyLegBPod&quot;);</span>
                    }
<span class="nc bnc" id="L2072" title="All 2 branches missed.">                } else if (ae instanceof QuadMech) {</span>
<span class="nc bnc" id="L2073" title="All 4 branches missed.">                    if (!((weapon.getLocation() == Mech.LOC_LLEG) || (weapon.getLocation() == Mech.LOC_RLEG)</span>
<span class="nc bnc" id="L2074" title="All 4 branches missed.">                            || (weapon.getLocation() == Mech.LOC_LARM) || (weapon.getLocation() == Mech.LOC_RARM))) {</span>
<span class="nc" id="L2075">                        return Messages.getString(&quot;WeaponAttackAction.OnlyLegBPod&quot;);</span>
                    }
                }
            }
            
            // Called shots
<span class="nc bnc" id="L2081" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_CALLED_SHOTS)) {</span>
<span class="nc" id="L2082">                String reason = weapon.getCalledShot().isValid(target);</span>
<span class="nc bnc" id="L2083" title="All 2 branches missed.">                if (reason != null) {</span>
<span class="nc" id="L2084">                    return reason;</span>
                }
            }
            
            // Capital Mass Drivers can only fire at targets directly in front of the attacker
<span class="nc bnc" id="L2089" title="All 6 branches missed.">            if ((target.getTargetType() == Targetable.TYPE_ENTITY) &amp;&amp; wtype.hasFlag(WeaponType.F_MASS_DRIVER)</span>
                    &amp;&amp; (ae instanceof SpaceStation)) {
<span class="nc bnc" id="L2091" title="All 2 branches missed.">                if (!ae.getPosition().translated(ae.getFacing(), Compute.effectiveDistance(game, ae, target)).equals(target.getPosition())) {</span>
<span class="nc" id="L2092">                    return Messages.getString(&quot;WeaponAttackAction.MassDriverFrontOnly&quot;);</span>
                }
            }
            
            // Capital missiles in bearings-only mode
<span class="nc bnc" id="L2097" title="All 2 branches missed.">            if (isBearingsOnlyMissile) {</span>
                //Can't target anything beyond max range of 5,000 hexes
                //This is an arbitrary number. If your map size is really this large, you'll probably crash the game
<span class="nc bnc" id="L2100" title="All 2 branches missed.">                if (distance &gt; RangeType.RANGE_BEARINGS_ONLY_OUT) {</span>
<span class="nc" id="L2101">                    return Messages.getString(&quot;WeaponAttackAction.OutOfRange&quot;);</span>
                }
                // Can't fire in bearings-only mode within direct-fire range (50 hexes)
<span class="nc bnc" id="L2104" title="All 4 branches missed.">                if (game.getPhase() == IGame.Phase.PHASE_TARGETING &amp;&amp; distance &lt; RangeType.RANGE_BEARINGS_ONLY_MINIMUM) {</span>
<span class="nc" id="L2105">                    return Messages.getString(&quot;WeaponAttackAction.BoMissileMinRange&quot;);</span>
                } 
                // Can't target anything but hexes
<span class="nc bnc" id="L2108" title="All 2 branches missed.">                if (ttype != Targetable.TYPE_HEX_ARTILLERY) {</span>
<span class="nc" id="L2109">                    return Messages.getString(&quot;WeaponAttackAction.BOHexOnly&quot;);</span>
                }
            }
            
            // Capital weapons fire by grounded units
<span class="nc bnc" id="L2114" title="All 4 branches missed.">            if (wtype.isSubCapital() || wtype.isCapital()) {</span>
                // Can't fire any but capital/subcapital missiles surface to surface
<span class="nc bnc" id="L2116" title="All 4 branches missed.">                if (Compute.isGroundToGround(ae, target)</span>
                        &amp;&amp; !(wtype instanceof CapitalMissileWeapon)) {
<span class="nc" id="L2118">                    return Messages.getString(&quot;WeaponAttackAction.NoS2SCapWeapons&quot;);</span>
                }
            }
            
            // Causing Fires
            
            // Some weapons can't cause fires, but Infernos always can.
<span class="nc bnc" id="L2125" title="All 6 branches missed.">            if ((vf_cool || (wtype.hasFlag(WeaponType.F_NO_FIRES) &amp;&amp; !isInferno))</span>
<span class="nc bnc" id="L2126" title="All 2 branches missed.">                    &amp;&amp; (Targetable.TYPE_HEX_IGNITE == target.getTargetType())) {</span>
<span class="nc" id="L2127">                return Messages.getString(&quot;WeaponAttackAction.WeaponCantIgnite&quot;);</span>
            }
            
            // only woods and buildings can be set intentionally on fire
<span class="nc bnc" id="L2131" title="All 2 branches missed.">            if ((target.getTargetType() == Targetable.TYPE_HEX_IGNITE)</span>
<span class="nc bnc" id="L2132" title="All 2 branches missed.">                    &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVANCED_NO_IGNITE_CLEAR)</span>
<span class="nc bnc" id="L2133" title="All 2 branches missed.">                    &amp;&amp; !(game.getBoard().getHex(((HexTarget) target).getPosition()).containsTerrain(Terrains.WOODS)</span>
<span class="nc bnc" id="L2134" title="All 2 branches missed.">                            || game.getBoard().getHex(((HexTarget) target).getPosition()).containsTerrain(Terrains.JUNGLE)</span>
<span class="nc" id="L2135">                            || game.getBoard().getHex(((HexTarget) target).getPosition())</span>
<span class="nc bnc" id="L2136" title="All 2 branches missed.">                                    .containsTerrain(Terrains.FUEL_TANK)</span>
<span class="nc" id="L2137">                            || game.getBoard().getHex(((HexTarget) target).getPosition())</span>
<span class="nc bnc" id="L2138" title="All 2 branches missed.">                                    .containsTerrain(Terrains.BUILDING))) {</span>
<span class="nc" id="L2139">                return Messages.getString(&quot;WeaponAttackAction.CantIntentionallyBurn&quot;);</span>
            }
            
            // Conventional Infantry Attacks
            
<span class="nc bnc" id="L2144" title="All 4 branches missed.">            if (isAttackerInfantry &amp;&amp; !(ae instanceof BattleArmor)) {</span>
                // 0 MP infantry units: move or shoot, except for anti-mech attacks,
                // those are handled above
<span class="nc bnc" id="L2147" title="All 6 branches missed.">                if ((ae.getMovementMode() == EntityMovementMode.INF_LEG) &amp;&amp; (ae.getWalkMP() == 0)</span>
                        &amp;&amp; (ae.moved != EntityMovementType.MOVE_NONE)) {
<span class="nc" id="L2149">                    return Messages.getString(&quot;WeaponAttackAction.0MPInf&quot;);</span>
                }
                // Can't shoot if platoon used fast movement
<span class="nc bnc" id="L2152" title="All 4 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_FAST_INFANTRY_MOVE)</span>
                        &amp;&amp; (ae.moved == EntityMovementType.MOVE_RUN)) {
<span class="nc" id="L2154">                    return Messages.getString(&quot;WeaponAttackAction.CantShootAndFastMove&quot;);</span>
                }
                // check for trying to fire field gun after moving
<span class="nc bnc" id="L2157" title="All 4 branches missed.">                if ((weapon.getLocation() == Infantry.LOC_FIELD_GUNS) &amp;&amp; (ae.moved != EntityMovementType.MOVE_NONE)) {</span>
<span class="nc" id="L2158">                    return Messages.getString(&quot;WeaponAttackAction.CantMoveAndFieldGun&quot;);</span>
                }
                // check for mixing infantry and field gun attacks
<span class="nc" id="L2161">                double fieldGunWeight = 0.0;</span>
<span class="nc bnc" id="L2162" title="All 2 branches missed.">                for (Enumeration&lt;EntityAction&gt; i = game.getActions(); i.hasMoreElements();) {</span>
<span class="nc" id="L2163">                    EntityAction ea = i.nextElement();</span>
<span class="nc bnc" id="L2164" title="All 2 branches missed.">                    if (!(ea instanceof WeaponAttackAction)) {</span>
<span class="nc" id="L2165">                        continue;</span>
                    }
<span class="nc" id="L2167">                    final WeaponAttackAction prevAttack = (WeaponAttackAction) ea;</span>
<span class="nc bnc" id="L2168" title="All 2 branches missed.">                    if (prevAttack.getEntityId() == attackerId) {</span>
<span class="nc" id="L2169">                        Mounted prevWeapon = ae.getEquipment(prevAttack.getWeaponId());</span>
<span class="nc bnc" id="L2170" title="All 2 branches missed.">                        if ((prevWeapon.getType().hasFlag(WeaponType.F_INFANTRY)</span>
<span class="nc bnc" id="L2171" title="All 2 branches missed.">                                &amp;&amp; (weapon.getLocation() == Infantry.LOC_FIELD_GUNS))</span>
<span class="nc bnc" id="L2172" title="All 2 branches missed.">                                || (weapon.getType().hasFlag(WeaponType.F_INFANTRY)</span>
<span class="nc bnc" id="L2173" title="All 2 branches missed.">                                        &amp;&amp; (prevWeapon.getLocation() == Infantry.LOC_FIELD_GUNS))) {</span>
<span class="nc" id="L2174">                            return Messages.getString(&quot;WeaponAttackAction.FieldGunOrSAOnly&quot;);</span>
                        }
<span class="nc bnc" id="L2176" title="All 4 branches missed.">                        if ((weapon.getLocation() == Infantry.LOC_FIELD_GUNS) &amp;&amp; (weaponId != prevAttack.getWeaponId())) {</span>
<span class="nc" id="L2177">                            fieldGunWeight += prevWeapon.getTonnage();</span>
                        }
                    }
<span class="nc" id="L2180">                }</span>
                // the total tonnage of field guns fired has to be less than or
                // equal to the men in the platoon
<span class="nc bnc" id="L2183" title="All 2 branches missed.">                if (weapon.getLocation() == Infantry.LOC_FIELD_GUNS) {</span>
<span class="nc bnc" id="L2184" title="All 2 branches missed.">                    if (((Infantry) ae).getShootingStrength() &lt; Math.ceil(fieldGunWeight + weapon.getTonnage())) {</span>
<span class="nc" id="L2185">                        return Messages.getString(&quot;WeaponAttackAction.NoFieldGunCrew&quot;);</span>
                    }
                }
            }
            
            // Extinguishing Fires

            // You can use certain types of flamer/sprayer ammo or infantry firefighting engineers
            // to extinguish burning hexes (and units).
            // TODO: This functionality does not appear to be implemented
<span class="nc bnc" id="L2195" title="All 2 branches missed.">            if (Targetable.TYPE_HEX_EXTINGUISH == target.getTargetType()) {</span>
<span class="nc bnc" id="L2196" title="All 4 branches missed.">                if (!wtype.hasFlag(WeaponType.F_EXTINGUISHER) &amp;&amp; !vf_cool) {</span>
<span class="nc" id="L2197">                    return Messages.getString(&quot;WeaponAttackAction.InvalidForFirefighting&quot;);</span>
                }
<span class="nc" id="L2199">                IHex hexTarget = game.getBoard().getHex(target.getPosition());</span>
<span class="nc bnc" id="L2200" title="All 2 branches missed.">                if (!hexTarget.containsTerrain(Terrains.FIRE)) {</span>
<span class="nc" id="L2201">                    return Messages.getString(&quot;WeaponAttackAction.TargetNotBurning&quot;);</span>
                }
<span class="nc bnc" id="L2203" title="All 2 branches missed.">            } else if (wtype.hasFlag(WeaponType.F_EXTINGUISHER)) {</span>
<span class="nc bnc" id="L2204" title="All 6 branches missed.">                if (!(((target instanceof Tank) &amp;&amp; ((Tank) target).isOnFire())</span>
<span class="nc bnc" id="L2205" title="All 2 branches missed.">                        || ((target instanceof Entity) &amp;&amp; (((Entity) target).infernos.getTurnsLeftToBurn() &gt; 0)))) {</span>
<span class="nc" id="L2206">                    return Messages.getString(&quot;WeaponAttackAction.TargetNotBurning&quot;);</span>
                }
            }
            
            // Gauss weapons using the TacOps powered down rule can't fire
<span class="nc bnc" id="L2211" title="All 2 branches missed.">            if ((wtype instanceof GaussWeapon) </span>
<span class="nc bnc" id="L2212" title="All 4 branches missed.">                    &amp;&amp; wtype.hasModes() &amp;&amp; weapon.curMode().equals(Weapon.MODE_GAUSS_POWERED_DOWN)) {</span>
<span class="nc" id="L2213">                return Messages.getString(&quot;WeaponAttackAction.WeaponNotReady&quot;);</span>
            }
            
            // Ground-to-air attacks
            
            // air2air and air2ground cannot be combined by any aerospace units
<span class="nc bnc" id="L2219" title="All 4 branches missed.">            if (Compute.isAirToAir(ae, target) || Compute.isAirToGround(ae, target)) {</span>
<span class="nc bnc" id="L2220" title="All 2 branches missed.">                for (Enumeration&lt;EntityAction&gt; i = game.getActions(); i.hasMoreElements();) {</span>
<span class="nc" id="L2221">                    EntityAction ea = i.nextElement();</span>
<span class="nc bnc" id="L2222" title="All 2 branches missed.">                    if (!(ea instanceof WeaponAttackAction)) {</span>
<span class="nc" id="L2223">                        continue;</span>
                    }
<span class="nc" id="L2225">                    WeaponAttackAction prevAttack = (WeaponAttackAction) ea;</span>
<span class="nc bnc" id="L2226" title="All 2 branches missed.">                    if (prevAttack.getEntityId() != ae.getId()) {</span>
<span class="nc" id="L2227">                        continue;</span>
                    }
<span class="nc bnc" id="L2229" title="All 4 branches missed.">                    if (Compute.isAirToAir(ae, target) &amp;&amp; prevAttack.isAirToGround(game)) {</span>
<span class="nc" id="L2230">                        return Messages.getString(&quot;WeaponAttackAction.AlreadyAtgAttack&quot;);</span>
                    }
<span class="nc bnc" id="L2232" title="All 4 branches missed.">                    if (Compute.isAirToGround(ae, target) &amp;&amp; prevAttack.isAirToAir(game)) {</span>
<span class="nc" id="L2233">                        return Messages.getString(&quot;WeaponAttackAction.AlreadyAtaAttack&quot;);</span>
                    }
<span class="nc" id="L2235">                }</span>
            }
            
            // Can't make ground-to-air attacks against a target above altitude 8
<span class="nc bnc" id="L2239" title="All 4 branches missed.">            if ((target.getAltitude() &gt; 8) &amp;&amp; Compute.isGroundToAir(ae, target)) {</span>
<span class="nc" id="L2240">                return Messages.getString(&quot;WeaponAttackAction.AeroTooHighForGta&quot;);</span>
            }
            
            // Infantry can't make ground-to-air attacks, unless using field guns, specialized AA infantry weapons,
            // or direct-fire artillery flak attacks
<span class="nc bnc" id="L2245" title="All 4 branches missed.">            boolean isWeaponFieldGuns = isAttackerInfantry &amp;&amp; (weapon.getLocation() == Infantry.LOC_FIELD_GUNS);</span>
<span class="nc bnc" id="L2246" title="All 10 branches missed.">            if ((ae instanceof Infantry) &amp;&amp; Compute.isGroundToAir(ae, target) &amp;&amp; !wtype.hasFlag(WeaponType.F_INF_AA)</span>
                    &amp;&amp; !isArtilleryFLAK
                    &amp;&amp; !isWeaponFieldGuns) {
<span class="nc" id="L2249">                return Messages.getString(&quot;WeaponAttackAction.NoInfantryGta&quot;);</span>
            }
            
            // only one ground-to-air attack allowed per turn
            // grounded spheroid dropships dont have this limitation
<span class="nc bnc" id="L2254" title="All 6 branches missed.">            if (!ae.isAirborne() &amp;&amp; !((ae instanceof Dropship) &amp;&amp; ((Aero) ae).isSpheroid())) {</span>
<span class="nc bnc" id="L2255" title="All 2 branches missed.">                for (Enumeration&lt;EntityAction&gt; i = game.getActions(); i.hasMoreElements();) {</span>
<span class="nc" id="L2256">                    EntityAction ea = i.nextElement();</span>
<span class="nc bnc" id="L2257" title="All 2 branches missed.">                    if (!(ea instanceof WeaponAttackAction)) {</span>
<span class="nc" id="L2258">                        continue;</span>
                    }
<span class="nc" id="L2260">                    WeaponAttackAction prevAttack = (WeaponAttackAction) ea;</span>
<span class="nc bnc" id="L2261" title="All 2 branches missed.">                    if (prevAttack.getEntityId() == ae.getId()) {</span>
<span class="nc bnc" id="L2262" title="All 4 branches missed.">                        if (prevAttack.isGroundToAir(game) &amp;&amp; !Compute.isGroundToAir(ae, target)) {</span>
<span class="nc" id="L2263">                            return Messages.getString(&quot;WeaponAttackAction.AlreadyGtaAttack&quot;);</span>
                        }
                        // Can't mix ground-to-air and ground-to-ground attacks either
<span class="nc bnc" id="L2266" title="All 4 branches missed.">                        if (!prevAttack.isGroundToAir(game) &amp;&amp; Compute.isGroundToAir(ae, target)) {</span>
<span class="nc" id="L2267">                            return Messages.getString(&quot;WeaponAttackAction.AlreadyGtgAttack&quot;);</span>
                        }
                        // Or split ground-to-air fire across multiple targets
<span class="nc bnc" id="L2270" title="All 6 branches missed.">                        if (prevAttack.isGroundToAir(game) &amp;&amp; Compute.isGroundToAir(ae, target) &amp;&amp; (null != te)</span>
<span class="nc bnc" id="L2271" title="All 2 branches missed.">                                &amp;&amp; (prevAttack.getTargetId() != te.getId())) {</span>
<span class="nc" id="L2272">                            return Messages.getString(&quot;WeaponAttackAction.OneTargetForGta&quot;);</span>
                        }
                    }
<span class="nc" id="L2275">                }</span>
            }
            
            // Indirect Fire (LRMs)
            
            // Can't fire Indirect LRM with direct LOS
<span class="nc bnc" id="L2281" title="All 4 branches missed.">            if (isIndirect &amp;&amp; game.getOptions().booleanOption(OptionsConstants.BASE_INDIRECT_FIRE)</span>
<span class="nc bnc" id="L2282" title="All 2 branches missed.">                    &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_INDIRECT_ALWAYS_POSSIBLE)</span>
<span class="nc bnc" id="L2283" title="All 2 branches missed.">                    &amp;&amp; LosEffects.calculateLos(game, ae.getId(), target).canSee()</span>
<span class="nc bnc" id="L2284" title="All 2 branches missed.">                    &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.ADVANCED_DOUBLE_BLIND)</span>
<span class="nc bnc" id="L2285" title="All 6 branches missed.">                            || Compute.canSee(game, ae, target))</span>
                    &amp;&amp; !(wtype instanceof ArtilleryCannonWeapon) &amp;&amp; !(wtype instanceof MekMortarWeapon)) {
<span class="nc" id="L2287">                return Messages.getString(&quot;WeaponAttackAction.NoIndirectWithLOS&quot;);</span>
            }
            
            // Can't fire Indirect LRMs if the option is turned off
<span class="nc bnc" id="L2291" title="All 4 branches missed.">            if (isIndirect &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.BASE_INDIRECT_FIRE)) {</span>
<span class="nc" id="L2292">                return Messages.getString(&quot;WeaponAttackAction.IndirectFireOff&quot;);</span>
            }

            // Can't fire an MML indirectly when loaded with SRM munitions
<span class="nc bnc" id="L2296" title="All 6 branches missed.">            if (isIndirect &amp;&amp; usesAmmo </span>
<span class="nc bnc" id="L2297" title="All 4 branches missed.">                    &amp;&amp; atype != null &amp;&amp; (atype.getAmmoType() == AmmoType.T_MML) &amp;&amp; !atype.hasFlag(AmmoType.F_MML_LRM)) {</span>
<span class="nc" id="L2298">                return Messages.getString(&quot;WeaponAttackAction.NoIndirectSRM&quot;);</span>
            }
            
            // Can't fire anything but Mech Mortars and Artillery Cannons indirectly without a spotter 
            // unless the attack has the Oblique Attacker SPA
<span class="nc bnc" id="L2303" title="All 2 branches missed.">            if (isIndirect) {</span>
<span class="nc bnc" id="L2304" title="All 6 branches missed.">                if ((spotter == null) &amp;&amp; !(wtype instanceof MekMortarWeapon) &amp;&amp; !(wtype instanceof ArtilleryCannonWeapon)</span>
<span class="nc bnc" id="L2305" title="All 2 branches missed.">                        &amp;&amp; !ae.hasAbility(OptionsConstants.GUNNERY_OBLIQUE_ATTACKER)) {</span>
<span class="nc" id="L2306">                    return Messages.getString(&quot;WeaponAttackAction.NoSpotter&quot;);</span>
                }
            }
            
            // Infantry Leg attacks and Swarm attacks
<span class="nc bnc" id="L2311" title="All 4 branches missed.">            if (Infantry.LEG_ATTACK.equals(wtype.getInternalName()) &amp;&amp; te != null) {</span>
<span class="nc" id="L2312">                toHit = Compute.getLegAttackBaseToHit(ae, te, game);</span>

                // Return if the attack is impossible.
<span class="nc bnc" id="L2315" title="All 2 branches missed.">                if (TargetRoll.IMPOSSIBLE == toHit.getValue()) {</span>
<span class="nc" id="L2316">                    return toHit.getDesc();</span>
                }
                // Out of range?
<span class="nc bnc" id="L2319" title="All 2 branches missed.">                if (Compute.effectiveDistance(game, ae, target) &gt; 0) {</span>
<span class="nc" id="L2320">                    return Messages.getString(&quot;WeaponAttackAction.OutOfRange&quot;);</span>
                }
                // Can't combine leg attacks with other attacks
<span class="nc bnc" id="L2323" title="All 2 branches missed.">                if (!WeaponAttackAction.isOnlyAttack(game, ae, Infantry.LEG_ATTACK, te)) {</span>
<span class="nc" id="L2324">                    return Messages.getString(&quot;WeaponAttackAction.LegAttackOnly&quot;);</span>
                }
<span class="nc bnc" id="L2326" title="All 4 branches missed.">            } else if (Infantry.SWARM_MEK.equals(wtype.getInternalName()) &amp;&amp; te != null) {</span>
<span class="nc" id="L2327">                toHit = Compute.getSwarmMekBaseToHit(ae, te, game);</span>

                // Return if the attack is impossible.
<span class="nc bnc" id="L2330" title="All 2 branches missed.">                if (TargetRoll.IMPOSSIBLE == toHit.getValue()) {</span>
<span class="nc" id="L2331">                    return toHit.getDesc();</span>
                }
                // Out of range?
<span class="nc bnc" id="L2334" title="All 2 branches missed.">                if (Compute.effectiveDistance(game, ae, target) &gt; 0) {</span>
<span class="nc" id="L2335">                    return Messages.getString(&quot;WeaponAttackAction.OutOfRange&quot;);</span>
                }
                // Can't combine swarm attacks with other attacks
<span class="nc bnc" id="L2338" title="All 2 branches missed.">                if (!WeaponAttackAction.isOnlyAttack(game, ae, Infantry.SWARM_MEK, te)) {</span>
<span class="nc" id="L2339">                    return Messages.getString(&quot;WeaponAttackAction.SwarmAttackOnly&quot;);</span>
                }
<span class="nc bnc" id="L2341" title="All 2 branches missed.">            } else if (Infantry.STOP_SWARM.equals(wtype.getInternalName())) {</span>
                // Can't stop if we're not swarming, otherwise automatic.
<span class="nc bnc" id="L2343" title="All 2 branches missed.">                if (Entity.NONE == ae.getSwarmTargetId()) {</span>
<span class="nc" id="L2344">                    return Messages.getString(&quot;WeaponAttackAction.NotSwarming&quot;);</span>
                }
<span class="nc bnc" id="L2346" title="All 2 branches missed.">            } else if (Infantry.SWARM_WEAPON_MEK.equals(wtype.getInternalName())) {</span>
                // Can't stop if we're not swarming, otherwise automatic.
<span class="nc bnc" id="L2348" title="All 2 branches missed.">                if (Entity.NONE == ae.getSwarmTargetId()) {</span>
<span class="nc" id="L2349">                    return Messages.getString(&quot;WeaponAttackAction.NotSwarming&quot;);</span>
                }
            } 
            // Swarming infantry always hit their target, but
            // they can only target the Mek they're swarming.
<span class="nc bnc" id="L2354" title="All 4 branches missed.">            if ((te != null) &amp;&amp; (ae.getSwarmTargetId() == te.getId())) {</span>
                // Weapons that do no damage cannot be used in swarm attacks
<span class="nc bnc" id="L2356" title="All 2 branches missed.">                if (wtype.getDamage() == 0) {</span>
<span class="nc" id="L2357">                    return Messages.getString(&quot;WeaponAttackAction.0DamageWeapon&quot;);</span>
                }
                // Missiles and BA body-mounted weapons cannot be used when swarming
<span class="nc bnc" id="L2360" title="All 2 branches missed.">                if (wtype.hasFlag(WeaponType.F_MISSILE)) {</span>
<span class="nc" id="L2361">                    return Messages.getString(&quot;WeaponAttackAction.NoMissileWhenSwarming&quot;);</span>
                }
<span class="nc bnc" id="L2363" title="All 2 branches missed.">                if (weapon.isBodyMounted()) {</span>
<span class="nc" id="L2364">                    return Messages.getString(&quot;WeaponAttackAction.NoBodyWhenSwarming&quot;);</span>
                }
<span class="nc bnc" id="L2366" title="All 2 branches missed.">            } else if (Entity.NONE != ae.getSwarmTargetId()) {</span>
<span class="nc" id="L2367">                return Messages.getString(&quot;WeaponAttackAction.MustTargetSwarmed&quot;);</span>
            }
            
            // MG arrays
            
            // Can't fire one if none of the component MGs are functional
<span class="nc bnc" id="L2373" title="All 4 branches missed.">            if (wtype.hasFlag(WeaponType.F_MGA) &amp;&amp; (weapon.getCurrentShots() == 0)) {</span>
<span class="nc" id="L2374">                return Messages.getString(&quot;WeaponAttackAction.NoWorkingMGs&quot;);</span>
            }
            // Or if the array is off
<span class="nc bnc" id="L2377" title="All 6 branches missed.">            if (wtype.hasFlag(WeaponType.F_MGA) &amp;&amp; wtype.hasModes() &amp;&amp; weapon.curMode().equals(Weapon.MODE_AMS_OFF)) {</span>
<span class="nc" id="L2378">                return Messages.getString(&quot;WeaponAttackAction.MGArrayOff&quot;);</span>
<span class="nc bnc" id="L2379" title="All 2 branches missed.">            } else if (wtype.hasFlag(WeaponType.F_MG)) {</span>
                // and you can't fire an individual MG if it's in an array
<span class="nc bnc" id="L2381" title="All 2 branches missed.">                if (ae.hasLinkedMGA(weapon)) {</span>
<span class="nc" id="L2382">                    return Messages.getString(&quot;WeaponAttackAction.MGPartOfArray&quot;);</span>
                }
            }
            
            // Protomech can fire MGA only into front arc, TW page 137
<span class="nc bnc" id="L2387" title="All 2 branches missed.">            if (!Compute.isInArc(ae.getPosition(), ae.getFacing(), target, Compute.ARC_FORWARD)</span>
<span class="nc bnc" id="L2388" title="All 4 branches missed.">                    &amp;&amp; wtype.hasFlag(WeaponType.F_MGA) &amp;&amp; (ae instanceof Protomech)) {</span>
<span class="nc" id="L2389">                return Messages.getString(&quot;WeaponAttackAction.ProtoMGAOnlyFront&quot;);</span>
            }
            
            // NARC and iNARC
<span class="nc bnc" id="L2393" title="All 4 branches missed.">            if ((wtype.getAmmoType() == AmmoType.T_NARC) || (wtype.getAmmoType() == AmmoType.T_INARC)) {</span>
                // Cannot be used against targets inside buildings
<span class="nc bnc" id="L2395" title="All 2 branches missed.">                if (targetInBuilding) {</span>
<span class="nc" id="L2396">                    return Messages.getString(&quot;WeaponAttackAction.NoNarcInBuilding&quot;);</span>
                }
                // and can't be fired at infantry
<span class="nc bnc" id="L2399" title="All 2 branches missed.">                if (target instanceof Infantry) {</span>
<span class="nc" id="L2400">                    return Messages.getString(&quot;WeaponAttackAction.CantNarcInfantry&quot;);</span>
                }
            }
            
            // PPCs linked to capacitors can't fire while charging
<span class="nc bnc" id="L2405" title="All 4 branches missed.">            if (weapon.getType().hasFlag(WeaponType.F_PPC) &amp;&amp; (weapon.getLinkedBy() != null)</span>
<span class="nc bnc" id="L2406" title="All 2 branches missed.">                    &amp;&amp; weapon.getLinkedBy().getType().hasFlag(MiscType.F_PPC_CAPACITOR)</span>
<span class="nc bnc" id="L2407" title="All 2 branches missed.">                    &amp;&amp; weapon.getLinkedBy().pendingMode().equals(Weapon.MODE_PPC_CHARGE)) {</span>
<span class="nc" id="L2408">                return Messages.getString(&quot;WeaponAttackAction.PPCCharging&quot;);</span>
            }
            
            // Some weapons can only be fired by themselves
            
            // Check to see if another solo weapon was fired
<span class="nc" id="L2414">            boolean hasSoloAttack = false;</span>
<span class="nc" id="L2415">            String soloWeaponName = &quot;&quot;;</span>
<span class="nc bnc" id="L2416" title="All 2 branches missed.">            for (EntityAction ea : game.getActionsVector()) {</span>
<span class="nc bnc" id="L2417" title="All 4 branches missed.">                if ((ea.getEntityId() == attackerId) &amp;&amp; (ea instanceof WeaponAttackAction)) {</span>
<span class="nc" id="L2418">                    WeaponAttackAction otherWAA = (WeaponAttackAction) ea;</span>
<span class="nc" id="L2419">                    final Mounted otherWeapon = ae.getEquipment(otherWAA.getWeaponId());</span>

<span class="nc bnc" id="L2421" title="All 2 branches missed.">                    if (!(otherWeapon.getType() instanceof WeaponType)) {</span>
<span class="nc" id="L2422">                        continue;</span>
                    }
<span class="nc" id="L2424">                    final WeaponType otherWtype = (WeaponType) otherWeapon.getType();</span>
<span class="nc bnc" id="L2425" title="All 4 branches missed.">                    hasSoloAttack |= (otherWtype.hasFlag(WeaponType.F_SOLO_ATTACK) &amp;&amp; otherWAA.getWeaponId() != weaponId);</span>
<span class="nc bnc" id="L2426" title="All 2 branches missed.">                    if (hasSoloAttack) {</span>
<span class="nc" id="L2427">                        soloWeaponName = otherWeapon.getName();</span>
<span class="nc" id="L2428">                        break;</span>
                    }
                }
<span class="nc" id="L2431">            }</span>
<span class="nc bnc" id="L2432" title="All 2 branches missed.">            if (hasSoloAttack) {</span>
<span class="nc" id="L2433">                return String.format(Messages.getString(&quot;WeaponAttackAction.CantFireWithOtherWeapons&quot;), soloWeaponName);</span>
            }
            
            // Handle solo attack weapons.
<span class="nc bnc" id="L2437" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_SOLO_ATTACK)) {</span>
<span class="nc bnc" id="L2438" title="All 2 branches missed.">                for (EntityAction ea : game.getActionsVector()) {</span>
<span class="nc bnc" id="L2439" title="All 2 branches missed.">                    if (!(ea instanceof WeaponAttackAction)) {</span>
<span class="nc" id="L2440">                        continue;</span>
                    }
<span class="nc" id="L2442">                    WeaponAttackAction prevAttack = (WeaponAttackAction) ea;</span>
<span class="nc bnc" id="L2443" title="All 2 branches missed.">                    if (prevAttack.getEntityId() == attackerId) {</span>
                        // If the attacker fires another weapon, this attack fails.
<span class="nc bnc" id="L2445" title="All 2 branches missed.">                        if (weaponId != prevAttack.getWeaponId()) {</span>
<span class="nc" id="L2446">                            return Messages.getString(&quot;WeaponAttackAction.CantMixAttacks&quot;);</span>
                        }
                    }
<span class="nc" id="L2449">                }</span>
            }

            // Protomechs cannot fire arm weapons and main gun in the same turn
<span class="nc bnc" id="L2453" title="All 2 branches missed.">            if ((ae instanceof Protomech)</span>
<span class="nc bnc" id="L2454" title="All 2 branches missed.">                    &amp;&amp; ((weapon.getLocation() == Protomech.LOC_MAINGUN)</span>
<span class="nc bnc" id="L2455" title="All 2 branches missed.">                    || (weapon.getLocation() == Protomech.LOC_RARM)</span>
<span class="nc bnc" id="L2456" title="All 2 branches missed.">                    || (weapon.getLocation() == Protomech.LOC_LARM))) {</span>
<span class="nc bnc" id="L2457" title="All 2 branches missed.">                final boolean firingMainGun = weapon.getLocation() == Protomech.LOC_MAINGUN;</span>
<span class="nc bnc" id="L2458" title="All 2 branches missed.">                for (EntityAction ea : game.getActionsVector()) {</span>
<span class="nc bnc" id="L2459" title="All 4 branches missed.">                    if ((ea.getEntityId() == attackerId) &amp;&amp; (ea instanceof WeaponAttackAction)) {</span>
<span class="nc" id="L2460">                        WeaponAttackAction otherWAA = (WeaponAttackAction) ea;</span>
<span class="nc" id="L2461">                        final Mounted otherWeapon = ae.getEquipment(otherWAA.getWeaponId());</span>
<span class="nc bnc" id="L2462" title="All 4 branches missed.">                        if ((firingMainGun &amp;&amp; ((otherWeapon.getLocation() == Protomech.LOC_RARM)</span>
<span class="nc bnc" id="L2463" title="All 4 branches missed.">                                || (otherWeapon.getLocation() == Protomech.LOC_LARM)))</span>
<span class="nc bnc" id="L2464" title="All 2 branches missed.">                                || !firingMainGun &amp;&amp; (otherWeapon.getLocation() == Protomech.LOC_MAINGUN)) {</span>
<span class="nc" id="L2465">                            return Messages.getString(&quot;WeaponAttackAction.CantFireArmsAndMainGun&quot;);</span>
                        }
                    }
<span class="nc" id="L2468">                }</span>
            }

            // TAG
            
            // The TAG system cannot target Airborne Aeros.
<span class="nc bnc" id="L2474" title="All 8 branches missed.">            if (isTAG &amp;&amp; (te != null) &amp;&amp; (te.isAirborne() || te.isSpaceborne())) {</span>
<span class="nc" id="L2475">                return Messages.getString(&quot;WeaponAttackAction.CantTAGAero&quot;);</span>
            }
            
            // The TAG system cannot target infantry.
<span class="nc bnc" id="L2479" title="All 6 branches missed.">            if (isTAG &amp;&amp; (te != null) &amp;&amp; (te instanceof Infantry)) {</span>
<span class="nc" id="L2480">                return Messages.getString(&quot;WeaponAttackAction.CantTAGInf&quot;);</span>
            }
            
            // TSEMPs
            
            // Can't fire a one-shot TSEMP more than once
<span class="nc bnc" id="L2486" title="All 6 branches missed.">            if (wtype.hasFlag(WeaponType.F_TSEMP) &amp;&amp; wtype.hasFlag(WeaponType.F_ONESHOT) &amp;&amp; weapon.isFired()) {</span>
<span class="nc" id="L2487">                return Messages.getString(&quot;WeaponAttackAction.OneShotTSEMP&quot;);</span>
            }

            // Can't fire a regular TSEMP while it is recharging
<span class="nc bnc" id="L2491" title="All 4 branches missed.">            if (wtype.hasFlag(WeaponType.F_TSEMP) &amp;&amp; weapon.isFired()) {</span>
<span class="nc" id="L2492">                return Messages.getString(&quot;WeaponAttackAction.TSEMPRecharging&quot;);</span>
            }
            
            // Weapon Bays
            
            // Large Craft weapon bays cannot bracket small craft at short range
<span class="nc bnc" id="L2498" title="All 2 branches missed.">            if (wtype.hasModes()</span>
<span class="nc bnc" id="L2499" title="All 4 branches missed.">                    &amp;&amp; (weapon.curMode().equals(Weapon.MODE_CAPITAL_BRACKET_80) || weapon.curMode().equals(Weapon.MODE_CAPITAL_BRACKET_60)</span>
<span class="nc bnc" id="L2500" title="All 2 branches missed.">                            || weapon.curMode().equals(Weapon.MODE_CAPITAL_BRACKET_40))</span>
<span class="nc bnc" id="L2501" title="All 6 branches missed.">                    &amp;&amp; target.isAero() &amp;&amp; te!= null &amp;&amp; !te.isLargeCraft()</span>
<span class="nc bnc" id="L2502" title="All 2 branches missed.">                    &amp;&amp; (RangeType.rangeBracket(ae.getPosition().distance(target.getPosition()), wtype.getRanges(weapon),</span>
                            true, false) == RangeType.RANGE_SHORT)) {
<span class="nc" id="L2504">                return Messages.getString(&quot;WeaponAttackAction.TooCloseForSCBracket&quot;);</span>
            }
            
            // you must have enough weapons in your bay to be able to use bracketing
<span class="nc bnc" id="L2508" title="All 6 branches missed.">            if (wtype.hasModes() &amp;&amp; weapon.curMode().equals(Weapon.MODE_CAPITAL_BRACKET_80) &amp;&amp; (weapon.getBayWeapons().size() &lt; 2)) {</span>
<span class="nc" id="L2509">                return Messages.getString(&quot;WeaponAttackAction.BayTooSmallForBracket&quot;);</span>
            }
<span class="nc bnc" id="L2511" title="All 6 branches missed.">            if (wtype.hasModes() &amp;&amp; weapon.curMode().equals(Weapon.MODE_CAPITAL_BRACKET_60) &amp;&amp; (weapon.getBayWeapons().size() &lt; 3)) {</span>
<span class="nc" id="L2512">                return Messages.getString(&quot;WeaponAttackAction.BayTooSmallForBracket&quot;);</span>
            }
<span class="nc bnc" id="L2514" title="All 6 branches missed.">            if (wtype.hasModes() &amp;&amp; weapon.curMode().equals(Weapon.MODE_CAPITAL_BRACKET_40) &amp;&amp; (weapon.getBayWeapons().size() &lt; 4)) {</span>
<span class="nc" id="L2515">                return Messages.getString(&quot;WeaponAttackAction.BayTooSmallForBracket&quot;);</span>
            }
            
            // If you're an aero, can't fire an AMS Bay at all or a Point Defense bay that's in PD Mode
<span class="nc bnc" id="L2519" title="All 2 branches missed.">            if (wtype.hasFlag(WeaponType.F_AMSBAY)) {</span>
<span class="nc" id="L2520">                return Messages.getString(&quot;WeaponAttackAction.AutoWeapon&quot;);</span>
<span class="nc bnc" id="L2521" title="All 4 branches missed.">            } else if (wtype.hasModes() &amp;&amp; weapon.curMode().equals(Weapon.MODE_POINT_DEFENSE)) {</span>
<span class="nc" id="L2522">                return Messages.getString(&quot;WeaponAttackAction.PDWeapon&quot;);</span>
            }
            
            // Weapon in arc?
<span class="nc bnc" id="L2526" title="All 2 branches missed.">            if (!Compute.isInArc(game, attackerId, weaponId, target)</span>
<span class="nc bnc" id="L2527" title="All 4 branches missed.">                    &amp;&amp; (!Compute.isAirToGround(ae, target) || isArtilleryIndirect)</span>
<span class="nc bnc" id="L2528" title="All 2 branches missed.">                    &amp;&amp; !ae.isMakingVTOLGroundAttack()</span>
<span class="nc bnc" id="L2529" title="All 2 branches missed.">                    &amp;&amp; !ae.isOffBoard()) {</span>
<span class="nc" id="L2530">                return Messages.getString(&quot;WeaponAttackAction.OutOfArc&quot;);</span>
            }
            
            // Weapon operational?
<span class="nc bnc" id="L2534" title="All 2 branches missed.">            if (!weapon.canFire(isStrafing)) {</span>
<span class="nc" id="L2535">                return Messages.getString(&quot;WeaponAttackAction.WeaponNotReady&quot;);</span>
            }
        }

        // If we get here, the shot is possible
<span class="nc" id="L2540">        return null;</span>
    }
    
    /**
     * Method that tests each attack to see if it would automatically hit.
     * If so, a reason string will be returned. A null return means we can continue
     * processing the attack
     * 
     * @param game The current game
     * @param ae The Entity making this attack
     * @param target The Targetable object being attacked
     * @param ttype  The targetable object type
     * @param los The calculated LOS between attacker and target
     * 
     * @param distance  The distance in hexes from attacker to target
     * 
     * @param wtype The WeaponType of the weapon being used
     * @param weapon The Mounted weapon being used
     * 
     * @param isBearingsOnlyMissile  flag that indicates whether this is a bearings-only capital missile attack
     */
    private static String toHitIsAutomatic(IGame game, Entity ae, Targetable target, int ttype, LosEffects los,
            int distance, WeaponType wtype, Mounted weapon, boolean isBearingsOnlyMissile) {
        
        // Buildings
        
        // Attacks against adjacent buildings automatically hit.
<span class="nc bnc" id="L2567" title="All 12 branches missed.">        if ((distance == 1) &amp;&amp; ((ttype == Targetable.TYPE_BUILDING)</span>
                || (ttype == Targetable.TYPE_BLDG_IGNITE)
                || (ttype == Targetable.TYPE_FUEL_TANK)
                || (ttype == Targetable.TYPE_FUEL_TANK_IGNITE)
                || (target instanceof GunEmplacement))) {
<span class="nc" id="L2572">            return Messages.getString(&quot;WeaponAttackAction.AdjBuilding&quot;);</span>
        }

        // Attacks against buildings from inside automatically hit.
<span class="nc bnc" id="L2576" title="All 12 branches missed.">        if ((null != los.getThruBldg()) &amp;&amp; ((ttype == Targetable.TYPE_BUILDING)</span>
                || (ttype == Targetable.TYPE_BLDG_IGNITE)
                || (ttype == Targetable.TYPE_FUEL_TANK)
                || (ttype == Targetable.TYPE_FUEL_TANK_IGNITE)
                || (target instanceof GunEmplacement))) {
<span class="nc" id="L2581">            return Messages.getString(&quot;WeaponAttackAction.InsideBuilding&quot;);</span>
        }
        
        // Special Weapon Rules
        
        // B-Pod firing at infantry in the same hex autohit
<span class="nc bnc" id="L2587" title="All 6 branches missed.">        if (wtype != null &amp;&amp; wtype.hasFlag(WeaponType.F_B_POD) &amp;&amp; (target instanceof Infantry)</span>
<span class="nc bnc" id="L2588" title="All 2 branches missed.">                &amp;&amp; target.getPosition().equals(ae.getPosition())) {</span>
<span class="nc" id="L2589">            return Messages.getString(&quot;WeaponAttackAction.BPodAtInf&quot;);</span>
        }
        
        // Capital Missiles in bearings-only mode target hexes and always hit them
<span class="nc bnc" id="L2593" title="All 2 branches missed.">        if (isBearingsOnlyMissile) {</span>
<span class="nc bnc" id="L2594" title="All 4 branches missed.">            if (game.getPhase() == IGame.Phase.PHASE_TARGETING &amp;&amp; distance &gt;= RangeType.RANGE_BEARINGS_ONLY_MINIMUM) {</span>
<span class="nc" id="L2595">                return Messages.getString(&quot;WeaponAttackAction.BoMissileHex&quot;);</span>
            }
        }
        
        // Screen launchers target hexes and hit automatically (if in range)
<span class="nc bnc" id="L2600" title="All 6 branches missed.">        if (wtype != null &amp;&amp; ((wtype.getAmmoType() == AmmoType.T_SCREEN_LAUNCHER)</span>
<span class="nc bnc" id="L2601" title="All 2 branches missed.">                || (wtype instanceof ScreenLauncherBayWeapon)) &amp;&amp; distance &lt;= wtype.getExtremeRange()) {</span>
<span class="nc" id="L2602">            return Messages.getString(&quot;WeaponAttackAction.ScreenAutoHit&quot;);</span>
        }
        
        // Vehicular grenade launchers
<span class="nc bnc" id="L2606" title="All 4 branches missed.">        if (weapon != null &amp;&amp; weapon.getType().hasFlag(WeaponType.F_VGL)) {</span>
<span class="nc" id="L2607">            int facing = weapon.getFacing();</span>
<span class="nc bnc" id="L2608" title="All 2 branches missed.">            if (ae.isSecondaryArcWeapon(ae.getEquipmentNum(weapon))) {</span>
<span class="nc" id="L2609">                facing = (facing + ae.getSecondaryFacing()) % 6;</span>
            }
<span class="nc" id="L2611">            Coords c = ae.getPosition().translated(facing);</span>
<span class="nc bnc" id="L2612" title="All 4 branches missed.">            if ((target instanceof HexTarget) &amp;&amp; target.getPosition().equals(c)) {</span>
<span class="nc" id="L2613">                return Messages.getString(&quot;WeaponAttackAction.Vgl&quot;);</span>
            }
        }
        
        // If we get here, the shot isn't an auto-hit
<span class="nc" id="L2618">        return null;</span>
    }

    /**
     * Some attacks are the only actions that a particular entity can make
     * during its turn Also, only this unit can make that particular attack.
     */
    private static boolean isOnlyAttack(IGame game, Entity attacker, String attackType, Entity target) {
        // mechs can only be the target of one leg or swarm attack
<span class="nc bnc" id="L2627" title="All 2 branches missed.">        for (Enumeration&lt;EntityAction&gt; actions = game.getActions(); actions.hasMoreElements();) {</span>
<span class="nc" id="L2628">            EntityAction ea = actions.nextElement();</span>
<span class="nc bnc" id="L2629" title="All 2 branches missed.">            if (ea instanceof WeaponAttackAction) {</span>
<span class="nc" id="L2630">                WeaponAttackAction waa = (WeaponAttackAction) ea;</span>
<span class="nc" id="L2631">                Entity waaAE = waa.getEntity(game);</span>
<span class="nc bnc" id="L2632" title="All 2 branches missed.">                if (waaAE == null) {</span>
<span class="nc" id="L2633">                    continue;</span>
                }
<span class="nc bnc" id="L2635" title="All 2 branches missed.">                if (waaAE.equals(attacker)) {</span>
                    // If there is an attack by this unit that is not the attack
                    // type, fail.
<span class="nc bnc" id="L2638" title="All 2 branches missed.">                    if (!waaAE.getEquipment(waa.getWeaponId()).getType().getInternalName().equals(attackType)) {</span>
<span class="nc" id="L2639">                        return false;</span>
                    }
                }
<span class="nc" id="L2642">                Targetable waaTarget = waa.getTarget(game);</span>
<span class="nc" id="L2643">                EquipmentType weapType = waaAE.getEquipment(waa.getWeaponId()).getType();</span>
<span class="nc bnc" id="L2644" title="All 6 branches missed.">                if (weapType.getInternalName().equals(attackType) &amp;&amp; (waaTarget != null) &amp;&amp; waaTarget.equals(target)) {</span>
<span class="nc bnc" id="L2645" title="All 2 branches missed.">                    if (!waaAE.equals(attacker)) {</span>
                        // If there is an attack by another unit that has this
                        // attack type against the same target, fail.
<span class="nc" id="L2648">                        return false;</span>
                    }
                }
            }
<span class="nc" id="L2652">        }</span>
<span class="nc" id="L2653">        return true;</span>
    }

    /**
     * @return Returns the nemesisConfused.
     */
    public boolean isNemesisConfused() {
<span class="nc" id="L2660">        return nemesisConfused;</span>
    }

    /**
     * @param nemesisConfused
     *            The nemesisConfused to set.
     */
    public void setNemesisConfused(boolean nemesisConfused) {
<span class="nc" id="L2668">        this.nemesisConfused = nemesisConfused;</span>
<span class="nc" id="L2669">    }</span>

    public boolean isSwarmingMissiles() {
<span class="nc" id="L2672">        return swarmingMissiles;</span>
    }

    public void setSwarmingMissiles(boolean swarmingMissiles) {
<span class="nc" id="L2676">        this.swarmingMissiles = swarmingMissiles;</span>
<span class="nc" id="L2677">    }</span>

    public void setOldTargetId(int id) {
<span class="nc" id="L2680">        oldTargetId = id;</span>
<span class="nc" id="L2681">    }</span>

    public int getOldTargetId() {
<span class="nc" id="L2684">        return oldTargetId;</span>
    }

    public void setOldTargetType(int t) {
<span class="nc" id="L2688">        oldTargetType = t;</span>
<span class="nc" id="L2689">    }</span>

    public int getOldTargetType() {
<span class="nc" id="L2692">        return oldTargetType;</span>
    }

    public void setOriginalTargetId(int id) {
<span class="nc" id="L2696">        originalTargetId = id;</span>
<span class="nc" id="L2697">    }</span>

    public int getOriginalTargetId() {
<span class="nc" id="L2700">        return originalTargetId;</span>
    }

    public void setOriginalTargetType(int t) {
<span class="nc" id="L2704">        originalTargetType = t;</span>
<span class="nc" id="L2705">    }</span>

    public int getOriginalTargetType() {
<span class="nc" id="L2708">        return originalTargetType;</span>
    }

    public int getSwarmMissiles() {
<span class="nc" id="L2712">        return swarmMissiles;</span>
    }

    public void setSwarmMissiles(int swarmMissiles) {
<span class="nc" id="L2716">        this.swarmMissiles = swarmMissiles;</span>
<span class="nc" id="L2717">    }</span>

    public int[] getBombPayload() {
<span class="nc" id="L2720">        return bombPayload;</span>
    }

    /**
     * 
     * @param load This is the &quot;bomb payload&quot;. It's an array indexed by the constants declared in BombType.
     * Each element indicates how many types of that bomb should be fired.
     */
    public void setBombPayload(int[] load) {
<span class="nc" id="L2729">        bombPayload = load;</span>
<span class="nc" id="L2730">    }</span>

    public boolean isStrafing() {
<span class="nc" id="L2733">        return isStrafing;</span>
    }

    public void setStrafing(boolean isStrafing) {
<span class="nc" id="L2737">        this.isStrafing = isStrafing;</span>
<span class="nc" id="L2738">    }</span>

    public boolean isStrafingFirstShot() {
<span class="nc" id="L2741">        return isStrafingFirstShot;</span>
    }

    public void setStrafingFirstShot(boolean isStrafingFirstShot) {
<span class="nc" id="L2745">        this.isStrafingFirstShot = isStrafingFirstShot;</span>
<span class="nc" id="L2746">    }</span>

    public boolean isPointblankShot() {
<span class="nc" id="L2749">        return isPointblankShot;</span>
    }

    public void setPointblankShot(boolean isPointblankShot) {
<span class="nc" id="L2753">        this.isPointblankShot = isPointblankShot;</span>
<span class="nc" id="L2754">    }</span>

    public boolean isHomingShot() {
<span class="nc" id="L2757">        return isHomingShot;</span>
    }

    public void setHomingShot(boolean isHomingShot) {
<span class="nc" id="L2761">        this.isHomingShot = isHomingShot;</span>
<span class="nc" id="L2762">    }</span>
    
    /**
     * Needed by teleoperated missiles
     * @param velocity - an integer representing initial velocity
     */
    public void setLaunchVelocity(int velocity) {
<span class="nc" id="L2769">        this.launchVelocity = velocity;</span>
<span class="nc" id="L2770">    }</span>
    
    //This is a stub. ArtilleryAttackActions actually need to use it
    public void updateTurnsTilHit(IGame game) {        
<span class="nc" id="L2774">    }</span>
    
    /**
     * Convenience method that compiles the ToHit modifiers applicable to the weather or other special environmental
     * effects. These affect everyone on the board.
     * @param game  The current game
     * @param ae    The attacking entity
     * @param target The Targetable object being attacked
     * 
     * @param wtype The WeaponType of the weapon being used
     * @param atype The AmmoType being used for this attack
     * 
     * @param toHit The running total ToHitData for this WeaponAttackAction
     * 
     * @param isArtilleryIndirect  flag that indicates whether this is an indirect-fire artillery attack
     */
    private static ToHitData compileEnvironmentalToHitMods(IGame game, Entity ae, Targetable target, WeaponType wtype, 
                AmmoType atype, ToHitData toHit, boolean isArtilleryIndirect) {
        
<span class="nc bnc" id="L2793" title="All 2 branches missed.">        if (toHit == null) {</span>
            // Without valid toHit data, the rest of this will fail
<span class="nc" id="L2795">            toHit = new ToHitData();</span>
        }
        
        // Night combat modifiers
<span class="nc bnc" id="L2799" title="All 2 branches missed.">        if (!isArtilleryIndirect) {</span>
<span class="nc" id="L2800">            toHit.append(AbstractAttackAction.nightModifiers(game, target, atype, ae, true));</span>
        }

<span class="nc" id="L2803">        TargetRoll weatherToHitMods = new TargetRoll();</span>

        // weather mods (not in space)
<span class="nc" id="L2806">        int weatherMod = game.getPlanetaryConditions().getWeatherHitPenalty(ae);</span>
<span class="nc bnc" id="L2807" title="All 4 branches missed.">        if ((weatherMod != 0) &amp;&amp; !game.getBoard().inSpace()) {</span>
<span class="nc" id="L2808">            weatherToHitMods.addModifier(weatherMod, game.getPlanetaryConditions().getWeatherDisplayableName());</span>
        }

        // wind mods (not in space)
<span class="nc bnc" id="L2812" title="All 2 branches missed.">        if (!game.getBoard().inSpace()) {</span>
<span class="nc" id="L2813">            int windCond = game.getPlanetaryConditions().getWindStrength();</span>
<span class="nc bnc" id="L2814" title="All 2 branches missed.">            if (windCond == PlanetaryConditions.WI_MOD_GALE) {</span>
<span class="nc bnc" id="L2815" title="All 4 branches missed.">                if (wtype != null &amp;&amp; wtype.hasFlag(WeaponType.F_MISSILE)) {</span>
<span class="nc" id="L2816">                    weatherToHitMods.addModifier(1, PlanetaryConditions.getWindDisplayableName(windCond));</span>
                }
<span class="nc bnc" id="L2818" title="All 2 branches missed.">            } else if (windCond == PlanetaryConditions.WI_STRONG_GALE) {</span>
<span class="nc bnc" id="L2819" title="All 4 branches missed.">                if (wtype != null &amp;&amp; wtype.hasFlag(WeaponType.F_BALLISTIC)) {</span>
<span class="nc" id="L2820">                    weatherToHitMods.addModifier(1, PlanetaryConditions.getWindDisplayableName(windCond));</span>
<span class="nc bnc" id="L2821" title="All 4 branches missed.">                } else if (wtype != null &amp;&amp; wtype.hasFlag(WeaponType.F_MISSILE)) {</span>
<span class="nc" id="L2822">                    weatherToHitMods.addModifier(2, PlanetaryConditions.getWindDisplayableName(windCond));</span>
                }
<span class="nc bnc" id="L2824" title="All 2 branches missed.">            } else if (windCond == PlanetaryConditions.WI_STORM) {</span>
<span class="nc bnc" id="L2825" title="All 4 branches missed.">                if (wtype != null &amp;&amp; wtype.hasFlag(WeaponType.F_BALLISTIC)) {</span>
<span class="nc" id="L2826">                    weatherToHitMods.addModifier(2, PlanetaryConditions.getWindDisplayableName(windCond));</span>
<span class="nc bnc" id="L2827" title="All 4 branches missed.">                } else if (wtype != null &amp;&amp; wtype.hasFlag(WeaponType.F_MISSILE)) {</span>
<span class="nc" id="L2828">                    weatherToHitMods.addModifier(3, PlanetaryConditions.getWindDisplayableName(windCond));</span>
                }
<span class="nc bnc" id="L2830" title="All 2 branches missed.">            } else if (windCond == PlanetaryConditions.WI_TORNADO_F13) {</span>
<span class="nc bnc" id="L2831" title="All 4 branches missed.">                if (wtype != null &amp;&amp; wtype.hasFlag(WeaponType.F_ENERGY)) {</span>
<span class="nc" id="L2832">                    weatherToHitMods.addModifier(2, PlanetaryConditions.getWindDisplayableName(windCond));</span>
                } else {
<span class="nc" id="L2834">                    weatherToHitMods.addModifier(3, PlanetaryConditions.getWindDisplayableName(windCond));</span>
                }
<span class="nc bnc" id="L2836" title="All 2 branches missed.">            } else if (windCond == PlanetaryConditions.WI_TORNADO_F4) {</span>
<span class="nc" id="L2837">                weatherToHitMods.addModifier(3, PlanetaryConditions.getWindDisplayableName(windCond));</span>
            }
        }

        // fog mods (not in space)
<span class="nc bnc" id="L2842" title="All 6 branches missed.">        if (wtype != null &amp;&amp; wtype.hasFlag(WeaponType.F_ENERGY) &amp;&amp; !game.getBoard().inSpace()</span>
<span class="nc bnc" id="L2843" title="All 2 branches missed.">                &amp;&amp; (game.getPlanetaryConditions().getFog() == PlanetaryConditions.FOG_HEAVY)) {</span>
<span class="nc" id="L2844">            weatherToHitMods.addModifier(1, Messages.getString(&quot;WeaponAttackAction.HeavyFog&quot;));</span>
        }

        // blowing sand mods
<span class="nc bnc" id="L2848" title="All 6 branches missed.">        if (wtype != null &amp;&amp; wtype.hasFlag(WeaponType.F_ENERGY) &amp;&amp; !game.getBoard().inSpace()</span>
<span class="nc bnc" id="L2849" title="All 2 branches missed.">                &amp;&amp; game.getPlanetaryConditions().isSandBlowing()</span>
<span class="nc bnc" id="L2850" title="All 2 branches missed.">                &amp;&amp; (game.getPlanetaryConditions().getWindStrength() &gt; PlanetaryConditions.WI_LIGHT_GALE)) {</span>
<span class="nc" id="L2851">            weatherToHitMods.addModifier(1, Messages.getString(&quot;WeaponAttackAction.BlowingSand&quot;));</span>
        }

<span class="nc bnc" id="L2854" title="All 2 branches missed.">        if (weatherToHitMods.getValue() &gt; 0) {</span>
<span class="nc bnc" id="L2855" title="All 4 branches missed.">            if ((ae.getCrew() != null) &amp;&amp; ae.hasAbility(OptionsConstants.UNOFF_WEATHERED)) {</span>
<span class="nc" id="L2856">                weatherToHitMods.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.Weathered&quot;));</span>
            }
<span class="nc" id="L2858">            toHit.append(weatherToHitMods);</span>
        }

        // gravity mods (not in space)
<span class="nc bnc" id="L2862" title="All 2 branches missed.">        if (!game.getBoard().inSpace()) {</span>
<span class="nc" id="L2863">            int mod = (int) Math.floor(Math.abs((game.getPlanetaryConditions().getGravity() - 1.0f) / 0.2f));</span>
<span class="nc bnc" id="L2864" title="All 4 branches missed.">            if ((mod != 0) &amp;&amp; wtype != null &amp;&amp; </span>
<span class="nc bnc" id="L2865" title="All 4 branches missed.">                    (wtype.hasFlag(WeaponType.F_BALLISTIC) || wtype.hasFlag(WeaponType.F_MISSILE))) {</span>
<span class="nc" id="L2866">                toHit.addModifier(mod, Messages.getString(&quot;WeaponAttackAction.Gravity&quot;));</span>
            }
        }

        // Electro-Magnetic Interference
<span class="nc bnc" id="L2871" title="All 6 branches missed.">        if (game.getPlanetaryConditions().hasEMI() &amp;&amp; !((ae instanceof Infantry) &amp;&amp; !(ae instanceof BattleArmor))) {</span>
<span class="nc" id="L2872">            toHit.addModifier(2, Messages.getString(&quot;WeaponAttackAction.EMI&quot;));</span>
        }
<span class="nc" id="L2874">        return toHit;</span>
    }
    
    /**
     * Convenience method that compiles the ToHit modifiers applicable to the weapon being fired
     * Got a heavy large laser that gets a +1 TH penalty?  You'll find that here.
     * Bonuses related to the attacker's condition?  Ammunition being used?  Those are in other methods.
     * 
     * @param game The current game
     * @param ae    The attacking entity
     * @param spotter   The spotting entity, if using indirect fire
     * @param target The Targetable object being attacked
     * @param ttype  The Targetable object type
     * @param toHit The running total ToHitData for this WeaponAttackAction
     * 
     * @param wtype The WeaponType of the weapon being used
     * @param weapon The Mounted weapon being used for this attack
     * @param atype The AmmoType being used for this attack
     * @param munition  Long indicating the munition type flag being used, if applicable
     * 
     * @param isFlakAttack  flag that indicates whether the attacker is using Flak against an airborne target
     * @param isIndirect  flag that indicates whether this is an indirect attack (LRM, mortar...)
     * @param narcSpotter  flag that indicates whether this spotting entity is using NARC equipment
     */
    private static ToHitData compileWeaponToHitMods(IGame game, Entity ae, Entity spotter, Targetable target,
                int ttype, ToHitData toHit, WeaponType wtype, Mounted weapon, AmmoType atype, long munition, 
                boolean isFlakAttack, boolean isIndirect, boolean narcSpotter) {
<span class="nc bnc" id="L2901" title="All 6 branches missed.">        if (ae == null || wtype == null || weapon == null) {</span>
            // Can't calculate weapon mods without a valid weapon and an attacker to fire it
<span class="nc" id="L2903">            return toHit;</span>
        }
        
<span class="nc bnc" id="L2906" title="All 2 branches missed.">        if (toHit == null) {</span>
            // Without valid toHit data, the rest of this will fail
<span class="nc" id="L2908">            toHit = new ToHitData();</span>
        }
        
<span class="nc" id="L2911">        Entity te = null;</span>
<span class="nc bnc" id="L2912" title="All 2 branches missed.">        if (ttype == Targetable.TYPE_ENTITY) {</span>
            //Some of these weapons only target valid entities
<span class="nc" id="L2914">            te = (Entity) target;</span>
        }
        
        // +4 for trying to fire ASEW or antiship missile at a target of &lt; 500 tons
<span class="nc bnc" id="L2918" title="All 6 branches missed.">        if ((wtype.hasFlag(WeaponType.F_ANTI_SHIP) || wtype.getAmmoType() == AmmoType.T_ASEW_MISSILE)</span>
<span class="nc bnc" id="L2919" title="All 2 branches missed.">                &amp;&amp; (te != null) &amp;&amp; (te.getWeight() &lt; 500)) {</span>
<span class="nc" id="L2920">            toHit.addModifier(4, Messages.getString(&quot;WeaponAttackAction.TeTooSmallForASM&quot;));</span>
        }
        
        // AAA mode makes targeting large craft more difficult
<span class="nc bnc" id="L2924" title="All 8 branches missed.">        if (wtype.hasModes() &amp;&amp; weapon.curMode().equals(Weapon.MODE_CAP_LASER_AAA) &amp;&amp; te != null &amp;&amp; te.isLargeCraft()) {</span>
<span class="nc" id="L2925">            toHit.addModifier(+1, Messages.getString(&quot;WeaponAttackAction.AAALaserAtShip&quot;));</span>
        }
        
        // Bombast Lasers
<span class="nc bnc" id="L2929" title="All 2 branches missed.">        if (wtype instanceof ISBombastLaser) {</span>
<span class="nc" id="L2930">            double damage = Compute.dialDownDamage(weapon, wtype);</span>
<span class="nc" id="L2931">            damage = Math.ceil((damage - 7) / 2);</span>

<span class="nc bnc" id="L2933" title="All 2 branches missed.">            if (damage &gt; 0) {</span>
<span class="nc" id="L2934">                toHit.addModifier((int) damage, Messages.getString(&quot;WeaponAttackAction.WeaponMod&quot;));</span>
            }
        }

        // Bracketing modes
<span class="nc bnc" id="L2939" title="All 4 branches missed.">        if (wtype.hasModes() &amp;&amp; weapon.curMode().equals(Weapon.MODE_CAPITAL_BRACKET_80)) {</span>
<span class="nc" id="L2940">            toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.Bracket80&quot;));</span>
        }
<span class="nc bnc" id="L2942" title="All 4 branches missed.">        if (wtype.hasModes() &amp;&amp; weapon.curMode().equals(Weapon.MODE_CAPITAL_BRACKET_60)) {</span>
<span class="nc" id="L2943">            toHit.addModifier(-2, Messages.getString(&quot;WeaponAttackAction.Bracket60&quot;));</span>
        }
<span class="nc bnc" id="L2945" title="All 4 branches missed.">        if (wtype.hasModes() &amp;&amp; weapon.curMode().equals(Weapon.MODE_CAPITAL_BRACKET_40)) {</span>
<span class="nc" id="L2946">            toHit.addModifier(-3, Messages.getString(&quot;WeaponAttackAction.Bracket40&quot;));</span>
        }
        
        // Capital ship mass driver penalty. YOU try hitting a maneuvering target with a spinal-mount weapon!
<span class="nc bnc" id="L2950" title="All 2 branches missed.">        if (wtype.hasFlag(WeaponType.F_MASS_DRIVER)) {</span>
<span class="nc" id="L2951">            toHit.addModifier(2, Messages.getString(&quot;WeaponAttackAction.MassDriver&quot;));</span>
        }
        
        // Capital missiles in waypoint launch mode
<span class="nc bnc" id="L2955" title="All 2 branches missed.">        if (weapon.isInWaypointLaunchMode()) {</span>
<span class="nc" id="L2956">            toHit.addModifier(1, Messages.getString(&quot;WeaponAttackAction.WaypointLaunch&quot;));</span>
        }
        
        // Capital weapon (except missiles) penalties at small targets
<span class="nc bnc" id="L2960" title="All 4 branches missed.">        if (wtype.isCapital() &amp;&amp; (wtype.getAtClass() != WeaponType.CLASS_CAPITAL_MISSILE)</span>
<span class="nc bnc" id="L2961" title="All 6 branches missed.">                &amp;&amp; (wtype.getAtClass() != WeaponType.CLASS_AR10) &amp;&amp; te != null &amp;&amp; !te.isLargeCraft()) {</span>
            // Capital Lasers have an AAA mode for shooting at small targets
<span class="nc" id="L2963">            int aaaMod = 0;</span>
<span class="nc bnc" id="L2964" title="All 4 branches missed.">            if (wtype.hasModes() &amp;&amp; weapon.curMode().equals(Weapon.MODE_CAP_LASER_AAA)) {</span>
<span class="nc" id="L2965">                aaaMod = 2;</span>
            }
<span class="nc bnc" id="L2967" title="All 2 branches missed.">            if (wtype.isSubCapital()) {</span>
<span class="nc" id="L2968">                toHit.addModifier(3 - aaaMod, Messages.getString(&quot;WeaponAttackAction.SubCapSmallTe&quot;));</span>
            } else {
<span class="nc" id="L2970">                toHit.addModifier(5 - aaaMod, Messages.getString(&quot;WeaponAttackAction.CapSmallTe&quot;));</span>
            }
        }
        
        // Check whether we're eligible for a flak bonus...
<span class="nc bnc" id="L2975" title="All 2 branches missed.">        if (isFlakAttack) {</span>
            // ...and if so, which one (HAGs get an extra -1 as per TW p. 136
            // that's not covered by anything else).
<span class="nc bnc" id="L2978" title="All 4 branches missed.">            if (atype != null &amp;&amp; atype.getAmmoType() == AmmoType.T_HAG) {</span>
<span class="nc" id="L2979">                toHit.addModifier(-3, Messages.getString(&quot;WeaponAttackAction.HagFlak&quot;));</span>
            } else {
<span class="nc" id="L2981">                toHit.addModifier(-2, Messages.getString(&quot;WeaponAttackAction.Flak&quot;));</span>
            }
        }
        
        // Flat to hit modifiers defined in WeaponType  
<span class="nc bnc" id="L2986" title="All 2 branches missed.">        if (wtype.getToHitModifier() != 0) {</span>
<span class="nc" id="L2987">            int modifier = wtype.getToHitModifier();</span>
<span class="nc bnc" id="L2988" title="All 2 branches missed.">            if (wtype instanceof VariableSpeedPulseLaserWeapon) {</span>
<span class="nc" id="L2989">                int nRange = ae.getPosition().distance(target.getPosition());</span>
<span class="nc" id="L2990">                int[] nRanges = wtype.getRanges(weapon);</span>

<span class="nc bnc" id="L2992" title="All 2 branches missed.">                if (nRange &lt;= nRanges[RangeType.RANGE_SHORT]) {</span>
<span class="nc" id="L2993">                    modifier += RangeType.RANGE_SHORT;</span>
<span class="nc bnc" id="L2994" title="All 2 branches missed.">                } else if (nRange &lt;= nRanges[RangeType.RANGE_MEDIUM]) {</span>
<span class="nc" id="L2995">                    modifier += RangeType.RANGE_MEDIUM;</span>
                } else {
<span class="nc" id="L2997">                    modifier += RangeType.RANGE_LONG;</span>
                }
            }
<span class="nc" id="L3000">            toHit.addModifier(modifier, Messages.getString(&quot;WeaponAttackAction.WeaponMod&quot;));</span>
        }

        // Indirect fire (LRMs, mortars and the like) has a +1 mod
<span class="nc bnc" id="L3004" title="All 2 branches missed.">        if (isIndirect) {</span>
<span class="nc" id="L3005">            toHit.addModifier(1, Messages.getString(&quot;WeaponAttackAction.Indirect&quot;));</span>
            // Unless the attacker has the Oblique Attacker SPA
<span class="nc bnc" id="L3007" title="All 2 branches missed.">            if (ae.hasAbility(OptionsConstants.GUNNERY_OBLIQUE_ATTACKER)) {</span>
<span class="nc" id="L3008">                toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.ObliqueAttacker&quot;));</span>
            }
        }
        
        // Indirect fire suffers a +1 penalty if the spotter is making attacks of its own
<span class="nc bnc" id="L3013" title="All 2 branches missed.">        if (isIndirect) {</span>
            // semiguided ammo negates this modifier, if TAG succeeded
<span class="nc bnc" id="L3015" title="All 4 branches missed.">            if ((atype != null) &amp;&amp; ((atype.getAmmoType() == AmmoType.T_LRM)</span>
<span class="nc bnc" id="L3016" title="All 2 branches missed.">                    || (atype.getAmmoType() == AmmoType.T_LRM_IMP)</span>
<span class="nc bnc" id="L3017" title="All 2 branches missed.">                    || (atype.getAmmoType() == AmmoType.T_MML)</span>
<span class="nc bnc" id="L3018" title="All 2 branches missed.">                    || (atype.getAmmoType() == AmmoType.T_NLRM) </span>
<span class="nc bnc" id="L3019" title="All 4 branches missed.">                    || (atype.getAmmoType() == AmmoType.T_MEK_MORTAR))</span>
                    &amp;&amp; (munition == AmmoType.M_SEMIGUIDED)) {

<span class="nc bnc" id="L3022" title="All 2 branches missed.">                if (Compute.isTargetTagged(target, game)) {</span>
<span class="nc" id="L3023">                    toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.SemiGuidedIndirect&quot;));</span>
                }
<span class="nc bnc" id="L3025" title="All 4 branches missed.">            } else if (!narcSpotter &amp;&amp; (spotter != null)) {</span>
                // Unless the target has been tagged, or the spotter has an active command console
<span class="nc" id="L3027">                toHit.append(Compute.getSpotterMovementModifier(game, spotter.getId()));</span>
<span class="nc bnc" id="L3028" title="All 4 branches missed.">                if (spotter.isAttackingThisTurn() &amp;&amp; !spotter.getCrew().hasActiveCommandConsole() &amp;&amp; </span>
<span class="nc bnc" id="L3029" title="All 2 branches missed.">                        !Compute.isTargetTagged(target, game)) {</span>
<span class="nc" id="L3030">                    toHit.addModifier(1, Messages.getString(&quot;WeaponAttackAction.SpotterAttacking&quot;));</span>
                }
            }
        }
        
        // And if this is a Mech Mortar
<span class="nc bnc" id="L3036" title="All 2 branches missed.">        if (wtype instanceof MekMortarWeapon) {</span>
<span class="nc bnc" id="L3037" title="All 2 branches missed.">            if (isIndirect) {</span>
                // +2 penalty if there's no spotting entity
<span class="nc bnc" id="L3039" title="All 2 branches missed.">                if (spotter == null) {</span>
<span class="nc" id="L3040">                    toHit.addModifier(2, Messages.getString(&quot;WeaponAttackAction.NoSpotter&quot;));</span>
                }
            } else {
                // +3 penalty for a direct-fire shot
<span class="nc" id="L3044">                toHit.addModifier(3, Messages.getString(&quot;WeaponAttackAction.DirectMortar&quot;));</span>
            }
        }
        
        // +1 to hit if the Kinder Rapid-Fire ACs optional rule is turned on, but only Jams on a 2.
        // See TacOps Autocannons for the rest of the rules
<span class="nc bnc" id="L3050" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_KIND_RAPID_AC) </span>
<span class="nc bnc" id="L3051" title="All 2 branches missed.">                &amp;&amp; weapon.curMode().equals(Weapon.MODE_AC_RAPID)) {</span>
<span class="nc" id="L3052">            toHit.addModifier(1, Messages.getString(&quot;WeaponAttackAction.AcRapid&quot;));</span>
        }
        
        // VSP Lasers
        // quirks
        
        // Flat -1 for Accurate Weapon
<span class="nc bnc" id="L3059" title="All 2 branches missed.">        if (weapon.hasQuirk(OptionsConstants.QUIRK_WEAP_POS_ACCURATE)) {</span>
<span class="nc" id="L3060">            toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.AccWeapon&quot;));</span>
        }
        // Flat +1 for Inaccurate Weapon
<span class="nc bnc" id="L3063" title="All 2 branches missed.">        if (weapon.hasQuirk(OptionsConstants.QUIRK_WEAP_NEG_INACCURATE)) {</span>
<span class="nc" id="L3064">            toHit.addModifier(+1, Messages.getString(&quot;WeaponAttackAction.InAccWeapon&quot;));</span>
        }
        // Stable Weapon - Reduces running/flanking penalty by 1
<span class="nc bnc" id="L3067" title="All 4 branches missed.">        if (weapon.hasQuirk(OptionsConstants.QUIRK_WEAP_POS_STABLE_WEAPON) &amp;&amp; (ae.moved == EntityMovementType.MOVE_RUN)) {</span>
<span class="nc" id="L3068">            toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.StableWeapon&quot;));</span>
        }
        // +1 for a Misrepaired Weapon - See StratOps Partial Repairs 
<span class="nc bnc" id="L3071" title="All 2 branches missed.">        if (weapon.hasQuirk(OptionsConstants.QUIRK_WEAP_NEG_MISREPAIRED)) {</span>
<span class="nc" id="L3072">            toHit.addModifier(+1, Messages.getString(&quot;WeaponAttackAction.MisrepairedWeapon&quot;));</span>
        }
        // +1 for a Misreplaced Weapon - See StratOps Partial Repairs
<span class="nc bnc" id="L3075" title="All 2 branches missed.">        if (weapon.hasQuirk(OptionsConstants.QUIRK_WEAP_NEG_MISREPLACED)) {</span>
<span class="nc" id="L3076">            toHit.addModifier(+1, Messages.getString(&quot;WeaponAttackAction.MisreplacedWeapon&quot;));</span>
        }
<span class="nc" id="L3078">        return toHit;</span>
    }
    
    /**
     * Convenience method that compiles the ToHit modifiers applicable to the ammunition being used
     * Using precision AC rounds that get a -1 TH bonus?  You'll find that here.
     * Bonuses related to the attacker's condition?  Using a weapon with a TH penalty?  Those are in other methods.
     * 
     * @param game The current game
     * @param ae The Entity making this attack
     * @param target The Targetable object being attacked
     * @param ttype  The targetable object type
     * @param toHit The running total ToHitData for this WeaponAttackAction
     * 
     * @param wtype The WeaponType of the weapon being used
     * @param weapon The Mounted weapon being used
     * @param atype The AmmoType being used for this attack
     * @param munition  Long indicating the munition type flag being used, if applicable
     * 
     * @param bApollo flag that indicates whether the attacker is using an Apollo FCS for MRMs
     * @param bArtemisV flag that indicates whether the attacker is using an Artemis V FCS
     * @param bFTL flag that indicates whether the attacker is using FTL missiles
     * @param bHeatSeeking flag that indicates whether the attacker is using Heat Seeking missiles
     * @param isECMAffected flag that indicates whether the target is inside an ECM bubble
     * @param isINarcGuided flag that indicates whether the target is broadcasting an iNarc beacon
     */
    private static ToHitData compileAmmoToHitMods(IGame game, Entity ae, Targetable target, int ttype, ToHitData toHit,
                WeaponType wtype, Mounted weapon, AmmoType atype, long munition, boolean bApollo, boolean bArtemisV,
                boolean bFTL, boolean bHeatSeeking, boolean isECMAffected, boolean isINarcGuided) {
<span class="nc bnc" id="L3107" title="All 4 branches missed.">        if (ae == null || atype == null) {</span>
            // Can't calculate ammo mods without valid ammo and an attacker to fire it
<span class="nc" id="L3109">            return toHit;</span>
        }
        
<span class="nc bnc" id="L3112" title="All 2 branches missed.">        if (toHit == null) {</span>
            // Without valid toHit data, the rest of this will fail
<span class="nc" id="L3114">            toHit = new ToHitData();</span>
        }
        
<span class="nc" id="L3117">        Entity te = null;</span>
<span class="nc bnc" id="L3118" title="All 2 branches missed.">        if (ttype == Targetable.TYPE_ENTITY) {</span>
            //Some ammo can only target valid entities
<span class="nc" id="L3120">            te = (Entity) target;</span>
        }

        // Autocannon Munitions
        
        // Armor Piercing ammo is a flat +1
<span class="nc bnc" id="L3126" title="All 2 branches missed.">        if (((atype.getAmmoType() == AmmoType.T_AC) </span>
<span class="nc bnc" id="L3127" title="All 2 branches missed.">                        || (atype.getAmmoType() == AmmoType.T_LAC)</span>
<span class="nc bnc" id="L3128" title="All 2 branches missed.">                        || (atype.getAmmoType() == AmmoType.T_AC_IMP)</span>
<span class="nc bnc" id="L3129" title="All 4 branches missed.">                        || (atype.getAmmoType() == AmmoType.T_PAC))</span>
                &amp;&amp; (munition == AmmoType.M_ARMOR_PIERCING)) {
<span class="nc" id="L3131">            toHit.addModifier(1, Messages.getString(&quot;WeaponAttackAction.ApAmmo&quot;));</span>
        }
        
        // Bombs
        
        // Air-to-air Arrow and Light Air-to-air missiles
<span class="nc bnc" id="L3137" title="All 4 branches missed.">        if (((atype.getAmmoType() == AmmoType.T_AAA_MISSILE) || (atype.getAmmoType() == AmmoType.T_LAA_MISSILE))</span>
<span class="nc bnc" id="L3138" title="All 2 branches missed.">                &amp;&amp; Compute.isAirToGround(ae, target)) {</span>
            // +4 penalty if trying to use one against a ground target
<span class="nc" id="L3140">            toHit.addModifier(+4, Messages.getString(&quot;WeaponAttackAction.AaaGroundAttack&quot;));</span>
            // +3 additional if the attacker is flying at Altitude 3 or less
<span class="nc bnc" id="L3142" title="All 2 branches missed.">            if (ae.getAltitude() &lt; 4) {</span>
<span class="nc" id="L3143">                toHit.addModifier(+3, Messages.getString(&quot;WeaponAttackAction.AaaLowAlt&quot;));</span>
            }
        }
        
        // Flat modifiers defined in AmmoType
<span class="nc bnc" id="L3148" title="All 2 branches missed.">        if (atype.getToHitModifier() != 0) {</span>
<span class="nc" id="L3149">            toHit.addModifier(atype.getToHitModifier(),</span>
<span class="nc" id="L3150">                    atype.getSubMunitionName() + Messages.getString(&quot;WeaponAttackAction.AmmoMod&quot;));</span>
        }
        
        // Missile Munitions
        
        // Apollo FCS for MRMs
<span class="nc bnc" id="L3156" title="All 2 branches missed.">        if (bApollo) {</span>
<span class="nc" id="L3157">            toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.ApolloFcs&quot;));</span>
        }
        
        // add Artemis V bonus
<span class="nc bnc" id="L3161" title="All 2 branches missed.">        if (bArtemisV) {</span>
<span class="nc" id="L3162">            toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.ArtemisV&quot;));</span>
        }
        
        // Follow-the-leader LRMs
<span class="nc bnc" id="L3166" title="All 2 branches missed.">        if (bFTL) {</span>
<span class="nc" id="L3167">            toHit.addModifier(2,atype.getSubMunitionName()</span>
<span class="nc" id="L3168">                    + Messages.getString(&quot;WeaponAttackAction.AmmoMod&quot;));</span>
        }
        
        // Heat Seeking Missles
<span class="nc bnc" id="L3172" title="All 2 branches missed.">        if (bHeatSeeking) {</span>
<span class="nc" id="L3173">            IHex hexTarget = game.getBoard().getHex(target.getPosition());</span>
            // -2 bonus if shooting at burning hexes or buildings
<span class="nc bnc" id="L3175" title="All 4 branches missed.">            if (te == null &amp;&amp; hexTarget.containsTerrain(Terrains.FIRE)) {</span>
<span class="nc" id="L3176">                toHit.addModifier(-2, Messages.getString(&quot;WeaponAttackAction.AmmoMod&quot;));</span>
            }
<span class="nc bnc" id="L3178" title="All 2 branches missed.">            if (te != null) {</span>
                // -2 bonus if the target is on fire
<span class="nc bnc" id="L3180" title="All 2 branches missed.">                if (te.infernos.isStillBurning()) {</span>
<span class="nc" id="L3181">                    toHit.addModifier(-2, Messages.getString(&quot;WeaponAttackAction.AmmoMod&quot;));</span>
                }
<span class="nc bnc" id="L3183" title="All 2 branches missed.">                if ((te.isAirborne())</span>
<span class="nc bnc" id="L3184" title="All 2 branches missed.">                        &amp;&amp; (toHit.getSideTable() == ToHitData.SIDE_REAR)) {</span>
                    // -2 bonus if shooting an Aero through the rear arc
<span class="nc" id="L3186">                    toHit.addModifier(-2, atype.getSubMunitionName()</span>
<span class="nc" id="L3187">                            + Messages.getString(&quot;WeaponAttackAction.AmmoMod&quot;));</span>
<span class="nc bnc" id="L3188" title="All 2 branches missed.">                } else if (te.heat == 0) {</span>
                    // +1 penalty if shooting at a non-heat-tracking unit or a heat-tracking unit at 0 heat
<span class="nc" id="L3190">                    toHit.addModifier(1, atype.getSubMunitionName()</span>
<span class="nc" id="L3191">                            + Messages.getString(&quot;WeaponAttackAction.AmmoMod&quot;));</span>
                } else {
                    // +1 bonus for each -1MP the target would get due to heat
<span class="nc" id="L3194">                    toHit.addModifier(-te.getHeatMPReduction(),</span>
<span class="nc" id="L3195">                            atype.getSubMunitionName()</span>
<span class="nc" id="L3196">                                    + Messages.getString(&quot;WeaponAttackAction.AmmoMod&quot;));</span>
                }
            }

            // +2 penalty if shooting into or through a burning hex
<span class="nc bnc" id="L3201" title="All 2 branches missed.">            if (LosEffects.hasFireBetween(ae.getPosition(),</span>
<span class="nc" id="L3202">                    target.getPosition(), game)) {</span>
<span class="nc" id="L3203">                toHit.addModifier(2, Messages.getString(&quot;WeaponAttackAction.HsmThruFire&quot;));</span>
            }
        }
        
        // Narc-capable missiles homing on an iNarc beacon
<span class="nc bnc" id="L3208" title="All 2 branches missed.">        if (isINarcGuided) {</span>
<span class="nc" id="L3209">            toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.iNarcHoming&quot;));</span>
        }
        
        // Listen-Kill ammo from War of 3039 sourcebook?
<span class="nc bnc" id="L3213" title="All 2 branches missed.">        if (!isECMAffected</span>
<span class="nc bnc" id="L3214" title="All 2 branches missed.">                &amp;&amp; ((atype.getAmmoType() == AmmoType.T_LRM) </span>
<span class="nc bnc" id="L3215" title="All 2 branches missed.">                        || (atype.getAmmoType() == AmmoType.T_LRM_IMP)</span>
<span class="nc bnc" id="L3216" title="All 2 branches missed.">                        || (atype.getAmmoType() == AmmoType.T_MML)</span>
<span class="nc bnc" id="L3217" title="All 2 branches missed.">                        || (atype.getAmmoType() == AmmoType.T_SRM)</span>
<span class="nc bnc" id="L3218" title="All 6 branches missed.">                        || (atype.getAmmoType() == AmmoType.T_SRM_IMP))</span>
<span class="nc bnc" id="L3219" title="All 2 branches missed.">                &amp;&amp; (munition == AmmoType.M_LISTEN_KILL) &amp;&amp; !((te != null) &amp;&amp; te.isClan())) {</span>
<span class="nc" id="L3220">            toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.ListenKill&quot;));</span>
        }
        
<span class="nc" id="L3223">        return toHit;</span>
    }
    
    /**
     * Convenience method that compiles the ToHit modifiers applicable to the attacker's condition
     * Attacker has damaged sensors?  You'll find that here.
     * Defender's a superheavy mech?  Using a weapon with a TH penalty?  Those are in other methods.
     * 
     * @param game The current game
     * @param ae The Entity making this attack
     * @param target The Targetable object being attacked
     * @param los The calculated LOS between attacker and target
     * @param toHit The running total ToHitData for this WeaponAttackAction
     * @param toSubtract An int value representing a running total of mods to disregard - used for some special attacks
     * 
     * @param aimingAt  An int value representing the location being aimed at
     * @param aimingMode  An int value that determines the reason aiming is allowed
     * 
     * @param wtype The WeaponType of the weapon being used
     * @param weapon The Mounted weapon being used
     * @param weaponId  The id number of the weapon being used - used by some external calculations
     * @param atype The AmmoType being used for this attack
     * @param munition  Long indicating the munition type flag being used, if applicable
     * 
     * @param isFlakAttack  flag that indicates whether the attacker is using Flak against an airborne target
     * @param isHaywireINarced  flag that indicates whether the attacker is affected by an iNarc Haywire pod
     * @param isNemesisConfused  flag that indicates whether the attack is affected by an iNarc Nemesis pod
     * @param isWeaponFieldGuns  flag that indicates whether the attack is being made with infantry field guns
     * @param usesAmmo  flag that indicates if the WeaponType being used is ammo-fed
     */
    private static ToHitData compileAttackerToHitMods(IGame game, Entity ae, Targetable target, LosEffects los, ToHitData toHit,
                int toSubtract, int aimingAt, int aimingMode, WeaponType wtype, Mounted weapon, int weaponId, AmmoType atype,
                long munition, boolean isFlakAttack, boolean isHaywireINarced, boolean isNemesisConfused, boolean isWeaponFieldGuns,
                boolean usesAmmo) {
        
<span class="nc bnc" id="L3258" title="All 2 branches missed.">        if (toHit == null) {</span>
            // Without valid toHit data, the rest of this will fail
<span class="nc" id="L3260">            toHit = new ToHitData();</span>
        }
        
        // Modifiers related to an action the attacker is taking
        
        // attacker movement
<span class="nc" id="L3266">        toHit.append(Compute.getAttackerMovementModifier(game, ae.getId()));</span>
        
        // attacker prone
<span class="nc bnc" id="L3269" title="All 2 branches missed.">        if (weaponId &gt; WeaponType.WEAPON_NA) {</span>
<span class="nc" id="L3270">            toHit.append(Compute.getProneMods(game, ae, weaponId));</span>
        }
        
        // add penalty for called shots and change hit table, if necessary
<span class="nc bnc" id="L3274" title="All 4 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_CALLED_SHOTS)</span>
                &amp;&amp; weapon != null) {
<span class="nc" id="L3276">            int call = weapon.getCalledShot().getCall();</span>
<span class="nc bnc" id="L3277" title="All 4 branches missed.">            if ((call &gt; CalledShot.CALLED_NONE) &amp;&amp; (aimingMode != IAimingModes.AIM_MODE_NONE)) {</span>
<span class="nc" id="L3278">                return new ToHitData(TargetRoll.IMPOSSIBLE, Messages.getString(&quot;WeaponAttackAction.CantAimAndCallShots&quot;));</span>
            }
<span class="nc bnc" id="L3280" title="All 6 branches missed.">            switch (call) {</span>
            case CalledShot.CALLED_NONE:
<span class="nc" id="L3282">                break;</span>
            case CalledShot.CALLED_HIGH:
<span class="nc" id="L3284">                toHit.addModifier(+3, Messages.getString(&quot;WeaponAttackAction.CalledHigh&quot;));</span>
<span class="nc" id="L3285">                toHit.setHitTable(ToHitData.HIT_ABOVE);</span>
<span class="nc" id="L3286">                break;</span>
            case CalledShot.CALLED_LOW:
<span class="nc bnc" id="L3288" title="All 2 branches missed.">                if (los.getTargetCover() == LosEffects.COVER_HORIZONTAL) {</span>
<span class="nc" id="L3289">                    return new ToHitData(TargetRoll.IMPOSSIBLE, Messages.getString(&quot;WeaponAttackAction.CalledLowPartCover&quot;));</span>
                }
<span class="nc" id="L3291">                toHit.addModifier(+3, Messages.getString(&quot;WeaponAttackAction.CalledLow&quot;));</span>
<span class="nc" id="L3292">                toHit.setHitTable(ToHitData.HIT_BELOW);</span>
<span class="nc" id="L3293">                break;</span>
            case CalledShot.CALLED_LEFT:
                // handled by Compute#targetSideTable
<span class="nc" id="L3296">                toHit.addModifier(+3, Messages.getString(&quot;WeaponAttackAction.CalledLeft&quot;));</span>
<span class="nc" id="L3297">                break;</span>
            case CalledShot.CALLED_RIGHT:
                // handled by Compute#targetSideTable
<span class="nc" id="L3300">                toHit.addModifier(+3, Messages.getString(&quot;WeaponAttackAction.CalledRight&quot;));</span>
                break;
            }
            // If we're making a called shot with swarm LRMs, then the penalty
            // only applies to the original attack.
<span class="nc bnc" id="L3305" title="All 2 branches missed.">            if (call != CalledShot.CALLED_NONE) {</span>
<span class="nc" id="L3306">                toSubtract += 3;</span>
            }
        }
        
        // Dropping units get hit with a +2 dropping penalty AND the +3 Jumping penalty (SO p22) 
<span class="nc bnc" id="L3311" title="All 4 branches missed.">        if (ae.isAirborne() &amp;&amp; !ae.isAero()) {</span>
<span class="nc" id="L3312">            toHit.addModifier(+2, Messages.getString(&quot;WeaponAttackAction.Dropping&quot;));</span>
<span class="nc" id="L3313">            toHit.addModifier(+3, Messages.getString(&quot;WeaponAttackAction.Jumping&quot;));</span>
        }
        
        // Infantry taking cover suffer a +1 penalty
<span class="nc bnc" id="L3317" title="All 4 branches missed.">        if ((ae instanceof Infantry) &amp;&amp; ((Infantry) ae).isTakingCover()) {</span>
<span class="nc bnc" id="L3318" title="All 2 branches missed.">            if (ae.getPosition().direction(target.getPosition()) == ae.getFacing()) {</span>
<span class="nc" id="L3319">                toHit.addModifier(+1, Messages.getString(&quot;WeaponAttackAction.FireThruCover&quot;));</span>
            }
        }
        
        // Quadvee converting to a new mode
<span class="nc bnc" id="L3324" title="All 4 branches missed.">        if (ae instanceof QuadVee &amp;&amp; ae.isConvertingNow()) {</span>
<span class="nc" id="L3325">            toHit.addModifier(+3, Messages.getString(&quot;WeaponAttackAction.QuadVeeConverting&quot;));</span>
        }
        
        // Secondary targets modifier,
        // if this is not a iNarc Nemesis confused attack
        // Inf field guns don't get secondary target mods, TO pg 311
<span class="nc bnc" id="L3331" title="All 4 branches missed.">        if (!isNemesisConfused &amp;&amp; !isWeaponFieldGuns) {</span>
<span class="nc" id="L3332">            toHit.append(Compute.getSecondaryTargetMod(game, ae, target));</span>
        }
        
        // if we're spotting for indirect fire, add +1
<span class="nc bnc" id="L3336" title="All 4 branches missed.">        if (ae.isSpotting() &amp;&amp; !ae.getCrew().hasActiveCommandConsole()</span>
<span class="nc bnc" id="L3337" title="All 4 branches missed.">                &amp;&amp; game.getTagInfo().stream().noneMatch(inf -&gt; inf.attackerId == ae.getId())) {</span>
<span class="nc" id="L3338">            toHit.addModifier(+1, Messages.getString(&quot;WeaponAttackAction.AeSpotting&quot;));</span>
        }
        
        // Special effects (like tasers) affecting the attacker
        
        // Attacker is battle armor and affected by BA taser feedback
<span class="nc bnc" id="L3344" title="All 2 branches missed.">        if (ae.getTaserFeedBackRounds() &gt; 0) {</span>
<span class="nc" id="L3345">            toHit.addModifier(1, Messages.getString(&quot;WeaponAttackAction.AeTaserFeedback&quot;));</span>
        }
        
        // If a unit is suffering from electromagnetic interference, they get a
        // blanket +2. Sucks to be them.
<span class="nc bnc" id="L3350" title="All 2 branches missed.">        if (ae.isSufferingEMI()) {</span>
<span class="nc" id="L3351">            toHit.addModifier(+2, Messages.getString(&quot;WeaponAttackAction.EMI&quot;));</span>
        }
        
        // heat
<span class="nc bnc" id="L3355" title="All 2 branches missed.">        if (ae.getHeatFiringModifier() != 0) {</span>
<span class="nc" id="L3356">            toHit.addModifier(ae.getHeatFiringModifier(), Messages.getString(&quot;WeaponAttackAction.Heat&quot;));</span>
        }
        
        // Attacker hit with an iNarc Haywire pod
<span class="nc bnc" id="L3360" title="All 2 branches missed.">        if (isHaywireINarced) {</span>
<span class="nc" id="L3361">            toHit.addModifier(1, Messages.getString(&quot;WeaponAttackAction.iNarcHaywire&quot;));</span>
        }
        
        // Attacker affected by Taser interference
<span class="nc bnc" id="L3365" title="All 2 branches missed.">        if (ae.getTaserInterferenceRounds() &gt; 0) {</span>
<span class="nc" id="L3366">            toHit.addModifier(ae.getTaserInterference(), Messages.getString(&quot;WeaponAttackAction.AeHitByTaser&quot;));</span>
        }
        
        // Attacker affected by TSEMP interference
<span class="nc bnc" id="L3370" title="All 2 branches missed.">        if (ae.getTsempEffect() == TSEMPWeapon.TSEMP_EFFECT_INTERFERENCE) {</span>
<span class="nc" id="L3371">            toHit.addModifier(+2, Messages.getString(&quot;WeaponAttackAction.AeTsemped&quot;));</span>
        }
        
        // Special Equipment that that attacker possesses
        
        // Attacker has an AES system
<span class="nc bnc" id="L3377" title="All 6 branches missed.">        if (weapon != null &amp;&amp; ae.hasFunctionalArmAES(weapon.getLocation()) &amp;&amp; !weapon.isSplit()) {</span>
<span class="nc" id="L3378">            toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.AES&quot;));</span>
        }
        
        // Heavy infantry have +1 penalty
<span class="nc bnc" id="L3382" title="All 4 branches missed.">        if ((ae instanceof Infantry) &amp;&amp; ae.hasWorkingMisc(MiscType.F_TOOLS, MiscType.S_HEAVY_ARMOR)) {</span>
<span class="nc" id="L3383">            toHit.addModifier(1, Messages.getString(&quot;WeaponAttackAction.HeavyArmor&quot;));</span>
        }
        
        // industrial cockpit: +1 to hit
<span class="nc bnc" id="L3387" title="All 4 branches missed.">        if ((ae instanceof Mech) &amp;&amp; (((Mech) ae).getCockpitType() == Mech.COCKPIT_INDUSTRIAL)) {</span>
<span class="nc" id="L3388">            toHit.addModifier(1, Messages.getString(&quot;WeaponAttackAction.IndustrialNoAfc&quot;));</span>
        }
        // primitive industrial cockpit: +2 to hit
<span class="nc bnc" id="L3391" title="All 4 branches missed.">        if ((ae instanceof Mech) &amp;&amp; (((Mech) ae).getCockpitType() == Mech.COCKPIT_PRIMITIVE_INDUSTRIAL)) {</span>
<span class="nc" id="L3392">            toHit.addModifier(2, Messages.getString(&quot;WeaponAttackAction.PrimIndustrialNoAfc&quot;));</span>
        }

        // primitive industrial cockpit with advanced firing control: +1 to hit
<span class="nc bnc" id="L3396" title="All 4 branches missed.">        if ((ae instanceof Mech) &amp;&amp; (((Mech) ae).getCockpitType() == Mech.COCKPIT_PRIMITIVE)</span>
<span class="nc bnc" id="L3397" title="All 2 branches missed.">                &amp;&amp; ((Mech) ae).isIndustrial()) {</span>
<span class="nc" id="L3398">            toHit.addModifier(1, Messages.getString(&quot;WeaponAttackAction.PrimIndustrialAfc&quot;));</span>
        }
        
        // Support vehicle basic/advanced fire control systems
<span class="nc bnc" id="L3402" title="All 4 branches missed.">        if ((ae instanceof SupportTank) || (ae instanceof SupportVTOL)) {</span>
<span class="nc bnc" id="L3403" title="All 2 branches missed.">            if (!ae.hasWorkingMisc(MiscType.F_BASIC_FIRECONTROL)</span>
<span class="nc bnc" id="L3404" title="All 2 branches missed.">                    &amp;&amp; !ae.hasWorkingMisc(MiscType.F_ADVANCED_FIRECONTROL)) {</span>
<span class="nc" id="L3405">                toHit.addModifier(2, Messages.getString(&quot;WeaponAttackAction.SupVeeNoFc&quot;));</span>
<span class="nc bnc" id="L3406" title="All 2 branches missed.">            } else if (ae.hasWorkingMisc(MiscType.F_BASIC_FIRECONTROL)</span>
<span class="nc bnc" id="L3407" title="All 2 branches missed.">                    &amp;&amp; !(ae.hasWorkingMisc(MiscType.F_ADVANCED_FIRECONTROL))) {</span>
<span class="nc" id="L3408">                toHit.addModifier(1, Messages.getString(&quot;WeaponAttackAction.SupVeeBfc&quot;));</span>
            }
        }
        
        // Is the attacker hindered by a shield?
<span class="nc bnc" id="L3413" title="All 4 branches missed.">        if (ae.hasShield() &amp;&amp; weapon != null) {</span>
            // active shield has already been checked as it makes shots
            // impossible
            // time to check passive defense and no defense

<span class="nc bnc" id="L3418" title="All 2 branches missed.">            if (ae.hasPassiveShield(weapon.getLocation(), weapon.isRearMounted())) {</span>
<span class="nc" id="L3419">                toHit.addModifier(+2, Messages.getString(&quot;WeaponAttackAction.PassiveShield&quot;));</span>
<span class="nc bnc" id="L3420" title="All 2 branches missed.">            } else if (ae.hasNoDefenseShield(weapon.getLocation())) {</span>
<span class="nc" id="L3421">                toHit.addModifier(+1, Messages.getString(&quot;WeaponAttackAction.Shield&quot;));</span>
            }
        }
        
        // add targeting computer (except with LBX cluster ammo)
<span class="nc bnc" id="L3426" title="All 4 branches missed.">        if ((aimingMode == IAimingModes.AIM_MODE_TARG_COMP) &amp;&amp; (aimingAt != Entity.LOC_NONE)) {</span>
<span class="nc bnc" id="L3427" title="All 2 branches missed.">            if (ae.hasActiveEiCockpit()) {</span>
<span class="nc bnc" id="L3428" title="All 2 branches missed.">                if (ae.hasTargComp()) {</span>
<span class="nc" id="L3429">                    toHit.addModifier(2, Messages.getString(&quot;WeaponAttackAction.AimWithTCompEi&quot;));</span>
                } else {
<span class="nc" id="L3431">                    toHit.addModifier(6, Messages.getString(&quot;WeaponAttackAction.AimWithEiOnly&quot;));</span>
                }
            } else {
<span class="nc" id="L3434">                toHit.addModifier(3, Messages.getString(&quot;WeaponAttackAction.AimWithTCompOnly&quot;));</span>
            }
        } else {
            // LB-X cluster, HAG flak, flak ammo ineligible for TC bonus
<span class="nc bnc" id="L3438" title="All 4 branches missed.">            boolean usesLBXCluster = usesAmmo &amp;&amp; (atype != null)</span>
<span class="nc bnc" id="L3439" title="All 6 branches missed.">                    &amp;&amp; (atype.getAmmoType() == AmmoType.T_AC_LBX || atype.getAmmoType() == AmmoType.T_AC_LBX_THB)</span>
                    &amp;&amp; munition == AmmoType.M_CLUSTER;
<span class="nc bnc" id="L3441" title="All 8 branches missed.">            boolean usesHAGFlak = usesAmmo &amp;&amp; (atype != null) &amp;&amp; atype.getAmmoType() == AmmoType.T_HAG &amp;&amp; isFlakAttack;</span>
<span class="nc bnc" id="L3442" title="All 6 branches missed.">            boolean isSBGauss = usesAmmo &amp;&amp; (atype != null) &amp;&amp; atype.getAmmoType() == AmmoType.T_SBGAUSS;</span>
<span class="nc bnc" id="L3443" title="All 6 branches missed.">            boolean isFlakAmmo = usesAmmo &amp;&amp; (atype != null) &amp;&amp; (munition == AmmoType.M_FLAK);</span>
<span class="nc bnc" id="L3444" title="All 8 branches missed.">            if (ae.hasTargComp() &amp;&amp; wtype != null &amp;&amp; wtype.hasFlag(WeaponType.F_DIRECT_FIRE) &amp;&amp; !wtype.hasFlag(WeaponType.F_CWS)</span>
<span class="nc bnc" id="L3445" title="All 12 branches missed.">                    &amp;&amp; !wtype.hasFlag(WeaponType.F_TASER)</span>
                    &amp;&amp; (!usesAmmo || !(usesLBXCluster || usesHAGFlak || isSBGauss || isFlakAmmo))) {
<span class="nc" id="L3447">                toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.TComp&quot;));</span>
            }
        }
        
        // penalty for an active void signature system
<span class="nc bnc" id="L3452" title="All 2 branches missed.">        if (ae.isVoidSigActive()) {</span>
<span class="nc" id="L3453">            toHit.addModifier(1, Messages.getString(&quot;WeaponAttackAction.AeVoidSig&quot;));</span>
        }
        
        // Critical damage effects
        
        // actuator &amp; sensor damage to attacker (includes partial repairs)
<span class="nc bnc" id="L3459" title="All 2 branches missed.">        if (weapon != null) {</span>
<span class="nc" id="L3460">            toHit.append(Compute.getDamageWeaponMods(ae, weapon));</span>
        }
        
        // Vehicle criticals
<span class="nc bnc" id="L3464" title="All 2 branches missed.">        if (ae instanceof Tank) {</span>
<span class="nc" id="L3465">            Tank tank = (Tank) ae;</span>
<span class="nc" id="L3466">            int sensors = tank.getSensorHits();</span>
<span class="nc bnc" id="L3467" title="All 2 branches missed.">            if (sensors &gt; 0) {</span>
<span class="nc" id="L3468">                toHit.addModifier(sensors, Messages.getString(&quot;WeaponAttackAction.SensorDamage&quot;));</span>
            }
<span class="nc bnc" id="L3470" title="All 4 branches missed.">            if (weapon != null &amp;&amp; tank.isStabiliserHit(weapon.getLocation())) {</span>
<span class="nc" id="L3471">                toHit.addModifier(Compute.getAttackerMovementModifier(game, tank.getId()).getValue(),</span>
                        &quot;stabiliser damage&quot;);
            }
        }
        
        // Quirks
        
        // Anti-air targeting quirk vs airborne unit
<span class="nc bnc" id="L3479" title="All 4 branches missed.">        if (ae.hasQuirk(OptionsConstants.QUIRK_POS_ANTI_AIR) &amp;&amp; (target instanceof Entity)) {</span>
<span class="nc bnc" id="L3480" title="All 4 branches missed.">            if (target.isAirborneVTOLorWIGE() || target.isAirborne()) {</span>
<span class="nc" id="L3481">                toHit.addModifier(-2, Messages.getString(&quot;WeaponAttackAction.AaVsAir&quot;));</span>
            }
        }
        
        // Sensor ghosts quirk
<span class="nc bnc" id="L3486" title="All 2 branches missed.">        if (ae.hasQuirk(OptionsConstants.QUIRK_NEG_SENSOR_GHOSTS)) {</span>
<span class="nc" id="L3487">            toHit.addModifier(+1, Messages.getString(&quot;WeaponAttackAction.SensorGhosts&quot;));</span>
        }

<span class="nc" id="L3490">        return toHit;</span>
    }
    
    /**
     * Convenience method that compiles the ToHit modifiers applicable to the attacker's condition, 
     * if the attacker is an aero
     * Attacker has damaged sensors?  You'll find that here.
     * Defender's a superheavy mech?  Using a weapon with a TH penalty?  Those are in other methods.
     * 
     * @param game The current game
     * @param ae The Entity making this attack
     * @param target The Targetable object being attacked
     * @param ttype  The targetable object type
     * @param toHit The running total ToHitData for this WeaponAttackAction
     * 
     * @param aimingAt  An int value representing the location being aimed at
     * @param aimingMode  An int value that determines the reason aiming is allowed
     * @param eistatus An int value representing the ei cockpit/pilot upgrade status
     * 
     * @param wtype The WeaponType of the weapon being used
     * @param weapon The Mounted weapon being used
     * @param atype The AmmoType being used for this attack
     * @param munition  Long indicating the munition type flag being used, if applicable
     * 
     * @param isArtilleryIndirect  flag that indicates whether this is an indirect-fire artillery attack
     * @param isFlakAttack  flag that indicates whether the attacker is using Flak against an airborne target
     * @param isNemesisConfused  flag that indicates whether the attack is affected by an iNarc Nemesis pod
     * @param isStrafing    flag that indicates whether this is an aero strafing attack
     * @param usesAmmo  flag that indicates if the WeaponType being used is ammo-fed
     */
    private static ToHitData compileAeroAttackerToHitMods(IGame game, Entity ae, Targetable target, int ttype,
                ToHitData toHit, int aimingAt, int aimingMode, int eistatus, WeaponType wtype, Mounted weapon,
                AmmoType atype, long munition, boolean isArtilleryIndirect, boolean isFlakAttack, boolean isNemesisConfused,
                boolean isStrafing, boolean usesAmmo) {
        
<span class="nc bnc" id="L3525" title="All 2 branches missed.">        if (toHit == null) {</span>
            // Without valid toHit data, the rest of this will fail
<span class="nc" id="L3527">            toHit = new ToHitData();</span>
        }
        
<span class="nc" id="L3530">        Entity te = null;</span>
<span class="nc bnc" id="L3531" title="All 2 branches missed.">        if (ttype == Targetable.TYPE_ENTITY) {</span>
            //Some of these weapons only target valid entities
<span class="nc" id="L3533">            te = (Entity) target;</span>
        }
        
        // Generic modifiers that apply to airborne and ground attackers
        
        // actuator &amp; sensor damage to attacker (includes partial repairs)
<span class="nc bnc" id="L3539" title="All 2 branches missed.">        if (weapon != null) {</span>
<span class="nc" id="L3540">            toHit.append(Compute.getDamageWeaponMods(ae, weapon));</span>
        }
        
        // heat
<span class="nc bnc" id="L3544" title="All 2 branches missed.">        if (ae.getHeatFiringModifier() != 0) {</span>
<span class="nc" id="L3545">            toHit.addModifier(ae.getHeatFiringModifier(), Messages.getString(&quot;WeaponAttackAction.Heat&quot;));</span>
        }
        
        // Secondary targets modifier, if this is not a iNarc Nemesis confused attack
        // Also does not apply for altitude bombing or strafing
<span class="nc bnc" id="L3550" title="All 8 branches missed.">        if (!isNemesisConfused &amp;&amp; wtype != null &amp;&amp; !wtype.hasFlag(WeaponType.F_ALT_BOMB) &amp;&amp; !isStrafing) {</span>
<span class="nc" id="L3551">            toHit.append(Compute.getSecondaryTargetMod(game, ae, target));</span>
        }
        
        // add targeting computer (except with LBX cluster ammo)
<span class="nc bnc" id="L3555" title="All 4 branches missed.">        if ((aimingMode == IAimingModes.AIM_MODE_TARG_COMP) &amp;&amp; (aimingAt != Entity.LOC_NONE)) {</span>
<span class="nc bnc" id="L3556" title="All 2 branches missed.">            if (ae.hasActiveEiCockpit()) {</span>
<span class="nc bnc" id="L3557" title="All 2 branches missed.">                if (ae.hasTargComp()) {</span>
<span class="nc" id="L3558">                    toHit.addModifier(2, Messages.getString(&quot;WeaponAttackAction.AimWithTCompEi&quot;));</span>
                } else {
<span class="nc" id="L3560">                    toHit.addModifier(6, Messages.getString(&quot;WeaponAttackAction.AimWithEiOnly&quot;));</span>
                }
            } else {
<span class="nc" id="L3563">                toHit.addModifier(3, Messages.getString(&quot;WeaponAttackAction.AimWithTCompOnly&quot;));</span>
            }
        } else {
            // LB-X cluster, HAG flak, flak ammo ineligible for TC bonus
<span class="nc bnc" id="L3567" title="All 4 branches missed.">            boolean usesLBXCluster = usesAmmo &amp;&amp; (atype != null)</span>
<span class="nc bnc" id="L3568" title="All 6 branches missed.">                    &amp;&amp; (atype.getAmmoType() == AmmoType.T_AC_LBX || atype.getAmmoType() == AmmoType.T_AC_LBX_THB)</span>
                    &amp;&amp; munition == AmmoType.M_CLUSTER;
<span class="nc bnc" id="L3570" title="All 8 branches missed.">            boolean usesHAGFlak = usesAmmo &amp;&amp; (atype != null) &amp;&amp; atype.getAmmoType() == AmmoType.T_HAG &amp;&amp; isFlakAttack;</span>
<span class="nc bnc" id="L3571" title="All 6 branches missed.">            boolean isSBGauss = usesAmmo &amp;&amp; (atype != null) &amp;&amp; atype.getAmmoType() == AmmoType.T_SBGAUSS;</span>
<span class="nc bnc" id="L3572" title="All 6 branches missed.">            boolean isFlakAmmo = usesAmmo &amp;&amp; (atype != null) &amp;&amp; (munition == AmmoType.M_FLAK);</span>
<span class="nc bnc" id="L3573" title="All 8 branches missed.">            if (ae.hasTargComp() &amp;&amp; wtype != null &amp;&amp; wtype.hasFlag(WeaponType.F_DIRECT_FIRE) &amp;&amp; !wtype.hasFlag(WeaponType.F_CWS)</span>
<span class="nc bnc" id="L3574" title="All 12 branches missed.">                    &amp;&amp; !wtype.hasFlag(WeaponType.F_TASER)</span>
                    &amp;&amp; (!usesAmmo || !(usesLBXCluster || usesHAGFlak || isSBGauss || isFlakAmmo))) {
<span class="nc" id="L3576">                toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.TComp&quot;));</span>
            }
        }
        
        // Modifiers for aero units, including fighter LAMs
<span class="nc bnc" id="L3581" title="All 2 branches missed.">        if (ae.isAero()) {</span>
<span class="nc" id="L3582">            IAero aero = (IAero) ae;</span>

            // check for heavy gauss rifle on fighter of small craft
            // Arguably a weapon effect, except that it only applies when used by a fighter (isn't recoil fun?)
            // So it's here instead of with other weapon mods that apply across the board
<span class="nc bnc" id="L3587" title="All 6 branches missed.">            if ((wtype instanceof ISHGaussRifle) &amp;&amp; !(ae instanceof Dropship)</span>
                    &amp;&amp; !(ae instanceof Jumpship)) {
<span class="nc" id="L3589">                toHit.addModifier(+1, Messages.getString(&quot;WeaponAttackAction.FighterHeavyGauss&quot;));</span>
            }
            
            // Space ECM
<span class="nc bnc" id="L3593" title="All 4 branches missed.">            if (game.getBoard().inSpace() &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ECM)) {</span>
<span class="nc" id="L3594">                int ecm = ComputeECM.getLargeCraftECM(ae, ae.getPosition(), target.getPosition());</span>
<span class="nc bnc" id="L3595" title="All 2 branches missed.">                if (!ae.isLargeCraft()) {</span>
<span class="nc" id="L3596">                    ecm += ComputeECM.getSmallCraftECM(ae, ae.getPosition(), target.getPosition());</span>
                }
<span class="nc" id="L3598">                ecm = Math.min(4, ecm);</span>
<span class="nc" id="L3599">                int eccm = 0;</span>
<span class="nc bnc" id="L3600" title="All 2 branches missed.">                if (ae.isLargeCraft()) {</span>
<span class="nc" id="L3601">                    eccm = ((Aero) ae).getECCMBonus();</span>
                }
<span class="nc bnc" id="L3603" title="All 2 branches missed.">                if (ecm &gt; 0) {</span>
<span class="nc" id="L3604">                    toHit.addModifier(ecm, Messages.getString(&quot;WeaponAttackAction.ECM&quot;));</span>
<span class="nc bnc" id="L3605" title="All 2 branches missed.">                    if (eccm &gt; 0) {</span>
<span class="nc" id="L3606">                        toHit.addModifier(-1 * Math.min(ecm, eccm), Messages.getString(&quot;WeaponAttackAction.ECCM&quot;));</span>
                    }
                }
            }

            // +4 attack penalty for locations hit by ASEW missiles
<span class="nc bnc" id="L3612" title="All 2 branches missed.">            if (ae instanceof Dropship) {</span>
<span class="nc" id="L3613">                Dropship d = (Dropship) ae;</span>
<span class="nc bnc" id="L3614" title="All 2 branches missed.">                if (weapon != null) {</span>
<span class="nc" id="L3615">                    int loc = weapon.getLocation();</span>
<span class="nc bnc" id="L3616" title="All 2 branches missed.">                    if (d.getASEWAffected(loc) &gt; 0) {</span>
<span class="nc" id="L3617">                        toHit.addModifier(4, Messages.getString(&quot;WeaponAttackAction.AeArcAsewAffected&quot;));</span>
                    }
                }
<span class="nc bnc" id="L3620" title="All 2 branches missed.">            } else if (ae instanceof Jumpship) {</span>
<span class="nc" id="L3621">                Jumpship j = (Jumpship) ae;</span>
<span class="nc bnc" id="L3622" title="All 2 branches missed.">                if (weapon != null) {</span>
<span class="nc" id="L3623">                    int loc = weapon.getLocation();</span>
<span class="nc bnc" id="L3624" title="All 2 branches missed.">                    if (j.getASEWAffected(loc) &gt; 0) {</span>
<span class="nc" id="L3625">                        toHit.addModifier(4, Messages.getString(&quot;WeaponAttackAction.AeArcAsewAffected&quot;));</span>
                    }
                }
<span class="nc" id="L3628">            } else {</span>
<span class="nc bnc" id="L3629" title="All 2 branches missed.">                if (ae.getASEWAffected() &gt; 0) {</span>
<span class="nc" id="L3630">                    toHit.addModifier(4, Messages.getString(&quot;WeaponAttackAction.AeAsewAffected&quot;));</span>
                }
            }
            // Altitude-related mods for air-to-air combat
<span class="nc bnc" id="L3634" title="All 2 branches missed.">            if (Compute.isAirToAir(ae, target)) {</span>
<span class="nc bnc" id="L3635" title="All 2 branches missed.">                if (target.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L3636">                    toHit.addModifier(+5, Messages.getString(&quot;WeaponAttackAction.TeNonAeroAirborne&quot;));</span>
                }
<span class="nc bnc" id="L3638" title="All 2 branches missed.">                if (ae.isNOE()) {</span>
<span class="nc bnc" id="L3639" title="All 2 branches missed.">                    if (ae.isOmni()) {</span>
<span class="nc" id="L3640">                        toHit.addModifier(+1, Messages.getString(&quot;WeaponAttackAction.AeOmniNoe&quot;));</span>
                    } else {
<span class="nc" id="L3642">                        toHit.addModifier(+2, Messages.getString(&quot;WeaponAttackAction.AeNoe&quot;));</span>
                    }
                }
            }
            
            // air-to-ground strikes
<span class="nc bnc" id="L3648" title="All 2 branches missed.">            if (Compute.isAirToGround(ae, target)</span>
<span class="nc bnc" id="L3649" title="All 2 branches missed.">                    || (ae.isMakingVTOLGroundAttack())) {</span>
                // When altitude bombing, add the altitude as a modifier
<span class="nc bnc" id="L3651" title="All 4 branches missed.">                if (wtype != null &amp;&amp; wtype.hasFlag(WeaponType.F_ALT_BOMB)) {</span>
<span class="nc" id="L3652">                    toHit.addModifier(ae.getAltitude(), Messages.getString(&quot;WeaponAttackAction.BombAltitude&quot;));</span>
                    // -2 for the Golden Goose SPA
<span class="nc bnc" id="L3654" title="All 2 branches missed.">                    if (ae.hasAbility(OptionsConstants.GUNNERY_GOLDEN_GOOSE)) {</span>
<span class="nc" id="L3655">                        toHit.addModifier(-2, Messages.getString(&quot;WeaponAttackAction.GoldenGoose&quot;));</span>
                    }
                // +4 Modifier for strafing
<span class="nc bnc" id="L3658" title="All 2 branches missed.">                } else if (isStrafing) {</span>
<span class="nc" id="L3659">                    toHit.addModifier(+4, Messages.getString(&quot;WeaponAttackAction.Strafing&quot;));</span>
                    // Additional +2 if flying at Nape-of-Earth
<span class="nc bnc" id="L3661" title="All 2 branches missed.">                    if (ae.getAltitude() == 1) {</span>
<span class="nc" id="L3662">                        toHit.addModifier(+2, Messages.getString(&quot;WeaponAttackAction.StrafingNoe&quot;));</span>
                    }
                    // Additional Nape-of-Earth restrictions for strafing
<span class="nc bnc" id="L3665" title="All 2 branches missed.">                    if (ae.getAltitude() == 1) {</span>
<span class="nc" id="L3666">                        Coords prevCoords = ae.passedThroughPrevious(target.getPosition());</span>
<span class="nc" id="L3667">                        IHex prevHex = game.getBoard().getHex(prevCoords);</span>
<span class="nc" id="L3668">                        toHit.append(Compute.getStrafingTerrainModifier(game, eistatus, prevHex));</span>
<span class="nc" id="L3669">                    }</span>
                } else {
                    // +2 modifier for striking
<span class="nc" id="L3672">                    toHit.addModifier(+2, Messages.getString(&quot;WeaponAttackAction.AtgStrike&quot;));</span>
<span class="nc bnc" id="L3673" title="All 2 branches missed.">                    if (ae.hasAbility(OptionsConstants.GUNNERY_GOLDEN_GOOSE)) {</span>
<span class="nc bnc" id="L3674" title="All 4 branches missed.">                        if (wtype != null &amp;&amp; wtype.hasFlag(WeaponType.F_DIVE_BOMB)) {</span>
                            // -2 for the Golden Goose SPA if dive bombing
<span class="nc" id="L3676">                            toHit.addModifier(-2, Messages.getString(&quot;WeaponAttackAction.GoldenGoose&quot;));</span>
                        } else {
                            // -1 for the Golden Goose SPA on strike attacks
<span class="nc" id="L3679">                            toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.GoldenGoose&quot;));</span>
                        }
                    }
                }
            }
            // units making air to ground attacks are easier to hit by air-to-air
            // attacks
<span class="nc bnc" id="L3686" title="All 2 branches missed.">            if (Compute.isAirToAir(ae, target)) {</span>
<span class="nc bnc" id="L3687" title="All 2 branches missed.">                for (Enumeration&lt;EntityAction&gt; i = game.getActions(); i.hasMoreElements();) {</span>
<span class="nc" id="L3688">                    EntityAction ea = i.nextElement();</span>
<span class="nc bnc" id="L3689" title="All 2 branches missed.">                    if (!(ea instanceof WeaponAttackAction)) {</span>
<span class="nc" id="L3690">                        continue;</span>
                    }
<span class="nc" id="L3692">                    WeaponAttackAction prevAttack = (WeaponAttackAction) ea;</span>
<span class="nc bnc" id="L3693" title="All 6 branches missed.">                    if ((te != null &amp;&amp; prevAttack.getEntityId() == te.getId()) &amp;&amp; prevAttack.isAirToGround(game)) {</span>
<span class="nc" id="L3694">                        toHit.addModifier(-3, Messages.getString(&quot;WeaponAttackAction.TeGroundAttack&quot;));</span>
<span class="nc" id="L3695">                        break;</span>
                    }
<span class="nc" id="L3697">                }</span>
            }
            // grounded aero
<span class="nc bnc" id="L3700" title="All 4 branches missed.">            if (!ae.isAirborne() &amp;&amp; !ae.isSpaceborne()) {</span>
<span class="nc bnc" id="L3701" title="All 2 branches missed.">                if (!(ae instanceof Dropship)) {</span>
<span class="nc" id="L3702">                    toHit.addModifier(+2, Messages.getString(&quot;WeaponAttackAction.GroundedAero&quot;));</span>
<span class="nc bnc" id="L3703" title="All 4 branches missed.">                } else if (!target.isAirborne() &amp;&amp; !isArtilleryIndirect) {</span>
<span class="nc" id="L3704">                    toHit.addModifier(-2, Messages.getString(&quot;WeaponAttackAction.GroundedDs&quot;));</span>
                }
            }
            // out of control
<span class="nc bnc" id="L3708" title="All 2 branches missed.">            if (aero.isOutControlTotal()) {</span>
<span class="nc" id="L3709">                toHit.addModifier(+2, Messages.getString(&quot;WeaponAttackAction.AeroOoc&quot;));</span>
            }
        }
        // Situational modifiers for aero units, not including LAMs.
<span class="nc bnc" id="L3713" title="All 2 branches missed.">        if (ae instanceof Aero) {</span>
<span class="nc" id="L3714">            Aero aero = (Aero) ae;</span>

            // sensor hits
<span class="nc" id="L3717">            int sensors = aero.getSensorHits();</span>

<span class="nc bnc" id="L3719" title="All 2 branches missed.">            if (!ae.isCapitalFighter()) {</span>
<span class="nc bnc" id="L3720" title="All 4 branches missed.">                if ((sensors &gt; 0) &amp;&amp; (sensors &lt; 3)) {</span>
<span class="nc" id="L3721">                    toHit.addModifier(sensors, Messages.getString(&quot;WeaponAttackAction.SensorDamage&quot;));</span>
                }
<span class="nc bnc" id="L3723" title="All 2 branches missed.">                if (sensors &gt; 2) {</span>
<span class="nc" id="L3724">                    toHit.addModifier(+5, Messages.getString(&quot;WeaponAttackAction.SensorDestroyed&quot;));</span>
                }
            }

            // FCS hits
<span class="nc" id="L3729">            int fcs = aero.getFCSHits();</span>

<span class="nc bnc" id="L3731" title="All 4 branches missed.">            if ((fcs &gt; 0) &amp;&amp; !aero.isCapitalFighter()) {</span>
<span class="nc" id="L3732">                toHit.addModifier(fcs * 2, Messages.getString(&quot;WeaponAttackAction.FcsDamage&quot;));</span>
            }
            
            // CIC hits
<span class="nc bnc" id="L3736" title="All 2 branches missed.">            if (aero instanceof Jumpship) {</span>
<span class="nc" id="L3737">                Jumpship js = (Jumpship) aero;</span>
<span class="nc" id="L3738">                int cic = js.getCICHits();</span>
<span class="nc bnc" id="L3739" title="All 2 branches missed.">                if (cic &gt; 0) {</span>
<span class="nc" id="L3740">                    toHit.addModifier(cic * 2, Messages.getString(&quot;WeaponAttackAction.CicDamage&quot;));</span>
                }
            }

            // targeting mods for evasive action by large craft
            // Per TW, this does not apply when firing Capital Missiles
<span class="nc bnc" id="L3746" title="All 4 branches missed.">            if (aero.isEvading() &amp;&amp; wtype != null &amp;&amp; </span>
<span class="nc bnc" id="L3747" title="All 2 branches missed.">                    (!(wtype.getAtClass() == WeaponType.CLASS_CAPITAL_MISSILE</span>
<span class="nc bnc" id="L3748" title="All 2 branches missed.">                            || wtype.getAtClass() == WeaponType.CLASS_AR10</span>
<span class="nc bnc" id="L3749" title="All 2 branches missed.">                            || wtype.getAtClass() == WeaponType.CLASS_TELE_MISSILE))) {</span>
<span class="nc" id="L3750">                toHit.addModifier(+2, Messages.getString(&quot;WeaponAttackAction.AeEvading&quot;));</span>
            }
            
            // stratops page 113: ECHO maneuvers for large craft
<span class="nc bnc" id="L3754" title="All 4 branches missed.">            if (((aero instanceof Warship) || (aero instanceof Dropship)) &amp;&amp;</span>
<span class="nc bnc" id="L3755" title="All 2 branches missed.">                    (aero.getFacing() != aero.getSecondaryFacing())) {</span>
                // if we're computing this for an &quot;attack preview&quot;, then we add 2 MP to 
                // the mp used, as we haven't used the MP yet. If we're actually processing
                // the attack, then the entity will be marked as 'done' and we have already added
                // the 2 MP, so we don't need to double-count it
<span class="nc bnc" id="L3760" title="All 2 branches missed.">                int extraMP = aero.isDone() ? 0 : 2;</span>
<span class="nc bnc" id="L3761" title="All 2 branches missed.">                boolean willUseRunMP = aero.mpUsed + extraMP &gt; aero.getWalkMP();</span>
<span class="nc bnc" id="L3762" title="All 2 branches missed.">                int mod = willUseRunMP ? 2 : 1;</span>
<span class="nc" id="L3763">                toHit.addModifier(mod, Messages.getString(&quot;WeaponAttackAction.LargeCraftEcho&quot;));</span>
            }

            // check for particular kinds of weapons in weapon bays
<span class="nc bnc" id="L3767" title="All 6 branches missed.">            if (ae.usesWeaponBays() &amp;&amp; wtype != null &amp;&amp; weapon != null) {</span>

                // any heavy lasers
<span class="nc bnc" id="L3770" title="All 2 branches missed.">                if (wtype.getAtClass() == WeaponType.CLASS_LASER) {</span>
<span class="nc bnc" id="L3771" title="All 2 branches missed.">                    for (int wId : weapon.getBayWeapons()) {</span>
<span class="nc" id="L3772">                        Mounted bweap = ae.getEquipment(wId);</span>
<span class="nc" id="L3773">                        WeaponType bwtype = (WeaponType) bweap.getType();</span>
<span class="nc bnc" id="L3774" title="All 2 branches missed.">                        if ((bwtype.getInternalName().contains(&quot;Heavy&quot;))</span>
<span class="nc bnc" id="L3775" title="All 2 branches missed.">                                &amp;&amp; (bwtype.getInternalName().contains(&quot;Laser&quot;))) {</span>
<span class="nc" id="L3776">                            toHit.addModifier(+1, Messages.getString(&quot;WeaponAttackAction.HeavyLaserInBay&quot;));</span>
<span class="nc" id="L3777">                            break;</span>
                        }
<span class="nc" id="L3779">                    }</span>
                }
                // barracuda missiles
<span class="nc bnc" id="L3782" title="All 2 branches missed.">                else if (wtype.getAtClass() == WeaponType.CLASS_CAPITAL_MISSILE) {</span>
<span class="nc" id="L3783">                    boolean onlyBarracuda = true;</span>
<span class="nc bnc" id="L3784" title="All 2 branches missed.">                    for (int wId : weapon.getBayWeapons()) {</span>
<span class="nc" id="L3785">                        Mounted bweap = ae.getEquipment(wId);</span>
<span class="nc" id="L3786">                        Mounted bammo = bweap.getLinked();</span>
<span class="nc bnc" id="L3787" title="All 2 branches missed.">                        if (bammo != null) {</span>
<span class="nc" id="L3788">                            AmmoType batype = (AmmoType) bammo.getType();</span>
<span class="nc bnc" id="L3789" title="All 2 branches missed.">                            if (batype.getAmmoType() != AmmoType.T_BARRACUDA) {</span>
<span class="nc" id="L3790">                                onlyBarracuda = false;</span>
                            }
                        }
<span class="nc" id="L3793">                    }</span>
<span class="nc bnc" id="L3794" title="All 2 branches missed.">                    if (onlyBarracuda) {</span>
<span class="nc" id="L3795">                        toHit.addModifier(-2, Messages.getString(&quot;WeaponAttackAction.Barracuda&quot;));</span>
                    }
<span class="nc" id="L3797">                }</span>
                // barracuda missiles in an AR10 launcher (must all be
                // barracuda)
<span class="nc bnc" id="L3800" title="All 2 branches missed.">                else if (wtype.getAtClass() == WeaponType.CLASS_AR10) {</span>
<span class="nc" id="L3801">                    boolean onlyBarracuda = true;</span>
<span class="nc bnc" id="L3802" title="All 2 branches missed.">                    for (int wId : weapon.getBayWeapons()) {</span>
<span class="nc" id="L3803">                        Mounted bweap = ae.getEquipment(wId);</span>
<span class="nc" id="L3804">                        Mounted bammo = bweap.getLinked();</span>
<span class="nc bnc" id="L3805" title="All 2 branches missed.">                        if (bammo != null) {</span>
<span class="nc" id="L3806">                            AmmoType batype = (AmmoType) bammo.getType();</span>
<span class="nc bnc" id="L3807" title="All 2 branches missed.">                            if (!batype.hasFlag(AmmoType.F_AR10_BARRACUDA)) {</span>
<span class="nc" id="L3808">                                onlyBarracuda = false;</span>
                            }
                        }
<span class="nc" id="L3811">                    }</span>
<span class="nc bnc" id="L3812" title="All 2 branches missed.">                    if (onlyBarracuda) {</span>
<span class="nc" id="L3813">                        toHit.addModifier(-2, Messages.getString(&quot;WeaponAttackAction.Barracuda&quot;));</span>
                    }
<span class="nc" id="L3815">                }</span>
                // LBX cluster
<span class="nc bnc" id="L3817" title="All 2 branches missed.">                else if (wtype.getAtClass() == WeaponType.CLASS_LBX_AC) {</span>
<span class="nc" id="L3818">                    boolean onlyCluster = true;</span>
<span class="nc bnc" id="L3819" title="All 2 branches missed.">                    for (int wId : weapon.getBayWeapons()) {</span>
<span class="nc" id="L3820">                        Mounted bweap = ae.getEquipment(wId);</span>
<span class="nc" id="L3821">                        Mounted bammo = bweap.getLinked();</span>
<span class="nc bnc" id="L3822" title="All 2 branches missed.">                        if (bammo != null) {</span>
<span class="nc" id="L3823">                            AmmoType batype = (AmmoType) bammo.getType();</span>
<span class="nc bnc" id="L3824" title="All 2 branches missed.">                            if (batype.getMunitionType() != AmmoType.M_CLUSTER) {</span>
<span class="nc" id="L3825">                                onlyCluster = false;</span>
<span class="nc" id="L3826">                                break;</span>
                            }
                        }
<span class="nc" id="L3829">                    }</span>
<span class="nc bnc" id="L3830" title="All 2 branches missed.">                    if (onlyCluster) {</span>
<span class="nc" id="L3831">                        toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.ClusterAmmo&quot;));</span>
                    }
                }
            }
        }
<span class="nc" id="L3836">        return toHit;</span>
    }
    
    /**
     * Convenience method that compiles the ToHit modifiers applicable to the attacker's crew/pilot
     * Pilot wounded?  Has an SPA?  You'll find that here.
     * Defender's a superheavy mech?  Using a weapon with a TH penalty?  Those are in other methods.
     * 
     * @param game The current game
     * @param ae The Entity making this attack
     * @param te The target Entity
     * @param toHit The running total ToHitData for this WeaponAttackAction
     * 
     * @param wtype The WeaponType of the weapon being used
     * 
     */
    private static ToHitData compileCrewToHitMods(IGame game, Entity ae, Entity te, ToHitData toHit, WeaponType wtype) {
        
<span class="nc bnc" id="L3854" title="All 2 branches missed.">        if (ae == null) {</span>
            // These checks won't work without a valid attacker
<span class="nc" id="L3856">            return toHit;</span>
        }
        
<span class="nc bnc" id="L3859" title="All 2 branches missed.">        if (toHit == null) {</span>
            // Without valid toHit data, the rest of this will fail
<span class="nc" id="L3861">            toHit = new ToHitData();</span>
        }
        
        //Now for modifiers affecting the attacker's crew
        
        // Bonuses for dual cockpits, etc
        // Bonus to gunnery if both crew members are active; a pilot who takes the gunner's role get +1.
<span class="nc bnc" id="L3868" title="All 4 branches missed.">        if (ae instanceof Mech &amp;&amp; ((Mech)ae).getCockpitType() == Mech.COCKPIT_DUAL) {</span>
<span class="nc bnc" id="L3869" title="All 2 branches missed.">            if (!ae.getCrew().isActive(ae.getCrew().getCrewType().getGunnerPos())) {</span>
<span class="nc" id="L3870">                toHit.addModifier(1, Messages.getString(&quot;WeaponAttackAction.GunnerHit&quot;));                </span>
<span class="nc bnc" id="L3871" title="All 2 branches missed.">            } else if (ae.getCrew().hasDedicatedGunner()) {</span>
<span class="nc" id="L3872">                toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.DualCockpit&quot;));</span>
            }
        }

        // The pilot or technical officer can take over the gunner's duties but suffers a +2 penalty.
<span class="nc bnc" id="L3877" title="All 6 branches missed.">        if ((ae instanceof TripodMech || ae instanceof QuadVee) &amp;&amp; !ae.getCrew().hasDedicatedGunner()) {</span>
<span class="nc" id="L3878">            toHit.addModifier(+2, Messages.getString(&quot;WeaponAttackAction.GunnerHit&quot;));</span>
        }
        
        // Fatigue
<span class="nc bnc" id="L3882" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_FATIGUE)</span>
<span class="nc bnc" id="L3883" title="All 2 branches missed.">                &amp;&amp; ae.getCrew().isGunneryFatigued()) {</span>
<span class="nc" id="L3884">            toHit.addModifier(1, Messages.getString(&quot;WeaponAttackAction.Fatigue&quot;));</span>
        }
        
        // Injuries
        
        // Aero unit pilot/crew hits
<span class="nc bnc" id="L3890" title="All 2 branches missed.">        if (ae instanceof Aero) {</span>
<span class="nc" id="L3891">            int pilothits = ae.getCrew().getHits();</span>
<span class="nc bnc" id="L3892" title="All 4 branches missed.">            if ((pilothits &gt; 0) &amp;&amp; !ae.isCapitalFighter()) {</span>
<span class="nc" id="L3893">                toHit.addModifier(pilothits, Messages.getString(&quot;WeaponAttackAction.PilotHits&quot;));</span>
            }
        }
        
        // Vehicle crew hits
<span class="nc bnc" id="L3898" title="All 2 branches missed.">        if (ae instanceof Tank) {</span>
<span class="nc" id="L3899">            Tank tank = (Tank) ae;</span>
<span class="nc bnc" id="L3900" title="All 2 branches missed.">            if (tank.isCommanderHit()) {</span>
<span class="nc bnc" id="L3901" title="All 2 branches missed.">                if (ae instanceof VTOL) {</span>
<span class="nc" id="L3902">                    toHit.addModifier(+1, Messages.getString(&quot;WeaponAttackAction.CopilotHit&quot;));</span>
                } else {
<span class="nc" id="L3904">                    toHit.addModifier(+1, Messages.getString(&quot;WeaponAttackAction.CmdrHit&quot;));</span>
                }
            }
        }
        
        // Manei Domini Upgrades
        
        // VDNI
<span class="nc bnc" id="L3912" title="All 2 branches missed.">        if (ae.hasAbility(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L3913" title="All 2 branches missed.">                || ae.hasAbility(OptionsConstants.MD_BVDNI)) {</span>
<span class="nc" id="L3914">            toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.Vdni&quot;));</span>
        }

<span class="nc bnc" id="L3917" title="All 4 branches missed.">        if ((ae instanceof Infantry) &amp;&amp; !(ae instanceof BattleArmor)) {</span>
            // check for pl-masc
            // the rules are a bit vague, but assume that if the infantry didn't
            // move or jumped, then they shouldn't get the penalty
<span class="nc bnc" id="L3921" title="All 6 branches missed.">            if (ae.hasAbility(OptionsConstants.MD_PL_MASC)</span>
                    &amp;&amp; ((ae.moved == EntityMovementType.MOVE_WALK) || (ae.moved == EntityMovementType.MOVE_RUN))) {
<span class="nc" id="L3923">                toHit.addModifier(+1, Messages.getString(&quot;WeaponAttackAction.PlMasc&quot;));</span>
            }

            // check for cyber eye laser sighting on ranged attacks
<span class="nc bnc" id="L3927" title="All 4 branches missed.">            if (ae.hasAbility(OptionsConstants.MD_CYBER_IMP_LASER)</span>
                    &amp;&amp; !(wtype instanceof InfantryAttack)) {
<span class="nc" id="L3929">                toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.MdEye&quot;));</span>
            }
        }
        
        // SPAs
        
        // Unofficial weapon class specialist - Does not have an unspecialized penalty 
<span class="nc bnc" id="L3936" title="All 4 branches missed.">        if (ae.hasAbility(OptionsConstants.UNOFF_GUNNERY_LASER)</span>
<span class="nc bnc" id="L3937" title="All 2 branches missed.">                &amp;&amp; wtype != null &amp;&amp; wtype.hasFlag(WeaponType.F_ENERGY)) {</span>
<span class="nc" id="L3938">            toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.GunLSkill&quot;));</span>
        }

<span class="nc bnc" id="L3941" title="All 4 branches missed.">        if (ae.hasAbility(OptionsConstants.UNOFF_GUNNERY_BALLISTIC)</span>
<span class="nc bnc" id="L3942" title="All 2 branches missed.">                &amp;&amp; wtype != null &amp;&amp; wtype.hasFlag(WeaponType.F_BALLISTIC)) {</span>
<span class="nc" id="L3943">            toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.GunBSkill&quot;));</span>
        }

<span class="nc bnc" id="L3946" title="All 4 branches missed.">        if (ae.hasAbility(OptionsConstants.UNOFF_GUNNERY_MISSILE)</span>
<span class="nc bnc" id="L3947" title="All 2 branches missed.">                &amp;&amp; wtype != null &amp;&amp; wtype.hasFlag(WeaponType.F_MISSILE)) {</span>
<span class="nc" id="L3948">            toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.GunMSkill&quot;));</span>
        }

        // Is the pilot a weapon specialist?
<span class="nc bnc" id="L3952" title="All 4 branches missed.">        if (wtype != null &amp;&amp; ae.hasAbility(OptionsConstants.GUNNERY_WEAPON_SPECIALIST, wtype.getName())) {</span>
<span class="nc" id="L3953">            toHit.addModifier(-2, Messages.getString(&quot;WeaponAttackAction.WeaponSpec&quot;));</span>
<span class="nc bnc" id="L3954" title="All 2 branches missed.">        } else if (ae.hasAbility(OptionsConstants.GUNNERY_SPECIALIST)) {</span>
            // aToW style gunnery specialist: -1 to specialized weapon and +1 to
            // all other weapons
            // Note that weapon specialist supersedes gunnery specialization, so
            // if you have
            // a specialization in Medium Lasers and a Laser specialization, you
            // only get the -2 specialization mod
<span class="nc bnc" id="L3961" title="All 4 branches missed.">            if (wtype != null &amp;&amp; wtype.hasFlag(WeaponType.F_ENERGY)) {</span>
<span class="nc bnc" id="L3962" title="All 2 branches missed.">                if (ae.hasAbility(OptionsConstants.GUNNERY_SPECIALIST, Crew.SPECIAL_ENERGY)) {</span>
<span class="nc" id="L3963">                    toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.EnergySpec&quot;));</span>
                } else {
<span class="nc" id="L3965">                    toHit.addModifier(+1, Messages.getString(&quot;WeaponAttackAction.Unspec&quot;));</span>
                }
<span class="nc bnc" id="L3967" title="All 4 branches missed.">            } else if (wtype != null &amp;&amp; wtype.hasFlag(WeaponType.F_BALLISTIC)) {</span>
<span class="nc bnc" id="L3968" title="All 2 branches missed.">                if (ae.hasAbility(OptionsConstants.GUNNERY_SPECIALIST, Crew.SPECIAL_BALLISTIC)) {</span>
<span class="nc" id="L3969">                    toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.BallisticSpec&quot;));</span>
                } else {
<span class="nc" id="L3971">                    toHit.addModifier(+1, Messages.getString(&quot;WeaponAttackAction.Unspec&quot;));</span>
                }
<span class="nc bnc" id="L3973" title="All 4 branches missed.">            } else if (wtype != null &amp;&amp; wtype.hasFlag(WeaponType.F_MISSILE)) {</span>
<span class="nc bnc" id="L3974" title="All 2 branches missed.">                if (ae.hasAbility(OptionsConstants.GUNNERY_SPECIALIST, Crew.SPECIAL_MISSILE)) {</span>
<span class="nc" id="L3975">                    toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.MissileSpec&quot;));</span>
                } else {
<span class="nc" id="L3977">                    toHit.addModifier(+1, Messages.getString(&quot;WeaponAttackAction.Unspec&quot;));</span>
                }
            }
        }
        
        // Target SPAs
<span class="nc bnc" id="L3983" title="All 2 branches missed.">        if (te != null) {</span>
            // Shaky Stick -  Target gets a +1 bonus against Ground-to-Air attacks
<span class="nc bnc" id="L3985" title="All 4 branches missed.">            if (te.hasAbility(OptionsConstants.PILOT_SHAKY_STICK) &amp;&amp; te.isAirborne()</span>
<span class="nc bnc" id="L3986" title="All 4 branches missed.">                    &amp;&amp; !ae.isAirborne() &amp;&amp; !ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L3987">                toHit.addModifier(+1, Messages.getString(&quot;WeaponAttackAction.ShakyStick&quot;));</span>
            }
            // Urban Guerrilla - Target gets a +1 bonus in any sort of urban terrain
<span class="nc bnc" id="L3990" title="All 2 branches missed.">            if (te.hasAbility(OptionsConstants.INFANTRY_URBAN_GUERRILLA)</span>
<span class="nc bnc" id="L3991" title="All 2 branches missed.">                    &amp;&amp; (game.getBoard().getHex(te.getPosition()).containsTerrain(Terrains.PAVEMENT)</span>
<span class="nc bnc" id="L3992" title="All 2 branches missed.">                            || game.getBoard().getHex(te.getPosition()).containsTerrain(Terrains.ROAD)</span>
<span class="nc bnc" id="L3993" title="All 2 branches missed.">                            || game.getBoard().getHex(te.getPosition()).containsTerrain(Terrains.RUBBLE)</span>
<span class="nc bnc" id="L3994" title="All 2 branches missed.">                            || game.getBoard().getHex(te.getPosition()).containsTerrain(Terrains.BUILDING)</span>
<span class="nc bnc" id="L3995" title="All 2 branches missed.">                            || game.getBoard().getHex(te.getPosition()).containsTerrain(Terrains.ROUGH))) {</span>
<span class="nc" id="L3996">                toHit.addModifier(+1, Messages.getString(&quot;WeaponAttackAction.UrbanGuerilla&quot;));</span>
            }
            // Forest Ranger - Target gets a +1 bonus in wooded terrain when moving at walking speed or greater
<span class="nc bnc" id="L3999" title="All 2 branches missed.">            if (te.hasAbility(OptionsConstants.PILOT_TM_FOREST_RANGER)</span>
<span class="nc bnc" id="L4000" title="All 2 branches missed.">                    &amp;&amp; (game.getBoard().getHex(te.getPosition()).containsTerrain(Terrains.WOODS)</span>
<span class="nc bnc" id="L4001" title="All 4 branches missed.">                       || game.getBoard().getHex(te.getPosition()).containsTerrain(Terrains.JUNGLE))</span>
                    &amp;&amp; te.moved == EntityMovementType.MOVE_WALK) {
<span class="nc" id="L4003">                toHit.addModifier(+1, Messages.getString(&quot;WeaponAttackAction.ForestRanger&quot;));</span>
            }
            // Swamp Beast - Target gets a +1 bonus in mud/swamp terrain when running/flanking
<span class="nc bnc" id="L4006" title="All 2 branches missed.">            if (te.hasAbility(OptionsConstants.PILOT_TM_SWAMP_BEAST)</span>
<span class="nc bnc" id="L4007" title="All 2 branches missed.">                    &amp;&amp; (game.getBoard().getHex(te.getPosition()).containsTerrain(Terrains.MUD)</span>
<span class="nc bnc" id="L4008" title="All 4 branches missed.">                        || game.getBoard().getHex(te.getPosition()).containsTerrain(Terrains.SWAMP))</span>
                    &amp;&amp; te.moved == EntityMovementType.MOVE_RUN) {
<span class="nc" id="L4010">                toHit.addModifier(+1, Messages.getString(&quot;WeaponAttackAction.SwampBeast&quot;));</span>
            }
        }
<span class="nc" id="L4013">        return toHit;</span>
    }
    
    /**
     * Convenience method that compiles the ToHit modifiers applicable to the defender's condition and actions
     * -4 for shooting at an immobile target?  You'll find that here.
     * Attacker strafing?  Using a weapon with a TH penalty?  Those are in other methods.
     * 
     * @param game The current game
     * @param ae The Entity making this attack
     * @param target The Targetable object being attacked
     * @param ttype  The targetable object type
     * @param los The calculated LOS between attacker and target
     * @param toHit The running total ToHitData for this WeaponAttackAction
     * @param toSubtract An int value representing a running total of mods to disregard - used for some special attacks
     * 
     * @param aimingAt  An int value representing the location being aimed at - used by immobile target calculations
     * @param aimingMode  An int value that determines the reason aiming is allowed - used by immobile target calculations
     * @param distance  The distance in hexes from attacker to target
     * 
     * @param wtype The WeaponType of the weapon being used
     * @param weapon The Mounted weapon being used
     * @param atype The AmmoType being used for this attack
     * @param munition  Long indicating the munition type flag being used, if applicable
     * 
     * @param isArtilleryDirect  flag that indicates whether this is a direct-fire artillery attack
     * @param isArtilleryIndirect  flag that indicates whether this is an indirect-fire artillery attack
     * @param isAttackerInfantry  flag that indicates whether the attacker is an infantry/BA unit
     * @param exchangeSwarmTarget  flag that indicates whether this is the secondary target of Swarm LRMs
     * @param isIndirect  flag that indicates whether this is an indirect attack (LRM, mortar...)
     * @param isPointBlankShot  flag that indicates whether or not this is a PBS by a hidden unit
     * @param usesAmmo  flag that indicates whether or not the WeaponType being used is ammo-fed
     */
    private static ToHitData compileTargetToHitMods(IGame game, Entity ae, Targetable target, int ttype, LosEffects los,
                ToHitData toHit, int toSubtract, int aimingAt, int aimingMode, int distance, WeaponType wtype,
                Mounted weapon, AmmoType atype, long munition, boolean isArtilleryDirect, boolean isArtilleryIndirect,
                boolean isAttackerInfantry, boolean exchangeSwarmTarget, boolean isIndirect,
                boolean isPointBlankShot, boolean usesAmmo) {
<span class="nc bnc" id="L4051" title="All 4 branches missed.">        if (ae == null || target == null) {</span>
            // Can't handle these attacks without a valid attacker and target
<span class="nc" id="L4053">            return toHit;</span>
        }
        
<span class="nc bnc" id="L4056" title="All 2 branches missed.">        if (toHit == null) {</span>
            // Without valid toHit data, the rest of this will fail
<span class="nc" id="L4058">            toHit = new ToHitData();</span>
        }
        
        //Target's hex
<span class="nc" id="L4062">        IHex targHex = game.getBoard().getHex(target.getPosition());</span>
        
<span class="nc" id="L4064">        Entity te = null;</span>
<span class="nc bnc" id="L4065" title="All 2 branches missed.">        if (ttype == Targetable.TYPE_ENTITY) {</span>
            //Some weapons only target valid entities
<span class="nc" id="L4067">            te = (Entity) target;</span>
        }
        
        // Modifiers related to a special action the target is taking
        
        // evading bonuses
<span class="nc bnc" id="L4073" title="All 4 branches missed.">        if ((te != null) &amp;&amp; te.isEvading()) {</span>
<span class="nc" id="L4074">            toHit.addModifier(te.getEvasionBonus(), Messages.getString(&quot;WeaponAttackAction.TeEvading&quot;));</span>
        }
        
        // Hull Down
<span class="nc bnc" id="L4078" title="All 4 branches missed.">        if ((te != null) &amp;&amp; te.isHullDown()) {</span>
<span class="nc bnc" id="L4079" title="All 6 branches missed.">            if ((te instanceof Mech) &amp;&amp; !(te instanceof QuadVee &amp;&amp; te.getConversionMode() == QuadVee.CONV_MODE_VEHICLE)</span>
<span class="nc bnc" id="L4080" title="All 2 branches missed.">                    &amp;&amp; (los.getTargetCover() &gt; LosEffects.COVER_NONE)) {</span>
<span class="nc" id="L4081">                toHit.addModifier(2, Messages.getString(&quot;WeaponAttackAction.HullDown&quot;));</span>
            }
            // tanks going Hull Down is different rules then 'Mechs, the
            // direction the attack comes from matters
<span class="nc bnc" id="L4085" title="All 6 branches missed.">            else if ((te instanceof Tank || (te instanceof QuadVee &amp;&amp; te.getConversionMode() == QuadVee.CONV_MODE_VEHICLE))</span>
<span class="nc bnc" id="L4086" title="All 2 branches missed.">                    &amp;&amp; targHex.containsTerrain(Terrains.FORTIFIED)) {</span>
                // TODO make this a LoS mod so that attacks will come in from
                // directions that grant Hull Down Mods
                int moveInDirection;

<span class="nc bnc" id="L4091" title="All 2 branches missed.">                if (!((Tank) te).isBackedIntoHullDown()) {</span>
<span class="nc" id="L4092">                    moveInDirection = ToHitData.SIDE_FRONT;</span>
                } else {
<span class="nc" id="L4094">                    moveInDirection = ToHitData.SIDE_REAR;</span>
                }

<span class="nc bnc" id="L4097" title="All 2 branches missed.">                if ((te.sideTable(ae.getPosition()) == moveInDirection)</span>
<span class="nc bnc" id="L4098" title="All 2 branches missed.">                        || (te.sideTable(ae.getPosition()) == ToHitData.SIDE_LEFT)</span>
<span class="nc bnc" id="L4099" title="All 2 branches missed.">                        || (te.sideTable(ae.getPosition()) == ToHitData.SIDE_RIGHT)) {</span>
<span class="nc" id="L4100">                    toHit.addModifier(2, Messages.getString(&quot;WeaponAttackAction.HullDown&quot;));</span>
                }
            }
        }
        
        // Infantry taking cover per TacOps special rules
<span class="nc bnc" id="L4106" title="All 6 branches missed.">        if (te != null &amp;&amp; (te instanceof Infantry) &amp;&amp; ((Infantry) te).isTakingCover()) {</span>
<span class="nc bnc" id="L4107" title="All 2 branches missed.">            if (te.getPosition().direction(ae.getPosition()) == te.getFacing()) {</span>
<span class="nc" id="L4108">                toHit.addModifier(+3, Messages.getString(&quot;WeaponAttackAction.FireThruCover&quot;));</span>
            }
        }
        
        // target prone
<span class="nc" id="L4113">        ToHitData proneMod = null;</span>
<span class="nc bnc" id="L4114" title="All 4 branches missed.">        if ((te != null) &amp;&amp; te.isProne()) {</span>
            // easier when point-blank
<span class="nc bnc" id="L4116" title="All 2 branches missed.">            if (distance &lt;= 1) {</span>
                // TW, pg. 221: Swarm Mek attacks apply prone/immobile mods as
                // normal.
<span class="nc" id="L4119">                proneMod = new ToHitData(-2, Messages.getString(&quot;WeaponAttackAction.ProneAdj&quot;));</span>
            } else {
                // Harder at range.
<span class="nc" id="L4122">                proneMod = new ToHitData(1, Messages.getString(&quot;WeaponAttackAction.ProneRange&quot;));</span>
            }
        }
<span class="nc bnc" id="L4125" title="All 2 branches missed.">        if (proneMod != null) {</span>
<span class="nc" id="L4126">            toHit.append(proneMod);</span>
<span class="nc" id="L4127">            toSubtract += proneMod.getValue();</span>
        }
        
        // Special effects affecting the target
        
        // Target grappled?
<span class="nc bnc" id="L4133" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L4134">            int grapple = te.getGrappled();</span>
<span class="nc bnc" id="L4135" title="All 2 branches missed.">            if (grapple != Entity.NONE) {</span>
                // -4 bonus if attacking the entity you're grappling
<span class="nc bnc" id="L4137" title="All 4 branches missed.">                if ((grapple == ae.getId()) &amp;&amp; (te.getGrappleSide() == Entity.GRAPPLE_BOTH)) {</span>
<span class="nc" id="L4138">                    toHit.addModifier(-4, Messages.getString(&quot;WeaponAttackAction.Grappled&quot;));</span>
                // -2 bonus if grappling the target at range with a chain whip
<span class="nc bnc" id="L4140" title="All 4 branches missed.">                } else if ((grapple == ae.getId()) &amp;&amp; (te.getGrappleSide() != Entity.GRAPPLE_BOTH)) {</span>
<span class="nc" id="L4141">                    toHit.addModifier(-2, Messages.getString(&quot;WeaponAttackAction.GrappledByChain&quot;));</span>
                // +1 penalty if firing at a target grappled by another unit. This does not apply to Swarm LRMs
<span class="nc bnc" id="L4143" title="All 2 branches missed.">                } else if (!exchangeSwarmTarget) {</span>
<span class="nc" id="L4144">                    toHit.addModifier(1, Messages.getString(&quot;WeaponAttackAction.FireIntoMelee&quot;));</span>
                } else {
                    // this -1 cancels the original +1
<span class="nc" id="L4147">                    toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.FriendlyFire&quot;));</span>
                }
            }
        }
        
        // Special Equipment and Quirks that the target possesses
        
        // ECM suite generating Ghost Targets
<span class="nc bnc" id="L4155" title="All 8 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_GHOST_TARGET) &amp;&amp; !isIndirect</span>
                &amp;&amp; !isArtilleryIndirect &amp;&amp; !isArtilleryDirect) {
<span class="nc" id="L4157">            int ghostTargetMod = Compute.getGhostTargetNumber(ae, ae.getPosition(), target.getPosition());</span>
<span class="nc bnc" id="L4158" title="All 6 branches missed.">            if ((ghostTargetMod &gt; -1) &amp;&amp; !((ae instanceof Infantry) &amp;&amp; !(ae instanceof BattleArmor))) {</span>
<span class="nc" id="L4159">                int bapMod = 0;</span>
<span class="nc bnc" id="L4160" title="All 2 branches missed.">                if (ae.hasBAP()) {</span>
<span class="nc" id="L4161">                    bapMod = 1;</span>
                }
<span class="nc" id="L4163">                int tcMod = 0;</span>
<span class="nc bnc" id="L4164" title="All 4 branches missed.">                if (ae.hasTargComp() &amp;&amp; wtype != null </span>
<span class="nc bnc" id="L4165" title="All 4 branches missed.">                        &amp;&amp; wtype.hasFlag(WeaponType.F_DIRECT_FIRE) &amp;&amp; !wtype.hasFlag(WeaponType.F_CWS)</span>
<span class="nc bnc" id="L4166" title="All 6 branches missed.">                        &amp;&amp; !wtype.hasFlag(WeaponType.F_TASER) &amp;&amp; (atype != null)</span>
<span class="nc bnc" id="L4167" title="All 2 branches missed.">                        &amp;&amp; (!usesAmmo || !(((atype.getAmmoType() == AmmoType.T_AC_LBX)</span>
<span class="nc bnc" id="L4168" title="All 4 branches missed.">                                || (atype.getAmmoType() == AmmoType.T_AC_LBX_THB))</span>
                                &amp;&amp; (munition == AmmoType.M_CLUSTER)))) {
<span class="nc" id="L4170">                    tcMod = 2;</span>
                }
<span class="nc" id="L4172">                int ghostTargetMoF = (ae.getCrew().getSensorOps() + ghostTargetMod)</span>
<span class="nc" id="L4173">                        - (ae.getGhostTargetOverride() + bapMod + tcMod);</span>
<span class="nc bnc" id="L4174" title="All 2 branches missed.">                if (ghostTargetMoF &gt; 1) {</span>
                    // according to this rules clarification the +4 max is on
                    // the PSR not on the to-hit roll
                    // http://www.classicbattletech.com/forums/index.php?topic=66036.0
                    // unofficial rule to cap the ghost target to-hit penalty
<span class="nc" id="L4179">                    int mod = ghostTargetMoF / 2;</span>
<span class="nc bnc" id="L4180" title="All 2 branches missed.">                    if (game.getOptions().intOption(OptionsConstants.ADVANCED_GHOST_TARGET_MAX) &gt; 0) {</span>
<span class="nc" id="L4181">                        mod = Math.min(mod, game.getOptions().intOption(OptionsConstants.ADVANCED_GHOST_TARGET_MAX));</span>
                    }
<span class="nc" id="L4183">                    toHit.addModifier(mod, Messages.getString(&quot;WeaponAttackAction.GhostTargets&quot;));</span>
                }
            }
        }
        
        // Movement and Position modifiers
        
        // target movement - ignore for pointblank shots from hidden units
<span class="nc bnc" id="L4191" title="All 4 branches missed.">        if ((te != null) &amp;&amp; !isPointBlankShot) {</span>
<span class="nc" id="L4192">            ToHitData thTemp = Compute.getTargetMovementModifier(game, target.getTargetId());</span>
<span class="nc" id="L4193">            toHit.append(thTemp);</span>
<span class="nc" id="L4194">            toSubtract += thTemp.getValue();</span>

            // semiguided ammo negates this modifier, if TAG succeeded
<span class="nc bnc" id="L4197" title="All 4 branches missed.">            if ((atype != null) &amp;&amp; ((atype.getAmmoType() == AmmoType.T_LRM) </span>
<span class="nc bnc" id="L4198" title="All 2 branches missed.">                    || (atype.getAmmoType() == AmmoType.T_LRM_IMP)</span>
<span class="nc bnc" id="L4199" title="All 2 branches missed.">                    || (atype.getAmmoType() == AmmoType.T_MML)</span>
<span class="nc bnc" id="L4200" title="All 2 branches missed.">                    || (atype.getAmmoType() == AmmoType.T_NLRM) </span>
<span class="nc bnc" id="L4201" title="All 4 branches missed.">                    || (atype.getAmmoType() == AmmoType.T_MEK_MORTAR))</span>
<span class="nc bnc" id="L4202" title="All 2 branches missed.">                    &amp;&amp; (munition == AmmoType.M_SEMIGUIDED) &amp;&amp; (te.getTaggedBy() != -1)) {</span>
<span class="nc" id="L4203">                int nAdjust = thTemp.getValue();</span>
<span class="nc bnc" id="L4204" title="All 2 branches missed.">                if (nAdjust &gt; 0) {</span>
<span class="nc" id="L4205">                    toHit.append(new ToHitData(-nAdjust, Messages.getString(&quot;WeaponAttackAction.SemiGuidedTag&quot;)));</span>
                }
<span class="nc" id="L4207">            }</span>
            // precision ammo reduces this modifier
<span class="nc bnc" id="L4209" title="All 2 branches missed.">            else if ((atype != null)</span>
<span class="nc bnc" id="L4210" title="All 2 branches missed.">                    &amp;&amp; ((atype.getAmmoType() == AmmoType.T_AC) </span>
<span class="nc bnc" id="L4211" title="All 2 branches missed.">                            || (atype.getAmmoType() == AmmoType.T_LAC)</span>
<span class="nc bnc" id="L4212" title="All 2 branches missed.">                            || (atype.getAmmoType() == AmmoType.T_AC_IMP)</span>
<span class="nc bnc" id="L4213" title="All 4 branches missed.">                            || (atype.getAmmoType() == AmmoType.T_PAC))</span>
                    &amp;&amp; (munition == AmmoType.M_PRECISION)) {
<span class="nc" id="L4215">                int nAdjust = Math.min(2, thTemp.getValue());</span>
<span class="nc bnc" id="L4216" title="All 2 branches missed.">                if (nAdjust &gt; 0) {</span>
<span class="nc" id="L4217">                    toHit.append(new ToHitData(-nAdjust, Messages.getString(&quot;WeaponAttackAction.Precision&quot;)));</span>
                }
            }
        }
        
        // Ground-to-air attacks against a target flying at NOE
<span class="nc bnc" id="L4223" title="All 6 branches missed.">        if (Compute.isGroundToAir(ae, target) &amp;&amp; (null != te) &amp;&amp; te.isNOE()) {</span>
<span class="nc bnc" id="L4224" title="All 2 branches missed.">            if (te.passedWithin(ae.getPosition(), 1)) {</span>
<span class="nc" id="L4225">                toHit.addModifier(+1, Messages.getString(&quot;WeaponAttackAction.TeNoe&quot;));</span>
            } else {
<span class="nc" id="L4227">                toHit.addModifier(+3, Messages.getString(&quot;WeaponAttackAction.TeNoe&quot;));</span>
            }
        }

        // Ground-to-air attacks against a target flying at any other altitude (if StratOps Velocity mods are on)
<span class="nc bnc" id="L4232" title="All 2 branches missed.">        if (Compute.isGroundToAir(ae, target)</span>
<span class="nc bnc" id="L4233" title="All 4 branches missed.">                &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_AA_FIRE) &amp;&amp; (null != te)</span>
<span class="nc bnc" id="L4234" title="All 2 branches missed.">                &amp;&amp; (te.isAero())) {</span>
<span class="nc" id="L4235">            int vMod = ((IAero) te).getCurrentVelocity();</span>
<span class="nc bnc" id="L4236" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AA_MOVE_MOD)) {</span>
<span class="nc" id="L4237">                vMod = Math.min(vMod / 2, 4);</span>
            }
<span class="nc" id="L4239">            toHit.addModifier(vMod, Messages.getString(&quot;WeaponAttackAction.TeVelocity&quot;));</span>
        }
        
        // target immobile
<span class="nc bnc" id="L4243" title="All 8 branches missed.">        boolean mekMortarMunitionsIgnoreImmobile = wtype != null &amp;&amp; wtype.hasFlag(WeaponType.F_MEK_MORTAR) </span>
                &amp;&amp; (atype != null) &amp;&amp; (munition == AmmoType.M_AIRBURST);
<span class="nc bnc" id="L4245" title="All 6 branches missed.">        if (wtype != null &amp;&amp; !(wtype instanceof ArtilleryCannonWeapon) &amp;&amp; !mekMortarMunitionsIgnoreImmobile) {</span>
<span class="nc" id="L4246">            ToHitData immobileMod = Compute.getImmobileMod(target, aimingAt, aimingMode);</span>
            // grounded dropships are treated as immobile as well for purpose of
            // the mods
<span class="nc bnc" id="L4249" title="All 8 branches missed.">            if ((null != te) &amp;&amp; !te.isAirborne() &amp;&amp; !te.isSpaceborne() &amp;&amp; (te instanceof Dropship)</span>
<span class="nc bnc" id="L4250" title="All 2 branches missed.">                    &amp;&amp; ((Aero) te).isSpheroid()) {</span>
<span class="nc" id="L4251">                immobileMod = new ToHitData(-4, Messages.getString(&quot;WeaponAttackAction.ImmobileDs&quot;));</span>
            }
<span class="nc bnc" id="L4253" title="All 2 branches missed.">            if (immobileMod != null) {</span>
<span class="nc" id="L4254">                toHit.append(immobileMod);</span>
<span class="nc" id="L4255">                toSubtract += immobileMod.getValue();</span>
            }
        }
        
        // Unit-specific modifiers
        
        // -1 to hit a SuperHeavy mech
<span class="nc bnc" id="L4262" title="All 6 branches missed.">        if (te != null &amp;&amp; (te instanceof Mech) &amp;&amp; ((Mech) te).isSuperHeavy()) {</span>
<span class="nc" id="L4263">            toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.TeSuperheavyMech&quot;));</span>
        }
        
        // Battle Armor targets are hard for Meks and Tanks to hit.
<span class="nc bnc" id="L4267" title="All 6 branches missed.">        if (!isAttackerInfantry &amp;&amp; (te != null) &amp;&amp; (te instanceof BattleArmor)) {</span>
<span class="nc" id="L4268">            toHit.addModifier(1, Messages.getString(&quot;WeaponAttackAction.BaTarget&quot;));</span>
        }

        // infantry squads are also hard to hit
<span class="nc bnc" id="L4272" title="All 8 branches missed.">        if (te != null &amp;&amp; (te instanceof Infantry) &amp;&amp; !(te instanceof BattleArmor) &amp;&amp; ((Infantry) te).isSquad()) {</span>
<span class="nc" id="L4273">            toHit.addModifier(1, Messages.getString(&quot;WeaponAttackAction.SquadTarget&quot;));</span>
        }

        // Ejected MechWarriors are harder to hit
<span class="nc bnc" id="L4277" title="All 4 branches missed.">        if ((te != null) &amp;&amp; (te instanceof MechWarrior)) {</span>
<span class="nc" id="L4278">            toHit.addModifier(2, Messages.getString(&quot;WeaponAttackAction.MwTarget&quot;));</span>
        }
        
        // Aerospace target modifiers
<span class="nc bnc" id="L4282" title="All 6 branches missed.">        if (te != null &amp;&amp; te.isAero() &amp;&amp; te.isAirborne()) {</span>
<span class="nc" id="L4283">            IAero a = (IAero) te;</span>

            // is the target at zero velocity
<span class="nc bnc" id="L4286" title="All 6 branches missed.">            if ((a.getCurrentVelocity() == 0) &amp;&amp; !(a.isSpheroid() &amp;&amp; !game.getBoard().inSpace())) {</span>
<span class="nc" id="L4287">                toHit.addModifier(-2, Messages.getString(&quot;WeaponAttackAction.ImmobileAero&quot;));</span>
            }
            
            // get mods for direction of attack
<span class="nc bnc" id="L4291" title="All 4 branches missed.">            if (!(a.isSpheroid() &amp;&amp; !game.getBoard().inSpace())) {</span>
<span class="nc" id="L4292">                int side = Compute.targetSideTable(ae.getPosition(), te);</span>
                
                // +1 if shooting at an aero approaching nose-on
<span class="nc bnc" id="L4295" title="All 2 branches missed.">                if (side == ToHitData.SIDE_FRONT) {</span>
<span class="nc" id="L4296">                    toHit.addModifier(+1, Messages.getString(&quot;WeaponAttackAction.AeroNoseAttack&quot;));</span>
                }
                // +2 if shooting at the side as it flashes by
<span class="nc bnc" id="L4299" title="All 4 branches missed.">                if ((side == ToHitData.SIDE_LEFT) || (side == ToHitData.SIDE_RIGHT)) {</span>
<span class="nc" id="L4300">                    toHit.addModifier(+2, Messages.getString(&quot;WeaponAttackAction.AeroSideAttack&quot;));</span>
                }
            }

            // Target hidden in the sensor shadow of a larger spacecraft
<span class="nc bnc" id="L4305" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_SENSOR_SHADOW)</span>
<span class="nc bnc" id="L4306" title="All 2 branches missed.">                    &amp;&amp; game.getBoard().inSpace()) {</span>
<span class="nc bnc" id="L4307" title="All 2 branches missed.">                for (Entity en : Compute.getAdjacentEntitiesAlongAttack(ae.getPosition(), target.getPosition(), game)) {</span>
<span class="nc bnc" id="L4308" title="All 4 branches missed.">                    if (!en.isEnemyOf(te) &amp;&amp; en.isLargeCraft() </span>
<span class="nc bnc" id="L4309" title="All 2 branches missed.">                            &amp;&amp; ((en.getWeight() - te.getWeight()) &gt;= -STRATOPS_SENSOR_SHADOW_WEIGHT_DIFF)) {</span>
<span class="nc" id="L4310">                        toHit.addModifier(+1, Messages.getString(&quot;WeaponAttackAction.SensorShadow&quot;));</span>
<span class="nc" id="L4311">                        break;</span>
                    }
<span class="nc" id="L4313">                }</span>
<span class="nc bnc" id="L4314" title="All 2 branches missed.">                for (Entity en : game.getEntitiesVector(target.getPosition())) {</span>
<span class="nc bnc" id="L4315" title="All 6 branches missed.">                    if (!en.isEnemyOf(te) &amp;&amp; en.isLargeCraft() &amp;&amp; !en.equals((Entity) a)</span>
<span class="nc bnc" id="L4316" title="All 2 branches missed.">                            &amp;&amp; ((en.getWeight() - te.getWeight()) &gt;= -STRATOPS_SENSOR_SHADOW_WEIGHT_DIFF)) {</span>
<span class="nc" id="L4317">                        toHit.addModifier(+1, Messages.getString(&quot;WeaponAttackAction.SensorShadow&quot;));</span>
<span class="nc" id="L4318">                        break;</span>
                    }
<span class="nc" id="L4320">                }</span>
            }
        }
        
<span class="nc" id="L4324">        return toHit;</span>
    }
    
    /**
     * Convenience method that compiles the ToHit modifiers applicable to the terrain and line of sight (LOS)
     * Woods along the LOS?  Target Underwater?  Partial cover? You'll find that here.
     * Also, if the to-hit table is changed due to cover/angle/elevation, look here.
     * -4 for shooting at an immobile target?  Using a weapon with a TH penalty?  Those are in other methods.
     * 
     * @param game The current game
     * @param ae The Entity making this attack
     * @param target The Targetable object being attacked
     * @param ttype  The targetable object type
     * @param aElev An int value representing the attacker's elevation
     * @param tElev An int value representing the target's elevation
     * @param targEl An int value representing the target's relative elevation
     * @param distance  The distance in hexes from attacker to target
     * @param los The calculated LOS between attacker and target
     * @param toHit The running total ToHitData for this WeaponAttackAction
     * @param losMods A cached set of LOS-related modifiers
     * @param toSubtract An int value representing a running total of mods to disregard - used for some special attacks
     * 
     * @param eistatus An int value representing the ei cockpit/pilot upgrade status
     * 
     * @param wtype The WeaponType of the weapon being used
     * @param weapon The Mounted weapon being used
     * @param weaponId  The id number of the weapon being used - used by some external calculations 
     * @param atype The AmmoType being used for this attack
     * @param munition  Long indicating the munition type flag being used, if applicable
     * 
     * @param inSameBuilding  flag that indicates whether this attack originates from within the same building
     * @param isIndirect  flag that indicates whether this is an indirect attack (LRM, mortar...)
     * @param isPointBlankShot  flag that indicates whether or not this is a PBS by a hidden unit
     * @param underWater  flag that indicates whether the weapon being used is underwater
     */
    private static ToHitData compileTerrainAndLosToHitMods(IGame game, Entity ae, Targetable target, int ttype, int aElev, int tElev,
                int targEl, int distance, LosEffects los, ToHitData toHit, ToHitData losMods, int toSubtract, int eistatus,
                WeaponType wtype, Mounted weapon, int weaponId, AmmoType atype, long munition, boolean isAttackerInfantry,
                boolean inSameBuilding, boolean isIndirect, boolean isPointBlankShot, boolean underWater) {
<span class="nc bnc" id="L4363" title="All 4 branches missed.">        if (ae == null || target == null) {</span>
            // Can't handle these attacks without a valid attacker and target
<span class="nc" id="L4365">            return toHit;</span>
        }
        
<span class="nc bnc" id="L4368" title="All 2 branches missed.">        if (toHit == null) {</span>
            // Without valid toHit data, the rest of this will fail
<span class="nc" id="L4370">            toHit = new ToHitData();</span>
        }
        
        //Target's hex
<span class="nc" id="L4374">        IHex targHex = game.getBoard().getHex(target.getPosition());</span>
        
<span class="nc bnc" id="L4376" title="All 4 branches missed.">        boolean targetHexContainsWater = targHex != null &amp;&amp; targHex.containsTerrain(Terrains.WATER);</span>
<span class="nc bnc" id="L4377" title="All 4 branches missed.">        boolean targetHexContainsFortified = targHex != null &amp;&amp; targHex.containsTerrain(Terrains.FORTIFIED);</span>
        
<span class="nc" id="L4379">        Entity te = null;</span>
<span class="nc bnc" id="L4380" title="All 2 branches missed.">        if (ttype == Targetable.TYPE_ENTITY) {</span>
            //Some of these weapons only target valid entities
<span class="nc" id="L4382">            te = (Entity) target;</span>
        }
        
        // Add range mods - If the attacker and target are in the same building
        // &amp; hex, range mods don't apply (and will cause the shot to fail)
        // Don't apply this to bomb attacks either, which are going to be at 0 range of necessity
<span class="nc bnc" id="L4388" title="All 6 branches missed.">        if (((los.getThruBldg() == null) || !los.getTargetPosition().equals(ae.getPosition()))</span>
                &amp;&amp; (wtype != null 
<span class="nc bnc" id="L4390" title="All 6 branches missed.">                    &amp;&amp; (!(wtype.hasFlag(WeaponType.F_ALT_BOMB) || wtype.hasFlag(WeaponType.F_DIVE_BOMB))))</span>
                &amp;&amp; weaponId &gt; WeaponType.WEAPON_NA) {
<span class="nc" id="L4392">            toHit.append(Compute.getRangeMods(game, ae, weaponId, target));</span>
        }
        
        // add in LOS mods that we've been keeping
<span class="nc" id="L4396">        toHit.append(losMods);</span>
        
        // Attacker Terrain
<span class="nc" id="L4399">        toHit.append(Compute.getAttackerTerrainModifier(game, ae.getId()));</span>
        
        // Target Terrain
        
        // BMM p. 31, semi-guided indirect missile attacks vs tagged targets ignore terrain modifiers
<span class="nc bnc" id="L4404" title="All 4 branches missed.">        boolean semiGuidedIndirectVsTaggedTarget = isIndirect &amp;&amp; </span>
<span class="nc bnc" id="L4405" title="All 2 branches missed.">                (atype != null) &amp;&amp; atype.getMunitionType() == AmmoType.M_SEMIGUIDED &amp;&amp; </span>
<span class="nc bnc" id="L4406" title="All 2 branches missed.">                        Compute.isTargetTagged(target, game);</span>
        
        // Base terrain calculations, not applicable when delivering minefields or bombs
        // also not applicable in pointblank shots from hidden units
<span class="nc bnc" id="L4410" title="All 6 branches missed.">        if ((ttype != Targetable.TYPE_MINEFIELD_DELIVER) &amp;&amp; !isPointBlankShot &amp;&amp; !semiGuidedIndirectVsTaggedTarget) {</span>
<span class="nc" id="L4411">            toHit.append(Compute.getTargetTerrainModifier(game, target, eistatus, inSameBuilding, underWater));</span>
<span class="nc" id="L4412">            toSubtract += Compute.getTargetTerrainModifier(game, target, eistatus, inSameBuilding, underWater)</span>
<span class="nc" id="L4413">                    .getValue();</span>
        }
        
        // Fortified/Dug-In Infantry
<span class="nc bnc" id="L4417" title="All 6 branches missed.">        if ((target instanceof Infantry) &amp;&amp; wtype != null &amp;&amp; !wtype.hasFlag(WeaponType.F_FLAMER)) {</span>
<span class="nc bnc" id="L4418" title="All 2 branches missed.">            if (targetHexContainsFortified</span>
<span class="nc bnc" id="L4419" title="All 2 branches missed.">                    || (((Infantry) target).getDugIn() == Infantry.DUG_IN_COMPLETE)) {</span>
<span class="nc" id="L4420">                toHit.addModifier(2, Messages.getString(&quot;WeaponAttackAction.DugInInf&quot;));</span>
            }
        }

        // target in water?
<span class="nc" id="L4425">        int partialWaterLevel = 1;</span>
<span class="nc bnc" id="L4426" title="All 6 branches missed.">        if (te != null &amp;&amp; (te instanceof Mech) &amp;&amp; ((Mech) te).isSuperHeavy()) {</span>
<span class="nc" id="L4427">            partialWaterLevel = 2;</span>
        }
<span class="nc bnc" id="L4429" title="All 4 branches missed.">        if ((te != null) &amp;&amp; targetHexContainsWater</span>
                // target in partial water
<span class="nc bnc" id="L4431" title="All 6 branches missed.">                &amp;&amp; (targHex.terrainLevel(Terrains.WATER) == partialWaterLevel) &amp;&amp; (targEl == 0) &amp;&amp; (te.height() &gt; 0)) { </span>
<span class="nc" id="L4432">            los.setTargetCover(los.getTargetCover() | LosEffects.COVER_HORIZONTAL);</span>
<span class="nc" id="L4433">            losMods = los.losModifiers(game, eistatus, underWater);</span>
        }
        
        // Change hit table for partial cover, accomodate for partial
        // underwater(legs)
<span class="nc bnc" id="L4438" title="All 2 branches missed.">        if (los.getTargetCover() != LosEffects.COVER_NONE) {</span>
<span class="nc bnc" id="L4439" title="All 8 branches missed.">            if (underWater &amp;&amp; (targetHexContainsWater &amp;&amp; (targEl == 0) </span>
<span class="nc bnc" id="L4440" title="All 2 branches missed.">                    &amp;&amp; (te != null &amp;&amp; te.height() &gt; 0))) {</span>
                // weapon underwater, target in partial water
<span class="nc" id="L4442">                toHit.setHitTable(ToHitData.HIT_PARTIAL_COVER);</span>
<span class="nc" id="L4443">                toHit.setCover(LosEffects.COVER_UPPER);</span>
            } else {
<span class="nc bnc" id="L4445" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_PARTIAL_COVER)) {</span>
<span class="nc" id="L4446">                    toHit.setHitTable(ToHitData.HIT_PARTIAL_COVER);</span>
<span class="nc" id="L4447">                    toHit.setCover(los.getTargetCover());</span>
                } else {
<span class="nc" id="L4449">                    toHit.setHitTable(ToHitData.HIT_PARTIAL_COVER);</span>
<span class="nc" id="L4450">                    toHit.setCover(LosEffects.COVER_HORIZONTAL);</span>
                }
                // Set damagable cover state information
<span class="nc" id="L4453">                toHit.setDamagableCoverTypePrimary(los.getDamagableCoverTypePrimary());</span>
<span class="nc" id="L4454">                toHit.setCoverLocPrimary(los.getCoverLocPrimary());</span>
<span class="nc" id="L4455">                toHit.setCoverDropshipPrimary(los.getCoverDropshipPrimary());</span>
<span class="nc" id="L4456">                toHit.setCoverBuildingPrimary(los.getCoverBuildingPrimary());</span>
<span class="nc" id="L4457">                toHit.setDamagableCoverTypeSecondary(los.getDamagableCoverTypeSecondary());</span>
<span class="nc" id="L4458">                toHit.setCoverLocSecondary(los.getCoverLocSecondary());</span>
<span class="nc" id="L4459">                toHit.setCoverDropshipSecondary(los.getCoverDropshipSecondary());</span>
<span class="nc" id="L4460">                toHit.setCoverBuildingSecondary(los.getCoverBuildingSecondary());</span>
            }
        }
        
        // Special Equipment
        
        // if we have BAP and there are woods in the
        // way, and we are within BAP range, we reduce the BTH by 1
        // Per TacOps errata, this bonus also applies to all units on the same C3 network
<span class="nc bnc" id="L4469" title="All 6 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_BAP) &amp;&amp; !isIndirect &amp;&amp; (te != null)</span>
<span class="nc bnc" id="L4470" title="All 4 branches missed.">                &amp;&amp; ae.hasBAP() &amp;&amp; (ae.getBAPRange() &gt;= Compute.effectiveDistance(game, ae, te))</span>
<span class="nc bnc" id="L4471" title="All 2 branches missed.">                &amp;&amp; !ComputeECM.isAffectedByECM(ae, ae.getPosition(), te.getPosition())</span>
<span class="nc bnc" id="L4472" title="All 2 branches missed.">                &amp;&amp; (game.getBoard().getHex(te.getPosition()).containsTerrain(Terrains.WOODS)</span>
<span class="nc bnc" id="L4473" title="All 2 branches missed.">                        || game.getBoard().getHex(te.getPosition()).containsTerrain(Terrains.JUNGLE)</span>
<span class="nc bnc" id="L4474" title="All 6 branches missed.">                        || (los.getLightWoods() &gt; 0) || (los.getHeavyWoods() &gt; 0) || (los.getUltraWoods() &gt; 0))</span>
<span class="nc bnc" id="L4475" title="All 2 branches missed.">                || ae.hasNetworkBAP()) {</span>
<span class="nc bnc" id="L4476" title="All 2 branches missed.">            if (ae.hasBAP()) {</span>
                // If you want the bonus, the entity with the BAP should fire first. 
                // Not sure how to get around this
<span class="nc bnc" id="L4479" title="All 2 branches missed.">                for (Entity en : game.getC3NetworkMembers(ae)) {</span>
<span class="nc" id="L4480">                    en.setNetworkBAP(true);</span>
<span class="nc" id="L4481">                }</span>
            }
<span class="nc" id="L4483">            toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.BAPInWoods&quot;));</span>
        }
        
        // To-hit table changes with no to-hit modifiers
        
        // Aeros in air-to-air combat can hit above and below
<span class="nc bnc" id="L4489" title="All 2 branches missed.">        if (Compute.isAirToAir(ae, target)) {</span>
<span class="nc bnc" id="L4490" title="All 2 branches missed.">            if ((ae.getAltitude() - target.getAltitude()) &gt; 2) {</span>
<span class="nc" id="L4491">                toHit.setHitTable(ToHitData.HIT_ABOVE);</span>
<span class="nc bnc" id="L4492" title="All 2 branches missed.">            } else if ((target.getAltitude() - ae.getAltitude()) &gt; 2) {</span>
<span class="nc" id="L4493">                toHit.setHitTable(ToHitData.HIT_BELOW);</span>
<span class="nc bnc" id="L4494" title="All 4 branches missed.">            } else if (((ae.getAltitude() - target.getAltitude()) &gt; 0) </span>
<span class="nc bnc" id="L4495" title="All 4 branches missed.">                    &amp;&amp; te != null &amp;&amp; (te.isAero() &amp;&amp; ((IAero) te).isSpheroid())) {</span>
<span class="nc" id="L4496">                toHit.setHitTable(ToHitData.HIT_ABOVE);</span>
<span class="nc bnc" id="L4497" title="All 4 branches missed.">            } else if (((ae.getAltitude() - target.getAltitude()) &lt; 0) </span>
<span class="nc bnc" id="L4498" title="All 4 branches missed.">                    &amp;&amp; te != null &amp;&amp; (te.isAero() &amp;&amp; ((IAero) te).isSpheroid())) {</span>
<span class="nc" id="L4499">                toHit.setHitTable(ToHitData.HIT_BELOW);</span>
            }
        }
        
        // Change hit table for elevation differences inside building.
<span class="nc bnc" id="L4504" title="All 4 branches missed.">        if ((null != los.getThruBldg()) &amp;&amp; (aElev != tElev)) {</span>

            // Tanks get hit in a random side.
<span class="nc bnc" id="L4507" title="All 2 branches missed.">            if (target instanceof Tank) {</span>
<span class="nc" id="L4508">                toHit.setSideTable(ToHitData.SIDE_RANDOM);</span>
<span class="nc bnc" id="L4509" title="All 2 branches missed.">            } else if (target instanceof Mech) {</span>
                // Meks have special tables for shots from above and below.
<span class="nc bnc" id="L4511" title="All 2 branches missed.">                if (aElev &gt; tElev) {</span>
<span class="nc" id="L4512">                    toHit.setHitTable(ToHitData.HIT_ABOVE);</span>
                } else {
<span class="nc" id="L4514">                    toHit.setHitTable(ToHitData.HIT_BELOW);</span>
                }
            }
        }
        
        // Ground-to-air attacks always hit from below
<span class="nc bnc" id="L4520" title="All 4 branches missed.">        if (Compute.isGroundToAir(ae, target) &amp;&amp; ((ae.getAltitude() - target.getAltitude()) &gt; 2)) {</span>
<span class="nc" id="L4521">            toHit.setHitTable(ToHitData.HIT_BELOW);</span>
        }
        
        // factor in target side
<span class="nc bnc" id="L4525" title="All 4 branches missed.">        if (isAttackerInfantry &amp;&amp; (0 == distance)) {</span>
            // Infantry attacks from the same hex are resolved against the
            // front.
<span class="nc" id="L4528">            toHit.setSideTable(ToHitData.SIDE_FRONT);</span>
        } else {
<span class="nc bnc" id="L4530" title="All 2 branches missed.">            if (weapon != null) {</span>
<span class="nc" id="L4531">                toHit.setSideTable(Compute.targetSideTable(ae, target, weapon.getCalledShot().getCall()));</span>
            }
        }
        
        // Change hit table for surface naval vessels hit by underwater attacks
<span class="nc bnc" id="L4536" title="All 8 branches missed.">        if (underWater &amp;&amp; targetHexContainsWater &amp;&amp; (null != te) &amp;&amp; te.isSurfaceNaval()) {</span>
<span class="nc" id="L4537">            toHit.setHitTable(ToHitData.HIT_UNDERWATER);</span>
        }
        
<span class="nc" id="L4540">        return toHit;</span>
    }
    
    /**
     * If you're using a weapon that does something totally special and doesn't apply mods like everything else, look here
     * 
     * @param game The current game
     * @param ae The Entity making this attack
     * @param target The Targetable object being attacked
     * @param ttype  The targetable object type
     * @param los The calculated LOS between attacker and target
     * @param toHit The running total ToHitData for this WeaponAttackAction
     * 
     * @param wtype The WeaponType of the weapon being used
     * @param atype The AmmoType being used for this attack
     * @param srt  Class that stores whether or not this WAA should return a special resolution
     */
    private static ToHitData handleSpecialWeaponAttacks(IGame game, Entity ae, Targetable target, int ttype,
                LosEffects los, ToHitData toHit, WeaponType wtype, AmmoType atype, SpecialResolutionTracker srt) {
<span class="nc bnc" id="L4559" title="All 2 branches missed.">        if (ae == null) {</span>
            //*Should* be impossible at this point in the process
<span class="nc" id="L4561">            return toHit;</span>
        }
        
<span class="nc" id="L4564">        Entity te = null;</span>
<span class="nc bnc" id="L4565" title="All 2 branches missed.">        if (ttype == Targetable.TYPE_ENTITY) {</span>
            //Some of these weapons only target valid entities
<span class="nc" id="L4567">            te = (Entity) target;</span>
        }
        
<span class="nc bnc" id="L4570" title="All 2 branches missed.">        if (toHit == null) {</span>
            // Without valid toHit data, the rest of this will fail
<span class="nc" id="L4572">            toHit = new ToHitData();</span>
        }
        
        // Battle Armor bomb racks (Micro bombs) use gunnery skill and no other mods per TWp228 2018 errata
<span class="nc bnc" id="L4576" title="All 4 branches missed.">        if ((atype != null) &amp;&amp; (atype.getAmmoType() == AmmoType.T_BA_MICRO_BOMB)) {</span>
<span class="nc bnc" id="L4577" title="All 2 branches missed.">            if (ae.getPosition().equals(target.getPosition())) {</span>
<span class="nc" id="L4578">                toHit = new ToHitData(ae.getCrew().getPiloting(), Messages.getString(&quot;WeaponAttackAction.GunSkill&quot;));</span>
            } else { 
<span class="nc" id="L4580">                toHit = new ToHitData(TargetRoll.IMPOSSIBLE, Messages.getString(&quot;WeaponAttackAction.OutOfRange&quot;));</span>
            }
<span class="nc" id="L4582">            srt.setSpecialResolution(true);</span>
<span class="nc" id="L4583">            return toHit;</span>
        }
        
        // Engineer's fire extinguisher has fixed to hit number,
        // Note that coolant trucks make a regular attack.
<span class="nc bnc" id="L4588" title="All 2 branches missed.">        if (wtype.hasFlag(WeaponType.F_EXTINGUISHER)) {</span>
<span class="nc" id="L4589">            toHit = new ToHitData(8, Messages.getString(&quot;WeaponAttackAction.FireExt&quot;));</span>
<span class="nc bnc" id="L4590" title="All 6 branches missed.">            if (((target instanceof Entity) &amp;&amp; ((Entity) target).infernos.isStillBurning())</span>
<span class="nc bnc" id="L4591" title="All 2 branches missed.">                    || ((target instanceof Tank) &amp;&amp; ((Tank) target).isInfernoFire())) {</span>
<span class="nc" id="L4592">                toHit.addModifier(2, Messages.getString(&quot;WeaponAttackAction.PutOutInferno&quot;));</span>
            }
<span class="nc bnc" id="L4594" title="All 2 branches missed.">            if ((target.getTargetType() == Targetable.TYPE_HEX_EXTINGUISH)</span>
<span class="nc bnc" id="L4595" title="All 2 branches missed.">                    &amp;&amp; game.getBoard().isInfernoBurning(target.getPosition())) {</span>
<span class="nc" id="L4596">                toHit.addModifier(2, Messages.getString(&quot;WeaponAttackAction.PutOutInferno&quot;));</span>
            }
<span class="nc" id="L4598">            srt.setSpecialResolution(true);</span>
<span class="nc" id="L4599">            return toHit;</span>
        }
        
        // if this is a space bombing attack then get the to hit and return
<span class="nc bnc" id="L4603" title="All 2 branches missed.">        if (wtype.hasFlag(WeaponType.F_SPACE_BOMB)) {</span>
<span class="nc bnc" id="L4604" title="All 2 branches missed.">            if (te != null) {</span>
<span class="nc" id="L4605">                toHit = Compute.getSpaceBombBaseToHit(ae, te, game);</span>
<span class="nc" id="L4606">                srt.setSpecialResolution(true);</span>
<span class="nc" id="L4607">                return toHit;</span>
            }
        }
        //If we get here, no special weapons apply. Return the input data and continue on
<span class="nc" id="L4611">        return toHit;</span>
    }
    
    /**
     * Convenience method that compiles the ToHit modifiers applicable to infantry/BA swarm attacks
     * 
     * @param game The current game
     * @param ae The Entity making this attack
     * @param target The Targetable object being attacked
     * @param ttype  The targetable object type
     * @param toHit The running total ToHitData for this WeaponAttackAction
     * 
     * @param wtype The WeaponType of the weapon being used
     * @param srt  Class that stores whether or not this WAA should return a special resolution
     */
    private static ToHitData handleInfantrySwarmAttacks(IGame game, Entity ae, Targetable target,
                int ttype, ToHitData toHit, WeaponType wtype, SpecialResolutionTracker srt)  {
<span class="nc bnc" id="L4628" title="All 2 branches missed.">        if (ae == null) {</span>
            //*Should* be impossible at this point in the process
<span class="nc" id="L4630">            return toHit;</span>
        }
<span class="nc bnc" id="L4632" title="All 4 branches missed.">        if (target == null || ttype != Targetable.TYPE_ENTITY) {</span>
            //Can only swarm a valid entity target
<span class="nc" id="L4634">            return toHit;</span>
        }
        
<span class="nc bnc" id="L4637" title="All 2 branches missed.">        if (toHit == null) {</span>
            // Without valid toHit data, the rest of this will fail
<span class="nc" id="L4639">            toHit = new ToHitData();</span>
        }
        
<span class="nc" id="L4642">        Entity te = (Entity) target;</span>
        // Leg attacks and Swarm attacks have their own base toHit values
<span class="nc bnc" id="L4644" title="All 2 branches missed.">        if (Infantry.LEG_ATTACK.equals(wtype.getInternalName())) {</span>
<span class="nc" id="L4645">            toHit = Compute.getLegAttackBaseToHit(ae, te, game);</span>
<span class="nc bnc" id="L4646" title="All 4 branches missed.">            if ((te instanceof Mech) &amp;&amp; ((Mech) te).isSuperHeavy()) {</span>
<span class="nc" id="L4647">                toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.TeSuperheavyMech&quot;));</span>
            }
<span class="nc" id="L4649">            srt.setSpecialResolution(true);</span>
<span class="nc" id="L4650">            return toHit;</span>

<span class="nc bnc" id="L4652" title="All 2 branches missed.">        } else if (Infantry.SWARM_MEK.equals(wtype.getInternalName())) {</span>
<span class="nc" id="L4653">            toHit = Compute.getSwarmMekBaseToHit(ae, te, game);</span>
<span class="nc bnc" id="L4654" title="All 2 branches missed.">            if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L4655">                srt.setSpecialResolution(true);</span>
<span class="nc" id="L4656">                return toHit;</span>
            }

<span class="nc bnc" id="L4659" title="All 2 branches missed.">            if (te instanceof Tank) {</span>
<span class="nc" id="L4660">                toHit.addModifier(-2, Messages.getString(&quot;WeaponAttackAction.TeVehicle&quot;));</span>
            }
<span class="nc bnc" id="L4662" title="All 4 branches missed.">            if ((te instanceof Mech) &amp;&amp; ((Mech) te).isSuperHeavy()) {</span>
<span class="nc" id="L4663">                toHit.addModifier(-1, Messages.getString(&quot;WeaponAttackAction.TeSuperheavyMech&quot;));</span>
            }

            // If the defender carries mechanized BA, they can fight off the
            // swarm
<span class="nc bnc" id="L4668" title="All 2 branches missed.">            for (Entity e : te.getExternalUnits()) {</span>
<span class="nc bnc" id="L4669" title="All 2 branches missed.">                if (e instanceof BattleArmor) {</span>
<span class="nc" id="L4670">                    BattleArmor ba = (BattleArmor) e;</span>
<span class="nc" id="L4671">                    int def = ba.getShootingStrength();</span>
<span class="nc" id="L4672">                    int att = ((Infantry) ae).getShootingStrength();</span>
<span class="nc bnc" id="L4673" title="All 2 branches missed.">                    if (!(ae instanceof BattleArmor)) {</span>
<span class="nc bnc" id="L4674" title="All 2 branches missed.">                        if (att &gt;= 28) {</span>
<span class="nc" id="L4675">                            att = 5;</span>
<span class="nc bnc" id="L4676" title="All 2 branches missed.">                        } else if (att &gt;= 24) {</span>
<span class="nc" id="L4677">                            att = 4;</span>
<span class="nc bnc" id="L4678" title="All 2 branches missed.">                        } else if (att &gt;= 21) {</span>
<span class="nc" id="L4679">                            att = 3;</span>
<span class="nc bnc" id="L4680" title="All 2 branches missed.">                        } else if (att &gt;= 18) {</span>
<span class="nc" id="L4681">                            att = 2;</span>
                        } else {
<span class="nc" id="L4683">                            att = 1;</span>
                        }
                    }
<span class="nc" id="L4686">                    def = (def + 2) - att;</span>
<span class="nc bnc" id="L4687" title="All 2 branches missed.">                    if (def &gt; 0) {</span>
<span class="nc" id="L4688">                        toHit.addModifier(def, Messages.getString(&quot;WeaponAttackAction.DefendingBA&quot;));</span>
                    }
                }
<span class="nc" id="L4691">            }</span>
<span class="nc" id="L4692">            srt.setSpecialResolution(true);</span>
<span class="nc" id="L4693">            return toHit;</span>
<span class="nc bnc" id="L4694" title="All 2 branches missed.">        } else if (Infantry.STOP_SWARM.equals(wtype.getInternalName())) {</span>
            // Can't stop if we're not swarming, otherwise automatic.
<span class="nc" id="L4696">            srt.setSpecialResolution(true);</span>
<span class="nc" id="L4697">            return new ToHitData(TargetRoll.AUTOMATIC_SUCCESS, Messages.getString(&quot;WeaponAttackAction.EndSwarm&quot;));</span>
        }
        // Swarming infantry always hit their target, but
        // they can only target the Mek they're swarming.
<span class="nc bnc" id="L4701" title="All 2 branches missed.">        else if ((ae.getSwarmTargetId() == te.getId())) {</span>
<span class="nc bnc" id="L4702" title="All 2 branches missed.">            int side = te instanceof Tank ? ToHitData.SIDE_RANDOM : ToHitData.SIDE_FRONT;</span>
<span class="nc bnc" id="L4703" title="All 2 branches missed.">            if (ae instanceof BattleArmor) {</span>
<span class="nc bnc" id="L4704" title="All 4 branches missed.">                if (!Infantry.SWARM_WEAPON_MEK.equals(wtype.getInternalName()) &amp;&amp; !(wtype instanceof InfantryAttack)) {</span>
<span class="nc" id="L4705">                    srt.setSpecialResolution(true);</span>
<span class="nc" id="L4706">                    return new ToHitData(TargetRoll.IMPOSSIBLE, Messages.getString(&quot;WeaponAttackAction.WrongSwarmUse&quot;));</span>
                }
<span class="nc" id="L4708">                srt.setSpecialResolution(true);</span>
<span class="nc" id="L4709">                return new ToHitData(TargetRoll.AUTOMATIC_SUCCESS, Messages.getString(&quot;WeaponAttackAction.SwarmingAutoHit&quot;), ToHitData.HIT_SWARM,</span>
                        side);
            }
<span class="nc" id="L4712">            srt.setSpecialResolution(true);</span>
<span class="nc" id="L4713">            return new ToHitData(TargetRoll.AUTOMATIC_SUCCESS, Messages.getString(&quot;WeaponAttackAction.SwarmingAutoHit&quot;), ToHitData.HIT_SWARM_CONVENTIONAL, side);</span>
        }
        //If we get here, no swarm attack applies
<span class="nc" id="L4716">        return toHit;</span>
    }
    
    /**
     * Method to handle modifiers for swarm missile secondary targets
     * 
     * @param game The current game
     * @param ae The Entity making this attack
     * @param target The Targetable object being attacked
     * @param swarmPrimaryTarget The original Targetable object being attacked
     * @param swarmSecondaryTarget The current Targetable object being attacked
     * @param toHit The running total ToHitData for this WeaponAttackAction
     * @param toSubtract An int value representing a running total of mods to disregard
     * 
     * @param eistatus An int value representing the ei cockpit/pilot upgrade status - used for terrain calculation
     * @param aimingAt  An int value representing the location being aimed at - used for immobile target
     * @param aimingMode  An int value that determines the reason aiming is allowed - used for immobile target
     * 
     * @param weapon The Mounted weapon being used
     * @param atype The AmmoType being used for this attack
     * @param munition  Long indicating the munition type flag being used, if applicable
     * 
     * @param isECMAffected flag that indicates whether the target is inside an ECM bubble
     * @param inSameBuilding  flag that indicates whether this attack originates from within the same building
     * @param underWater  flag that indicates whether the weapon being used is underwater
     */
    private static ToHitData handleSwarmSecondaryAttacks(IGame game, Entity ae, Targetable target,
                Targetable swarmPrimaryTarget, Targetable swarmSecondaryTarget, ToHitData toHit,
                int toSubtract, int eistatus, int aimingAt, int aimingMode, Mounted weapon, AmmoType atype,
                long munition, boolean isECMAffected, boolean inSameBuilding, boolean underWater) {
        
<span class="nc bnc" id="L4747" title="All 6 branches missed.">        if (ae == null || swarmPrimaryTarget == null || swarmSecondaryTarget == null) {</span>
            // This method won't work without these 3 things
<span class="nc" id="L4749">            return toHit;</span>
        }
        
<span class="nc bnc" id="L4752" title="All 2 branches missed.">        if (toHit == null) {</span>
            // Without valid toHit data, the rest of this will fail
<span class="nc" id="L4754">            toHit = new ToHitData();</span>
        }
        
<span class="nc" id="L4757">        toHit.addModifier(-toSubtract, Messages.getString(&quot;WeaponAttackAction.OriginalTargetMods&quot;));</span>
<span class="nc" id="L4758">        toHit.append(Compute.getImmobileMod(swarmSecondaryTarget, aimingAt, aimingMode));</span>
<span class="nc" id="L4759">        toHit.append(Compute.getTargetTerrainModifier(game,</span>
<span class="nc" id="L4760">                game.getTarget(swarmSecondaryTarget.getTargetType(), swarmSecondaryTarget.getTargetId()), eistatus,</span>
                inSameBuilding, underWater));
<span class="nc" id="L4762">        toHit.setCover(LosEffects.COVER_NONE);</span>
        
<span class="nc" id="L4764">        IHex targHex = game.getBoard().getHex(swarmSecondaryTarget.getPosition());</span>
<span class="nc" id="L4765">        int targEl = swarmSecondaryTarget.relHeight();</span>
<span class="nc" id="L4766">        int distance = Compute.effectiveDistance(game, ae, swarmSecondaryTarget);</span>
        
<span class="nc" id="L4768">        Entity te = null;</span>
<span class="nc bnc" id="L4769" title="All 2 branches missed.">        if (swarmSecondaryTarget.getTargetType() == Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L4770">            te = (Entity) target;</span>
        }

        // We might not attack the new target from the same side as the
        // old, so recalculate; the attack *direction* is still traced from
        // the original source.
<span class="nc" id="L4776">        toHit.setSideTable(Compute.targetSideTable(ae, swarmSecondaryTarget));</span>

        // Secondary swarm LRM attacks are never called shots even if the
        // initial one was.
<span class="nc bnc" id="L4780" title="All 4 branches missed.">        if (weapon != null &amp;&amp; weapon.getCalledShot().getCall() != CalledShot.CALLED_NONE) {</span>
<span class="nc" id="L4781">            weapon.getCalledShot().reset();</span>
<span class="nc" id="L4782">            toHit.setHitTable(ToHitData.HIT_NORMAL);</span>
        }

        LosEffects swarmlos;
        // TO makes it seem like the terrain modifers should be between the
        // attacker and the secondary target, but we have received rules
        // clarifications on the old forums indicating that this is correct
<span class="nc bnc" id="L4789" title="All 2 branches missed.">        if (swarmPrimaryTarget.getTargetType() != Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L4790">            swarmlos = LosEffects.calculateLos(game, swarmSecondaryTarget.getTargetId(), target);</span>
        } else {
<span class="nc" id="L4792">            swarmlos = LosEffects.calculateLos(game, swarmPrimaryTarget.getTargetId(), swarmSecondaryTarget);</span>
        }

        // reset cover
<span class="nc bnc" id="L4796" title="All 2 branches missed.">        if (swarmlos.getTargetCover() != LosEffects.COVER_NONE) {</span>
<span class="nc bnc" id="L4797" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_PARTIAL_COVER)) {</span>
<span class="nc" id="L4798">                toHit.setHitTable(ToHitData.HIT_PARTIAL_COVER);</span>
<span class="nc" id="L4799">                toHit.setCover(swarmlos.getTargetCover());</span>
            } else {
<span class="nc" id="L4801">                toHit.setHitTable(ToHitData.HIT_PARTIAL_COVER);</span>
<span class="nc" id="L4802">                toHit.setCover(LosEffects.COVER_HORIZONTAL);</span>
            }
        }
        // target in water?
<span class="nc bnc" id="L4806" title="All 2 branches missed.">        if (swarmSecondaryTarget.getTargetType() == Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L4807">            Entity oldEnt = game.getEntity(swarmSecondaryTarget.getTargetId());</span>
<span class="nc" id="L4808">            toHit.append(Compute.getTargetMovementModifier(game, oldEnt.getId()));</span>
            // target in partial water - depth 1 for most units
<span class="nc" id="L4810">            int partialWaterLevel = 1;</span>
            // Depth 2 for superheavy mechs
<span class="nc bnc" id="L4812" title="All 6 branches missed.">            if (te != null &amp;&amp; (te instanceof Mech) &amp;&amp; ((Mech) te).isSuperHeavy()) {</span>
<span class="nc" id="L4813">                partialWaterLevel = 2;</span>
            }
<span class="nc bnc" id="L4815" title="All 2 branches missed.">            if (targHex.containsTerrain(Terrains.WATER)</span>
<span class="nc bnc" id="L4816" title="All 4 branches missed.">                    &amp;&amp; (targHex.terrainLevel(Terrains.WATER) == partialWaterLevel) &amp;&amp; (targEl == 0)</span>
<span class="nc bnc" id="L4817" title="All 2 branches missed.">                    &amp;&amp; (oldEnt.height() &gt; 0)) {</span>
<span class="nc" id="L4818">                toHit.setCover(toHit.getCover() | LosEffects.COVER_HORIZONTAL);</span>
            }
            // Prone
<span class="nc" id="L4821">            ToHitData proneMod = new ToHitData();</span>
<span class="nc bnc" id="L4822" title="All 2 branches missed.">            if (oldEnt.isProne()) {</span>
                // easier when point-blank
<span class="nc bnc" id="L4824" title="All 2 branches missed.">                if (distance &lt;= 1) {</span>
<span class="nc" id="L4825">                    proneMod = new ToHitData(-2, Messages.getString(&quot;WeaponAttackAction.ProneAdj&quot;));</span>
                } else {
                    // Harder at range.
<span class="nc" id="L4828">                    proneMod = new ToHitData(1, Messages.getString(&quot;WeaponAttackAction.ProneRange&quot;));</span>
                }
            }
            // I-Swarm bonus
<span class="nc" id="L4832">            toHit.append(proneMod);</span>
<span class="nc bnc" id="L4833" title="All 6 branches missed.">            if (!isECMAffected &amp;&amp; (atype != null) &amp;&amp; !oldEnt.isEnemyOf(ae)</span>
<span class="nc bnc" id="L4834" title="All 4 branches missed.">                    &amp;&amp; !(oldEnt.getBadCriticals(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_SENSORS, Mech.LOC_HEAD) &gt; 0)</span>
                    &amp;&amp; (munition == AmmoType.M_SWARM_I)) {
<span class="nc" id="L4836">                toHit.addModifier(+2, Messages.getString(&quot;WeaponAttackAction.SwarmIFriendly&quot;));</span>
            }
        }
<span class="nc" id="L4839">        return toHit;</span>
    }
    
    /**
     * Convenience method that compiles the ToHit modifiers applicable to artillery attacks
     * 
     * @param game The current game
     * @param ae The Entity making this attack
     * @param target The Targetable object being attacked
     * @param ttype  The targetable object type
     * @param toHit The running total ToHitData for this WeaponAttackAction
     * 
     * @param wtype The WeaponType of the weapon being used
     * @param weapon The Mounted weapon being used
     * @param atype The AmmoType being used for this attack
     * 
     * @param isArtilleryDirect  flag that indicates whether this is a direct-fire artillery attack
     * @param isArtilleryFLAK   flag that indicates whether this is a flak artillery attack
     * @param isArtilleryIndirect  flag that indicates whether this is an indirect-fire artillery attack
     * @param isHoming flag that indicates whether this is a homing missile/copperhead shot
     * @param usesAmmo  flag that indicates if the WeaponType being used is ammo-fed
     * @param srt  Class that stores whether or not this WAA should return a special resolution
     */
    private static ToHitData handleArtilleryAttacks(IGame game, Entity ae, Targetable target, int ttype, 
                ToHitData losMods, ToHitData toHit, WeaponType wtype, Mounted weapon, AmmoType atype, 
                boolean isArtilleryDirect, boolean isArtilleryFLAK, boolean isArtilleryIndirect, boolean isHoming,
                boolean usesAmmo, SpecialResolutionTracker srt) {
<span class="nc" id="L4866">        Entity te = null;</span>
<span class="nc bnc" id="L4867" title="All 2 branches missed.">        if (ttype == Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L4868">            te = (Entity) target;</span>
        }
        
<span class="nc bnc" id="L4871" title="All 2 branches missed.">        if (toHit == null) {</span>
            // Without valid toHit data, the rest of this will fail
<span class="nc" id="L4873">            toHit = new ToHitData();</span>
        }
        
        //Homing warheads just need a flat 4 to seek out a successful TAG
<span class="nc bnc" id="L4877" title="All 2 branches missed.">        if (isHoming) {  </span>
<span class="nc" id="L4878">            srt.setSpecialResolution(true);</span>
<span class="nc" id="L4879">            return new ToHitData(4, Messages.getString(&quot;WeaponAttackAction.HomingArty&quot;));</span>
        }
        
        //Don't bother adding up modifiers if the target hex has been hit before
<span class="nc bnc" id="L4883" title="All 4 branches missed.">        if (game.getEntity(ae.getId()).getOwner().getArtyAutoHitHexes().contains(target.getPosition())</span>
                &amp;&amp; !isArtilleryFLAK) {
<span class="nc" id="L4885">            srt.setSpecialResolution(true);</span>
<span class="nc" id="L4886">            return new ToHitData(TargetRoll.AUTOMATIC_SUCCESS, Messages.getString(&quot;WeaponAttackAction.ArtyDesTarget&quot;));</span>
        }
        
        // Handle direct artillery attacks.
<span class="nc bnc" id="L4890" title="All 2 branches missed.">        if (isArtilleryDirect) {</span>
            //If an airborne unit occupies the target hex, standard artillery ammo makes a flak attack against it
            //TN is a flat 3 + the altitude mod + the attacker's weapon skill
<span class="nc bnc" id="L4893" title="All 4 branches missed.">            if (isArtilleryFLAK &amp;&amp; te != null) {</span>
<span class="nc" id="L4894">                toHit.addModifier(3, Messages.getString(&quot;WeaponAttackAction.ArtyFlak&quot;));</span>
<span class="nc bnc" id="L4895" title="All 2 branches missed.">                if (te.isAirborne()) {</span>
<span class="nc bnc" id="L4896" title="All 2 branches missed.">                    if (te.getAltitude() &gt; 3) {</span>
<span class="nc bnc" id="L4897" title="All 2 branches missed.">                        if (te.getAltitude() &gt; 9) {</span>
<span class="nc" id="L4898">                            toHit.addModifier(3, Messages.getString(&quot;WeaponAttackAction.AeroTeAlt10&quot;));</span>
<span class="nc bnc" id="L4899" title="All 2 branches missed.">                        } else if (te.getAltitude() &gt; 6) {</span>
<span class="nc" id="L4900">                            toHit.addModifier(2, Messages.getString(&quot;WeaponAttackAction.AeroTeAlt79&quot;));</span>
<span class="nc bnc" id="L4901" title="All 2 branches missed.">                        } else if (te.getAltitude() &gt; 3) {</span>
<span class="nc" id="L4902">                            toHit.addModifier(1, Messages.getString(&quot;WeaponAttackAction.AeroTeAlt46&quot;));</span>
                        }
                    }
                }
<span class="nc" id="L4906">                srt.setSpecialResolution(true);</span>
<span class="nc" id="L4907">                return toHit;</span>
            } else {
                //All other direct fire artillery attacks
<span class="nc" id="L4910">                toHit.addModifier(4, Messages.getString(&quot;WeaponAttackAction.DirectArty&quot;));</span>
<span class="nc" id="L4911">                toHit.append(Compute.getAttackerMovementModifier(game, ae.getId()));</span>
<span class="nc" id="L4912">                toHit.append(losMods);</span>
<span class="nc" id="L4913">                toHit.append(Compute.getSecondaryTargetMod(game, ae, target));</span>
                // actuator &amp; sensor damage to attacker
<span class="nc bnc" id="L4915" title="All 2 branches missed.">                if (weapon != null) {</span>
<span class="nc" id="L4916">                    toHit.append(Compute.getDamageWeaponMods(ae, weapon));</span>
                }
                // heat
<span class="nc bnc" id="L4919" title="All 2 branches missed.">                if (ae.getHeatFiringModifier() != 0) {</span>
<span class="nc" id="L4920">                    toHit.addModifier(ae.getHeatFiringModifier(), Messages.getString(&quot;WeaponAttackAction.Heat&quot;));</span>
                }
                // weapon to-hit modifier
<span class="nc bnc" id="L4923" title="All 2 branches missed.">                if (wtype.getToHitModifier() != 0) {</span>
<span class="nc" id="L4924">                    toHit.addModifier(wtype.getToHitModifier(), Messages.getString(&quot;WeaponAttackAction.WeaponMod&quot;));</span>
                }
                // ammo to-hit modifier
<span class="nc bnc" id="L4927" title="All 6 branches missed.">                if (usesAmmo &amp;&amp; (atype != null) &amp;&amp; (atype.getToHitModifier() != 0)) {</span>
<span class="nc" id="L4928">                    toHit.addModifier(atype.getToHitModifier(),</span>
<span class="nc" id="L4929">                            atype.getSubMunitionName()</span>
<span class="nc" id="L4930">                                    + Messages.getString(&quot;WeaponAttackAction.AmmoMod&quot;));</span>
                }
            }
<span class="nc" id="L4933">            srt.setSpecialResolution(true);</span>
<span class="nc" id="L4934">            return toHit;</span>
        }
        //And now for indirect artillery fire
<span class="nc bnc" id="L4937" title="All 2 branches missed.">        if (isArtilleryIndirect) {</span>
<span class="nc" id="L4938">            int mod = 7;</span>
<span class="nc bnc" id="L4939" title="All 2 branches missed.">            if (ae.hasAbility(OptionsConstants.GUNNERY_OBLIQUE_ATTACKER)) {</span>
<span class="nc" id="L4940">                mod--;</span>
            }
<span class="nc" id="L4942">            toHit.addModifier(mod, Messages.getString(&quot;WeaponAttackAction.IndirectArty&quot;));</span>
<span class="nc" id="L4943">            int adjust = 0;</span>
<span class="nc bnc" id="L4944" title="All 2 branches missed.">            if (weapon != null) {        </span>
<span class="nc" id="L4945">                adjust = ae.aTracker.getModifier(weapon, target.getPosition());</span>
            }
<span class="nc" id="L4947">            boolean spotterIsForwardObserver = ae.aTracker.getSpotterHasForwardObs();</span>
<span class="nc bnc" id="L4948" title="All 2 branches missed.">            if (adjust == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L4949">                return new ToHitData(TargetRoll.AUTOMATIC_SUCCESS,</span>
                        &quot;Artillery firing at target that's been hit before.&quot;);
<span class="nc bnc" id="L4951" title="All 2 branches missed.">            } else if (adjust != 0) {</span>
<span class="nc" id="L4952">                toHit.addModifier(adjust, Messages.getString(&quot;WeaponAttackAction.AdjustedFire&quot;));</span>
<span class="nc bnc" id="L4953" title="All 2 branches missed.">                if (spotterIsForwardObserver) {</span>
<span class="nc" id="L4954">                    toHit.addModifier(-2, Messages.getString(&quot;WeaponAttackAction.FooSpotter&quot;));</span>
                }
            }
            // Capital missiles used for surface to surface artillery attacks
            // See SO p110
            // Start with a flat +2 modifier
<span class="nc bnc" id="L4960" title="All 2 branches missed.">            if (wtype instanceof CapitalMissileWeapon</span>
<span class="nc bnc" id="L4961" title="All 2 branches missed.">                    &amp;&amp; Compute.isGroundToGround(ae, target)) {</span>
<span class="nc" id="L4962">                toHit.addModifier(2, Messages.getString(&quot;WeaponAttackAction.SubCapArtillery&quot;));</span>
                // +3 additional modifier if fired underwater
<span class="nc bnc" id="L4964" title="All 2 branches missed.">                if (ae.isUnderwater()) {</span>
<span class="nc" id="L4965">                    toHit.addModifier(3, Messages.getString(&quot;WeaponAttackAction.SubCapUnderwater&quot;));</span>
                }
                // +1 modifier if attacker cruised/walked
<span class="nc bnc" id="L4968" title="All 2 branches missed.">                if (ae.moved == EntityMovementType.MOVE_WALK) {</span>
<span class="nc" id="L4969">                    toHit.addModifier(1, Messages.getString(&quot;WeaponAttackAction.Walked&quot;));</span>
<span class="nc bnc" id="L4970" title="All 2 branches missed.">                } else if (ae.moved == EntityMovementType.MOVE_RUN) {</span>
                    // +2 modifier if attacker ran
<span class="nc" id="L4972">                    toHit.addModifier(2, Messages.getString(&quot;WeaponAttackAction.Ran&quot;));</span>
                }
<span class="nc bnc" id="L4974" title="All 2 branches missed.">            } else if (ae.isAirborne()) {</span>
<span class="nc bnc" id="L4975" title="All 2 branches missed.">                if (ae.getAltitude() &gt; 6) {</span>
<span class="nc" id="L4976">                    toHit.addModifier(+2, Messages.getString(&quot;WeaponAttackAction.Altitude&quot;));</span>
<span class="nc bnc" id="L4977" title="All 2 branches missed.">                } else if (ae.getAltitude() &gt; 3) {</span>
<span class="nc" id="L4978">                    toHit.addModifier(+1, Messages.getString(&quot;WeaponAttackAction.Altitude&quot;));</span>
                }
            }
<span class="nc" id="L4981">            srt.setSpecialResolution(true);</span>
<span class="nc" id="L4982">            return toHit;</span>
        }
        //If we get here, this isn't an artillery attack
<span class="nc" id="L4985">        return toHit;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>