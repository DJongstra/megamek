<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="nl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BattleArmor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">PlayerTest Coverage Results</a> &gt; <a href="index.source.html" class="el_package">megamek.common</a> &gt; <span class="el_source">BattleArmor.java</span></div><h1>BattleArmor.java</h1><pre class="source lang-java linenums">/*
 * MegaMek - Copyright (C) 2002,2003,2004 Ben Mazur (bmazur@sev.org)
 *
 * This program is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License as published by the Free Software
 * Foundation; either version 2 of the License, or (at your option) any later
 * version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
 * details.
 */

package megamek.common;

import java.text.NumberFormat;
import java.util.Arrays;
import java.util.Map;
import java.util.Vector;

import megamek.MegaMek;
import megamek.common.options.OptionsConstants;
import megamek.common.preference.PreferenceManager;
import megamek.common.weapons.InfantryAttack;
import megamek.common.weapons.infantry.InfantryWeapon;

/**
 * This class represents a squad or point of battle armor equiped infantry,
 * sometimes referred to as &quot;Elementals&quot;. Much of the behaviour of a battle
 * armor unit is identical to that of an infantry platoon, and is rather
 * different than that of a Mek or Tank.
 *
 * @author Suvarov454@sourceforge.net (James A. Damour )
 * @version $revision:$
 */
/*
 * PLEASE NOTE!!! My programming style is to put constants first in tests so the
 * compiler catches my &quot;= for ==&quot; errors.
 */
public class BattleArmor extends Infantry {
    /**
     *
     */
    private static final long serialVersionUID = 4594311535026187825L;
    /*
     * Infantry have no critical slot limitations. IS squads usually have 4 men,
     * Clan points usually have 5. Have a location that represents the entire
     * squad.
     */
<span class="nc" id="L51">    private static final int[] IS_NUM_OF_SLOTS = { 20, 2, 2, 2, 2, 2, 2 };</span>
<span class="nc" id="L52">    private static final String[] IS_LOCATION_ABBRS = { &quot;Squad&quot;, &quot;Trooper 1&quot;,</span>
        &quot;Trooper 2&quot;, &quot;Trooper 3&quot;, &quot;Trooper 4&quot;, &quot;Trooper 5&quot;, &quot;Trooper 6&quot; };
<span class="nc" id="L54">    private static final String[] IS_LOCATION_NAMES = { &quot;Squad&quot;, &quot;Trooper 1&quot;,</span>
        &quot;Trooper 2&quot;, &quot;Trooper 3&quot;, &quot;Trooper 4&quot;, &quot;Trooper 5&quot;, &quot;Trooper 6&quot; };
<span class="nc" id="L56">    private static final int[] CLAN_NUM_OF_SLOTS = { 20, 2, 2, 2, 2, 2, 2 };</span>
<span class="nc" id="L57">    private static final String[] CLAN_LOCATION_ABBRS = { &quot;Point&quot;, &quot;Trooper 1&quot;,</span>
        &quot;Trooper 2&quot;, &quot;Trooper 3&quot;, &quot;Trooper 4&quot;, &quot;Trooper 5&quot;, &quot;Trooper 6&quot; };
<span class="nc" id="L59">    private static final String[] CLAN_LOCATION_NAMES = { &quot;Point&quot;, &quot;Trooper 1&quot;,</span>
        &quot;Trooper 2&quot;, &quot;Trooper 3&quot;, &quot;Trooper 4&quot;, &quot;Trooper 5&quot;, &quot;Trooper 6&quot; };

    public static final int MANIPULATOR_NONE = 0;
    public static final int MANIPULATOR_ARMORED_GLOVE = 1;
    public static final int MANIPULATOR_BASIC = 2;
    public static final int MANIPULATOR_BASIC_MINE_CLEARANCE = 3;
    public static final int MANIPULATOR_BATTLE = 4;
    public static final int MANIPULATOR_BATTLE_MAGNET = 5;
    public static final int MANIPULATOR_BATTLE_VIBRO = 6;
    public static final int MANIPULATOR_HEAVY_BATTLE = 7;
    public static final int MANIPULATOR_HEAVY_BATTLE_MAGNET = 8;
    public static final int MANIPULATOR_HEAVY_BATTLE_VIBRO = 9;
    public static final int MANIPULATOR_SALVAGE_ARM = 10;
    public static final int MANIPULATOR_CARGO_LIFTER = 11;
    public static final int MANIPULATOR_INDUSTRIAL_DRILL = 12;

    /**
     * A list of the internal names for the different manipulator types.
     * The indices in this collection correspond to the MANIPULATOR defines
     * in &lt;code&gt;BattleArmor&lt;/code&gt;.  These names should match the internal
     * name for the manipulator's MiscType entry.
     */
<span class="nc" id="L82">    public static final String[] MANIPULATOR_TYPE_STRINGS = { &quot;None&quot;,</span>
        &quot;BAArmoredGlove&quot;, &quot;BABasicManipulator&quot;,
        &quot;BABasicManipulatorMineClearance&quot;, &quot;BABattleClaw&quot;,
        &quot;BABattleClawMagnets&quot;, &quot;BABattleClawVibro&quot;,
        &quot;BAHeavyBattleClaw&quot;, &quot;BAHeavyBattleClawMagnets&quot;,
        &quot;BAHeavyBattleClawVibro&quot;,
        &quot;BASalvageArm&quot;, &quot;BACargoLifter&quot;, &quot;BAIndustrialDrill&quot; };

    /**
     * A list of the display names for the different manipulator types.
     * The indices in this collection correspond to the MANIPULATOR defines
     * in &lt;code&gt;BattleArmor&lt;/code&gt;.  These names should match the
     * name for the manipulator's MiscType entry.
     */
<span class="nc" id="L96">    public static final String[] MANIPULATOR_NAME_STRINGS = { &quot;None&quot;,</span>
        &quot;BA Manipulators [Armored Gloves]&quot;, &quot;BA Manipulators [Manipulator (Basic)]&quot;,
        &quot;BA Manipulator Adaptation [Mine Clearance Equipment]&quot;, &quot;BA Manipulators [Battle Claw]&quot;,
        &quot;BA Manipulator Adaptation [Magnetic Battle Claw]&quot;, &quot;BA Manipulator Adaptation [Vibro-Claw]&quot;,
        &quot;BA Manipulators [Heavy Battle Claw]&quot;, &quot;BA Manipulator Adaptation [Heavy Magnetic Battle Claw]&quot;,
        &quot;BA Manipulator Adaptation [Heavy Vibro-Claw]&quot;, &quot;BA Manipulators [Salvage Arm]&quot;, &quot;BA Manipulators [Cargo Lifter]&quot;,
        &quot;BA Manipulators [Industrial Drill]&quot; };

    public static final int CHASSIS_TYPE_BIPED = 0;
    public static final int CHASSIS_TYPE_QUAD = 1;

    /**
     * The number of men alive in this unit at the beginning of the phase,
     * before it begins to take damage.
     */
<span class="nc" id="L111">    private int troopersShooting = 0;</span>

    /**
     * the number of troopers of this squad, dead or alive
     */
<span class="nc" id="L116">    private int troopers = -1;</span>

    /**
     * The cost of this unit. This value should be set when the unit's file is
     * read.
     */
<span class="nc" id="L122">    protected int myCost = -1;</span>
    /**
     * This unit's weight class
     */
<span class="nc" id="L126">    private int weightClass = -1;</span>
    /**
     * this unit's chassis type, should be BattleArmor.CHASSIS_TYPE_BIPED or
     * BattleArmor.CHASSIS_TYPE_QUAD
     */
<span class="nc" id="L131">    private int chassisType = -1;</span>

    /**
     * Flag that is &lt;code&gt;true&lt;/code&gt; when this object's constructor has
     * completed.
     */
<span class="nc" id="L137">    private boolean isInitialized = false;</span>

    /**
     * Flag that is &lt;code&gt;true&lt;/code&gt; when this unit is equipped with stealth.
     */
<span class="nc" id="L142">    private boolean isStealthy = false;</span>

    /**
     * Flag that is &lt;code&gt;true&lt;/code&gt; when this unit is equipped with mimetic
     * armor.
     */
<span class="nc" id="L148">    private boolean isMimetic = false;</span>

    /**
     * Flag that is &lt;code&gt;true&lt;/code&gt; when this unit is equipped with a camo
     * system.
     */
<span class="nc" id="L154">    private boolean hasCamoSystem = false;</span>

    /**
     * Modifiers to &lt;code&gt;ToHitData&lt;/code&gt; for stealth.
     */
<span class="nc" id="L159">    private int shortStealthMod = 0;</span>
<span class="nc" id="L160">    private int mediumStealthMod = 0;</span>
<span class="nc" id="L161">    private int longStealthMod = 0;</span>
<span class="nc" id="L162">    private String stealthName = null;</span>
<span class="nc" id="L163">    private String camoName = null;</span>

    // Public and Protected constants, constructors, and methods.

    /**
     * Internal name of the Inner disposable SRM2 ammo pack.
     */
    public static final String DISPOSABLE_SRM2_AMMO = &quot;BA-SRM2 (one shot) Ammo&quot;;

    /**
     * Internal name of the disposable NARC ammo pack.
     */
    public static final String DISPOSABLE_NARC_AMMO = &quot;BA-Compact Narc Ammo&quot;;

    /**
     * The internal name for the Mine Launcher weapon.
     */
    public static final String MINE_LAUNCHER = &quot;BAMineLauncher&quot;;

    /**
     * The internal name for advanced.
     */
<span class="nc" id="L185">    public static final String ADVANCED_ARMOR = EquipmentType</span>
<span class="nc" id="L186">            .getArmorTypeName(EquipmentType.T_ARMOR_BA_STANDARD_ADVANCED);</span>

    /**
     * The internal name for standard Prototype.
     */
<span class="nc" id="L191">    public static final String STANDARD_PROTOTYPE = EquipmentType</span>
<span class="nc" id="L192">            .getArmorTypeName(EquipmentType.T_ARMOR_BA_STANDARD_PROTOTYPE);</span>

    /**
     * The internal name for stealth Prototype.
     */
<span class="nc" id="L197">    public static final String STEALTH_PROTOTYPE = EquipmentType</span>
<span class="nc" id="L198">            .getArmorTypeName(EquipmentType.T_ARMOR_BA_STEALTH_PROTOTYPE);</span>

    /**
     * The internal name for basic Stealth armor.
     */
<span class="nc" id="L203">    public static final String BASIC_STEALTH_ARMOR = EquipmentType</span>
<span class="nc" id="L204">            .getArmorTypeName(EquipmentType.T_ARMOR_BA_STEALTH_BASIC);</span>

    /**
     * The internal name for standard Stealth armor.
     */
<span class="nc" id="L209">    public static final String STANDARD_STEALTH_ARMOR = EquipmentType</span>
<span class="nc" id="L210">            .getArmorTypeName(EquipmentType.T_ARMOR_BA_STEALTH);</span>

    /**
     * The internal name for improved Stealth armor.
     */
<span class="nc" id="L215">    public static final String IMPROVED_STEALTH_ARMOR = EquipmentType</span>
<span class="nc" id="L216">            .getArmorTypeName(EquipmentType.T_ARMOR_BA_STEALTH_IMP);</span>

    /**
     * The internal name for Mimetic armor.
     */
<span class="nc" id="L221">    public static final String MIMETIC_ARMOR = EquipmentType</span>
<span class="nc" id="L222">            .getArmorTypeName(EquipmentType.T_ARMOR_BA_MIMETIC);</span>

    /**
     * The internal name for fire-resistant armor.
     */
<span class="nc" id="L227">    public static final String FIRE_RESISTANT = EquipmentType</span>
<span class="nc" id="L228">            .getArmorTypeName(EquipmentType.T_ARMOR_BA_FIRE_RESIST);</span>

    /**
     * The internal name for Simple Camo equipment.
     */
    public static final String CAMO_SYSTEM = &quot;Camo System&quot;;

    /**
     * The internal name for Single-Hex ECM equipment.
     */
    public static final String SINGLE_HEX_ECM = &quot;Single-Hex ECM&quot;;

    /**
     * /** The maximum number of men in a battle armor squad.
     */
    public static final int BA_MAX_MEN = 6;

    /**
     * The location for infantry equipment.
     */
    public static final int LOC_SQUAD = 0;

    public static final int LOC_TROOPER_1 = 1;
    public static final int LOC_TROOPER_2 = 2;
    public static final int LOC_TROOPER_3 = 3;
    public static final int LOC_TROOPER_4 = 4;
    public static final int LOC_TROOPER_5 = 5;
    public static final int LOC_TROOPER_6 = 6;

    /**
     * The location for mounted equipment on BA
     */
    public static final int MOUNT_LOC_NONE   = -1;
    public static final int MOUNT_LOC_BODY   = 0;
    public static final int MOUNT_LOC_RARM   = 1;
    public static final int MOUNT_LOC_LARM   = 2;
    public static final int MOUNT_LOC_TURRET = 3;

<span class="nc" id="L266">    public static final String[] MOUNT_LOC_NAMES = { &quot;Body&quot;, &quot;Right Arm&quot;,</span>
            &quot;Left Arm&quot;, &quot;Turret&quot; };

    /**
     * How many mount locations are possible?
     */
    public static final int MOUNT_NUM_LOCS = 4;
    
    // Quad BA can add critical space by adding a turret mount.
<span class="nc" id="L275">    private int turretSize = 0;</span>
<span class="nc" id="L276">    private boolean modularTurret = false;</span>

<span class="nc" id="L278">    private boolean exoskeleton = false;</span>

    /**
     * Clan industrial exoskeletons can opt to not use Harjel, to allow them to
     * use IS chassis weight; this flag indicates whether or not this is the
     * case.
     */
<span class="nc" id="L285">    private boolean clanExoWithoutHarjel = false;</span>

    @Override
    public String[] getLocationAbbrs() {
<span class="nc bnc" id="L289" title="All 4 branches missed.">        if (!isInitialized || isClan()) {</span>
<span class="nc" id="L290">            return CLAN_LOCATION_ABBRS;</span>
        }
<span class="nc" id="L292">        return IS_LOCATION_ABBRS;</span>
    }

    public String[] getBaMountLocAbbr() {
<span class="nc" id="L296">        return MOUNT_LOC_NAMES;</span>
    }

    public static String getBaMountLocAbbr(int loc) {
<span class="nc bnc" id="L300" title="All 2 branches missed.">        if (loc == MOUNT_LOC_NONE) {</span>
<span class="nc" id="L301">            return &quot;None&quot;;</span>
        }
<span class="nc" id="L303">        return MOUNT_LOC_NAMES[loc];</span>
    }

    @Override
    public String[] getLocationNames() {
<span class="nc bnc" id="L308" title="All 4 branches missed.">        if (!isInitialized || isClan()) {</span>
<span class="nc" id="L309">            return CLAN_LOCATION_NAMES;</span>
        }
<span class="nc" id="L311">        return IS_LOCATION_NAMES;</span>
    }

    /**
     * Returns the number of Troopers in the BattleArmor squad, since locations
     * for BattleArmor correspond to the different suits instead of the actual
     * mount locations for equipment.
     */
    @Override
    public int locations() {
<span class="nc" id="L321">        int retVal = getTroopers();</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">        if (retVal == 0) {</span>
            // Return one more than the maximum number of men in the unit.
<span class="nc bnc" id="L324" title="All 2 branches missed.">            if (!isInitialized) {</span>
<span class="nc" id="L325">                retVal = 6 + 1;</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">            } else if (isClan()) {</span>
<span class="nc" id="L327">                retVal = 5 + 1;</span>
            } else {
<span class="nc" id="L329">                retVal = 4 + 1;</span>
            }
        } else {
<span class="nc" id="L332">            retVal++;</span>
        }
<span class="nc" id="L334">        return retVal;</span>
    }

    /**
     * Generate a new, blank, battle armor unit. Hopefully, we'll be loaded from
     * somewhere.
     */
    public BattleArmor() {
        // Instantiate the superclass.
<span class="nc" id="L343">        super();</span>

<span class="nc" id="L345">        setArmorType(EquipmentType.T_ARMOR_BA_STANDARD);</span>

        // BA are always one squad
<span class="nc" id="L348">        squadn = 1;</span>

        // All Battle Armor squads are Clan until specified otherwise.
<span class="nc" id="L351">        setTechLevel(TechConstants.T_CLAN_TW);</span>

        // Construction complete.
<span class="nc" id="L354">        isInitialized = true;</span>
<span class="nc" id="L355">    }</span>

    @Override
    public int getUnitType() {
<span class="nc" id="L359">        return UnitType.BATTLE_ARMOR;</span>
    }

<span class="nc" id="L362">    protected static final TechAdvancement[] TA_BATTLEARMOR = {</span>
<span class="nc" id="L363">            new TechAdvancement(TECH_BASE_ALL).setISAdvancement(2710, DATE_NONE, 3058, 2766, 2905)</span>
<span class="nc" id="L364">                .setClanAdvancement(2710, DATE_NONE, 3058).setPrototypeFactions(F_TH)</span>
<span class="nc" id="L365">                .setReintroductionFactions(F_CS).setTechRating(RATING_D)</span>
<span class="nc" id="L366">                .setAvailability(RATING_F, RATING_X, RATING_E, RATING_D)</span>
<span class="nc" id="L367">                .setStaticTechLevel(SimpleTechLevel.STANDARD), //ultralight</span>
<span class="nc" id="L368">            new TechAdvancement(TECH_BASE_ALL).setISAdvancement(DATE_NONE, 3050, 3050)</span>
<span class="nc" id="L369">                .setClanAdvancement(2865, 2870, 2900).setPrototypeFactions(F_CWF)</span>
<span class="nc" id="L370">                .setProductionFactions(F_CIH, F_FS, F_LC).setClanApproximate(true, false, false)</span>
<span class="nc" id="L371">                .setTechRating(RATING_E)</span>
<span class="nc" id="L372">                .setAvailability(RATING_X, RATING_F, RATING_E, RATING_D)</span>
<span class="nc" id="L373">                .setStaticTechLevel(SimpleTechLevel.STANDARD), //light</span>
<span class="nc" id="L374">            new TechAdvancement(TECH_BASE_ALL).setISAdvancement(2864, 3052, 3052)</span>
<span class="nc" id="L375">                .setClanAdvancement(2840, 2868, 2875)</span>
<span class="nc" id="L376">                .setClanApproximate(true, false, false).setPrototypeFactions(F_CGS)</span>
<span class="nc" id="L377">                .setProductionFactions(F_CWF, F_FS, F_LC, F_CS).setTechRating(RATING_E)</span>
<span class="nc" id="L378">                .setAvailability(RATING_X, RATING_D, RATING_D, RATING_D)</span>
<span class="nc" id="L379">                .setStaticTechLevel(SimpleTechLevel.STANDARD), //medium</span>
<span class="nc" id="L380">            new TechAdvancement(TECH_BASE_ALL).setISAdvancement(DATE_NONE, 3050, 3058)</span>
<span class="nc" id="L381">                .setClanAdvancement(2867, 2875, 3058)</span>
<span class="nc" id="L382">                .setClanApproximate(true, false, false).setPrototypeFactions(F_CWF)</span>
<span class="nc" id="L383">                .setProductionFactions(F_CHH, F_FS, F_LC).setTechRating(RATING_E)</span>
<span class="nc" id="L384">                .setAvailability(RATING_X, RATING_F, RATING_E, RATING_D)</span>
<span class="nc" id="L385">                .setStaticTechLevel(SimpleTechLevel.STANDARD), // heavy</span>
<span class="nc" id="L386">            new TechAdvancement(TECH_BASE_ALL).setISAdvancement(DATE_NONE, 3058, 3060)</span>
<span class="nc" id="L387">                .setClanAdvancement(2870, 2877, 3060)</span>
<span class="nc" id="L388">                .setClanApproximate(true, false, false).setPrototypeFactions(F_CNC)</span>
<span class="nc" id="L389">                .setProductionFactions(F_CGB, F_DC).setTechRating(RATING_E)</span>
<span class="nc" id="L390">                .setAvailability(RATING_X, RATING_F, RATING_E, RATING_D)</span>
<span class="nc" id="L391">                .setStaticTechLevel(SimpleTechLevel.STANDARD) // assault</span>
    };
    
    public static TechAdvancement getConstructionTechAdvancement(int weightClass) {
<span class="nc" id="L395">        return new TechAdvancement(TA_BATTLEARMOR[weightClass]);</span>
    }
    
    @Override
    public TechAdvancement getConstructionTechAdvancement() {
<span class="nc" id="L400">        int index = getWeightClass();</span>
<span class="nc bnc" id="L401" title="All 4 branches missed.">        if (index &lt; 0 || index &gt;= TA_BATTLEARMOR.length) {</span>
<span class="nc" id="L402">            index = EntityWeightClass.WEIGHT_MEDIUM;</span>
        }
<span class="nc" id="L404">        return TA_BATTLEARMOR[index];</span>
    }

    /**
     * Returns this entity's original jumping mp.
     */
    @Override
    public int getOriginalJumpMP() {
<span class="nc" id="L412">        return jumpMP;</span>
    }

    /**
     * Returns this entity's walking mp, factored for extreme temperatures and
     * gravity.
     */
    @Override
    public int getWalkMP(boolean gravity, boolean ignoreheat,
            boolean ignoremodulararmor) {
<span class="nc" id="L422">        return getWalkMP(gravity, ignoreheat, ignoremodulararmor, false, false);</span>
    }

    public int getWalkMP(boolean gravity, boolean ignoreheat,
            boolean ignoremodulararmor, boolean ignoreDWP,
            boolean ignoreMyomerBooster) {
<span class="nc" id="L428">        int j = getOriginalWalkMP();</span>
<span class="nc bnc" id="L429" title="All 2 branches missed.">        if (hasMyomerBooster()) {</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">            if (!ignoreMyomerBooster) {</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">                if (getWeightClass() &gt;= EntityWeightClass.WEIGHT_HEAVY) {</span>
<span class="nc" id="L432">                    j++;</span>
                } else {
<span class="nc" id="L434">                    j += 2;</span>
                }
            }
<span class="nc bnc" id="L437" title="All 2 branches missed.">        } else if (hasWorkingMisc(MiscType.F_MECHANICAL_JUMP_BOOSTER)) {</span>
            // mechanical jump booster gives an extra MP
<span class="nc" id="L439">            j++;</span>
        }
<span class="nc bnc" id="L441" title="All 4 branches missed.">        if (hasDWP() &amp;&amp; !ignoreDWP) {</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">            if (getWeightClass() == EntityWeightClass.WEIGHT_MEDIUM) {</span>
<span class="nc" id="L443">                j -= 3;</span>
<span class="nc bnc" id="L444" title="All 2 branches missed.">            } else if (getWeightClass() &gt;= EntityWeightClass.WEIGHT_HEAVY) {</span>
<span class="nc" id="L445">                j -= 2;</span>
            }
<span class="nc bnc" id="L447" title="All 2 branches missed.">            if (j == 0) {</span>
<span class="nc" id="L448">                j++;</span>
            }
        }
<span class="nc bnc" id="L451" title="All 2 branches missed.">        if (null != game) {</span>
<span class="nc" id="L452">            int weatherMod = game.getPlanetaryConditions()</span>
<span class="nc" id="L453">                    .getMovementMods(this);</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">            if (weatherMod != 0) {</span>
<span class="nc" id="L455">                j = Math.max(j + weatherMod, 0);</span>
            }
        }
<span class="nc bnc" id="L458" title="All 2 branches missed.">        if (gravity) {</span>
<span class="nc" id="L459">            j = applyGravityEffectsOnMP(j);</span>
        }
<span class="nc" id="L461">        return j;</span>
    }

    @Override
    public int getRunMP(boolean gravity, boolean ignoreheat,
            boolean ignoremodulararmor) {
<span class="nc bnc" id="L467" title="All 2 branches missed.">        boolean fastMove = (game != null) &amp;&amp;</span>
<span class="nc bnc" id="L468" title="All 2 branches missed.">                game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_FAST_INFANTRY_MOVE);</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">        if(fastMove) {</span>
<span class="nc" id="L470">            return getWalkMP(gravity, ignoreheat, ignoremodulararmor, false,</span>
                    false) + 1;
        }
<span class="nc" id="L473">        return getWalkMP(gravity, ignoreheat, ignoremodulararmor, false, false);</span>
    }

    /**
     * does this ba mount a myomer booster?
     *
     * @return
     */
    public boolean hasMyomerBooster() {
<span class="nc bnc" id="L482" title="All 2 branches missed.">        for (Mounted mEquip : getMisc()) {</span>
<span class="nc" id="L483">            MiscType mtype = (MiscType) mEquip.getType();</span>
<span class="nc bnc" id="L484" title="All 4 branches missed.">            if (mtype.hasFlag(MiscType.F_MASC) &amp;&amp; !mEquip.isInoperable()) {</span>
<span class="nc" id="L485">                return true;</span>
            }
<span class="nc" id="L487">        }</span>
<span class="nc" id="L488">        return false;</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Infantry#getJumpMP(boolean)
     */
    @Override
    public int getJumpMP(boolean gravity) {
<span class="nc" id="L498">        return getJumpMP(gravity, false, false);</span>
    }

    /**
     * get this BA's jump MP, possibly ignoring gravity and burden
     *
     * @param gravity
     * @param ignoreBurden
     * @return
     */
    public int getJumpMP(boolean gravity, boolean ignoreBurden,
            boolean ignoreDWP) {
<span class="nc bnc" id="L510" title="All 4 branches missed.">        if (isBurdened() &amp;&amp; !ignoreBurden) {</span>
<span class="nc" id="L511">            return 0;</span>
        }
<span class="nc bnc" id="L513" title="All 4 branches missed.">        if (hasDWP() &amp;&amp; !ignoreDWP) {</span>
<span class="nc" id="L514">            return 0;</span>
        }
<span class="nc bnc" id="L516" title="All 2 branches missed.">        if (null != game) {</span>
<span class="nc" id="L517">            int windCond = game.getPlanetaryConditions().getWindStrength();</span>
<span class="nc bnc" id="L518" title="All 2 branches missed.">            if (windCond &gt;= PlanetaryConditions.WI_STORM) {</span>
<span class="nc" id="L519">                return 0;</span>
            }
        }
<span class="nc" id="L522">        int mp = 0;</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">        if (getMovementMode() != EntityMovementMode.INF_UMU) {</span>
<span class="nc" id="L524">            mp = getOriginalJumpMP();</span>
        }
        // if we have no normal jump jets, we get 1 jump MP from mechanical jump
        // boosters, if we have them.
<span class="nc bnc" id="L528" title="All 4 branches missed.">        if ((mp == 0) &amp;&amp; hasWorkingMisc(MiscType.F_MECHANICAL_JUMP_BOOSTER)) {</span>
<span class="nc" id="L529">            mp++;</span>
        }
        // partial wing gives extra MP in atmosphere
<span class="nc bnc" id="L532" title="All 2 branches missed.">        if ((mp &gt; 0)</span>
<span class="nc bnc" id="L533" title="All 4 branches missed.">                &amp;&amp; hasWorkingMisc(MiscType.F_PARTIAL_WING)</span>
<span class="nc bnc" id="L534" title="All 2 branches missed.">                &amp;&amp; ((game == null) || !game.getPlanetaryConditions().isVacuum())) {</span>
<span class="nc" id="L535">            mp++;</span>
        }
<span class="nc bnc" id="L537" title="All 4 branches missed.">        if ((mp &gt; 0) &amp;&amp; hasWorkingMisc(MiscType.F_JUMP_BOOSTER)) {</span>
            // jump booster gives an extra MP
<span class="nc" id="L539">            mp++;</span>
        }
<span class="nc bnc" id="L541" title="All 2 branches missed.">        if (gravity) {</span>
<span class="nc" id="L542">            mp = applyGravityEffectsOnMP(mp);</span>
        }
<span class="nc" id="L544">        return mp;</span>
    }

    /**
     * Returns the name of the type of movement used. This is Infantry-specific.
     */
    @Override
    public String getMovementString(EntityMovementType mtype) {
<span class="nc bnc" id="L552" title="All 5 branches missed.">        switch (mtype) {</span>
        case MOVE_NONE:
<span class="nc" id="L554">            return &quot;None&quot;;</span>
        case MOVE_WALK:
        case MOVE_RUN:
<span class="nc" id="L557">            return &quot;Walked&quot;;</span>
        case MOVE_VTOL_WALK:
        case MOVE_VTOL_RUN:
<span class="nc" id="L560">            return &quot;Flew&quot;;</span>
        case MOVE_JUMP:
<span class="nc" id="L562">            return &quot;Jumped&quot;;</span>
        default:
<span class="nc" id="L564">            return &quot;Unknown!&quot;;</span>
        }
    }

    /**
     * Returns the abbreviation of the type of movement used. This is
     * Infantry-specific.
     */
    @Override
    public String getMovementAbbr(EntityMovementType mtype) {
<span class="nc bnc" id="L574" title="All 6 branches missed.">        switch (mtype) {</span>
        case MOVE_NONE:
<span class="nc" id="L576">            return &quot;N&quot;;</span>
        case MOVE_WALK:
<span class="nc" id="L578">            return &quot;W&quot;;</span>
        case MOVE_RUN:
<span class="nc" id="L580">            return &quot;R&quot;;</span>
        case MOVE_JUMP:
<span class="nc" id="L582">            return &quot;J&quot;;</span>
        case MOVE_VTOL_WALK:
        case MOVE_VTOL_RUN:
<span class="nc" id="L585">            return &quot;F&quot;;</span>
        default:
<span class="nc" id="L587">            return &quot;?&quot;;</span>
        }
    }

    /**
     * Battle Armor units can only get hit in undestroyed troopers.
     */
    @Override
    public HitData rollHitLocation(int table, int side, int aimedLocation,
            int aimingMode, int cover) {

        // If this squad was killed, target trooper 1 (just because).
<span class="nc bnc" id="L599" title="All 2 branches missed.">        if (isDoomed()) {</span>
<span class="nc" id="L600">            return new HitData(1);</span>
        }

<span class="nc bnc" id="L603" title="All 4 branches missed.">        if ((aimedLocation != LOC_NONE)</span>
                &amp;&amp; (aimingMode != IAimingModes.AIM_MODE_NONE)) {

<span class="nc" id="L606">            int roll = Compute.d6(2);</span>

<span class="nc bnc" id="L608" title="All 4 branches missed.">            if ((5 &lt; roll) &amp;&amp; (roll &lt; 9)) {</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">                return new HitData(aimedLocation, side == ToHitData.SIDE_REAR,</span>
                        true);
            }
        }

        // Pick a random number between 1 and 6.
<span class="nc" id="L615">        int loc = Compute.d6();</span>

        // Pick a new random number if that trooper is dead or never existed.
        // Remember that there's one more location than the number of troopers.
        // In http://forums.classicbattletech.com/index.php/topic,43203.0.html,
        // &quot;previously destroyed includes the current phase&quot; for rolling hits on
        // a squad,
        // modifying previous ruling in the AskThePM FAQ.
<span class="nc bnc" id="L623" title="All 2 branches missed.">        while ((loc &gt;= locations())</span>
<span class="nc bnc" id="L624" title="All 2 branches missed.">                || (IArmorState.ARMOR_NA == this.getInternal(loc))</span>
<span class="nc bnc" id="L625" title="All 2 branches missed.">                || (IArmorState.ARMOR_DESTROYED == this.getInternal(loc))</span>
<span class="nc bnc" id="L626" title="All 4 branches missed.">                || ((IArmorState.ARMOR_DOOMED == this.getInternal(loc)) &amp;&amp; !isDoomed())) {</span>
<span class="nc" id="L627">            loc = Compute.d6();</span>
        }

<span class="nc" id="L630">        int critLocation = Compute.d6();</span>
        // TacOps p. 108 Trooper takes a crit if a second roll is the same
        // location as the first.
<span class="nc bnc" id="L633" title="All 4 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_BA_CRITICALS)</span>
                &amp;&amp; (loc == critLocation)) {
<span class="nc" id="L635">            return new HitData(loc, false, HitData.EFFECT_CRITICAL);</span>
        }
        // Hit that trooper.
<span class="nc" id="L638">        return new HitData(loc);</span>

    }

    @Override
    public HitData rollHitLocation(int table, int side) {
<span class="nc" id="L644">        return rollHitLocation(table, side, LOC_NONE,</span>
                IAimingModes.AIM_MODE_NONE, LosEffects.COVER_NONE);
    }

    /**
     * For level 3 rules, each trooper occupies a specific location
     * precondition: hit is a location covered by BA
     */
    @Override
    public HitData getTrooperAtLocation(HitData hit, Entity transport) {
<span class="nc bnc" id="L654" title="All 2 branches missed.">        if (transport instanceof Mech) {</span>
<span class="nc" id="L655">            int loc = 99;</span>
<span class="nc bnc" id="L656" title="All 4 branches missed.">            switch (hit.getLocation()) {</span>
            case Mech.LOC_RT:
<span class="nc bnc" id="L658" title="All 2 branches missed.">                if (hit.isRear()) {</span>
<span class="nc" id="L659">                    loc = 3;</span>
                } else {
<span class="nc" id="L661">                    loc = 1;</span>
                }
<span class="nc" id="L663">                break;</span>
            case Mech.LOC_LT:
<span class="nc bnc" id="L665" title="All 2 branches missed.">                if (hit.isRear()) {</span>
<span class="nc" id="L666">                    loc = 4;</span>
                } else {
<span class="nc" id="L668">                    loc = 2;</span>
                }
<span class="nc" id="L670">                break;</span>
            case Mech.LOC_CT:
<span class="nc bnc" id="L672" title="All 2 branches missed.">                if (hit.isRear()) {</span>
<span class="nc" id="L673">                    loc = 5;</span>
                } else {
<span class="nc" id="L675">                    loc = 6;</span>
                }
                break;
            }
<span class="nc bnc" id="L679" title="All 2 branches missed.">            if (loc &lt; locations()) {</span>
<span class="nc" id="L680">                return new HitData(loc);</span>
            }
<span class="nc bnc" id="L682" title="All 2 branches missed.">        } else if (transport instanceof Tank) {</span>
<span class="nc" id="L683">            int loc = 99;</span>
<span class="nc bnc" id="L684" title="All 4 branches missed.">            switch (hit.getLocation()) {</span>
            case Tank.LOC_RIGHT:
                // There are 2 troopers on each location, so pick
                // one randomly if both are alive.
<span class="nc bnc" id="L688" title="All 4 branches missed.">                if ((getInternal(1) &gt; 0) &amp;&amp; (getInternal(2) &gt; 0)) {</span>
<span class="nc" id="L689">                    loc = Compute.randomInt(2) + 1;</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">                } else if (getInternal(1) &gt; 0) {</span>
<span class="nc" id="L691">                    loc = 1;</span>
                } else {
<span class="nc" id="L693">                    loc = 2;</span>
                }
<span class="nc" id="L695">                break;</span>
            case Tank.LOC_LEFT:
<span class="nc bnc" id="L697" title="All 4 branches missed.">                if ((getInternal(3) &gt; 0) &amp;&amp; (getInternal(4) &gt; 0)) {</span>
<span class="nc" id="L698">                    loc = Compute.randomInt(2) + 3;</span>
<span class="nc bnc" id="L699" title="All 2 branches missed.">                } else if (getInternal(3) &gt; 0) {</span>
<span class="nc" id="L700">                    loc = 3;</span>
                } else {
<span class="nc" id="L702">                    loc = 4;</span>
                }
<span class="nc" id="L704">                break;</span>
            case Tank.LOC_REAR:
                //Troopers 5 and 6 only exist when you have Clan and CS/WoB units, so we need
                //to ensure the array is large enough before checking their status.
<span class="nc bnc" id="L708" title="All 6 branches missed.">                if (locations() &gt;= 7 &amp;&amp; ((getInternal(5) &gt; 0) &amp;&amp; (getInternal(6) &gt; 0))) {</span>
                    //If we have a live trooper 5 and 6, randomize who gets hit
<span class="nc" id="L710">                    loc = Compute.randomInt(2) + 5;</span>
<span class="nc bnc" id="L711" title="All 4 branches missed.">                } else if ((locations() &gt;= 7) &amp;&amp; (getInternal(5) &lt;= 0)) {</span>
                    //If trooper 5 is dead, hit trooper 6
<span class="nc" id="L713">                    loc = 6;</span>
                } else {
<span class="nc" id="L715">                    loc = 5;</span>
                }
                break;
            }
            //If we get here with an invalid loc for this squad, this next test should fail
<span class="nc bnc" id="L720" title="All 2 branches missed.">            if (loc &lt; locations()) {</span>
<span class="nc" id="L721">                return new HitData(loc);</span>
            }
        }
        // otherwise roll a random location
<span class="nc" id="L725">        return rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
    }

    /**
     * Battle Armor units don't transfer damage.
     */
    @Override
    public HitData getTransferLocation(HitData hit) {

        // If any trooper lives, the unit isn't destroyed.
<span class="nc bnc" id="L735" title="All 2 branches missed.">        for (int loop = 1; loop &lt; locations(); loop++) {</span>
<span class="nc bnc" id="L736" title="All 2 branches missed.">            if (0 &lt; this.getInternal(loop)) {</span>
<span class="nc" id="L737">                return new HitData(Entity.LOC_NONE);</span>
            }
        }

        // No surviving troopers, so we're toast.
<span class="nc" id="L742">        return new HitData(Entity.LOC_DESTROYED);</span>
    }

    /**
     * Battle Armor units use default behavior for armor and internals.
     *
     * @see megamek.common.Infantry#isPlatoon()
     */
    @Override
    protected boolean isPlatoon() {
<span class="nc" id="L752">        return false;</span>
    }

    /**
     * Battle Armor units have no armor on their squad location.
     *
     * @see megamek.common.Infantry#getArmor(int, boolean )
     */
    @Override
    public int getArmor(int loc, boolean rear) {
<span class="nc bnc" id="L762" title="All 2 branches missed.">        if (BattleArmor.LOC_SQUAD != loc) {</span>
<span class="nc" id="L763">            return super.getArmor(loc, rear);</span>
        }
<span class="nc" id="L765">        return IArmorState.ARMOR_NA;</span>
    }

    /**
     * Battle Armor units have no armor on their squad location.
     *
     * @see megamek.common.Infantry#getOArmor(int, boolean )
     */
    @Override
    public int getOArmor(int loc, boolean rear) {
<span class="nc bnc" id="L775" title="All 2 branches missed.">        if (BattleArmor.LOC_SQUAD != loc) {</span>
<span class="nc" id="L776">            return super.getOArmor(loc, rear);</span>
        }
<span class="nc" id="L778">        return IArmorState.ARMOR_NA;</span>
    }

    /**
     * Battle Armor units have no internals on their squad location.
     *
     * @see megamek.common.Infantry#getInternal(int )
     */
    @Override
    public int getInternal(int loc) {
<span class="nc bnc" id="L788" title="All 2 branches missed.">        if (BattleArmor.LOC_SQUAD != loc) {</span>
<span class="nc" id="L789">            return super.getInternal(loc);</span>
        }
<span class="nc" id="L791">        return IArmorState.ARMOR_NA;</span>
    }

    /**
     * Battle Armor units have no internals on their squad location.
     *
     * @see megamek.common.Infantry#getOInternal(int )
     */
    @Override
    public int getOInternal(int loc) {
<span class="nc bnc" id="L801" title="All 2 branches missed.">        if (BattleArmor.LOC_SQUAD != loc) {</span>
<span class="nc" id="L802">            return super.getOInternal(loc);</span>
        }
<span class="nc" id="L804">        return IArmorState.ARMOR_NA;</span>
    }

    /**
     * Set the troopers in the unit to the appropriate values.
     */
    @Override
    public void autoSetInternal() {
        // No troopers in the squad location.
<span class="nc" id="L813">        initializeInternal(IArmorState.ARMOR_NA, LOC_SQUAD);</span>

        // Initialize the troopers.
<span class="nc bnc" id="L816" title="All 2 branches missed.">        for (int loop = 1; loop &lt; locations(); loop++) {</span>
<span class="nc" id="L817">            initializeInternal(1, loop);</span>
        }

        // Set the initial number of troopers that can shoot
        // to one less than the number of locations in the unit.
<span class="nc" id="L822">        troopersShooting = locations() - 1;</span>
<span class="nc" id="L823">    }</span>

    /**
     * Set the troopers in the unit to the given values.
     */
    public void setInternal(int value) {
        // Initialize the troopers.
<span class="nc bnc" id="L830" title="All 2 branches missed.">        for (int loop = 1; loop &lt; locations(); loop++) {</span>
<span class="nc" id="L831">            initializeInternal(value, loop);</span>
        }
<span class="nc" id="L833">    }</span>

    /**
     * Mounts the specified equipment in the specified location.
     */
    @Override
    public void addEquipment(Mounted mounted, int loc, boolean rearMounted)
            throws LocationFullException {
        // Implement parent's behavior.
<span class="nc" id="L842">        super.addEquipment(mounted, loc, rearMounted);</span>

        // Is the item a camo system equipment?
<span class="nc" id="L845">        String name = mounted.getType().getInternalName();</span>
<span class="nc bnc" id="L846" title="All 2 branches missed.">        if (BattleArmor.CAMO_SYSTEM.equals(name)) {</span>
<span class="nc" id="L847">            hasCamoSystem = true;</span>
<span class="nc" id="L848">            camoName = name;</span>
        }
<span class="nc" id="L850">    }</span>

    /**
     * Battle Armor units have as many critical slots as they need to hold their
     * equipment.
     */
    @Override
    protected int[] getNoOfSlots() {
<span class="nc bnc" id="L858" title="All 2 branches missed.">        if(!isInitialized) {</span>
<span class="nc" id="L859">            return CLAN_NUM_OF_SLOTS;</span>
        }
<span class="nc bnc" id="L861" title="All 2 branches missed.">        return Arrays.copyOf(isClan() ? CLAN_NUM_OF_SLOTS : IS_NUM_OF_SLOTS, troopers + 1);</span>
    }

    /**
     * Trooper's equipment dies when they do.
     */
    @Override
    public boolean hasHittableCriticals(int loc) {
<span class="nc bnc" id="L869" title="All 2 branches missed.">        if (LOC_SQUAD == loc) {</span>
<span class="nc" id="L870">            return false;</span>
        }
<span class="nc" id="L872">        return super.hasHittableCriticals(loc);</span>
    }

    /**
     * Calculates the battle value of this platoon.
     */
    @Override
    public int calculateBattleValue(boolean ignoreC3, boolean ignorePilot) {
<span class="nc bnc" id="L880" title="All 2 branches missed.">        if (useManualBV) {</span>
<span class="nc" id="L881">            return manualBV;</span>
        }
<span class="nc" id="L883">        return calculateBattleValue(ignoreC3, ignorePilot, false);</span>
    }

    /**
     * Calculates the battle value of this platoon.
     *
     * @param ignoreC3
     *            ignore C3 linkage
     * @param ignorePilot
     *            ignore the skill of the pilot
     * @param singleTrooper
     *            calculate just the BV of a single trooper
     * @return the battlevalue
     */
    public int calculateBattleValue(boolean ignoreC3, boolean ignorePilot,
            boolean singleTrooper) {
<span class="nc bnc" id="L899" title="All 2 branches missed.">        if (useManualBV) {</span>
<span class="nc" id="L900">            return manualBV;</span>
        }
        // we do this per trooper, then add up
<span class="nc" id="L903">        double squadBV = 0;</span>
<span class="nc bnc" id="L904" title="All 2 branches missed.">        for (int i = 1; i &lt; locations(); i++) {</span>
<span class="nc bnc" id="L905" title="All 2 branches missed.">            if (this.getInternal(i) &lt;= 0) {</span>
<span class="nc" id="L906">                continue;</span>
            }
<span class="nc" id="L908">            double dBV = 0;</span>
<span class="nc" id="L909">            double armorBV = 2.5;</span>
<span class="nc bnc" id="L910" title="All 6 branches missed.">            if (isFireResistant() || isReflective() || isReactive()) {</span>
<span class="nc" id="L911">                armorBV = 3.5;</span>
            }
<span class="nc" id="L913">            dBV += (getArmor(i) * armorBV) + 1;</span>
            // improved sensors add 1
<span class="nc bnc" id="L915" title="All 2 branches missed.">            if (hasImprovedSensors()) {</span>
<span class="nc" id="L916">                dBV += 1;</span>
            }
            // active probes add 1
<span class="nc bnc" id="L919" title="All 2 branches missed.">            if (hasActiveProbe()) {</span>
<span class="nc" id="L920">                dBV += 1;</span>
            }
            // ECM adds 1
<span class="nc bnc" id="L923" title="All 2 branches missed.">            for (Mounted mounted : getMisc()) {</span>
<span class="nc bnc" id="L924" title="All 2 branches missed.">                if (mounted.getType().hasFlag(MiscType.F_ECM)) {</span>
<span class="nc bnc" id="L925" title="All 2 branches missed.">                    if (mounted.getType().hasFlag(MiscType.F_ANGEL_ECM)) {</span>
<span class="nc" id="L926">                        dBV += 2;</span>
                    } else {
<span class="nc" id="L928">                        dBV += 1;</span>
                    }
<span class="nc" id="L930">                    break;</span>
                }
<span class="nc" id="L932">            }</span>
<span class="nc bnc" id="L933" title="All 2 branches missed.">            for (Mounted weapon : getWeaponList()) {</span>
<span class="nc bnc" id="L934" title="All 2 branches missed.">                if (weapon.getType().hasFlag(WeaponType.F_AMS)) {</span>
<span class="nc bnc" id="L935" title="All 2 branches missed.">                    if (weapon.getLocation() == LOC_SQUAD) {</span>
<span class="nc" id="L936">                        dBV += weapon.getType().getBV(this);</span>
                    }

                    else {
                        // squad support, count at 1/troopercount
<span class="nc" id="L941">                        dBV += weapon.getType().getBV(this)</span>
<span class="nc" id="L942">                                / getTotalOInternal();</span>
                    }
                }
<span class="nc" id="L945">            }</span>
<span class="nc" id="L946">            int runMP = getWalkMP(false, false, true, true, false);</span>
<span class="nc" id="L947">            int umuMP = getActiveUMUCount();</span>
<span class="nc" id="L948">            int tmmRan = Compute.getTargetMovementModifier(Math.max(runMP,umuMP), false, false,</span>
<span class="nc" id="L949">                    game).getValue();</span>
            // get jump MP, ignoring burden
<span class="nc" id="L951">            int rawJump = getJumpMP(false, true, true);</span>
<span class="nc bnc" id="L952" title="All 2 branches missed.">            int tmmJumped = (rawJump &gt; 0) ? Compute.</span>
<span class="nc" id="L953">                    getTargetMovementModifier(rawJump, true, false, game).</span>
<span class="nc" id="L954">                    getValue() : 0;</span>
<span class="nc" id="L955">                    double targetMovementModifier = Math.max(tmmRan, tmmJumped);</span>
<span class="nc" id="L956">                    double tmmFactor = 1 + (targetMovementModifier / 10) + 0.1;</span>
<span class="nc bnc" id="L957" title="All 2 branches missed.">                    if (hasCamoSystem) {</span>
<span class="nc" id="L958">                        tmmFactor += 0.2;</span>
                    }
<span class="nc bnc" id="L960" title="All 2 branches missed.">                    if (isStealthy) {</span>
<span class="nc" id="L961">                        tmmFactor += 0.2;</span>
                    }
                    // improved stealth get's an extra 0.1, for 0.3 total
<span class="nc bnc" id="L964" title="All 2 branches missed.">                    if ((stealthName != null)</span>
<span class="nc bnc" id="L965" title="All 2 branches missed.">                            &amp;&amp; stealthName.equals(BattleArmor.IMPROVED_STEALTH_ARMOR)) {</span>
<span class="nc" id="L966">                        tmmFactor += 0.1;</span>
                    }
<span class="nc bnc" id="L968" title="All 2 branches missed.">                    if (isMimetic) {</span>
<span class="nc" id="L969">                        tmmFactor += 0.3;</span>
                    }

<span class="nc" id="L972">                    dBV *= tmmFactor;</span>
<span class="nc" id="L973">                    double oBV = 0;</span>
<span class="nc bnc" id="L974" title="All 2 branches missed.">                    for (Mounted weapon : getWeaponList()) {</span>
                        // infantry weapons don't count at all
<span class="nc bnc" id="L976" title="All 4 branches missed.">                        if (weapon.getType().hasFlag(WeaponType.F_INFANTRY) || weapon.getType().hasFlag(WeaponType.F_AMS)) {</span>
<span class="nc" id="L977">                            continue;</span>
                        }

<span class="nc bnc" id="L980" title="All 2 branches missed.">                        if (weapon.getLocation() == LOC_SQUAD) {</span>
                            // Squad support, count at 1/troopercount
<span class="nc bnc" id="L982" title="All 2 branches missed.">                            if (weapon.isSquadSupportWeapon()){</span>
<span class="nc" id="L983">                                oBV += weapon.getType().getBV(this) / getTotalOInternal();</span>
                            } else {
<span class="nc" id="L985">                                oBV += weapon.getType().getBV(this);</span>
                            }
                        } else {
<span class="nc" id="L988">                            oBV += weapon.getType().getBV(this) / getTotalOInternal();</span>
                        }
<span class="nc" id="L990">                    }</span>

<span class="nc bnc" id="L992" title="All 2 branches missed.">                    for (Mounted misc : getMisc()) {</span>
<span class="nc bnc" id="L993" title="All 2 branches missed.">                        if (misc.getType().hasFlag(MiscType.F_MINE)) {</span>
<span class="nc bnc" id="L994" title="All 2 branches missed.">                            if (misc.getLocation() == LOC_SQUAD) {</span>
<span class="nc" id="L995">                                oBV += misc.getType().getBV(this);</span>
                            } else {
<span class="nc" id="L997">                                oBV += misc.getType().getBV(this) / getTotalOInternal();</span>
                            }
                        }
<span class="nc bnc" id="L1000" title="All 2 branches missed.">                        if (misc.getType().hasFlag(MiscType.F_MAGNETIC_CLAMP)) {</span>
<span class="nc bnc" id="L1001" title="All 2 branches missed.">                            if (misc.getLocation() == LOC_SQUAD) {</span>
<span class="nc" id="L1002">                                oBV += misc.getType().getBV(this);</span>
                            } else {
<span class="nc" id="L1004">                                oBV += misc.getType().getBV(this) / getTotalOInternal();</span>
                            }
                        }
<span class="nc" id="L1007">                    }</span>
<span class="nc bnc" id="L1008" title="All 2 branches missed.">                    for (Mounted ammo : getAmmo()) {</span>
<span class="nc" id="L1009">                        int loc = ammo.getLocation();</span>
                        // don't count oneshot ammo
<span class="nc bnc" id="L1011" title="All 2 branches missed.">                        if (loc == LOC_NONE) {</span>
<span class="nc" id="L1012">                            continue;</span>
                        }
<span class="nc bnc" id="L1014" title="All 4 branches missed.">                        if ((loc == LOC_SQUAD) || (loc == i)) {</span>
<span class="nc" id="L1015">                            double ammoBV = ((AmmoType) ammo.getType()).getBABV();</span>
<span class="nc" id="L1016">                            oBV += ammoBV;</span>
                        }
<span class="nc" id="L1018">                    }</span>
<span class="nc bnc" id="L1019" title="All 2 branches missed.">                    if (canMakeAntiMekAttacks()) {</span>
                        // all non-missile and non-body mounted direct fire weapons
                        // counted again
<span class="nc bnc" id="L1022" title="All 2 branches missed.">                        for (Mounted weapon : getWeaponList()) {</span>
                            // infantry weapons don't count at all
<span class="nc bnc" id="L1024" title="All 4 branches missed.">                            if (weapon.getType().hasFlag(WeaponType.F_INFANTRY) || weapon.getType().hasFlag(WeaponType.F_AMS)) {</span>
<span class="nc" id="L1025">                                continue;</span>
                            }
<span class="nc bnc" id="L1027" title="All 2 branches missed.">                            if (weapon.getLocation() == LOC_SQUAD) {</span>
<span class="nc bnc" id="L1028" title="All 2 branches missed.">                                if (!weapon.getType().hasFlag(WeaponType.F_MISSILE)</span>
<span class="nc bnc" id="L1029" title="All 2 branches missed.">                                        &amp;&amp; !weapon.isBodyMounted()) {</span>
<span class="nc" id="L1030">                                    oBV += weapon.getType().getBV(this);</span>
                                }
                            } else {
                                // squad support, count at 1/troopercount
<span class="nc" id="L1034">                                oBV += weapon.getType().getBV(this)</span>
<span class="nc" id="L1035">                                        / getTotalOInternal();</span>
                            }
<span class="nc" id="L1037">                        }</span>
                        // magnetic claws and vibro claws counted again
<span class="nc bnc" id="L1039" title="All 2 branches missed.">                        for (Mounted misc : getMisc()) {</span>
<span class="nc bnc" id="L1040" title="All 2 branches missed.">                            if ((misc.getLocation() == LOC_SQUAD)</span>
<span class="nc bnc" id="L1041" title="All 2 branches missed.">                                    || (misc.getLocation() == i)) {</span>
<span class="nc bnc" id="L1042" title="All 2 branches missed.">                                if (misc.getType().hasFlag(MiscType.F_MAGNET_CLAW)</span>
<span class="nc bnc" id="L1043" title="All 2 branches missed.">                                        || misc.getType().hasFlag(MiscType.F_VIBROCLAW)) {</span>
<span class="nc" id="L1044">                                    oBV += misc.getType().getBV(this);</span>
                                }
                            }
<span class="nc" id="L1047">                        }</span>
                    }
                    // getJumpMP won't return UMU MP, so weed need to count that extra
<span class="nc" id="L1050">                    int movement = Math.max(getWalkMP(false, false, true, true, false),</span>
<span class="nc" id="L1051">                            Math.max(getJumpMP(false, true, true), getActiveUMUCount()));</span>
<span class="nc" id="L1052">                    double speedFactor = Math.pow(1 + ((double) (movement - 5) / 10), 1.2);</span>
<span class="nc" id="L1053">                    speedFactor = Math.round(speedFactor * 100) / 100.0;</span>
<span class="nc" id="L1054">                    oBV *= speedFactor;</span>

                    double soldierBV;
<span class="nc bnc" id="L1057" title="All 2 branches missed.">                    if (useGeometricMeanBV()) {</span>
<span class="nc" id="L1058">                        soldierBV = 2 * Math.sqrt(oBV * dBV);</span>
<span class="nc bnc" id="L1059" title="All 2 branches missed.">                        if (soldierBV == 0) {</span>
<span class="nc" id="L1060">                            soldierBV = oBV + dBV;</span>
                        }
                    } else {
<span class="nc" id="L1063">                        soldierBV = oBV + dBV;</span>
                    }

<span class="nc" id="L1066">                    squadBV += soldierBV;</span>

                    /*
                     * if (i == 1) { System.out.println(getChassis()+getModel());
                     * System.out.println(dBV); System.out.println(oBV);
                     * System.out.println((oBV+dBV)); }
                     */
        }
        // we have now added all troopers, divide by current strength to then
        // multiply by the unit size mod
<span class="nc" id="L1076">        squadBV /= getShootingStrength();</span>
        // we might want to get just the BV of a single trooper
<span class="nc bnc" id="L1078" title="All 2 branches missed.">        if (singleTrooper) {</span>
<span class="nc" id="L1079">            return (int) Math.round(squadBV);</span>
        }
<span class="nc bnc" id="L1081" title="All 7 branches missed.">        switch (getShootingStrength()) {</span>
        case 1:
<span class="nc" id="L1083">            break;</span>
        case 2:
<span class="nc" id="L1085">            squadBV *= 2.2;</span>
<span class="nc" id="L1086">            break;</span>
        case 3:
<span class="nc" id="L1088">            squadBV *= 3.6;</span>
<span class="nc" id="L1089">            break;</span>
        case 4:
<span class="nc" id="L1091">            squadBV *= 5.2;</span>
<span class="nc" id="L1092">            break;</span>
        case 5:
<span class="nc" id="L1094">            squadBV *= 7;</span>
<span class="nc" id="L1095">            break;</span>
        case 6:
<span class="nc" id="L1097">            squadBV *= 9;</span>
            break;
        }

<span class="nc bnc" id="L1101" title="All 2 branches missed.">        if (!ignoreC3) {</span>
<span class="nc" id="L1102">            squadBV += getExtraC3BV((int) Math.round(squadBV));</span>
        }

        // Adjust BV for crew skills.
<span class="nc" id="L1106">        double pilotFactor = 1;</span>
<span class="nc bnc" id="L1107" title="All 2 branches missed.">        if (!ignorePilot) {</span>
<span class="nc" id="L1108">            pilotFactor = getCrew().getBVSkillMultiplier(isAntiMekTrained(), game);</span>
        }

<span class="nc" id="L1111">        int retVal = (int) Math.round(squadBV * pilotFactor);</span>
<span class="nc" id="L1112">        return retVal;</span>
    }

    /**
     * Prepare the entity for a new round of action.
     */
    @Override
    public void newRound(int roundNumber) {
        // Perform all base-class behavior.
<span class="nc" id="L1121">        super.newRound(roundNumber);</span>

        // If we're equipped with a Magnetic Mine
        // launcher, turn it to single shot mode.
<span class="nc bnc" id="L1125" title="All 2 branches missed.">        for (Mounted m : getMisc()) {</span>
<span class="nc" id="L1126">            EquipmentType equip = m.getType();</span>
<span class="nc bnc" id="L1127" title="All 2 branches missed.">            if (BattleArmor.MINE_LAUNCHER.equals(equip.getInternalName())) {</span>
<span class="nc" id="L1128">                m.setMode(&quot;Single&quot;);</span>
            }
<span class="nc" id="L1130">        }</span>
<span class="nc" id="L1131">    }</span>

    /**
     * Update the unit to reflect damages taken in this phase.
     */
    @Override
    public void applyDamage() {
<span class="nc" id="L1138">        super.applyDamage();</span>
<span class="nc" id="L1139">        int troopersAlive = 0;</span>
<span class="nc bnc" id="L1140" title="All 2 branches missed.">        for (int i = 0; i &lt; locations(); i++) {</span>
<span class="nc bnc" id="L1141" title="All 2 branches missed.">            if (getInternal(i) &gt; 0) {</span>
<span class="nc" id="L1142">                troopersAlive++;</span>
            }
        }
<span class="nc" id="L1145">        troopersShooting = troopersAlive;</span>
<span class="nc" id="L1146">    }</span>

    /**
     * Get the number of men in the unit (before damage is applied).
     *
     * @see megamek.common.Infantry#getShootingStrength
     */
    @Override
    public int getShootingStrength() {
<span class="nc" id="L1155">        return troopersShooting;</span>
    }

    public void setCost(int inC) {
<span class="nc" id="L1159">        myCost = inC;</span>
<span class="nc" id="L1160">    }</span>

    /**
     * Determines if the battle armor unit is burdened with un-jettisoned
     * equipment. This can prevent the unit from jumping or using their special
     * Anti-Mek attacks.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if the unit hasn't jettisoned its equipment
     *         yet, &lt;code&gt;false&lt;/code&gt; if it has.
     */
    public boolean isBurdened() {

        // Clan Elemental points are never burdened by equipment.
<span class="nc bnc" id="L1173" title="All 2 branches missed.">        if (!isClan()) {</span>

            // if we have ammo left for a body mounted missile launcher,
            // we are burdened
<span class="nc bnc" id="L1177" title="All 2 branches missed.">            for (Mounted mounted : getAmmo()) {</span>
<span class="nc bnc" id="L1178" title="All 2 branches missed.">                if (mounted.getUsableShotsLeft() == 0) {</span>
                    // no shots left, we don't count
<span class="nc" id="L1180">                    continue;</span>
                }
                // first get the weapon we are linked by
                // (so we basically only check the currently loaded
                // ammo, but if the weapon has no currently loaded ammo, we're
                // fine
<span class="nc" id="L1186">                Mounted weapon = mounted.getLinkedBy();</span>
<span class="nc bnc" id="L1187" title="All 4 branches missed.">                if ((weapon != null) &amp;&amp; weapon.isBodyMounted()</span>
<span class="nc bnc" id="L1188" title="All 2 branches missed.">                        &amp;&amp; weapon.getType().hasFlag(WeaponType.F_MISSILE)) {</span>
<span class="nc" id="L1189">                    return true;</span>
                }
<span class="nc" id="L1191">            } // Check the next piece of equipment</span>

        } // End is-inner-sphere-squad

        // Unit isn't burdened.
<span class="nc" id="L1196">        return false;</span>
    }

    @Override
    public boolean canMakeAntiMekAttacks() {
<span class="nc bnc" id="L1201" title="All 4 branches missed.">        return !isBurdened() &amp;&amp; canDoMechanizedBA()</span>
<span class="nc bnc" id="L1202" title="All 2 branches missed.">                &amp;&amp; (getWeightClass() &lt; EntityWeightClass.WEIGHT_HEAVY)</span>
<span class="nc bnc" id="L1203" title="All 2 branches missed.">                &amp;&amp; (getMovementMode() != EntityMovementMode.INF_UMU);</span>
    }

    /**
     * does this BA have an unjettisoned DWP?
     *
     * @return
     */
    public boolean hasDWP() {
<span class="nc bnc" id="L1212" title="All 2 branches missed.">        for (Mounted mounted : getWeaponList()) {</span>
<span class="nc bnc" id="L1213" title="All 2 branches missed.">            if (mounted.isDWPMounted()) {</span>
<span class="nc bnc" id="L1214" title="All 2 branches missed.">                if (mounted.isMissing()) {</span>
<span class="nc" id="L1215">                    continue;</span>
<span class="nc bnc" id="L1216" title="All 2 branches missed.">                } else if ((mounted.getLinked() != null)</span>
<span class="nc bnc" id="L1217" title="All 2 branches missed.">                        &amp;&amp; (mounted.getLinked().getUsableShotsLeft() &gt; 0)) {</span>
<span class="nc" id="L1218">                    return true;</span>
<span class="nc bnc" id="L1219" title="All 2 branches missed.">                } else if ((mounted.getLinked() == null)</span>
<span class="nc bnc" id="L1220" title="All 2 branches missed.">                        &amp;&amp; !mounted.isMissing()) {</span>
<span class="nc" id="L1221">                    return true;</span>
                }
            }
<span class="nc" id="L1224">        }</span>
<span class="nc" id="L1225">        return false;</span>
    }

    /**
     * Returns true if this &lt;code&gt;BattleArmor&lt;/code&gt; can use a detachable weapon
     * pack. A &lt;code&gt;BattleArmor&lt;/code&gt; must have 2 or more walking MP and be
     * Medium or heavier to mount DWP.
     *
     * @return
     */
    public boolean canMountDWP() {
<span class="nc bnc" id="L1236" title="All 2 branches missed.">        return (getOriginalWalkMP() &gt;= 2)</span>
<span class="nc bnc" id="L1237" title="All 2 branches missed.">                &amp;&amp; (getWeightClass() &gt;= EntityWeightClass.WEIGHT_MEDIUM);</span>
    }

    /**
     * Returns the name of the stealth Armor used by the BA. Mostly for
     * MegaMekLab Usage.
     *
     * @return name of the stealth armor.
     */
    public String getStealthName() {
<span class="nc" id="L1247">        return stealthName;</span>
    }

    public String getCamoName() {
<span class="nc" id="L1251">        return camoName;</span>
    }

    /**
     * Public interface to the BattleArmors short range stealth modifier
     *
     * @return shortStealthMod
     */
    public int getShortStealthMod() {
<span class="nc" id="L1260">        return shortStealthMod;</span>
    }

    /**
     * Public interface to the BattleArmors medium range stealth modifier
     *
     * @return mediumStealthMod
     */
    public int getMediumStealthMod() {
<span class="nc" id="L1269">        return mediumStealthMod;</span>
    }

    /**
     * Public interface to the BattleArmors long range stealth modifier
     *
     * @return longStealthMod
     */
    public int getLongStealthMod() {
<span class="nc" id="L1278">        return longStealthMod;</span>
    }

    /**
     * Determine if this unit has an active stealth system.
     * &lt;p/&gt;
     * Sub-classes are encouraged to override this method.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if this unit has a stealth system that is
     *         currently active, &lt;code&gt;false&lt;/code&gt; if there is no stealth
     *         system or if it is inactive.
     */
    @Override
    public boolean isStealthActive() {
<span class="nc bnc" id="L1292" title="All 6 branches missed.">        return (isStealthy || isMimetic || hasCamoSystem);</span>
    }

    public boolean isMimetic() {
<span class="nc" id="L1296">        return isMimetic;</span>
    }

    public boolean hasCamoSystem() {
<span class="nc" id="L1300">        return hasCamoSystem;</span>
    }

    public boolean isStealthy() {
<span class="nc" id="L1304">        return isStealthy;</span>
    }

    /**
     * Determine the stealth modifier for firing at this unit from the given
     * range. If the value supplied for &lt;code&gt;range&lt;/code&gt; is not one of the
     * &lt;code&gt;Entity&lt;/code&gt; class range constants, an
     * &lt;code&gt;IllegalArgumentException&lt;/code&gt; will be thrown.
     * &lt;p/&gt;
     * Sub-classes are encouraged to override this method.
     *
     * @param range
     *            - an &lt;code&gt;int&lt;/code&gt; value that must match one of the
     *            &lt;code&gt;Compute&lt;/code&gt; class range constants.
     * @param ae
     *            - the entity making the attack.
     * @return a &lt;code&gt;TargetRoll&lt;/code&gt; value that contains the stealth
     *         modifier for the given range.
     */
    @Override
    public TargetRoll getStealthModifier(int range, Entity ae) {
<span class="nc" id="L1325">        TargetRoll result = null;</span>

        // Note: infantry are immune to stealth, but not camoflage
        // or mimetic armor

        // Mimetic armor modifier is based upon the number of hexes moved,
        // and adds to existing movement modifier (Total Warfare p228):
        // 0 hexes moved +3 movement modifier
        // 1 hex moved +2 movement modifier
        // 2 hexes moved +1 movement modifier
        // 3+ hexes moved +0 movement modifier
<span class="nc bnc" id="L1336" title="All 4 branches missed.">        if (isMimetic &amp;&amp; !hasMyomerBooster()) {</span>
<span class="nc" id="L1337">            int mmod = 3 - delta_distance;</span>
<span class="nc" id="L1338">            mmod = Math.max(0, mmod);</span>
<span class="nc" id="L1339">            result = new TargetRoll(mmod, &quot;mimetic armor&quot;);</span>
        }

        // Stealthy units alreay have their to-hit mods defined.
<span class="nc bnc" id="L1343" title="All 6 branches missed.">        if (isStealthy</span>
                &amp;&amp; !((ae instanceof Infantry) &amp;&amp; !(ae instanceof BattleArmor))
<span class="nc bnc" id="L1345" title="All 2 branches missed.">                &amp;&amp; !hasMyomerBooster()) {</span>
<span class="nc bnc" id="L1346" title="All 5 branches missed.">            switch (range) {</span>
            case RangeType.RANGE_MINIMUM:
            case RangeType.RANGE_SHORT:
<span class="nc" id="L1349">                result = new TargetRoll(shortStealthMod, stealthName);</span>
<span class="nc" id="L1350">                break;</span>
            case RangeType.RANGE_MEDIUM:
<span class="nc" id="L1352">                result = new TargetRoll(mediumStealthMod, stealthName);</span>
<span class="nc" id="L1353">                break;</span>
            case RangeType.RANGE_LONG:
            case RangeType.RANGE_EXTREME:
            case RangeType.RANGE_LOS:
<span class="nc" id="L1357">                result = new TargetRoll(longStealthMod, stealthName);</span>
<span class="nc" id="L1358">                break;</span>
            case RangeType.RANGE_OUT:
<span class="nc" id="L1360">                break;</span>
            default:
<span class="nc" id="L1362">                throw new IllegalArgumentException(</span>
                        &quot;Unknown range constant: &quot; + range);
            }
        }

        // Simple camo modifier is on top of the movement modifier
        // 0 hexes moved +2 movement modifier
        // 1 hexes moved +1 movement modifier
        // 2+ hexes moved no modifier
        // This can also be in addition to any armor except Mimetic!
<span class="nc bnc" id="L1372" title="All 4 branches missed.">        if (hasCamoSystem &amp;&amp; (delta_distance &lt; 2)) {</span>
<span class="nc" id="L1373">            int mod = Math.max(2 - delta_distance, 0);</span>
<span class="nc bnc" id="L1374" title="All 2 branches missed.">            if (result == null) {</span>
<span class="nc" id="L1375">                result = new TargetRoll(mod, &quot;camoflage&quot;);</span>
            } else {
<span class="nc" id="L1377">                result.append(new TargetRoll(mod, &quot;camoflage&quot;));</span>
            }
        }

<span class="nc bnc" id="L1381" title="All 2 branches missed.">        if (result == null) {</span>
<span class="nc" id="L1382">            result = new TargetRoll(0, &quot;stealth not active&quot;);</span>
        }

        // Return the result.
<span class="nc" id="L1386">        return result;</span>
    } // End public TargetRoll getStealthModifier( char )

    @Override
    public double getCost(boolean ignoreAmmo) {
<span class="nc" id="L1391">        return getCost(ignoreAmmo, true);</span>
    }

    @Override
    public double getAlternateCost() {
<span class="nc" id="L1396">        return getCost(false, false);</span>
    }

    public double getCost(boolean ignoreAmmo, boolean includeTrainingAndClan) {

<span class="nc bnc" id="L1401" title="All 2 branches missed.">        if(getChassis().equals(&quot;Longinus Battle Armor&quot;)</span>
<span class="nc bnc" id="L1402" title="All 4 branches missed.">                &amp;&amp; getModel().equals(&quot;[Flamer]&quot;)</span>
                &amp;&amp; !includeTrainingAndClan) {
        }

<span class="nc" id="L1406">        double cost = 0;</span>
<span class="nc bnc" id="L1407" title="All 4 branches missed.">        switch (weightClass) {</span>
        case EntityWeightClass.WEIGHT_MEDIUM:
<span class="nc" id="L1409">            cost += 100000;</span>
<span class="nc bnc" id="L1410" title="All 2 branches missed.">            if (getMovementMode() == EntityMovementMode.VTOL) {</span>
<span class="nc" id="L1411">                cost += getOriginalJumpMP() * 100000;</span>
            } else {
<span class="nc" id="L1413">                cost += getOriginalJumpMP() * 75000;</span>
            }
<span class="nc" id="L1415">            break;</span>
        case EntityWeightClass.WEIGHT_HEAVY:
<span class="nc" id="L1417">            cost += 200000;</span>
<span class="nc bnc" id="L1418" title="All 2 branches missed.">            if (getMovementMode() == EntityMovementMode.INF_UMU) {</span>
<span class="nc" id="L1419">                cost += getOriginalJumpMP() * 100000;</span>
            } else {
<span class="nc" id="L1421">                cost += getOriginalJumpMP() * 150000;</span>
            }
<span class="nc" id="L1423">            break;</span>
        case EntityWeightClass.WEIGHT_ASSAULT:
<span class="nc" id="L1425">            cost += 400000;</span>
<span class="nc bnc" id="L1426" title="All 2 branches missed.">            if (getMovementMode() == EntityMovementMode.INF_UMU) {</span>
<span class="nc" id="L1427">                cost += getOriginalJumpMP() * 150000;</span>
            } else {
<span class="nc" id="L1429">                cost += getOriginalJumpMP() * 300000;</span>
            }
<span class="nc" id="L1431">            break;</span>
        default:
<span class="nc" id="L1433">            cost += 50000;</span>
<span class="nc" id="L1434">            cost += 50000 * getOriginalJumpMP();</span>
        }
<span class="nc" id="L1436">        cost += 25000 * (getOriginalWalkMP() - 1);</span>

        // damn, manipulators are supposed to be treated as structural costs
        // and get multiplied by 1.1 if clan
<span class="nc" id="L1440">        long manipulatorCost = 0;</span>
<span class="nc bnc" id="L1441" title="All 2 branches missed.">        for (Mounted mounted : getEquipment()) {</span>
<span class="nc bnc" id="L1442" title="All 2 branches missed.">            if ((mounted.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L1443" title="All 2 branches missed.">                    &amp;&amp; ((MiscType) mounted.getType()).hasFlag(MiscType.F_BA_MANIPULATOR)) {</span>
<span class="nc" id="L1444">                long itemCost = (long) mounted.getCost();</span>
<span class="nc" id="L1445">                manipulatorCost += itemCost;</span>
            }

<span class="nc" id="L1448">        }</span>
<span class="nc" id="L1449">        cost += manipulatorCost;</span>

<span class="nc" id="L1451">        double baseArmorCost = 10000;</span>
<span class="nc bnc" id="L1452" title="All 6 branches missed.">        switch(getArmorType(LOC_TROOPER_1)) {</span>
        case EquipmentType.T_ARMOR_BA_STANDARD_ADVANCED:
<span class="nc" id="L1454">            baseArmorCost = 12500;</span>
<span class="nc" id="L1455">            break;</span>
        case EquipmentType.T_ARMOR_BA_MIMETIC:
        case EquipmentType.T_ARMOR_BA_STEALTH:
<span class="nc" id="L1458">            baseArmorCost =  15000;</span>
<span class="nc" id="L1459">            break;</span>
        case EquipmentType.T_ARMOR_BA_STEALTH_BASIC:
<span class="nc" id="L1461">            baseArmorCost =  12000;</span>
<span class="nc" id="L1462">            break;</span>
        case EquipmentType.T_ARMOR_BA_STEALTH_IMP:
<span class="nc" id="L1464">            baseArmorCost =  20000;</span>
<span class="nc" id="L1465">            break;</span>
        case EquipmentType.T_ARMOR_BA_STEALTH_PROTOTYPE:
<span class="nc" id="L1467">            baseArmorCost =  50000;</span>
<span class="nc" id="L1468">            break;</span>
        case EquipmentType.T_ARMOR_BA_FIRE_RESIST:
        case EquipmentType.T_ARMOR_BA_STANDARD_PROTOTYPE:
        case EquipmentType.T_ARMOR_BA_STANDARD:
        default:
<span class="nc" id="L1473">            baseArmorCost =  10000;</span>
        }

<span class="nc" id="L1476">        cost += (baseArmorCost * getOArmor(LOC_TROOPER_1));</span>

        // training cost and clan mod
<span class="nc bnc" id="L1479" title="All 2 branches missed.">        if (includeTrainingAndClan) {</span>
<span class="nc bnc" id="L1480" title="All 2 branches missed.">            if (isClan()) {</span>
<span class="nc" id="L1481">                cost *= 1.1;</span>
<span class="nc" id="L1482">                cost += 200000;</span>
            } else {
<span class="nc" id="L1484">                cost += 150000;</span>
            }
        }

        // TODO: we do not track the modular weapons mount for 1000 C-bills in
        // the unit files
<span class="nc" id="L1490">        cost += getWeaponsAndEquipmentCost(ignoreAmmo) - manipulatorCost;</span>

<span class="nc" id="L1492">        return getSquadSize() * cost;</span>
    }

    @Override
    public boolean hasEiCockpit() {
<span class="nc" id="L1497">        return true;</span>
    }

    public void setWeightClass(int inWC) {
<span class="nc bnc" id="L1501" title="All 6 branches missed.">        switch (inWC) {</span>
        case 0:
<span class="nc" id="L1503">            weightClass = EntityWeightClass.WEIGHT_ULTRA_LIGHT;</span>
<span class="nc" id="L1504">            break;</span>
        case 1:
<span class="nc" id="L1506">            weightClass = EntityWeightClass.WEIGHT_LIGHT;</span>
<span class="nc" id="L1507">            break;</span>
        case 2:
<span class="nc" id="L1509">            weightClass = EntityWeightClass.WEIGHT_MEDIUM;</span>
<span class="nc" id="L1510">            break;</span>
        case 3:
<span class="nc" id="L1512">            weightClass = EntityWeightClass.WEIGHT_HEAVY;</span>
<span class="nc" id="L1513">            break;</span>
        case 4:
<span class="nc" id="L1515">            weightClass = EntityWeightClass.WEIGHT_ASSAULT;</span>
            break;
        }
<span class="nc" id="L1518">    }</span>

    public double getTrooperWeight() {
<span class="nc" id="L1521">        return EntityWeightClass.getClassLimit(getWeightClass(), this);</span>
    }

    @Override
    public int getWeightClass() {
<span class="nc" id="L1526">        return weightClass;</span>
    }

    public int getTroopers() {
<span class="nc" id="L1530">        return troopers;</span>
    }

    public void setTroopers(int troopers) {
<span class="nc" id="L1534">        this.troopers = troopers;</span>
        // this is also squad size
<span class="nc" id="L1536">        setSquadSize(troopers);</span>
<span class="nc" id="L1537">    }</span>

    public void setChassisType(int inCT) {
<span class="nc" id="L1540">        chassisType = inCT;</span>
<span class="nc" id="L1541">    }</span>

    public int getChassisType() {
<span class="nc" id="L1544">        return chassisType;</span>
    }

    @Override
    public boolean canAssaultDrop() {
<span class="nc" id="L1549">        return true;</span>
    }

    @Override
    public boolean isNuclearHardened() {
<span class="nc" id="L1554">        return true;</span>
    }

    public boolean isTrooperActive(int trooperNum) {
<span class="nc bnc" id="L1558" title="All 2 branches missed.">        return (getInternal(trooperNum) &gt; 0);</span>
    }

    public int getNumberActiverTroopers() {
<span class="nc" id="L1562">        int count = 0;</span>
        // Initialize the troopers.
<span class="nc bnc" id="L1564" title="All 2 branches missed.">        for (int loop = 1; loop &lt; locations(); loop++) {</span>
<span class="nc bnc" id="L1565" title="All 2 branches missed.">            if (isTrooperActive(loop)) {</span>
<span class="nc" id="L1566">                count++;</span>
            }
        }
<span class="nc" id="L1569">        return count;</span>
    }

    public int getRandomTrooper() {
<span class="nc" id="L1573">        Vector&lt;Integer&gt; activeTroops = new Vector&lt;Integer&gt;();</span>
<span class="nc bnc" id="L1574" title="All 2 branches missed.">        for (int loop = 1; loop &lt; locations(); loop++) {</span>
<span class="nc bnc" id="L1575" title="All 2 branches missed.">            if (isTrooperActive(loop)) {</span>
<span class="nc" id="L1576">                activeTroops.add(loop);</span>
            }
        }
<span class="nc" id="L1579">        int locInt = Compute.randomInt(activeTroops.size());</span>
<span class="nc" id="L1580">        return activeTroops.elementAt(locInt);</span>
    }

    @Override
    public boolean loadWeapon(Mounted mounted, Mounted mountedAmmo) {
        // BA must carry the ammo in same location as the weapon.
        // except for mine launcher mines
        // This allows for squad weapons and individual trooper weapons
        // such as NARC and the support weapons in TW/TO
<span class="nc" id="L1589">        AmmoType at = (AmmoType) mountedAmmo.getType();</span>
<span class="nc bnc" id="L1590" title="All 2 branches missed.">        if (!(at.getAmmoType() == AmmoType.T_MINE)</span>
<span class="nc bnc" id="L1591" title="All 2 branches missed.">                &amp;&amp; (mounted.getLocation() != mountedAmmo.getLocation())) {</span>
<span class="nc" id="L1592">            return false;</span>
        }
<span class="nc" id="L1594">        return super.loadWeapon(mounted, mountedAmmo);</span>
    }

    @Override
    public boolean loadWeaponWithSameAmmo(Mounted mounted, Mounted mountedAmmo) {
        // BA must carry the ammo in same location as the weapon.
        // except for mine launcher mines
        // This allows for squad weapons and individual trooper weapons
        // such as NARC and the support weapons in TW/TO
<span class="nc" id="L1603">        AmmoType at = (AmmoType) mountedAmmo.getType();</span>
<span class="nc bnc" id="L1604" title="All 2 branches missed.">        if (!(at.getAmmoType() == AmmoType.T_MINE)</span>
<span class="nc bnc" id="L1605" title="All 2 branches missed.">                &amp;&amp; (mounted.getLocation() != mountedAmmo.getLocation())) {</span>
<span class="nc" id="L1606">            return false;</span>
        }
<span class="nc" id="L1608">        return super.loadWeaponWithSameAmmo(mounted, mountedAmmo);</span>
    }

    public final String getBLK() {
<span class="nc" id="L1612">        String newline = &quot;\r\n&quot;;</span>
<span class="nc" id="L1613">        StringBuffer buff = new StringBuffer();</span>
<span class="nc" id="L1614">        buff.append(&quot;&lt;BlockVersion&gt;&quot;);</span>
<span class="nc" id="L1615">        buff.append(newline);</span>
<span class="nc" id="L1616">        buff.append(&quot;1&quot;);</span>
<span class="nc" id="L1617">        buff.append(newline);</span>
<span class="nc" id="L1618">        buff.append(&quot;&lt;/BlockVersion&gt;&quot;);</span>
<span class="nc" id="L1619">        buff.append(newline);</span>

<span class="nc" id="L1621">        buff.append(&quot;&lt;UnitType&gt;&quot;);</span>
<span class="nc" id="L1622">        buff.append(newline);</span>
<span class="nc" id="L1623">        buff.append(&quot;BattleArmor&quot;);</span>
<span class="nc" id="L1624">        buff.append(newline);</span>
<span class="nc" id="L1625">        buff.append(&quot;&lt;/UnitType&gt;&quot;);</span>
<span class="nc" id="L1626">        buff.append(newline);</span>

<span class="nc" id="L1628">        buff.append(&quot;&lt;name&gt;&quot;);</span>
<span class="nc" id="L1629">        buff.append(newline);</span>
<span class="nc" id="L1630">        buff.append(getChassis());</span>
<span class="nc" id="L1631">        buff.append(newline);</span>
<span class="nc" id="L1632">        buff.append(&quot;&lt;/name&gt;&quot;);</span>
<span class="nc" id="L1633">        buff.append(newline);</span>

<span class="nc" id="L1635">        buff.append(&quot;&lt;model&gt;&quot;);</span>
<span class="nc" id="L1636">        buff.append(newline);</span>
<span class="nc" id="L1637">        buff.append(getModel());</span>
<span class="nc" id="L1638">        buff.append(newline);</span>
<span class="nc" id="L1639">        buff.append(&quot;&lt;/model&gt;&quot;);</span>
<span class="nc" id="L1640">        buff.append(newline);</span>

<span class="nc" id="L1642">        buff.append(&quot;&lt;year&gt;&quot;);</span>
<span class="nc" id="L1643">        buff.append(newline);</span>
<span class="nc" id="L1644">        buff.append(getYear());</span>
<span class="nc" id="L1645">        buff.append(newline);</span>
<span class="nc" id="L1646">        buff.append(&quot;&lt;/year&gt;&quot;);</span>
<span class="nc" id="L1647">        buff.append(newline);</span>

<span class="nc" id="L1649">        buff.append(&quot;&lt;type&gt;&quot;);</span>
<span class="nc" id="L1650">        buff.append(newline);</span>
<span class="nc bnc" id="L1651" title="All 10 branches missed.">        switch (getTechLevel()) {</span>
        case TechConstants.T_INTRO_BOXSET:
<span class="nc" id="L1653">            buff.append(&quot;IS Level 1&quot;);</span>
<span class="nc" id="L1654">            break;</span>
        case TechConstants.T_IS_TW_NON_BOX:
<span class="nc" id="L1656">            buff.append(&quot;IS Level 2&quot;);</span>
<span class="nc" id="L1657">            break;</span>
        case TechConstants.T_IS_ADVANCED:
<span class="nc" id="L1659">            buff.append(&quot;IS Level 3&quot;);</span>
<span class="nc" id="L1660">            break;</span>
        case TechConstants.T_IS_EXPERIMENTAL:
<span class="nc" id="L1662">            buff.append(&quot;IS Level 4&quot;);</span>
<span class="nc" id="L1663">            break;</span>
        case TechConstants.T_IS_UNOFFICIAL:
<span class="nc" id="L1665">            buff.append(&quot;IS Level 5&quot;);</span>
<span class="nc" id="L1666">            break;</span>
        case TechConstants.T_CLAN_TW:
<span class="nc" id="L1668">            buff.append(&quot;Clan Level 2&quot;);</span>
<span class="nc" id="L1669">            break;</span>
        case TechConstants.T_CLAN_ADVANCED:
<span class="nc" id="L1671">            buff.append(&quot;Clan Level 3&quot;);</span>
<span class="nc" id="L1672">            break;</span>
        case TechConstants.T_CLAN_EXPERIMENTAL:
<span class="nc" id="L1674">            buff.append(&quot;Clan Level 4&quot;);</span>
<span class="nc" id="L1675">            break;</span>
        case TechConstants.T_CLAN_UNOFFICIAL:
<span class="nc" id="L1677">            buff.append(&quot;Clan Level 5&quot;);</span>
            break;
        }
<span class="nc" id="L1680">        buff.append(newline);</span>
<span class="nc" id="L1681">        buff.append(&quot;&lt;/type&gt;&quot;);</span>
<span class="nc" id="L1682">        buff.append(newline);</span>

<span class="nc" id="L1684">        buff.append(&quot;&lt;trooper count&gt;&quot;);</span>
<span class="nc" id="L1685">        buff.append(newline);</span>
<span class="nc" id="L1686">        buff.append(getWeight());</span>
<span class="nc" id="L1687">        buff.append(newline);</span>
<span class="nc" id="L1688">        buff.append(&quot;&lt;/trooper count&gt;&quot;);</span>
<span class="nc" id="L1689">        buff.append(newline);</span>

<span class="nc" id="L1691">        buff.append(&quot;&lt;weightclass&gt;&quot;);</span>
<span class="nc" id="L1692">        buff.append(newline);</span>
<span class="nc bnc" id="L1693" title="All 6 branches missed.">        switch (getWeightClass()) {</span>
        case EntityWeightClass.WEIGHT_ULTRA_LIGHT:
<span class="nc" id="L1695">            buff.append(&quot;0&quot;);</span>
<span class="nc" id="L1696">            break;</span>
        case EntityWeightClass.WEIGHT_LIGHT:
<span class="nc" id="L1698">            buff.append(&quot;1&quot;);</span>
<span class="nc" id="L1699">            break;</span>
        case EntityWeightClass.WEIGHT_MEDIUM:
<span class="nc" id="L1701">            buff.append(&quot;2&quot;);</span>
<span class="nc" id="L1702">            break;</span>
        case EntityWeightClass.WEIGHT_HEAVY:
<span class="nc" id="L1704">            buff.append(&quot;3&quot;);</span>
<span class="nc" id="L1705">            break;</span>
        case EntityWeightClass.WEIGHT_ASSAULT:
<span class="nc" id="L1707">            buff.append(&quot;4&quot;);</span>
            break;
        }
<span class="nc" id="L1710">        buff.append(newline);</span>
<span class="nc" id="L1711">        buff.append(&quot;&lt;/weightclass&gt;&quot;);</span>
<span class="nc" id="L1712">        buff.append(newline);</span>

<span class="nc" id="L1714">        buff.append(&quot;&lt;motion_type&gt;&quot;);</span>
<span class="nc" id="L1715">        buff.append(newline);</span>
<span class="nc bnc" id="L1716" title="All 5 branches missed.">        switch (getMovementMode()) {</span>
        case INF_JUMP:
<span class="nc" id="L1718">            buff.append(&quot;jump&quot;);</span>
<span class="nc" id="L1719">            break;</span>
        case INF_LEG:
<span class="nc" id="L1721">            buff.append(&quot;leg&quot;);</span>
<span class="nc" id="L1722">            break;</span>
        case VTOL:
<span class="nc" id="L1724">            buff.append(&quot;vtol&quot;);</span>
<span class="nc" id="L1725">            break;</span>
        case INF_UMU:
<span class="nc" id="L1727">            buff.append(&quot;submarine&quot;);</span>
<span class="nc" id="L1728">            break;</span>
        default:
<span class="nc" id="L1730">            buff.append(&quot;none&quot;);</span>
            break;
        }
<span class="nc" id="L1733">        buff.append(newline);</span>
<span class="nc" id="L1734">        buff.append(&quot;&lt;/motion_type&gt;&quot;);</span>
<span class="nc" id="L1735">        buff.append(newline);</span>

<span class="nc" id="L1737">        buff.append(&quot;&lt;chassis&gt;&quot;);</span>
<span class="nc" id="L1738">        buff.append(newline);</span>
<span class="nc bnc" id="L1739" title="All 3 branches missed.">        switch (getChassisType()) {</span>
        case BattleArmor.CHASSIS_TYPE_BIPED:
<span class="nc" id="L1741">            buff.append(&quot;biped&quot;);</span>
<span class="nc" id="L1742">            break;</span>
        case BattleArmor.CHASSIS_TYPE_QUAD:
<span class="nc" id="L1744">            buff.append(&quot;quad&quot;);</span>
            break;
        }
<span class="nc" id="L1747">        buff.append(&quot;&lt;/chassis&gt;&quot;);</span>
<span class="nc" id="L1748">        buff.append(newline);</span>

<span class="nc" id="L1750">        buff.append(&quot;&lt;cruiseMP&gt;&quot;);</span>
<span class="nc" id="L1751">        buff.append(newline);</span>
<span class="nc" id="L1752">        buff.append(getOriginalRunMP());</span>
<span class="nc" id="L1753">        buff.append(newline);</span>
<span class="nc" id="L1754">        buff.append(&quot;&lt;/cruiseMP&gt;&quot;);</span>
<span class="nc" id="L1755">        buff.append(newline);</span>

<span class="nc" id="L1757">        buff.append(&quot;&lt;jumpMP&gt;&quot;);</span>
<span class="nc" id="L1758">        buff.append(newline);</span>
<span class="nc" id="L1759">        buff.append(getOriginalJumpMP());</span>
<span class="nc" id="L1760">        buff.append(newline);</span>
<span class="nc" id="L1761">        buff.append(&quot;&lt;/jumpMP&gt;&quot;);</span>
<span class="nc" id="L1762">        buff.append(newline);</span>

<span class="nc" id="L1764">        buff.append(&quot;&lt;armor&gt;&quot;);</span>
<span class="nc" id="L1765">        buff.append(newline);</span>
<span class="nc" id="L1766">        buff.append(getOArmor(LOC_TROOPER_1));</span>
<span class="nc" id="L1767">        buff.append(newline);</span>
<span class="nc" id="L1768">        buff.append(&quot;&lt;/armor&gt;&quot;);</span>
<span class="nc" id="L1769">        buff.append(newline);</span>
        
<span class="nc bnc" id="L1771" title="All 2 branches missed.">        if (getTurretCapacity() &gt; 0) {</span>
<span class="nc" id="L1772">            buff.append(&quot;&lt;turret&gt;&quot;);</span>
<span class="nc" id="L1773">            buff.append(newline);</span>
<span class="nc bnc" id="L1774" title="All 2 branches missed.">            if (hasModularTurretMount()) {</span>
<span class="nc" id="L1775">                buff.append(&quot;Modular:&quot;);</span>
            } else {
<span class="nc" id="L1777">                buff.append(&quot;Standard:&quot;);</span>
            }
<span class="nc" id="L1779">            buff.append(String.valueOf(getTurretCapacity()));</span>
<span class="nc" id="L1780">            buff.append(&quot;&lt;/turret&gt;&quot;);</span>
<span class="nc" id="L1781">            buff.append(newline);</span>
        }

<span class="nc" id="L1784">        buff.append(&quot;&lt;armor_type&gt;&quot;);</span>
<span class="nc" id="L1785">        buff.append(newline);</span>
<span class="nc" id="L1786">        buff.append(getArmorType(LOC_SQUAD));</span>
<span class="nc" id="L1787">        buff.append(newline);</span>
<span class="nc" id="L1788">        buff.append(&quot;&lt;/armor_type&gt;&quot;);</span>
<span class="nc" id="L1789">        buff.append(newline);</span>

<span class="nc" id="L1791">        buff.append(&quot;&lt;armor_tech&gt;&quot;);</span>
<span class="nc" id="L1792">        buff.append(newline);</span>
<span class="nc" id="L1793">        buff.append(getArmorTechLevel(LOC_SQUAD));</span>
<span class="nc" id="L1794">        buff.append(newline);</span>
<span class="nc" id="L1795">        buff.append(&quot;&lt;/armor_tech&gt;&quot;);</span>
<span class="nc" id="L1796">        buff.append(newline);</span>

<span class="nc bnc" id="L1798" title="All 2 branches missed.">        for (int i = 0; i &lt; locations(); i++) {</span>
<span class="nc" id="L1799">            boolean found = false;</span>
<span class="nc bnc" id="L1800" title="All 2 branches missed.">            for (Mounted m : getEquipment()) {</span>
                // don't write out swarm and leg attack, those get added
                // dynamically
<span class="nc bnc" id="L1803" title="All 2 branches missed.">                if ((m.getType() instanceof WeaponType)</span>
<span class="nc bnc" id="L1804" title="All 2 branches missed.">                        &amp;&amp; m.getType().hasFlag(WeaponType.F_INFANTRY_ATTACK)) {</span>
<span class="nc" id="L1805">                    continue;</span>
                }
<span class="nc bnc" id="L1807" title="All 2 branches missed.">                if (m.getLocation() == i) {</span>
<span class="nc bnc" id="L1808" title="All 2 branches missed.">                    if (!found) {</span>
<span class="nc" id="L1809">                        found = true;</span>
<span class="nc" id="L1810">                        buff.append(&quot;&lt;&quot;);</span>
<span class="nc" id="L1811">                        buff.append(getLocationName(i));</span>
<span class="nc" id="L1812">                        buff.append(&quot; equipment&gt;&quot;);</span>
<span class="nc" id="L1813">                        buff.append(newline);</span>
                    }
<span class="nc" id="L1815">                    buff.append(m.getType().getInternalName());</span>
<span class="nc" id="L1816">                    buff.append(newline);</span>
                }
<span class="nc" id="L1818">            }</span>
<span class="nc bnc" id="L1819" title="All 2 branches missed.">            if (found) {</span>
<span class="nc" id="L1820">                buff.append(&quot;&lt;/&quot;);</span>
<span class="nc" id="L1821">                buff.append(getLocationName(i));</span>
<span class="nc" id="L1822">                buff.append(&quot; equipment&gt;&quot;);</span>
<span class="nc" id="L1823">                buff.append(newline);</span>
            }
        }

<span class="nc" id="L1827">        return buff.toString();</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#getVibroClaws()
     */
    @Override
    public int getVibroClaws() {
<span class="nc" id="L1837">        int claws = 0;</span>
<span class="nc bnc" id="L1838" title="All 2 branches missed.">        for (Mounted mounted : getMisc()) {</span>
<span class="nc bnc" id="L1839" title="All 2 branches missed.">            if (mounted.getType().hasFlag(MiscType.F_VIBROCLAW)) {</span>
<span class="nc" id="L1840">                claws++;</span>
            }
<span class="nc" id="L1842">        }</span>
<span class="nc" id="L1843">        return claws;</span>
    }

    /**
     * return if this BA has fire resistant armor
     *
     * @return
     */
    public boolean isFireResistant() {
<span class="nc bnc" id="L1852" title="All 2 branches missed.">        for (Mounted equip : getMisc()) {</span>
<span class="nc bnc" id="L1853" title="All 2 branches missed.">            if (equip.getType().hasFlag(MiscType.F_FIRE_RESISTANT)) {</span>
<span class="nc" id="L1854">                return true;</span>
            }
<span class="nc" id="L1856">        }</span>
<span class="nc" id="L1857">        return false;</span>
    }

    /**
     * return if this BA has laser reflective armor
     *
     * @return
     */
    public boolean isReflective() {
<span class="nc bnc" id="L1866" title="All 2 branches missed.">        for (Mounted equip : getMisc()) {</span>
<span class="nc bnc" id="L1867" title="All 2 branches missed.">            if (equip.getType().hasFlag(MiscType.F_REFLECTIVE)) {</span>
<span class="nc" id="L1868">                return true;</span>
            }
<span class="nc" id="L1870">        }</span>
<span class="nc" id="L1871">        return false;</span>
    }

    /**
     * return if this BA has reactive armor
     * @return
     */
    public boolean isReactive() {
<span class="nc bnc" id="L1879" title="All 2 branches missed.">        for (Mounted equip : getMisc()) {</span>
<span class="nc bnc" id="L1880" title="All 2 branches missed.">            if (equip.getType().hasFlag(MiscType.F_REACTIVE)) {</span>
<span class="nc" id="L1881">                return true;</span>
            }
<span class="nc" id="L1883">        }</span>
<span class="nc" id="L1884">        return false;</span>
    }

    /**
     * return if this BA has improved sensors
     *
     * @return
     */
    public boolean hasImprovedSensors() {
<span class="nc bnc" id="L1893" title="All 2 branches missed.">        for (Mounted equip : getMisc()) {</span>
<span class="nc bnc" id="L1894" title="All 2 branches missed.">            if (equip.getType().hasFlag(MiscType.F_BAP)) {</span>
<span class="nc bnc" id="L1895" title="All 2 branches missed.">                if (equip.getType().getInternalName().equals(Sensor.ISIMPROVED)</span>
<span class="nc" id="L1896">                        || equip.getType().getInternalName()</span>
<span class="nc bnc" id="L1897" title="All 2 branches missed.">                        .equals(Sensor.CLIMPROVED)) {</span>
<span class="nc" id="L1898">                    return true;</span>
                }
            }
<span class="nc" id="L1901">        }</span>
<span class="nc" id="L1902">        return false;</span>
    }

    /**
     * return if the BA has any kind of active probe
     *
     * @return
     */
    public boolean hasActiveProbe() {
<span class="nc bnc" id="L1911" title="All 2 branches missed.">        for (Mounted equip : getMisc()) {</span>
<span class="nc bnc" id="L1912" title="All 2 branches missed.">            if (equip.getType().hasFlag(MiscType.F_BAP)</span>
<span class="nc" id="L1913">                    &amp;&amp; !(equip.getType().getInternalName()</span>
<span class="nc bnc" id="L1914" title="All 2 branches missed.">                            .equals(Sensor.ISIMPROVED) || equip.getType()</span>
<span class="nc bnc" id="L1915" title="All 2 branches missed.">                            .getInternalName().equals(Sensor.CLIMPROVED))) {</span>
<span class="nc" id="L1916">                return true;</span>
            }
<span class="nc" id="L1918">        }</span>
<span class="nc" id="L1919">        return false;</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Entity#canTransferCriticals(int)
     */
    @Override
    public boolean canTransferCriticals(int loc) {
        // BAs can never transfer crits
<span class="nc" id="L1930">        return false;</span>
    }

    /**
     * can this BattleArmor ride as Mechanized BA?
     *
     * @return
     */
    public boolean canDoMechanizedBA() {
<span class="nc bnc" id="L1939" title="All 2 branches missed.">        if (getChassisType() != CHASSIS_TYPE_QUAD) {</span>
<span class="nc bnc" id="L1940" title="All 2 branches missed.">            if (hasWorkingMisc(MiscType.F_MAGNETIC_CLAMP)) {</span>
<span class="nc" id="L1941">                return true;</span>
            }
<span class="nc" id="L1943">            int tBasicManipulatorCount = countWorkingMisc(MiscType.F_BASIC_MANIPULATOR);</span>
<span class="nc" id="L1944">            int tArmoredGloveCount = countWorkingMisc(MiscType.F_ARMORED_GLOVE);</span>
<span class="nc" id="L1945">            int tBattleClawCount = countWorkingMisc(MiscType.F_BATTLE_CLAW);</span>
<span class="nc bnc" id="L1946" title="All 4 branches missed.">            switch (getWeightClass()) {</span>
            case EntityWeightClass.WEIGHT_ULTRA_LIGHT:
            case EntityWeightClass.WEIGHT_LIGHT:
<span class="nc bnc" id="L1949" title="All 6 branches missed.">                if ((tArmoredGloveCount &gt; 1)</span>
                        || (tBasicManipulatorCount &gt; 0)
                        || (tBattleClawCount &gt; 0)) {
<span class="nc" id="L1952">                    return true;</span>
                }
                break;
            case EntityWeightClass.WEIGHT_MEDIUM:
<span class="nc bnc" id="L1956" title="All 4 branches missed.">                if ((tBasicManipulatorCount &gt; 0) || (tBattleClawCount &gt; 0)) {</span>
<span class="nc" id="L1957">                    return true;</span>
                }
                break;
            case EntityWeightClass.WEIGHT_HEAVY:
<span class="nc bnc" id="L1961" title="All 4 branches missed.">                if ((tBasicManipulatorCount &gt; 0) || (tBattleClawCount &gt; 0)) {</span>
<span class="nc" id="L1962">                    return true;</span>
                }
                break;
            case EntityWeightClass.WEIGHT_ASSAULT:
            default:
<span class="nc" id="L1967">                return false;</span>
            }
        }
<span class="nc" id="L1970">        return false;</span>
    }

    @Override
    public double getWeight() {
        // If following Total Warfare rules each BA trooper will weigh a ton
        // for transport purposes. Following Tactical Operations gives us a
        // more realistic weight per trooper
<span class="nc bnc" id="L1978" title="All 2 branches missed.">        if ((game != null)</span>
<span class="nc bnc" id="L1979" title="All 2 branches missed.">                &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_BA_WEIGHT)) {</span>
<span class="nc" id="L1980">            double troopton = troopers;</span>
<span class="nc bnc" id="L1981" title="All 6 branches missed.">            switch (getWeightClass()) {</span>
            case EntityWeightClass.WEIGHT_ULTRA_LIGHT:
<span class="nc" id="L1983">                troopton = troopers * 0.25;</span>
<span class="nc" id="L1984">                break;</span>
            case EntityWeightClass.WEIGHT_LIGHT:
<span class="nc" id="L1986">                troopton = troopers * 0.5;</span>
<span class="nc" id="L1987">                break;</span>
            case EntityWeightClass.WEIGHT_MEDIUM:
<span class="nc" id="L1989">                troopton = troopers * 1.0;</span>
<span class="nc" id="L1990">                break;</span>
            case EntityWeightClass.WEIGHT_HEAVY:
<span class="nc" id="L1992">                troopton = troopers * 1.5;</span>
<span class="nc" id="L1993">                break;</span>
            case EntityWeightClass.WEIGHT_ASSAULT:
<span class="nc" id="L1995">                troopton = troopers * 2.0;</span>
<span class="nc" id="L1996">                break;</span>
            default:
<span class="nc" id="L1998">                troopton = troopers;</span>
            }
<span class="nc" id="L2000">            return troopton;</span>
        } else {
<span class="nc" id="L2002">            return troopers;</span>
        }
    }

    public double getAlternateWeight() {
        double troopton;
<span class="nc bnc" id="L2008" title="All 6 branches missed.">        switch (getWeightClass()) {</span>
        case EntityWeightClass.WEIGHT_ULTRA_LIGHT:
<span class="nc" id="L2010">            troopton = troopers * 0.25;</span>
<span class="nc" id="L2011">            break;</span>
        case EntityWeightClass.WEIGHT_LIGHT:
<span class="nc" id="L2013">            troopton = troopers * 0.5;</span>
<span class="nc" id="L2014">            break;</span>
        case EntityWeightClass.WEIGHT_MEDIUM:
<span class="nc" id="L2016">            troopton = troopers * 1.0;</span>
<span class="nc" id="L2017">            break;</span>
        case EntityWeightClass.WEIGHT_HEAVY:
<span class="nc" id="L2019">            troopton = troopers * 1.5;</span>
<span class="nc" id="L2020">            break;</span>
        case EntityWeightClass.WEIGHT_ASSAULT:
<span class="nc" id="L2022">            troopton = troopers * 2.0;</span>
<span class="nc" id="L2023">            break;</span>
        default:
<span class="nc" id="L2025">            troopton = troopers;</span>
        }
<span class="nc" id="L2027">        return troopton;</span>
    }

    @Override
    public int getWeaponArc(int wn) {
<span class="nc" id="L2032">        return Compute.ARC_360;</span>
    }

    @Override
    public boolean isHardenedArmorDamaged(HitData hit) {
<span class="nc" id="L2037">        return false;</span>
    }

    @Override
    public boolean hasPatchworkArmor() {
<span class="nc" id="L2042">        return false;</span>
    }

    @Override
    public void setBattleForceMovement(Map&lt;String,Integer&gt; movement) {
<span class="nc bnc" id="L2047" title="All 2 branches missed.">        if (hasDWP()) {</span>
<span class="nc" id="L2048">        	movement.put(&quot;&quot;, getWalkMP());</span>
        }
<span class="nc" id="L2050">        int move = Math.max(getWalkMP(true, false, false, true, false),</span>
<span class="nc" id="L2051">                getJumpMP(true, true, true));</span>
<span class="nc" id="L2052">        movement.put(getMovementModeAsBattleForceString(), move);</span>
<span class="nc" id="L2053">    }    </span>

    @Override
    public void setAlphaStrikeMovement(Map&lt;String,Integer&gt; moves) {
<span class="nc bnc" id="L2057" title="All 2 branches missed.">        if (getMovementMode().equals(EntityMovementMode.INF_JUMP)) {</span>
<span class="nc" id="L2058">            moves.put(&quot;j&quot;, getJumpMP(true, true, true) * 2);</span>
<span class="nc bnc" id="L2059" title="All 2 branches missed.">        } else if (getMovementMode().equals(EntityMovementMode.INF_UMU)) {</span>
<span class="nc" id="L2060">            moves.put(&quot;s&quot;, getActiveUMUCount() * 2);</span>
        } else {
<span class="nc" id="L2062">            moves.put(getMovementModeAsBattleForceString(), getOriginalWalkMP() * 2);</span>
        }
<span class="nc" id="L2064">    }</span>
    
    @Override
    public int getBattleForceArmorPoints() {
<span class="nc" id="L2068">        double armor = 0;</span>
<span class="nc bnc" id="L2069" title="All 2 branches missed.">        for (int i = 1; i &lt; locations(); i++) {</span>
<span class="nc bnc" id="L2070" title="All 4 branches missed.">            if (armorType[i] == EquipmentType.T_ARMOR_BA_REACTIVE</span>
                    || armorType[i] == EquipmentType.T_ARMOR_BA_REFLECTIVE) {
<span class="nc" id="L2072">                armor += getArmor(i) * 0.75;</span>
            } else {
<span class="nc" id="L2074">                armor += getArmor(i);</span>
            }
        }
<span class="nc" id="L2077">        return (int)Math.round(armor / 30.0);</span>
    }

    @Override
    /**
     * Each BA squad has 2 structure points
     */
    public int getBattleForceStructurePoints() {
<span class="nc" id="L2085">        return 2;</span>
    }

    @Override
    public void addBattleForceSpecialAbilities(Map&lt;BattleForceSPA,Integer&gt; specialAbilities) {
<span class="nc" id="L2090">        super.addBattleForceSpecialAbilities(specialAbilities);</span>
<span class="nc bnc" id="L2091" title="All 2 branches missed.">        for (Mounted m : getEquipment()) {</span>
<span class="nc bnc" id="L2092" title="All 2 branches missed.">            if (!(m.getType() instanceof MiscType)) {</span>
<span class="nc" id="L2093">                continue;</span>
            }
<span class="nc bnc" id="L2095" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_VISUAL_CAMO)</span>
<span class="nc bnc" id="L2096" title="All 2 branches missed.">                    &amp;&amp; !m.getType().getName().equals(MIMETIC_ARMOR)) {</span>
<span class="nc" id="L2097">                specialAbilities.put(BattleForceSPA.LMAS, null);</span>
<span class="nc bnc" id="L2098" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_VEHICLE_MINE_DISPENSER)) {</span>
<span class="nc" id="L2099">                specialAbilities.merge(BattleForceSPA.MDS, 1, Integer::sum);</span>
<span class="nc bnc" id="L2100" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_TOOLS)</span>
<span class="nc bnc" id="L2101" title="All 2 branches missed.">                    &amp;&amp; (m.getType().getSubType() &amp; MiscType.S_MINESWEEPER) == MiscType.S_MINESWEEPER) {</span>
<span class="nc" id="L2102">                specialAbilities.put(BattleForceSPA.MSW, null);</span>
<span class="nc bnc" id="L2103" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_SPACE_ADAPTATION)) {</span>
<span class="nc" id="L2104">                specialAbilities.put(BattleForceSPA.SOA, null);</span>
<span class="nc bnc" id="L2105" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_PARAFOIL)) {</span>
<span class="nc" id="L2106">                specialAbilities.put(BattleForceSPA.PARA, null);</span>
<span class="nc bnc" id="L2107" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_MAGNETIC_CLAMP)) {</span>
<span class="nc" id="L2108">                specialAbilities.put(BattleForceSPA.XMEC, null);</span>
            }
<span class="nc" id="L2110">        }</span>
<span class="nc bnc" id="L2111" title="All 2 branches missed.">        if (canDoMechanizedBA()) {</span>
<span class="nc" id="L2112">            specialAbilities.put(BattleForceSPA.MEC, null);</span>
        }
<span class="nc bnc" id="L2114" title="All 3 branches missed.">        switch (getArmorType(0)) {</span>
        case EquipmentType.T_ARMOR_BA_MIMETIC:
<span class="nc" id="L2116">            specialAbilities.put(BattleForceSPA.MAS, null);</span>
<span class="nc" id="L2117">            break;</span>
        case EquipmentType.T_ARMOR_BA_FIRE_RESIST:
<span class="nc" id="L2119">            specialAbilities.put(BattleForceSPA.FR, null);</span>
            break;
        }
<span class="nc" id="L2122">    }</span>

    public void setIsExoskeleton(boolean exoskeleton) {
<span class="nc" id="L2125">        this.exoskeleton = exoskeleton;</span>
<span class="nc" id="L2126">    }</span>

    public boolean isExoskeleton() {
<span class="nc" id="L2129">        return exoskeleton;</span>
    }

    @Override
    public boolean isCrippled() {
<span class="nc" id="L2134">        double activeTroopPercent = (double) getNumberActiverTroopers() / getSquadSize();</span>
<span class="nc bnc" id="L2135" title="All 2 branches missed.">        if (activeTroopPercent &lt; 0.5) {</span>
<span class="nc" id="L2136">            MegaMek.getLogger().debug(getDisplayName() + &quot; CRIPPLED: Only &quot;</span>
<span class="nc" id="L2137">                    + NumberFormat.getPercentInstance().format(activeTroopPercent) + &quot; troops remaining.&quot;);</span>
<span class="nc" id="L2138">            return true;</span>
        } else {
<span class="nc" id="L2140">            return false;</span>
        }
    }

    @Override
    public boolean isDmgHeavy() {
<span class="nc bnc" id="L2146" title="All 2 branches missed.">        return (((double) getNumberActiverTroopers() / getSquadSize()) &lt; 0.67);</span>
    }

    @Override
    public boolean isDmgModerate() {
<span class="nc bnc" id="L2151" title="All 2 branches missed.">        return (((double) getNumberActiverTroopers() / getSquadSize()) &lt; 0.75);</span>
    }

    @Override
    public boolean isDmgLight() {
<span class="nc bnc" id="L2156" title="All 2 branches missed.">        return (((double) getNumberActiverTroopers() / getSquadSize()) &lt; 0.9);</span>
    }

    public int calculateSwarmDamage() {
<span class="nc" id="L2160">        int damage = 0;</span>
<span class="nc bnc" id="L2161" title="All 2 branches missed.">        for (Mounted m : getWeaponList()) {</span>
            WeaponType wtype;
<span class="nc bnc" id="L2163" title="All 2 branches missed.">            if (m.getType() instanceof WeaponType) {</span>
<span class="nc" id="L2164">                wtype = (WeaponType) m.getType();</span>
<span class="nc bnc" id="L2165" title="All 2 branches missed.">                if (wtype.hasFlag(WeaponType.F_MISSILE)) {</span>
<span class="nc" id="L2166">                    continue;</span>
                }
<span class="nc bnc" id="L2168" title="All 2 branches missed.">                if (m.isBodyMounted()) {</span>
<span class="nc" id="L2169">                    continue;</span>
                }
<span class="nc bnc" id="L2171" title="All 2 branches missed.">                if (wtype instanceof InfantryWeapon) {</span>
<span class="nc" id="L2172">                    continue;</span>
                }
<span class="nc bnc" id="L2174" title="All 2 branches missed.">                if (wtype instanceof InfantryAttack) {</span>
<span class="nc" id="L2175">                    continue;</span>
                }
<span class="nc" id="L2177">                int addToDamage = wtype.getDamage(0);</span>
<span class="nc bnc" id="L2178" title="All 2 branches missed.">                if (addToDamage &lt; 0) {</span>
<span class="nc" id="L2179">                    continue;</span>
                }
                // if it's a squad mounted weapon, each trooper hits
<span class="nc bnc" id="L2182" title="All 2 branches missed.">                if (m.getLocation() == BattleArmor.LOC_SQUAD) {</span>
<span class="nc" id="L2183">                    addToDamage *= getShootingStrength();</span>
                }
<span class="nc" id="L2185">                damage += addToDamage;</span>
            }
<span class="nc" id="L2187">        }</span>
<span class="nc bnc" id="L2188" title="All 2 branches missed.">        if (hasMyomerBooster()) {</span>
<span class="nc" id="L2189">            damage += getTroopers() * 2;</span>
        }
<span class="nc" id="L2191">        return damage;</span>
    }

    public boolean isConventionalInfantry() {
<span class="nc" id="L2195">        return false;</span>
    }

    @Override
    public long getEntityType(){
<span class="nc" id="L2200">        return Entity.ETYPE_INFANTRY | Entity.ETYPE_BATTLEARMOR;</span>
    }

    public int getMaximumJumpMP() {
<span class="nc" id="L2204">        return getMaximumJumpMP(false);</span>
    }

    /**
     * Returns the maximum jump MP that this BA can have.
     *
     * @param ignoreEquipment
     *            If true, bonuses from equipment like partial wing and jump
     *            booster are ignored. This is important for construction
     *            purposes, where we shouldn't allow the JSpinner to select
     *            these values.
     * @return
     */
    public int getMaximumJumpMP(boolean ignoreEquipment) {
<span class="nc bnc" id="L2218" title="All 2 branches missed.">        if(chassisType == CHASSIS_TYPE_QUAD) {</span>
<span class="nc" id="L2219">            return 0;</span>
        }
<span class="nc" id="L2221">        int max = 2;</span>
<span class="nc bnc" id="L2222" title="All 2 branches missed.">        if(getMovementMode() == EntityMovementMode.INF_UMU) {</span>
<span class="nc bnc" id="L2223" title="All 2 branches missed.">            if(getWeightClass() &lt;= EntityWeightClass.WEIGHT_LIGHT) {</span>
<span class="nc" id="L2224">                max = 5;</span>
            }
<span class="nc bnc" id="L2226" title="All 2 branches missed.">            else if(getWeightClass() == EntityWeightClass.WEIGHT_MEDIUM) {</span>
<span class="nc" id="L2227">                max = 4;</span>
            }
<span class="nc bnc" id="L2229" title="All 2 branches missed.">            else if(getWeightClass() == EntityWeightClass.WEIGHT_HEAVY) {</span>
<span class="nc" id="L2230">                max = 3;</span>
            }
            else {
<span class="nc" id="L2233">                max = 2;</span>
            }
        }
<span class="nc bnc" id="L2236" title="All 2 branches missed.">        else if(getMovementMode() == EntityMovementMode.VTOL) {</span>
<span class="nc bnc" id="L2237" title="All 2 branches missed.">            if(getWeightClass() == EntityWeightClass.WEIGHT_ULTRA_LIGHT) {</span>
<span class="nc" id="L2238">                max = 7;</span>
            }
<span class="nc bnc" id="L2240" title="All 2 branches missed.">            else if(getWeightClass() == EntityWeightClass.WEIGHT_LIGHT) {</span>
<span class="nc" id="L2241">                max = 6;</span>
            }
<span class="nc bnc" id="L2243" title="All 2 branches missed.">            else if(getWeightClass() == EntityWeightClass.WEIGHT_MEDIUM) {</span>
<span class="nc" id="L2244">                max = 5;</span>
            }
            else {
<span class="nc" id="L2247">                max = 0;</span>
            }
        }
        else {
<span class="nc bnc" id="L2251" title="All 2 branches missed.">            if(getWeightClass() &lt; EntityWeightClass.WEIGHT_HEAVY) {</span>
<span class="nc" id="L2252">                max = 3;</span>
            }
        }

        // Partial wings and jump boosters add 1 jump MP and can increase it
        //  over the max and they cannot be used together
<span class="nc bnc" id="L2258" title="All 2 branches missed.">        if (!ignoreEquipment</span>
<span class="nc bnc" id="L2259" title="All 2 branches missed.">                &amp;&amp; (hasWorkingMisc(MiscType.F_JUMP_BOOSTER)</span>
<span class="nc bnc" id="L2260" title="All 2 branches missed.">                        || hasWorkingMisc(MiscType.F_PARTIAL_WING))){</span>
<span class="nc" id="L2261">            max++;</span>
        }

<span class="nc" id="L2264">        return max;</span>
    }

    public int getMinimumWalkMP() {
<span class="nc bnc" id="L2268" title="All 2 branches missed.">        if(chassisType == CHASSIS_TYPE_QUAD) {</span>
<span class="nc" id="L2269">            return 2;</span>
        }
<span class="nc" id="L2271">        return 1;</span>
    }

    public int getMaximumWalkMP() {
<span class="nc" id="L2275">        int max = 2;</span>
<span class="nc bnc" id="L2276" title="All 2 branches missed.">        if(getWeightClass() &lt; EntityWeightClass.WEIGHT_HEAVY) {</span>
<span class="nc" id="L2277">            max = 3;</span>
        }
<span class="nc bnc" id="L2279" title="All 2 branches missed.">        if(chassisType == CHASSIS_TYPE_QUAD) {</span>
<span class="nc" id="L2280">            max += 2;</span>
        }

        // Mechanical jump boosters add 1 MP and can increase it over the max
<span class="nc bnc" id="L2284" title="All 2 branches missed.">        if (hasWorkingMisc(MiscType.F_MECHANICAL_JUMP_BOOSTER)){</span>
<span class="nc" id="L2285">            max++;</span>
        }

<span class="nc bnc" id="L2288" title="All 2 branches missed.">        if (hasMyomerBooster()){</span>
<span class="nc bnc" id="L2289" title="All 3 branches missed.">            switch (getWeightClass()){</span>
            case EntityWeightClass.WEIGHT_ULTRA_LIGHT:
            case EntityWeightClass.WEIGHT_LIGHT:
            case EntityWeightClass.WEIGHT_MEDIUM:
<span class="nc" id="L2293">                max += 2;</span>
<span class="nc" id="L2294">                break;</span>
            case EntityWeightClass.WEIGHT_HEAVY:
            case EntityWeightClass.WEIGHT_ASSAULT:
<span class="nc" id="L2297">                max++;</span>
                break;
            }
        }


<span class="nc" id="L2303">        return max;</span>
    }

    public int getMaximumArmorPoints() {
<span class="nc bnc" id="L2307" title="All 6 branches missed.">        switch(getWeightClass()) {</span>
        case EntityWeightClass.WEIGHT_ULTRA_LIGHT:
<span class="nc" id="L2309">            return 2;</span>
        case EntityWeightClass.WEIGHT_LIGHT:
<span class="nc" id="L2311">            return 6;</span>
        case EntityWeightClass.WEIGHT_MEDIUM:
<span class="nc" id="L2313">            return 10;</span>
        case EntityWeightClass.WEIGHT_HEAVY:
<span class="nc" id="L2315">            return 14;</span>
        case EntityWeightClass.WEIGHT_ASSAULT:
<span class="nc" id="L2317">            return 18;</span>
        default:
<span class="nc" id="L2319">            return 0;</span>
        }
    }

    @Override
    public void setArmorType(int armType) {
<span class="nc bnc" id="L2325" title="All 2 branches missed.">        for (int i = 0; i &lt; 7; i++) {</span>
<span class="nc" id="L2326">            armorType[i] = armType;</span>
        }

        // Set some special state for certain armor types
<span class="nc bnc" id="L2330" title="All 2 branches missed.">        if(armType == EquipmentType.T_ARMOR_BA_STEALTH_BASIC) {</span>
<span class="nc" id="L2331">            isStealthy = true;</span>
<span class="nc" id="L2332">            shortStealthMod = 0;</span>
<span class="nc" id="L2333">            mediumStealthMod = 1;</span>
<span class="nc" id="L2334">            longStealthMod = 2;</span>
<span class="nc" id="L2335">            stealthName = BattleArmor.BASIC_STEALTH_ARMOR;</span>
<span class="nc bnc" id="L2336" title="All 2 branches missed.">        } else if (armType ==  EquipmentType.T_ARMOR_BA_STEALTH_PROTOTYPE) {</span>
<span class="nc" id="L2337">            isStealthy = true;</span>
<span class="nc" id="L2338">            shortStealthMod = 0;</span>
<span class="nc" id="L2339">            mediumStealthMod = 1;</span>
<span class="nc" id="L2340">            longStealthMod = 2;</span>
<span class="nc" id="L2341">            stealthName = BattleArmor.STEALTH_PROTOTYPE;</span>
<span class="nc bnc" id="L2342" title="All 2 branches missed.">        } else if (armType ==  EquipmentType.T_ARMOR_BA_STEALTH) {</span>
<span class="nc" id="L2343">            isStealthy = true;</span>
<span class="nc" id="L2344">            shortStealthMod = 1;</span>
<span class="nc" id="L2345">            mediumStealthMod = 1;</span>
<span class="nc" id="L2346">            longStealthMod = 2;</span>
<span class="nc" id="L2347">            stealthName = BattleArmor.STANDARD_STEALTH_ARMOR;</span>
<span class="nc bnc" id="L2348" title="All 2 branches missed.">        } else if (armType ==  EquipmentType.T_ARMOR_BA_STEALTH_IMP) {</span>
<span class="nc" id="L2349">            isStealthy = true;</span>
<span class="nc" id="L2350">            shortStealthMod = 1;</span>
<span class="nc" id="L2351">            mediumStealthMod = 2;</span>
<span class="nc" id="L2352">            longStealthMod = 3;</span>
<span class="nc" id="L2353">            stealthName = BattleArmor.IMPROVED_STEALTH_ARMOR;</span>
<span class="nc bnc" id="L2354" title="All 2 branches missed.">        } else if (armType ==  EquipmentType.T_ARMOR_BA_MIMETIC) {</span>
<span class="nc" id="L2355">            isMimetic = true;</span>
<span class="nc" id="L2356">            stealthName = BattleArmor.MIMETIC_ARMOR;</span>
        }
<span class="nc" id="L2358">    }</span>

    public int getArmCrits() {
<span class="nc bnc" id="L2361" title="All 2 branches missed.">        if(getChassisType() == CHASSIS_TYPE_QUAD) {</span>
<span class="nc" id="L2362">            return 0;</span>
        }
<span class="nc bnc" id="L2364" title="All 3 branches missed.">        switch(getWeightClass()) {</span>
        case EntityWeightClass.WEIGHT_ULTRA_LIGHT:
        case EntityWeightClass.WEIGHT_LIGHT:
<span class="nc" id="L2367">            return 2;</span>
        case EntityWeightClass.WEIGHT_MEDIUM:
        case EntityWeightClass.WEIGHT_HEAVY:
<span class="nc" id="L2370">            return 3;</span>
        default:
<span class="nc" id="L2372">            return 4;</span>
        }

    }
    
    public int getBodyCrits() {
<span class="nc bnc" id="L2378" title="All 2 branches missed.">        if(getChassisType() == CHASSIS_TYPE_QUAD) {</span>
<span class="nc" id="L2379">            int turret = 0;</span>
<span class="nc bnc" id="L2380" title="All 2 branches missed.">            if (getTurretCapacity() &gt; 0) {</span>
<span class="nc" id="L2381">                turret = 1;</span>
<span class="nc bnc" id="L2382" title="All 2 branches missed.">                if (hasModularTurretMount()) {</span>
<span class="nc" id="L2383">                    turret++;</span>
                }
            }
<span class="nc bnc" id="L2386" title="All 5 branches missed.">            switch(getWeightClass()) {</span>
            case EntityWeightClass.WEIGHT_ULTRA_LIGHT:
<span class="nc" id="L2388">                return 0;</span>
            case EntityWeightClass.WEIGHT_LIGHT:
<span class="nc" id="L2390">                return 5 - turret;</span>
            case EntityWeightClass.WEIGHT_MEDIUM:
<span class="nc" id="L2392">                return 7 - turret;</span>
            case EntityWeightClass.WEIGHT_HEAVY:
<span class="nc" id="L2394">                return 9 - turret;</span>
            default:
<span class="nc" id="L2396">                return 11 - turret;</span>
            }
        } else {
<span class="nc bnc" id="L2399" title="All 3 branches missed.">            switch(getWeightClass()) {</span>
            case EntityWeightClass.WEIGHT_ULTRA_LIGHT:
<span class="nc" id="L2401">                return 2;</span>
            case EntityWeightClass.WEIGHT_LIGHT:
            case EntityWeightClass.WEIGHT_MEDIUM:
<span class="nc" id="L2404">                return 4;</span>
            default:
<span class="nc" id="L2406">                return 6;</span>
            }
        }
    }
    
    public int getTurretCapacity() {
<span class="nc" id="L2412">        return turretSize;</span>
    }
    
    public void setTurretSize(int capacity) {
<span class="nc" id="L2416">        turretSize = capacity;</span>
<span class="nc" id="L2417">    }</span>
    
    public boolean hasModularTurretMount() {
<span class="nc" id="L2420">        return modularTurret;</span>
    }
    
    public void setModularTurret(boolean modular) {
<span class="nc" id="L2424">        modularTurret = modular;</span>
<span class="nc" id="L2425">    }</span>

    public int getTotalCrits() {
<span class="nc" id="L2428">        return (getArmCrits() * 2) + getBodyCrits() + getTurretCapacity();</span>
    }

    public int getNumCrits(int loc){
<span class="nc bnc" id="L2432" title="All 2 branches missed.">        if (loc == MOUNT_LOC_BODY){</span>
<span class="nc" id="L2433">            return getBodyCrits();</span>
<span class="nc bnc" id="L2434" title="All 4 branches missed.">        } else if ((loc == MOUNT_LOC_LARM) || (loc == MOUNT_LOC_RARM)){</span>
<span class="nc" id="L2435">            return getArmCrits();</span>
<span class="nc bnc" id="L2436" title="All 2 branches missed.">        } else if (loc == MOUNT_LOC_TURRET) {</span>
<span class="nc" id="L2437">            return getTurretCapacity();</span>
        } else {
<span class="nc" id="L2439">            return 0;</span>
        }
    }

    /**
     * Returns the number of allowed anti-mech weapons the supplied location
     * can mount.  The body can mount a set number of anti-mech weapons and a
     * set number of anti-personnel, however for the arms can mount 2 AP or
     * 1 AP and 1 AM.
     *
     * @param loc
     * @return
     */
    public int getNumAllowedAntiMechWeapons(int loc){
<span class="nc bnc" id="L2453" title="All 4 branches missed.">        if ((loc == MOUNT_LOC_LARM) || (loc == MOUNT_LOC_RARM)){</span>
<span class="nc" id="L2454">            return 1;</span>
<span class="nc bnc" id="L2455" title="All 4 branches missed.">        } else if ((loc == MOUNT_LOC_BODY) || (loc == MOUNT_LOC_TURRET)) {</span>
<span class="nc bnc" id="L2456" title="All 2 branches missed.">            if (getChassisType() == CHASSIS_TYPE_QUAD){</span>
<span class="nc" id="L2457">                return 4;</span>
            } else {
<span class="nc" id="L2459">                return 2;</span>
            }
        } else {
<span class="nc" id="L2462">            return 0;</span>
        }
    }

    /**
     * Returns the number of allowed anti-personnel weapons the location can
     * mount. The body can mount a set number of anti-mech weapons and a set
     * number of anti-personnel, however the arms can mount 2 AP or 1 AP and 1
     * AM.
     *
     * @param loc
     * @return
     */
    public int getNumAllowedAntiPersonnelWeapons(int loc, int trooper) {
<span class="nc bnc" id="L2476" title="All 4 branches missed.">        if ((loc == MOUNT_LOC_LARM) || (loc == MOUNT_LOC_RARM)) {</span>
<span class="nc" id="L2477">            boolean hasAntiMech = false;</span>
<span class="nc bnc" id="L2478" title="All 2 branches missed.">            for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L2479" title="All 2 branches missed.">                if (!m.getType().hasFlag(WeaponType.F_INFANTRY)</span>
<span class="nc bnc" id="L2480" title="All 2 branches missed.">                        &amp;&amp; (m.getBaMountLoc() == loc)</span>
<span class="nc bnc" id="L2481" title="All 4 branches missed.">                        &amp;&amp; ((m.getLocation() == LOC_SQUAD) || (m.getLocation() == trooper))) {</span>
<span class="nc" id="L2482">                    hasAntiMech = true;</span>
                }
<span class="nc" id="L2484">            }</span>
<span class="nc bnc" id="L2485" title="All 2 branches missed.">            if (hasAntiMech) {</span>
<span class="nc" id="L2486">                return 1;</span>
            } else {
<span class="nc" id="L2488">                return 2;</span>
            }
<span class="nc bnc" id="L2490" title="All 2 branches missed.">        } else if (loc == MOUNT_LOC_BODY) {</span>
<span class="nc bnc" id="L2491" title="All 2 branches missed.">            if (getChassisType() == CHASSIS_TYPE_QUAD) {</span>
<span class="nc" id="L2492">                return 4;</span>
            } else {
<span class="nc" id="L2494">                return 2;</span>
            }
        } else {
<span class="nc" id="L2497">            return 0;</span>
        }
    }

    @Override
    public boolean doomedInExtremeTemp() {
<span class="nc" id="L2503">        return false;</span>
    }

    @Override
    public boolean doomedInVacuum() {
<span class="nc" id="L2508">        return false;</span>
    }

    /**
     * Convenience method for determining if the BA has magnetic clamps.
     *
     * @return true if the unit has at least one magnetic clamp, else false
     */
    public boolean hasMagneticClamps() {
<span class="nc bnc" id="L2517" title="All 2 branches missed.">        return countWorkingMisc(MiscType.F_MAGNETIC_CLAMP) &gt; 0;</span>
    }

    /**
     * Returns the &lt;code&gt;EquipmentType&lt;/code&gt; internal name for the manipulator
     * mounted in the left arm of this &lt;code&gt;BattleArmor&lt;/code&gt; squad.
     *
     * @return
     */
    public String getLeftManipulatorName(){
<span class="nc" id="L2527">        Mounted m = getLeftManipulator();</span>
<span class="nc bnc" id="L2528" title="All 2 branches missed.">        if (m == null){</span>
<span class="nc" id="L2529">            return MANIPULATOR_TYPE_STRINGS[MANIPULATOR_NONE];</span>
        } else {
<span class="nc" id="L2531">            return m.getType().getInternalName();</span>
        }
    }

    /**
     * Returns the &lt;code&gt;EquipmentType&lt;/code&gt; internal name for the manipulator
     * mounted in the right arm of this &lt;code&gt;BattleArmor&lt;/code&gt; squad.
     *
     * @return
     */
    public String getRightManipulatorName(){
<span class="nc" id="L2542">        Mounted m = getRightManipulator();</span>
<span class="nc bnc" id="L2543" title="All 2 branches missed.">        if (m == null){</span>
<span class="nc" id="L2544">            return MANIPULATOR_TYPE_STRINGS[MANIPULATOR_NONE];</span>
        } else {
<span class="nc" id="L2546">            return m.getType().getInternalName();</span>
        }
    }

    /**
     * Returns the &lt;code&gt;Mounted&lt;/code&gt; for the manipulator
     * mounted in the left arm of this &lt;code&gt;BattleArmor&lt;/code&gt; squad.
     *
     * @return
     */
    public Mounted getLeftManipulator(){
<span class="nc bnc" id="L2557" title="All 2 branches missed.">        for (Mounted m : getMisc()){</span>
<span class="nc bnc" id="L2558" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_BA_MANIPULATOR)</span>
<span class="nc bnc" id="L2559" title="All 2 branches missed.">                    &amp;&amp; (m.getBaMountLoc() == MOUNT_LOC_LARM)){</span>
<span class="nc" id="L2560">                return m;</span>
            }
<span class="nc" id="L2562">        }</span>
<span class="nc" id="L2563">        return null;</span>
    }

    /**
     * Returns the &lt;code&gt;Mounted&lt;/code&gt; for the manipulator
     * mounted in the right arm of this &lt;code&gt;BattleArmor&lt;/code&gt; squad.
     *
     * @return
     */
    public Mounted getRightManipulator(){
<span class="nc bnc" id="L2573" title="All 2 branches missed.">        for (Mounted m : getMisc()){</span>
<span class="nc bnc" id="L2574" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_BA_MANIPULATOR)</span>
<span class="nc bnc" id="L2575" title="All 2 branches missed.">                    &amp;&amp; (m.getBaMountLoc() == MOUNT_LOC_RARM)){</span>
<span class="nc" id="L2576">                return m;</span>
            }
<span class="nc" id="L2578">        }</span>
<span class="nc" id="L2579">        return null;</span>
    }

    public boolean isClanExoWithoutHarjel() {
<span class="nc" id="L2583">        return clanExoWithoutHarjel;</span>
    }

    public void setClanExoWithoutHarjel(boolean clanExoWithoutHarjel) {
<span class="nc" id="L2587">        this.clanExoWithoutHarjel = clanExoWithoutHarjel;</span>
<span class="nc" id="L2588">    }</span>

    @Override
    public String getLocationDamage(int loc) {
<span class="nc" id="L2592">        String toReturn = &quot;&quot;;</span>
<span class="nc bnc" id="L2593" title="All 2 branches missed.">        if(getInternal(loc)&lt;0) {</span>
<span class="nc" id="L2594">            return toReturn;</span>
        }
<span class="nc" id="L2596">        boolean first = true;</span>
<span class="nc bnc" id="L2597" title="All 2 branches missed.">        for(Mounted m : getEquipment()) {</span>
<span class="nc bnc" id="L2598" title="All 2 branches missed.">            if(m.isMissingForTrooper(loc)) {</span>
<span class="nc bnc" id="L2599" title="All 2 branches missed.">                if (!first) {</span>
<span class="nc" id="L2600">                    toReturn += &quot;, &quot;;</span>
                }
<span class="nc" id="L2602">                toReturn += m.getName();</span>
<span class="nc" id="L2603">                first = false;</span>
            }
<span class="nc" id="L2605">        }</span>
<span class="nc" id="L2606">        return toReturn;</span>
    }

    /**
     * Used to determine the draw priority of different Entity subclasses.
     * This allows different unit types to always be draw above/below other
     * types.
     *
     * @return
     */
    public int getSpriteDrawPriority() {
<span class="nc" id="L2617">        return 2;</span>
    }


} // End public class BattleArmor extends Infantry implements Serializable
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>