<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="nl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Entity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">PlayerTest Coverage Results</a> &gt; <a href="index.source.html" class="el_package">megamek.common</a> &gt; <span class="el_source">Entity.java</span></div><h1>Entity.java</h1><pre class="source lang-java linenums">/*
* MegaMek -
* Copyright (C) 2000, 2001, 2002, 2003, 2004, 2005 Ben Mazur (bmazur@sev.org)
* Copyright (C) 2018 The MegaMek Team
*
* This program is free software; you can redistribute it and/or modify it under
* the terms of the GNU General Public License as published by the Free Software
* Foundation; either version 2 of the License, or (at your option) any later
* version.
*
* This program is distributed in the hope that it will be useful, but WITHOUT
* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
* FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
* details.
*/
package megamek.common;

import java.math.BigInteger;
import java.text.NumberFormat;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.Set;
import java.util.UUID;
import java.util.Vector;
import java.util.concurrent.ConcurrentHashMap;
import java.util.stream.Collectors;

import megamek.MegaMek;
import megamek.client.ui.swing.GUIPreferences;
import megamek.common.Building.BasementType;
import megamek.common.IGame.Phase;
import megamek.common.MovePath.MoveStepType;
import megamek.common.actions.AbstractAttackAction;
import megamek.common.actions.AttackAction;
import megamek.common.actions.ChargeAttackAction;
import megamek.common.actions.DfaAttackAction;
import megamek.common.actions.DisplacementAttackAction;
import megamek.common.actions.EntityAction;
import megamek.common.actions.PushAttackAction;
import megamek.common.actions.TeleMissileAttackAction;
import megamek.common.actions.WeaponAttackAction;
import megamek.common.annotations.Nullable;
import megamek.common.event.GameEntityChangeEvent;
import megamek.common.icons.Camouflage;
import megamek.common.options.GameOptions;
import megamek.common.options.IOption;
import megamek.common.options.IOptionGroup;
import megamek.common.options.OptionsConstants;
import megamek.common.options.PartialRepairs;
import megamek.common.options.Quirks;
import megamek.common.preference.PreferenceManager;
import megamek.common.util.StringUtil;
import megamek.common.weapons.AlamoMissileWeapon;
import megamek.common.weapons.AltitudeBombAttack;
import megamek.common.weapons.CapitalMissileBearingsOnlyHandler;
import megamek.common.weapons.DiveBombAttack;
import megamek.common.weapons.SpaceBombAttack;
import megamek.common.weapons.Weapon;
import megamek.common.weapons.WeaponHandler;
import megamek.common.weapons.battlearmor.ISBAPopUpMineLauncher;
import megamek.common.weapons.bayweapons.AR10BayWeapon;
import megamek.common.weapons.bayweapons.BayWeapon;
import megamek.common.weapons.bayweapons.CapitalMissileBayWeapon;
import megamek.common.weapons.bayweapons.TeleOperatedMissileBayWeapon;
import megamek.common.weapons.bombs.BombArrowIV;
import megamek.common.weapons.bombs.BombISRL10;
import megamek.common.weapons.bombs.CLAAAMissileWeapon;
import megamek.common.weapons.bombs.CLASEWMissileWeapon;
import megamek.common.weapons.bombs.CLASMissileWeapon;
import megamek.common.weapons.bombs.CLBombTAG;
import megamek.common.weapons.bombs.CLLAAMissileWeapon;
import megamek.common.weapons.bombs.ISAAAMissileWeapon;
import megamek.common.weapons.bombs.ISASEWMissileWeapon;
import megamek.common.weapons.bombs.ISASMissileWeapon;
import megamek.common.weapons.bombs.ISBombTAG;
import megamek.common.weapons.bombs.ISLAAMissileWeapon;
import megamek.common.weapons.capitalweapons.CapitalMissileWeapon;
import megamek.common.weapons.infantry.InfantryWeapon;
import megamek.common.weapons.other.TSEMPWeapon;

/**
 * Entity is a master class for basically anything on the board except terrain.
 */
public abstract class Entity extends TurnOrdered implements Transporter, Targetable, RoundUpdated,
        PhaseUpdated, ITechnology {
    private static final long serialVersionUID = 1430806396279853295L;

    public static final int DOES_NOT_TRACK_HEAT = 999;
    public static final int UNLIMITED_JUMP_DOWN = 999;

    /**
     * Entity Type Id Definitions These are used to identify the type of Entity,
     * such as 'mech or aero.
     */
    public static final long ETYPE_MECH = 1L;
    public static final long ETYPE_BIPED_MECH = 1L &lt;&lt; 1;
    public static final long ETYPE_LAND_AIR_MECH = 1L &lt;&lt; 2;
    public static final long ETYPE_QUAD_MECH = 1L &lt;&lt; 3;
    public static final long ETYPE_ARMLESS_MECH = 1L &lt;&lt; 4;

    public static final long ETYPE_AERO = 1L &lt;&lt; 5;

    public static final long ETYPE_JUMPSHIP = 1L &lt;&lt; 6;
    public static final long ETYPE_WARSHIP = 1L &lt;&lt; 7;
    public static final long ETYPE_SPACE_STATION = 1L &lt;&lt; 8;

    public static final long ETYPE_CONV_FIGHTER = 1L &lt;&lt; 9;
    public static final long ETYPE_FIXED_WING_SUPPORT = 1L &lt;&lt; 10;

    public static final long ETYPE_FIGHTER_SQUADRON = 1L &lt;&lt; 11;

    public static final long ETYPE_SMALL_CRAFT = 1L &lt;&lt; 12;
    public static final long ETYPE_DROPSHIP = 1L &lt;&lt; 13;

    public static final long ETYPE_TELEMISSILE = 1L &lt;&lt; 14;

    public static final long ETYPE_INFANTRY = 1L &lt;&lt; 15;
    public static final long ETYPE_BATTLEARMOR = 1L &lt;&lt; 16;
    public static final long ETYPE_MECHWARRIOR = 1L &lt;&lt; 17;

    public static final long ETYPE_PROTOMECH = 1L &lt;&lt; 18;

    public static final long ETYPE_TANK = 1L &lt;&lt; 19;

    public static final long ETYPE_GUN_EMPLACEMENT = 1L &lt;&lt; 20;

    public static final long ETYPE_SUPER_HEAVY_TANK = 1L &lt;&lt; 21;

    public static final long ETYPE_SUPPORT_TANK = 1L &lt;&lt; 22;
    public static final long ETYPE_LARGE_SUPPORT_TANK = 1L &lt;&lt; 23;

    public static final long ETYPE_VTOL = 1L &lt;&lt; 24;
    public static final long ETYPE_SUPPORT_VTOL = 1L &lt;&lt; 25;

    public static final long ETYPE_TRIPOD_MECH = 1L &lt;&lt; 26;
    public static final long ETYPE_QUADVEE = 1L &lt;&lt; 27;

    public static final int NONE = -1;

    public static final int LOC_NONE = -1;
    public static final int LOC_DESTROYED = -2;

    public static final int MAX_C3_NODES = 12;
    public static final int MAX_C3i_NODES = 6;

    public static final int GRAPPLE_BOTH = 0;
    public static final int GRAPPLE_RIGHT = 1;
    public static final int GRAPPLE_LEFT = 2;

    public static final int DMG_NONE = 0;
    public static final int DMG_LIGHT = 1;
    public static final int DMG_MODERATE = 2;
    public static final int DMG_HEAVY = 3;
    public static final int DMG_CRIPPLED = 4;

    public static final int USE_STRUCTURAL_RATING = -1;

<span class="nc" id="L168">    public static final String ENTITY_AIR_TO_GROUND_SENSOR_RANGE= Messages.getString(&quot;Entity.sensor_range_vs_ground_target&quot;);</span>

    // Weapon sort order defines
<span class="nc" id="L171">    public static enum WeaponSortOrder {</span>
<span class="nc" id="L172">        DEFAULT(&quot;DEFAULT&quot;),</span>
<span class="nc" id="L173">        RANGE_LH(&quot;RANGE_LH&quot;),</span>
<span class="nc" id="L174">        RANGE_HL(&quot;RANGE_HL&quot;),</span>
<span class="nc" id="L175">        DAMAGE_LH(&quot;DAMAGE_LH&quot;),</span>
<span class="nc" id="L176">        DAMAGE_HL(&quot;DAMAGE_HL&quot;),</span>
<span class="nc" id="L177">        ARC(&quot;ARC&quot;),</span>
<span class="nc" id="L178">        CUSTOM(&quot;CUSTOM&quot;);</span>

        public final String i18nEntry;

<span class="nc" id="L182">        WeaponSortOrder(String s) {</span>
<span class="nc" id="L183">            i18nEntry = s;</span>
<span class="nc" id="L184">        }</span>
    }

    protected transient IGame game;

<span class="nc" id="L189">    protected int id = Entity.NONE;</span>

<span class="nc" id="L191">    protected Camouflage camouflage = new Camouflage();</span>

    /**
     * ID settable by external sources (such as mm.net)
     */
<span class="nc" id="L196">    protected String externalId = &quot;-1&quot;;</span>

    protected double weight;
<span class="nc" id="L199">    protected boolean omni = false;</span>
    protected String chassis;
    protected String model;
<span class="nc" id="L202">    protected int year = 3071;</span>
    protected int techLevel;
    private CompositeTechLevel compositeTechLevel;
    /**
     * Used by support vehicles to define the structural tech rating
     * (TM pg 117).  The values should come from EquipmentType.RATING_A-X.
     */
<span class="nc" id="L209">    protected int structuralTechRating =  EquipmentType.RATING_A;</span>
    /**
     * Used by support vehicles to define tech rating of armor.  Default value
     * indicates that structural tech rating should be used, as in most cases
     * the armor and structural tech ratings match.
     */
<span class="nc" id="L215">    protected int armorTechRating = USE_STRUCTURAL_RATING;</span>
    /**
     * Used by support vehicles to define tech rating of armor.  Default value
     * indicates that structural tech rating should be used, as in most cases
     * the engine and structural tech ratings match.
     */
<span class="nc" id="L221">    protected int engineTechRating = USE_STRUCTURAL_RATING;</span>

    /**
     * Used by omni support vehicles to track the weight of optional fire control systems.
     */
<span class="nc" id="L226">    private double baseChassisFireConWeight = 0.0;</span>
    /**
     * Year to use calculating engine and control system weight and fuel efficiency for primitive
     * support vehicles and aerospace units. This needs to be tracked separately from intro year to
     * account for refits that change the intro year but don't affect the structural components
     */
<span class="nc" id="L232">    private int originalBuildYear = -1;</span>

    private Engine engine;
<span class="nc" id="L235">    protected boolean mixedTech = false;</span>
<span class="nc" id="L236">    protected boolean designValid = true;</span>
<span class="nc" id="L237">    protected boolean useManualBV = false;</span>
<span class="nc" id="L238">    protected int manualBV = -1;</span>

<span class="nc" id="L240">    protected int initialBV = -1;</span>

<span class="nc" id="L242">    protected String displayName = null;</span>
<span class="nc" id="L243">    protected String shortName = null;</span>
<span class="nc" id="L244">    public int duplicateMarker = 1;</span>

    protected transient IPlayer owner;
    protected int ownerId;
<span class="nc" id="L248">    protected int traitorId = -1;</span>

<span class="nc" id="L250">    protected int targetBay = -1;</span>

<span class="nc" id="L252">    private int startingPos = Board.START_NONE;</span>

    /**
     * The pilot of the entity. Even infantry has a 'pilot'.
     */
    private Crew crew;
    
    // Crew and passenger numbers
    protected int nCrew;
    protected int nPassenger;
    protected int nMarines;

<span class="nc" id="L264">    private Quirks quirks = new Quirks();</span>
<span class="nc" id="L265">    private PartialRepairs partReps = new PartialRepairs();</span>

    // Variable for manually shutdown mechs.
<span class="nc" id="L268">    protected boolean manualShutdown = false;</span>
<span class="nc" id="L269">    protected boolean startupThisPhase = false;</span>

<span class="nc" id="L271">    protected boolean shutDown = false;</span>
<span class="nc" id="L272">    protected boolean shutDownThisPhase = false;</span>
<span class="nc" id="L273">    protected boolean doomed = false;</span>
<span class="nc" id="L274">    protected boolean destroyed = false;</span>

<span class="nc" id="L276">    private Coords position = null;</span>

    /**
     * Used for Entities that are bigger than a single hex. This contains the
     * central hex plus all of the other hexes this entity occupies. The central
     * hex is important for drawing multi-hex sprites.
     */
<span class="nc" id="L283">    protected Map&lt;Integer, Coords&gt; secondaryPositions = null;</span>

<span class="nc" id="L285">    protected int facing = 0;</span>
<span class="nc" id="L286">    protected int sec_facing = 0;</span>

<span class="nc" id="L288">    protected int walkMP = 0;</span>
<span class="nc" id="L289">    protected int jumpMP = 0;</span>

<span class="nc" id="L291">    protected boolean done = false;</span>

<span class="nc" id="L293">    protected boolean prone = false;</span>
<span class="nc" id="L294">    protected boolean hullDown = false;</span>
<span class="nc" id="L295">    protected boolean findingClub = false;</span>
<span class="nc" id="L296">    protected boolean armsFlipped = false;</span>
<span class="nc" id="L297">    protected boolean unjammingRAC = false;</span>
<span class="nc" id="L298">    protected boolean selfDestructing = false;</span>
<span class="nc" id="L299">    protected boolean selfDestructInitiated = false;</span>
<span class="nc" id="L300">    protected boolean selfDestructedThisTurn = false;</span>
    /**
     * Variable to store the state of a possible externally mounted searchlight.
     * True if an operable searchlight is externally mounted, false if one isn't
     * mounted or if it is destroyed. Other searchlights may be mounted as
     * equipment on the entity.
     */
<span class="nc" id="L307">    protected boolean hasExternalSpotlight = false;</span>
<span class="nc" id="L308">    protected boolean illuminated = false;</span>
<span class="nc" id="L309">    protected boolean spotlightIsActive = false;</span>
<span class="nc" id="L310">    protected boolean usedSearchlight = false;</span>
<span class="nc" id="L311">    protected boolean stuckInSwamp = false;</span>
<span class="nc" id="L312">    protected boolean canUnstickByJumping = false;</span>
<span class="nc" id="L313">    protected int taggedBy = -1;</span>
<span class="nc" id="L314">    protected boolean layingMines = false;</span>
<span class="nc" id="L315">    protected boolean _isEMId = false;</span>
    protected boolean[] hardenedArmorDamaged;
    protected boolean[] locationBlownOff;
    protected boolean[] locationBlownOffThisPhase;
    protected int[] armorType;
    protected int[] armorTechLevel;
<span class="nc" id="L321">    protected boolean isJumpingNow = false;</span>
<span class="nc" id="L322">    protected boolean convertingNow = false;</span>
<span class="nc" id="L323">    private int conversionMode = 0;</span>
    protected EntityMovementMode previousMovementMode;

<span class="nc" id="L326">    protected DisplacementAttackAction displacementAttack = null;</span>

<span class="nc" id="L328">    public int heat = 0;</span>
<span class="nc" id="L329">    public int heatBuildup = 0;</span>
<span class="nc" id="L330">    public int heatFromExternal = 0;</span>
<span class="nc" id="L331">    public int coolFromExternal = 0;</span>
<span class="nc" id="L332">    public int delta_distance = 0;</span>
<span class="nc" id="L333">    public int mpUsed = 0;</span>
<span class="nc" id="L334">    public EntityMovementType moved = EntityMovementType.MOVE_NONE;</span>
<span class="nc" id="L335">    public EntityMovementType movedLastRound = EntityMovementType.MOVE_NONE;</span>
<span class="nc" id="L336">    private boolean movedBackwards = false;</span>
    /**
     * Used to keep track of usage of the power reverse quirk, which allows a
     * combat vehicle to use flank MP in reverse.  If power reverse is used and
     * a PSR is required, it adds a +1 modifier to the PSR.
     */
<span class="nc" id="L342">    private boolean isPowerReverse = false;</span>
<span class="nc" id="L343">    private boolean wigeLiftoffHover = false;</span>
<span class="nc" id="L344">    protected int mpUsedLastRound = 0;</span>
<span class="nc" id="L345">    public boolean gotPavementBonus = false;</span>
<span class="nc" id="L346">    public int wigeBonus = 0;</span>
<span class="nc" id="L347">    public boolean hitThisRoundByAntiTSM = false;</span>
<span class="nc" id="L348">    public boolean inReverse = false;</span>
<span class="nc" id="L349">    protected boolean struck = false;</span>
<span class="nc" id="L350">    protected boolean fell = false;</span>

    private int[] exposure;
    private int[] armor;
    private int[] internal;
    private int[] orig_armor;
    private int[] orig_internal;
    public int damageThisPhase;
    public int damageThisRound;
    public int engineHitsThisPhase;
<span class="nc" id="L360">    public boolean rolledForEngineExplosion = false; // So that we don't roll</span>
    // twice in one round
    public boolean dodging;
    public boolean reckless;
<span class="nc" id="L364">    private boolean evading = false;</span>

    public boolean spotting;
<span class="nc" id="L367">    private boolean clearingMinefield = false;</span>
<span class="nc" id="L368">    protected int killerId = Entity.NONE;</span>
<span class="nc" id="L369">    private int offBoardDistance = 0;</span>
<span class="nc" id="L370">    private OffBoardDirection offBoardDirection = OffBoardDirection.NONE;</span>
<span class="nc" id="L371">    private OffBoardDirection retreatedDirection = OffBoardDirection.NONE;</span>

<span class="nc" id="L373">    protected int[] vectors = {0, 0, 0, 0, 0, 0};</span>
<span class="nc" id="L374">    private int recoveryTurn = 0;</span>
    // need to keep a list of areas that this entity has passed through on the
    // current turn
<span class="nc" id="L377">    private Vector&lt;Coords&gt; passedThrough = new Vector&lt;Coords&gt;();</span>
<span class="nc" id="L378">    private List&lt;Integer&gt; passedThroughFacing = new ArrayList&lt;&gt;();</span>
    /**
     * Stores the player selected hex ground to air targeting.
     * For ground to air, distance to target for the ground unit is determined
     * by the closest hex in the flight path of the airborne unit.  It's
     * possible that there are multiple equidistance hexes in the flight path
     * and in some cases, one of those hexes will be better than the other (ie,
     * one could be side arc and one rear).  By default, MM picks the first hex,
     * but the user should be able to distinguish between multiple equi-distant
     * hexes.
     */
<span class="nc" id="L389">    private Map&lt;Integer, Coords&gt; playerPickedPassThrough = new HashMap&lt;&gt;();</span>
    private boolean ramming;
    // to determine what arcs have fired for large craft
    private boolean[] frontArcFired;
    private boolean[] rearArcFired;

    /**
     * The object that tracks this unit's Inferno round hits.
     */
<span class="nc" id="L398">    public InfernoTracker infernos = new InfernoTracker();</span>
<span class="nc" id="L399">    public ArtilleryTracker aTracker = new ArtilleryTracker();</span>
<span class="nc" id="L400">    public TeleMissileTracker tmTracker = new TeleMissileTracker();</span>

<span class="nc" id="L402">    protected String c3NetIdString = null;</span>
<span class="nc" id="L403">    protected int c3Master = NONE;</span>
<span class="nc" id="L404">    protected int c3CompanyMasterIndex = LOC_DESTROYED;</span>
<span class="nc" id="L405">    private String c3UUID = null;</span>
<span class="nc" id="L406">    private String c3MasterIsUUID = null;</span>
<span class="nc" id="L407">    private String[] c3iUUIDs = new String[MAX_C3i_NODES];</span>
<span class="nc" id="L408">    private String[] NC3UUIDs = new String[MAX_C3i_NODES];</span>
<span class="nc" id="L409">    private boolean networkBAP = false;</span>

<span class="nc" id="L411">    protected int structureType = EquipmentType.T_STRUCTURE_UNKNOWN;</span>
<span class="nc" id="L412">    protected int structureTechLevel = TechConstants.T_TECH_UNKNOWN;</span>

<span class="nc" id="L414">    protected String source = &quot;&quot;;</span>

    /**
     * Keeps track of whether this Entity was hit by a TSEMP this turn.
     */
<span class="nc" id="L419">    private int tsempHitsThisTurn = 0;</span>

    /**
     * Keeps track of the current TSEMP effect on this entity
     */
<span class="nc" id="L424">    private int tsempEffect = TSEMPWeapon.TSEMP_EFFECT_NONE;</span>


    /**
     * Keeps track of the current ASEW effect on this entity
     */
<span class="nc" id="L430">    protected int asewAffectedTurns = 0;</span>

    /**
     * Keeps track of whether this Entity fired a TSEMP this turn
     */
<span class="nc" id="L435">    private boolean firedTsempThisTurn = false;</span>

    /**
     * Keeps track of whether this Entity has ever fired a TSEMP.  This is used
     * to avoid having to iterate over all weapons looking for TSEMPs to reset
     * at the start of every round.
     */
<span class="nc" id="L442">    private boolean hasFiredTsemp = false;</span>

    /**
     * A list of all mounted equipment. (Weapons, ammo, and misc)
     */
<span class="nc" id="L447">    protected ArrayList&lt;Mounted&gt; equipmentList = new ArrayList&lt;Mounted&gt;();</span>

    /**
     * A list of all mounted weapons. This only includes regular weapons, not
     * bay mounts or grouped weapon mounts.
     */
<span class="nc" id="L453">    protected ArrayList&lt;Mounted&gt; weaponList = new ArrayList&lt;Mounted&gt;();</span>

    /**
     * A list of all mounted weapon bays
     */
<span class="nc" id="L458">    protected ArrayList&lt;Mounted&gt; weaponBayList = new ArrayList&lt;Mounted&gt;();</span>

    /**
     * A list of all mounted weapon groups
     */
<span class="nc" id="L463">    protected ArrayList&lt;Mounted&gt; weaponGroupList = new ArrayList&lt;Mounted&gt;();</span>

    /**
     * A list of every weapon mount, including bay mounts and weapon group
     * mounts
     */
<span class="nc" id="L469">    protected ArrayList&lt;Mounted&gt; totalWeaponList = new ArrayList&lt;Mounted&gt;();</span>

    /**
     * A list of all mounted ammo.
     */
<span class="nc" id="L474">    protected ArrayList&lt;Mounted&gt; ammoList = new ArrayList&lt;Mounted&gt;();</span>

    /**
     * A list of all mounted bombs.
     */
<span class="nc" id="L479">    protected ArrayList&lt;Mounted&gt; bombList = new ArrayList&lt;Mounted&gt;();</span>

    /**
     * A list of all remaining equipment.
     */
<span class="nc" id="L484">    protected ArrayList&lt;Mounted&gt; miscList = new ArrayList&lt;Mounted&gt;();</span>

<span class="nc" id="L486">    protected ArrayList&lt;INarcPod&gt; pendingINarcPods = new ArrayList&lt;INarcPod&gt;();</span>
<span class="nc" id="L487">    protected ArrayList&lt;INarcPod&gt; iNarcPods = new ArrayList&lt;INarcPod&gt;();</span>
<span class="nc" id="L488">    protected ArrayList&lt;NarcPod&gt; pendingNarcPods = new ArrayList&lt;NarcPod&gt;();</span>
<span class="nc" id="L489">    protected ArrayList&lt;NarcPod&gt; narcPods = new ArrayList&lt;NarcPod&gt;();</span>

<span class="nc" id="L491">    protected ArrayList&lt;String&gt; failedEquipmentList = new ArrayList&lt;String&gt;();</span>

    // which teams have NARCd us? a long allows for 64 teams.
<span class="nc" id="L494">    protected long m_lNarcedBy = 0;</span>
<span class="nc" id="L495">    protected long m_lPendingNarc = 0;</span>

    /**
     * This matrix stores critical slots in the format [location][slot #]. What
     * locations entities have and how many slots there are in each is
     * determined by the subclasses of Entity such as Mech.
     */
    protected CriticalSlot[][] crits; // [loc][slot]

    /**
     * Stores the current movement mode.
     */
<span class="nc" id="L507">    protected EntityMovementMode movementMode = EntityMovementMode.NONE;</span>

    /**
     * Flag that determines if this Entity is a hidden unit or not (see TW pg
     * 259).
     */
<span class="nc" id="L513">    protected boolean isHidden = false;</span>

    /**
     * Used to determine if this Entity has made a pointblank shot so far this
     * round.
     */
<span class="nc" id="L519">    protected boolean madePointblankShot = false;</span>

    /**
     * Keeps track of whether this Entity should activate in a particular game
     * phase.  Generally this will be null, indicating the unit isn't
     * activating.
     */
<span class="nc" id="L526">    protected IGame.Phase hiddenActivationPhase = null;</span>

<span class="nc" id="L528">    protected boolean carcass = false;</span>

    /**
     * The components of this entity that can transport other entities.
     */
<span class="nc" id="L533">    private Vector&lt;Transporter&gt; transports = new Vector&lt;Transporter&gt;();</span>

    /**
     * The components of this entity that can transport other entities and occupy
     * pod space of an omni unit.
     */
<span class="nc" id="L539">    private Vector&lt;Transporter&gt; omniPodTransports = new Vector&lt;Transporter&gt;();</span>

    /**
     * The ids of the MechWarriors this entity has picked up
     */
<span class="nc" id="L544">    private Vector&lt;Integer&gt; pickedUpMechWarriors = new Vector&lt;Integer&gt;();</span>

    /**
     * The ID of the &lt;code&gt;Entity&lt;/code&gt; that has loaded this unit.
     */
<span class="nc" id="L549">    private int conveyance = Entity.NONE;</span>

    /**
     * Set to &lt;code&gt;true&lt;/code&gt; if this unit was unloaded this turn.
     */
<span class="nc" id="L554">    private boolean unloadedThisTurn = false;</span>

    /**
     * Set to &lt;code&gt;true&lt;/code&gt; if this unit was loaded this turn.
     */
<span class="nc" id="L559">    private boolean loadedThisTurn = false;</span>

    /**
     * Need to keep a vector of entity IDs loaded in the chat lounge
     */
<span class="nc" id="L564">    private Vector&lt;Integer&gt; loadedKeepers = new Vector&lt;Integer&gt;();</span>

    /**
     * The id of the &lt;code&gt;Entity&lt;/code&gt; that is the current target of a swarm
     * attack by this unit.
     */
<span class="nc" id="L570">    private int swarmTargetId = Entity.NONE;</span>

    /**
     * The id of the &lt;code&gt;Entity&lt;/code&gt; that is attacking this unit with a
     * swarm attack.
     */
<span class="nc" id="L576">    private int swarmAttackerId = Entity.NONE;</span>

    /**
     * Flag that indicates that the unit can still be salvaged (given enough
     * time and parts).
     */
<span class="nc" id="L582">    private boolean salvageable = true;</span>

    /**
     * The removal condition is set when the entitiy is removed from the game.
     */
<span class="nc" id="L587">    private int removalCondition = IEntityRemovalConditions.REMOVE_UNKNOWN;</span>

    /**
     * The round this unit will be deployed
     */
<span class="nc" id="L592">    private int deployRound = 0;</span>

    /**
     * Marks an entity as having been deployed
     */
<span class="nc" id="L597">    private boolean deployed = false;</span>

    /**
     * Tracks if this entity was never deployed
     */
<span class="nc" id="L602">    private boolean neverDeployed = true;</span>

    /**
     * The unit number of this entity. All entities which are members of the
     * same low-level unit are expected to share the same unit number. Future
     * implementations may store multiple unit designations in the same unit
     * number (e.g. battalion, company, platoon, and lance).
     */
<span class="nc" id="L610">    private short unitNumber = Entity.NONE;</span>

    /**
     * Indicates whether this entity has been seen by the enemy during the
     * course of this game. Used in double-blind.
     */
<span class="nc" id="L616">    private boolean everSeenByEnemy = false;</span>

    /**
     * Indicates whether this entity can currently be seen by the enemy. Used in
     * double-blind.
     */
<span class="nc" id="L622">    private boolean visibleToEnemy = false;</span>

    /**
     * Flag that indicates whether this entity has been detected by sensors by
     * an enemy.
     */
    private boolean detectedByEnemy;

    /**
     * Check to see who has seen this Entity Used for Double Blind Reports.
     */
<span class="nc" id="L633">    private Vector&lt;IPlayer&gt; entitySeenBy = new Vector&lt;IPlayer&gt;();</span>

    /**
     * Check to see what players have detected this entity with sensors, for
     * double blind play.
     */
<span class="nc" id="L639">    private Vector&lt;IPlayer&gt; entityDetectedBy = new Vector&lt;IPlayer&gt;();</span>

    /**
     * Contains the ids of all entities that have been detected by this entity's sensors.
     * Used for double-blind on space maps - SO p117
     *
     * Entities need only be cleared from this when they move out of range,
     * are destroyed, or move off the board
     */
<span class="nc" id="L648">    public Set&lt;Integer&gt; sensorContacts = new HashSet&lt;Integer&gt;();</span>

    /**
     * Contains the ids of all entities that this entity has established a firing solution on.
     * Used for double-blind on space maps - SO p117
     *
     * Entities need only be cleared from this when they move out of range,
     * are destroyed, or move off the board
     */
<span class="nc" id="L657">    public Set&lt;Integer&gt; firingSolutions = new HashSet&lt;Integer&gt;();</span>

    /**
     * Whether this entity is captured or not.
     */
<span class="nc" id="L662">    private boolean captured = false;</span>

    /**
     * this is the elevation of the Entity--with respect to the surface of the
     * hex it's in. In other words, this may need to *change* as it moves from
     * hex to hex--without it going up or down. I.e.--level 0 hex, elevation
     * 5--it moves to a level 2 hex, without going up or down. elevation is now
     * 3.
     */
<span class="nc" id="L671">    protected int elevation = 0;</span>

    /**
     * altitude is different from elevation. It is used to measure the vertical
     * distance of Aero units from the ground on low atmosphere and ground maps.
     */
<span class="nc" id="L677">    protected int altitude = 0;</span>

    /**
     * 2 vectors holding entity and weapon ids. to see who hit us this round
     * with a swarm volley from what launcher. This vector holds the Entity ids.
     *
     * @see megamek.common.Entity#hitBySwarmsWeapon
     */
<span class="nc" id="L685">    private Vector&lt;Integer&gt; hitBySwarmsEntity = new Vector&lt;Integer&gt;();</span>

    /**
     * A vector that stores from which launcher we where hit by a swarm weapon
     * this round. This vector holds the weapon ID's.
     *
     * @see megamek.common.Entity#hitBySwarmsEntity
     */
<span class="nc" id="L693">    private Vector&lt;Integer&gt; hitBySwarmsWeapon = new Vector&lt;Integer&gt;();</span>

    /**
     * True if and only if this is a canon (published) unit.
     */
    private boolean canon;

<span class="nc" id="L700">    private int assaultDropInProgress = 0;</span>
<span class="nc" id="L701">    private boolean climbMode = GUIPreferences.getInstance()</span>
<span class="nc" id="L702">            .getBoolean(GUIPreferences.ADVANCED_MOVE_DEFAULT_CLIMB_MODE);</span>

<span class="nc" id="L704">    protected int lastTarget = Entity.NONE;</span>
<span class="nc" id="L705">    protected String lastTargetDisplayName = &quot;&quot;;</span>

    /**
     * the entity id of our current spot-target
     */
<span class="nc" id="L710">    private int spotTargetId = Entity.NONE;</span>

<span class="nc" id="L712">    private boolean isCommander = false;</span>

<span class="nc" id="L714">    protected boolean isCarefulStanding = false;</span>

    /**
     * a vector of currently active sensors that might be able to check range
     */
<span class="nc" id="L719">    private Vector&lt;Sensor&gt; sensors = new Vector&lt;Sensor&gt;();</span>
    // the currently selected sensor
    private Sensor activeSensor;
    // the sensor chosen for next turn
    private Sensor nextSensor;
    // roll for sensor check
    private int sensorCheck;

    // the roll for ghost targets
    private int ghostTargetRoll;
    // the roll to override ghost targets
    private int ghostTargetOverride;

    // Tac Ops HeatSink Coolant Failure number
    protected int heatSinkCoolantFailureFactor;

    // for how many rounds should this unit stay shutdown due to tasering
<span class="nc" id="L736">    protected int taserShutdownRounds = 0;</span>

    // is this unit shutdown by a BA taser?
<span class="nc" id="L739">    protected boolean shutdownByBATaser = false;</span>

    // for how many more rounds does this unit suffer from taser feedback?
<span class="nc" id="L742">    protected int taserFeedBackRounds = 0;</span>

<span class="nc" id="L744">    protected int taserInterference = 0;</span>
<span class="nc" id="L745">    protected int taserInterferenceRounds = 0;</span>
<span class="nc" id="L746">    protected boolean taserInterferenceHeat = false;</span>

    // contains a HTML string describing BV calculation
<span class="nc" id="L749">    protected StringBuffer bvText = null;</span>
<span class="nc" id="L750">    protected String startTable = &quot;&lt;TABLE&gt;&quot;;</span>
<span class="nc" id="L751">    protected String endTable = &quot;&lt;/TABLE&gt;&quot;;</span>

<span class="nc" id="L753">    protected String startRow = &quot;&lt;TR&gt;&quot;;</span>
<span class="nc" id="L754">    protected String endRow = &quot;&lt;/TR&gt;&quot;;</span>

<span class="nc" id="L756">    protected String startColumn = &quot;&lt;TD&gt;&quot;;</span>
<span class="nc" id="L757">    protected String endColumn = &quot;&lt;/TD&gt;&quot;;</span>

<span class="nc" id="L759">    protected String nl = &quot;&lt;BR&gt;&quot;;</span>

    // for how many rounds has blueshield been active?
<span class="nc" id="L762">    private int blueShieldRounds = 0;</span>

    // Entity fluff object for use with MegaMekLab
    protected EntityFluff fluff;

    // a settable armor tonnage for use with MML - this is not what
    // is calculated by getArmorTonnage
    protected double armorTonnage;

<span class="nc" id="L771">    protected static int[] MASC_FAILURE = {3, 5, 7, 11, 13, 13, 13};</span>
<span class="nc" id="L772">    protected static int[] ALTERNATE_MASC_FAILURE = {0, 3, 5, 7, 11, 13, 13,</span>
                                                     13};
<span class="nc" id="L774">    protected static int[] ALTERNATE_MASC_FAILURE_ENHANCED = {0, 3, 3, 5, 7,</span>
                                                              11, 13, 13, 13};

    // MASCLevel is the # of turns MASC has been used previously
<span class="nc" id="L778">    protected int nMASCLevel = 0;</span>

<span class="nc" id="L780">    protected boolean bMASCWentUp = false;</span>

<span class="nc" id="L782">    protected boolean usedMASC = false; // Has masc been used?</span>

    /**
     * Nova CEWS can adjust the network on the fly. This keeps track of the C3
     * net ID to be switched to on the next turn.
     */
<span class="nc" id="L788">    private String newC3NetIdString = null;</span>

    /**
     * Keeps track of the number of iATM improved magnetic pulse (IMP) his this
     * entity took this turn.
     */
<span class="nc" id="L794">    private int impThisTurn = 0;</span>

    /**
     * Keeps track of the number of iATM improved magnetic pulse (IMP) his this
     * entity took last turn.
     */
<span class="nc" id="L800">    private int impLastTurn = 0;</span>

<span class="nc" id="L802">    private int impThisTurnHeatHelp = 0;</span>

    protected boolean military;

    /**
     * Keeps track of whether or not this Entity has a critically hit radical
     * heat sink.  Using a flag will prevent having to iterate over all of the
     * Entity's mounted equipment
     */
<span class="nc" id="L811">    protected boolean hasDamagedRHS = false;</span>

    /**
     * Keeps track of the number of consecutive turns a radical heat sink has
     * been used.
     */
<span class="nc" id="L817">    protected int consecutiveRHSUses = 0;</span>

    /**
     * Flag that can be used to indicate whether this Entity should use a
     * geometric mean when computing BV.
     */
<span class="nc" id="L823">    protected boolean useGeometricBV = false;</span>

<span class="nc" id="L825">    protected boolean useReducedOverheatModifierBV = false;</span>

<span class="nc" id="L827">    private final Set&lt;Integer&gt; attackedByThisTurn =</span>
<span class="nc" id="L828">            Collections.newSetFromMap(new ConcurrentHashMap&lt;Integer, Boolean&gt;());</span>

    /**
     * Determines the sort order for weapons in the UnitDisplay weapon list.
     */
    private WeaponSortOrder weaponSortOrder;

    /**
     * Maps a weapon id to a user-specified index, used to get a custom ordering
     * for weapons.
     */
<span class="nc" id="L839">    private Map&lt;Integer, Integer&gt; customWeapOrder = null;</span>

    /**
     * Flag that indicates weapon sort order has changed (included ordering for
     * custom sort order).
     */
<span class="nc" id="L845">    private boolean weapOrderChanged = false;</span>

    /**
     * Set of team IDs that have observed this entity making attacks from off-board
     */
    private Set&lt;Integer&gt; offBoardShotObservers;
    
    /**
     * Generates a new, blank, entity.
     */
<span class="nc" id="L855">    public Entity() {</span>
<span class="nc" id="L856">        crew = new Crew(defaultCrewType());</span>
<span class="nc" id="L857">        nCrew = 0;</span>
<span class="nc" id="L858">        nPassenger = 0;</span>
<span class="nc" id="L859">        nMarines = 0;</span>
<span class="nc" id="L860">        armor = new int[locations()];</span>
<span class="nc" id="L861">        internal = new int[locations()];</span>
<span class="nc" id="L862">        orig_armor = new int[locations()];</span>
<span class="nc" id="L863">        orig_internal = new int[locations()];</span>
<span class="nc" id="L864">        crits = new CriticalSlot[locations()][];</span>
<span class="nc" id="L865">        exposure = new int[locations()];</span>
<span class="nc" id="L866">        armorType = new int[locations()];</span>
<span class="nc" id="L867">        armorTechLevel = new int[locations()];</span>
<span class="nc bnc" id="L868" title="All 2 branches missed.">        for (int i = 0; i &lt; locations(); i++) {</span>
<span class="nc" id="L869">            crits[i] = new CriticalSlot[getNumberOfCriticals(i)];</span>
<span class="nc" id="L870">            armorType[i] = EquipmentType.T_ARMOR_UNKNOWN;</span>
<span class="nc" id="L871">            armorTechLevel[i] = TechConstants.T_TECH_UNKNOWN;</span>
        }
<span class="nc" id="L873">        hardenedArmorDamaged = new boolean[locations()];</span>
<span class="nc" id="L874">        locationBlownOff = new boolean[locations()];</span>
<span class="nc" id="L875">        locationBlownOffThisPhase = new boolean[locations()];</span>
<span class="nc" id="L876">        setC3NetId(this);</span>
<span class="nc" id="L877">        quirks.initialize();</span>
<span class="nc" id="L878">        secondaryPositions = new HashMap&lt;Integer, Coords&gt;();</span>
<span class="nc" id="L879">        fluff = new EntityFluff();</span>
<span class="nc" id="L880">        impThisTurn = 0;</span>
<span class="nc" id="L881">        impLastTurn = 0;</span>

<span class="nc" id="L883">        weaponSortOrder = WeaponSortOrder.values()[GUIPreferences.getInstance()</span>
<span class="nc" id="L884">                .getDefaultWeaponSortOrder()];</span>

        //set a random UUID for external ID, this will help us sort enemy salvage and prisoners in MHQ
        //and should have no effect on MM (but need to make sure it doesnt screw up MekWars)
<span class="nc" id="L888">        externalId = UUID.randomUUID().toString();</span>
<span class="nc" id="L889">        initTechAdvancement();</span>
<span class="nc" id="L890">        offBoardShotObservers = new HashSet&lt;&gt;();</span>
<span class="nc" id="L891">    }</span>

    /**
     * @see {@link UnitType}
     */
    public abstract int getUnitType();

    public CrewType defaultCrewType() {
<span class="nc" id="L899">        return CrewType.SINGLE;</span>
    }

    protected void initMilitary() {
<span class="nc" id="L903">        military = hasViableWeapons();</span>
<span class="nc" id="L904">    }</span>

    protected boolean hasViableWeapons() {
<span class="nc" id="L907">        int totalDmg = 0;</span>
<span class="nc" id="L908">        boolean hasRangeSixPlus = false;</span>
<span class="nc" id="L909">        List&lt;Mounted&gt; weaponList = getTotalWeaponList();</span>
<span class="nc bnc" id="L910" title="All 2 branches missed.">        for (Mounted weapon : weaponList) {</span>
<span class="nc bnc" id="L911" title="All 2 branches missed.">            if (weapon.isCrippled()) {</span>
<span class="nc" id="L912">                continue;</span>
            }
<span class="nc" id="L914">            WeaponType type = (WeaponType) weapon.getType();</span>
<span class="nc bnc" id="L915" title="All 2 branches missed.">            if (type.getDamage() == WeaponType.DAMAGE_VARIABLE) {</span>

<span class="nc bnc" id="L917" title="All 2 branches missed.">            } else if (type.getDamage() == WeaponType.DAMAGE_ARTILLERY) {</span>
<span class="nc" id="L918">                return true;</span>
<span class="nc bnc" id="L919" title="All 2 branches missed.">            } else if (type.getDamage() == WeaponType.DAMAGE_BY_CLUSTERTABLE) {</span>
<span class="nc" id="L920">                totalDmg += type.getRackSize();</span>
<span class="nc bnc" id="L921" title="All 2 branches missed.">            } else if (type.getDamage() == WeaponType.DAMAGE_SPECIAL) {</span>
<span class="nc bnc" id="L922" title="All 2 branches missed.">                if (type instanceof ISBAPopUpMineLauncher) {</span>
<span class="nc" id="L923">                    totalDmg += 4;</span>
                }
            } else {
<span class="nc" id="L926">                totalDmg += type.getDamage();</span>
            }

<span class="nc bnc" id="L929" title="All 2 branches missed.">            if (type.getLongRange() &gt;= 6) {</span>
<span class="nc" id="L930">                hasRangeSixPlus = true;</span>
            }
<span class="nc" id="L932">        }</span>
<span class="nc bnc" id="L933" title="All 4 branches missed.">        return (totalDmg &gt;= 5) || hasRangeSixPlus;</span>
    }

    /**
     * Restores the entity after serialization
     */
    public void restore() {
        // restore all mounted equipments
<span class="nc bnc" id="L941" title="All 2 branches missed.">        for (Mounted mounted : equipmentList) {</span>
<span class="nc" id="L942">            mounted.restore();</span>
<span class="nc" id="L943">        }</span>
        // set game options, we derive some equipment's modes from this
<span class="nc" id="L945">        setGameOptions();</span>
<span class="nc" id="L946">    }</span>

    /**
     * Returns the ID number of this Entity.
     *
     * @return ID Number.
     */
    public int getId() {
<span class="nc" id="L954">        return id;</span>
    }

    /**
     * Sets the ID number of this Entity, which will also set the display name
     * and short name to null.
     *
     * @param id the new ID.
     */
    public void setId(int id) {
<span class="nc" id="L964">        this.id = id;</span>
<span class="nc" id="L965">        displayName = null;</span>
<span class="nc" id="L966">        shortName = null;</span>
<span class="nc" id="L967">    }</span>

    /**
     * This returns the external ID.
     * &lt;p&gt;
     * Taharqa: I am changing
     * externalId to a string so I can use UUIDs in MHQ. It should only require
     * a simple parseInt to be added to it to return an integer for other
     * programs (i.e. MekWars).
     *
     * @return the ID settable by external sources (such as mm.net)
     * @throws NumberFormatException if the stored ID is not an integer
     * @see megamek.common.Entity#externalId
     */
    public int getExternalId() {
<span class="nc" id="L982">        return Integer.parseInt(externalId);</span>
    }

    public String getExternalIdAsString() {
<span class="nc" id="L986">        return externalId;</span>
    }

    /**
     * This sets the external ID.
     *
     * @param externalId the new external ID for this Entity.
     * @see megamek.common.Entity#externalId
     */
    public void setExternalIdAsString(String externalId) {
<span class="nc" id="L996">        this.externalId = externalId;</span>
<span class="nc" id="L997">    }</span>

    public void setExternalId(int id) {
<span class="nc" id="L1000">        externalId = Integer.toString(id);</span>
<span class="nc" id="L1001">    }</span>

    /**
     * This returns the game this Entity belongs to.
     *
     * @return the game.
     */
    public IGame getGame() {
<span class="nc" id="L1009">        return game;</span>
    }

    /**
     * This sets the game the entity belongs to. It also restores the entity and
     * checks that the game is in a consistent state. This function takes care
     * of the units transported by this entity.
     *
     * @param game the game.
     */
    @Override
    public void setGame(IGame game) {
<span class="nc" id="L1021">        this.game = game;</span>
<span class="nc" id="L1022">        restore();</span>
        // Make sure the owner is set.
<span class="nc bnc" id="L1024" title="All 2 branches missed.">        if (null == owner) {</span>
<span class="nc bnc" id="L1025" title="All 2 branches missed.">            if (Entity.NONE == ownerId) {</span>
<span class="nc" id="L1026">                throw new IllegalStateException(</span>
                        &quot;Entity doesn't know its owner's ID.&quot;);
            }
<span class="nc" id="L1029">            IPlayer player = game.getPlayer(ownerId);</span>
<span class="nc bnc" id="L1030" title="All 2 branches missed.">            if (null == player) {</span>
<span class="nc" id="L1031">                System.err.println(&quot;Entity can't find player #&quot; + ownerId);</span>
            } else {
<span class="nc" id="L1033">                setOwner(player);</span>
            }
        }
        // also set game for our transports
        // they need it to return correct entites, because they store just the
        // IDs
<span class="nc bnc" id="L1039" title="All 2 branches missed.">        for (Transporter transport : getTransports()) {</span>
<span class="nc" id="L1040">            transport.setGame(game);</span>
<span class="nc" id="L1041">        }</span>
<span class="nc" id="L1042">    }</span>

    /**
     * Returns the unit code for this entity.
     */
    public String getModel() {
<span class="nc" id="L1048">        return model;</span>
    }

    /**
     * Sets the unit code for this Entity.
     *
     * @param model The unit code.
     */
    public void setModel(String model) {
<span class="nc" id="L1057">        this.model = model;</span>
<span class="nc" id="L1058">    }</span>

    /**
     * Returns the chassis name for this entity.
     */
    public String getChassis() {
<span class="nc" id="L1064">        return chassis;</span>
    }

    /**
     * sets the chassis name for this entity.
     *
     * @param chassis The chassis name.
     */
    public void setChassis(String chassis) {
<span class="nc" id="L1073">        this.chassis = chassis;</span>
<span class="nc" id="L1074">    }</span>

    /**
     * Returns the fluff for this entity.
     */
    public EntityFluff getFluff() {
<span class="nc" id="L1080">        return fluff;</span>
    }

    /**
     * Returns the unit tech for this entity.
     */
    public int getTechLevel() {
<span class="nc" id="L1087">        return techLevel;</span>
    }

    /**
     * Sets the tech level for this Entity.
     *
     * @param techLevel The tech level, it must be one of the
     *                  {@link megamek.common.TechConstants TechConstants }.
     */
    public void setTechLevel(int techLevel) {
<span class="nc" id="L1097">        this.techLevel = techLevel;</span>
<span class="nc" id="L1098">        recalculateTechAdvancement();</span>
<span class="nc" id="L1099">    }</span>

    /**
     * Sets initial TechAdvancement without equipment based on construction options.
     */
    protected void initTechAdvancement() {
<span class="nc" id="L1105">        compositeTechLevel = new CompositeTechLevel(this, F_NONE);</span>
<span class="nc" id="L1106">        addSystemTechAdvancement(compositeTechLevel);</span>
<span class="nc" id="L1107">    }</span>

    public CompositeTechLevel factionTechLevel(int techFaction) {
<span class="nc bnc" id="L1110" title="All 2 branches missed.">        if (techFaction == F_NONE) {</span>
<span class="nc" id="L1111">            return compositeTechLevel;</span>
        }
<span class="nc" id="L1113">        CompositeTechLevel retVal = new CompositeTechLevel(this, techFaction);</span>
<span class="nc" id="L1114">        addSystemTechAdvancement(retVal);</span>
<span class="nc bnc" id="L1115" title="All 2 branches missed.">        for (Mounted m : getEquipment()) {</span>
<span class="nc" id="L1116">            retVal.addComponent(m.getType());</span>
<span class="nc bnc" id="L1117" title="All 2 branches missed.">            if (m.isArmored()) {</span>
<span class="nc" id="L1118">                retVal.addComponent(TA_ARMORED_COMPONENT);</span>
            }
<span class="nc" id="L1120">        }</span>
<span class="nc" id="L1121">        return retVal;</span>
    }

    protected void addTechComponent(ITechnology tech) {
<span class="nc" id="L1125">        compositeTechLevel.addComponent(tech);</span>
<span class="nc" id="L1126">    }</span>

    @Override
    public boolean isIntroLevel() {
<span class="nc" id="L1130">        return compositeTechLevel.isIntroLevel();</span>
    }

    @Override
    public boolean isUnofficial() {
<span class="nc" id="L1135">        return compositeTechLevel.isUnofficial();</span>
    }

    @Override
    public int getIntroductionDate() {
<span class="nc" id="L1140">        return year;</span>
    }

    @Override
    public int getIntroductionDate(boolean clan, int faction) {
<span class="nc" id="L1145">        return year;</span>
    }

    /**
     * @return The earliest date this unit could be built, based on the latest intro date
     *         of the components.
     */
    public int getEarliestTechDate() {
<span class="nc" id="L1153">        return compositeTechLevel.getEarliestTechDate();</span>
    }

    @Override
    public int getPrototypeDate() {
<span class="nc" id="L1158">        return compositeTechLevel.getPrototypeDate();</span>
    }

    @Override
    public int getPrototypeDate(boolean clan, int faction) {
<span class="nc" id="L1163">        return compositeTechLevel.getPrototypeDate(clan, faction);</span>
    }

    @Override
    public int getProductionDate() {
<span class="nc" id="L1168">        return compositeTechLevel.getProductionDate();</span>
    }

    @Override
    public int getProductionDate(boolean clan, int faction) {
<span class="nc" id="L1173">        return compositeTechLevel.getProductionDate(clan, faction);</span>
    }

    @Override
    public int getCommonDate() {
<span class="nc" id="L1178">        return compositeTechLevel.getCommonDate();</span>
    }

    @Override
    public int getExtinctionDate() {
<span class="nc" id="L1183">        return compositeTechLevel.getExtinctionDate();</span>
    }

    @Override
    public int getExtinctionDate(boolean clan, int faction) {
<span class="nc" id="L1188">        return compositeTechLevel.getExtinctionDate(clan, faction);</span>
    }

    @Override
    public int getReintroductionDate() {
<span class="nc" id="L1193">        return compositeTechLevel.getReintroductionDate();</span>
    }

    @Override
    public int getReintroductionDate(boolean clan, int faction) {
<span class="nc" id="L1198">        return compositeTechLevel.getReintroductionDate(clan, faction);</span>
    }


    @Override
    public int getTechRating() {
<span class="nc" id="L1204">        return compositeTechLevel.getTechRating();</span>
    }

    @Override
    public SimpleTechLevel getStaticTechLevel() {
<span class="nc" id="L1209">        return compositeTechLevel.getStaticTechLevel();</span>
    }

    @Override
    public int getBaseAvailability(int era) {
<span class="nc" id="L1214">        return compositeTechLevel.getBaseAvailability(era);</span>
    }

    @Override
    public String getExtinctionRange() {
<span class="nc" id="L1219">        return compositeTechLevel.getExtinctionRange();</span>
    }

    /**
     * return - the base construction option tech advancement
     */
    public abstract TechAdvancement getConstructionTechAdvancement();

    /**
     * Resets techAdvancement to initial value and adjusts for all installed equipment.
     */
    public void recalculateTechAdvancement() {
<span class="nc" id="L1231">        initTechAdvancement();</span>
<span class="nc bnc" id="L1232" title="All 2 branches missed.">        for (Mounted m : getEquipment()) {</span>
<span class="nc" id="L1233">            compositeTechLevel.addComponent(m.getType());</span>
<span class="nc bnc" id="L1234" title="All 2 branches missed.">            if (m.isArmored()) {</span>
<span class="nc" id="L1235">                compositeTechLevel.addComponent(TA_ARMORED_COMPONENT);</span>
            }
<span class="nc" id="L1237">        }</span>
<span class="nc" id="L1238">    }</span>

<span class="nc" id="L1240">    protected static final TechAdvancement TA_OMNI = new TechAdvancement(TECH_BASE_ALL)</span>
<span class="nc" id="L1241">            .setISAdvancement(DATE_NONE, DATE_NONE, 3052)</span>
<span class="nc" id="L1242">            .setClanAdvancement(2854, 2856, 2864).setClanApproximate(true)</span>
<span class="nc" id="L1243">            .setPrototypeFactions(F_CCY, F_CSF).setProductionFactions(F_CCY, F_DC)</span>
<span class="nc" id="L1244">            .setTechRating(RATING_E).setAvailability(RATING_X, RATING_E, RATING_E, RATING_D)</span>
<span class="nc" id="L1245">            .setStaticTechLevel(SimpleTechLevel.STANDARD);</span>
    // This is not in the rules anywhere, but is implied by the existence of the Badger and Bandit
    // tanks used by Wolf's Dragoons and sold to the merc market as early as 3008.
<span class="nc" id="L1248">    private static final TechAdvancement TA_OMNIVEHICLE = new TechAdvancement(TECH_BASE_ALL)</span>
<span class="nc" id="L1249">            .setISAdvancement(3008, DATE_NONE, 3052).setISApproximate(true)</span>
<span class="nc" id="L1250">            .setClanAdvancement(2854, 2856, 2864).setClanApproximate(true)</span>
<span class="nc" id="L1251">            .setPrototypeFactions(F_CCY, F_CSF, F_MERC).setProductionFactions(F_CCY, F_DC)</span>
<span class="nc" id="L1252">            .setTechRating(RATING_E).setAvailability(RATING_X, RATING_E, RATING_E, RATING_D)</span>
<span class="nc" id="L1253">            .setStaticTechLevel(SimpleTechLevel.STANDARD);</span>
<span class="nc" id="L1254">    protected static final TechAdvancement TA_PATCHWORK_ARMOR = new TechAdvancement(TECH_BASE_ALL)</span>
<span class="nc" id="L1255">            .setAdvancement(DATE_PS, 3075, 3080).setApproximate(false, false, true)</span>
<span class="nc" id="L1256">            .setTechRating(RATING_A)</span>
<span class="nc" id="L1257">            .setAvailability(RATING_E, RATING_D, RATING_E, RATING_E)</span>
<span class="nc" id="L1258">            .setStaticTechLevel(SimpleTechLevel.ADVANCED);</span>
<span class="nc" id="L1259">    protected static final TechAdvancement TA_MIXED_TECH = new TechAdvancement(TECH_BASE_ALL)</span>
<span class="nc" id="L1260">            .setISAdvancement(3050, 3082, 3115)</span>
<span class="nc" id="L1261">            .setClanAdvancement(2820, 3082, 3115).setApproximate(true, true, true)</span>
<span class="nc" id="L1262">            .setPrototypeFactions(F_CLAN, F_DC, F_FS, F_LC)</span>
<span class="nc" id="L1263">            .setTechRating(RATING_A).setAvailability(RATING_X, RATING_X, RATING_E, RATING_D)</span>
<span class="nc" id="L1264">            .setStaticTechLevel(SimpleTechLevel.ADVANCED);</span>
<span class="nc" id="L1265">    protected static final TechAdvancement TA_ARMORED_COMPONENT = new TechAdvancement(TECH_BASE_ALL)</span>
<span class="nc" id="L1266">            .setISAdvancement(3061, 3082).setClanAdvancement(3061, 3077)</span>
<span class="nc" id="L1267">            .setPrototypeFactions(F_CSF,F_FW).setProductionFactions(F_CJF,F_FW)</span>
<span class="nc" id="L1268">            .setTechRating(RATING_E).setAvailability(RATING_X, RATING_X, RATING_F, RATING_E)</span>
<span class="nc" id="L1269">            .setStaticTechLevel(SimpleTechLevel.EXPERIMENTAL);</span>

    public static TechAdvancement getOmniAdvancement() {
<span class="nc" id="L1272">        return getOmniAdvancement(null);</span>
    }
    
    public static TechAdvancement getOmniAdvancement(Entity en) {
<span class="nc bnc" id="L1276" title="All 2 branches missed.">        if (en instanceof Tank) {</span>
<span class="nc" id="L1277">            return new TechAdvancement(TA_OMNIVEHICLE);</span>
        } else {
<span class="nc" id="L1279">            return new TechAdvancement(TA_OMNI);</span>
        }
    }

    public static TechAdvancement getPatchworkArmorAdvancement() {
<span class="nc" id="L1284">        return new TechAdvancement(TA_PATCHWORK_ARMOR);</span>
    }

    public static TechAdvancement getMixedTechAdvancement() {
<span class="nc" id="L1288">        return new TechAdvancement(TA_MIXED_TECH);</span>
    }

    public static TechAdvancement getArmoredComponentTechAdvancement() {
<span class="nc" id="L1292">        return new TechAdvancement(TA_ARMORED_COMPONENT);</span>
    }

    /**
     * Incorporate dates for components that are not in the equipment list, such as engines and structure.
     */
    protected void addSystemTechAdvancement(CompositeTechLevel ctl) {
<span class="nc bnc" id="L1299" title="All 2 branches missed.">        if (hasEngine()) {</span>
<span class="nc" id="L1300">            ctl.addComponent(getEngine());</span>
        }
<span class="nc bnc" id="L1302" title="All 2 branches missed.">        if (isOmni()) {</span>
<span class="nc" id="L1303">            ctl.addComponent(TA_OMNI);</span>
        }
<span class="nc bnc" id="L1305" title="All 2 branches missed.">        if (hasPatchworkArmor()) {</span>
<span class="nc" id="L1306">            ctl.addComponent(TA_PATCHWORK_ARMOR);</span>
<span class="nc bnc" id="L1307" title="All 2 branches missed.">            for (int loc = 0; loc &lt; locations(); loc++) {</span>
<span class="nc" id="L1308">                ctl.addComponent(EquipmentType.getArmorTechAdvancement(armorType[loc],</span>
<span class="nc" id="L1309">                        TechConstants.isClan(armorTechLevel[loc])));</span>
            }
        } else {
<span class="nc" id="L1312">            ctl.addComponent(EquipmentType.getArmorTechAdvancement(armorType[0],</span>
<span class="nc" id="L1313">                    TechConstants.isClan(armorTechLevel[0])));</span>
        }
<span class="nc bnc" id="L1315" title="All 2 branches missed.">        if (isMixedTech()) {</span>
<span class="nc" id="L1316">            ctl.addComponent(TA_MIXED_TECH);</span>
        }
<span class="nc" id="L1318">        ctl.addComponent(EquipmentType.getStructureTechAdvancement(structureType,</span>
<span class="nc" id="L1319">                TechConstants.isClan(structureTechLevel)));</span>
        /* TM, p. 122 gives general eras for each tech rating, but not specific dates.
         * Besides that, there are many canon units with higher tech ratings than should
         * be possible in their era, so we're just going to add a stub to get the tech rating right
         * for cost purposes. */
<span class="nc bnc" id="L1324" title="All 2 branches missed.">        if (isSupportVehicle()) {</span>
<span class="nc" id="L1325">            TechAdvancement blank = new TechAdvancement(getConstructionTechAdvancement());</span>
<span class="nc" id="L1326">            ctl.addComponent(blank.setTechRating(getEngineTechRating()));</span>
<span class="nc" id="L1327">            ctl.addComponent(blank.setTechRating(getStructuralTechRating()));</span>
<span class="nc bnc" id="L1328" title="All 4 branches missed.">            if (!hasPatchworkArmor() &amp;&amp; (getArmorType(firstArmorIndex()) == EquipmentType.T_ARMOR_STANDARD)) {</span>
<span class="nc" id="L1329">                ctl.addComponent(blank.setTechRating(getArmorTechRating()));</span>
            }
        }
<span class="nc" id="L1332">    }</span>

    public int getRecoveryTurn() {
<span class="nc" id="L1335">        return recoveryTurn;</span>
    }

    public void setRecoveryTurn(int r) {
<span class="nc" id="L1339">        recoveryTurn = r;</span>
<span class="nc" id="L1340">    }</span>

    public boolean isManualShutdown() {
<span class="nc" id="L1343">        return manualShutdown;</span>
    }

    public void setManualShutdown(boolean tf) {
<span class="nc" id="L1347">        manualShutdown = tf;</span>
<span class="nc" id="L1348">    }</span>

    public void performManualShutdown() {
<span class="nc bnc" id="L1351" title="All 4 branches missed.">        if (isManualShutdown() || (getTaserShutdownRounds() != 0)</span>
<span class="nc bnc" id="L1352" title="All 2 branches missed.">            || isShutDown()) {</span>
<span class="nc" id="L1353">            return;</span>
        }
<span class="nc" id="L1355">        setShutDown(true);</span>
<span class="nc" id="L1356">        setManualShutdown(true);</span>
<span class="nc" id="L1357">    }</span>

    public void performManualStartup() {
<span class="nc bnc" id="L1360" title="All 2 branches missed.">        if (!isManualShutdown()) {</span>
<span class="nc" id="L1361">            return;</span>
        }
<span class="nc" id="L1363">        setManualShutdown(false);</span>
        // Can't startup if a taser shutdown or a TSEMP shutdown
<span class="nc bnc" id="L1365" title="All 2 branches missed.">        if ((getTaserShutdownRounds() == 0)</span>
<span class="nc bnc" id="L1366" title="All 2 branches missed.">            &amp;&amp; (getTsempEffect() != TSEMPWeapon.TSEMP_EFFECT_SHUTDOWN)) {</span>
<span class="nc" id="L1367">            setShutDown(false);</span>
<span class="nc" id="L1368">            setStartupThisPhase(true);</span>
        }
<span class="nc" id="L1370">    }</span>

    /**
     * Checks if this is a clan unit. It is determined by tech level.
     *
     * @return true if this unit is a clan unit.
     * @see megamek.common.Entity#setTechLevel(int)
     */
    public boolean isClan() {
<span class="nc bnc" id="L1379" title="All 8 branches missed.">        return ((techLevel == TechConstants.T_CLAN_TW)</span>
                || (techLevel == TechConstants.T_CLAN_ADVANCED)
                || (techLevel == TechConstants.T_CLAN_EXPERIMENTAL) || (techLevel == TechConstants.T_CLAN_UNOFFICIAL));
    }

    public boolean isClanArmor(int loc) {
        // if the location does not exist, it does not have clan armor
<span class="nc bnc" id="L1386" title="All 2 branches missed.">        if (loc &gt;= locations()) {</span>
<span class="nc" id="L1387">            return false;</span>
        }
        
<span class="nc bnc" id="L1390" title="All 2 branches missed.">        if (getArmorTechLevel(loc) == TechConstants.T_TECH_UNKNOWN) {</span>
<span class="nc" id="L1391">            return isClan();</span>
        }
<span class="nc bnc" id="L1393" title="All 2 branches missed.">        return ((getArmorTechLevel(loc) == TechConstants.T_CLAN_TW)</span>
<span class="nc bnc" id="L1394" title="All 2 branches missed.">                || (getArmorTechLevel(loc) == TechConstants.T_CLAN_ADVANCED)</span>
<span class="nc bnc" id="L1395" title="All 4 branches missed.">                || (getArmorTechLevel(loc) == TechConstants.T_CLAN_EXPERIMENTAL) || (getArmorTechLevel(loc) ==</span>
                                                                                     TechConstants.T_CLAN_UNOFFICIAL));
    }

    @Override
    public int getTechBase() {
<span class="nc bnc" id="L1401" title="All 2 branches missed.">        return isClan()? TECH_BASE_CLAN : TECH_BASE_IS;</span>
    }

    public boolean isMixedTech() {
<span class="nc" id="L1405">        return mixedTech;</span>
    }

    public void setMixedTech(boolean mixedTech) {
<span class="nc" id="L1409">        this.mixedTech = mixedTech;</span>
<span class="nc" id="L1410">    }</span>

    public boolean isDesignValid() {
<span class="nc" id="L1413">        return designValid;</span>
    }

    public void setDesignValid(boolean designValid) {
<span class="nc" id="L1417">        this.designValid = designValid;</span>
<span class="nc" id="L1418">    }</span>

    public int getYear() {
<span class="nc" id="L1421">        return year;</span>
    }

    public void setYear(int year) {
<span class="nc" id="L1425">        this.year = year;</span>
<span class="nc" id="L1426">    }</span>

    /** @return the tonnage of the Entity, not its weight */
    public double getWeight() {
<span class="nc" id="L1430">        return weight;</span>
    }

    // TODO: WeightClass is no longer correct. See the Tech Manual
    public int getWeightClass() {
<span class="nc" id="L1435">        return EntityWeightClass.getWeightClass(getWeight(), this);</span>
    }

    public String getWeightClassName() {
<span class="nc" id="L1439">        return EntityWeightClass.getClassName(getWeightClass(), this);</span>
    }

    //Since this varies by unit type, it will be defined as overrides in each relevant class
    public boolean isSuperHeavy() {
<span class="nc" id="L1444">        return false;</span>
    }

    public void setWeight(double weight) {
<span class="nc" id="L1448">        this.weight = weight;</span>
        // Any time the weight is reset we need to reset the crew size
<span class="nc" id="L1450">        crew.setSize(Compute.getFullCrewSize(this));</span>
<span class="nc" id="L1451">        crew.setCurrentSize(crew.getSize());</span>
<span class="nc" id="L1452">    }</span>

    public boolean isOmni() {
<span class="nc" id="L1455">        return omni;</span>
    }

    public void setOmni(boolean omni) {
<span class="nc" id="L1459">        this.omni = omni;</span>
<span class="nc" id="L1460">    }</span>

    /**
     * Returns the number of locations in the entity
     */
    public abstract int locations();

    /**
     * Determines where to place equipment that does not require a specific location. What
     * this means varies by {@link Entity} type.
     *
     * @return        The location to place equipment that is not required to be assigned a location,
     *                defaulting to Entity.LOC_NONE for unit types that do not have such a location.
     */
    public int getBodyLocation() {
<span class="nc" id="L1475">        return LOC_NONE;</span>
    }

    /**
     * Returns the player that &quot;owns&quot; this entity.
     */
    public IPlayer getOwner() {
<span class="nc" id="L1482">        return owner;</span>
    }

    public void setOwner(IPlayer player) {
<span class="nc" id="L1486">        owner = player;</span>
<span class="nc" id="L1487">        ownerId = player.getId();</span>

<span class="nc" id="L1489">        generateDisplayName();</span>
<span class="nc" id="L1490">    }</span>

    public int getOwnerId() {
<span class="nc" id="L1493">        return ownerId;</span>
    }

    /**
     * Returns true if the other entity is an enemy of this entity. This is more
     * reliable than Player.isEnemyOf since it knows that an entity will never
     * be an enemy of itself.
     */
    public boolean isEnemyOf(Entity other) {
<span class="nc bnc" id="L1502" title="All 2 branches missed.">        if(null == other) {</span>
<span class="nc" id="L1503">            return false;</span>
        }
<span class="nc bnc" id="L1505" title="All 2 branches missed.">        if(null == owner) {</span>
<span class="nc bnc" id="L1506" title="All 4 branches missed.">            return ((id != other.getId()) &amp;&amp; (ownerId != other.ownerId));</span>
        }
<span class="nc bnc" id="L1508" title="All 2 branches missed.">        return (id != other.getId())</span>
<span class="nc bnc" id="L1509" title="All 4 branches missed.">            &amp;&amp; ((null == other.getOwner()) || owner.isEnemyOf(other.getOwner()));</span>
    }

    public Crew getCrew() {
<span class="nc" id="L1513">        return crew;</span>
    }

    public void setCrew(Crew crew) {
<span class="nc" id="L1517">        this.crew = crew;</span>
<span class="nc" id="L1518">    }</span>
    
    /**
     * @return The total number of crew available to supplement marines on boarding actions.
     *         Includes officers, enlisted, and bay personnel, but not marines/ba or passengers.
     */
    public int getNCrew() {
<span class="nc" id="L1525">        return nCrew;</span>
    }
    
    public void setNCrew(int crew) {
<span class="nc" id="L1529">    }</span>
    
    /**
     * Returns the number of passengers on this unit
     * Intended for spacecraft, where we want to get the crews of transported units
     * plus actual passengers assigned to quarters
     * @return
     */
    public int getNPassenger() {
<span class="nc" id="L1538">        return nPassenger;</span>
    }
    
    public void setNPassenger(int pass) {
<span class="nc" id="L1542">    }</span>
    
    /**
     * @return The number conventional marines available to vessels for boarding actions.
     */
    public int getNMarines() {
<span class="nc" id="L1548">        return nMarines;</span>
    }
    
    /**
     * Updates the number of marines aboard
     * @param marines The number of marines to add/subtract
     */
    public void setNMarines(int marines) {
<span class="nc" id="L1556">    }</span>

    /**
     * Units with a cockpit command console provide an initiative bonus to their side, provided
     * that the commander is not currently functioning as pilot, the unit has advanced fire control,
     * and the unit is heavy or assault weight class.
     *
     * @return Whether the Entity qualifies for initiative bonus from cockpit command console.
     */
    public boolean hasCommandConsoleBonus() {
<span class="nc" id="L1566">        return false;</span>
    }

    public boolean isShutDown() {
<span class="nc" id="L1570">        return shutDown;</span>
    }

    public void setShutDown(boolean shutDown) {
<span class="nc" id="L1574">        this.shutDown = shutDown;</span>
<span class="nc" id="L1575">        setShutDownThisPhase(shutDown);</span>
<span class="nc" id="L1576">    }</span>

    public void setShutDownThisPhase(boolean shutDown) {
<span class="nc" id="L1579">        shutDownThisPhase = shutDown;</span>
<span class="nc" id="L1580">    }</span>

    public boolean isShutDownThisPhase() {
<span class="nc" id="L1583">        return shutDownThisPhase;</span>
    }

    public void setStartupThisPhase(boolean shutDown) {
<span class="nc" id="L1587">        startupThisPhase = shutDown;</span>
<span class="nc" id="L1588">    }</span>

    public boolean isStartupThisPhase() {
<span class="nc" id="L1591">        return startupThisPhase;</span>
    }

    public boolean isDoomed() {
<span class="nc" id="L1595">        return doomed;</span>
    }

    public void setDoomed(boolean doomed) {
        // Doomed entities aren't in retreat.
<span class="nc bnc" id="L1600" title="All 2 branches missed.">        if (doomed) {</span>
<span class="nc" id="L1601">            setRemovalCondition(IEntityRemovalConditions.REMOVE_SALVAGEABLE);</span>
        }
<span class="nc" id="L1603">        this.doomed = doomed;</span>
<span class="nc" id="L1604">    }</span>

    public boolean isDestroyed() {
<span class="nc" id="L1607">        return destroyed;</span>
    }

    public void setDestroyed(boolean destroyed) {
<span class="nc" id="L1611">        this.destroyed = destroyed;</span>
<span class="nc" id="L1612">    }</span>

    // Targetable interface
    @Override
    public int getTargetType() {
<span class="nc" id="L1617">        return Targetable.TYPE_ENTITY;</span>
    }

    @Override
    public int getTargetId() {
<span class="nc" id="L1622">        return getId();</span>
    }

    @Override
    public int getHeight() {
<span class="nc" id="L1627">        return height();</span>
    }

    // End Targetable interface

    public boolean isDone() {
<span class="nc" id="L1633">        return done;</span>
    }

    public void setDone(boolean done) {
<span class="nc" id="L1637">        this.done = done;</span>
<span class="nc" id="L1638">    }</span>

    /**
     * This method should &lt;strong&gt;only&lt;/stong&gt; be called when needed to remove a
     * dead swarmer's game turn.
     */
    public void setUnloaded(boolean unloaded) {
<span class="nc" id="L1645">        unloadedThisTurn = unloaded;</span>
<span class="nc" id="L1646">    }</span>

    public void setLoadedThisTurn(boolean loaded) {
<span class="nc" id="L1649">        loadedThisTurn = loaded;</span>
<span class="nc" id="L1650">    }</span>

    /**
     * Determine if this entity participate in the current game phase.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if this entity is not shut down, is not
     * destroyed, has an active crew, and was not unloaded from a
     * transport this turn. &lt;code&gt;false&lt;/code&gt; otherwise.
     */
    public boolean isActive() {
<span class="nc" id="L1660">        return this.isActive(-1);</span>
    }

    public boolean isActive(int turn) {
<span class="nc bnc" id="L1664" title="All 6 branches missed.">        boolean isActive = !shutDown &amp;&amp; !isManualShutdown() &amp;&amp; !destroyed</span>
<span class="nc bnc" id="L1665" title="All 4 branches missed.">                           &amp;&amp; getCrew().isActive() &amp;&amp; !unloadedThisTurn;</span>

<span class="nc bnc" id="L1667" title="All 4 branches missed.">        if ((turn &gt; -1) &amp;&amp; isActive) {</span>
<span class="nc bnc" id="L1668" title="All 4 branches missed.">            isActive = !deployed &amp;&amp; shouldDeploy(turn);</span>
        } else {
<span class="nc bnc" id="L1670" title="All 4 branches missed.">            isActive = isActive &amp;&amp; deployed;</span>
        }

<span class="nc" id="L1673">        return isActive;</span>
    }

    /**
     * Returns true if this entity is selectable for action. Transported
     * entities can not be selected.
     */
    public boolean isSelectableThisTurn() {
<span class="nc bnc" id="L1681" title="All 6 branches missed.">        return !done &amp;&amp; (conveyance == Entity.NONE) &amp;&amp; !unloadedThisTurn</span>
<span class="nc bnc" id="L1682" title="All 4 branches missed.">               &amp;&amp; !isClearingMinefield() &amp;&amp; !isCarcass();</span>
    }

    /**
     * Returns true if this entity could potentially be loaded (did not move
     * from starting hex)
     */
    public boolean isLoadableThisTurn() {
<span class="nc bnc" id="L1690" title="All 6 branches missed.">        return (delta_distance == 0) &amp;&amp; (conveyance == Entity.NONE)</span>
<span class="nc bnc" id="L1691" title="All 4 branches missed.">               &amp;&amp; !unloadedThisTurn &amp;&amp; !isClearingMinefield() &amp;&amp; getTractor() == Entity.NONE;</span>
    }

    /**
     * Determine if this &lt;code&gt;Entity&lt;/code&gt; was unloaded previously this turn.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if this entity was unloaded for any reason
     * during this turn.
     */
    public boolean isUnloadedThisTurn() {
<span class="nc" id="L1701">        return unloadedThisTurn;</span>
    }

    public boolean wasLoadedThisTurn() {
<span class="nc" id="L1705">        return loadedThisTurn;</span>
    }

    /**
     * Returns true if this entity is targetable for attacks.  A unit is
     * targetable if it is not destroyed, not doomed, deployed, not off board,
     * not being transported, and not captured.
     */
    public boolean isTargetable() {
<span class="nc bnc" id="L1714" title="All 12 branches missed.">        return !destroyed &amp;&amp; !doomed &amp;&amp; deployed &amp;&amp; !isOffBoard()</span>
               &amp;&amp; (conveyance == Entity.NONE) &amp;&amp; !captured
<span class="nc bnc" id="L1716" title="All 2 branches missed.">               &amp;&amp; (getPosition() != null);</span>
    }

    public boolean isProne() {
<span class="nc" id="L1720">        return prone;</span>
    }

    public void setProne(boolean prone) {
<span class="nc" id="L1724">        this.prone = prone;</span>
<span class="nc bnc" id="L1725" title="All 2 branches missed.">        if (prone) {</span>
<span class="nc" id="L1726">            hullDown = false;</span>
        }
<span class="nc" id="L1728">    }</span>

    public boolean isHullDown() {
<span class="nc" id="L1731">        return hullDown;</span>
    }

    public void setHullDown(boolean down) {
<span class="nc" id="L1735">        hullDown = down;</span>
<span class="nc bnc" id="L1736" title="All 2 branches missed.">        if (hullDown) {</span>
<span class="nc" id="L1737">            prone = false;</span>
        }
<span class="nc" id="L1739">    }</span>

    /**
     * Is this entity shut down or is the crew unconscious?
     */
    @Override
    public boolean isImmobile() {
<span class="nc" id="L1746">        return isImmobile(true);</span>
    }

    /**
     * Is this entity shut down, or if applicable is the crew unconscious?
     * @param checkCrew If true, consider the fitness of the crew when determining
     *                  if the entity is immobile.
     */
    public boolean isImmobile(boolean checkCrew) {
<span class="nc bnc" id="L1755" title="All 8 branches missed.">        return isShutDown() || (checkCrew &amp;&amp; (crew != null) &amp;&amp; crew.isUnconscious());</span>
    }

    /**
     * This method returns true if a unit is permanently immobilized either
     * because its crew is dead/gone or because of damage
     *
     * @return true if unit is permanently immobile
     */
    public boolean isPermanentlyImmobilized(boolean checkCrew) {
<span class="nc bnc" id="L1765" title="All 6 branches missed.">        if (checkCrew &amp;&amp; ((getCrew() == null) || getCrew().isDead())) {</span>
<span class="nc" id="L1766">            return true;</span>
<span class="nc bnc" id="L1767" title="All 6 branches missed.">        } else if (((getOriginalWalkMP() &gt; 0) || (getOriginalRunMP() &gt; 0) || (getOriginalJumpMP() &gt; 0))</span>
                /*
                 * Need to make sure here that we're ignoring heat because
                 * that's not actually &quot;permanent&quot;:
                 */
<span class="nc bnc" id="L1772" title="All 2 branches missed.">                &amp;&amp; ((getWalkMP(true, true, false) == 0)</span>
<span class="nc bnc" id="L1773" title="All 4 branches missed.">                    &amp;&amp; (getRunMP(true, true, false) == 0) &amp;&amp; (getJumpMP() == 0))) {</span>
<span class="nc" id="L1774">            return true;</span>
        } else {
<span class="nc" id="L1776">            return false;</span>
        }
    }

    public boolean isCharging() {
<span class="nc" id="L1781">        return displacementAttack instanceof ChargeAttackAction;</span>
    }

    public boolean isPushing() {
<span class="nc" id="L1785">        return displacementAttack instanceof PushAttackAction;</span>
    }

    public boolean isMakingDfa() {
<span class="nc" id="L1789">        return displacementAttack instanceof DfaAttackAction;</span>
    }

    public boolean hasDisplacementAttack() {
<span class="nc bnc" id="L1793" title="All 2 branches missed.">        return displacementAttack != null;</span>
    }

    public DisplacementAttackAction getDisplacementAttack() {
<span class="nc" id="L1797">        return displacementAttack;</span>
    }

    public void setDisplacementAttack(
            DisplacementAttackAction displacementAttack) {
<span class="nc" id="L1802">        this.displacementAttack = displacementAttack;</span>
<span class="nc" id="L1803">    }</span>

    /**
     * Returns true if any other entities this entity knows of are making a
     * displacement attack on this entity.
     */
    public boolean isTargetOfDisplacementAttack() {
<span class="nc bnc" id="L1810" title="All 2 branches missed.">        return findTargetedDisplacement() != null;</span>
    }

    /**
     * Returns any known displacement attacks (should only be one) that this
     * entity is a target of.
     */
    public DisplacementAttackAction findTargetedDisplacement() {
<span class="nc bnc" id="L1818" title="All 2 branches missed.">        for (Entity other : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L1819" title="All 2 branches missed.">            if (other.hasDisplacementAttack()</span>
<span class="nc bnc" id="L1820" title="All 2 branches missed.">                &amp;&amp; (other.getDisplacementAttack().getTargetId() == id)) {</span>
<span class="nc" id="L1821">                return other.getDisplacementAttack();</span>
            }
<span class="nc" id="L1823">        }</span>
<span class="nc" id="L1824">        return null;</span>
    }

    public boolean isUnjammingRAC() {
<span class="nc" id="L1828">        return unjammingRAC;</span>
    }

    public void setUnjammingRAC(boolean u) {
<span class="nc" id="L1832">        unjammingRAC = u;</span>
<span class="nc" id="L1833">    }</span>

    public boolean isFindingClub() {
<span class="nc" id="L1836">        return findingClub;</span>
    }

    public void setFindingClub(boolean findingClub) {
<span class="nc" id="L1840">        this.findingClub = findingClub;</span>
<span class="nc" id="L1841">    }</span>

    /**
     * Set whether or not the mech's arms are flipped to the rear
     */
    public void setArmsFlipped(boolean armsFlipped) {
<span class="nc" id="L1847">        setArmsFlipped(armsFlipped, true);</span>
<span class="nc" id="L1848">    }</span>
    
    /**
     * Set whether or not the mech's arms are flipped to the rear.
     * Does not fire the game event, useful for when it's called repeatedly
     * such as during bot turn calculations
     */
    public void setArmsFlipped(boolean armsFlipped, boolean fireEvent) {
<span class="nc" id="L1856">        this.armsFlipped = armsFlipped;</span>
        
<span class="nc bnc" id="L1858" title="All 2 branches missed.">        if (fireEvent) {</span>
<span class="nc" id="L1859">            game.processGameEvent(new GameEntityChangeEvent(this, this));</span>
        }
<span class="nc" id="L1861">    }</span>

    /**
     * Returns true if the mech's arms are flipped to the rear
     */
    public boolean getArmsFlipped() {
<span class="nc" id="L1867">        return armsFlipped;</span>
    }

    /**
     * @return true if the VTOL or LAM is making a VTOL strafe or VTOL/AirMech bomb attack
     */
    public boolean isMakingVTOLGroundAttack() {
<span class="nc" id="L1874">        return false;</span>
    }


    /**
     * Returns the current position of this entity on the board. This is not
     * named getLocation(), since I want the word location to refer to hit
     * locations on a mech or vehicle.
     */
    @Override
    public Coords getPosition() {
<span class="nc" id="L1885">        return position;</span>
    }

    /**
     * Returns a set of the coords this Entity occupies
     *
     * @return
     */
    public HashSet&lt;Coords&gt; getOccupiedCoords() {
<span class="nc" id="L1894">        HashSet&lt;Coords&gt; positions = new HashSet&lt;Coords&gt;();</span>
<span class="nc bnc" id="L1895" title="All 2 branches missed.">        if ((getSecondaryPositions() != null)</span>
<span class="nc bnc" id="L1896" title="All 2 branches missed.">            &amp;&amp; (getSecondaryPositions().size() != 0)) {</span>
<span class="nc bnc" id="L1897" title="All 2 branches missed.">            for (int key : getSecondaryPositions().keySet()) {</span>
<span class="nc" id="L1898">                positions.add(getSecondaryPositions().get(key));</span>
<span class="nc" id="L1899">            }</span>
<span class="nc bnc" id="L1900" title="All 2 branches missed.">        } else if (getPosition() != null) {</span>
<span class="nc" id="L1901">            positions.add(getPosition());</span>
        }
<span class="nc" id="L1903">        return positions;</span>
    }

    public void setPosition(Coords position) {
<span class="nc" id="L1907">        setPosition(position, true);</span>
<span class="nc" id="L1908">    }</span>

    /**
     * Sets the current position of this entity on the board.
     *
     * @param position the new position.
     */
    public void setPosition(Coords position, boolean gameUpdate) {
<span class="nc" id="L1916">        HashSet&lt;Coords&gt; oldPositions = null;</span>
<span class="nc bnc" id="L1917" title="All 4 branches missed.">        if ((game != null) &amp;&amp; gameUpdate) {</span>
<span class="nc" id="L1918">            oldPositions = getOccupiedCoords();</span>
        }
<span class="nc" id="L1920">        this.position = position;</span>
<span class="nc bnc" id="L1921" title="All 4 branches missed.">        if ((game != null) &amp;&amp; gameUpdate) {</span>
<span class="nc" id="L1922">            game.updateEntityPositionLookup(this, oldPositions);</span>
        }
<span class="nc" id="L1924">    }</span>

    /**
     * @return the coords of the second to last position on the passed through
     * vector or the current position if too small
     */

    public Coords getPriorPosition() {
<span class="nc bnc" id="L1932" title="All 2 branches missed.">        if (passedThrough.size() &lt; 2) {</span>
<span class="nc" id="L1933">            return getPosition();</span>
        }
<span class="nc" id="L1935">        return passedThrough.elementAt(passedThrough.size() - 2);</span>
    }

    /**
     * Sets the current elevation of this entity above the ground.  This is the
     * number of levels the unit is above the level of the hex.
     *
     * @param elevation an &lt;code&gt;int&lt;/code&gt; representing the new elevation.
     */
    public void setElevation(int elevation) {
<span class="nc" id="L1945">        this.elevation = elevation;</span>
<span class="nc" id="L1946">    }</span>

    /**
     * A helper function for fiddling with elevation. Takes the current hex, a
     * hex being moved to, returns the elevation the Entity will be considered
     * to be at w/r/t it's new hex.
     */
    public int calcElevation(IHex current, IHex next, int assumedElevation,
            boolean climb, boolean wigeEndClimbPrevious) {
<span class="nc" id="L1955">        int retVal = assumedElevation;</span>
<span class="nc bnc" id="L1956" title="All 2 branches missed.">        if (isAero()) {</span>
<span class="nc" id="L1957">            return retVal;</span>
        }
<span class="nc bnc" id="L1959" title="All 2 branches missed.">        if (getMovementMode() == EntityMovementMode.WIGE) {</span>
            // Airborne WiGEs remain 1 elevation above underlying terrain, unless climb mode is
            // on, then they maintain current absolute elevation  as long as it is at least
            // one level above the ground.
            // WiGEs treat the tops of buildings as the underlying terrain, but must pay an additional
            // 2 MP to climb.
            // See http://bg.battletech.com/forums/index.php?topic=51081.msg1297747#msg1297747

            // Find level equivalent of current elevation
<span class="nc" id="L1968">            int level = current.surface() + assumedElevation;</span>
            // For WiGE purposes, the surface of a hex with a building is the roof; otherwise it's the surface of the hex.
<span class="nc" id="L1970">            int curSurface = current.surface();</span>
<span class="nc bnc" id="L1971" title="All 2 branches missed.">            if (current.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L1972">                curSurface += current.terrainLevel(Terrains.BLDG_ELEV);</span>
            }
<span class="nc" id="L1974">            int nextSurface = next.surface();</span>
<span class="nc bnc" id="L1975" title="All 2 branches missed.">            if (next.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L1976">                nextSurface += next.terrainLevel(Terrains.BLDG_ELEV);</span>
            }

            int nextLevel;
<span class="nc bnc" id="L1980" title="All 2 branches missed.">            if (level - curSurface &lt;= 0) {</span>
                // If we are not above the effective surface, we are not airborne and the next level
                // is the effective surface of the next hex.
<span class="nc" id="L1983">                nextLevel = nextSurface;</span>
<span class="nc bnc" id="L1984" title="All 2 branches missed.">            } else if (climb) {</span>
                // If climb mode is on, we maintain the same level unless the next surface requires climbing.
                // is the effective surface of the next hex.
<span class="nc" id="L1987">                nextLevel = Math.max(level, nextSurface + 1);</span>
            } else {
                // Otherwise we move to one elevation level above the effective surface.
<span class="nc" id="L1990">                nextLevel = nextSurface + 1;</span>
            }
            // Elevation is this height of the level above the actual surface elevation of the hex.
<span class="nc" id="L1993">            retVal = nextLevel - next.surface();</span>
<span class="nc bnc" id="L1994" title="All 2 branches missed.">        } else if ((getMovementMode() == EntityMovementMode.SUBMARINE)</span>
<span class="nc bnc" id="L1995" title="All 2 branches missed.">            || ((getMovementMode() == EntityMovementMode.INF_UMU)</span>
<span class="nc bnc" id="L1996" title="All 2 branches missed.">                &amp;&amp; next.containsTerrain(Terrains.WATER) &amp;&amp; current</span>
<span class="nc bnc" id="L1997" title="All 2 branches missed.">                .containsTerrain(Terrains.WATER))</span>
<span class="nc bnc" id="L1998" title="All 2 branches missed.">            || (getMovementMode() == EntityMovementMode.VTOL)</span>
<span class="nc bnc" id="L1999" title="All 4 branches missed.">            || ((getMovementMode() == EntityMovementMode.QUAD_SWIM) &amp;&amp; hasUMU())</span>
<span class="nc bnc" id="L2000" title="All 4 branches missed.">            || ((getMovementMode() == EntityMovementMode.BIPED_SWIM) &amp;&amp; hasUMU())) {</span>
<span class="nc" id="L2001">            retVal += current.surface();</span>
<span class="nc" id="L2002">            retVal -= next.surface();</span>
        } else {
            // if we're a hovercraft, surface ship, WIGE or a &quot;fully amphibious&quot; vehicle, we go on the water surface
            // without adjusting elevation
<span class="nc bnc" id="L2006" title="All 2 branches missed.">            if ((getMovementMode() != EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L2007" title="All 2 branches missed.">                &amp;&amp; (getMovementMode() != EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L2008" title="All 2 branches missed.">                &amp;&amp; (getMovementMode() != EntityMovementMode.HYDROFOIL)</span>
<span class="nc bnc" id="L2009" title="All 2 branches missed.">                &amp;&amp; (getMovementMode() != EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L2010" title="All 2 branches missed.">                &amp;&amp; !hasWorkingMisc(MiscType.F_FULLY_AMPHIBIOUS)) {</span>
<span class="nc" id="L2011">                int prevWaterLevel = 0;</span>
<span class="nc bnc" id="L2012" title="All 2 branches missed.">                if (current.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L2013">                    prevWaterLevel = current.terrainLevel(Terrains.WATER);</span>
<span class="nc bnc" id="L2014" title="All 4 branches missed.">                    if (!(current.containsTerrain(Terrains.ICE))</span>
                        || (assumedElevation &lt; 0)) {
                        // count water, only if the entity isn't on ice surface
<span class="nc" id="L2017">                        retVal += current.terrainLevel(Terrains.WATER);</span>
                    }
                }
<span class="nc bnc" id="L2020" title="All 2 branches missed.">                if (next.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L2021">                    int waterLevel = next.terrainLevel(Terrains.WATER);</span>
<span class="nc bnc" id="L2022" title="All 2 branches missed.">                    if (next.containsTerrain(Terrains.ICE)) {</span>
                        // a mech can only climb out onto ice in depth 2 or
                        // shallower water
                        // mech on the surface will stay on the surface

<span class="nc bnc" id="L2027" title="All 10 branches missed.">                        if (((waterLevel == 1) &amp;&amp; (prevWaterLevel == 1))</span>
                            || ((prevWaterLevel &lt;= 2) &amp;&amp; climb)
                            || (assumedElevation &gt;= 0)) {
<span class="nc" id="L2030">                            retVal += waterLevel;</span>
                        }
                    }
<span class="nc" id="L2033">                    retVal -= waterLevel;</span>
                }
            }

<span class="nc bnc" id="L2037" title="All 2 branches missed.">            if (next.containsTerrain(Terrains.BUILDING)</span>
<span class="nc bnc" id="L2038" title="All 2 branches missed.">                || current.containsTerrain(Terrains.BUILDING)) {</span>
<span class="nc" id="L2039">                int bldcur = Math.max(-current.depth(true),</span>
<span class="nc" id="L2040">                                      current.terrainLevel(Terrains.BLDG_ELEV));</span>
<span class="nc" id="L2041">                int bldnex = Math.max(-next.depth(true),</span>
<span class="nc" id="L2042">                                      next.terrainLevel(Terrains.BLDG_ELEV));</span>
<span class="nc bnc" id="L2043" title="All 10 branches missed.">                if (((assumedElevation == bldcur)</span>
                     &amp;&amp; (climb || isJumpingNow) &amp;&amp; (this instanceof Mech))
                    || (retVal &gt; bldnex)) {
<span class="nc" id="L2046">                    retVal = bldnex;</span>
<span class="nc" id="L2047">                } else if ((bldnex + next.surface())</span>
<span class="nc bnc" id="L2048" title="All 2 branches missed.">                        &gt; (bldcur + current.surface())) {</span>
<span class="nc" id="L2049">                    int nextBasement =</span>
<span class="nc" id="L2050">                            next.terrainLevel(Terrains.BLDG_BASEMENT_TYPE);</span>
<span class="nc" id="L2051">                    int collapsedBasement =</span>
<span class="nc" id="L2052">                            next.terrainLevel(Terrains.BLDG_BASE_COLLAPSED);</span>
<span class="nc bnc" id="L2053" title="All 4 branches missed.">                    if (climb || isJumpingNow) {</span>
<span class="nc" id="L2054">                        retVal = bldnex + next.surface();</span>
                    // If the basement is collapsed, there is no level 0
<span class="nc bnc" id="L2056" title="All 2 branches missed.">                    } else if ((assumedElevation == 0)</span>
<span class="nc bnc" id="L2057" title="All 4 branches missed.">                            &amp;&amp; (nextBasement &gt; BasementType.NONE.getValue())</span>
                            &amp;&amp; (collapsedBasement &gt; 0)) {
<span class="nc" id="L2059">                        retVal -= BasementType.getType(</span>
<span class="nc" id="L2060">                                next.terrainLevel(Terrains.BLDG_BASEMENT_TYPE))</span>
<span class="nc" id="L2061">                                              .getDepth();</span>
                    } else {
<span class="nc" id="L2063">                        retVal += current.surface();</span>
<span class="nc" id="L2064">                        retVal -= next.surface();</span>
                    }
<span class="nc bnc" id="L2066" title="All 2 branches missed.">                } else if (elevation == -(current.depth(true))) {</span>
<span class="nc bnc" id="L2067" title="All 4 branches missed.">                    if (climb || isJumpingNow) {</span>
<span class="nc" id="L2068">                        retVal = bldnex + next.surface();</span>
<span class="nc" id="L2069">                    } else if ((current</span>
<span class="nc" id="L2070">                                        .terrainLevel(Terrains.BLDG_BASEMENT_TYPE) &gt; BasementType.NONE</span>
<span class="nc bnc" id="L2071" title="All 2 branches missed.">                                        .getValue())</span>
                               &amp;&amp; (assumedElevation == -BasementType
<span class="nc" id="L2073">                            .getType(</span>
<span class="nc" id="L2074">                                    current.terrainLevel(Terrains.BLDG_BASEMENT_TYPE))</span>
<span class="nc bnc" id="L2075" title="All 2 branches missed.">                            .getDepth())) {</span>
<span class="nc" id="L2076">                        retVal = -BasementType.getType(</span>
<span class="nc" id="L2077">                                next.terrainLevel(Terrains.BLDG_BASEMENT_TYPE))</span>
<span class="nc" id="L2078">                                              .getDepth();</span>
                    } else {
<span class="nc" id="L2080">                        retVal += current.surface();</span>
<span class="nc" id="L2081">                        retVal -= next.surface();</span>
                    }
                }
            }
<span class="nc bnc" id="L2085" title="All 2 branches missed.">            if ((getMovementMode() != EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L2086" title="All 2 branches missed.">                    &amp;&amp; (getMovementMode() != EntityMovementMode.HYDROFOIL)</span>
<span class="nc bnc" id="L2087" title="All 2 branches missed.">                    &amp;&amp; (next.containsTerrain(Terrains.BRIDGE) || current</span>
<span class="nc bnc" id="L2088" title="All 2 branches missed.">                            .containsTerrain(Terrains.BRIDGE))) {</span>
                int bridgeElev;
<span class="nc bnc" id="L2090" title="All 2 branches missed.">                if (next.containsTerrain(Terrains.BRIDGE)) {</span>
<span class="nc" id="L2091">                    bridgeElev = next.terrainLevel(Terrains.BRIDGE_ELEV);</span>
                } else {
<span class="nc" id="L2093">                    bridgeElev = 0;</span>
                }
<span class="nc" id="L2095">                int elevDiff = Math.abs((next.surface() + bridgeElev)</span>
<span class="nc" id="L2096">                        - (current.surface() + assumedElevation));</span>
<span class="nc bnc" id="L2097" title="All 2 branches missed.">                if (elevDiff &lt;= getMaxElevationChange()) {</span>
                    // bridge is reachable at least
<span class="nc bnc" id="L2099" title="All 4 branches missed.">                    if (climb || !isElevationValid(retVal, next)) {</span>
                        // use bridge if you can't use the base terrain or if
                        // you prefer to by climb mode
<span class="nc" id="L2102">                        retVal = bridgeElev;</span>
                    }
                }
            }
        }

<span class="nc" id="L2108">        return retVal;</span>
    }

    public int calcElevation(IHex current, IHex next) {
<span class="nc" id="L2112">        return calcElevation(current, next, elevation, false, false);</span>
    }

    /**
     * Returns the elevation of this entity, relative to the current Hex's
     * surface
     */
    @Override
    public int getElevation() {
<span class="nc bnc" id="L2121" title="All 2 branches missed.">        if (Entity.NONE != getTransportId()) {</span>
<span class="nc" id="L2122">            return game.getEntity(getTransportId()).getElevation();</span>
        }

<span class="nc bnc" id="L2125" title="All 4 branches missed.">        if ((null == getPosition()) &amp;&amp; (isDeployed())) {</span>
<span class="nc" id="L2126">            throw new IllegalStateException(&quot;Entity #&quot; + getId()</span>
                                            + &quot; does not know its position.&quot;);
        }

<span class="nc bnc" id="L2130" title="All 2 branches missed.">        if (isOffBoard()) {</span>
<span class="nc" id="L2131">            return 0;</span>
        }

<span class="nc" id="L2134">        return elevation;</span>
    }

    public boolean canGoDown() {
<span class="nc" id="L2138">        return canGoDown(elevation, getPosition());</span>
    }

    /**
     * is it possible to go down, or are we landed/just above the
     * water/treeline? assuming passed elevation.
     */
    public boolean canGoDown(int assumedElevation, Coords assumedPos) {
<span class="nc bnc" id="L2146" title="All 2 branches missed.">        if (!getGame().getBoard().contains(assumedPos)) {</span>
<span class="nc" id="L2147">            return false;</span>
        }
<span class="nc" id="L2149">        IHex hex = getGame().getBoard().getHex(assumedPos);</span>
<span class="nc" id="L2150">        int assumedAlt = assumedElevation + hex.surface();</span>
<span class="nc" id="L2151">        int minAlt = hex.surface();</span>
<span class="nc bnc" id="L2152" title="All 8 branches missed.">        switch (getMovementMode()) {</span>
            case INF_JUMP:
            case INF_LEG:
            case INF_MOTORIZED:
<span class="nc" id="L2156">                minAlt -= Math.max(</span>
                        0,
<span class="nc" id="L2158">                        BasementType.getType(</span>
<span class="nc" id="L2159">                                hex.terrainLevel(Terrains.BLDG_BASEMENT_TYPE))</span>
<span class="nc" id="L2160">                                    .getDepth());</span>
<span class="nc" id="L2161">                break;</span>
            case WIGE:
                // Per errata, WiGEs have flotation hull, which makes no sense unless it changes the rule
                // in TW that they cannot land on water.
                // See
<span class="nc bnc" id="L2166" title="All 2 branches missed.">                if (isAirborne()) {</span>
<span class="nc" id="L2167">                    return false;</span>
                }
<span class="nc bnc" id="L2169" title="All 2 branches missed.">                if (hex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L2170">                    minAlt = hex.surface();</span>
<span class="nc" id="L2171">                    break;</span>
                }
                // else fall through
            case VTOL:
<span class="nc" id="L2175">                int minElev = 0;</span>
                // When over a bridge, limit downward movement. Can land on a bridge.
<span class="nc bnc" id="L2177" title="All 2 branches missed.">                if (hex.containsTerrain(Terrains.BRIDGE_ELEV)</span>
<span class="nc bnc" id="L2178" title="All 2 branches missed.">                        &amp;&amp; (assumedElevation &gt;= hex.terrainLevel(Terrains.BRIDGE_ELEV)) ) {</span>
<span class="nc" id="L2179">                    minElev = hex.terrainLevel(Terrains.BRIDGE_ELEV);</span>
                }
                // Cannot land on woods or water
<span class="nc bnc" id="L2182" title="All 4 branches missed.">                if (hex.containsTerrain(Terrains.WOODS) || hex.containsTerrain(Terrains.JUNGLE)) {</span>
<span class="nc" id="L2183">                    minElev = Math.max(minElev, hex.terrainLevel(Terrains.FOLIAGE_ELEV) - hex.depth() + 1);</span>
                }
<span class="nc bnc" id="L2185" title="All 2 branches missed.">                if (hex.depth() &gt; 0) {</span>
<span class="nc" id="L2186">                    minElev = Math.max(minElev, 1);</span>
                }
                // Can land on buildings
<span class="nc bnc" id="L2189" title="All 2 branches missed.">                if (hex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L2190">                    minElev = Math.max(minElev, hex.terrainLevel(Terrains.BLDG_ELEV) - hex.depth());</span>
                }
<span class="nc" id="L2192">                minAlt = minElev + hex.surface();</span>
<span class="nc" id="L2193">                break;</span>
            case AERODYNE:
            case SPHEROID:
<span class="nc" id="L2196">                assumedAlt = assumedElevation;</span>
<span class="nc bnc" id="L2197" title="All 2 branches missed.">                if (game.getBoard().inAtmosphere()) {</span>
<span class="nc" id="L2198">                    minAlt = Math.max(0, hex.ceiling(true)) + 1;</span>
<span class="nc bnc" id="L2199" title="All 4 branches missed.">                } else if (game.getBoard().onGround() &amp;&amp; isAirborne()) {</span>
<span class="nc" id="L2200">                    minAlt = 1;</span>
                }
                // if sensors are damaged then, one higher
<span class="nc bnc" id="L2203" title="All 2 branches missed.">                if (isAero()</span>
<span class="nc bnc" id="L2204" title="All 2 branches missed.">                        &amp;&amp; (((IAero)this).getSensorHits() &gt; 0)) {</span>
<span class="nc" id="L2205">                    minAlt++;</span>
                }
                break;
            case INF_UMU:
            	/* non-mechanized SCUBA infantry have a maximum depth of 2 */
<span class="nc bnc" id="L2210" title="All 4 branches missed.">            	if (this instanceof Infantry &amp;&amp; ((Infantry)this).hasSpecialization(Infantry.SCUBA)</span>
<span class="nc bnc" id="L2211" title="All 2 branches missed.">            			&amp;&amp; hex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L2212">            		minAlt = Math.max(hex.floor(), -2);</span>
            	} else {
<span class="nc" id="L2214">            		minAlt = hex.floor();</span>
            	}
<span class="nc" id="L2216">            	break;</span>
            case SUBMARINE:
            case BIPED_SWIM:
            case QUAD_SWIM:
<span class="nc" id="L2220">                minAlt = hex.floor();</span>
<span class="nc" id="L2221">                break;</span>
            case BIPED:
            case QUAD:
<span class="nc bnc" id="L2224" title="All 2 branches missed.">                if (this instanceof Protomech) {</span>
<span class="nc" id="L2225">                    minAlt -= Math</span>
<span class="nc" id="L2226">                            .max(0,</span>
                                 BasementType
<span class="nc" id="L2228">                                         .getType(</span>
<span class="nc" id="L2229">                                                 hex.terrainLevel(Terrains.BLDG_BASEMENT_TYPE))</span>
<span class="nc" id="L2230">                                         .getDepth());</span>
                } else {
<span class="nc" id="L2232">                    return false;</span>
                }
                break;
            default:
<span class="nc" id="L2236">                return false;</span>
        }
<span class="nc bnc" id="L2238" title="All 2 branches missed.">        return (assumedAlt &gt; minAlt);</span>
    }

    /**
     * is it possible to go up, or are we at maximum altitude? assuming passed
     * elevation.
     */
    public boolean canGoUp(int assumedElevation, Coords assumedPos) {
        // Could have a hex off the board
<span class="nc bnc" id="L2247" title="All 2 branches missed.">        if (!getGame().getBoard().contains(assumedPos)) {</span>
<span class="nc" id="L2248">            return false;</span>
        }
<span class="nc" id="L2250">        IHex hex = getGame().getBoard().getHex(assumedPos);</span>
<span class="nc" id="L2251">        int assumedAlt = assumedElevation + hex.surface();</span>
<span class="nc" id="L2252">        int maxAlt = hex.surface();</span>
<span class="nc bnc" id="L2253" title="All 8 branches missed.">        switch (getMovementMode()) {</span>
            case INF_JUMP:
            case INF_LEG:
            case INF_MOTORIZED:
<span class="nc" id="L2257">                maxAlt += Math.max(0, hex.terrainLevel(Terrains.BLDG_ELEV));</span>
<span class="nc" id="L2258">                break;</span>
            case VTOL:
<span class="nc" id="L2260">                maxAlt = hex.surface() + 50;</span>
                // When under a bridge, restrict upward movement
                // &quot;- 1&quot; to correct that height() reports one less than the rules (TW p.99) say
<span class="nc bnc" id="L2263" title="All 2 branches missed.">                if (hex.containsTerrain(Terrains.BRIDGE_ELEV)</span>
<span class="nc bnc" id="L2264" title="All 2 branches missed.">                        &amp;&amp; assumedElevation &lt; hex.terrainLevel(Terrains.BRIDGE_ELEV)) {</span>
<span class="nc" id="L2265">                    maxAlt = hex.terrainLevel(Terrains.BRIDGE_ELEV) - height() - 1;   </span>
                }
                break;
            case AERODYNE:
            case SPHEROID:
<span class="nc bnc" id="L2270" title="All 2 branches missed.">                if (!game.getBoard().inSpace()) {</span>
<span class="nc" id="L2271">                    assumedAlt = assumedElevation;</span>
<span class="nc" id="L2272">                    maxAlt = 10;</span>
                }
                break;
            case SUBMARINE:
<span class="nc" id="L2276">                maxAlt = hex.surface() - getHeight();</span>
<span class="nc" id="L2277">                break;</span>
            case INF_UMU:
            case BIPED_SWIM:
            case QUAD_SWIM:
                // UMU's won't allow the entity to break the surface of the
                // water
<span class="nc" id="L2283">                maxAlt = hex.surface() - (getHeight() + 1);</span>
<span class="nc" id="L2284">                break;</span>
            case WIGE:
<span class="nc bnc" id="L2286" title="All 2 branches missed.">                if (this instanceof LandAirMech) {</span>
<span class="nc bnc" id="L2287" title="All 2 branches missed.">                    if (isAirborne()) {</span>
<span class="nc" id="L2288">                        return false;</span>
                    }
<span class="nc" id="L2290">                    maxAlt = hex.surface() + 25;</span>
<span class="nc bnc" id="L2291" title="All 2 branches missed.">                } else if (this instanceof Protomech) {</span>
<span class="nc" id="L2292">                    maxAlt = hex.surface() + 12;</span>
<span class="nc bnc" id="L2293" title="All 2 branches missed.">                } else if (hex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L2294">                    maxAlt = Math.max(hex.surface(), hex.terrainLevel(Terrains.BLDG_ELEV)) + 1;</span>
                } else {
<span class="nc" id="L2296">                    maxAlt = hex.surface() + 1;</span>
                }
<span class="nc" id="L2298">                break;</span>
            case BIPED:
            case QUAD:
<span class="nc bnc" id="L2301" title="All 2 branches missed.">                if (this instanceof Protomech) {</span>
<span class="nc" id="L2302">                    maxAlt += Math.max(0, hex.terrainLevel(Terrains.BLDG_ELEV));</span>
                } else {
<span class="nc" id="L2304">                    return false;</span>
                }
                break;
            default:
<span class="nc" id="L2308">                return false;</span>
        }
<span class="nc bnc" id="L2310" title="All 2 branches missed.">        return (assumedAlt &lt; maxAlt);</span>
    }

    /**
     * Check if this entity can legally occupy the requested elevation. Does not
     * check stacking, only terrain limitations
     */
    public boolean isElevationValid(int assumedElevation, IHex hex) {
<span class="nc" id="L2318">        int assumedAlt = assumedElevation + hex.surface();</span>
<span class="nc bnc" id="L2319" title="All 2 branches missed.">        if (getMovementMode() == EntityMovementMode.VTOL) {</span>
<span class="nc bnc" id="L2320" title="All 2 branches missed.">            if ((this instanceof Infantry)</span>
<span class="nc bnc" id="L2321" title="All 2 branches missed.">                    &amp;&amp; (hex.containsTerrain(Terrains.BUILDING)</span>
<span class="nc bnc" id="L2322" title="All 2 branches missed.">                            || hex.containsTerrain(Terrains.WOODS) </span>
<span class="nc bnc" id="L2323" title="All 2 branches missed.">                            || hex.containsTerrain(Terrains.JUNGLE))) {</span>
                // VTOL BA (sylph) can move as ground unit as well
<span class="nc bnc" id="L2325" title="All 4 branches missed.">                return ((assumedElevation &lt;= 50) &amp;&amp; (assumedAlt &gt;= hex.floor()));</span>
            } else {
                // VTOLs can be anywhere on or above ground and fly beneath bridges,
                // land on buildings and ignore planted fields and industrial zone 
                // but cannot land on water or trees
                // As always, height() reports one less than the rules (TW p.99) say
                // Units may move under a bridge if their top is 
                // lower than or equal to the bridge height (TW p.62)
<span class="nc bnc" id="L2333" title="All 4 branches missed.">                boolean allowed = (assumedElevation &lt;= 50) &amp;&amp; (assumedElevation &gt;= 0);</span>
<span class="nc bnc" id="L2334" title="All 2 branches missed.">                if (hex.containsTerrain(Terrains.BRIDGE_ELEV)) {</span>
<span class="nc bnc" id="L2335" title="All 2 branches missed.">                    allowed &amp;= (assumedElevation &gt;= hex.terrainLevel(Terrains.BRIDGE_ELEV))</span>
<span class="nc bnc" id="L2336" title="All 2 branches missed.">                            || (assumedElevation + height() + 1 &lt;= hex.terrainLevel(Terrains.BRIDGE_ELEV));</span>
                }
<span class="nc bnc" id="L2338" title="All 2 branches missed.">                if (hex.containsTerrain(Terrains.FOLIAGE_ELEV)) {</span>
<span class="nc bnc" id="L2339" title="All 2 branches missed.">                    allowed &amp;= (assumedElevation &gt; hex.terrainLevel(Terrains.FOLIAGE_ELEV) - hex.depth());</span>
                }
<span class="nc bnc" id="L2341" title="All 2 branches missed.">                if (hex.depth() &gt; 0) {</span>
<span class="nc bnc" id="L2342" title="All 2 branches missed.">                    allowed &amp;= (assumedElevation &gt; 0);</span>
                }
<span class="nc bnc" id="L2344" title="All 2 branches missed.">                if (hex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc bnc" id="L2345" title="All 2 branches missed.">                    allowed &amp;= (assumedElevation &gt;= hex.terrainLevel(Terrains.BLDG_ELEV) - hex.depth());</span>
                }
<span class="nc" id="L2347">                return allowed;</span>
            }
<span class="nc bnc" id="L2349" title="All 2 branches missed.">        } else if ((getMovementMode() == EntityMovementMode.SUBMARINE)</span>
<span class="nc bnc" id="L2350" title="All 2 branches missed.">                   || ((getMovementMode() == EntityMovementMode.INF_UMU) &amp;&amp; hex</span>
<span class="nc bnc" id="L2351" title="All 2 branches missed.">                .containsTerrain(Terrains.WATER))</span>
<span class="nc bnc" id="L2352" title="All 4 branches missed.">                   || ((getMovementMode() == EntityMovementMode.QUAD_SWIM) &amp;&amp; hasUMU())</span>
<span class="nc bnc" id="L2353" title="All 4 branches missed.">                   || ((getMovementMode() == EntityMovementMode.BIPED_SWIM) &amp;&amp; hasUMU())) {</span>
<span class="nc bnc" id="L2354" title="All 4 branches missed.">        	if (this instanceof Infantry &amp;&amp; ((Infantry)this).hasSpecialization(Infantry.SCUBA)</span>
<span class="nc bnc" id="L2355" title="All 2 branches missed.">        			&amp;&amp; getMovementMode() == EntityMovementMode.INF_UMU) {</span>
<span class="nc bnc" id="L2356" title="All 2 branches missed.">        		return assumedAlt &gt;= Math.max(hex.floor(), -2)</span>
<span class="nc bnc" id="L2357" title="All 2 branches missed.">        				&amp;&amp; (assumedAlt &lt;= hex.surface());</span>
        	}
<span class="nc bnc" id="L2359" title="All 4 branches missed.">            return ((assumedAlt &gt;= hex.floor()) &amp;&amp; (assumedAlt &lt;= hex.surface()));</span>
<span class="nc bnc" id="L2360" title="All 2 branches missed.">        } else if ((getMovementMode() == EntityMovementMode.HYDROFOIL)</span>
<span class="nc bnc" id="L2361" title="All 2 branches missed.">                   || (getMovementMode() == EntityMovementMode.NAVAL)) {</span>
<span class="nc bnc" id="L2362" title="All 2 branches missed.">            return assumedAlt == hex.surface();</span>
<span class="nc bnc" id="L2363" title="All 2 branches missed.">        } else if (getMovementMode() == EntityMovementMode.WIGE) {</span>
            // WiGEs can possibly be at any location above or on the surface
<span class="nc bnc" id="L2365" title="All 2 branches missed.">            return (assumedAlt &gt;= hex.floor());</span>
        } else {
            // regular ground units
<span class="nc bnc" id="L2368" title="All 2 branches missed.">            if (hex.containsTerrain(Terrains.ICE)</span>
<span class="nc bnc" id="L2369" title="All 4 branches missed.">                || (((getMovementMode() == EntityMovementMode.HOVER) || hasWorkingMisc(MiscType.F_FULLY_AMPHIBIOUS)) &amp;&amp;</span>
<span class="nc bnc" id="L2370" title="All 2 branches missed.">                        hex.containsTerrain(Terrains.WATER))) {</span>
                // surface of ice is OK, surface of water is OK for hovers and &quot;fully amphibious&quot; units
<span class="nc bnc" id="L2372" title="All 2 branches missed.">                if (assumedAlt == hex.surface()) {</span>
<span class="nc" id="L2373">                    return true;</span>
                }
            }
            // only mechs can move underwater
<span class="nc bnc" id="L2377" title="All 2 branches missed.">            if (hex.containsTerrain(Terrains.WATER)</span>
<span class="nc bnc" id="L2378" title="All 6 branches missed.">                &amp;&amp; (assumedAlt &lt; hex.surface()) &amp;&amp; !(this instanceof Mech)</span>
                &amp;&amp; !(this instanceof Protomech)) {
<span class="nc" id="L2380">                return false;</span>
            }
            // can move on the ground unless its underwater
<span class="nc bnc" id="L2383" title="All 2 branches missed.">            if (assumedAlt == hex.floor()) {</span>
<span class="nc" id="L2384">                return true;</span>
            }

<span class="nc bnc" id="L2387" title="All 2 branches missed.">            if (hex.containsTerrain(Terrains.BRIDGE)) {</span>
                // can move on top of a bridge
<span class="nc bnc" id="L2389" title="All 2 branches missed.">                if (assumedElevation == hex.terrainLevel(Terrains.BRIDGE_ELEV)) {</span>
<span class="nc" id="L2390">                    return true;</span>
                }
            }
<span class="nc bnc" id="L2393" title="All 2 branches missed.">            if (hex.containsTerrain(Terrains.BUILDING)) {</span>
                // Any unit can fall into a basement
<span class="nc bnc" id="L2395" title="All 4 branches missed.">                if ((assumedAlt &lt; 0) &amp;&amp; (hex.depth(true) &gt; 0)) {</span>
<span class="nc" id="L2396">                    return true;</span>
                }
                // Mechs, protos and infantry can occupy any floor in the
                // building
<span class="nc bnc" id="L2400" title="All 6 branches missed.">                if ((this instanceof Mech) || (this instanceof Protomech)</span>
                    || (this instanceof Infantry)) {
<span class="nc bnc" id="L2402" title="All 2 branches missed.">                    if ((assumedAlt &gt;= (hex.surface() - hex.depth(true)))</span>
<span class="nc bnc" id="L2403" title="All 2 branches missed.">                        &amp;&amp; (assumedAlt &lt;= hex.ceiling())) {</span>
<span class="nc" id="L2404">                        return true;</span>
                    }
                }
            }
        }
<span class="nc" id="L2409">        return false;</span>
    }

    /**
     * Returns the height of the unit, that is, how many levels above its
     * elevation it is for LOS purposes. Default is 0.
     */
    public int height() {
<span class="nc" id="L2417">        return 0;</span>
    }

    /**
     * Returns the elevation of the entity's highest point relative to
     * the surface of the hex the entity is in , i.e.
     * relHeight() == getElevation() + getHeight()
     */
    @Override
    public int relHeight() {
<span class="nc" id="L2427">        return getElevation() + height();</span>
    }

    /*
     * Convenience method to determine whether this entity is on a ground map with an atmosphere
     */
    public boolean isOnAtmosphericGroundMap() {
<span class="nc bnc" id="L2434" title="All 2 branches missed.">        return  ((getGame().getPlanetaryConditions().getAtmosphere() != PlanetaryConditions.ATMO_VACUUM) ||</span>
<span class="nc bnc" id="L2435" title="All 2 branches missed.">                (getGame().getPlanetaryConditions().getAtmosphere() != PlanetaryConditions.ATMO_TRACE)) &amp;&amp;</span>

<span class="nc bnc" id="L2437" title="All 2 branches missed.">                (getGame().getBoard().onGround() ||</span>
                // doesn't make sense in english, but &quot;atmospheric&quot; map actually
                // covers maps that are within a planet's gravity well
<span class="nc bnc" id="L2440" title="All 2 branches missed.">                getGame().getBoard().inAtmosphere());</span>
    }

    /**
     * Convenience method to determine whether this entity should be treated as an airborne aero on a ground map.
     * @return True if this is an airborne aircraft on a ground map.
     */
    public boolean isAirborneAeroOnGroundMap() {
<span class="nc bnc" id="L2448" title="All 6 branches missed.">        return isAero() &amp;&amp; isAirborne() &amp;&amp; getGame().getBoard().onGround();</span>
    }

    /**
     * Returns the display name for this entity.
     */
    @Override
    public String getDisplayName() {
<span class="nc bnc" id="L2456" title="All 2 branches missed.">        if (displayName == null) {</span>
<span class="nc" id="L2457">            generateDisplayName();</span>
        }
<span class="nc" id="L2459">        return displayName;</span>
    }

    /**
     * Generates the display name for this entity.
     * &lt;p/&gt;
     * Sub-classes are allowed to override this method. The display name is in
     * the format [Chassis] [Model] ([Player Name]).
     */
    public void generateDisplayName() {
<span class="nc" id="L2469">        StringBuffer nbuf = new StringBuffer();</span>
<span class="nc" id="L2470">        nbuf.append(chassis);</span>
<span class="nc bnc" id="L2471" title="All 4 branches missed.">        if ((model != null) &amp;&amp; (model.length() &gt; 0)) {</span>
<span class="nc" id="L2472">            nbuf.append(&quot; &quot;).append(model);</span>
        }
        // if show unit id is on, append the id
<span class="nc bnc" id="L2475" title="All 2 branches missed.">        if (PreferenceManager.getClientPreferences().getShowUnitId()) {</span>
<span class="nc" id="L2476">            nbuf.append(&quot; ID:&quot;).append(getId());</span>
<span class="nc bnc" id="L2477" title="All 2 branches missed.">        } else if (duplicateMarker &gt; 1) {</span>
            // if not, and a player has more than one unit with the same name,
            // append &quot;#N&quot; after the model to differentiate.
<span class="nc" id="L2480">            nbuf.append(&quot; #&quot; + duplicateMarker);</span>
        }
<span class="nc bnc" id="L2482" title="All 2 branches missed.">        if (getOwner() != null) {</span>
<span class="nc" id="L2483">            nbuf.append(&quot; (&quot;).append(getOwner().getName()).append(&quot;)&quot;);</span>
        }
<span class="nc bnc" id="L2485" title="All 2 branches missed.">        if (PreferenceManager.getClientPreferences().getShowUnitId()) {</span>
<span class="nc" id="L2486">            nbuf.append(&quot; ID:&quot;).append(getId());</span>
        }

<span class="nc" id="L2489">        displayName = nbuf.toString();</span>
<span class="nc" id="L2490">    }</span>

    /**
     * A short name, suitable for displaying above a unit icon. The short name
     * is basically the same as the display name, minus the player name.
     */
    public String getShortName() {
<span class="nc bnc" id="L2497" title="All 2 branches missed.">        if (shortName == null) {</span>
<span class="nc" id="L2498">            generateShortName();</span>
        }
<span class="nc" id="L2500">        return shortName;</span>
    }

    /**
     * Generate the short name for a unit
     * &lt;p/&gt;
     * Sub-classes are allowed to override this method. The display name is in
     * the format [Chassis] [Model].
     */
    public void generateShortName() {
<span class="nc" id="L2510">        StringBuffer nbuf = new StringBuffer();</span>
<span class="nc" id="L2511">        nbuf.append(chassis);</span>
<span class="nc bnc" id="L2512" title="All 4 branches missed.">        if ((model != null) &amp;&amp; (model.length() &gt; 0)) {</span>
<span class="nc" id="L2513">            nbuf.append(&quot; &quot;).append(model);</span>
        }
        // if show unit id is on, append the id
<span class="nc bnc" id="L2516" title="All 2 branches missed.">        if (PreferenceManager.getClientPreferences().getShowUnitId()) {</span>
<span class="nc" id="L2517">            nbuf.append(&quot; ID:&quot;).append(getId());</span>
<span class="nc bnc" id="L2518" title="All 2 branches missed.">        } else if (duplicateMarker &gt; 1) {</span>
            // if not, and a player has more than one unit with the same name,
            // append &quot;#N&quot; after the model to differentiate.
<span class="nc" id="L2521">            nbuf.append(&quot; #&quot; + duplicateMarker);</span>
        }

<span class="nc" id="L2524">        shortName = nbuf.toString();</span>
<span class="nc" id="L2525">    }</span>

    public String getShortNameRaw() {
<span class="nc" id="L2528">        StringBuffer nbuf = new StringBuffer();</span>
<span class="nc" id="L2529">        nbuf.append(chassis);</span>
<span class="nc bnc" id="L2530" title="All 4 branches missed.">        if ((model != null) &amp;&amp; (model.length() &gt; 0)) {</span>
<span class="nc" id="L2531">            nbuf.append(&quot; &quot;).append(model);</span>
        }
<span class="nc" id="L2533">        return nbuf.toString();</span>
    }

    /**
     * Returns the primary facing, or -1 if n/a
     */
    public int getFacing() {
<span class="nc bnc" id="L2540" title="All 2 branches missed.">        if (Entity.NONE != conveyance) {</span>
<span class="nc" id="L2541">            Entity transporter = game.getEntity(conveyance);</span>
<span class="nc bnc" id="L2542" title="All 2 branches missed.">            if (transporter == null) {</span>
<span class="nc" id="L2543">                transporter = game.getOutOfGameEntity(conveyance);</span>
            }
<span class="nc" id="L2545">            return transporter.getFacing();</span>
        }
<span class="nc" id="L2547">        return facing;</span>
    }

    /**
     * Sets the primary facing.
     */
    public void setFacing(int facing) {
<span class="nc" id="L2554">        this.facing = facing;</span>
<span class="nc bnc" id="L2555" title="All 2 branches missed.">        if (game != null) {</span>
<span class="nc" id="L2556">            game.processGameEvent(new GameEntityChangeEvent(this, this));</span>
        }
<span class="nc" id="L2558">    }</span>

    /**
     * Returns the secondary facing, or -1 if n/a
     */
    public int getSecondaryFacing() {
<span class="nc" id="L2564">        return sec_facing;</span>
    }

    public void setSecondaryFacing(int sec_facing) {
<span class="nc" id="L2568">        setSecondaryFacing(sec_facing, true);</span>
<span class="nc" id="L2569">    }</span>
    
    /**
     * Sets the secondary facing. 
     * Optionally does not fire a game change event (useful for bot evaluation)
     */
    public void setSecondaryFacing(int sec_facing, boolean fireEvent) {
<span class="nc" id="L2576">        this.sec_facing = sec_facing;</span>
<span class="nc bnc" id="L2577" title="All 4 branches missed.">        if (fireEvent &amp;&amp; (game != null)) {</span>
<span class="nc" id="L2578">            game.processGameEvent(new GameEntityChangeEvent(this, this));</span>
        }
<span class="nc" id="L2580">    }</span>
    
    /**
     * Utility function that handles situations where a facing change
     * imparts some kind of permanent effect to the entity.
     */
    public void postProcessFacingChange() {
    	
<span class="nc" id="L2588">    }</span>

    /**
     * Can this entity change secondary facing at all?
     */
    public abstract boolean canChangeSecondaryFacing();

    /**
     * Can this entity torso/turret twist the given direction?
     */
    public abstract boolean isValidSecondaryFacing(int dir);

    /**
     * Returns the closest valid secondary facing to the given direction.
     *
     * @return the the closest valid secondary facing.
     */
    public abstract int clipSecondaryFacing(int dir);

    /**
     * Returns true if the entity has an RAC which is jammed and not destroyed
     * As of 5/22/2012 also returns true if there is a jammed and not destroyed
     * Ultra AC and the unofficial options is enabled.  Jammed ACs and LACs can
     * also be unjammed if rapid-fire ACs is turned on.
     */
    public boolean canUnjamRAC() {
<span class="nc bnc" id="L2614" title="All 2 branches missed.">        for (Mounted mounted : getTotalWeaponList()) {</span>
<span class="nc" id="L2615">            WeaponType wtype = (WeaponType) mounted.getType();</span>
<span class="nc bnc" id="L2616" title="All 2 branches missed.">            if ((wtype.getAmmoType() == AmmoType.T_AC_ROTARY)</span>
<span class="nc bnc" id="L2617" title="All 4 branches missed.">                &amp;&amp; mounted.isJammed() &amp;&amp; !mounted.isDestroyed()) {</span>
<span class="nc" id="L2618">                return true;</span>
            }
<span class="nc bnc" id="L2620" title="All 2 branches missed.">            if (((wtype.getAmmoType() == AmmoType.T_AC_ULTRA)</span>
<span class="nc bnc" id="L2621" title="All 2 branches missed.">                 || (wtype.getAmmoType() == AmmoType.T_AC_ULTRA_THB)</span>
<span class="nc bnc" id="L2622" title="All 2 branches missed.">                 || (wtype.getAmmoType() == AmmoType.T_AC)</span>
<span class="nc bnc" id="L2623" title="All 2 branches missed.">                 || (wtype.getAmmoType() == AmmoType.T_LAC)</span>
<span class="nc bnc" id="L2624" title="All 2 branches missed.">                 || (wtype.getAmmoType() == AmmoType.T_AC_IMP)</span>
<span class="nc bnc" id="L2625" title="All 2 branches missed.">                 || (wtype.getAmmoType() == AmmoType.T_PAC))</span>
<span class="nc bnc" id="L2626" title="All 2 branches missed.">                &amp;&amp; mounted.isJammed()</span>
<span class="nc bnc" id="L2627" title="All 2 branches missed.">                &amp;&amp; !mounted.isDestroyed()</span>
<span class="nc bnc" id="L2628" title="All 2 branches missed.">                &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_UNJAM_UAC)) {</span>
<span class="nc" id="L2629">                return true;</span>
            }
<span class="nc" id="L2631">        }</span>
<span class="nc" id="L2632">        return false;</span>
    }

    /**
     * Returns true if the entity can flip its arms
     */
    public boolean canFlipArms() {
<span class="nc" id="L2639">        return false;</span>
    }

    /**
     * Returns this entity's original walking movement points
     */
    public int getOriginalWalkMP() {
<span class="nc" id="L2646">        return walkMP;</span>
    }

    /**
     * Sets this entity's original walking movement points
     */
    public void setOriginalWalkMP(int walkMP) {
<span class="nc" id="L2653">        this.walkMP = walkMP;</span>
<span class="nc" id="L2654">    }</span>

    /**
     * Returns this entity's walking/cruising mp, factored for heat and gravity.
     */

    public int getWalkMP() {
<span class="nc" id="L2661">        return getWalkMP(true, false);</span>
    }

    /**
     * Returns this entity's walking/cruising mp, factored for heat and possibly
     * gravity.
     *
     * @param gravity    Should the movement be factored for gravity
     * @param ignoreheat Should heat be ignored?
     */
    public int getWalkMP(boolean gravity, boolean ignoreheat) {
<span class="nc" id="L2672">        return getWalkMP(gravity, ignoreheat, false);</span>
    }

    public int getWalkMP(boolean gravity, boolean ignoreheat,
                         boolean ignoremodulararmor) {
<span class="nc" id="L2677">        int mp = getOriginalWalkMP();</span>

<span class="nc bnc" id="L2679" title="All 2 branches missed.">        if (!ignoreheat) {</span>
<span class="nc" id="L2680">            mp = Math.max(0, mp - getHeatMPReduction());</span>
        }
<span class="nc" id="L2682">        mp = Math.max(mp - getCargoMpReduction(this), 0);</span>
<span class="nc bnc" id="L2683" title="All 2 branches missed.">        if (null != game) {</span>
<span class="nc" id="L2684">            int weatherMod = game.getPlanetaryConditions()</span>
<span class="nc" id="L2685">                                 .getMovementMods(this);</span>
<span class="nc bnc" id="L2686" title="All 2 branches missed.">            if (weatherMod != 0) {</span>
<span class="nc" id="L2687">                mp = Math.max(mp + weatherMod, 0);</span>
            }
        }
<span class="nc bnc" id="L2690" title="All 2 branches missed.">        if (gravity) {</span>
<span class="nc" id="L2691">            mp = applyGravityEffectsOnMP(mp);</span>
        }
<span class="nc" id="L2693">        return mp;</span>
    }

    /**
     * This returns how much MP is removed due to heat
     *
     * @return
     */
    public int getHeatMPReduction() {
        int minus;

<span class="nc bnc" id="L2704" title="All 4 branches missed.">        if ((game != null) &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_HEAT)) {</span>
<span class="nc bnc" id="L2705" title="All 2 branches missed.">            if (heat &lt; 30) {</span>
<span class="nc" id="L2706">                minus = (heat / 5);</span>
<span class="nc bnc" id="L2707" title="All 2 branches missed.">            } else if (heat &gt;= 49) {</span>
<span class="nc" id="L2708">                minus = 9;</span>
<span class="nc bnc" id="L2709" title="All 2 branches missed.">            } else if (heat &gt;= 43) {</span>
<span class="nc" id="L2710">                minus = 8;</span>
<span class="nc bnc" id="L2711" title="All 2 branches missed.">            } else if (heat &gt;= 37) {</span>
<span class="nc" id="L2712">                minus = 7;</span>
<span class="nc bnc" id="L2713" title="All 2 branches missed.">            } else if (heat &gt;= 31) {</span>
<span class="nc" id="L2714">                minus = 6;</span>
            } else {
<span class="nc" id="L2716">                minus = 5;</span>
            }
        } else {
<span class="nc" id="L2719">            minus = heat / 5;</span>
        }

<span class="nc" id="L2722">        return minus;</span>
    }

    /**
     * get the heat generated by this Entity when standing still
     */
    public int getStandingHeat() {
<span class="nc" id="L2729">        return 0;</span>
    }

    /**
     * get the heat generated by this Entity when walking/cruising
     */
    public int getWalkHeat() {
<span class="nc" id="L2736">        return 0;</span>
    }

    /**
     * Returns this entity's unmodified running/flank mp.
     */
    public int getOriginalRunMP() {
<span class="nc" id="L2743">        return (int) Math.ceil(getOriginalWalkMP() * 1.5);</span>
    }

    /**
     * Returns this entity's running/flank mp modified for heat and gravity.
     */
    public int getRunMP() {
<span class="nc" id="L2750">        return getRunMP(true, false, false);</span>
    }

    public int getRunMP(boolean gravity, boolean ignoreheat,
                        boolean ignoremodulararmor) {
<span class="nc" id="L2755">        return (int) Math.ceil(getWalkMP(gravity, ignoreheat,</span>
                                         ignoremodulararmor) * 1.5);
    }

    /**
     * Returns run MP without considering MASC
     */
    public int getRunMPwithoutMASC() {
<span class="nc" id="L2763">        return getRunMPwithoutMASC(true, false, false);</span>
    }

    /**
     * Returns run MP without considering MASC, optionally figuring in gravity
     * and possibly ignoring heat
     */
    public abstract int getRunMPwithoutMASC(boolean gravity,
                                            boolean ignoreheat, boolean ignoremodulararmor);

    /**
     * Returns this entity's running/flank mp as a string.
     */
    public String getRunMPasString() {
<span class="nc" id="L2777">        return Integer.toString(getRunMP());</span>
    }

    /**
     * get the heat generated by this Entity when running/flanking
     */
    public int getRunHeat() {
<span class="nc" id="L2784">        return 0;</span>
    }

    /**
     * Returns this entity's unmodified sprint mp.
     */
    protected int getOriginalSprintMP() {
<span class="nc" id="L2791">        return getOriginalRunMP();</span>
    }

    /**
     * Returns this entity's running/flank mp modified for heat and gravity.
     */
    public int getSprintMP() {
<span class="nc" id="L2798">        return getRunMP();</span>
    }

    public int getSprintMP(boolean gravity, boolean ignoreheat,
                           boolean ignoremodulararmor) {
<span class="nc" id="L2803">        return getRunMP(gravity, ignoreheat, ignoremodulararmor);</span>
    }

    /**
     * Returns sprint MP without considering MASC
     */
    public int getSprintMPwithoutMASC() {
<span class="nc" id="L2810">        return getRunMPwithoutMASC();</span>
    }

    /**
     * Returns sprint MP without considering MASC, optionally figuring in
     * gravity and possibly ignoring heat
     */
    public int getSprintMPwithoutMASC(boolean gravity, boolean ignoreheat,
                                      boolean ignoremodulararmor) {
<span class="nc" id="L2819">        return getRunMPwithoutMASC(gravity, ignoreheat, ignoremodulararmor);</span>
    }

    /**
     * Returns this entity's sprint mp as a string.
     */
    public String getSprintMPasString() {
<span class="nc" id="L2826">        return Integer.toString(getSprintMP());</span>
    }

    /**
     * get the heat generated by this Entity when sprinting
     */
    public int getSprintHeat() {
<span class="nc" id="L2833">        return 3;</span>
    }

    /**
     * get the gravity limit for ground movement
     */
    public int getRunningGravityLimit() {
<span class="nc" id="L2840">        return getRunMP(false, false, false);</span>
    }

    /**
     * Returns this entity's original jumping mp.
     */
    public int getOriginalJumpMP() {
<span class="nc" id="L2847">    	return getOriginalJumpMP(false);</span>
    }

    public int getOriginalJumpMP(boolean ignoreModularArmor) {

<span class="nc bnc" id="L2852" title="All 4 branches missed.">        if (!ignoreModularArmor &amp;&amp; hasModularArmor()) {</span>
<span class="nc" id="L2853">            return Math.max(0, jumpMP - 1);</span>
        }

<span class="nc" id="L2856">        return jumpMP;</span>
    }

    /**
     * Sets this entity's original jump movement points
     */
    public void setOriginalJumpMP(int jumpMP) {
<span class="nc" id="L2863">        this.jumpMP = jumpMP;</span>
<span class="nc" id="L2864">    }</span>

    /**
     * Returns this entity's current jumping MP, not affected by terrain,
     * factored for gravity.
     */
    public int getJumpMP() {
<span class="nc" id="L2871">        return getJumpMP(true);</span>
    }

    /**
     * return this entity's current jump MP, possibly affected by gravity
     *
     * @param gravity
     * @return
     */
    public int getJumpMP(boolean gravity) {
<span class="nc bnc" id="L2881" title="All 2 branches missed.">        if (gravity) {</span>
<span class="nc" id="L2882">            return applyGravityEffectsOnMP(getOriginalJumpMP());</span>
        }
<span class="nc" id="L2884">        return getOriginalJumpMP();</span>
    }

    public int getJumpType() {
<span class="nc" id="L2888">        return 0;</span>
    }

    /**
     * get the heat generated by this Entity when jumping for a certain amount
     * of MP
     *
     * @param movedMP the number of movement points spent
     */
    public int getJumpHeat(int movedMP) {
<span class="nc" id="L2898">        return 0;</span>
    }

    /**
     * Returns this entity's current jumping MP, affected by terrain (like
     * water.)
     */
    public int getJumpMPWithTerrain() {
<span class="nc" id="L2906">        return getJumpMP();</span>
    }

    /**
     * Tanks and certain other units can get a +1 bonus to MP if their move is entirely on pavement.
     *
     * @return true if the &lt;code&gt;Entity&lt;/code&gt; gets a movement bonus on pavement
     */
    public boolean isEligibleForPavementBonus() {
<span class="nc" id="L2915">        return false;</span>
    }

    /**
     * Returns the absolute elevation above ground level 0 that this entity
     * would be on if it were placed into the specified hex.
     * Hovercraft, naval vessels, and hydrofoils move on the
     * surface of the water
     */
    public int elevationOccupied(IHex hex) {
<span class="nc" id="L2925">        return elevationOccupied(hex, getElevation());</span>
    }

    public int elevationOccupied(IHex hex, int elevation) {
<span class="nc bnc" id="L2929" title="All 2 branches missed.">        if (hex == null) {</span>
<span class="nc" id="L2930">            return 0;</span>
        }
<span class="nc bnc" id="L2932" title="All 4 branches missed.">        if ((movementMode == EntityMovementMode.VTOL)</span>
            || (movementMode == EntityMovementMode.WIGE)) {
<span class="nc" id="L2934">            return hex.surface() + elevation;</span>
<span class="nc bnc" id="L2935" title="All 6 branches missed.">        } else if (((movementMode == EntityMovementMode.HOVER)</span>
                    || (movementMode == EntityMovementMode.NAVAL)
                    || (movementMode == EntityMovementMode.HYDROFOIL)
<span class="nc bnc" id="L2938" title="All 2 branches missed.">                    || hex.containsTerrain(Terrains.ICE))</span>
<span class="nc bnc" id="L2939" title="All 2 branches missed.">                   &amp;&amp; hex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L2940">            return hex.surface();</span>
        } else {
<span class="nc" id="L2942">            return hex.floor();</span>
        }
    }

    /**
     * Returns true if the specified hex contains some sort of prohibited
     * terrain.
     */
    public boolean isLocationProhibited(Coords c) {
<span class="nc" id="L2951">        return isLocationProhibited(c, elevation);</span>
    }

    /**
     * Returns true if the specified hex contains some sort of prohibited
     * terrain if the Entity is at the specified elevation.  Elevation generally
     * only matters for units like WiGEs or VTOLs.
     *
     * @param c
     * @param currElevation
     * @return
     */
    public boolean isLocationProhibited(Coords c, int currElevation) {
<span class="nc" id="L2964">        IHex hex = game.getBoard().getHex(c);</span>
<span class="nc bnc" id="L2965" title="All 2 branches missed.">        if (hex.containsTerrain(Terrains.IMPASSABLE)) {</span>
<span class="nc bnc" id="L2966" title="All 2 branches missed.">            return !isAirborne();</span>
        }

<span class="nc bnc" id="L2969" title="All 4 branches missed.">        if (hex.containsTerrain(Terrains.SPACE) &amp;&amp; doomedInSpace()) {</span>
<span class="nc" id="L2970">            return true;</span>
        }

        // Additional restrictions for hidden units
<span class="nc bnc" id="L2974" title="All 2 branches missed.">        if (isHidden()) {</span>
            // Can't deploy in paved hexes
<span class="nc bnc" id="L2976" title="All 2 branches missed.">            if (hex.containsTerrain(Terrains.PAVEMENT)</span>
<span class="nc bnc" id="L2977" title="All 2 branches missed.">                    || hex.containsTerrain(Terrains.ROAD)) {</span>
<span class="nc" id="L2978">                return true;</span>
            }
            // Can't deploy on a bridge
<span class="nc bnc" id="L2981" title="All 2 branches missed.">            if ((hex.terrainLevel(Terrains.BRIDGE_ELEV) == currElevation)</span>
<span class="nc bnc" id="L2982" title="All 2 branches missed.">                    &amp;&amp; hex.containsTerrain(Terrains.BRIDGE)) {</span>
<span class="nc" id="L2983">                return true;</span>
            }
            // Can't deploy on the surface of water
<span class="nc bnc" id="L2986" title="All 4 branches missed.">            if (hex.containsTerrain(Terrains.WATER) &amp;&amp; (currElevation == 0)) {</span>
<span class="nc" id="L2987">                return true;</span>
            }
        }

<span class="nc" id="L2991">        return false;</span>
    }

    /**
     * Returns true if the the given board is prohibited
     */
    public boolean isBoardProhibited(int mapType) {

<span class="nc bnc" id="L2999" title="All 4 branches missed.">        if ((mapType == Board.T_GROUND) &amp;&amp; doomedOnGround()) {</span>
<span class="nc" id="L3000">            return true;</span>
        }

<span class="nc bnc" id="L3003" title="All 4 branches missed.">        if ((mapType == Board.T_ATMOSPHERE) &amp;&amp; doomedInAtmosphere()) {</span>
<span class="nc" id="L3004">            return true;</span>
        }

<span class="nc bnc" id="L3007" title="All 4 branches missed.">        if ((mapType == Board.T_SPACE) &amp;&amp; doomedInSpace()) {</span>
<span class="nc" id="L3008">            return true;</span>
        }

<span class="nc" id="L3011">        return false;</span>
    }

    /**
     * Returns the name of the type of movement used.
     */
    public abstract String getMovementString(EntityMovementType mtype);

    /**
     * Returns the abbreviation of the name of the type of movement used.
     */
    public abstract String getMovementAbbr(EntityMovementType mtype);

    /**
     * Returns the name of the location specified.
     */
    public String getLocationName(HitData hit) {
<span class="nc" id="L3028">        return getLocationName(hit.getLocation());</span>
    }

    public abstract String[] getLocationNames();

    /**
     * Returns the name of the location specified.
     */
    public String getLocationName(int loc) {
<span class="nc" id="L3037">        String[] locationNames = getLocationNames();</span>

<span class="nc bnc" id="L3039" title="All 4 branches missed.">        if ((null == locationNames) || (loc &gt;= locationNames.length)) {</span>
<span class="nc" id="L3040">            return &quot;&quot;;</span>
        }

<span class="nc bnc" id="L3043" title="All 2 branches missed.">        if (loc &lt; 0) {</span>
<span class="nc" id="L3044">            return &quot;None&quot;;</span>
        }

<span class="nc" id="L3047">        return locationNames[loc];</span>
    }

    public abstract String[] getLocationAbbrs();

    /**
     * Returns the abbreviated name of the location specified.
     */
    public String getLocationAbbr(HitData hit) {
<span class="nc" id="L3056">        return getLocationAbbr(hit.getLocation())</span>
<span class="nc bnc" id="L3057" title="All 4 branches missed.">               + (hit.isRear() &amp;&amp; hasRearArmor(hit.getLocation()) ? &quot;R&quot; : &quot;&quot;)</span>
<span class="nc bnc" id="L3058" title="All 2 branches missed.">               + (((hit.getEffect() &amp; HitData.EFFECT_CRITICAL) == HitData.EFFECT_CRITICAL) ? &quot; (critical)&quot;</span>
<span class="nc" id="L3059">                                                                                           : &quot;&quot;);</span>
    }

    /**
     * Returns the abbreviated name of the location specified.
     */
    public String getLocationAbbr(int loc) {
<span class="nc" id="L3066">        String[] locationAbbrs = getLocationAbbrs();</span>

<span class="nc bnc" id="L3068" title="All 4 branches missed.">        if ((null == locationAbbrs) || (loc &gt;= locationAbbrs.length)) {</span>
<span class="nc" id="L3069">            return &quot;&quot;;</span>
        }
<span class="nc bnc" id="L3071" title="All 2 branches missed.">        if (loc == Entity.LOC_NONE) {</span>
<span class="nc" id="L3072">            return &quot;None&quot;;</span>
        }
<span class="nc" id="L3074">        return locationAbbrs[loc];</span>
    }

    /**
     * Returns the location that the specified abbreviation indicates
     */
    public int getLocationFromAbbr(String abbr) {
<span class="nc bnc" id="L3081" title="All 2 branches missed.">        for (int i = 0; i &lt; locations(); i++) {</span>
<span class="nc bnc" id="L3082" title="All 2 branches missed.">            if (getLocationAbbr(i).equalsIgnoreCase(abbr)) {</span>
<span class="nc" id="L3083">                return i;</span>
            }
        }
<span class="nc" id="L3086">        return Entity.LOC_NONE;</span>
    }

    /**
     * Rolls the to-hit number
     */
    public abstract HitData rollHitLocation(int table, int side,
                                            int aimedLocation, int aimingMode, int cover);

    /**
     * Rolls up a hit location
     */
    public abstract HitData rollHitLocation(int table, int side);

    /**
     * Gets the location that excess damage transfers to. That is, one location
     * inwards.
     */
    public abstract HitData getTransferLocation(HitData hit);

    /**
     * int version
     */
    public int getTransferLocation(int loc) {
<span class="nc" id="L3110">        return getTransferLocation(new HitData(loc)).getLocation();</span>
    }

    /**
     * Gets the location that is destroyed recursively. That is, one location
     * outwards.
     */
    public abstract int getDependentLocation(int loc);

    /**
     * Does this location have rear armor?
     */
    public abstract boolean hasRearArmor(int loc);

    /**
     * Returns the amount of armor in the location specified, or ARMOR_NA, or
     * ARMOR_DESTROYED. Only works on front locations.
     */
    public int getArmor(int loc) {
<span class="nc" id="L3129">        return getArmor(loc, false);</span>
    }

    /**
     * Returns the amount of armor in the location hit, or IArmorState.ARMOR_NA,
     * or IArmorState.ARMOR_DESTROYED.
     */
    public int getArmor(HitData hit) {
<span class="nc" id="L3137">        return getArmor(hit.getLocation(), hit.isRear());</span>
    }

    /**
     * Returns the amount of armor in the location specified, or
     * IArmorState.ARMOR_NA, or IArmorState.ARMOR_DESTROYED.
     */
    public int getArmor(int loc, boolean rear) {
<span class="nc bnc" id="L3145" title="All 2 branches missed.">        if (loc &gt;= armor.length) {</span>
<span class="nc" id="L3146">            return IArmorState.ARMOR_NA;</span>
        }
<span class="nc" id="L3148">        return getArmorForReal(loc, rear);</span>
    }

    public int getArmorForReal(int loc, boolean rear) {
<span class="nc" id="L3152">        return armor[loc];</span>
    }

    public int getArmorForReal(int loc) {
<span class="nc" id="L3156">        return getArmorForReal(loc, false);</span>
    }

    /**
     * Returns the original amount of armor in the location specified. Only
     * works on front locations.
     */
    public int getOArmor(int loc) {
<span class="nc" id="L3164">        return getOArmor(loc, false);</span>
    }

    /**
     * Returns the original amount of armor in the location hit.
     */
    public int getOArmor(HitData hit) {
<span class="nc" id="L3171">        return getOArmor(hit.getLocation(), hit.isRear());</span>
    }

    /**
     * Returns the original amount of armor in the location specified, or
     * ARMOR_NA, or ARMOR_DESTROYED.
     *
     * @param loc  the location to check.
     * @param rear if true inspect the rear armor, else check the front.
     */
    public int getOArmor(int loc, boolean rear) {
<span class="nc" id="L3182">        return orig_armor[loc];</span>
    }

    /**
     * Sets the amount of armor in the location specified.
     */
    public void setArmor(int val, HitData hit) {
<span class="nc" id="L3189">        setArmor(val, hit.getLocation(), hit.isRear());</span>
<span class="nc" id="L3190">    }</span>

    /**
     * Sets the amount of armor in the front location specified.
     */
    public void setArmor(int val, int loc) {
<span class="nc" id="L3196">        setArmor(val, loc, false);</span>
<span class="nc" id="L3197">    }</span>

    /**
     * Sets the amount of armor in the location specified.
     *
     * @param val  the value of the armor (eg how many armor points)
     * @param loc  the location of the armor
     * @param rear true iff the armor is rear mounted.
     */
    public void setArmor(int val, int loc, boolean rear) {
<span class="nc" id="L3207">        armor[loc] = val;</span>
<span class="nc" id="L3208">    }</span>

    public void refreshLocations() {
<span class="nc" id="L3211">        armor = new int[locations()];</span>
<span class="nc" id="L3212">        internal = new int[locations()];</span>
<span class="nc" id="L3213">        orig_armor = new int[locations()];</span>
<span class="nc" id="L3214">        orig_internal = new int[locations()];</span>
<span class="nc" id="L3215">        crits = new CriticalSlot[locations()][];</span>
<span class="nc" id="L3216">        exposure = new int[locations()];</span>
<span class="nc bnc" id="L3217" title="All 2 branches missed.">        for (int i = 0; i &lt; locations(); i++) {</span>
<span class="nc" id="L3218">            crits[i] = new CriticalSlot[getNumberOfCriticals(i)];</span>
        }
<span class="nc" id="L3220">    }</span>

    /**
     * @return The index of the first armored location (skipping vehicle body, et. al.)
     */
    public int firstArmorIndex() {
<span class="nc" id="L3226">        return 0;</span>
    }

    /**
     * Initializes the armor on the unit. Sets the original and starting point
     * of the armor to the same number.
     */
    public void initializeArmor(int val, int loc) {
<span class="nc" id="L3234">        orig_armor[loc] = val;</span>
<span class="nc" id="L3235">        setArmor(val, loc);</span>
<span class="nc" id="L3236">    }</span>

    /**
     * Returns the total amount of armor on the entity.
     */
    public int getTotalArmor() {
<span class="nc" id="L3242">        int totalArmor = 0;</span>
<span class="nc bnc" id="L3243" title="All 2 branches missed.">        for (int i = 0; i &lt; locations(); i++) {</span>
<span class="nc bnc" id="L3244" title="All 2 branches missed.">            if (getArmor(i) &gt; 0) {</span>
<span class="nc" id="L3245">                totalArmor += getArmor(i);</span>
            }
<span class="nc bnc" id="L3247" title="All 4 branches missed.">            if (hasRearArmor(i) &amp;&amp; (getArmor(i, true) &gt; 0)) {</span>
<span class="nc" id="L3248">                totalArmor += getArmor(i, true);</span>
            }
        }
<span class="nc" id="L3251">        return totalArmor;</span>
    }

    /**
     * Returns the total amount of armor on the entity.
     */
    public int getTotalOArmor() {
<span class="nc" id="L3258">        int totalArmor = 0;</span>
<span class="nc bnc" id="L3259" title="All 2 branches missed.">        for (int i = 0; i &lt; locations(); i++) {</span>
<span class="nc bnc" id="L3260" title="All 2 branches missed.">            if (getOArmor(i) &gt; 0) {</span>
<span class="nc" id="L3261">                totalArmor += getOArmor(i);</span>
            }
<span class="nc bnc" id="L3263" title="All 4 branches missed.">            if (hasRearArmor(i) &amp;&amp; (getOArmor(i, true) &gt; 0)) {</span>
<span class="nc" id="L3264">                totalArmor += getOArmor(i, true);</span>
            }
        }
<span class="nc" id="L3267">        return totalArmor;</span>
    }

    /**
     * Returns the percent of the armor remaining
     */
    public double getArmorRemainingPercent() {
<span class="nc bnc" id="L3274" title="All 2 branches missed.">        if (getTotalOArmor() == 0) {</span>
<span class="nc" id="L3275">            return IArmorState.ARMOR_NA;</span>
        }
<span class="nc" id="L3277">        return ((double) getTotalArmor() / (double) getTotalOArmor());</span>
    }

    /**
     * Returns the amount of internal structure in the location hit.
     */
    public int getInternal(HitData hit) {
<span class="nc" id="L3284">        return getInternal(hit.getLocation());</span>
    }

    /**
     * Returns the amount of internal structure in the location specified, or
     * ARMOR_NA, or ARMOR_DESTROYED.
     */
    public int getInternal(int loc) {
<span class="nc" id="L3292">        return getInternalForReal(loc);</span>
    }

    public int getInternalForReal(int loc) {
<span class="nc bnc" id="L3296" title="All 4 branches missed.">        if ((this instanceof GunEmplacement) &amp;&amp; (loc == Tank.LOC_TURRET)) {</span>
<span class="nc" id="L3297">            return Tank.LOC_TURRET;</span>
        }
<span class="nc" id="L3299">        return internal[loc];</span>
    }

    /**
     * Returns the original amount of internal structure in the location hit.
     */
    public int getOInternal(HitData hit) {
<span class="nc" id="L3306">        return getOInternal(hit.getLocation());</span>
    }

    /**
     * Returns the original amount of internal structure in the location
     * specified, or ARMOR_NA, or ARMOR_DESTROYED.
     */
    public int getOInternal(int loc) {
<span class="nc" id="L3314">        return orig_internal[loc];</span>
    }

    /**
     * Sets the amount of armor in the location specified.
     */
    public void setInternal(int val, HitData hit) {
<span class="nc" id="L3321">        setInternal(val, hit.getLocation());</span>
<span class="nc" id="L3322">    }</span>

    /**
     * Sets the amount of armor in the location specified.
     */
    public void setInternal(int val, int loc) {
<span class="nc" id="L3328">        internal[loc] = val;</span>
<span class="nc" id="L3329">    }</span>

    /**
     * Initializes the internal structure on the unit. Sets the original and
     * starting point of the internal structure to the same number.
     */
    public void initializeInternal(int val, int loc) {
<span class="nc" id="L3336">        orig_internal[loc] = val;</span>
<span class="nc" id="L3337">        setInternal(val, loc);</span>
<span class="nc" id="L3338">    }</span>

    /**
     * Set the internal structure to the appropriate value for the mech's weight
     * class
     */
    public abstract void autoSetInternal();

    /**
     * Returns the total amount of internal structure on the entity.
     */
    public int getTotalInternal() {
<span class="nc" id="L3350">        int totalInternal = 0;</span>
<span class="nc bnc" id="L3351" title="All 2 branches missed.">        for (int i = 0; i &lt; locations(); i++) {</span>
<span class="nc bnc" id="L3352" title="All 2 branches missed.">            if (getInternal(i) &gt; 0) {</span>
<span class="nc" id="L3353">                totalInternal += getInternal(i);</span>
            }
        }
<span class="nc" id="L3356">        return totalInternal;</span>
    }

    /**
     * Returns the total original amount of internal structure on the entity.
     */
    public int getTotalOInternal() {
<span class="nc" id="L3363">        int totalInternal = 0;</span>
<span class="nc bnc" id="L3364" title="All 2 branches missed.">        for (int i = 0; i &lt; locations(); i++) {</span>
<span class="nc bnc" id="L3365" title="All 2 branches missed.">            if (getOInternal(i) &gt; 0) {</span>
<span class="nc" id="L3366">                totalInternal += getOInternal(i);</span>
            }
        }
<span class="nc" id="L3369">        return totalInternal;</span>
    }

    /**
     * Returns the percent of the armor remaining
     */
    public double getInternalRemainingPercent() {
<span class="nc" id="L3376">        return ((double) getTotalInternal() / (double) getTotalOInternal());</span>
    }

    /**
     * Is this location destroyed or breached?
     */
    public boolean isLocationBad(int loc) {
<span class="nc bnc" id="L3383" title="All 2 branches missed.">        return (getInternal(loc) == IArmorState.ARMOR_DESTROYED)</span>
<span class="nc bnc" id="L3384" title="All 4 branches missed.">               || (isLocationBlownOff(loc) &amp;&amp; !isLocationBlownOffThisPhase(loc));</span>
    }

    public boolean isLocationTrulyDestroyed(int loc) {
<span class="nc bnc" id="L3388" title="All 2 branches missed.">        return internal[loc] == IArmorState.ARMOR_DESTROYED;</span>
    }

    /**
     * Is this location destroyed or breached?
     */
    public boolean isLocationDoomed(int loc) {
<span class="nc bnc" id="L3395" title="All 2 branches missed.">        return (getInternal(loc) == IArmorState.ARMOR_DOOMED)</span>
<span class="nc bnc" id="L3396" title="All 2 branches missed.">               || isLocationBlownOff(loc);</span>
    }

    /**
     * returns exposure or breached flag for location
     */
    public int getLocationStatus(int loc) {
<span class="nc" id="L3403">        return exposure[loc];</span>
    }

    /**
     * sets location exposure
     *
     * @param loc    the location who's exposure is to be set
     * @param status the status to set
     */
    public void setLocationStatus(int loc, int status) {
<span class="nc" id="L3413">        setLocationStatus(loc, status, false);</span>
<span class="nc" id="L3414">    }</span>

    /**
     * sets location exposure
     *
     * @param loc         the location who's exposure is to be set
     * @param status      the status to set
     * @param allowChange allow change of breached locations
     */
    public void setLocationStatus(int loc, int status, boolean allowChange) {
<span class="nc bnc" id="L3424" title="All 4 branches missed.">        if (allowChange || (exposure[loc] &gt; ILocationExposureStatus.BREACHED)) { // can't change BREACHED status</span>
<span class="nc" id="L3425">            exposure[loc] = status;</span>
        }
<span class="nc" id="L3427">    }</span>

    /**
     * Returns true is the location is a leg
     *
     * @param loc the location to check.
     */
    public boolean locationIsLeg(int loc) {
<span class="nc" id="L3435">        return false;</span>
    }

    /**
     * Returns a string representing the armor in the location
     */
    public String getArmorString(int loc) {
<span class="nc" id="L3442">        return getArmorString(loc, false);</span>
    }

    /**
     * Returns a string representing the armor in the location
     */
    public String getArmorString(int loc, boolean rear) {
<span class="nc" id="L3449">        return Entity.armorStringFor(getArmor(loc, rear));</span>
    }

    /**
     * Returns a string representing the internal structure in the location
     */
    public String getInternalString(int loc) {
<span class="nc" id="L3456">        return Entity.armorStringFor(getInternal(loc));</span>
    }

    /**
     * Parses the game's internal armor representation into a human-readable
     * string.
     */
    public static String armorStringFor(int value) {
<span class="nc bnc" id="L3464" title="All 2 branches missed.">        if (value == IArmorState.ARMOR_NA) {</span>
<span class="nc" id="L3465">            return &quot;N/A&quot;;</span>
<span class="nc bnc" id="L3466" title="All 4 branches missed.">        } else if ((value == IArmorState.ARMOR_DOOMED)</span>
                   || (value == IArmorState.ARMOR_DESTROYED)) {
<span class="nc" id="L3468">            return &quot;***&quot;;</span>
        } else {
<span class="nc" id="L3470">            return Integer.toString(value);</span>
        }
    }

    /**
     * Returns the modifier to weapons fire due to heat.
     */
    public int getHeatFiringModifier() {
<span class="nc" id="L3478">        int mod = 0;</span>
<span class="nc bnc" id="L3479" title="All 2 branches missed.">        if (heat &gt;= 8) {</span>
<span class="nc" id="L3480">            mod++;</span>
        }
<span class="nc bnc" id="L3482" title="All 2 branches missed.">        if (heat &gt;= 13) {</span>
<span class="nc" id="L3483">            mod++;</span>
        }
<span class="nc bnc" id="L3485" title="All 2 branches missed.">        if (heat &gt;= 17) {</span>
<span class="nc" id="L3486">            mod++;</span>
        }
<span class="nc bnc" id="L3488" title="All 2 branches missed.">        if (heat &gt;= 24) {</span>
<span class="nc" id="L3489">            mod++;</span>
        }
<span class="nc" id="L3491">        boolean mtHeat = game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_HEAT);</span>
<span class="nc bnc" id="L3492" title="All 4 branches missed.">        if (mtHeat &amp;&amp; (heat &gt;= 33)) {</span>
<span class="nc" id="L3493">            mod++;</span>
        }
<span class="nc bnc" id="L3495" title="All 4 branches missed.">        if (mtHeat &amp;&amp; (heat &gt;= 41)) {</span>
<span class="nc" id="L3496">            mod++;</span>
        }
<span class="nc bnc" id="L3498" title="All 4 branches missed.">        if (mtHeat &amp;&amp; (heat &gt;= 48)) {</span>
<span class="nc" id="L3499">            mod++;</span>
        }
<span class="nc bnc" id="L3501" title="All 4 branches missed.">        if ((mod &gt; 0) &amp;&amp; (getCrew() != null)</span>
<span class="nc bnc" id="L3502" title="All 2 branches missed.">                &amp;&amp; hasAbility(OptionsConstants.UNOFF_SOME_LIKE_IT_HOT)) {</span>
<span class="nc" id="L3503">            mod--;</span>
        }

<span class="nc" id="L3506">        return mod;</span>
    }

    /**
     * Creates a new mount for this equipment and adds it in.
     */
    public Mounted addEquipment(EquipmentType etype, int loc)
            throws LocationFullException {
<span class="nc" id="L3514">        return addEquipment(etype, loc, false);</span>
    }

    /**
     * Creates a new mount for this equipment and adds it in.
     */
    public Mounted addEquipment(EquipmentType etype, int loc,
                                boolean rearMounted) throws LocationFullException {
<span class="nc" id="L3522">        return addEquipment(etype, loc, rearMounted,</span>
                            BattleArmor.MOUNT_LOC_NONE, false, false, false, false, false);
    }

    /**
     * Creates a new mount for this equipment and adds it in.
     */
    public Mounted addEquipment(EquipmentType etype, int loc,
                                boolean rearMounted, int baMountLoc, boolean isArmored,
                                boolean isTurreted) throws LocationFullException {
<span class="nc" id="L3532">        return addEquipment(etype, loc, rearMounted, baMountLoc, isArmored,</span>
                            isTurreted, false, false, false);
    }

    public Mounted addEquipment(EquipmentType etype, int loc,
                                boolean rearMounted, int baMountLoc, boolean isArmored,
                                boolean isTurreted, boolean isSponsonTurreted)
            throws LocationFullException {
<span class="nc" id="L3540">        return addEquipment(etype, loc, rearMounted, baMountLoc, isArmored,</span>
                            isTurreted, isSponsonTurreted, false, false);
    }

    public Mounted addEquipment(EquipmentType etype, int loc,
            boolean rearMounted, int baMountLoc, boolean isArmored,
            boolean isTurreted, boolean isSponsonTurreted,
            boolean isPintleTurreted) throws LocationFullException {
<span class="nc" id="L3548">        return addEquipment(etype, loc, rearMounted, baMountLoc, isArmored,</span>
                isTurreted, isSponsonTurreted, isPintleTurreted, false);
    }

    public Mounted addEquipment(EquipmentType etype, int loc,
                                boolean rearMounted, int baMountLoc, boolean isArmored,
                                boolean isTurreted, boolean isSponsonTurreted,
                                boolean isPintleTurreted, boolean isOmniPodded) throws LocationFullException {
<span class="nc" id="L3556">        Mounted mounted = new Mounted(this, etype);</span>
<span class="nc" id="L3557">        mounted.setArmored(isArmored);</span>
<span class="nc" id="L3558">        mounted.setBaMountLoc(baMountLoc);</span>
<span class="nc" id="L3559">        mounted.setMechTurretMounted(isTurreted);</span>
<span class="nc" id="L3560">        mounted.setSponsonTurretMounted(isSponsonTurreted);</span>
<span class="nc" id="L3561">        mounted.setPintleTurretMounted(isPintleTurreted);</span>
<span class="nc" id="L3562">        mounted.setOmniPodMounted(isOmniPodded);</span>
<span class="nc" id="L3563">        addEquipment(mounted, loc, rearMounted);</span>
<span class="nc" id="L3564">        return mounted;</span>
    }

    /**
     * mounting weapons needs to take account of ammo
     *
     * @param etype
     * @param loc
     * @param rearMounted
     * @param nAmmo
     * @return
     * @throws LocationFullException
     */
    public Mounted addEquipment(EquipmentType etype, int loc,
                                boolean rearMounted, int nAmmo) throws LocationFullException {
<span class="nc" id="L3579">        Mounted mounted = new Mounted(this, etype);</span>
<span class="nc" id="L3580">        addEquipment(mounted, loc, rearMounted, nAmmo);</span>
<span class="nc" id="L3581">        return mounted;</span>

    }

    /**
     * indicate whether this is a bomb mount
     */
    public Mounted addBomb(EquipmentType etype, int loc)
            throws LocationFullException {
<span class="nc" id="L3590">        Mounted mounted = new Mounted(this, etype);</span>
<span class="nc" id="L3591">        addBomb(mounted, loc);</span>
<span class="nc" id="L3592">        return mounted;</span>
    }

    protected void addBomb(Mounted mounted, int loc)
            throws LocationFullException {
<span class="nc" id="L3597">        mounted.setBombMounted(true);</span>
<span class="nc" id="L3598">        addEquipment(mounted, loc, false);</span>
<span class="nc" id="L3599">    }</span>

    public Mounted addWeaponGroup(EquipmentType etype, int loc)
            throws LocationFullException {
<span class="nc" id="L3603">        Mounted mounted = new Mounted(this, etype);</span>
<span class="nc" id="L3604">        addEquipment(mounted, loc, false, true);</span>
<span class="nc" id="L3605">        return mounted;</span>
    }

    /**
     * indicate whether this is bodymounted for BAs
     */
    public Mounted addEquipment(EquipmentType etype, int loc,
                                boolean rearMounted, int baMountLoc, boolean dwpMounted)
            throws LocationFullException {
<span class="nc" id="L3614">        Mounted mounted = new Mounted(this, etype);</span>
<span class="nc" id="L3615">        mounted.setBaMountLoc(baMountLoc);</span>
<span class="nc" id="L3616">        mounted.setDWPMounted(dwpMounted);</span>
<span class="nc" id="L3617">        addEquipment(mounted, loc, rearMounted);</span>
<span class="nc" id="L3618">        return mounted;</span>
    }

    protected void addEquipment(Mounted mounted, int loc, boolean rearMounted,
                                int nAmmo) throws LocationFullException {
<span class="nc bnc" id="L3623" title="All 4 branches missed.">        if ((mounted.getType() instanceof AmmoType) &amp;&amp; (nAmmo &gt; 1)) {</span>
<span class="nc" id="L3624">            mounted.setByShot(true);</span>
<span class="nc" id="L3625">            mounted.setShotsLeft(nAmmo);</span>
<span class="nc" id="L3626">            mounted.setOriginalShots(nAmmo);</span>
<span class="nc" id="L3627">            double tonnage = Math.max(1, nAmmo / ((AmmoType) mounted.getType()).getShots()) * mounted.getTonnage();</span>
<span class="nc" id="L3628">            mounted.setAmmoCapacity(tonnage);</span>
        }

<span class="nc" id="L3631">        addEquipment(mounted, loc, rearMounted);</span>
<span class="nc" id="L3632">    }</span>

    protected void addEquipment(Mounted mounted, int loc, boolean rearMounted,
                                boolean isWeaponGroup) throws LocationFullException {
<span class="nc" id="L3636">        mounted.setWeaponGroup(true);</span>

<span class="nc" id="L3638">        addEquipment(mounted, loc, rearMounted);</span>
<span class="nc" id="L3639">    }</span>

    public void addEquipment(Mounted mounted, int loc, boolean rearMounted)
            throws LocationFullException {
<span class="nc" id="L3643">        mounted.setLocation(loc, rearMounted);</span>
<span class="nc" id="L3644">        equipmentList.add(mounted);</span>

<span class="nc" id="L3646">        compositeTechLevel.addComponent(mounted.getType());</span>
<span class="nc bnc" id="L3647" title="All 2 branches missed.">        if (mounted.isArmored()) {</span>
<span class="nc" id="L3648">            compositeTechLevel.addComponent(TA_ARMORED_COMPONENT);</span>
        }

        // add it to the proper sub-list
<span class="nc bnc" id="L3652" title="All 2 branches missed.">        if (mounted.getType() instanceof WeaponType) {</span>
<span class="nc" id="L3653">            totalWeaponList.add(mounted);</span>
<span class="nc bnc" id="L3654" title="All 2 branches missed.">            if (mounted.isWeaponGroup()) {</span>
<span class="nc" id="L3655">                weaponGroupList.add(mounted);</span>
<span class="nc bnc" id="L3656" title="All 2 branches missed.">            } else if (mounted.getType() instanceof BayWeapon) {</span>
<span class="nc" id="L3657">                weaponBayList.add(mounted);</span>
            } else {
<span class="nc" id="L3659">                weaponList.add(mounted);</span>
            }

<span class="nc bnc" id="L3662" title="All 2 branches missed.">            if (mounted.getType().hasFlag(WeaponType.F_ARTILLERY)) {</span>
<span class="nc" id="L3663">                aTracker.addWeapon(mounted);</span>
            }

            // one-shot launchers need their single shot of ammo added.
<span class="nc bnc" id="L3667" title="All 2 branches missed.">            if ((mounted.getType().hasFlag(WeaponType.F_ONESHOT)</span>
<span class="nc bnc" id="L3668" title="All 4 branches missed.">                    || (isSupportVehicle() &amp;&amp; (mounted.getType() instanceof InfantryWeapon)))</span>
<span class="nc bnc" id="L3669" title="All 2 branches missed.">                    &amp;&amp; (AmmoType.getOneshotAmmo(mounted) != null)) {</span>
<span class="nc" id="L3670">                addOneshotAmmo(mounted);</span>
            }
        }
<span class="nc bnc" id="L3673" title="All 2 branches missed.">        if (mounted.getType() instanceof AmmoType) {</span>
<span class="nc" id="L3674">            ammoList.add(mounted);</span>
        }
<span class="nc bnc" id="L3676" title="All 2 branches missed.">        if (mounted.getType() instanceof BombType) {</span>
<span class="nc" id="L3677">            bombList.add(mounted);</span>
        }
<span class="nc bnc" id="L3679" title="All 2 branches missed.">        if (mounted.getType() instanceof MiscType) {</span>
<span class="nc" id="L3680">            miscList.add(mounted);</span>
        }
<span class="nc" id="L3682">    }</span>

    private void addOneshotAmmo(Mounted mounted) throws LocationFullException {
        EquipmentType ammo;
        int shots;
<span class="nc bnc" id="L3687" title="All 2 branches missed.">        if (mounted.getType() instanceof InfantryWeapon) {</span>
<span class="nc" id="L3688">            ammo = EquipmentType.get(EquipmentTypeLookup.INFANTRY_AMMO);</span>
<span class="nc" id="L3689">            shots = ((InfantryWeapon) mounted.getType()).getShots() * (int) mounted.getSize();</span>
        } else {
<span class="nc" id="L3691">            ammo = AmmoType.getOneshotAmmo(mounted);</span>
<span class="nc" id="L3692">            shots = 1;</span>
        }
<span class="nc bnc" id="L3694" title="All 2 branches missed.">        if (ammo == null) {</span>
<span class="nc" id="L3695">            MegaMek.getLogger().error(&quot;Equipment lookup failed for ammo for &quot; + mounted.getName());</span>
<span class="nc" id="L3696">            return;</span>
        }
<span class="nc" id="L3698">        Mounted m = new Mounted(this, ammo);</span>
<span class="nc" id="L3699">        m.setOmniPodMounted(mounted.isOmniPodMounted());</span>
        // BA pop-up mines can be fired individually and need a shot for each launcher in the squad.
<span class="nc bnc" id="L3701" title="All 2 branches missed.">        if (mounted.getType().hasFlag(WeaponType.F_BA_INDIVIDUAL)) {</span>
<span class="nc" id="L3702">            shots = getTotalInternal();</span>
        }
<span class="nc" id="L3704">        m.setShotsLeft(shots);</span>
<span class="nc" id="L3705">        m.setOriginalShots(shots);</span>
<span class="nc" id="L3706">        mounted.setLinked(m);</span>
<span class="nc" id="L3707">        addEquipment(m, Entity.LOC_NONE, false);</span>
        // Fusillade gets a second round, which can be a different munition type so
        // need to allow for two separate mounts. Some infantry weapons have alternate
        // inferno ammo, which will use the same mechanism but start with zero shots.
<span class="nc bnc" id="L3711" title="All 2 branches missed.">        if (mounted.getType().hasFlag(WeaponType.F_DOUBLE_ONESHOT)) {</span>
<span class="nc" id="L3712">            Mounted m2 = new Mounted(this, m.getType());</span>
<span class="nc" id="L3713">            m2.setOmniPodMounted(mounted.isOmniPodMounted());</span>
<span class="nc" id="L3714">            m2.setShotsLeft(shots);</span>
<span class="nc" id="L3715">            m2.setOriginalShots(shots);</span>
<span class="nc" id="L3716">            m.setLinked(m2);</span>
<span class="nc" id="L3717">            addEquipment(m2, Entity.LOC_NONE, false);</span>
<span class="nc bnc" id="L3718" title="All 2 branches missed.">        } else if ((mounted.getType() instanceof InfantryWeapon)</span>
<span class="nc bnc" id="L3719" title="All 2 branches missed.">                &amp;&amp; ((InfantryWeapon) mounted.getType()).hasInfernoAmmo()) {</span>
<span class="nc" id="L3720">            Mounted m2 = new Mounted(this, EquipmentType.get(EquipmentTypeLookup.INFANTRY_INFERNO_AMMO));</span>
<span class="nc" id="L3721">            m2.setOmniPodMounted(mounted.isOmniPodMounted());</span>
<span class="nc" id="L3722">            m2.setShotsLeft(0);</span>
<span class="nc" id="L3723">            m.setLinked(m2);</span>
<span class="nc" id="L3724">            addEquipment(m2, Entity.LOC_NONE, false);</span>
        }
<span class="nc" id="L3726">    }</span>

    public void addFailedEquipment(String s) {
<span class="nc" id="L3729">        failedEquipmentList.add(s);</span>
<span class="nc" id="L3730">    }</span>

    /**
     * Returns the equipment number of the specified equipment, or -1 if
     * equipment is not present.
     */
    public int getEquipmentNum(Mounted mounted) {
<span class="nc bnc" id="L3737" title="All 2 branches missed.">        if (mounted != null) {</span>
<span class="nc" id="L3738">            return equipmentList.indexOf(mounted);</span>
        }
<span class="nc" id="L3740">        return -1;</span>
    }

    /**
     * Returns an enumeration of all equipment
     */
    public ArrayList&lt;Mounted&gt; getEquipment() {
<span class="nc" id="L3747">        return equipmentList;</span>
    }

    /**
     * Returns the equipment, specified by number
     */
    public Mounted getEquipment(int index) {
        try {
<span class="nc" id="L3755">            return equipmentList.get(index);</span>
<span class="nc" id="L3756">        } catch (IndexOutOfBoundsException ex) {</span>
<span class="nc" id="L3757">            return null;</span>
        }
    }

    public EquipmentType getEquipmentType(CriticalSlot cs) {
<span class="nc bnc" id="L3762" title="All 2 branches missed.">        if (cs.getType() != CriticalSlot.TYPE_EQUIPMENT) {</span>
<span class="nc" id="L3763">            return null;</span>
        }
<span class="nc" id="L3765">        Mounted m = cs.getMount();</span>
<span class="nc" id="L3766">        return m.getType();</span>
    }

    /**
     * Returns an enumeration which contains the name of each piece of equipment
     * that failed to load.
     */
    public Iterator&lt;String&gt; getFailedEquipment() {
<span class="nc" id="L3774">        return failedEquipmentList.iterator();</span>
    }

    public int getTotalAmmoOfType(EquipmentType et) {
<span class="nc" id="L3778">        int totalShotsLeft = 0;</span>
<span class="nc bnc" id="L3779" title="All 2 branches missed.">        for (Mounted amounted : getAmmo()) {</span>
            // FIXME: Consider new AmmoType::equals / BombType::equals
<span class="nc bnc" id="L3781" title="All 4 branches missed.">            if (amounted.getType().equals(et) &amp;&amp; !amounted.isDumping()) {</span>
<span class="nc" id="L3782">                totalShotsLeft += amounted.getUsableShotsLeft();</span>
            }
<span class="nc" id="L3784">        }</span>
<span class="nc" id="L3785">        return totalShotsLeft;</span>
    }

    /**
     * Determine how much ammunition (of all munition types) remains which is
     * compatible with the given weapon.
     *
     * @param weapon The weapon being considered
     * @return the &lt;code&gt;int&lt;/code&gt; count of the amount of shots of all
     * munitions available for the given weapon.
     */
    public int getTotalMunitionsOfType(Mounted weapon) {
<span class="nc" id="L3797">        int totalShotsLeft = 0;</span>
        
        // specifically don't count caseless munitions as being of the same type as non-caseless
<span class="nc bnc" id="L3800" title="All 2 branches missed.">        for (Mounted amounted : getAmmo()) {</span>
<span class="nc" id="L3801">            boolean canSwitchToAmmo = AmmoType.canSwitchToAmmo(weapon, (AmmoType) amounted.getType());</span>

<span class="nc bnc" id="L3803" title="All 4 branches missed.">            if (canSwitchToAmmo &amp;&amp; !amounted.isDumping()) {</span>
<span class="nc" id="L3804">                totalShotsLeft += amounted.getUsableShotsLeft();</span>
            }
<span class="nc" id="L3806">        }</span>
<span class="nc" id="L3807">        return totalShotsLeft;</span>
    }

    /**
     * Returns the Rules.ARC that the weapon, specified by number, fires into.
     */
    public abstract int getWeaponArc(int wn);

    /**
     * Returns true if this weapon fires into the secondary facing arc. If
     * false, assume it fires into the primary.
     */
    public abstract boolean isSecondaryArcWeapon(int weaponId);

    public Iterator&lt;Mounted&gt; getWeapons() {
<span class="nc bnc" id="L3822" title="All 2 branches missed.">        if (usesWeaponBays()) {</span>
<span class="nc" id="L3823">            return weaponBayList.iterator();</span>
        }
<span class="nc bnc" id="L3825" title="All 2 branches missed.">        if (isCapitalFighter()) {</span>
<span class="nc" id="L3826">            return weaponGroupList.iterator();</span>
        }

<span class="nc" id="L3829">        return weaponList.iterator();</span>
    }
    
    public ArrayList&lt;Mounted&gt; getIndividualWeaponList() {
<span class="nc" id="L3833">        return weaponList;</span>
    }

    public ArrayList&lt;Mounted&gt; getWeaponList() {
<span class="nc bnc" id="L3837" title="All 2 branches missed.">        if (usesWeaponBays()) {</span>
<span class="nc" id="L3838">            return weaponBayList;</span>
        }
<span class="nc bnc" id="L3840" title="All 2 branches missed.">        if (isCapitalFighter()) {</span>
<span class="nc" id="L3841">            return weaponGroupList;</span>
        }

<span class="nc" id="L3844">        return weaponList;</span>
    }

    public List&lt;Mounted&gt; getTotalWeaponList() {
        // return full weapon list even bay mounts and weapon groups
<span class="nc" id="L3849">        return totalWeaponList;</span>
    }

    public ArrayList&lt;Mounted&gt; getWeaponBayList() {
<span class="nc" id="L3853">        return weaponBayList;</span>
    }

    public ArrayList&lt;Mounted&gt; getWeaponGroupList() {
<span class="nc" id="L3857">        return weaponGroupList;</span>
    }

    /**
     * Returns the first ready weapon
     *
     * @return the index number of the first available weapon, or -1 if none are
     * ready.
     */
    public int getFirstWeapon() {
        // Now phase appropriate, since we don't really care to select weapons
        // we can't use during this phase... do we?
<span class="nc bnc" id="L3869" title="All 2 branches missed.">        for (Mounted mounted : getWeaponList()) {</span>
            // TAG only in the correct phase...
<span class="nc bnc" id="L3871" title="All 2 branches missed.">            if ((mounted.getType().hasFlag(WeaponType.F_TAG) &amp;&amp; (game</span>
<span class="nc bnc" id="L3872" title="All 2 branches missed.">                                                                         .getPhase() != IGame.Phase.PHASE_OFFBOARD))</span>
<span class="nc bnc" id="L3873" title="All 2 branches missed.">                || (!mounted.getType().hasFlag(WeaponType.F_TAG) &amp;&amp; (game</span>
<span class="nc bnc" id="L3874" title="All 2 branches missed.">                                                                             .getPhase() == IGame.Phase.PHASE_OFFBOARD))</span>
                //No AMS, unless it's in 'weapon' mode
<span class="nc bnc" id="L3876" title="All 4 branches missed.">                || (mounted.getType().hasFlag(WeaponType.F_AMS) &amp;&amp; !mounted.curMode().equals(Weapon.MODE_AMS_MANUAL))) {</span>
<span class="nc" id="L3877">                continue;</span>
            }

            // Artillery and Bearings-Only Capital Missiles only in the correct phase...
<span class="nc bnc" id="L3881" title="All 2 branches missed.">            if (!(mounted.getType().hasFlag(WeaponType.F_ARTILLERY)</span>
<span class="nc bnc" id="L3882" title="All 2 branches missed.">                    || mounted.isInBearingsOnlyMode()</span>
<span class="nc bnc" id="L3883" title="All 2 branches missed.">                    || (this.getAltitude() == 0</span>
<span class="nc bnc" id="L3884" title="All 2 branches missed.">                            &amp;&amp; mounted.getType() instanceof CapitalMissileWeapon))) {</span>
<span class="nc" id="L3885">                continue;</span>
            }

            // No linked MGs...
<span class="nc bnc" id="L3889" title="All 2 branches missed.">            if (mounted.getType().hasFlag(WeaponType.F_MG)) {</span>
<span class="nc bnc" id="L3890" title="All 2 branches missed.">                if (hasLinkedMGA(mounted)) {</span>
<span class="nc" id="L3891">                    continue;</span>
                }
            }

            // It must be ready to be used...
<span class="nc bnc" id="L3896" title="All 2 branches missed.">            if (mounted.isReady()) {</span>
<span class="nc" id="L3897">                return getEquipmentNum(mounted);</span>
            }
<span class="nc" id="L3899">        }</span>
<span class="nc" id="L3900">        return -1;</span>
    }

    /**
     * Returns true if the weapon, specified as a weapon id, is valid for the
     * current phase.
     *
     * @param weapNum
     * @return True if valid, else false
     */
    public boolean isWeaponValidForPhase(int weapNum) {
<span class="nc" id="L3911">        return isWeaponValidForPhase(equipmentList.get(weapNum));</span>
    }

    /**
     * Returns true if the weapon, specified as a &lt;code&gt;Mounted&lt;/code&gt;, is
     * valid for the current phase.
     *
     * @param mounted
     * @return True if valid, else false
     */
    public boolean isWeaponValidForPhase(Mounted mounted) {
        // Start reached, now we can attempt to pick a weapon.
<span class="nc bnc" id="L3923" title="All 2 branches missed.">        if ((mounted != null)</span>
<span class="nc bnc" id="L3924" title="All 2 branches missed.">            &amp;&amp; (mounted.isReady())</span>
<span class="nc bnc" id="L3925" title="All 4 branches missed.">            &amp;&amp; (!(mounted.getType().hasFlag(WeaponType.F_AMS) &amp;&amp; mounted.curMode().equals(Weapon.MODE_AMS_ON)))</span>
<span class="nc bnc" id="L3926" title="All 4 branches missed.">            &amp;&amp; (!(mounted.getType().hasFlag(WeaponType.F_AMS) &amp;&amp; mounted.curMode().equals(Weapon.MODE_AMS_OFF)))</span>
<span class="nc bnc" id="L3927" title="All 2 branches missed.">            &amp;&amp; (!mounted.getType().hasFlag(WeaponType.F_AMSBAY))</span>
<span class="nc bnc" id="L3928" title="All 4 branches missed.">            &amp;&amp; (!(mounted.getType().hasModes() &amp;&amp; mounted.curMode().equals(&quot;Point Defense&quot;)))</span>
<span class="nc bnc" id="L3929" title="All 2 branches missed.">            &amp;&amp; ((mounted.getLinked() == null)</span>
<span class="nc bnc" id="L3930" title="All 2 branches missed.">                || mounted.getLinked().getType().hasFlag(MiscType.F_AP_MOUNT)</span>
<span class="nc bnc" id="L3931" title="All 2 branches missed.">                || (mounted.getLinked().getUsableShotsLeft() &gt; 0))) {</span>

            // TAG only in the correct phase...
<span class="nc bnc" id="L3934" title="All 2 branches missed.">            if ((mounted.getType().hasFlag(WeaponType.F_TAG)</span>
<span class="nc bnc" id="L3935" title="All 2 branches missed.">                    &amp;&amp; (game.getPhase() != IGame.Phase.PHASE_OFFBOARD))</span>
<span class="nc bnc" id="L3936" title="All 2 branches missed.">                    || (!mounted.getType().hasFlag(WeaponType.F_TAG)</span>
<span class="nc bnc" id="L3937" title="All 2 branches missed.">                            &amp;&amp; (game.getPhase()</span>
                                    == IGame.Phase.PHASE_OFFBOARD))) {
<span class="nc" id="L3939">                return false;</span>
            }

            // Artillery or Bearings-only missiles only in the targeting phase...
<span class="nc bnc" id="L3943" title="All 2 branches missed.">            if (!(mounted.getType().hasFlag(WeaponType.F_ARTILLERY)</span>
<span class="nc bnc" id="L3944" title="All 2 branches missed.">                    || mounted.isInBearingsOnlyMode()</span>
<span class="nc bnc" id="L3945" title="All 2 branches missed.">                    || (this.getAltitude() == 0</span>
<span class="nc bnc" id="L3946" title="All 2 branches missed.">                            &amp;&amp; mounted.getType() instanceof CapitalMissileWeapon))</span>
<span class="nc bnc" id="L3947" title="All 2 branches missed.">                &amp;&amp; (game.getPhase() == IGame.Phase.PHASE_TARGETING)) {</span>
<span class="nc" id="L3948">                return false;</span>
            }
            // No Bearings-only missiles in the firing phase
<span class="nc bnc" id="L3951" title="All 4 branches missed.">            if (mounted.isInBearingsOnlyMode() &amp;&amp; game.getPhase() == IGame.Phase.PHASE_FIRING) {</span>
<span class="nc" id="L3952">                return false;</span>
            }

            // No linked MGs...
<span class="nc bnc" id="L3956" title="All 2 branches missed.">            if (mounted.getType().hasFlag(WeaponType.F_MG)) {</span>
<span class="nc bnc" id="L3957" title="All 2 branches missed.">                if (hasLinkedMGA(mounted)) {</span>
<span class="nc" id="L3958">                    return false;</span>
                }
            }
<span class="nc" id="L3961">            return true;</span>
        } else {
<span class="nc" id="L3963">            return false;</span>
        }
    }

    /**
     * Attempts to load all weapons with ammo
     */
    public void loadAllWeapons() {
<span class="nc bnc" id="L3971" title="All 2 branches missed.">        for (Mounted mounted : getTotalWeaponList()) {</span>
<span class="nc" id="L3972">            WeaponType wtype = (WeaponType) mounted.getType();</span>
<span class="nc bnc" id="L3973" title="All 2 branches missed.">            if (wtype.getAmmoType() != AmmoType.T_NA) {</span>
<span class="nc" id="L3974">                loadWeapon(mounted);</span>
            }
<span class="nc" id="L3976">        }</span>
<span class="nc" id="L3977">    }</span>

    /**
     * Tries to load the specified weapon with the first available ammo
     */
    public void loadWeapon(Mounted mounted) {
<span class="nc bnc" id="L3983" title="All 2 branches missed.">        for (Mounted mountedAmmo : getAmmo()) {</span>
<span class="nc bnc" id="L3984" title="All 2 branches missed.">            if (loadWeapon(mounted, mountedAmmo)) {</span>
<span class="nc" id="L3985">                break;</span>
            }
<span class="nc" id="L3987">        }</span>
<span class="nc" id="L3988">    }</span>

    /**
     * Tries to load the specified weapon with the first available ammo of the
     * same munition type as currently in use. If this fails, use first ammo.
     * 
     * If this is a weapon bay, try to load the weapon with ammo in the same bay,
     * and if it fails, load with compatible ammo in the same location.
     * 
     * If this unit is part of a train, also check the vehicles directly connected
     * to it for compatible ammo
     */
    public void loadWeaponWithSameAmmo(Mounted mounted) {
<span class="nc bnc" id="L4001" title="All 2 branches missed.">        for (Mounted mountedAmmo : getAmmo()) {</span>
<span class="nc bnc" id="L4002" title="All 2 branches missed.">            if (loadWeaponWithSameAmmo(mounted, mountedAmmo)) {</span>
<span class="nc" id="L4003">                return;</span>
            }
<span class="nc" id="L4005">        }</span>
        //Check the unit towing this one for ammo
<span class="nc bnc" id="L4007" title="All 2 branches missed.">        if (getTowedBy() != Entity.NONE) {</span>
<span class="nc" id="L4008">            Entity ahead = game.getEntity(getTowedBy());</span>
<span class="nc bnc" id="L4009" title="All 2 branches missed.">            if (ahead != null) {</span>
<span class="nc bnc" id="L4010" title="All 2 branches missed.">                for (Mounted towedByAmmo : ahead.getAmmo()) {</span>
<span class="nc bnc" id="L4011" title="All 2 branches missed.">                    if (loadWeaponWithSameAmmo(mounted, towedByAmmo)) {</span>
<span class="nc" id="L4012">                        return;</span>
                    }
<span class="nc" id="L4014">                }</span>
            }
        }
        // Then check the unit towed by this one for ammo
<span class="nc bnc" id="L4018" title="All 2 branches missed.">        if (getTowing() != Entity.NONE) {</span>
<span class="nc" id="L4019">            Entity behind = game.getEntity(getTowing());</span>
<span class="nc bnc" id="L4020" title="All 2 branches missed.">            if (behind != null) {</span>
<span class="nc bnc" id="L4021" title="All 2 branches missed.">                for (Mounted towingAmmo : behind.getAmmo()) {</span>
<span class="nc bnc" id="L4022" title="All 2 branches missed.">                    if (loadWeaponWithSameAmmo(mounted, towingAmmo)) {</span>
<span class="nc" id="L4023">                        return;</span>
                    }
<span class="nc" id="L4025">                }</span>
            }
        }
        // fall back to use any ammo
<span class="nc" id="L4029">        loadWeapon(mounted);</span>
<span class="nc" id="L4030">    }</span>

    /**
     * Tries to load the specified weapon with the specified ammo. Returns true
     * if successful, false otherwise.
     */
    public boolean loadWeapon(Mounted mounted, Mounted mountedAmmo) {
<span class="nc" id="L4037">        boolean success = false;</span>
<span class="nc" id="L4038">        WeaponType wtype = (WeaponType) mounted.getType();</span>
<span class="nc" id="L4039">        AmmoType atype = (AmmoType) mountedAmmo.getType();</span>

<span class="nc bnc" id="L4041" title="All 4 branches missed.">        if (mountedAmmo.isAmmoUsable() &amp;&amp; !wtype.hasFlag(WeaponType.F_ONESHOT)</span>
<span class="nc bnc" id="L4042" title="All 2 branches missed.">            &amp;&amp; (atype.getAmmoType() == wtype.getAmmoType())</span>
<span class="nc bnc" id="L4043" title="All 2 branches missed.">            &amp;&amp; (atype.getRackSize() == wtype.getRackSize())) {</span>
<span class="nc" id="L4044">            mounted.setLinked(mountedAmmo);</span>
<span class="nc" id="L4045">            success = true;</span>
<span class="nc bnc" id="L4046" title="All 2 branches missed.">        } else if ((wtype.hasFlag(WeaponType.F_DOUBLE_ONESHOT)</span>
<span class="nc bnc" id="L4047" title="All 2 branches missed.">                    || (wtype.getAmmoType() == AmmoType.T_INFANTRY))</span>
<span class="nc bnc" id="L4048" title="All 2 branches missed.">                &amp;&amp; (mountedAmmo.getLocation() == Entity.LOC_NONE)) {</span>
            // Make sure this ammo is in the chain, then move it to the head.
<span class="nc bnc" id="L4050" title="All 2 branches missed.">            for (Mounted current = mounted; current != null; current = current.getLinked()) {</span>
<span class="nc bnc" id="L4051" title="All 2 branches missed.">                if (current == mountedAmmo) {</span>
<span class="nc" id="L4052">                    current.getLinkedBy().setLinked(current.getLinked());</span>
<span class="nc" id="L4053">                    current.setLinked(mounted.getLinked());</span>
<span class="nc" id="L4054">                    mounted.setLinked(current);</span>
<span class="nc" id="L4055">                    return true;</span>
                }
            }
        }
<span class="nc" id="L4059">        return success;</span>
    }

    /**
     * Tries to load the specified weapon with the specified ammo. Returns true
     * if successful, false otherwise.
     */
    public boolean loadWeaponWithSameAmmo(Mounted mounted, Mounted mountedAmmo) {
<span class="nc" id="L4067">        AmmoType atype = (AmmoType) mountedAmmo.getType();</span>
<span class="nc" id="L4068">        Mounted oldammo = mounted.getLinked();</span>

<span class="nc bnc" id="L4070" title="All 4 branches missed.">        if ((oldammo != null) &amp;&amp; (oldammo.getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L4071" title="All 2 branches missed.">                &amp;&amp; !((AmmoType) oldammo.getType()).equals(atype)) {</span>
<span class="nc" id="L4072">            return false;</span>
        }

<span class="nc" id="L4075">        return loadWeapon(mounted, mountedAmmo);</span>
    }

    /**
     * Checks whether a weapon has been fired on this unit this turn
     *
     * @return
     */
    public boolean weaponFired() {
<span class="nc" id="L4084">        boolean fired = false;</span>
<span class="nc bnc" id="L4085" title="All 4 branches missed.">        for (int loc = 0; (loc &lt; locations()) &amp;&amp; !fired; loc++) {</span>
<span class="nc" id="L4086">            fired |= weaponFiredFrom(loc);</span>
        }
<span class="nc" id="L4088">        return fired;</span>
    }

    /**
     * Checks whether a weapon has been fired from the specified location this
     * turn
     */
    public boolean weaponFiredFrom(int loc) {
        // check critical slots for used weapons
<span class="nc bnc" id="L4097" title="All 2 branches missed.">        for (int i = 0; i &lt; this.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L4098">            CriticalSlot slot = getCritical(loc, i);</span>
            // ignore empty &amp; system slots
<span class="nc bnc" id="L4100" title="All 2 branches missed.">            if ((slot == null)</span>
<span class="nc bnc" id="L4101" title="All 2 branches missed.">                || (slot.getType() != CriticalSlot.TYPE_EQUIPMENT)) {</span>
<span class="nc" id="L4102">                continue;</span>
            }
<span class="nc" id="L4104">            Mounted mounted = slot.getMount();</span>
<span class="nc bnc" id="L4105" title="All 2 branches missed.">            if ((mounted.getType() instanceof WeaponType)</span>
<span class="nc bnc" id="L4106" title="All 2 branches missed.">                &amp;&amp; mounted.isUsedThisRound()) {</span>
<span class="nc" id="L4107">                return true;</span>
            }
        }
<span class="nc" id="L4110">        return false;</span>
    }

    public ArrayList&lt;Mounted&gt; getAmmo() {
<span class="nc" id="L4114">        return ammoList;</span>
    }

    public ArrayList&lt;Mounted&gt; getMisc() {
<span class="nc" id="L4118">        return miscList;</span>
    }

    public List&lt;Mounted&gt; getBombs() {
<span class="nc" id="L4122">        return bombList;</span>
    }

    public Vector&lt;Mounted&gt; getBombs(BigInteger flag) {
<span class="nc" id="L4126">        Vector&lt;Mounted&gt; bombs = new Vector&lt;Mounted&gt;();</span>
<span class="nc bnc" id="L4127" title="All 2 branches missed.">        for (Mounted bomb : getBombs()) {</span>
<span class="nc" id="L4128">            BombType btype = (BombType) bomb.getType();</span>
<span class="nc bnc" id="L4129" title="All 4 branches missed.">            if (!bomb.isInoperable() &amp;&amp; (bomb.getUsableShotsLeft() &gt; 0)</span>
<span class="nc bnc" id="L4130" title="All 2 branches missed.">                &amp;&amp; btype.hasFlag(flag)) {</span>
<span class="nc" id="L4131">                bombs.add(bomb);</span>
            }
<span class="nc" id="L4133">        }</span>
<span class="nc" id="L4134">        return bombs;</span>
    }
    /**
     * Reset bomb attacks according to what bombs are available.
     */
    protected void resetBombAttacks() {
        // Remove all bomb attacks
<span class="nc" id="L4141">        List&lt;Mounted&gt; bombAttacksToRemove = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L4142">        EquipmentType spaceBomb = EquipmentType.get(IBomber.SPACE_BOMB_ATTACK);</span>
<span class="nc" id="L4143">        EquipmentType altBomb = EquipmentType.get(IBomber.ALT_BOMB_ATTACK);</span>
<span class="nc" id="L4144">        EquipmentType diveBomb = EquipmentType.get(IBomber.DIVE_BOMB_ATTACK);</span>
<span class="nc bnc" id="L4145" title="All 2 branches missed.">        for (Mounted eq : equipmentList) {</span>
            // FIXME: Consider new BombType::equals
<span class="nc bnc" id="L4147" title="All 4 branches missed.">            if (eq.getType().equals(spaceBomb) || eq.getType().equals(altBomb)</span>
<span class="nc bnc" id="L4148" title="All 2 branches missed.">                    || eq.getType().equals(diveBomb)) {</span>
<span class="nc" id="L4149">                bombAttacksToRemove.add(eq);</span>
            }
<span class="nc" id="L4151">        }</span>
<span class="nc" id="L4152">        equipmentList.removeAll(bombAttacksToRemove);</span>
<span class="nc" id="L4153">        weaponList.removeAll(bombAttacksToRemove);</span>
<span class="nc" id="L4154">        totalWeaponList.removeAll(bombAttacksToRemove);</span>
<span class="nc" id="L4155">        weaponGroupList.removeAll(bombAttacksToRemove);</span>
<span class="nc" id="L4156">        weaponBayList.removeAll(bombAttacksToRemove);</span>

<span class="nc" id="L4158">        boolean foundSpaceBomb = false;</span>
<span class="nc" id="L4159">        int numGroundBombs = 0;</span>

<span class="nc bnc" id="L4161" title="All 2 branches missed.">        for (Mounted m : getBombs()) {</span>
            // Add the space bomb attack
<span class="nc bnc" id="L4163" title="All 2 branches missed.">            if (!foundSpaceBomb</span>
<span class="nc bnc" id="L4164" title="All 2 branches missed.">                    &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_SPACE_BOMB)</span>
<span class="nc bnc" id="L4165" title="All 2 branches missed.">                    &amp;&amp; m.getType().hasFlag(AmmoType.F_SPACE_BOMB)</span>
<span class="nc bnc" id="L4166" title="All 2 branches missed.">                    &amp;&amp; isFighter()</span>
<span class="nc bnc" id="L4167" title="All 2 branches missed.">                    &amp;&amp; game.getBoard().inSpace()) {</span>
                try {
<span class="nc" id="L4169">                    Mounted bomb = addEquipment(spaceBomb, m.getLocation(), false);</span>
<span class="nc bnc" id="L4170" title="All 2 branches missed.">                    if (hasETypeFlag(ETYPE_FIGHTER_SQUADRON)) {</span>
<span class="nc" id="L4171">                        bomb.setWeaponGroup(true);</span>
<span class="nc" id="L4172">                        weaponGroupList.add(bomb);</span>
                    }
<span class="nc" id="L4174">                } catch (LocationFullException ex) {</span>

<span class="nc" id="L4176">                }</span>
<span class="nc" id="L4177">                foundSpaceBomb = true;</span>
            }
<span class="nc bnc" id="L4179" title="All 2 branches missed.">            if (!game.getBoard().inSpace()</span>
<span class="nc bnc" id="L4180" title="All 4 branches missed.">                    &amp;&amp; m.getType().hasFlag(AmmoType.F_GROUND_BOMB)</span>
                    &amp;&amp; !((this instanceof LandAirMech)
<span class="nc bnc" id="L4182" title="All 2 branches missed.">                            &amp;&amp; (getConversionMode() == LandAirMech.CONV_MODE_MECH))) {</span>
<span class="nc bnc" id="L4183" title="All 2 branches missed.">                if (numGroundBombs &lt; 1) {</span>
                    try {
<span class="nc" id="L4185">                        Mounted bomb = addEquipment(diveBomb, m.getLocation(), false);</span>
<span class="nc bnc" id="L4186" title="All 2 branches missed.">                        if (hasETypeFlag(ETYPE_FIGHTER_SQUADRON)) {</span>
<span class="nc" id="L4187">                            bomb.setWeaponGroup(true);</span>
<span class="nc" id="L4188">                            weaponGroupList.add(bomb);</span>
                        }
<span class="nc" id="L4190">                    } catch (LocationFullException ex) {</span>
<span class="nc" id="L4191">                    }</span>
                }
<span class="nc bnc" id="L4193" title="All 4 branches missed.">                if (numGroundBombs &lt; 10 &amp;&amp; isFighter()) {</span>
                    try {
<span class="nc" id="L4195">                        Mounted bomb = addEquipment(altBomb, m.getLocation(), false);</span>
<span class="nc bnc" id="L4196" title="All 2 branches missed.">                        if (hasETypeFlag(ETYPE_FIGHTER_SQUADRON)) {</span>
<span class="nc" id="L4197">                            bomb.setWeaponGroup(true);</span>
<span class="nc" id="L4198">                            weaponGroupList.add(bomb);</span>
                        }
<span class="nc" id="L4200">                    } catch (LocationFullException ex) {</span>
<span class="nc" id="L4201">                    }</span>
                }
<span class="nc" id="L4203">                numGroundBombs++;</span>
            }

<span class="nc" id="L4206">        }</span>

<span class="nc" id="L4208">    }</span>

    /**
     * Removes the first misc eq. whose name equals the specified string. Used
     * for removing broken tree clubs.
     */
    public void removeMisc(String toRemove) {
<span class="nc bnc" id="L4215" title="All 2 branches missed.">        for (Mounted mounted : getMisc()) {</span>
<span class="nc bnc" id="L4216" title="All 2 branches missed.">            if (mounted.getName().equals(toRemove)) {</span>
<span class="nc" id="L4217">                miscList.remove(mounted);</span>
<span class="nc" id="L4218">                equipmentList.remove(mounted);</span>
<span class="nc" id="L4219">                break;</span>
            }
<span class="nc" id="L4221">        }</span>
<span class="nc" id="L4222">    }</span>

    public void removeWeapon(String toRemove) {
<span class="nc bnc" id="L4225" title="All 2 branches missed.">        for (Mounted mounted : getMisc()) {</span>
<span class="nc bnc" id="L4226" title="All 2 branches missed.">            if (mounted.getName().equals(toRemove)) {</span>
<span class="nc" id="L4227">                weaponList.remove(mounted);</span>
<span class="nc" id="L4228">                equipmentList.remove(mounted);</span>
<span class="nc" id="L4229">                break;</span>
            }
<span class="nc" id="L4231">        }</span>
<span class="nc" id="L4232">    }</span>

    /**
     * Clear all bombs and bomb attacks
     */
    public void clearBombs() {
<span class="nc" id="L4238">        bombList.clear();</span>
<span class="nc bnc" id="L4239" title="All 2 branches missed.">        for (Iterator&lt;Mounted&gt; i = equipmentList.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L4240">            Mounted m = i.next();</span>
<span class="nc bnc" id="L4241" title="All 2 branches missed.">            if ((m.getType() instanceof BombType)</span>
<span class="nc bnc" id="L4242" title="All 2 branches missed.">                || (m.getType() instanceof DiveBombAttack)</span>
<span class="nc bnc" id="L4243" title="All 2 branches missed.">                || (m.getType() instanceof SpaceBombAttack)</span>
<span class="nc bnc" id="L4244" title="All 2 branches missed.">                || (m.getType() instanceof AltitudeBombAttack)</span>
<span class="nc bnc" id="L4245" title="All 2 branches missed.">                || (m.getType() instanceof ISAAAMissileWeapon)</span>
<span class="nc bnc" id="L4246" title="All 2 branches missed.">                || (m.getType() instanceof CLAAAMissileWeapon)</span>
<span class="nc bnc" id="L4247" title="All 2 branches missed.">                || (m.getType() instanceof ISASMissileWeapon)</span>
<span class="nc bnc" id="L4248" title="All 2 branches missed.">                || (m.getType() instanceof ISASEWMissileWeapon)</span>
<span class="nc bnc" id="L4249" title="All 2 branches missed.">                || (m.getType() instanceof CLASMissileWeapon)</span>
<span class="nc bnc" id="L4250" title="All 2 branches missed.">                || (m.getType() instanceof CLASEWMissileWeapon)</span>
<span class="nc bnc" id="L4251" title="All 2 branches missed.">                || (m.getType() instanceof ISLAAMissileWeapon)</span>
<span class="nc bnc" id="L4252" title="All 2 branches missed.">                || (m.getType() instanceof CLLAAMissileWeapon)</span>
<span class="nc bnc" id="L4253" title="All 2 branches missed.">                || (m.getType() instanceof BombArrowIV)</span>
                    /*|| m.getType() instanceof CLBombArrowIV*/
<span class="nc bnc" id="L4255" title="All 2 branches missed.">                    || (m.getType() instanceof CLBombTAG)</span>
<span class="nc bnc" id="L4256" title="All 2 branches missed.">                    || (m.getType() instanceof ISBombTAG)</span>
<span class="nc bnc" id="L4257" title="All 2 branches missed.">                    || (m.getType() instanceof BombISRL10)</span>
<span class="nc bnc" id="L4258" title="All 2 branches missed.">                    || (m.getType() instanceof AlamoMissileWeapon)) {</span>
<span class="nc" id="L4259">                i.remove();</span>
            }
<span class="nc" id="L4261">        }</span>
<span class="nc bnc" id="L4262" title="All 2 branches missed.">        for (Iterator&lt;Mounted&gt; i = weaponList.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L4263">            Mounted m = i.next();</span>
<span class="nc bnc" id="L4264" title="All 2 branches missed.">            if ((m.getType() instanceof DiveBombAttack)</span>
<span class="nc bnc" id="L4265" title="All 2 branches missed.">                || (m.getType() instanceof SpaceBombAttack)</span>
<span class="nc bnc" id="L4266" title="All 2 branches missed.">                || (m.getType() instanceof AltitudeBombAttack)</span>
<span class="nc bnc" id="L4267" title="All 2 branches missed.">                || (m.getType() instanceof ISAAAMissileWeapon)</span>
<span class="nc bnc" id="L4268" title="All 2 branches missed.">                || (m.getType() instanceof CLAAAMissileWeapon)</span>
<span class="nc bnc" id="L4269" title="All 2 branches missed.">                || (m.getType() instanceof ISASMissileWeapon)</span>
<span class="nc bnc" id="L4270" title="All 2 branches missed.">                || (m.getType() instanceof ISASEWMissileWeapon)</span>
<span class="nc bnc" id="L4271" title="All 2 branches missed.">                || (m.getType() instanceof CLASMissileWeapon)</span>
<span class="nc bnc" id="L4272" title="All 2 branches missed.">                || (m.getType() instanceof CLASEWMissileWeapon)</span>
<span class="nc bnc" id="L4273" title="All 2 branches missed.">                || (m.getType() instanceof ISLAAMissileWeapon)</span>
<span class="nc bnc" id="L4274" title="All 2 branches missed.">                || (m.getType() instanceof CLLAAMissileWeapon)</span>
<span class="nc bnc" id="L4275" title="All 2 branches missed.">                || (m.getType() instanceof BombArrowIV)</span>
                    /*|| m.getType() instanceof CLBombArrowIV*/
<span class="nc bnc" id="L4277" title="All 2 branches missed.">                    || (m.getType() instanceof CLBombTAG)</span>
<span class="nc bnc" id="L4278" title="All 2 branches missed.">                    || (m.getType() instanceof ISBombTAG)</span>
<span class="nc bnc" id="L4279" title="All 2 branches missed.">                    || (m.getType() instanceof BombISRL10)</span>
<span class="nc bnc" id="L4280" title="All 2 branches missed.">                    || (m.getType() instanceof AlamoMissileWeapon)) {</span>
<span class="nc" id="L4281">                i.remove();</span>
            }
<span class="nc" id="L4283">        }</span>
<span class="nc bnc" id="L4284" title="All 2 branches missed.">        for (Iterator&lt;Mounted&gt; i = ammoList.iterator(); i.hasNext(); ) {</span>
<span class="nc" id="L4285">            Mounted m = i.next();</span>
<span class="nc bnc" id="L4286" title="All 2 branches missed.">            if (m.getType() instanceof BombType) {</span>
<span class="nc" id="L4287">                i.remove();</span>
            }
<span class="nc" id="L4289">        }</span>
<span class="nc" id="L4290">    }</span>

    public List&lt;Mounted&gt; getClubs() {
<span class="nc" id="L4293">        List&lt;Mounted&gt; rv = new ArrayList&lt;Mounted&gt;();</span>
<span class="nc bnc" id="L4294" title="All 2 branches missed.">        for (Mounted m : getMisc()) {</span>
<span class="nc bnc" id="L4295" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_CLUB)) {</span>
<span class="nc" id="L4296">                rv.add(m);</span>
            }
<span class="nc" id="L4298">        }</span>
<span class="nc" id="L4299">        return rv;</span>
    }

    /**
     * Check if the entity has an arbitrary type of misc equipment
     *
     * @param flag A MiscType.F_XXX
     * @return true if at least one ready item.
     */
    public boolean hasWorkingMisc(BigInteger flag) {
<span class="nc" id="L4309">        return hasWorkingMisc(flag, -1);</span>
    }

    /**
     * Check if the entity has an arbitrary type of misc equipment
     *
     * @param flag      A MiscType.F_XXX
     * @param secondary A MiscType.S_XXX or -1 for don't care
     * @return true if at least one ready item.
     */
    public boolean hasWorkingMisc(BigInteger flag, long secondary) {
<span class="nc bnc" id="L4320" title="All 2 branches missed.">        for (Mounted m : miscList) {</span>
<span class="nc bnc" id="L4321" title="All 4 branches missed.">            if ((m.getType() instanceof MiscType) &amp;&amp; m.isReady()) {</span>
<span class="nc" id="L4322">                MiscType type = (MiscType) m.getType();</span>
<span class="nc bnc" id="L4323" title="All 4 branches missed.">                if (type.hasFlag(flag)</span>
<span class="nc bnc" id="L4324" title="All 2 branches missed.">                    &amp;&amp; ((secondary == -1) || type.hasSubType(secondary))) {</span>
<span class="nc" id="L4325">                    return true;</span>
                }
            }
<span class="nc" id="L4328">        }</span>
<span class="nc" id="L4329">        return false;</span>
    }

    public boolean hasMisc(BigInteger flag) {
<span class="nc bnc" id="L4333" title="All 2 branches missed.">        for (Mounted m : miscList) {</span>
<span class="nc bnc" id="L4334" title="All 2 branches missed.">            if ((m.getType() instanceof MiscType)) {</span>
<span class="nc" id="L4335">                MiscType type = (MiscType) m.getType();</span>
<span class="nc bnc" id="L4336" title="All 2 branches missed.">                if (type.hasFlag(flag)) {</span>
<span class="nc" id="L4337">                    return true;</span>
                }
            }
<span class="nc" id="L4340">        }</span>
<span class="nc" id="L4341">        return false;</span>
    }

    /**
     * return how many misc equipments with the specified flag the unit has
     *
     * @param flag
     * @return
     */
    public int countWorkingMisc(BigInteger flag) {
<span class="nc" id="L4351">        return countWorkingMisc(flag, -1);</span>
    }

    public int countWorkingMisc(BigInteger flag, int location) {
<span class="nc" id="L4355">        int count = 0;</span>
<span class="nc bnc" id="L4356" title="All 2 branches missed.">        OUTER: for (Mounted m : getMisc()) {</span>
<span class="nc bnc" id="L4357" title="All 6 branches missed.">            if (!m.isInoperable() &amp;&amp; m.getType().hasFlag(flag)</span>
<span class="nc bnc" id="L4358" title="All 2 branches missed.">                    &amp;&amp; ((location == -1) || (m.getLocation() == location))) {</span>
<span class="nc bnc" id="L4359" title="All 2 branches missed.">                if (m.getType().hasModes()) {</span>
<span class="nc bnc" id="L4360" title="All 2 branches missed.">                    for (Enumeration&lt;EquipmentMode&gt; e = m.getType().getModes(); e.hasMoreElements();) {</span>
<span class="nc bnc" id="L4361" title="All 4 branches missed.">                        if (e.nextElement().equals(&quot;On&quot;) &amp;&amp; !m.curMode().equals(&quot;On&quot;)) {</span>
<span class="nc" id="L4362">                            continue OUTER;</span>
                        }
                    }
                }
<span class="nc" id="L4366">                count++;</span>
            }
<span class="nc" id="L4368">        }</span>
<span class="nc" id="L4369">        return count;</span>
    }

    /**
     * Check if the entity has an arbitrary type of misc equipment
     *
     * @param name MiscType internal name
     * @return true if at least one ready item.
     */
    public boolean hasWorkingMisc(String name) {
<span class="nc bnc" id="L4379" title="All 2 branches missed.">        for (Mounted m : miscList) {</span>
<span class="nc bnc" id="L4380" title="All 4 branches missed.">            if ((m.getType() instanceof MiscType) &amp;&amp; m.isReady()) {</span>
<span class="nc" id="L4381">                MiscType type = (MiscType) m.getType();</span>
<span class="nc bnc" id="L4382" title="All 2 branches missed.">                if (type.internalName.equalsIgnoreCase(name)) {</span>
<span class="nc" id="L4383">                    return true;</span>
                }
            }
<span class="nc" id="L4386">        }</span>
<span class="nc" id="L4387">        return false;</span>
    }

    /**
     * Check if the entity has an arbitrary type of misc equipment
     *
     * @param flag      A MiscType.F_XXX
     * @param secondary A MiscType.S_XXX or -1 for don't care
     * @param location  The location to check e.g. Mech.LOC_LARM
     * @return true if at least one ready item.
     */
    public boolean hasWorkingMisc(BigInteger flag, long secondary, int location) {
        // go through the location slot by slot, because of misc equipment that
        // is spreadable
<span class="nc bnc" id="L4401" title="All 2 branches missed.">        for (int slot = 0; slot &lt; getNumberOfCriticals(location); slot++) {</span>
<span class="nc" id="L4402">            CriticalSlot crit = getCritical(location, slot);</span>
<span class="nc bnc" id="L4403" title="All 2 branches missed.">            if ((null != crit)</span>
<span class="nc bnc" id="L4404" title="All 2 branches missed.">                &amp;&amp; (crit.getType() == CriticalSlot.TYPE_EQUIPMENT)) {</span>
<span class="nc" id="L4405">                Mounted mount = crit.getMount();</span>
<span class="nc bnc" id="L4406" title="All 2 branches missed.">                if (mount == null) {</span>
<span class="nc" id="L4407">                    continue;</span>
                }
<span class="nc bnc" id="L4409" title="All 4 branches missed.">                if ((mount.getType() instanceof MiscType) &amp;&amp; mount.isReady()) {</span>
<span class="nc" id="L4410">                    MiscType type = (MiscType) mount.getType();</span>
<span class="nc bnc" id="L4411" title="All 4 branches missed.">                    if (type.hasFlag(flag)</span>
<span class="nc bnc" id="L4412" title="All 2 branches missed.">                        &amp;&amp; ((secondary == -1) || type.hasSubType(secondary))) {</span>
<span class="nc" id="L4413">                        return true;</span>
                    }
                }
            }
        }
<span class="nc" id="L4418">        return false;</span>
    }

    /**
     * Check if the entity has an arbitrary type of weapon
     *
     * @param flag A WeaponType.F_XXX
     */
    public boolean hasWorkingWeapon(BigInteger flag) {
<span class="nc" id="L4427">        return hasWorkingWeapon(flag, -1);</span>
    }

    /**
     * Check if the entity has an arbitrary type of weapon
     *
     * @param flag      A WeaponType.F_XXX
     * @param secondary A WeaponType.S_XXX or -1 for don't care
     * @return true if at least one ready item.
     */
    public boolean hasWorkingWeapon(BigInteger flag, long secondary) {
<span class="nc bnc" id="L4438" title="All 2 branches missed.">        for (Mounted m : weaponList) {</span>
<span class="nc bnc" id="L4439" title="All 4 branches missed.">            if ((m.getType() instanceof WeaponType) &amp;&amp; m.isReady()) {</span>
<span class="nc" id="L4440">                WeaponType type = (WeaponType) m.getType();</span>
<span class="nc bnc" id="L4441" title="All 4 branches missed.">                if (type.hasFlag(flag)</span>
<span class="nc bnc" id="L4442" title="All 2 branches missed.">                    &amp;&amp; ((secondary == -1) || type.hasSubType(secondary))) {</span>
<span class="nc" id="L4443">                    return true;</span>
                }
            }
<span class="nc" id="L4446">        }</span>
<span class="nc" id="L4447">        return false;</span>
    }

    /**
     * Check if the entity has an arbitrary type of weapon
     *
     * @param name internal name of the weapon.
     * @return true if at least one ready item.
     */
    public boolean hasWorkingWeapon(String name) {
<span class="nc bnc" id="L4457" title="All 2 branches missed.">        for (Mounted m : weaponList) {</span>
<span class="nc bnc" id="L4458" title="All 4 branches missed.">            if ((m.getType() instanceof WeaponType) &amp;&amp; m.isReady()) {</span>
<span class="nc" id="L4459">                WeaponType type = (WeaponType) m.getType();</span>
<span class="nc bnc" id="L4460" title="All 2 branches missed.">                if (type.getInternalName().equalsIgnoreCase(name)) {</span>
<span class="nc" id="L4461">                    return true;</span>
                }
            }
<span class="nc" id="L4464">        }</span>
<span class="nc" id="L4465">        return false;</span>
    }

    /**
     * Check if the entity has an arbitrary type of weapon
     *
     * @param flag      A WeaponType.F_XXX
     * @param secondary A WeaponType.S_XXX or -1 for don't care
     * @param location  The location to check e.g. Mech.LOC_LARM
     * @return true if at least one ready item.
     */
    public boolean hasWorkingWeapon(BigInteger flag, int secondary, int location) {
        // go through the location slot by slot, because of misc equipment that
        // is spreadable
<span class="nc bnc" id="L4479" title="All 2 branches missed.">        for (int slot = 0; slot &lt; getNumberOfCriticals(location); slot++) {</span>
<span class="nc" id="L4480">            CriticalSlot crit = getCritical(location, slot);</span>
<span class="nc bnc" id="L4481" title="All 2 branches missed.">            if ((null != crit)</span>
<span class="nc bnc" id="L4482" title="All 2 branches missed.">                &amp;&amp; (crit.getType() == CriticalSlot.TYPE_EQUIPMENT)) {</span>
<span class="nc" id="L4483">                Mounted mount = crit.getMount();</span>
<span class="nc bnc" id="L4484" title="All 2 branches missed.">                if (mount == null) {</span>
<span class="nc" id="L4485">                    continue;</span>
                }
<span class="nc bnc" id="L4487" title="All 4 branches missed.">                if ((mount.getType() instanceof WeaponType) &amp;&amp; mount.isReady()) {</span>
<span class="nc" id="L4488">                    WeaponType type = (WeaponType) mount.getType();</span>
<span class="nc bnc" id="L4489" title="All 4 branches missed.">                    if (type.hasFlag(flag)</span>
<span class="nc bnc" id="L4490" title="All 2 branches missed.">                        &amp;&amp; ((secondary == -1) || type.hasSubType(secondary))) {</span>
<span class="nc" id="L4491">                        return true;</span>
                    }
                }
            }
        }
<span class="nc" id="L4496">        return false;</span>
    }

    /**
     * Returns the amount of heat that the entity can sink each turn.
     */
    public int getHeatCapacity() {
<span class="nc" id="L4503">        return getHeatCapacity(true);</span>
    }

    public abstract int getHeatCapacity(boolean radicalHeatSink);

    /**
     * Returns the amount of heat that the entity can sink each turn, factoring
     * in whether the entity is standing in water.
     */
    public abstract int getHeatCapacityWithWater();

    /**
     * Returns extra heat generated by engine crits
     */
    public abstract int getEngineCritHeat();

    /**
     * Returns a critical hit slot
     */
    public CriticalSlot getCritical(int loc, int slot) {
<span class="nc" id="L4523">        return crits[loc][slot];</span>
    }

    /**
     * Sets a critical hit slot
     */
    public void setCritical(int loc, int slot, CriticalSlot cs) {
<span class="nc" id="L4530">        crits[loc][slot] = cs;</span>
<span class="nc" id="L4531">    }</span>

    /**
     * Adds a critical to the first available slot in the location.
     *
     * @return true if there was room for the critical
     */
    public boolean addCritical(int loc, CriticalSlot cs) {
<span class="nc bnc" id="L4539" title="All 2 branches missed.">        for (int i = 0; i &lt; getNumberOfCriticals(loc); i++) {</span>
<span class="nc bnc" id="L4540" title="All 2 branches missed.">            if (getCritical(loc, i) == null) {</span>
<span class="nc" id="L4541">                crits[loc][i] = cs;</span>
<span class="nc" id="L4542">                return true;</span>
            }
        }
<span class="nc" id="L4545">        return false; // no slot available :(</span>
    }

    /**
     * Adds a critical to a critical slot, first trying the supplied slot
     * number, and continuing from there if it's full
     *
     * @return true if there was room for the critical
     */
    public boolean addCritical(int loc, CriticalSlot cs, int slotNumber) {
<span class="nc bnc" id="L4555" title="All 2 branches missed.">        for (int i = 0; i &lt; getNumberOfCriticals(loc); i++) {</span>
<span class="nc bnc" id="L4556" title="All 2 branches missed.">            if (getCritical(loc, slotNumber) == null) {</span>
<span class="nc" id="L4557">                crits[loc][slotNumber] = cs;</span>
<span class="nc" id="L4558">                return true;</span>
            }
<span class="nc" id="L4560">            slotNumber = (slotNumber + 1) % getNumberOfCriticals(loc);</span>
        }
<span class="nc" id="L4562">        return false; // no slot available :(</span>
    }

    /**
     * Attempts to set the given slot to the given critical. If the desired slot
     * is full, adds the critical to the first available slot.
     *
     * @return true if the crit was succesfully added to any slot
     */
    public boolean addCritical(int loc, int slot, CriticalSlot cs) {
<span class="nc bnc" id="L4572" title="All 2 branches missed.">        if (getCritical(loc, slot) == null) {</span>
<span class="nc" id="L4573">            setCritical(loc, slot, cs);</span>
<span class="nc" id="L4574">            return true;</span>
        }
<span class="nc" id="L4576">        return addCritical(loc, cs);</span>
    }

    /**
     * Removes all matching critical slots from the location
     */
    public void removeCriticals(int loc, CriticalSlot cs) {
<span class="nc bnc" id="L4583" title="All 2 branches missed.">        for (int i = 0; i &lt; getNumberOfCriticals(loc); i++) {</span>
<span class="nc bnc" id="L4584" title="All 4 branches missed.">            if ((getCritical(loc, i) != null) &amp;&amp; getCritical(loc, i).equals(cs)) {</span>
<span class="nc" id="L4585">                setCritical(loc, i, null);</span>
            }
        }
<span class="nc" id="L4588">    }</span>

    /**
     * Returns the number of empty critical slots in a location
     */
    public int getEmptyCriticals(int loc) {
<span class="nc" id="L4594">        int empty = 0;</span>

<span class="nc bnc" id="L4596" title="All 2 branches missed.">        for (int i = 0; i &lt; getNumberOfCriticals(loc); i++) {</span>
<span class="nc bnc" id="L4597" title="All 2 branches missed.">            if (getCritical(loc, i) == null) {</span>
<span class="nc" id="L4598">                empty++;</span>
            }
        }
<span class="nc" id="L4601">        return empty;</span>
    }

    /**
     * Returns the number of operational critical slots remaining in a location
     */
    public int getHittableCriticals(int loc) {
<span class="nc" id="L4608">        int hittable = 0;</span>

<span class="nc bnc" id="L4610" title="All 2 branches missed.">        for (int i = 0; i &lt; getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L4611">            CriticalSlot crit = getCritical(loc, i);</span>
<span class="nc bnc" id="L4612" title="All 4 branches missed.">            if ((crit != null) &amp;&amp; getCritical(loc, i).isHittable()) {</span>
<span class="nc" id="L4613">                hittable++;</span>
            }
            // Reactive armor criticals in a location with armor should count
            // as hittable, evne though they aren't actually hittable
<span class="nc bnc" id="L4617" title="All 2 branches missed.">            else if ((crit != null)</span>
<span class="nc bnc" id="L4618" title="All 2 branches missed.">                    &amp;&amp; (crit.getType() == CriticalSlot.TYPE_EQUIPMENT)</span>
<span class="nc bnc" id="L4619" title="All 2 branches missed.">                    &amp;&amp; (crit.getMount() != null)</span>
<span class="nc bnc" id="L4620" title="All 2 branches missed.">                    &amp;&amp; crit.getMount().getType().hasFlag(MiscType.F_REACTIVE)</span>
<span class="nc bnc" id="L4621" title="All 2 branches missed.">                    &amp;&amp; (getArmor(loc) &gt; 0)) {</span>
<span class="nc" id="L4622">                hittable++;</span>
            }
        }
<span class="nc" id="L4625">        return hittable;</span>
    }

    /**
     * Returns true if this location should transfer criticals to the next
     * location inwards. Checks to see that every critical in this location is
     * either already totally destroyed (not just hit) or was never hittable to
     * begin with.
     */
    public boolean canTransferCriticals(int loc) {
<span class="nc bnc" id="L4635" title="All 2 branches missed.">        for (int i = 0; i &lt; getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L4636">            CriticalSlot crit = getCritical(loc, i);</span>
<span class="nc bnc" id="L4637" title="All 6 branches missed.">            if ((crit != null) &amp;&amp; !crit.isDestroyed() &amp;&amp; crit.isEverHittable()) {</span>
<span class="nc" id="L4638">                return false;</span>
            }
        }
<span class="nc" id="L4641">        return true;</span>
    }

    /**
     * Only Mechs have Gyros but this helps keep the code a bit cleaner.
     *
     * @return &lt;code&gt;-1&lt;/code&gt;
     */
    public int getGyroType() {
<span class="nc" id="L4650">        return -1;</span>
    }

    /**
     * Only Mechs have gyros, but this helps keep the code a bit cleaner.
     *
     * @return true if the &lt;code&gt;Entity&lt;/code&gt; is a Mech and has taken enough gyro hits to destroy it
     */
    public boolean isGyroDestroyed() {
<span class="nc" id="L4659">        return false;</span>
    }

    /**
     * Returns the number of operational critical slots of the specified type in
     * the location
     */
    public int getGoodCriticals(CriticalSlot cs, int loc) {
<span class="nc" id="L4667">        return getGoodCriticals(cs.getType(), cs.getIndex(), loc);</span>
    }

    /**
     * Returns the number of operational critical slots of the specified type in
     * the location
     */
    public int getGoodCriticals(int type, int index, int loc) {
<span class="nc" id="L4675">        int operational = 0;</span>
<span class="nc" id="L4676">        Mounted m = null;</span>
<span class="nc bnc" id="L4677" title="All 2 branches missed.">        if (type == CriticalSlot.TYPE_EQUIPMENT) {</span>
<span class="nc" id="L4678">            m = getEquipment(index);</span>
        }

<span class="nc" id="L4681">        int numberOfCriticals = getNumberOfCriticals(loc);</span>
<span class="nc bnc" id="L4682" title="All 2 branches missed.">        for (int i = 0; i &lt; numberOfCriticals; i++) {</span>
<span class="nc" id="L4683">            CriticalSlot ccs = getCritical(loc, i);</span>

            //  Check to see if this crit mounts the supplied item
            //  For systems, we can compare the index, but for equipment we
            //  need to get the Mounted that is mounted in that index and
            //  compare types.  Superheavies may have two Mounted in each crit
<span class="nc bnc" id="L4689" title="All 4 branches missed.">            if ((ccs != null) &amp;&amp; (ccs.getType() == type)) {</span>
<span class="nc bnc" id="L4690" title="All 4 branches missed.">                if (!ccs.isDestroyed() &amp;&amp; !ccs.isBreached()) {</span>
<span class="nc bnc" id="L4691" title="All 4 branches missed.">                    if ((type == CriticalSlot.TYPE_SYSTEM) &amp;&amp; (ccs.getIndex() == index)) {</span>
<span class="nc" id="L4692">                        operational++;</span>
<span class="nc bnc" id="L4693" title="All 6 branches missed.">                    } else if ((type == CriticalSlot.TYPE_EQUIPMENT) &amp;&amp; (m.equals(ccs.getMount()) || m.equals(ccs</span>
<span class="nc" id="L4694">                                                                                                                      .getMount2()))) {</span>
<span class="nc" id="L4695">                        operational++;</span>
                    }
                }
            }
        }
<span class="nc" id="L4700">        return operational;</span>
    }

    /**
     * The number of critical slots that are destroyed or breached in the
     * location or missing along with it (if it was blown off).
     */
    public int getBadCriticals(int type, int index, int loc) {
<span class="nc" id="L4708">        int hits = 0;</span>
<span class="nc" id="L4709">        Mounted m = null;</span>
<span class="nc bnc" id="L4710" title="All 2 branches missed.">        if (type == CriticalSlot.TYPE_EQUIPMENT) {</span>
<span class="nc" id="L4711">            m = getEquipment(index);</span>
        }

<span class="nc" id="L4714">        int numberOfCriticals = getNumberOfCriticals(loc);</span>
<span class="nc bnc" id="L4715" title="All 2 branches missed.">        for (int i = 0; i &lt; numberOfCriticals; i++) {</span>
<span class="nc" id="L4716">            CriticalSlot ccs = getCritical(loc, i);</span>

            //  Check to see if this crit mounts the supplied item
            //  For systems, we can compare the index, but for equipment we
            //  need to get the Mounted that is mounted in that index and
            //  compare types.  Superheavies may have two Mounted in each crit
<span class="nc bnc" id="L4722" title="All 4 branches missed.">            if ((ccs != null) &amp;&amp; (ccs.getType() == type)) {</span>
<span class="nc bnc" id="L4723" title="All 6 branches missed.">                if (ccs.isDestroyed() || ccs.isBreached() || ccs.isMissing()) {</span>
<span class="nc bnc" id="L4724" title="All 4 branches missed.">                    if ((type == CriticalSlot.TYPE_SYSTEM) &amp;&amp; (ccs.getIndex() == index)) {</span>
<span class="nc" id="L4725">                        hits++;</span>
<span class="nc bnc" id="L4726" title="All 6 branches missed.">                    } else if ((type == CriticalSlot.TYPE_EQUIPMENT) &amp;&amp; (m.equals(ccs.getMount()) || m.equals(ccs</span>
<span class="nc" id="L4727">                                                                                                                      .getMount2()))) {</span>
<span class="nc" id="L4728">                        hits++;</span>
                    }
                }
            }
        }
<span class="nc" id="L4733">        return hits;</span>
    }

    /**
     * Number of slots damaged (but not breached) in a location
     */
    public int getDamagedCriticals(int type, int index, int loc) {
<span class="nc" id="L4740">        int hits = 0;</span>
<span class="nc" id="L4741">        Mounted m = null;</span>
<span class="nc bnc" id="L4742" title="All 2 branches missed.">        if (type == CriticalSlot.TYPE_EQUIPMENT) {</span>
<span class="nc" id="L4743">            m = getEquipment(index);</span>
        }

<span class="nc" id="L4746">        int numberOfCriticals = getNumberOfCriticals(loc);</span>
<span class="nc bnc" id="L4747" title="All 2 branches missed.">        for (int i = 0; i &lt; numberOfCriticals; i++) {</span>
<span class="nc" id="L4748">            CriticalSlot ccs = getCritical(loc, i);</span>

            //  Check to see if this crit mounts the supplied item
            //  For systems, we can compare the index, but for equipment we
            //  need to get the Mounted that is mounted in that index and
            //  compare types.  Superheavies may have two Mounted in each crit
<span class="nc bnc" id="L4754" title="All 4 branches missed.">            if ((ccs != null) &amp;&amp; (ccs.getType() == type)) {</span>
<span class="nc bnc" id="L4755" title="All 2 branches missed.">                if (ccs.isDamaged()) {</span>
<span class="nc bnc" id="L4756" title="All 4 branches missed.">                    if ((type == CriticalSlot.TYPE_SYSTEM) &amp;&amp; (ccs.getIndex() == index)) {</span>
<span class="nc" id="L4757">                        hits++;</span>
<span class="nc bnc" id="L4758" title="All 6 branches missed.">                    } else if ((type == CriticalSlot.TYPE_EQUIPMENT) &amp;&amp; (m.equals(ccs.getMount()) || m.equals(ccs</span>
<span class="nc" id="L4759">                                                                                                                      .getMount2()))) {</span>
<span class="nc" id="L4760">                        hits++;</span>
                    }
                }
            }
        }
<span class="nc" id="L4765">        return hits;</span>
    }

    /**
     * Number of slots doomed, missing or destroyed in a location
     */
    public int getHitCriticals(int type, int index, int loc) {
<span class="nc" id="L4772">        int hits = 0;</span>
<span class="nc" id="L4773">        Mounted m = null;</span>
<span class="nc bnc" id="L4774" title="All 2 branches missed.">        if (type == CriticalSlot.TYPE_EQUIPMENT) {</span>
<span class="nc" id="L4775">            m = getEquipment(index);</span>
        }

<span class="nc" id="L4778">        int numberOfCriticals = getNumberOfCriticals(loc);</span>
<span class="nc bnc" id="L4779" title="All 2 branches missed.">        for (int i = 0; i &lt; numberOfCriticals; i++) {</span>
<span class="nc" id="L4780">            CriticalSlot ccs = getCritical(loc, i);</span>

            //  Check to see if this crit mounts the supplied item
            //  For systems, we can compare the index, but for equipment we
            //  need to get the Mounted that is mounted in that index and
            //  compare types.  Superheavies may have two Mounted in each crit
<span class="nc bnc" id="L4786" title="All 4 branches missed.">            if ((ccs != null) &amp;&amp; (ccs.getType() == type)) {</span>
<span class="nc bnc" id="L4787" title="All 6 branches missed.">                if (ccs.isDamaged() || ccs.isBreached() || ccs.isMissing()) {</span>
<span class="nc bnc" id="L4788" title="All 4 branches missed.">                    if ((type == CriticalSlot.TYPE_SYSTEM) &amp;&amp; (ccs.getIndex() == index)) {</span>
<span class="nc" id="L4789">                        hits++;</span>
<span class="nc bnc" id="L4790" title="All 6 branches missed.">                    } else if ((type == CriticalSlot.TYPE_EQUIPMENT) &amp;&amp; (m.equals(ccs.getMount()) || m.equals(ccs</span>
<span class="nc" id="L4791">                                                                                                                      .getMount2()))) {</span>
<span class="nc" id="L4792">                        hits++;</span>
                    }
                }
            }
        }
<span class="nc" id="L4797">        return hits;</span>
    }

    protected abstract int[] getNoOfSlots();

    /**
     * Returns the number of total critical slots in a location
     */
    public int getNumberOfCriticals(int loc) {
<span class="nc" id="L4806">        int[] noOfSlots = getNoOfSlots();</span>
<span class="nc bnc" id="L4807" title="All 6 branches missed.">        if ((null == noOfSlots) || (loc &gt;= noOfSlots.length)</span>
            || (loc == LOC_NONE)) {
<span class="nc" id="L4809">            return 0;</span>
        }
<span class="nc" id="L4811">        return noOfSlots[loc];</span>
    }

    /**
     * Returns the number of critical slots present in the section, destroyed or
     * not.
     */
    public int getNumberOfCriticals(int type, int index, int loc) {
<span class="nc" id="L4819">        int num = 0;</span>
<span class="nc" id="L4820">        int numCrits = getNumberOfCriticals(loc);</span>
<span class="nc bnc" id="L4821" title="All 2 branches missed.">        for (int i = 0; i &lt; numCrits; i++) {</span>
<span class="nc" id="L4822">            CriticalSlot ccs = getCritical(loc, i);</span>
<span class="nc bnc" id="L4823" title="All 4 branches missed.">            if ((ccs != null) &amp;&amp; (ccs.getType() == type)</span>
<span class="nc bnc" id="L4824" title="All 2 branches missed.">                &amp;&amp; (ccs.getIndex() == index)) {</span>
<span class="nc" id="L4825">                num++;</span>
            }
        }
<span class="nc" id="L4828">        return num;</span>
    }

    /**
     * Returns the number of critical slots present in the section, destroyed or
     * not.
     */
    public int getNumberOfCriticals(EquipmentType etype, int loc) {
<span class="nc" id="L4836">        int num = 0;</span>
<span class="nc" id="L4837">        int numberOfCriticals = getNumberOfCriticals(loc);</span>
<span class="nc bnc" id="L4838" title="All 2 branches missed.">        for (int i = 0; i &lt; numberOfCriticals; i++) {</span>
<span class="nc" id="L4839">            CriticalSlot ccs = getCritical(loc, i);</span>
<span class="nc bnc" id="L4840" title="All 4 branches missed.">            if ((ccs != null) &amp;&amp; (getEquipmentType(ccs) != null)</span>
<span class="nc bnc" id="L4841" title="All 2 branches missed.">                &amp;&amp; getEquipmentType(ccs).equals(etype)) {</span>
<span class="nc" id="L4842">                num++;</span>
            }
        }
<span class="nc" id="L4845">        return num;</span>
    }

    /**
     * Returns the number of critical slots present in the mech, destroyed or
     * not.
     */
    public int getNumberOfCriticals(EquipmentType etype) {
<span class="nc" id="L4853">        int num = 0;</span>
<span class="nc" id="L4854">        int locations = locations();</span>
<span class="nc bnc" id="L4855" title="All 2 branches missed.">        for (int l = 0; l &lt; locations; l++) {</span>
<span class="nc" id="L4856">            num += getNumberOfCriticals(etype, l);</span>
        }
<span class="nc" id="L4858">        return num;</span>
    }

    /**
     * Returns how many of the given equipment are present in the mech,
     * destroyed or not.
     */
    public int getNumberOf(EquipmentType etype) {
<span class="nc" id="L4866">        int total = 0;</span>
<span class="nc bnc" id="L4867" title="All 2 branches missed.">        for (Mounted m : equipmentList) {</span>
<span class="nc bnc" id="L4868" title="All 2 branches missed.">            if (m.getType().equals(etype)) {</span>
<span class="nc" id="L4869">                total++;</span>
            }
<span class="nc" id="L4871">        }</span>
<span class="nc" id="L4872">        return total;</span>
    }

    /**
     * Returns true if the entity has a hip crit. Overridden by sub-classes.
     */
    public boolean hasHipCrit() {
<span class="nc" id="L4879">        return false;</span>
    }

    /**
     * Returns true if the entity has a leg actuator crit
     */
    public boolean hasLegActuatorCrit() {
<span class="nc" id="L4886">        boolean hasCrit = false;</span>

<span class="nc bnc" id="L4888" title="All 2 branches missed.">        for (int i = 0; i &lt; locations(); i++) {</span>
<span class="nc bnc" id="L4889" title="All 2 branches missed.">            if (locationIsLeg(i)) {</span>
<span class="nc bnc" id="L4890" title="All 2 branches missed.">                if ((getBadCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                                     Mech.ACTUATOR_HIP, i) &gt; 0)
<span class="nc bnc" id="L4892" title="All 2 branches missed.">                    || (getBadCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                                        Mech.ACTUATOR_UPPER_LEG, i) &gt; 0)
<span class="nc bnc" id="L4894" title="All 2 branches missed.">                    || (getBadCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                                        Mech.ACTUATOR_LOWER_LEG, i) &gt; 0)
<span class="nc bnc" id="L4896" title="All 2 branches missed.">                    || (getBadCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                                        Mech.ACTUATOR_FOOT, i) &gt; 0)) {
<span class="nc" id="L4898">                    hasCrit = true;</span>
<span class="nc" id="L4899">                    break;</span>
                }
            }
        }
<span class="nc" id="L4903">        return hasCrit;</span>
    }

    /**
     * Returns true if there is at least 1 functional system of the type
     * specified in the location
     */
    public boolean hasWorkingSystem(int system, int loc) {
<span class="nc bnc" id="L4911" title="All 2 branches missed.">        for (int i = 0; i &lt; getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L4912">            CriticalSlot ccs = getCritical(loc, i);</span>
<span class="nc bnc" id="L4913" title="All 4 branches missed.">            if ((ccs != null) &amp;&amp; (ccs.getType() == CriticalSlot.TYPE_SYSTEM)</span>
<span class="nc bnc" id="L4914" title="All 4 branches missed.">                &amp;&amp; (ccs.getIndex() == system) &amp;&amp; !ccs.isDamaged()</span>
<span class="nc bnc" id="L4915" title="All 2 branches missed.">                &amp;&amp; !ccs.isBreached()) {</span>
<span class="nc" id="L4916">                return true;</span>
            }
        }
<span class="nc" id="L4919">        return false;</span>
    }

    /**
     * Returns false if there is at least one non-repairable critical slot for
     * this system in the given location
     */
    public boolean isSystemRepairable(int system, int loc) {
<span class="nc bnc" id="L4927" title="All 2 branches missed.">        for (int i = 0; i &lt; getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L4928">            CriticalSlot ccs = getCritical(loc, i);</span>
<span class="nc bnc" id="L4929" title="All 4 branches missed.">            if ((ccs != null) &amp;&amp; (ccs.getType() == CriticalSlot.TYPE_SYSTEM)</span>
<span class="nc bnc" id="L4930" title="All 4 branches missed.">                &amp;&amp; (ccs.getIndex() == system) &amp;&amp; !ccs.isRepairable()) {</span>
<span class="nc" id="L4931">                return false;</span>
            }
        }
<span class="nc" id="L4934">        return true;</span>
    }

    /**
     * Returns true if the the location has a system of the type, whether is
     * destroyed or not
     */
    public boolean hasSystem(int system, int loc) {
<span class="nc bnc" id="L4942" title="All 2 branches missed.">        for (int i = 0; i &lt; getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L4943">            CriticalSlot ccs = getCritical(loc, i);</span>
<span class="nc bnc" id="L4944" title="All 4 branches missed.">            if ((ccs != null) &amp;&amp; (ccs.getType() == CriticalSlot.TYPE_SYSTEM)</span>
<span class="nc bnc" id="L4945" title="All 2 branches missed.">                &amp;&amp; (ccs.getIndex() == system)) {</span>
<span class="nc" id="L4946">                return true;</span>
            }
        }
<span class="nc" id="L4949">        return false;</span>
    }

    /**
     * Checks to see if this entity is wielding any vibroblades
     *
     * @return always returns &lt;code&gt;false&lt;/code&gt; as Only biped mechs can wield
     * vibroblades
     */
    public boolean hasVibroblades() {
<span class="nc" id="L4959">        return false;</span>
    }

    /**
     * Checks to see if any heat is given off by an active vibro blade
     *
     * @param location
     * @return always returns &lt;code&gt;0&lt;/code&gt; as Only biped mechs can wield
     * vibroblades
     */
    public int getActiveVibrobladeHeat(int location) {
<span class="nc" id="L4970">        return 0;</span>
    }

    public int getActiveVibrobladeHeat(int location, boolean ignoreMode) {
<span class="nc" id="L4974">        return 0;</span>
    }

    /**
     * Does the mech have any shields. a mech can have up to 2 shields.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if &lt;code&gt;shieldCount&lt;/code&gt; is greater than 0
     * else &lt;code&gt;false&lt;/code&gt;
     */
    public boolean hasShield() {
<span class="nc" id="L4984">        return false;</span>
    }

    /**
     * Check to see how many shields of a certian size a mek has. you can have
     * up to shields per mech. However they can be of different size and each
     * size has its own draw backs. So check each size and add modifers based on
     * the number shields of that size.
     */
    public int getNumberOfShields(long size) {
<span class="nc" id="L4994">        return 0;</span>
    }

    /**
     * Does the mech have an active shield This should only be called after
     * hasShield has been called.
     */
    public boolean hasActiveShield(int location, boolean rear) {
<span class="nc" id="L5002">        return true;</span>
    }

    /**
     * Does the mech have an active shield This should only be called by
     * hasActiveShield(location,rear)
     */
    public boolean hasActiveShield(int location) {
<span class="nc" id="L5010">        return false;</span>
    }

    /**
     * Does the mech have a passive shield This should only be called after
     * hasShield has been called.
     */
    public boolean hasPassiveShield(int location, boolean rear) {
<span class="nc" id="L5018">        return false;</span>
    }

    /**
     * Does the mech have a passive shield This should only be called by
     * hasPassiveShield(location,rear)
     */
    public boolean hasPassiveShield(int location) {
<span class="nc" id="L5026">        return false;</span>
    }

    /**
     * Does the mech have an shield in no defense mode
     */
    public boolean hasNoDefenseShield(int location) {
<span class="nc" id="L5033">        return false;</span>
    }

    /**
     * This method checks to see if a unit has Underwater Maneuvering Units
     *
     * @return &lt;code&gt;boolean&lt;/code&gt; if the entity has usable UMU crits.
     */
    public boolean hasUMU() {
<span class="nc bnc" id="L5042" title="All 2 branches missed.">        return getActiveUMUCount() &gt; 0;</span>
    }

    /**
     * This counts the number of UMU's a Mech has that are still viable
     *
     * @return number &lt;code&gt;int&lt;/code&gt;of useable UMU's
     */
    public int getActiveUMUCount() {
<span class="nc bnc" id="L5051" title="All 4 branches missed.">        if (hasShield() &amp;&amp; (getNumberOfShields(MiscType.S_SHIELD_LARGE) &gt; 0)) {</span>
<span class="nc" id="L5052">            return 0;</span>
        }
<span class="nc" id="L5054">        int count = 0;</span>
<span class="nc bnc" id="L5055" title="All 2 branches missed.">        for (Mounted m : getMisc()) {</span>
<span class="nc" id="L5056">            EquipmentType type = m.getType();</span>
<span class="nc bnc" id="L5057" title="All 4 branches missed.">            if ((type instanceof MiscType) &amp;&amp; type.hasFlag(MiscType.F_UMU)</span>
<span class="nc bnc" id="L5058" title="All 6 branches missed.">                &amp;&amp; !(m.isDestroyed() || m.isMissing() || m.isBreached())) {</span>
<span class="nc" id="L5059">                count++;</span>
            }
<span class="nc" id="L5061">        }</span>
<span class="nc" id="L5062">        return count;</span>
    }

    /**
     * This returns all UMU a mech has.
     *
     * @return &lt;code&gt;int&lt;/code&gt;Total number of UMUs a mech has.
     */
    public int getAllUMUCount() {
<span class="nc bnc" id="L5071" title="All 4 branches missed.">        if (hasShield() &amp;&amp; (getNumberOfShields(MiscType.S_SHIELD_LARGE) &gt; 0)) {</span>
<span class="nc" id="L5072">            return 0;</span>
        }
<span class="nc" id="L5074">        int count = 0;</span>
<span class="nc bnc" id="L5075" title="All 2 branches missed.">        for (Mounted m : getMisc()) {</span>
<span class="nc" id="L5076">            EquipmentType type = m.getType();</span>
<span class="nc bnc" id="L5077" title="All 4 branches missed.">            if ((type instanceof MiscType) &amp;&amp; type.hasFlag(MiscType.F_UMU)) {</span>
<span class="nc" id="L5078">                count++;</span>
            }
<span class="nc" id="L5080">        }</span>
<span class="nc" id="L5081">        return count;</span>
    }

    /**
     * Does the mech have a functioning ECM unit?
     */
    public boolean hasActiveECM() {
<span class="nc" id="L5088">        return hasActiveECM(false);</span>
    }

    /**
     * check if we have an active ECM unit for stealth armor purposes
     *
     * @param stealth
     * @return
     */
    public boolean hasActiveECM(boolean stealth) {
        // no ECM in space unless strat op option enabled
<span class="nc bnc" id="L5099" title="All 2 branches missed.">        if (game.getBoard().inSpace()</span>
<span class="nc bnc" id="L5100" title="All 2 branches missed.">            &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ECM)) {</span>
<span class="nc" id="L5101">            return false;</span>
        }
<span class="nc bnc" id="L5103" title="All 2 branches missed.">        if (!isShutDown()) {</span>
<span class="nc bnc" id="L5104" title="All 2 branches missed.">            for (Mounted m : getMisc()) {</span>
<span class="nc" id="L5105">                EquipmentType type = m.getType();</span>
                // EQ equipment does not count for stealth armor
<span class="nc bnc" id="L5107" title="All 4 branches missed.">                if (stealth &amp;&amp; type.hasFlag(MiscType.F_EW_EQUIPMENT)) {</span>
<span class="nc" id="L5108">                    continue;</span>
                }
                // TacOps p. 100 Angle ECM can have 1 ECM and 1 ECCM at the same
                // time
<span class="nc bnc" id="L5112" title="All 2 branches missed.">                if ((type instanceof MiscType)</span>
<span class="nc bnc" id="L5113" title="All 2 branches missed.">                    &amp;&amp; type.hasFlag(MiscType.F_ECM)</span>
<span class="nc bnc" id="L5114" title="All 2 branches missed.">                    &amp;&amp; (m.curMode().equals(&quot;ECM&quot;)</span>
<span class="nc bnc" id="L5115" title="All 2 branches missed.">                        || m.curMode().equals(&quot;ECM &amp; ECCM&quot;) || m</span>
<span class="nc bnc" id="L5116" title="All 2 branches missed.">                        .curMode().equals(&quot;ECM &amp; Ghost Targets&quot;))) {</span>
<span class="nc bnc" id="L5117" title="All 2 branches missed.">                    return !(m.isInoperable());</span>
                }
<span class="nc" id="L5119">            }</span>
        }
<span class="nc" id="L5121">        return false;</span>
    }

    /**
     * Does the mech have a functioning ECM unit?
     */
    public boolean hasActiveAngelECM() {
        // no ECM in space unless strat op option enabled
<span class="nc bnc" id="L5129" title="All 2 branches missed.">        if (game.getBoard().inSpace()</span>
<span class="nc bnc" id="L5130" title="All 2 branches missed.">            &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ECM)) {</span>
<span class="nc" id="L5131">            return false;</span>
        }
<span class="nc bnc" id="L5133" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_ANGEL_ECM)</span>
<span class="nc bnc" id="L5134" title="All 2 branches missed.">            &amp;&amp; !isShutDown()) {</span>
<span class="nc bnc" id="L5135" title="All 2 branches missed.">            for (Mounted m : getMisc()) {</span>
<span class="nc" id="L5136">                EquipmentType type = m.getType();</span>
<span class="nc bnc" id="L5137" title="All 2 branches missed.">                if ((type instanceof MiscType)</span>
<span class="nc bnc" id="L5138" title="All 2 branches missed.">                    &amp;&amp; type.hasFlag(MiscType.F_ANGEL_ECM)</span>
<span class="nc bnc" id="L5139" title="All 2 branches missed.">                    &amp;&amp; (m.curMode().equals(&quot;ECM&quot;)</span>
<span class="nc bnc" id="L5140" title="All 2 branches missed.">                        || m.curMode().equals(&quot;ECM &amp; ECCM&quot;) || m</span>
<span class="nc bnc" id="L5141" title="All 2 branches missed.">                        .curMode().equals(&quot;ECM &amp; Ghost Targets&quot;))) {</span>
<span class="nc bnc" id="L5142" title="All 2 branches missed.">                    return !(m.isInoperable());</span>
                }
<span class="nc" id="L5144">            }</span>
        }
<span class="nc" id="L5146">        return false;</span>
    }

    /**
     * WOR Does the mech have a functioning ECM unit?
     */
    public boolean hasActiveNovaECM() {
        // no ECM in space unless strat op option enabled
<span class="nc bnc" id="L5154" title="All 2 branches missed.">        if (game.getBoard().inSpace()</span>
<span class="nc bnc" id="L5155" title="All 2 branches missed.">            &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ECM)) {</span>
<span class="nc" id="L5156">            return false;</span>
        }
<span class="nc bnc" id="L5158" title="All 2 branches missed.">        if (!isShutDown()) {</span>
<span class="nc bnc" id="L5159" title="All 2 branches missed.">            for (Mounted m : getMisc()) {</span>
<span class="nc" id="L5160">                EquipmentType type = m.getType();</span>
<span class="nc bnc" id="L5161" title="All 4 branches missed.">                if ((type instanceof MiscType) &amp;&amp; type.hasFlag(MiscType.F_NOVA)</span>
<span class="nc bnc" id="L5162" title="All 2 branches missed.">                    &amp;&amp; m.curMode().equals(&quot;ECM&quot;)) {</span>
<span class="nc bnc" id="L5163" title="All 2 branches missed.">                    return !(m.isInoperable());</span>
                }
<span class="nc" id="L5165">            }</span>
        }
<span class="nc" id="L5167">        return false;</span>
    }

    /**
     * Does the mech have a functioning ECM unit, tuned to ghost target
     * generation?
     */

    /**
     * Does the mech have a functioning ECM unit, tuned to ghost target
     * generation?
     */
    public boolean hasGhostTargets(boolean active) {
        // no Ghost Targets in space unless strat op option enabled
<span class="nc bnc" id="L5181" title="All 2 branches missed.">        if (game.getBoard().inSpace()) {</span>
<span class="nc" id="L5182">            return false;</span>
        }

        // if you failed your ghost target PSR, then it doesn't matter
<span class="nc bnc" id="L5186" title="All 6 branches missed.">        if ((active &amp;&amp; (getGhostTargetRollMoS() &lt; 0)) || isShutDown()) {</span>
<span class="nc" id="L5187">            return false;</span>
        }
<span class="nc" id="L5189">        boolean hasGhost = false;</span>
<span class="nc bnc" id="L5190" title="All 2 branches missed.">        for (Mounted m : getMisc()) {</span>
<span class="nc" id="L5191">            EquipmentType type = m.getType();</span>
            // TacOps p. 100 Angle ECM can have ECM/ECCM and Ghost Targets at
            // the same time
<span class="nc bnc" id="L5194" title="All 2 branches missed.">            if ((type instanceof MiscType)</span>
<span class="nc bnc" id="L5195" title="All 2 branches missed.">                &amp;&amp; type.hasFlag(MiscType.F_ECM)</span>
<span class="nc bnc" id="L5196" title="All 2 branches missed.">                &amp;&amp; (m.curMode().equals(&quot;Ghost Targets&quot;)</span>
<span class="nc bnc" id="L5197" title="All 2 branches missed.">                    || m.curMode().equals(&quot;ECM &amp; Ghost Targets&quot;) || m</span>
<span class="nc bnc" id="L5198" title="All 2 branches missed.">                    .curMode().equals(&quot;ECCM &amp; Ghost Targets&quot;))</span>
<span class="nc bnc" id="L5199" title="All 4 branches missed.">                &amp;&amp; !(m.isInoperable() || getCrew().isUnconscious())) {</span>
<span class="nc" id="L5200">                hasGhost = true;</span>
            }
<span class="nc bnc" id="L5202" title="All 2 branches missed.">            if ((type instanceof MiscType)</span>
<span class="nc bnc" id="L5203" title="All 2 branches missed.">                &amp;&amp; type.hasFlag(MiscType.F_COMMUNICATIONS)</span>
<span class="nc bnc" id="L5204" title="All 2 branches missed.">                &amp;&amp; m.curMode().equals(&quot;Ghost Targets&quot;)</span>
<span class="nc bnc" id="L5205" title="All 2 branches missed.">                &amp;&amp; (getTotalCommGearTons() &gt;= 7)</span>
<span class="nc bnc" id="L5206" title="All 4 branches missed.">                &amp;&amp; !(m.isInoperable() || getCrew().isUnconscious())) {</span>
<span class="nc" id="L5207">                hasGhost = true;</span>
            }
<span class="nc" id="L5209">        }</span>
<span class="nc" id="L5210">        return hasGhost;</span>
    }

    /**
     * Checks to see if this entity has a functional ECM unit that is using
     * ECCM.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if the entity has angelecm and it is in ECCM
     * mode &lt;code&gt;false&lt;/code&gt; if the entity does not have angel ecm or
     * it is not in eccm mode or it is damaged.
     */
    public boolean hasActiveECCM() {
        // no ECM in space unless strat op option enabled
<span class="nc bnc" id="L5223" title="All 2 branches missed.">        if (game.getBoard().inSpace()</span>
<span class="nc bnc" id="L5224" title="All 2 branches missed.">            &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ECM)) {</span>
<span class="nc" id="L5225">            return false;</span>
        }
<span class="nc bnc" id="L5227" title="All 2 branches missed.">        if ((game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_ECCM) || game</span>
<span class="nc bnc" id="L5228" title="All 4 branches missed.">                .getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ECM)) &amp;&amp; !isShutDown()) {</span>
<span class="nc bnc" id="L5229" title="All 2 branches missed.">            for (Mounted m : getMisc()) {</span>
<span class="nc" id="L5230">                EquipmentType type = m.getType();</span>
                // TacOps p. 100 Angle ECM can have 1 ECM and 1 ECCM at the same
                // time
<span class="nc bnc" id="L5233" title="All 2 branches missed.">                if ((type instanceof MiscType)</span>
<span class="nc bnc" id="L5234" title="All 2 branches missed.">                    &amp;&amp; ((type.hasFlag(MiscType.F_ECM) &amp;&amp; (m.curMode()</span>
<span class="nc bnc" id="L5235" title="All 2 branches missed.">                                                           .equals(&quot;ECCM&quot;)</span>
<span class="nc bnc" id="L5236" title="All 2 branches missed.">                                                          || m.curMode().equals(&quot;ECM &amp; ECCM&quot;) || m</span>
<span class="nc bnc" id="L5237" title="All 2 branches missed.">                        .curMode().equals(&quot;ECCM &amp; Ghost Targets&quot;))) || (type</span>
<span class="nc bnc" id="L5238" title="All 2 branches missed.">                                                                                .hasFlag(MiscType.F_COMMUNICATIONS) &amp;&amp; m</span>
<span class="nc bnc" id="L5239" title="All 2 branches missed.">                                                                                .curMode().equals(&quot;ECCM&quot;)))) {</span>
<span class="nc bnc" id="L5240" title="All 2 branches missed.">                    return !m.isInoperable();</span>
                }
<span class="nc" id="L5242">            }</span>
        }
<span class="nc" id="L5244">        return false;</span>
    }

    /**
     * Checks to see if this unit has a functional AngelECM unit that is using
     * ECCM.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if the entity has angelecm and it is in ECCM
     * mode &lt;code&gt;false&lt;/code&gt; if the entity does not have angel ecm or
     * it is not in eccm mode or it is damaged.
     */
    public boolean hasActiveAngelECCM() {
<span class="nc bnc" id="L5256" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_ANGEL_ECM)</span>
<span class="nc bnc" id="L5257" title="All 2 branches missed.">            &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_ECCM)</span>
<span class="nc bnc" id="L5258" title="All 2 branches missed.">            &amp;&amp; !isShutDown()) {</span>
<span class="nc bnc" id="L5259" title="All 2 branches missed.">            for (Mounted m : getMisc()) {</span>
<span class="nc" id="L5260">                EquipmentType type = m.getType();</span>
<span class="nc bnc" id="L5261" title="All 2 branches missed.">                if ((type instanceof MiscType)</span>
<span class="nc bnc" id="L5262" title="All 2 branches missed.">                    &amp;&amp; type.hasFlag(MiscType.F_ANGEL_ECM)</span>
<span class="nc bnc" id="L5263" title="All 2 branches missed.">                    &amp;&amp; (m.curMode().equals(&quot;ECCM&quot;)</span>
<span class="nc bnc" id="L5264" title="All 2 branches missed.">                        || m.curMode().equals(&quot;ECM &amp; ECCM&quot;) || m</span>
<span class="nc bnc" id="L5265" title="All 2 branches missed.">                        .curMode().equals(&quot;ECCM &amp; Ghost Targets&quot;))) {</span>
<span class="nc bnc" id="L5266" title="All 8 branches missed.">                    return !(m.isDestroyed() || m.isMissing() || m.isBreached() || isShutDown());</span>
                }
<span class="nc" id="L5268">            }</span>
        }
<span class="nc" id="L5270">        return false;</span>
    }

    /**
     * What's the range of the ECM equipment? Infantry can have ECM that just
     * covers their own hex.
     *
     * @return the &lt;code&gt;int&lt;/code&gt; range of this unit's ECM. This value will be
     * &lt;code&gt;Entity.NONE&lt;/code&gt; if no ECM is active.
     */
    public int getECMRange() {
        // no ECM in space unless strat op option enabled
<span class="nc bnc" id="L5282" title="All 2 branches missed.">        if (game.getBoard().inSpace()</span>
<span class="nc bnc" id="L5283" title="All 2 branches missed.">            &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ECM)) {</span>
<span class="nc" id="L5284">            return Entity.NONE;</span>
        }
        // If we have stealth up and running, there's no bubble.
<span class="nc bnc" id="L5287" title="All 2 branches missed.">        if (isStealthOn()) {</span>
<span class="nc" id="L5288">            return Entity.NONE;</span>
        }

<span class="nc bnc" id="L5291" title="All 2 branches missed.">        if (!isShutDown()) {</span>
<span class="nc bnc" id="L5292" title="All 2 branches missed.">            for (Mounted m : getMisc()) {</span>
<span class="nc" id="L5293">                EquipmentType type = m.getType();</span>
<span class="nc bnc" id="L5294" title="All 4 branches missed.">                if ((type instanceof MiscType) &amp;&amp; type.hasFlag(MiscType.F_ECM)</span>
<span class="nc bnc" id="L5295" title="All 2 branches missed.">                    &amp;&amp; !m.isInoperable()) {</span>
<span class="nc bnc" id="L5296" title="All 2 branches missed.">                    if (type.hasFlag(MiscType.F_SINGLE_HEX_ECM)) {</span>
<span class="nc" id="L5297">                        return 0;</span>
                    }
<span class="nc" id="L5299">                    int toReturn = 6;</span>
<span class="nc bnc" id="L5300" title="All 4 branches missed.">                    if (type.hasFlag(MiscType.F_ANGEL_ECM)</span>
                        &amp;&amp; (this instanceof BattleArmor)) {
<span class="nc" id="L5302">                        toReturn = 2;</span>
                    }
<span class="nc bnc" id="L5304" title="All 2 branches missed.">                    if (type.hasFlag(MiscType.F_EW_EQUIPMENT)</span>
<span class="nc bnc" id="L5305" title="All 2 branches missed.">                        || type.hasFlag(MiscType.F_NOVA)</span>
<span class="nc bnc" id="L5306" title="All 2 branches missed.">                        || type.hasFlag(MiscType.F_WATCHDOG)) {</span>
<span class="nc" id="L5307">                        toReturn = 3;</span>
                    }
<span class="nc bnc" id="L5309" title="All 2 branches missed.">                    if (game.getPlanetaryConditions().hasEMI()) {</span>
<span class="nc" id="L5310">                        return toReturn * 2;</span>
                    }
<span class="nc" id="L5312">                    return toReturn;</span>
                }
<span class="nc" id="L5314">            }</span>
        }
<span class="nc" id="L5316">        return Entity.NONE;</span>
    }

    /**
     * Does the mech have a functioning BAP? This is just for the basic BAP for
     * Beagle BloodHound WatchDog Clan Active or Light.
     */
    public boolean hasBAP() {
<span class="nc" id="L5324">        return hasBAP(true);</span>
    }
    
    /**
     * Does a unit on the same C3 network have a BAP?
     * Used to share BAP targeting bonuses against targets in woods
     * @return
     */
    public boolean hasNetworkBAP() {
<span class="nc" id="L5333">        return networkBAP;</span>
    }
    
    public void setNetworkBAP(boolean BAP) {
<span class="nc" id="L5337">        networkBAP = BAP;</span>
<span class="nc" id="L5338">    }</span>

    public boolean hasBAP(boolean checkECM) {
<span class="nc bnc" id="L5341" title="All 4 branches missed.">        if (((game != null) &amp;&amp; game.getPlanetaryConditions().hasEMI())</span>
<span class="nc bnc" id="L5342" title="All 2 branches missed.">            || isShutDown()) {</span>
<span class="nc" id="L5343">            return false;</span>
        }
<span class="nc bnc" id="L5345" title="All 2 branches missed.">        for (Mounted m : getMisc()) {</span>
<span class="nc" id="L5346">            EquipmentType type = m.getType();</span>
<span class="nc bnc" id="L5347" title="All 4 branches missed.">            if ((type instanceof MiscType) &amp;&amp; type.hasFlag(MiscType.F_BAP)) {</span>

<span class="nc bnc" id="L5349" title="All 2 branches missed.">                if (!m.isInoperable()) {</span>
                    // Beagle Isn't affected by normal ECM
<span class="nc bnc" id="L5351" title="All 2 branches missed.">                    if (type.getName().equals(&quot;Beagle Active Probe&quot;)) {</span>

<span class="nc bnc" id="L5353" title="All 4 branches missed.">                        if ((game != null)</span>
                            &amp;&amp; checkECM
<span class="nc bnc" id="L5355" title="All 2 branches missed.">                            &amp;&amp; ComputeECM.isAffectedByAngelECM(this,</span>
<span class="nc" id="L5356">                                                               getPosition(), getPosition())) {</span>
<span class="nc" id="L5357">                            return false;</span>
                        }
<span class="nc" id="L5359">                        return true;</span>
                    }
<span class="nc bnc" id="L5361" title="All 4 branches missed.">                    return !checkECM</span>
                           || (game == null)
<span class="nc bnc" id="L5363" title="All 2 branches missed.">                           || !ComputeECM.isAffectedByECM(this, getPosition(),</span>
<span class="nc" id="L5364">                                                          getPosition());</span>
                }
            }
<span class="nc" id="L5367">        }</span>

        // check for Manei Domini implants
<span class="nc bnc" id="L5370" title="All 2 branches missed.">        if (((hasAbility(OptionsConstants.MD_CYBER_IMP_AUDIO)</span>
<span class="nc bnc" id="L5371" title="All 2 branches missed.">        	|| hasAbility(OptionsConstants.MD_CYBER_IMP_VISUAL)</span>
<span class="nc bnc" id="L5372" title="All 6 branches missed.">        	|| hasAbility(OptionsConstants.MD_MM_IMPLANTS))</span>
        		&amp;&amp; (this instanceof Infantry) &amp;&amp; !(this instanceof BattleArmor))
<span class="nc bnc" id="L5374" title="All 2 branches missed.">            || (hasAbility(OptionsConstants.MD_MM_IMPLANTS)</span>
<span class="nc bnc" id="L5375" title="All 2 branches missed.">            		&amp;&amp; (hasAbility(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L5376" title="All 2 branches missed.">			|| hasAbility(OptionsConstants.MD_BVDNI))))</span>

        {
<span class="nc bnc" id="L5379" title="All 2 branches missed.">            return !checkECM</span>
<span class="nc bnc" id="L5380" title="All 2 branches missed.">                   || !ComputeECM.isAffectedByECM(this, getPosition(),</span>
<span class="nc" id="L5381">                                                  getPosition());</span>
        }
        // check for quirk
<span class="nc bnc" id="L5384" title="All 2 branches missed.">        if (hasQuirk(OptionsConstants.QUIRK_POS_IMPROVED_SENSORS)) {</span>
<span class="nc bnc" id="L5385" title="All 2 branches missed.">            return !checkECM</span>
<span class="nc bnc" id="L5386" title="All 2 branches missed.">                   || !ComputeECM.isAffectedByECM(this, getPosition(),</span>
<span class="nc" id="L5387">                                                  getPosition());</span>
        }
        // check for SPA
<span class="nc bnc" id="L5390" title="All 2 branches missed.">        if (hasAbility(OptionsConstants.MISC_EAGLE_EYES)) {</span>
<span class="nc bnc" id="L5391" title="All 4 branches missed.">            return !checkECM || !ComputeECM.isAffectedByECM(this, getPosition(), getPosition());</span>
        }

<span class="nc" id="L5394">        return false;</span>
    }

    /**
     * What's the range of the BAP equipment?
     *
     * @return the &lt;code&gt;int&lt;/code&gt; range of this unit's BAP. This value will be
     * &lt;code&gt;Entity.NONE&lt;/code&gt; if no BAP is active.
     */
    public int getBAPRange() {
<span class="nc bnc" id="L5404" title="All 4 branches missed.">        if (game.getPlanetaryConditions().hasEMI() || isShutDown()) {</span>
<span class="nc" id="L5405">            return Entity.NONE;</span>
        }
        // check for Manei Domini implants
<span class="nc" id="L5408">        int cyberBonus = 0;</span>
<span class="nc bnc" id="L5409" title="All 2 branches missed.">        if (((hasAbility(OptionsConstants.MD_CYBER_IMP_AUDIO)</span>
<span class="nc bnc" id="L5410" title="All 2 branches missed.">        		|| hasAbility(OptionsConstants.MD_MM_IMPLANTS))</span>
<span class="nc bnc" id="L5411" title="All 6 branches missed.">        		|| hasAbility(OptionsConstants.MD_CYBER_IMP_VISUAL)</span>
                	&amp;&amp; (this instanceof Infantry) &amp;&amp; !(this instanceof BattleArmor))
<span class="nc bnc" id="L5413" title="All 2 branches missed.">                || (hasAbility(OptionsConstants.MD_MM_IMPLANTS)</span>
<span class="nc bnc" id="L5414" title="All 2 branches missed.">                	&amp;&amp; (hasAbility(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L5415" title="All 2 branches missed.">    			|| hasAbility(OptionsConstants.MD_BVDNI)))) {</span>
<span class="nc" id="L5416">            cyberBonus = 2;</span>
        }

        // check for quirks
<span class="nc" id="L5420">        int quirkBonus = 0;</span>
<span class="nc bnc" id="L5421" title="All 2 branches missed.">        if (hasQuirk(OptionsConstants.QUIRK_POS_IMPROVED_SENSORS)) {</span>
<span class="nc bnc" id="L5422" title="All 2 branches missed.">            if (isClan()) {</span>
<span class="nc" id="L5423">                quirkBonus = 5;</span>
            } else {
<span class="nc" id="L5425">                quirkBonus = 4;</span>
            }
        }

        // check for SPA
<span class="nc" id="L5430">        int spaBonus = 0;</span>
<span class="nc bnc" id="L5431" title="All 2 branches missed.">        if (hasAbility(OptionsConstants.MISC_EAGLE_EYES)) {</span>
<span class="nc" id="L5432">            spaBonus = 1;</span>
        }

<span class="nc bnc" id="L5435" title="All 2 branches missed.">        for (Mounted m : getMisc()) {</span>
<span class="nc" id="L5436">            EquipmentType type = m.getType();</span>
<span class="nc bnc" id="L5437" title="All 4 branches missed.">            if ((type instanceof MiscType) &amp;&amp; type.hasFlag(MiscType.F_BAP)</span>
<span class="nc bnc" id="L5438" title="All 2 branches missed.">                &amp;&amp; !m.isInoperable()) {</span>

                // Quirk bonus is only 2 if equiped with BAP
<span class="nc bnc" id="L5441" title="All 2 branches missed.">                if (quirkBonus &gt; 0) {</span>
<span class="nc" id="L5442">                    quirkBonus = 2;</span>
                }
                // System.err.println(&quot;BAP type name: &quot;+m.getName()+&quot;
                // internalName: &quot;+((MiscType)m.getType()).internalName);
                // in space the range of all BAPs is given by the mode
<span class="nc bnc" id="L5447" title="All 2 branches missed.">                if (game.getBoard().inSpace()) {</span>
<span class="nc bnc" id="L5448" title="All 2 branches missed.">                    if (m.curMode().equals(&quot;Medium&quot;)) {</span>
<span class="nc" id="L5449">                        return 12;</span>
                    }
<span class="nc" id="L5451">                    return 6;</span>
                }

<span class="nc bnc" id="L5454" title="All 2 branches missed.">                if (m.getName().equals(&quot;Bloodhound Active Probe (THB)&quot;)</span>
<span class="nc bnc" id="L5455" title="All 2 branches missed.">                    || m.getName().equals(Sensor.BAP)) {</span>
<span class="nc" id="L5456">                    return 8 + cyberBonus + quirkBonus + spaBonus;</span>
                }
<span class="nc bnc" id="L5458" title="All 2 branches missed.">                if ((m.getType()).getInternalName().equals(Sensor.CLAN_AP)</span>
<span class="nc bnc" id="L5459" title="All 2 branches missed.">                    || (m.getType()).getInternalName().equals(</span>
                        Sensor.WATCHDOG)
<span class="nc bnc" id="L5461" title="All 2 branches missed.">                    || (m.getType()).getInternalName().equals(Sensor.NOVA)) {</span>
<span class="nc" id="L5462">                    return 5 + cyberBonus + quirkBonus + spaBonus;</span>
                }
<span class="nc bnc" id="L5464" title="All 2 branches missed.">                if ((m.getType()).getInternalName().equals(Sensor.LIGHT_AP)</span>
<span class="nc" id="L5465">                    || (m.getType().getInternalName()</span>
<span class="nc bnc" id="L5466" title="All 2 branches missed.">                         .equals(Sensor.CLBALIGHT_AP))</span>
<span class="nc" id="L5467">                    || (m.getType().getInternalName()</span>
<span class="nc bnc" id="L5468" title="All 2 branches missed.">                         .equals(Sensor.ISBALIGHT_AP))) {</span>
<span class="nc" id="L5469">                    return 3 + cyberBonus + quirkBonus + spaBonus;</span>
                }
<span class="nc bnc" id="L5471" title="All 2 branches missed.">                if (m.getType().getInternalName().equals(Sensor.ISIMPROVED)</span>
<span class="nc" id="L5472">                    || (m.getType().getInternalName()</span>
<span class="nc bnc" id="L5473" title="All 2 branches missed.">                         .equals(Sensor.CLIMPROVED))) {</span>
<span class="nc" id="L5474">                    return 2 + cyberBonus + quirkBonus + spaBonus;</span>
                }
<span class="nc" id="L5476">                return 4 + cyberBonus + quirkBonus + spaBonus;// everthing else should be</span>
                // range 4
            }
<span class="nc" id="L5479">        }</span>
<span class="nc bnc" id="L5480" title="All 2 branches missed.">        if ((cyberBonus + quirkBonus + spaBonus) &gt; 0) {</span>
<span class="nc" id="L5481">            return cyberBonus + quirkBonus + spaBonus;</span>
        }

<span class="nc" id="L5484">        return Entity.NONE;</span>
    }

    /**
     * Returns wether or not this entity has a Targeting Computer.
     */
    public boolean hasTargComp() {
<span class="nc bnc" id="L5491" title="All 2 branches missed.">        for (Mounted m : getMisc()) {</span>
<span class="nc bnc" id="L5492" title="All 2 branches missed.">            if ((m.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L5493" title="All 2 branches missed.">                &amp;&amp; m.getType().hasFlag(MiscType.F_TARGCOMP)) {</span>
<span class="nc bnc" id="L5494" title="All 2 branches missed.">                return !m.isInoperable();</span>
            }
<span class="nc" id="L5496">        }</span>
<span class="nc" id="L5497">        return false;</span>
    }

    /**
     * Returns wether or not this entity has a Targeting Computer that is in
     * aimed shot mode.
     */
    public boolean hasAimModeTargComp() {
<span class="nc bnc" id="L5505" title="All 2 branches missed.">        if (hasActiveEiCockpit()) {</span>
<span class="nc bnc" id="L5506" title="All 2 branches missed.">            if (this instanceof Mech) {</span>
<span class="nc bnc" id="L5507" title="All 2 branches missed.">                if (((Mech) this).getCockpitStatus() == Mech.COCKPIT_AIMED_SHOT) {</span>
<span class="nc" id="L5508">                    return true;</span>
                }
            } else {
<span class="nc" id="L5511">                return true;</span>
            }
        }
<span class="nc bnc" id="L5514" title="All 2 branches missed.">        for (Mounted m : getMisc()) {</span>
<span class="nc bnc" id="L5515" title="All 2 branches missed.">            if ((m.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L5516" title="All 2 branches missed.">                &amp;&amp; m.getType().hasFlag(MiscType.F_TARGCOMP)</span>
<span class="nc bnc" id="L5517" title="All 2 branches missed.">                &amp;&amp; m.curMode().equals(&quot;Aimed shot&quot;)) {</span>
<span class="nc bnc" id="L5518" title="All 2 branches missed.">                return !m.isInoperable();</span>
            }
<span class="nc" id="L5520">        }</span>
<span class="nc" id="L5521">        return false;</span>
    }

    /**
     * Returns whether this 'mech has a C3 Slave or not.
     */
    public boolean hasC3S() {
<span class="nc bnc" id="L5528" title="All 4 branches missed.">        if (isShutDown() || isOffBoard()) {</span>
<span class="nc" id="L5529">            return false;</span>
        }
<span class="nc bnc" id="L5531" title="All 2 branches missed.">        for (Mounted m : getEquipment()) {</span>
<span class="nc bnc" id="L5532" title="All 2 branches missed.">            if ((m.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L5533" title="All 2 branches missed.">                &amp;&amp; (m.getType().hasFlag(MiscType.F_C3S) || m.getType()</span>
<span class="nc bnc" id="L5534" title="All 4 branches missed.">                                                            .hasFlag(MiscType.F_C3SBS)) &amp;&amp; !m.isInoperable()) {</span>
<span class="nc" id="L5535">                return true;</span>
            }
<span class="nc" id="L5537">        }</span>
<span class="nc" id="L5538">        return false;</span>
    }

    /**
     * Only Meks can have CASE II so all other entites return false.
     *
     * @return true iff the mech has CASE II.
     */
    public boolean hasCASEII() {
<span class="nc" id="L5547">        return false;</span>
    }

    /**
     * Only Meks have CASE II so all other entites return false.
     *
     * @param location
     * @return true iff the mech has CASE II at this location.
     */
    public boolean hasCASEII(int location) {
<span class="nc" id="L5557">        return false;</span>
    }

    /**
     * Does this entity have an undamaged HarJel system in this location?
     * (Type-dependent, defaults to false.)
     * Does not include Harjel II or Harjel III, as they do not prevent breach
     * checks like Harjel does.
     *
     * @param location the &lt;code&gt;int&lt;/code&gt; location to check
     * @return a &lt;code&gt;boolean&lt;/code&gt; value indicating a present HarJel system
     */
    public boolean hasHarJelIn(int location) {
<span class="nc bnc" id="L5570" title="All 2 branches missed.">        for (Mounted mounted : getMisc()) {</span>
<span class="nc bnc" id="L5571" title="All 2 branches missed.">            if ((mounted.getLocation() == location)</span>
<span class="nc bnc" id="L5572" title="All 2 branches missed.">                &amp;&amp; mounted.isReady()</span>
<span class="nc bnc" id="L5573" title="All 2 branches missed.">                &amp;&amp; (mounted.getType().hasFlag(MiscType.F_HARJEL))) {</span>
<span class="nc" id="L5574">                return true;</span>
            }
<span class="nc" id="L5576">        }</span>
<span class="nc" id="L5577">        return false;</span>
    }

    public boolean hasBoostedC3() {
<span class="nc bnc" id="L5581" title="All 4 branches missed.">        if (isShutDown() || isOffBoard()) {</span>
<span class="nc" id="L5582">            return false;</span>
        }
<span class="nc bnc" id="L5584" title="All 2 branches missed.">        for (Mounted m : getEquipment()) {</span>
<span class="nc bnc" id="L5585" title="All 4 branches missed.">            if ((m.getType().hasFlag(MiscType.F_C3SBS) || m.getType().hasFlag(</span>
                    WeaponType.F_C3MBS))
<span class="nc bnc" id="L5587" title="All 2 branches missed.">                &amp;&amp; !m.isInoperable()) {</span>
<span class="nc" id="L5588">                return true;</span>
            }
<span class="nc" id="L5590">        }</span>
<span class="nc" id="L5591">        return false;</span>
    }

    /**
     * Checks if the entity has a C3 Master.
     *
     * @return true if it has a working C3M computer and has a master.
     */
    public boolean hasC3M() {
<span class="nc bnc" id="L5600" title="All 4 branches missed.">        if (isShutDown() || isOffBoard()) {</span>
<span class="nc" id="L5601">            return false;</span>
        }
<span class="nc bnc" id="L5603" title="All 2 branches missed.">        for (Mounted m : getEquipment()) {</span>
<span class="nc bnc" id="L5604" title="All 2 branches missed.">            if ((m.getType() instanceof WeaponType)</span>
<span class="nc bnc" id="L5605" title="All 2 branches missed.">                &amp;&amp; (m.getType().hasFlag(WeaponType.F_C3M) || m.getType()</span>
<span class="nc bnc" id="L5606" title="All 4 branches missed.">                                                              .hasFlag(WeaponType.F_C3MBS)) &amp;&amp; !m.isInoperable()) {</span>
                // If this unit is configured as a company commander,
                // and if this computer is the company master, then
                // this unit does not have a lance master computer.
<span class="nc bnc" id="L5610" title="All 2 branches missed.">                if (C3MasterIs(this)</span>
<span class="nc bnc" id="L5611" title="All 2 branches missed.">                    &amp;&amp; (c3CompanyMasterIndex == getEquipmentNum(m))) {</span>
<span class="nc" id="L5612">                    return false;</span>
                }
<span class="nc" id="L5614">                return true;</span>
            }
<span class="nc" id="L5616">        }</span>
<span class="nc" id="L5617">        return false;</span>
    }

    public boolean hasC3MM() {
<span class="nc bnc" id="L5621" title="All 4 branches missed.">        if (isShutDown() || isOffBoard()) {</span>
<span class="nc" id="L5622">            return false;</span>
        }

        // Have we already determined that there's no company command master?
<span class="nc bnc" id="L5626" title="All 2 branches missed.">        if (c3CompanyMasterIndex == LOC_NONE) {</span>
<span class="nc" id="L5627">            return false;</span>
        }

        // Do we need to determine that there's no company command master?
<span class="nc bnc" id="L5631" title="All 2 branches missed.">        if (c3CompanyMasterIndex == LOC_DESTROYED) {</span>
<span class="nc" id="L5632">            Iterator&lt;Mounted&gt; e = getEquipment().iterator();</span>
<span class="nc bnc" id="L5633" title="All 4 branches missed.">            while ((c3CompanyMasterIndex == LOC_DESTROYED) &amp;&amp; e.hasNext()) {</span>
<span class="nc" id="L5634">                Mounted m = e.next();</span>
<span class="nc bnc" id="L5635" title="All 2 branches missed.">                if ((m.getType() instanceof WeaponType)</span>
<span class="nc bnc" id="L5636" title="All 2 branches missed.">                    &amp;&amp; (m.getType().hasFlag(WeaponType.F_C3M) || m</span>
<span class="nc bnc" id="L5637" title="All 2 branches missed.">                        .getType().hasFlag(WeaponType.F_C3MBS))</span>
<span class="nc bnc" id="L5638" title="All 2 branches missed.">                    &amp;&amp; !m.isInoperable()) {</span>
                    // Now look for the company command master.
<span class="nc bnc" id="L5640" title="All 2 branches missed.">                    while ((c3CompanyMasterIndex == LOC_DESTROYED)</span>
<span class="nc bnc" id="L5641" title="All 2 branches missed.">                           &amp;&amp; e.hasNext()) {</span>
<span class="nc" id="L5642">                        m = e.next();</span>
<span class="nc bnc" id="L5643" title="All 2 branches missed.">                        if ((m.getType() instanceof WeaponType)</span>
<span class="nc bnc" id="L5644" title="All 2 branches missed.">                            &amp;&amp; (m.getType().hasFlag(WeaponType.F_C3M) || m</span>
<span class="nc bnc" id="L5645" title="All 2 branches missed.">                                .getType().hasFlag(WeaponType.F_C3MBS))</span>
<span class="nc bnc" id="L5646" title="All 2 branches missed.">                            &amp;&amp; !m.isInoperable()) {</span>
                            // Found the comany command master
<span class="nc" id="L5648">                            c3CompanyMasterIndex = getEquipmentNum(m);</span>
                        }
                    }
                }
<span class="nc" id="L5652">            }</span>
            // If we haven't found the company command master, there is none.
<span class="nc bnc" id="L5654" title="All 2 branches missed.">            if (c3CompanyMasterIndex == LOC_DESTROYED) {</span>
<span class="nc" id="L5655">                c3CompanyMasterIndex = LOC_NONE;</span>
<span class="nc" id="L5656">                return false;</span>
            }
        }

<span class="nc" id="L5660">        Mounted m = getEquipment(c3CompanyMasterIndex);</span>
<span class="nc bnc" id="L5661" title="All 4 branches missed.">        if (!m.isDestroyed() &amp;&amp; !m.isBreached()) {</span>
<span class="nc" id="L5662">            return true;</span>
        }
<span class="nc" id="L5664">        return false;</span>
    }

    /**
     * Checks if it has any type of C3 computer.
     *
     * @return true iff it has a C3 computer.
     */
    public boolean hasC3() {
<span class="nc bnc" id="L5673" title="All 6 branches missed.">        return hasC3S() || hasC3M() || hasC3MM();</span>
    }

    /**
     * Checks if we have nova CEWS that is not offline.
     *
     * @return
     */
    public boolean hasActiveNovaCEWS() {
<span class="nc bnc" id="L5682" title="All 4 branches missed.">        if (isShutDown() || isOffBoard()) {</span>
<span class="nc" id="L5683">            return false;</span>
        }
<span class="nc bnc" id="L5685" title="All 2 branches missed.">        for (Mounted m : getEquipment()) {</span>
<span class="nc bnc" id="L5686" title="All 2 branches missed.">            if ((m.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L5687" title="All 2 branches missed.">                &amp;&amp; m.getType().hasFlag(MiscType.F_NOVA)</span>
<span class="nc bnc" id="L5688" title="All 4 branches missed.">                &amp;&amp; !m.isInoperable() &amp;&amp; !m.curMode().equals(&quot;Off&quot;)) {</span>
<span class="nc" id="L5689">                return true;</span>
            }
<span class="nc" id="L5691">        }</span>
<span class="nc" id="L5692">        return false;</span>
    }

    public boolean hasNovaCEWS() {
<span class="nc bnc" id="L5696" title="All 2 branches missed.">        for (Mounted m : getEquipment()) {</span>
<span class="nc bnc" id="L5697" title="All 2 branches missed.">            if ((m.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L5698" title="All 2 branches missed.">                &amp;&amp; m.getType().hasFlag(MiscType.F_NOVA)</span>
<span class="nc bnc" id="L5699" title="All 2 branches missed.">                &amp;&amp; !m.isInoperable()) {</span>
<span class="nc" id="L5700">                return true;</span>
            }
<span class="nc" id="L5702">        }</span>
<span class="nc" id="L5703">        return false;</span>
    }

    public boolean hasNavalC3() {
<span class="nc bnc" id="L5707" title="All 4 branches missed.">        if (isShutDown() || isOffBoard()) {</span>
<span class="nc" id="L5708">            return false;</span>
        }
<span class="nc bnc" id="L5710" title="All 2 branches missed.">        for (Mounted m : getEquipment()) {</span>
<span class="nc bnc" id="L5711" title="All 2 branches missed.">            if ((m.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L5712" title="All 4 branches missed.">                &amp;&amp; m.getType().hasFlag(MiscType.F_NAVAL_C3) &amp;&amp; !m.isInoperable()) {</span>
<span class="nc" id="L5713">                return true;</span>
            }
<span class="nc" id="L5715">        }</span>
<span class="nc" id="L5716">        return false;</span>
    }

    public boolean hasC3i() {
<span class="nc bnc" id="L5720" title="All 4 branches missed.">        if (isShutDown() || isOffBoard()) {</span>
<span class="nc" id="L5721">            return false;</span>
        }
<span class="nc bnc" id="L5723" title="All 2 branches missed.">        for (Mounted m : getEquipment()) {</span>
<span class="nc bnc" id="L5724" title="All 2 branches missed.">            if ((m.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L5725" title="All 4 branches missed.">                &amp;&amp; m.getType().hasFlag(MiscType.F_C3I) &amp;&amp; !m.isInoperable()) {</span>
<span class="nc" id="L5726">                return true;</span>
            }
<span class="nc" id="L5728">        }</span>
        // check for Manei Domini implants
<span class="nc bnc" id="L5730" title="All 4 branches missed.">        if ((this instanceof Infantry) &amp;&amp; (null != crew)</span>
                //Fix for Bug Report #1194
<span class="nc bnc" id="L5732" title="All 2 branches missed.">            &amp;&amp; hasAbility(OptionsConstants.MD_ENH_MM_IMPLANTS)</span>
<span class="nc bnc" id="L5733" title="All 2 branches missed.">            &amp;&amp; hasAbility(OptionsConstants.MD_BOOST_COMM_IMPLANT)) {</span>
<span class="nc" id="L5734">            return true;</span>
        }
<span class="nc" id="L5736">        return false;</span>
    }

    public String getC3NetId() {
<span class="nc bnc" id="L5740" title="All 2 branches missed.">        if (c3NetIdString == null) {</span>
<span class="nc bnc" id="L5741" title="All 2 branches missed.">            if (hasC3()) {</span>
<span class="nc" id="L5742">                c3NetIdString = &quot;C3.&quot; + getId();</span>
<span class="nc bnc" id="L5743" title="All 2 branches missed.">            } else if (hasC3i()) {</span>
<span class="nc" id="L5744">                c3NetIdString = &quot;C3i.&quot; + getId();</span>
<span class="nc bnc" id="L5745" title="All 2 branches missed.">            } else if (hasActiveNovaCEWS()) {</span>
<span class="nc" id="L5746">                c3NetIdString = &quot;C3Nova.&quot; + getId();</span>
<span class="nc bnc" id="L5747" title="All 2 branches missed.">            } else if (hasNavalC3()) {</span>
<span class="nc" id="L5748">                c3NetIdString = &quot;NC3.&quot; + getId();</span>
            }
        }
<span class="nc" id="L5751">        return c3NetIdString;</span>
    }

    public String getOriginalNovaC3NetId() {
<span class="nc" id="L5755">        return &quot;C3Nova.&quot; + getId();</span>
    }

    /**
     * Switches the C3 network Id to the new network ID.
     */
    public void newRoundNovaNetSwitch() {
<span class="nc bnc" id="L5762" title="All 2 branches missed.">        if (hasNovaCEWS()) {</span>
            // FIXME: no check for network limit of 3 units
<span class="nc" id="L5764">            c3NetIdString = newC3NetIdString;</span>
        }
<span class="nc" id="L5766">    }</span>

    /**
     * Set the C3 network ID to be used on the next turn. Used for reconfiguring
     * a C3 network with Nova CEWS.
     *
     * @param str
     */
    public void setNewRoundNovaNetworkString(String str) {
        // Only allow Nova CEWS to change
<span class="nc bnc" id="L5776" title="All 2 branches missed.">        if (hasNovaCEWS()) {</span>
<span class="nc" id="L5777">            newC3NetIdString = str;</span>
        } else {
<span class="nc" id="L5779">            newC3NetIdString = getOriginalNovaC3NetId();</span>
        }
<span class="nc" id="L5781">    }</span>

    /**
     * Returns the C3 network id that will be switched to on the next turn.
     *
     * @return
     */
    public String getNewRoundNovaNetworkString() {
<span class="nc bnc" id="L5789" title="All 4 branches missed.">        if ((newC3NetIdString == null) || newC3NetIdString.isEmpty()) {</span>
<span class="nc" id="L5790">            newC3NetIdString = getOriginalNovaC3NetId();</span>
        }
<span class="nc" id="L5792">        return newC3NetIdString;</span>
    }

    public void setC3NetId(Entity e) {
<span class="nc bnc" id="L5796" title="All 4 branches missed.">        if ((e == null) || isEnemyOf(e)) {</span>
<span class="nc" id="L5797">            return;</span>
        }
<span class="nc" id="L5799">        c3NetIdString = e.c3NetIdString;</span>
<span class="nc" id="L5800">    }</span>

    public void setC3NetIdSelf() {
<span class="nc bnc" id="L5803" title="All 2 branches missed.">        if (hasActiveNovaCEWS()) {</span>
<span class="nc" id="L5804">            c3NetIdString = &quot;C3Nova.&quot; + getId();</span>
<span class="nc bnc" id="L5805" title="All 2 branches missed.">        } else if (hasNavalC3()) {</span>
<span class="nc" id="L5806">            c3NetIdString = &quot;NC3.&quot; + getId();</span>
        } else {
<span class="nc" id="L5808">            c3NetIdString = &quot;C3i.&quot; + getId();</span>
        }
<span class="nc" id="L5810">    }</span>

    /**
     * Determine the remaining number of other C3 Master computers that can
     * connect to this &lt;code&gt;Entity&lt;/code&gt;.
     * &lt;p/&gt;
     * Please note, if this &lt;code&gt;Entity&lt;/code&gt; does not have two C3 Master
     * computers, then it must first be identified as a company commander;
     * otherwise the number of free nodes will be zero.
     *
     * @return a non-negative &lt;code&gt;int&lt;/code&gt; value.
     */
    public int calculateFreeC3MNodes() {
<span class="nc" id="L5823">        int nodes = 0;</span>
<span class="nc bnc" id="L5824" title="All 2 branches missed.">        if (hasC3MM()) {</span>
<span class="nc" id="L5825">            nodes = 2;</span>
<span class="nc bnc" id="L5826" title="All 2 branches missed.">            if (game != null) {</span>
<span class="nc bnc" id="L5827" title="All 2 branches missed.">                for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L5828" title="All 4 branches missed.">                    if (e.hasC3M() &amp;&amp; (e != this)) {</span>
<span class="nc" id="L5829">                        final Entity m = e.getC3Master();</span>
<span class="nc bnc" id="L5830" title="All 2 branches missed.">                        if (equals(m)) {</span>
<span class="nc" id="L5831">                            nodes--;</span>
                        }
<span class="nc bnc" id="L5833" title="All 2 branches missed.">                        if (nodes &lt;= 0) {</span>
<span class="nc" id="L5834">                            return 0;</span>
                        }
                    }
<span class="nc" id="L5837">                }</span>
            }
<span class="nc bnc" id="L5839" title="All 4 branches missed.">        } else if (hasC3M() &amp;&amp; C3MasterIs(this)) {</span>
<span class="nc" id="L5840">            nodes = 3;</span>
<span class="nc bnc" id="L5841" title="All 2 branches missed.">            if (game != null) {</span>
<span class="nc bnc" id="L5842" title="All 2 branches missed.">                for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L5843" title="All 4 branches missed.">                    if (e.hasC3() &amp;&amp; (e != this)) {</span>
<span class="nc" id="L5844">                        final Entity m = e.getC3Master();</span>
<span class="nc bnc" id="L5845" title="All 2 branches missed.">                        if (equals(m)) {</span>
<span class="nc" id="L5846">                            nodes--;</span>
                        }
<span class="nc bnc" id="L5848" title="All 2 branches missed.">                        if (nodes &lt;= 0) {</span>
<span class="nc" id="L5849">                            return 0;</span>
                        }
                    }
<span class="nc" id="L5852">                }</span>
            }
        }
<span class="nc" id="L5855">        return nodes;</span>
    }

    /**
     * Determine the remaining number of other C3 computers that can connect to
     * this &lt;code&gt;Entity&lt;/code&gt;.
     * &lt;p/&gt;
     * Please note, if this &lt;code&gt;Entity&lt;/code&gt; has two C3 Master computers,
     * then this function only returns the remaining number of &lt;b&gt;C3 Slave&lt;/b&gt;
     * computers that can connect.
     *
     * @return a non-negative &lt;code&gt;int&lt;/code&gt; value.
     */
    public int calculateFreeC3Nodes() {
<span class="nc" id="L5869">        int nodes = 0;</span>
<span class="nc bnc" id="L5870" title="All 4 branches missed.">        if (hasC3i() || hasNavalC3()) {</span>
<span class="nc" id="L5871">            nodes = 5;</span>
<span class="nc bnc" id="L5872" title="All 2 branches missed.">            if (game != null) {</span>
<span class="nc bnc" id="L5873" title="All 2 branches missed.">                for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L5874" title="All 4 branches missed.">                    if (!equals(e) &amp;&amp; onSameC3NetworkAs(e)) {</span>
<span class="nc" id="L5875">                        nodes--;</span>
<span class="nc bnc" id="L5876" title="All 2 branches missed.">                        if (nodes &lt;= 0) {</span>
<span class="nc" id="L5877">                            return 0;</span>
                        }
                    }
<span class="nc" id="L5880">                }</span>
            }
<span class="nc bnc" id="L5882" title="All 2 branches missed.">        } else if (hasC3M()) {</span>
<span class="nc" id="L5883">            nodes = 3;</span>
<span class="nc bnc" id="L5884" title="All 2 branches missed.">            if (game != null) {</span>
<span class="nc bnc" id="L5885" title="All 2 branches missed.">                for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L5886" title="All 4 branches missed.">                    if (e.hasC3() &amp;&amp; !equals(e)) {</span>
<span class="nc" id="L5887">                        final Entity m = e.getC3Master();</span>
<span class="nc bnc" id="L5888" title="All 2 branches missed.">                        if (equals(m)) {</span>
                            // If this unit is a company commander, and has two
                            // C3 Master computers, only count C3 Slaves here.
<span class="nc bnc" id="L5891" title="All 6 branches missed.">                            if (!C3MasterIs(this) || !hasC3MM() || e.hasC3S()) {</span>
<span class="nc" id="L5892">                                nodes--;</span>
                            }
                        }
<span class="nc bnc" id="L5895" title="All 2 branches missed.">                        if (nodes &lt;= 0) {</span>
<span class="nc" id="L5896">                            return 0;</span>
                        }
                    }
<span class="nc" id="L5899">                }</span>
            }
<span class="nc bnc" id="L5901" title="All 2 branches missed.">        } else if (hasActiveNovaCEWS()) {</span>
<span class="nc" id="L5902">            nodes = 2;</span>
<span class="nc bnc" id="L5903" title="All 2 branches missed.">            if (game != null) {</span>
<span class="nc bnc" id="L5904" title="All 2 branches missed.">                for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L5905" title="All 4 branches missed.">                    if (!equals(e) &amp;&amp; onSameC3NetworkAs(e)) {</span>
<span class="nc" id="L5906">                        nodes--;</span>
<span class="nc bnc" id="L5907" title="All 2 branches missed.">                        if (nodes &lt;= 0) {</span>
<span class="nc" id="L5908">                            return 0;</span>
                        }
                    }
<span class="nc" id="L5911">                }</span>
            }
        }
<span class="nc" id="L5914">        return nodes;</span>
    }

    /**
     * @return the entity &quot;above&quot; this entity in our c3 network, or this entity
     * itself, if none is above this
     */
    public Entity getC3Top() {
<span class="nc" id="L5922">        Entity m = this;</span>
<span class="nc" id="L5923">        Entity master = m.getC3Master();</span>
<span class="nc bnc" id="L5924" title="All 2 branches missed.">        while ((master != null)</span>
<span class="nc bnc" id="L5925" title="All 2 branches missed.">               &amp;&amp; !master.equals(m)</span>
<span class="nc bnc" id="L5926" title="All 2 branches missed.">               &amp;&amp; master.hasC3()</span>
<span class="nc bnc" id="L5927" title="All 4 branches missed.">               &amp;&amp; ((m.hasBoostedC3() &amp;&amp; !ComputeECM.isAffectedByAngelECM(m,</span>
<span class="nc" id="L5928">                                                                         m.getPosition(),</span>
<span class="nc" id="L5929">                                                                         master.getPosition())) || !(ComputeECM</span>
<span class="nc bnc" id="L5930" title="All 2 branches missed.">                                                                                                             .isAffectedByECM(m, m.getPosition(),</span>
<span class="nc" id="L5931">                                                                                                                              master.getPosition())))</span>
<span class="nc bnc" id="L5932" title="All 4 branches missed.">               &amp;&amp; ((master.hasBoostedC3() &amp;&amp; !ComputeECM.isAffectedByAngelECM(</span>
<span class="nc" id="L5933">                master, master.getPosition(), master.getPosition())) || !(ComputeECM</span>
<span class="nc bnc" id="L5934" title="All 2 branches missed.">                                                                                  .isAffectedByECM(master, master.getPosition(),</span>
<span class="nc" id="L5935">                                                                                                   master.getPosition())))) {</span>
<span class="nc" id="L5936">            m = master;</span>
<span class="nc" id="L5937">            master = m.getC3Master();</span>
        }
<span class="nc" id="L5939">        return m;</span>
    }

    /**
     * Return the unit that is current master of this unit's C3 network. If the
     * master unit has been destroyed or had it's C3 master computer damaged,
     * then this unit is out of the C3 network for the rest of the game. If the
     * master unit has shut down, then this unit may return to the C3 network at
     * a later time.
     *
     * @return the &lt;code&gt;Entity&lt;/code&gt; that is the master of this unit's C3
     * network. This value may be &lt;code&gt;null&lt;/code&gt;. If the value master
     * unit has shut down, then the value will be non-&lt;code&gt;null&lt;/code&gt;
     * after the master unit restarts.
     */
    public Entity getC3Master() {
<span class="nc bnc" id="L5955" title="All 2 branches missed.">        if (c3Master == NONE) {</span>
<span class="nc" id="L5956">            return null;</span>
        }
<span class="nc bnc" id="L5958" title="All 4 branches missed.">        if (hasC3S() &amp;&amp; (c3Master &gt; NONE)) {</span>
            // since we can't seem to get the check working in setC3Master(),
            // I'll just do it here, every time. This sucks.
<span class="nc" id="L5961">            Entity eMaster = game.getEntity(c3Master);</span>
            // Have we lost our C3Master?
<span class="nc bnc" id="L5963" title="All 2 branches missed.">            if (eMaster == null) {</span>
<span class="nc" id="L5964">                c3Master = NONE;</span>
            }
            // If our master is shut down, don't clear this slave's setting.
<span class="nc bnc" id="L5967" title="All 2 branches missed.">            else if (eMaster.isShutDown()) {</span>
<span class="nc" id="L5968">                return null;</span>
            }
            // Slave computers can't connect to single-computer company masters.
<span class="nc bnc" id="L5971" title="All 4 branches missed.">            else if (eMaster.C3MasterIs(eMaster) &amp;&amp; !eMaster.hasC3MM()) {</span>
<span class="nc" id="L5972">                c3Master = NONE;</span>
            }
            // Has our lance master lost its computer?
<span class="nc bnc" id="L5975" title="All 2 branches missed.">            else if (!eMaster.hasC3M()) {</span>
<span class="nc" id="L5976">                c3Master = NONE;</span>
            }
<span class="nc bnc" id="L5978" title="All 4 branches missed.">        } else if (hasC3M() &amp;&amp; (c3Master &gt; NONE)) {</span>
<span class="nc" id="L5979">            Entity eMaster = game.getEntity(c3Master);</span>
            // Have we lost our C3Master?
<span class="nc bnc" id="L5981" title="All 2 branches missed.">            if (eMaster == null) {</span>
<span class="nc" id="L5982">                c3Master = NONE;</span>
            }
            // If our master is shut down, don't clear this slave's setting.
<span class="nc bnc" id="L5985" title="All 2 branches missed.">            else if (eMaster.isShutDown()) {</span>
<span class="nc" id="L5986">                return null;</span>
            }
            // Has our company commander lost his company command computer?
<span class="nc bnc" id="L5989" title="All 2 branches missed.">            else if (((eMaster.c3CompanyMasterIndex &gt; LOC_NONE) &amp;&amp; !eMaster</span>
<span class="nc bnc" id="L5990" title="All 4 branches missed.">                    .hasC3MM())</span>
                     || ((eMaster.c3CompanyMasterIndex &lt;= LOC_NONE) &amp;&amp; !eMaster
<span class="nc bnc" id="L5992" title="All 2 branches missed.">                    .hasC3M())) {</span>
<span class="nc" id="L5993">                c3Master = NONE;</span>
            }
            // maximum depth of a c3 network is 2 levels.
<span class="nc bnc" id="L5996" title="All 2 branches missed.">            else if (eMaster != this) {</span>
<span class="nc" id="L5997">                Entity eCompanyMaster = eMaster.getC3Master();</span>
<span class="nc bnc" id="L5998" title="All 2 branches missed.">                if ((eCompanyMaster != null)</span>
<span class="nc bnc" id="L5999" title="All 2 branches missed.">                    &amp;&amp; (eCompanyMaster.getC3Master() != eCompanyMaster)) {</span>
<span class="nc" id="L6000">                    c3Master = NONE;</span>
                }
            }
<span class="nc" id="L6003">        }</span>
        // If we aren't shut down, and if we don't have a company master
        // computer, but have a C3Master, then we must have lost our network.
<span class="nc bnc" id="L6006" title="All 6 branches missed.">        else if (!isShutDown() &amp;&amp; !hasC3MM() &amp;&amp; (c3Master &gt; NONE)) {</span>
<span class="nc" id="L6007">            c3Master = NONE;</span>
        }
<span class="nc bnc" id="L6009" title="All 2 branches missed.">        if (c3Master == NONE) {</span>
<span class="nc" id="L6010">            return null;</span>
        }
<span class="nc" id="L6012">        return game.getEntity(c3Master);</span>
    }

    /**
     * Get the ID of the master unit in this unit's C3 network. If the master
     * unit has shut down, then the ID will still be returned. The only times
     * when the value, &lt;code&gt;Entity.NONE&lt;/code&gt; is returned is when this unit is
     * permanently out of the C3 network, or when it was never in a C3 network.
     *
     * @return the &lt;code&gt;int&lt;/code&gt; ID of the unit that is the master of this
     * unit's C3 network, or &lt;code&gt;Entity.NONE&lt;/code&gt;.
     */
    public int getC3MasterId() {
        // Make sure that this unit is still on a C3 network.
        // N.B. this call may set this.C3Master to NONE.
<span class="nc" id="L6027">        getC3Master();</span>
<span class="nc" id="L6028">        return c3Master;</span>
    }

    /**
     * Determines if the passed &lt;code&gt;Entity&lt;/code&gt; is the C3 Master of this
     * unit.
     * &lt;p/&gt;
     * Please note, that when an &lt;code&gt;Entity&lt;/code&gt; is it's own C3 Master, then
     * it is a company commander.
     * &lt;p/&gt;
     * Also note that when &lt;code&gt;null&lt;/code&gt; is the master for this
     * &lt;code&gt;Entity&lt;/code&gt;, then it is an independent master.
     *
     * @param e - the &lt;code&gt;Entity&lt;/code&gt; that may be this unit's C3 Master.
     * @return a &lt;code&gt;boolean&lt;/code&gt; that is &lt;code&gt;true&lt;/code&gt; when the passed
     * &lt;code&gt;Entity&lt;/code&gt; is this unit's commander. If the passed unit
     * isn't this unit's commander, this routine returns
     * &lt;code&gt;false&lt;/code&gt;.
     */
    public boolean C3MasterIs(Entity e) {
<span class="nc bnc" id="L6048" title="All 2 branches missed.">        if (e == null) {</span>
<span class="nc bnc" id="L6049" title="All 2 branches missed.">            if (c3Master == NONE) {</span>
<span class="nc" id="L6050">                return true;</span>
            }

<span class="nc" id="L6053">            return false; // if this entity has a C3Master then null is not</span>
            // it's master.
        }
<span class="nc bnc" id="L6056" title="All 2 branches missed.">        return (e.id == c3Master);</span>
    }

    /**
     * Set another &lt;code&gt;Entity&lt;/code&gt; as our C3 Master
     *
     * @param e - the &lt;code&gt;Entity&lt;/code&gt; that should be set as our C3 Master.
     */
    public void setC3Master(Entity e, boolean reset) {
<span class="nc bnc" id="L6065" title="All 2 branches missed.">        if (e == null) {</span>
<span class="nc" id="L6066">            setC3Master(NONE, reset);</span>
        } else {
<span class="nc bnc" id="L6068" title="All 2 branches missed.">            if (isEnemyOf(e)) {</span>
<span class="nc" id="L6069">                return;</span>
            }
<span class="nc" id="L6071">            setC3Master(e.id, reset);</span>
        }
<span class="nc" id="L6073">    }</span>

    /**
     * @param entityId
     */
    public void setC3Master(int entityId, boolean reset) {
<span class="nc bnc" id="L6079" title="All 8 branches missed.">        if (reset &amp;&amp; ((id == entityId) != (id == c3Master))) {</span>
            // this just changed from a company-level to lance-level (or vice
            // versa); have to disconnect all slaved units to maintain
            // integrity.
<span class="nc bnc" id="L6083" title="All 2 branches missed.">            for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L6084" title="All 4 branches missed.">                if (e.C3MasterIs(this) &amp;&amp; !equals(e)) {</span>
<span class="nc" id="L6085">                    e.setC3Master(NONE, reset);</span>
                }
<span class="nc" id="L6087">            }</span>
        }
<span class="nc bnc" id="L6089" title="All 2 branches missed.">        if (hasC3()) {</span>
<span class="nc" id="L6090">            c3Master = entityId;</span>
        }
<span class="nc bnc" id="L6092" title="All 4 branches missed.">        if (hasC3() &amp;&amp; (entityId == NONE)) {</span>
<span class="nc" id="L6093">            c3NetIdString = &quot;C3.&quot; + id;</span>
<span class="nc bnc" id="L6094" title="All 4 branches missed.">        } else if (hasC3i() &amp;&amp; (entityId == NONE)) {</span>
<span class="nc" id="L6095">            c3NetIdString = &quot;C3i.&quot; + id;</span>
<span class="nc bnc" id="L6096" title="All 4 branches missed.">        } else if (hasNavalC3() &amp;&amp; (entityId == NONE)) {</span>
<span class="nc" id="L6097">            c3NetIdString = &quot;NC3.&quot; + id;</span>
<span class="nc bnc" id="L6098" title="All 6 branches missed.">        } else if (hasC3() || hasC3i() || hasNavalC3()) {</span>
<span class="nc" id="L6099">            c3NetIdString = game.getEntity(entityId).getC3NetId();</span>
        }
<span class="nc bnc" id="L6101" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L6102" title="All 4 branches missed.">            if (e.C3MasterIs(this) &amp;&amp; !equals(e)) {</span>
<span class="nc" id="L6103">                e.c3NetIdString = c3NetIdString;</span>
            }
<span class="nc" id="L6105">        }</span>
<span class="nc" id="L6106">    }</span>

    public boolean onSameC3NetworkAs(Entity e) {
<span class="nc" id="L6109">        return onSameC3NetworkAs(e, false);</span>
    }

    /**
     * Checks if another entity is on the same c3 network as this entity
     *
     * @param e         The &lt;code&gt;Entity&lt;/code&gt; to check against this entity
     * @param ignoreECM a &lt;code&gt;boolean&lt;/code&gt; indicating if ECM should be ignored, we
     *                  need this for c3i
     * @return a &lt;code&gt;boolean&lt;/code&gt; that is &lt;code&gt;true&lt;/code&gt; if the given
     * entity is on the same network, &lt;code&gt;false&lt;/code&gt; if not.
     */
    public boolean onSameC3NetworkAs(Entity e, boolean ignoreECM) {
<span class="nc bnc" id="L6122" title="All 6 branches missed.">        if (isEnemyOf(e) || isShutDown() || e.isShutDown()) {</span>
<span class="nc" id="L6123">            return false;</span>
        }

        // Active Mek Stealth prevents entity from participating in C3.
        // Turn off the stealth, and your back in the network.
<span class="nc bnc" id="L6128" title="All 4 branches missed.">        if (((this instanceof Mech) || (this instanceof Tank))</span>
<span class="nc bnc" id="L6129" title="All 2 branches missed.">            &amp;&amp; isStealthActive()) {</span>
<span class="nc" id="L6130">            return false;</span>
        }
<span class="nc bnc" id="L6132" title="All 6 branches missed.">        if (((e instanceof Mech) || (e instanceof Tank)) &amp;&amp; e.isStealthActive()) {</span>
<span class="nc" id="L6133">            return false;</span>
        }

        // C3i is easy - if they both have C3i, and their net ID's match,
        // they're on the same network!
<span class="nc bnc" id="L6138" title="All 6 branches missed.">        if (hasC3i() &amp;&amp; e.hasC3i() &amp;&amp; getC3NetId().equals(e.getC3NetId())) {</span>
<span class="nc bnc" id="L6139" title="All 2 branches missed.">            if (ignoreECM) {</span>
<span class="nc" id="L6140">                return true;</span>
            }
<span class="nc bnc" id="L6142" title="All 2 branches missed.">            return !(ComputeECM.isAffectedByECM(e, e.getPosition(),</span>
<span class="nc" id="L6143">                                                e.getPosition()))</span>
<span class="nc bnc" id="L6144" title="All 2 branches missed.">                   &amp;&amp; !(ComputeECM.isAffectedByECM(this, getPosition(),</span>
<span class="nc" id="L6145">                                                   getPosition()));</span>
        }

        // NC3 is easy too - if they both have NC3, and their net ID's match,
        // they're on the same network!
<span class="nc bnc" id="L6150" title="All 6 branches missed.">        if (hasNavalC3() &amp;&amp; e.hasNavalC3() &amp;&amp; getC3NetId().equals(e.getC3NetId())) {</span>
<span class="nc" id="L6151">            int distance = Compute.effectiveDistance(game,this,e,false);</span>
            //Naval C3 is not affected by ECM, but nodes must be within 60 hexes of one another
<span class="nc bnc" id="L6153" title="All 2 branches missed.">            if (game.getRoundCount() &gt; 0) {</span>
<span class="nc bnc" id="L6154" title="All 2 branches missed.">                if (distance &gt; 60) {</span>
<span class="nc" id="L6155">                    return false;</span>
                }
                //Naval C3 only works in space
<span class="nc bnc" id="L6158" title="All 2 branches missed.">                if (!isSpaceborne()) {</span>
<span class="nc" id="L6159">                    return false;</span>
                }
            }
<span class="nc" id="L6162">            return true;</span>
        }

        // Nova is easy - if they both have Nova, and their net ID's match,
        // they're on the same network!
        // At least I hope thats how it works.
<span class="nc bnc" id="L6168" title="All 4 branches missed.">        if (hasActiveNovaCEWS() &amp;&amp; e.hasActiveNovaCEWS()</span>
<span class="nc bnc" id="L6169" title="All 2 branches missed.">            &amp;&amp; getC3NetId().equals(e.getC3NetId())) {</span>
<span class="nc bnc" id="L6170" title="All 2 branches missed.">            if (ignoreECM) {</span>
<span class="nc" id="L6171">                return true;</span>
            }
<span class="nc" id="L6173">            ECMInfo srcInfo = ComputeECM.getECMEffects(e, e.getPosition(),</span>
<span class="nc" id="L6174">                    e.getPosition(), true, null);</span>
<span class="nc" id="L6175">            ECMInfo dstInfo = ComputeECM.getECMEffects(this, getPosition(),</span>
<span class="nc" id="L6176">                    getPosition(), true, null);</span>
<span class="nc bnc" id="L6177" title="All 6 branches missed.">            return !((srcInfo != null) &amp;&amp; srcInfo.isNovaECM())</span>
<span class="nc bnc" id="L6178" title="All 2 branches missed.">                    &amp;&amp; !((dstInfo != null) &amp;&amp; dstInfo.isNovaECM());</span>
        }

        // simple sanity check - do they both have C3, and are they both on the
        // same network?
<span class="nc bnc" id="L6183" title="All 4 branches missed.">        if (!hasC3() || !e.hasC3()) {</span>
<span class="nc" id="L6184">            return false;</span>
        }
<span class="nc bnc" id="L6186" title="All 4 branches missed.">        if ((getC3Top() == null) || (e.getC3Top() == null)) {</span>
<span class="nc" id="L6187">            return false;</span>
        }
        // got the easy part out of the way, now we need to verify that the
        // network isn't down
<span class="nc" id="L6191">        return (getC3Top().equals(e.getC3Top()));</span>
    }

    /**
     * Returns whether there is CASE protecting the location.
     */
    public boolean locationHasCase(int loc) {
<span class="nc bnc" id="L6198" title="All 2 branches missed.">        for (Mounted mounted : getMisc()) {</span>
<span class="nc bnc" id="L6199" title="All 2 branches missed.">            if ((mounted.getLocation() == loc)</span>
<span class="nc bnc" id="L6200" title="All 2 branches missed.">                &amp;&amp; mounted.getType().hasFlag(MiscType.F_CASE)|(mounted.getType().hasFlag(MiscType.F_CASEP))) {</span>
<span class="nc" id="L6201">                return true;</span>
            }
<span class="nc" id="L6203">        }</span>
<span class="nc" id="L6204">        return false;</span>
    }

    /**
     * Returns whether there is CASE anywhere on this {@code Entity}.
     */
    public boolean hasCase() {
        // Clan Mechs always have CASE!
<span class="nc bnc" id="L6212" title="All 2 branches missed.">        if (isClan()) {</span>
<span class="nc" id="L6213">            return true;</span>
        }
<span class="nc bnc" id="L6215" title="All 2 branches missed.">        for (Mounted mounted : getMisc()) {</span>
<span class="nc bnc" id="L6216" title="All 4 branches missed.">            if (mounted.getType().hasFlag(MiscType.F_CASE)||(mounted.getType().hasFlag(MiscType.F_CASEP))</span>
                    ) {
<span class="nc" id="L6218">                return true;</span>
            }
<span class="nc" id="L6220">        }</span>
<span class="nc" id="L6221">        return false;</span>
    }

    /**
     * Hits all criticals of the system occupying the specified critical slot.
     * Used, for example, in a gauss rifle capacitor discharge. Does not apply
     * any special effect of hitting the criticals, like ammo explosion.
     */
    public void hitAllCriticals(int loc, int slot) {
<span class="nc" id="L6230">        CriticalSlot orig = getCritical(loc, slot);</span>
<span class="nc bnc" id="L6231" title="All 2 branches missed.">        for (int i = 0; i &lt; getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L6232">            CriticalSlot cs = getCritical(loc, i);</span>
<span class="nc bnc" id="L6233" title="All 4 branches missed.">            if ((cs != null) &amp;&amp; (cs.getType() == orig.getType())) {</span>
<span class="nc" id="L6234">                Mounted csMount = cs.getMount();</span>
<span class="nc bnc" id="L6235" title="All 4 branches missed.">                if ((csMount != null) &amp;&amp; csMount.equals(orig.getMount())) {</span>
<span class="nc" id="L6236">                    cs.setHit(true);</span>
                }
            }
        }
<span class="nc" id="L6240">    }</span>

    /**
     * Start a new round
     *
     * @param roundNumber the &lt;code&gt;int&lt;/code&gt; number of the new round
     */
    @Override
    public void newRound(int roundNumber) {
<span class="nc" id="L6249">        fell = false;</span>
<span class="nc" id="L6250">        struck = false;</span>
<span class="nc" id="L6251">        unloadedThisTurn = false;</span>
<span class="nc" id="L6252">        loadedThisTurn = false;</span>
<span class="nc" id="L6253">        done = false;</span>
<span class="nc" id="L6254">        delta_distance = 0;</span>
<span class="nc" id="L6255">        mpUsedLastRound = mpUsed;</span>
<span class="nc" id="L6256">        mpUsed = 0;</span>
<span class="nc" id="L6257">        isJumpingNow = false;</span>
<span class="nc" id="L6258">        convertingNow = false;</span>
<span class="nc" id="L6259">        damageThisRound = 0;</span>
<span class="nc bnc" id="L6260" title="All 2 branches missed.">        if (assaultDropInProgress == 2) {</span>
<span class="nc" id="L6261">            assaultDropInProgress = 0;</span>
        }
<span class="nc" id="L6263">        movedLastRound = moved;</span>
<span class="nc" id="L6264">        moved = EntityMovementType.MOVE_NONE;</span>
<span class="nc" id="L6265">        movedBackwards = false;</span>
<span class="nc" id="L6266">        isPowerReverse = false;</span>
<span class="nc" id="L6267">        wigeLiftoffHover = false;</span>
<span class="nc" id="L6268">        gotPavementBonus = false;</span>
<span class="nc" id="L6269">        wigeBonus = 0;</span>
<span class="nc" id="L6270">        hitThisRoundByAntiTSM = false;</span>
<span class="nc" id="L6271">        inReverse = false;</span>
<span class="nc" id="L6272">        hitBySwarmsEntity.clear();</span>
<span class="nc" id="L6273">        hitBySwarmsWeapon.clear();</span>
<span class="nc" id="L6274">        setTaggedBy(-1);</span>
<span class="nc" id="L6275">        setLayingMines(false);</span>
<span class="nc" id="L6276">        setArmsFlipped(false);</span>
<span class="nc" id="L6277">        setDisplacementAttack(null);</span>
<span class="nc" id="L6278">        setFindingClub(false);</span>
<span class="nc" id="L6279">        setSpotting(false);</span>
<span class="nc" id="L6280">        spotTargetId = Entity.NONE;</span>
<span class="nc" id="L6281">        setClearingMinefield(false);</span>
<span class="nc" id="L6282">        setUnjammingRAC(false);</span>
<span class="nc" id="L6283">        crew.setKoThisRound(false);</span>
<span class="nc" id="L6284">        m_lNarcedBy |= m_lPendingNarc;</span>
<span class="nc bnc" id="L6285" title="All 2 branches missed.">        if (pendingINarcPods.size() &gt; 0) {</span>
<span class="nc" id="L6286">            iNarcPods.addAll(pendingINarcPods);</span>
<span class="nc" id="L6287">            pendingINarcPods = new ArrayList&lt;INarcPod&gt;();</span>
        }
<span class="nc bnc" id="L6289" title="All 2 branches missed.">        if (pendingNarcPods.size() &gt; 0) {</span>
<span class="nc" id="L6290">            narcPods.addAll(pendingNarcPods);</span>
<span class="nc" id="L6291">            pendingNarcPods.clear();</span>
        }

        // update the number of turns we used a blue shield
<span class="nc bnc" id="L6295" title="All 2 branches missed.">        if (hasActiveBlueShield()) {</span>
<span class="nc" id="L6296">            blueShieldRounds++;</span>
        }

        // for dropping troops, check to see if they are going to land
        // this turn, if so, then set their assault drop status to true
<span class="nc bnc" id="L6301" title="All 2 branches missed.">        if (isAirborne()</span>
<span class="nc bnc" id="L6302" title="All 2 branches missed.">            &amp;&amp; !isAero()</span>
<span class="nc" id="L6303">            &amp;&amp; (getAltitude() &lt;= game.getPlanetaryConditions()</span>
<span class="nc bnc" id="L6304" title="All 2 branches missed.">                                     .getDropRate())) {</span>
<span class="nc" id="L6305">            setAssaultDropInProgress(true);</span>
        }

<span class="nc bnc" id="L6308" title="All 2 branches missed.">        for (Mounted m : getEquipment()) {</span>
<span class="nc" id="L6309">            m.newRound(roundNumber);</span>
<span class="nc" id="L6310">        }</span>

<span class="nc" id="L6312">        newRoundNovaNetSwitch();</span>
<span class="nc" id="L6313">        doNewRoundIMP();</span>

        // reset hexes passed through
<span class="nc" id="L6316">        setPassedThrough(new Vector&lt;Coords&gt;());</span>
<span class="nc" id="L6317">        setPassedThroughFacing(new ArrayList&lt;Integer&gt;());</span>
<span class="nc bnc" id="L6318" title="All 2 branches missed.">        if (playerPickedPassThrough == null) {</span>
<span class="nc" id="L6319">            playerPickedPassThrough = new HashMap&lt;&gt;();</span>
        } else {
<span class="nc" id="L6321">            playerPickedPassThrough.clear();</span>
        }

<span class="nc" id="L6324">        resetFiringArcs();</span>

<span class="nc" id="L6326">        resetBays();</span>

<span class="nc bnc" id="L6328" title="All 2 branches missed.">        if (isBomber()) {</span>
<span class="nc" id="L6329">            resetBombAttacks();</span>
        }

        // reset evasion
<span class="nc" id="L6333">        setEvading(false);</span>

        // make sensor checks
<span class="nc" id="L6336">        sensorCheck = Compute.d6(2);</span>
        // if the current sensor is BAP and BAP is critted, then switch to the
        // first
        // thing that works
<span class="nc bnc" id="L6340" title="All 6 branches missed.">        if ((null != nextSensor) &amp;&amp; nextSensor.isBAP() &amp;&amp; !hasBAP(false)) {</span>
<span class="nc bnc" id="L6341" title="All 2 branches missed.">            for (Sensor sensor : getSensors()) {</span>
<span class="nc bnc" id="L6342" title="All 2 branches missed.">                if (!sensor.isBAP()) {</span>
<span class="nc" id="L6343">                    nextSensor = sensor;</span>
<span class="nc" id="L6344">                    break;</span>
                }
<span class="nc" id="L6346">            }</span>
        }

        // change the active sensor, if requested
<span class="nc bnc" id="L6350" title="All 2 branches missed.">        if (null != nextSensor) {</span>
<span class="nc" id="L6351">            activeSensor = nextSensor;</span>
        }

        // ghost target roll
<span class="nc" id="L6355">        ghostTargetRoll = Compute.d6(2);</span>
<span class="nc" id="L6356">        ghostTargetOverride = Compute.d6(2);</span>

        // update fatigue count
<span class="nc bnc" id="L6359" title="All 4 branches missed.">        if ((null != crew) &amp;&amp; isDeployed()) {</span>
<span class="nc" id="L6360">            crew.incrementFatigueCount();</span>
        }

        // Update the inferno tracker.
<span class="nc" id="L6364">        infernos.newRound(roundNumber);</span>
<span class="nc bnc" id="L6365" title="All 2 branches missed.">        if (taserShutdownRounds &gt; 0) {</span>
<span class="nc" id="L6366">            taserShutdownRounds--;</span>
<span class="nc bnc" id="L6367" title="All 2 branches missed.">            if (taserShutdownRounds == 0) {</span>
<span class="nc" id="L6368">                shutdownByBATaser = false;</span>
            }
        }
<span class="nc bnc" id="L6371" title="All 2 branches missed.">        if (taserInterferenceRounds &gt; 0) {</span>
<span class="nc" id="L6372">            taserInterferenceRounds--;</span>
<span class="nc bnc" id="L6373" title="All 2 branches missed.">            if (taserInterferenceRounds == 0) {</span>
<span class="nc" id="L6374">                taserInterference = 0;</span>
<span class="nc" id="L6375">                taserInterferenceHeat = false;</span>
            }
        }
<span class="nc bnc" id="L6378" title="All 2 branches missed.">        if (taserFeedBackRounds &gt; 0) {</span>
<span class="nc" id="L6379">            taserFeedBackRounds--;</span>
        }

        // If we are affected by the TSEMP Shutdown effect, we should remove
        // it now, so we can startup during the end phase
<span class="nc bnc" id="L6384" title="All 2 branches missed.">        if (getTsempEffect() == TSEMPWeapon.TSEMP_EFFECT_SHUTDOWN) {</span>
<span class="nc" id="L6385">            setTsempEffect(TSEMPWeapon.TSEMP_EFFECT_NONE);</span>
            // The TSEMP interference effect shouldn't be removed until the start
            //  of a round where we didn't have any TSEMP hits and didn't fire a
            //  TSEMP, since we need the effect active during the firing phase
<span class="nc bnc" id="L6389" title="All 4 branches missed.">        } else if ((getTsempHitsThisTurn() == 0) &amp;&amp; !isFiredTsempThisTurn()) {</span>
<span class="nc" id="L6390">            setTsempEffect(TSEMPWeapon.TSEMP_EFFECT_NONE);</span>
        }

        // TSEMPs can fire every other round, so if we didn't fire last
        //  round and the TSEMP isn't one-shot, reset it's fired state
<span class="nc bnc" id="L6395" title="All 2 branches missed.">        if (hasFiredTsemp()) {</span>
<span class="nc bnc" id="L6396" title="All 2 branches missed.">            for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L6397" title="All 2 branches missed.">                if (m.getType().hasFlag(WeaponType.F_TSEMP)</span>
<span class="nc bnc" id="L6398" title="All 2 branches missed.">                    &amp;&amp; !m.getType().hasFlag(WeaponType.F_ONESHOT)) {</span>
<span class="nc bnc" id="L6399" title="All 2 branches missed.">                    if (m.isTSEMPDowntime()) {</span>
<span class="nc" id="L6400">                        m.setFired(false);</span>
<span class="nc" id="L6401">                        m.setTSEMPDowntime(false);</span>
<span class="nc bnc" id="L6402" title="All 2 branches missed.">                    } else if (m.isFired()) {</span>
<span class="nc" id="L6403">                        m.setTSEMPDowntime(true);</span>
                    }
                }
<span class="nc" id="L6406">            }</span>
        }

        // Reset TSEMP hits
<span class="nc" id="L6410">        tsempHitsThisTurn = 0;</span>
        // Reset TSEMP firing flag
<span class="nc" id="L6412">        setFiredTsempThisTurn(false);</span>

        // Decrement the number of consecutive turns if not used last turn
<span class="nc bnc" id="L6415" title="All 2 branches missed.">        if (!hasActivatedRadicalHS()) {</span>
<span class="nc" id="L6416">            setConsecutiveRHSUses(Math.max(0, getConsecutiveRHSUses() - 1));</span>
        }
        // Reset used RHS flag
<span class="nc" id="L6419">        deactivateRadicalHS();</span>

<span class="nc" id="L6421">        clearAttackedByThisTurn();</span>

<span class="nc" id="L6423">        setMadePointblankShot(false);</span>

<span class="nc" id="L6425">        setSelfDestructedThisTurn(false);</span>

<span class="nc" id="L6427">        setClimbMode(GUIPreferences.getInstance().getBoolean(GUIPreferences.ADVANCED_MOVE_DEFAULT_CLIMB_MODE));</span>
<span class="nc" id="L6428">    }</span>

    /**
     * Applies any damage that the entity has suffered. When anything gets hit
     * it is simply marked as &quot;hit&quot; but does not stop working until this is
     * called.
     */
    public void applyDamage() {
        // mark all damaged equipment destroyed
<span class="nc bnc" id="L6437" title="All 2 branches missed.">        for (Mounted mounted : getEquipment()) {</span>
<span class="nc bnc" id="L6438" title="All 2 branches missed.">            if (mounted.isHit()) {</span>
<span class="nc" id="L6439">                mounted.setDestroyed(true);</span>
            }
<span class="nc" id="L6441">        }</span>

        // destroy criticals that were hit last phase
<span class="nc bnc" id="L6444" title="All 2 branches missed.">        for (int i = 0; i &lt; locations(); i++) {</span>
<span class="nc bnc" id="L6445" title="All 2 branches missed.">            for (int j = 0; j &lt; getNumberOfCriticals(i); j++) {</span>
<span class="nc" id="L6446">                final CriticalSlot cs = getCritical(i, j);</span>
<span class="nc bnc" id="L6447" title="All 4 branches missed.">                if ((cs != null) &amp;&amp; cs.isHit()) {</span>
<span class="nc" id="L6448">                    cs.setDestroyed(true);</span>
                }
            }
        }

        // Reset any &quot;blown off this phase&quot; markers.
<span class="nc bnc" id="L6454" title="All 2 branches missed.">        for (int i = 0; i &lt; locations(); i++) {</span>
<span class="nc" id="L6455">            setLocationBlownOffThisPhase(i, false);</span>
        }

        // destroy armor/internals if the section was removed
<span class="nc bnc" id="L6459" title="All 2 branches missed.">        for (int i = 0; i &lt; locations(); i++) {</span>
<span class="nc bnc" id="L6460" title="All 2 branches missed.">            if (getInternal(i) == IArmorState.ARMOR_DOOMED) {</span>
<span class="nc" id="L6461">                setArmor(IArmorState.ARMOR_DESTROYED, i);</span>
<span class="nc" id="L6462">                setArmor(IArmorState.ARMOR_DESTROYED, i, true);</span>
<span class="nc" id="L6463">                setInternal(IArmorState.ARMOR_DESTROYED, i);</span>
                // destroy any Narc beacons
<span class="nc" id="L6465">                for (Iterator&lt;NarcPod&gt; iter = narcPods.iterator(); iter</span>
<span class="nc bnc" id="L6466" title="All 2 branches missed.">                        .hasNext(); ) {</span>
<span class="nc" id="L6467">                    NarcPod p = iter.next();</span>
<span class="nc bnc" id="L6468" title="All 2 branches missed.">                    if (p.getLocation() == i) {</span>
<span class="nc" id="L6469">                        iter.remove();</span>
                    }
<span class="nc" id="L6471">                }</span>
<span class="nc" id="L6472">                for (Iterator&lt;INarcPod&gt; iter = iNarcPods.iterator(); iter</span>
<span class="nc bnc" id="L6473" title="All 2 branches missed.">                        .hasNext(); ) {</span>
<span class="nc" id="L6474">                    INarcPod p = iter.next();</span>
<span class="nc bnc" id="L6475" title="All 2 branches missed.">                    if (p.getLocation() == i) {</span>
<span class="nc" id="L6476">                        iter.remove();</span>
                    }
<span class="nc" id="L6478">                }</span>
<span class="nc" id="L6479">                for (Iterator&lt;NarcPod&gt; iter = pendingNarcPods.iterator(); iter</span>
<span class="nc bnc" id="L6480" title="All 2 branches missed.">                        .hasNext(); ) {</span>
<span class="nc" id="L6481">                    NarcPod p = iter.next();</span>
<span class="nc bnc" id="L6482" title="All 2 branches missed.">                    if (p.getLocation() == i) {</span>
<span class="nc" id="L6483">                        iter.remove();</span>
                    }
<span class="nc" id="L6485">                }</span>
<span class="nc" id="L6486">                for (Iterator&lt;INarcPod&gt; iter = pendingINarcPods.iterator(); iter</span>
<span class="nc bnc" id="L6487" title="All 2 branches missed.">                        .hasNext(); ) {</span>
<span class="nc" id="L6488">                    INarcPod p = iter.next();</span>
<span class="nc bnc" id="L6489" title="All 2 branches missed.">                    if (p.getLocation() == i) {</span>
<span class="nc" id="L6490">                        iter.remove();</span>
                    }
<span class="nc" id="L6492">                }</span>
            }
        }
<span class="nc" id="L6495">    }</span>

    /**
     * Attempts to reload any empty weapons with the first ammo found
     */
    public void reloadEmptyWeapons() {
        // try to reload weapons
<span class="nc bnc" id="L6502" title="All 2 branches missed.">        for (Mounted mounted : getTotalWeaponList()) {</span>
<span class="nc" id="L6503">            WeaponType wtype = (WeaponType) mounted.getType();</span>

<span class="nc bnc" id="L6505" title="All 2 branches missed.">            if (wtype.getAmmoType() != AmmoType.T_NA) {</span>
<span class="nc bnc" id="L6506" title="All 2 branches missed.">                if ((mounted.getLinked() == null)</span>
<span class="nc bnc" id="L6507" title="All 2 branches missed.">                    || (mounted.getLinked().getUsableShotsLeft() &lt;= 0)</span>
<span class="nc bnc" id="L6508" title="All 2 branches missed.">                    || mounted.getLinked().isDumping()) {</span>
<span class="nc" id="L6509">                    loadWeaponWithSameAmmo(mounted);</span>
                }
            }
<span class="nc" id="L6512">        }</span>
<span class="nc" id="L6513">    }</span>

    /**
     * Return the currently operable AMS mounted in this Entity.
     *
     * @return
     */
    public List&lt;Mounted&gt; getActiveAMS() {
<span class="nc" id="L6521">        ArrayList&lt;Mounted&gt; ams = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L6522" title="All 2 branches missed.">        for (Mounted weapon : getWeaponList()) {</span>
            // Skip anything that's not AMS
<span class="nc bnc" id="L6524" title="All 2 branches missed.">            if (!weapon.getType().hasFlag(WeaponType.F_AMS)) {</span>
<span class="nc" id="L6525">                continue;</span>
            }

            // Make sure the AMS is good to go
<span class="nc bnc" id="L6529" title="All 4 branches missed.">            if (!weapon.isReady() || weapon.isMissing()</span>
<span class="nc bnc" id="L6530" title="All 2 branches missed.">                || !weapon.curMode().equals(Weapon.MODE_AMS_ON)) {</span>
<span class="nc" id="L6531">                continue;</span>
            }

            // AMS blocked by transported units can not fire
<span class="nc bnc" id="L6535" title="All 2 branches missed.">            if (isWeaponBlockedAt(weapon.getLocation(),</span>
<span class="nc" id="L6536">                                  weapon.isRearMounted())) {</span>
<span class="nc" id="L6537">                continue;</span>
            }

            // Make sure ammo is loaded
<span class="nc bnc" id="L6541" title="All 2 branches missed.">            boolean baAPDS = (this instanceof BattleArmor)</span>
<span class="nc bnc" id="L6542" title="All 2 branches missed.">                    &amp;&amp; (weapon.getType().getInternalName().equals(&quot;ISBAAPDS&quot;));</span>
<span class="nc" id="L6543">            Mounted ammo = weapon.getLinked();</span>
<span class="nc bnc" id="L6544" title="All 6 branches missed.">            if (!(weapon.getType().hasFlag(WeaponType.F_ENERGY)) &amp;&amp; !baAPDS</span>
<span class="nc bnc" id="L6545" title="All 2 branches missed.">                &amp;&amp; ((ammo == null) || (ammo.getUsableShotsLeft() == 0)</span>
<span class="nc bnc" id="L6546" title="All 2 branches missed.">                    || ammo.isDumping())) {</span>
<span class="nc" id="L6547">                loadWeapon(weapon);</span>
<span class="nc" id="L6548">                ammo = weapon.getLinked();</span>
            }

            // try again
<span class="nc bnc" id="L6552" title="All 6 branches missed.">            if (!(weapon.getType().hasFlag(WeaponType.F_ENERGY)) &amp;&amp; !baAPDS</span>
<span class="nc bnc" id="L6553" title="All 2 branches missed.">                &amp;&amp; ((ammo == null) || (ammo.getUsableShotsLeft() == 0)</span>
<span class="nc bnc" id="L6554" title="All 2 branches missed.">                    || ammo.isDumping())) {</span>
                // No ammo for this AMS.
<span class="nc" id="L6556">                continue;</span>
            }
<span class="nc" id="L6558">            ams.add(weapon);</span>
<span class="nc" id="L6559">        }</span>
<span class="nc" id="L6560">        return ams;</span>
    }

    /**
     * Assign AMS systems to incoming telemissile attacks. This
     * allows AMS bays to work against these modified physical attacks
     */
    public void assignTMAMS(Vector&lt;AttackAction&gt; vTMAttacks) {
<span class="nc" id="L6568">        HashSet&lt;AttackAction&gt; targets = new HashSet&lt;AttackAction&gt;();</span>
<span class="nc bnc" id="L6569" title="All 2 branches missed.">        for (Mounted ams : getActiveAMS()) {</span>
         // make a new vector of only incoming attacks in arc
<span class="nc" id="L6571">            Vector&lt;TeleMissileAttackAction&gt; vTMAttacksInArc = new Vector&lt;TeleMissileAttackAction&gt;(</span>
<span class="nc" id="L6572">                    vTMAttacks.size());</span>

<span class="nc bnc" id="L6574" title="All 2 branches missed.">            for (AttackAction aa : vTMAttacks) {</span>
                //We already made sure these are all telemissile attacks in Server
<span class="nc" id="L6576">                TeleMissileAttackAction taa = (TeleMissileAttackAction) aa;</span>
<span class="nc bnc" id="L6577" title="All 2 branches missed.">                if (!targets.contains(taa)</span>
<span class="nc bnc" id="L6578" title="All 2 branches missed.">                        &amp;&amp; Compute.isInArc(game, getId(), getEquipmentNum(ams),</span>
<span class="nc" id="L6579">                                game.getEntity(taa.getEntityId()))) {</span>
<span class="nc" id="L6580">                    vTMAttacksInArc.addElement(taa);</span>
                }
<span class="nc" id="L6582">            }</span>
            //AMS Bays can fire at all incoming attacks each round
            //Point defense bays are added too. If they haven't fired
            //at something else already, they can attack now.
<span class="nc bnc" id="L6586" title="All 2 branches missed.">            if (ams.getType().hasFlag(WeaponType.F_AMSBAY)</span>
<span class="nc bnc" id="L6587" title="All 2 branches missed.">                    || (ams.getType().hasFlag(WeaponType.F_PDBAY)</span>
<span class="nc bnc" id="L6588" title="All 2 branches missed.">                            &amp;&amp; !ams.isUsedThisRound())) {</span>
<span class="nc bnc" id="L6589" title="All 2 branches missed.">                for (TeleMissileAttackAction taa : vTMAttacksInArc) {</span>
<span class="nc bnc" id="L6590" title="All 2 branches missed.">                    if (taa != null) {</span>
<span class="nc" id="L6591">                        taa.addCounterEquipment(ams);</span>
                    }
<span class="nc" id="L6593">                }</span>
            }
<span class="nc" id="L6595">        }</span>
<span class="nc" id="L6596">    }</span>

    /**
     * Assign AMS systems to the most dangerous incoming missile attacks. This
     * should only be called once per turn, or AMS will get extra attacks
     */
    public void assignAMS(Vector&lt;WeaponHandler&gt; vAttacks) {

<span class="nc" id="L6604">        HashSet&lt;WeaponAttackAction&gt; targets = new HashSet&lt;WeaponAttackAction&gt;();</span>
<span class="nc bnc" id="L6605" title="All 2 branches missed.">        for (Mounted ams : getActiveAMS()) {</span>
            // Ignore APDS, it gets assigned elsewhere
<span class="nc bnc" id="L6607" title="All 2 branches missed.">            if (ams.isAPDS()) {</span>
<span class="nc" id="L6608">                continue;</span>
            }

            // make a new vector of only incoming attacks in arc
<span class="nc" id="L6612">            Vector&lt;WeaponAttackAction&gt; vAttacksInArc = new Vector&lt;WeaponAttackAction&gt;(</span>
<span class="nc" id="L6613">                    vAttacks.size());</span>
<span class="nc bnc" id="L6614" title="All 2 branches missed.">            for (WeaponHandler wr : vAttacks) {</span>
<span class="nc bnc" id="L6615" title="All 2 branches missed.">                if (wr instanceof CapitalMissileBearingsOnlyHandler) {</span>
<span class="nc bnc" id="L6616" title="All 2 branches missed.">                    if (!targets.contains(wr.waa)</span>
<span class="nc bnc" id="L6617" title="All 2 branches missed.">                            &amp;&amp; Compute.isInArc(game, getId(), getEquipmentNum(ams),</span>
<span class="nc" id="L6618">                                    game.getTarget(wr.waa.getOriginalTargetType(), wr.waa.getOriginalTargetId()))) {</span>
<span class="nc" id="L6619">                        vAttacksInArc.addElement(wr.waa);</span>
                    }
                } else {
<span class="nc bnc" id="L6622" title="All 2 branches missed.">                    if (!targets.contains(wr.waa)</span>
<span class="nc bnc" id="L6623" title="All 2 branches missed.">                            &amp;&amp; Compute.isInArc(game, getId(), getEquipmentNum(ams),</span>
<span class="nc" id="L6624">                                    game.getEntity(wr.waa.getEntityId()))) {</span>
<span class="nc" id="L6625">                        vAttacksInArc.addElement(wr.waa);</span>
                    }
                }
<span class="nc" id="L6628">            }</span>
            //AMS Bays can fire at all incoming attacks each round
            //So can standard AMS if the unofficial option is turned on
<span class="nc bnc" id="L6631" title="All 2 branches missed.">            if ((ams.getType().hasFlag(WeaponType.F_AMSBAY))</span>
<span class="nc bnc" id="L6632" title="All 2 branches missed.">                    || (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_MULTI_USE_AMS)</span>
<span class="nc bnc" id="L6633" title="All 2 branches missed.">                            &amp;&amp; ams.getType().hasFlag(WeaponType.F_AMS))) {</span>
<span class="nc bnc" id="L6634" title="All 2 branches missed.">                for (WeaponAttackAction waa : vAttacksInArc) {</span>
<span class="nc bnc" id="L6635" title="All 2 branches missed.">                    if (waa != null) {</span>
<span class="nc" id="L6636">                        waa.addCounterEquipment(ams);</span>
                    }
<span class="nc" id="L6638">                }</span>
<span class="nc bnc" id="L6639" title="All 2 branches missed.">            } else if (ams.getType().hasFlag(WeaponType.F_PDBAY)) {</span>
            	//Point defense bays are assigned to the attack with the greatest threat
            	//Unlike single AMS, PD bays can gang up on 1 attack
<span class="nc" id="L6642">                WeaponAttackAction waa = Compute.getHighestExpectedDamage(game,</span>
                        vAttacksInArc, true);
<span class="nc bnc" id="L6644" title="All 2 branches missed.">                    if (waa != null) {</span>
<span class="nc" id="L6645">                    	waa.addCounterEquipment(ams);</span>
                    }
<span class="nc" id="L6647">            } else {</span>
            //Otherwise, find the most dangerous salvo by expected damage and target it
            // this ensures that only 1 AMS targets the strike. Use for non-bays.
<span class="nc" id="L6650">            WeaponAttackAction waa = Compute.getHighestExpectedDamage(game,</span>
                    vAttacksInArc, true);
<span class="nc bnc" id="L6652" title="All 2 branches missed.">                if (waa != null) {</span>
<span class="nc" id="L6653">                waa.addCounterEquipment(ams);</span>
<span class="nc" id="L6654">                targets.add(waa);</span>
                }
            }
<span class="nc" id="L6657">        }</span>
<span class="nc" id="L6658">    }</span>

    /**
     * has the team attached a narc pod to me?
     */
    public boolean isNarcedBy(int nTeamID) {
<span class="nc bnc" id="L6664" title="All 2 branches missed.">        for (NarcPod p : narcPods) {</span>
<span class="nc bnc" id="L6665" title="All 2 branches missed.">            if (p.getTeam() == nTeamID) {</span>
<span class="nc" id="L6666">                return true;</span>
            }
<span class="nc" id="L6668">        }</span>
<span class="nc" id="L6669">        return false;</span>
    }

    /**
     * add a narc pod from this team to the mech. Unremovable
     *
     * @param pod The &lt;code&gt;NarcPod&lt;/code&gt; to be attached.
     */
    public void attachNarcPod(NarcPod pod) {
<span class="nc" id="L6678">        pendingNarcPods.add(pod);</span>
<span class="nc" id="L6679">    }</span>

    /**
     * attach an iNarcPod
     *
     * @param pod The &lt;code&gt;INarcPod&lt;/code&gt; to be attached.
     */
    public void attachINarcPod(INarcPod pod) {
<span class="nc" id="L6687">        pendingINarcPods.add(pod);</span>
<span class="nc" id="L6688">    }</span>

    /**
     * Have we been iNarced with a homing pod from that team?
     *
     * @param nTeamID The id of the team that we are wondering about.
     * @return true if the Entity is narced by that team.
     */
    public boolean isINarcedBy(int nTeamID) {
<span class="nc bnc" id="L6697" title="All 2 branches missed.">        for (INarcPod pod : iNarcPods) {</span>
<span class="nc bnc" id="L6698" title="All 2 branches missed.">            if ((pod.getTeam() == nTeamID)</span>
<span class="nc bnc" id="L6699" title="All 2 branches missed.">                &amp;&amp; (pod.getType() == INarcPod.HOMING)) {</span>
<span class="nc" id="L6700">                return true;</span>
            }
<span class="nc" id="L6702">        }</span>
<span class="nc" id="L6703">        return false;</span>
    }

    /**
     * Have we been iNarced with the named pod from any team?
     *
     * @param type the &lt;code&gt;int&lt;/code&gt; type of iNarc pod.
     * @return &lt;code&gt;true&lt;/code&gt; if we have.
     */
    public boolean isINarcedWith(long type) {
<span class="nc bnc" id="L6713" title="All 2 branches missed.">        for (INarcPod pod : iNarcPods) {</span>
<span class="nc bnc" id="L6714" title="All 2 branches missed.">            if (pod.getType() == type) {</span>
<span class="nc" id="L6715">                return true;</span>
            }
<span class="nc" id="L6717">        }</span>
<span class="nc" id="L6718">        return false;</span>
    }

    /**
     * Remove all attached iNarc Pods
     */
    public void removeAllINarcPods() {
<span class="nc" id="L6725">        iNarcPods.clear();</span>
<span class="nc" id="L6726">    }</span>

    /**
     * Do we have any iNarc Pods attached?
     *
     * @return true iff one or more iNarcPods are attached.
     */
    public boolean hasINarcPodsAttached() {
<span class="nc bnc" id="L6734" title="All 2 branches missed.">        if (iNarcPods.size() &gt; 0) {</span>
<span class="nc" id="L6735">            return true;</span>
        }
<span class="nc" id="L6737">        return false;</span>
    }

    /**
     * Get an &lt;code&gt;Enumeration&lt;/code&gt; of &lt;code&gt;INarcPod&lt;/code&gt;s that are
     * attached to this entity.
     *
     * @return an &lt;code&gt;Enumeration&lt;/code&gt; of &lt;code&gt;INarcPod&lt;/code&gt;s.
     */
    public Iterator&lt;INarcPod&gt; getINarcPodsAttached() {
<span class="nc" id="L6747">        return iNarcPods.iterator();</span>
    }

    /**
     * Remove an &lt;code&gt;INarcPod&lt;/code&gt; from this entity.
     *
     * @param pod the &lt;code&gt;INarcPod&lt;/code&gt; to be removed.
     * @return &lt;code&gt;true&lt;/code&gt; if the pod was removed, &lt;code&gt;false&lt;/code&gt; if
     * the pod was not attached to this entity.
     */
    public boolean removeINarcPod(INarcPod pod) {
<span class="nc" id="L6758">        return iNarcPods.remove(pod);</span>
    }

    /**
     * Calculates the battle value of this entity
     */
    public abstract int calculateBattleValue();

    public boolean useGeometricMeanBV() {
<span class="nc bnc" id="L6767" title="All 4 branches missed.">        return useGeometricBV || ((game != null)</span>
<span class="nc bnc" id="L6768" title="All 2 branches missed.">                                  &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVANCED_GEOMETRIC_MEAN_BV));</span>
    }

    public boolean useReducedOverheatModifierBV() {
<span class="nc bnc" id="L6772" title="All 4 branches missed.">        return (useReducedOverheatModifierBV || ((game != null)</span>
<span class="nc bnc" id="L6773" title="All 2 branches missed.">                                                &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVANCED_REDUCED_OVERHEAT_MODIFIER_BV)));</span>
    }

    /**
     * Calculates the battle value of this mech. If the parameter is true, then
     * the battle value for c3 will be added whether the mech is currently part
     * of a network or not. This should be overwritten if necessary
     *
     * @param ignoreC3    if the contribution of the C3 computer should be ignored when
     *                    calculating BV.
     * @param ignorePilot if the extra BV due to piloting skill should be ignore, needed
     *                    for c3 bv
     */
    public int calculateBattleValue(boolean ignoreC3, boolean ignorePilot) {
<span class="nc bnc" id="L6787" title="All 2 branches missed.">        if (useManualBV) {</span>
<span class="nc" id="L6788">            return manualBV;</span>
        }
<span class="nc" id="L6790">        return calculateBattleValue();</span>
    }

    /**
     * Generates a vector containing reports on all useful information about
     * this entity.
     */
    public abstract Vector&lt;Report&gt; victoryReport();

    /**
     * Two entities are equal if their ids are equal
     */
    @Override
    public boolean equals(Object obj) {
<span class="nc bnc" id="L6804" title="All 2 branches missed.">        if(this == obj) {</span>
<span class="nc" id="L6805">            return true;</span>
        }
<span class="nc bnc" id="L6807" title="All 4 branches missed.">        if((null == obj) || (getClass() != obj.getClass())) {</span>
<span class="nc" id="L6808">            return false;</span>
        }
<span class="nc" id="L6810">        final Entity other = (Entity) obj;</span>
<span class="nc bnc" id="L6811" title="All 2 branches missed.">        return (id == other.id);</span>
    }

    @Override
    public int hashCode() {
<span class="nc" id="L6816">        return id;</span>
    }

    /**
     * Get the movement mode of the entity
     */
    public EntityMovementMode getMovementMode() {
<span class="nc" id="L6823">        return movementMode;</span>
    }

    /**
     * Get the movement mode of the entity as a String.
     */
    public String getMovementModeAsString() {
<span class="nc bnc" id="L6830" title="All 21 branches missed.">        switch (getMovementMode()) {</span>
            case NONE:
<span class="nc" id="L6832">                return &quot;None&quot;;</span>
            case BIPED:
            case BIPED_SWIM:
<span class="nc" id="L6835">                return &quot;Biped&quot;;</span>
            case QUAD:
            case QUAD_SWIM:
<span class="nc" id="L6838">                return &quot;Quad&quot;;</span>
            case TRACKED:
<span class="nc" id="L6840">                return &quot;Tracked&quot;;</span>
            case WHEELED:
<span class="nc" id="L6842">                return &quot;Wheeled&quot;;</span>
            case HOVER:
<span class="nc" id="L6844">                return &quot;Hover&quot;;</span>
            case VTOL:
<span class="nc" id="L6846">                return &quot;VTOL&quot;;</span>
            case NAVAL:
<span class="nc" id="L6848">                return &quot;Naval&quot;;</span>
            case HYDROFOIL:
<span class="nc" id="L6850">                return &quot;Hydrofoil&quot;;</span>
            case SUBMARINE:
<span class="nc" id="L6852">                return &quot;Submarine&quot;;</span>
            case INF_UMU:
<span class="nc" id="L6854">                return &quot;UMU&quot;;</span>
            case INF_LEG:
<span class="nc" id="L6856">                return &quot;Leg&quot;;</span>
            case INF_MOTORIZED:
<span class="nc" id="L6858">                return &quot;Motorized&quot;;</span>
            case INF_JUMP:
<span class="nc" id="L6860">                return &quot;Jump&quot;;</span>
            case WIGE:
<span class="nc" id="L6862">                return &quot;WiGE&quot;;</span>
            case AERODYNE:
<span class="nc" id="L6864">                return &quot;Aerodyne&quot;;</span>
            case SPHEROID:
<span class="nc" id="L6866">                return &quot;Spheroid&quot;;</span>
            case RAIL:
<span class="nc" id="L6868">                return &quot;Rail&quot;;</span>
            case MAGLEV:
<span class="nc" id="L6870">                return &quot;MagLev&quot;;</span>
            case STATION_KEEPING:
<span class="nc" id="L6872">                return &quot;Station-Keeping&quot;;</span>
            default:
<span class="nc" id="L6874">                return &quot;ERROR&quot;;</span>
        }
    }

    /**
     * Set the movement type of the entity
     */
    public void setMovementMode(EntityMovementMode movementMode) {
<span class="nc" id="L6882">        this.movementMode = movementMode;</span>
<span class="nc" id="L6883">    }</span>

    /**
     * Helper function to determine if a entity is a biped
     */
    public boolean entityIsBiped() {
<span class="nc bnc" id="L6889" title="All 2 branches missed.">        return (getMovementMode() == EntityMovementMode.BIPED);</span>
    }

    /**
     * Helper function to determine if a entity is a quad
     */
    public boolean entityIsQuad() {
<span class="nc bnc" id="L6896" title="All 2 branches missed.">        return (getMovementMode() == EntityMovementMode.QUAD);</span>
    }

    /**
     * Returns true is the entity needs a roll to stand up
     */
    public boolean needsRollToStand() {
<span class="nc" id="L6903">        return true;</span>
    }

    /**
     * Returns an entity's base piloting skill roll needed Only use this version
     * if the entity is through processing movement
     */
    public PilotingRollData getBasePilotingRoll() {
<span class="nc" id="L6911">        return getBasePilotingRoll(moved);</span>
    }

    /**
     * Returns an entity's base piloting skill roll needed
     */
    public PilotingRollData getBasePilotingRoll(EntityMovementType moveType) {
<span class="nc" id="L6918">        final int entityId = getId();</span>

        PilotingRollData roll;

        // Crew dead?
<span class="nc bnc" id="L6923" title="All 4 branches missed.">        if (getCrew().isDead() || getCrew().isDoomed()</span>
<span class="nc bnc" id="L6924" title="All 2 branches missed.">            || (getCrew().getHits() &gt;= 6)) {</span>
            // Following line switched from impossible to automatic failure
            // -- bug fix for dead units taking PSRs
<span class="nc" id="L6927">            return new PilotingRollData(entityId, TargetRoll.AUTOMATIC_FAIL,</span>
                                        &quot;Pilot dead&quot;);
        }
        // pilot awake?
<span class="nc bnc" id="L6931" title="All 2 branches missed.">        else if (!getCrew().isActive()) {</span>
<span class="nc" id="L6932">            return new PilotingRollData(entityId, TargetRoll.IMPOSSIBLE,</span>
                                        &quot;Pilot unconscious&quot;);
        }
        // gyro operational? does not apply if using tracked/quadvee vehicle/lam fighter movement
<span class="nc bnc" id="L6936" title="All 8 branches missed.">        if (isGyroDestroyed() &amp;&amp; canFall()</span>
                &amp;&amp; moveType != EntityMovementType.MOVE_VTOL_WALK
                &amp;&amp; moveType != EntityMovementType.MOVE_VTOL_RUN) {
<span class="nc" id="L6939">            return new PilotingRollData(entityId, TargetRoll.AUTOMATIC_FAIL,</span>
<span class="nc" id="L6940">                                        getCrew().getPiloting() + 6, &quot;Gyro destroyed&quot;);</span>
        }

        // both legs present?
<span class="nc bnc" id="L6944" title="All 2 branches missed.">        if ((this instanceof BipedMech)</span>
<span class="nc bnc" id="L6945" title="All 6 branches missed.">             &amp;&amp; (((BipedMech) this).countBadLegs() == 2)</span>
             &amp;&amp; (moveType != EntityMovementType.MOVE_VTOL_WALK)
             &amp;&amp; (moveType != EntityMovementType.MOVE_VTOL_RUN)) {
<span class="nc" id="L6948">                return new PilotingRollData(entityId,</span>
                                            TargetRoll.AUTOMATIC_FAIL,
<span class="nc" id="L6950">                                            getCrew().getPiloting() + 10, &quot;Both legs destroyed&quot;);</span>
<span class="nc bnc" id="L6951" title="All 2 branches missed.">        } else if (this instanceof QuadMech) {</span>
<span class="nc bnc" id="L6952" title="All 2 branches missed.">            if (((QuadMech) this).countBadLegs() &gt;= 3) {</span>
<span class="nc" id="L6953">                return new PilotingRollData(entityId,</span>
<span class="nc" id="L6954">                                            TargetRoll.AUTOMATIC_FAIL, getCrew().getPiloting()</span>
<span class="nc" id="L6955">                                                                       + (((Mech) this).countBadLegs() * 5),</span>
<span class="nc" id="L6956">                                            ((Mech) this).countBadLegs() + &quot; legs destroyed&quot;);</span>
            }
        }
        // entity shut down?
<span class="nc bnc" id="L6960" title="All 4 branches missed.">        if (isShutDown() &amp;&amp; isShutDownThisPhase()) {</span>
<span class="nc" id="L6961">            return new PilotingRollData(entityId, TargetRoll.AUTOMATIC_FAIL,</span>
<span class="nc" id="L6962">                                        getCrew().getPiloting() + 3, &quot;Reactor shut down&quot;);</span>
<span class="nc bnc" id="L6963" title="All 2 branches missed.">        } else if (isShutDown()) {</span>
<span class="nc" id="L6964">            return new PilotingRollData(entityId, TargetRoll.AUTOMATIC_FAIL,</span>
                                        TargetRoll.IMPOSSIBLE, &quot;Reactor shut down&quot;);
        }

        // okay, let's figure out the stuff then
<span class="nc" id="L6969">        roll = new PilotingRollData(entityId, getCrew().getPiloting(moveType),</span>
                                    &quot;Base piloting skill&quot;);

        // Let's see if we have a modifier to our piloting skill roll. We'll
        // pass in the roll
        // object and adjust as necessary
<span class="nc" id="L6975">        roll = addEntityBonuses(roll);</span>

        // add planetary condition modifiers
<span class="nc" id="L6978">        roll = addConditionBonuses(roll, moveType);</span>

<span class="nc bnc" id="L6980" title="All 4 branches missed.">        if (isCarefulStand() &amp;&amp; ((getWalkMP() - mpUsed) &gt; 2)) {</span>
<span class="nc" id="L6981">            roll.addModifier(-2, &quot;careful stand&quot;);</span>
        }

<span class="nc bnc" id="L6984" title="All 2 branches missed.">        if (hasQuirk(OptionsConstants.QUIRK_NEG_HARD_PILOT)) {</span>
<span class="nc" id="L6985">            roll.addModifier(+1, &quot;hard to pilot&quot;);</span>
        }

<span class="nc bnc" id="L6988" title="All 2 branches missed.">        if (getPartialRepairs() != null) {</span>
<span class="nc bnc" id="L6989" title="All 2 branches missed.">            if (getPartialRepairs().booleanOption(&quot;mech_gyro_1_crit&quot;)) {</span>
<span class="nc" id="L6990">                roll.addModifier(+1, &quot;Partial repair of Gyro (+1)&quot;);</span>
            }
<span class="nc bnc" id="L6992" title="All 2 branches missed.">            if (getPartialRepairs().booleanOption(&quot;mech_gyro_2_crit&quot;)) {</span>
<span class="nc" id="L6993">                roll.addModifier(+1, &quot;Partial repair of Gyro (+2)&quot;);</span>
            }
        }

<span class="nc bnc" id="L6997" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_FATIGUE)</span>
<span class="nc bnc" id="L6998" title="All 2 branches missed.">            &amp;&amp; crew.isPilotingFatigued()) {</span>
<span class="nc" id="L6999">            roll.addModifier(1, &quot;fatigue&quot;);</span>
        }

<span class="nc bnc" id="L7002" title="All 2 branches missed.">        if (taserInterference &gt; 0) {</span>
<span class="nc" id="L7003">            roll.addModifier(taserInterference, &quot;taser interference&quot;);</span>
        }

<span class="nc bnc" id="L7006" title="All 4 branches missed.">        if ((game.getPhase() == Phase.PHASE_MOVEMENT) &amp;&amp; isPowerReverse()) {</span>
<span class="nc" id="L7007">            roll.addModifier(1, &quot;power reverse&quot;);</span>
        }

<span class="nc" id="L7010">        return roll;</span>
    }

    /**
     * Add in any piloting skill mods
     */
    public abstract PilotingRollData addEntityBonuses(PilotingRollData roll);

    /**
     * Add in any modifiers due to global conditions like light/weather/etc.
     */
    public PilotingRollData addConditionBonuses(PilotingRollData roll,
            EntityMovementType moveType) {

<span class="nc bnc" id="L7024" title="All 4 branches missed.">        if (moveType == EntityMovementType.MOVE_SPRINT</span>
                || moveType == EntityMovementType.MOVE_VTOL_SPRINT) {
<span class="nc" id="L7026">            roll.addModifier(2, &quot;Sprinting&quot;);</span>
        }

<span class="nc" id="L7029">        PlanetaryConditions conditions = game.getPlanetaryConditions();</span>
        // check light conditions for &quot;running&quot; entities
<span class="nc bnc" id="L7031" title="All 10 branches missed.">        if ((moveType == EntityMovementType.MOVE_RUN)</span>
            || (moveType == EntityMovementType.MOVE_SPRINT)
            || (moveType == EntityMovementType.MOVE_VTOL_RUN)
            || (moveType == EntityMovementType.MOVE_OVER_THRUST)
            || (moveType == EntityMovementType.MOVE_VTOL_SPRINT)) {
<span class="nc" id="L7036">            int lightPenalty = conditions.getLightPilotPenalty();</span>
<span class="nc bnc" id="L7037" title="All 2 branches missed.">            if (lightPenalty &gt; 0) {</span>
<span class="nc" id="L7038">                roll.addModifier(lightPenalty,</span>
<span class="nc" id="L7039">                        conditions.getLightDisplayableName());</span>
            }
        }

        // check weather conditions for all entities
<span class="nc" id="L7044">        int weatherMod = conditions.getWeatherPilotPenalty();</span>
<span class="nc bnc" id="L7045" title="All 6 branches missed.">        if ((weatherMod != 0) &amp;&amp; !game.getBoard().inSpace()</span>
<span class="nc bnc" id="L7046" title="All 2 branches missed.">                &amp;&amp; ((null == crew) || !hasAbility(OptionsConstants.UNOFF_ALLWEATHER))) {</span>
<span class="nc" id="L7047">            roll.addModifier(weatherMod, conditions.getWeatherDisplayableName());</span>
        }

        // check wind conditions for all entities
<span class="nc" id="L7051">        int windMod = conditions.getWindPilotPenalty(this);</span>
<span class="nc bnc" id="L7052" title="All 6 branches missed.">        if ((windMod != 0) &amp;&amp; !game.getBoard().inSpace()</span>
<span class="nc bnc" id="L7053" title="All 2 branches missed.">                &amp;&amp; ((null == crew) || !hasAbility(OptionsConstants.UNOFF_ALLWEATHER))) {</span>
<span class="nc" id="L7054">            roll.addModifier(windMod, conditions.getWindDisplayableName());</span>
        }

<span class="nc" id="L7057">        return roll;</span>
    }

    /**
     * Checks if the entity is getting up. If so, returns the target roll for
     * the piloting skill check.
     */
    public PilotingRollData checkGetUp(MoveStep step,
            EntityMovementType moveType) {

<span class="nc bnc" id="L7067" title="All 2 branches missed.">        if ((step == null)</span>
<span class="nc bnc" id="L7068" title="All 2 branches missed.">            || ((step.getType() != MoveStepType.GET_UP)</span>
<span class="nc bnc" id="L7069" title="All 2 branches missed.">                    &amp;&amp; (step.getType() != MoveStepType.CAREFUL_STAND))) {</span>
<span class="nc" id="L7070">            return new PilotingRollData(id, TargetRoll.CHECK_FALSE,</span>
                    &quot;Check false: Entity is not attempting to get up.&quot;);
        }

<span class="nc" id="L7074">        PilotingRollData roll = getBasePilotingRoll(moveType);</span>

<span class="nc bnc" id="L7076" title="All 2 branches missed.">        if (this instanceof BipedMech) {</span>
<span class="nc bnc" id="L7077" title="All 2 branches missed.">            if ((((Mech) this).countBadLegs() &gt;= 1)</span>
<span class="nc bnc" id="L7078" title="All 2 branches missed.">                    &amp;&amp; (isLocationBad(Mech.LOC_LARM)</span>
<span class="nc bnc" id="L7079" title="All 2 branches missed.">                            &amp;&amp; isLocationBad(Mech.LOC_RARM))) {</span>
<span class="nc" id="L7080">                roll.addModifier(TargetRoll.IMPOSSIBLE,</span>
                        &quot;can't get up with destroyed leg and arms&quot;);
<span class="nc" id="L7082">                return roll;</span>
            }
        }

<span class="nc bnc" id="L7086" title="All 4 branches missed.">        if (isHullDown() &amp;&amp; (this instanceof QuadMech)) {</span>
<span class="nc" id="L7087">            roll.addModifier(TargetRoll.AUTOMATIC_SUCCESS,</span>
                    &quot;getting up from hull down&quot;);
<span class="nc" id="L7089">            return roll;</span>
        }

<span class="nc bnc" id="L7092" title="All 4 branches missed.">        if (!needsRollToStand() &amp;&amp; !isGyroDestroyed()) {</span>
<span class="nc" id="L7093">            roll.addModifier(TargetRoll.AUTOMATIC_SUCCESS, &quot;\n&quot;</span>
<span class="nc" id="L7094">                    + getDisplayName()</span>
                    + &quot; does not need to make a piloting skill check &quot;
                    + &quot;to stand up because it has all four of &quot; + &quot;its legs.&quot;);
<span class="nc" id="L7097">            return roll;</span>
        }

        // append the reason modifier
<span class="nc" id="L7101">        roll.append(new PilotingRollData(getId(), 0, &quot;getting up&quot;));</span>
<span class="nc" id="L7102">        addPilotingModifierForTerrain(roll, step);</span>
<span class="nc" id="L7103">        return roll;</span>
    }

    /**
     * Checks if the entity is attempting to run with damage that would force a
     * PSR. If so, returns the target roll for the piloting skill check.
     */
    public PilotingRollData checkRunningWithDamage(
            EntityMovementType overallMoveType) {
<span class="nc" id="L7112">        PilotingRollData roll = getBasePilotingRoll(overallMoveType);</span>

<span class="nc" id="L7114">        int gyroDamage = getBadCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                                         Mech.SYSTEM_GYRO, Mech.LOC_CT);
<span class="nc bnc" id="L7116" title="All 2 branches missed.">        if (getGyroType() == Mech.GYRO_HEAVY_DUTY) {</span>
<span class="nc" id="L7117">            gyroDamage--; // HD gyro ignores 1st damage</span>
        }
<span class="nc bnc" id="L7119" title="All 4 branches missed.">        if (((overallMoveType == EntityMovementType.MOVE_RUN)</span>
                || (overallMoveType == EntityMovementType.MOVE_SPRINT))
<span class="nc bnc" id="L7121" title="All 6 branches missed.">            &amp;&amp; canFall() &amp;&amp; ((gyroDamage &gt; 0) || hasHipCrit())) {</span>
            // append the reason modifier
<span class="nc" id="L7123">            roll.append(new PilotingRollData(getId(), 0,</span>
                                             &quot;running with damaged hip actuator or gyro&quot;));
        } else {
<span class="nc" id="L7126">            roll.addModifier(TargetRoll.CHECK_FALSE,</span>
                             &quot;Check false: Entity is not attempting to run with damage&quot;);
        }
<span class="nc" id="L7129">        addPilotingModifierForTerrain(roll);</span>
<span class="nc" id="L7130">        return roll;</span>
    }

    /**
     * Checks if the entity is attempting to sprint with MASC engaged. If so,
     * returns the target roll for the piloting skill check.
     */
    public PilotingRollData checkSprintingWithMASC(
            EntityMovementType overallMoveType, int used) {
<span class="nc" id="L7139">        PilotingRollData roll = getBasePilotingRoll(overallMoveType);</span>

<span class="nc bnc" id="L7141" title="All 4 branches missed.">        if ((overallMoveType == EntityMovementType.MOVE_SPRINT</span>
                || overallMoveType == EntityMovementType.MOVE_VTOL_SPRINT)
<span class="nc bnc" id="L7143" title="All 2 branches missed.">            &amp;&amp; (used &gt; ((int) Math.ceil(2.0 * this.getWalkMP())))) {</span>
<span class="nc" id="L7144">            roll.append(new PilotingRollData(getId(), 0,</span>
                                             &quot;sprinting with active MASC/Supercharger&quot;));
        } else {
<span class="nc" id="L7147">            roll.addModifier(TargetRoll.CHECK_FALSE,</span>
                             &quot;Check false: Entity is not attempting to sprint with MASC&quot;);
        }

<span class="nc" id="L7151">        addPilotingModifierForTerrain(roll);</span>
<span class="nc" id="L7152">        return roll;</span>
    }

    /**
     * Checks if the entity is attempting to sprint with supercharger engaged.
     * If so, returns the target roll for the piloting skill check.
     */
    public PilotingRollData checkSprintingWithSupercharger(
            EntityMovementType overallMoveType, int used) {
<span class="nc" id="L7161">        PilotingRollData roll = getBasePilotingRoll(overallMoveType);</span>

<span class="nc bnc" id="L7163" title="All 4 branches missed.">        if ((overallMoveType == EntityMovementType.MOVE_SPRINT</span>
                || overallMoveType == EntityMovementType.MOVE_VTOL_SPRINT)
<span class="nc bnc" id="L7165" title="All 2 branches missed.">            &amp;&amp; (used &gt; ((int) Math.ceil(2.5 * this.getWalkMP())))) {</span>
<span class="nc" id="L7166">            roll.append(new PilotingRollData(getId(), 0,</span>
                                             &quot;sprinting with active MASC/Supercharger&quot;));
        } else {
<span class="nc" id="L7169">            roll.addModifier(TargetRoll.CHECK_FALSE,</span>
                             &quot;Check false: Entity is not attempting to sprint with Supercharger&quot;);
        }

<span class="nc" id="L7173">        addPilotingModifierForTerrain(roll);</span>
<span class="nc" id="L7174">        return roll;</span>
    }

    /**
     * Checks if the entity is attempting to sprint with supercharger engaged.
     * If so, returns the target roll for the piloting skill check.
     */
    public PilotingRollData checkUsingOverdrive (EntityMovementType overallMoveType) {
<span class="nc" id="L7182">        PilotingRollData roll = getBasePilotingRoll(overallMoveType);</span>

<span class="nc bnc" id="L7184" title="All 8 branches missed.">        if ((overallMoveType == EntityMovementType.MOVE_SPRINT</span>
                || overallMoveType == EntityMovementType.MOVE_VTOL_SPRINT)
                &amp;&amp; (this instanceof Tank
<span class="nc bnc" id="L7187" title="All 2 branches missed.">                        || (this instanceof QuadVee &amp;&amp; getConversionMode() == QuadVee.CONV_MODE_VEHICLE))) {</span>
<span class="nc" id="L7188">            roll.append(new PilotingRollData(getId(), 0, &quot;using overdrive&quot;));</span>
        } else {
<span class="nc" id="L7190">            roll.addModifier(TargetRoll.CHECK_FALSE,</span>
                             &quot;Check false: Entity is not using overdrive&quot;);
        }

<span class="nc" id="L7194">        return roll;</span>
    }

    /**
     * Checks if the entity is attempting to increase two speed categories.
     * If so, returns the target roll for the piloting skill check.
     */
    public PilotingRollData checkGunningIt (EntityMovementType overallMoveType) {
<span class="nc" id="L7202">        PilotingRollData roll = getBasePilotingRoll(overallMoveType);</span>

<span class="nc bnc" id="L7204" title="All 6 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_VEHICLE_ACCELERATION)</span>
                &amp;&amp; (this instanceof Tank
<span class="nc bnc" id="L7206" title="All 2 branches missed.">                        || (this instanceof QuadVee &amp;&amp; getConversionMode() == QuadVee.CONV_MODE_VEHICLE))) {</span>
<span class="nc bnc" id="L7207" title="All 18 branches missed.">            if (((overallMoveType == EntityMovementType.MOVE_SPRINT</span>
                    || overallMoveType == EntityMovementType.MOVE_VTOL_SPRINT)
                    &amp;&amp; (movedLastRound == EntityMovementType.MOVE_WALK
                    || movedLastRound == EntityMovementType.MOVE_VTOL_WALK))
                    || ((overallMoveType == EntityMovementType.MOVE_RUN
                    || overallMoveType == EntityMovementType.MOVE_VTOL_RUN)
                            &amp;&amp; (movedLastRound == EntityMovementType.MOVE_NONE
                            || movedLastRound == EntityMovementType.MOVE_JUMP
                            || movedLastRound == EntityMovementType.MOVE_SKID))) {
<span class="nc" id="L7216">                roll.append(new PilotingRollData(getId(), 0, &quot;gunning it&quot;));</span>
<span class="nc" id="L7217">                return roll;</span>
            }
        }
<span class="nc" id="L7220">        roll.addModifier(TargetRoll.CHECK_FALSE,</span>
                &quot;Check false: Entity is not gunning it&quot;);
<span class="nc" id="L7222">        return roll;</span>
    }

    /**
     * Checks if an entity is passing through certain terrain while not moving
     * carefully
     */
    public PilotingRollData checkRecklessMove(MoveStep step,
            EntityMovementType moveType, IHex curHex, Coords lastPos,
            Coords curPos, IHex prevHex) {
<span class="nc" id="L7232">        PilotingRollData roll = getBasePilotingRoll(moveType);</span>
        // no need to go further if movement is careful
<span class="nc bnc" id="L7234" title="All 2 branches missed.">        if (step.isCareful()) {</span>
<span class="nc" id="L7235">            roll.addModifier(TargetRoll.CHECK_FALSE, &quot;moving carefully&quot;);</span>
<span class="nc" id="L7236">            return roll;</span>
        }

        // this only applies in fog, night conditions, or if a hex along the
        // move path has ice
<span class="nc bnc" id="L7241" title="All 2 branches missed.">        boolean isFoggy = game.getPlanetaryConditions().getFog() != PlanetaryConditions.FOG_NONE;</span>
<span class="nc bnc" id="L7242" title="All 2 branches missed.">        boolean isDark = game.getPlanetaryConditions().getLight() &gt; PlanetaryConditions.L_DUSK;</span>

        // if we are jumping, then no worries
<span class="nc bnc" id="L7245" title="All 2 branches missed.">        if (moveType == EntityMovementType.MOVE_JUMP) {</span>
<span class="nc" id="L7246">            roll.addModifier(TargetRoll.CHECK_FALSE, &quot;jumping is not reckless?&quot;);</span>
<span class="nc" id="L7247">            return roll;</span>
        }

        // we need to make this check on the first move forward and anytime the
        // hex is not clear or is a level change
<span class="nc bnc" id="L7252" title="All 6 branches missed.">        if ((isFoggy || isDark) &amp;&amp; !lastPos.equals(curPos)</span>
<span class="nc bnc" id="L7253" title="All 2 branches missed.">            &amp;&amp; lastPos.equals(step.getEntity().getPosition())) {</span>
<span class="nc" id="L7254">            roll.append(new PilotingRollData(getId(), 0, &quot;moving recklessly&quot;));</span>
        }
        // FIXME: no perfect solution in the current code to determine if hex is
        // clear. I will use movement costs
<span class="nc bnc" id="L7258" title="All 4 branches missed.">        else if ((isFoggy || isDark)</span>
<span class="nc bnc" id="L7259" title="All 2 branches missed.">                 &amp;&amp; !lastPos.equals(curPos)</span>
<span class="nc bnc" id="L7260" title="All 4 branches missed.">                 &amp;&amp; ((curHex.movementCost(this) &gt; 0) || ((null != prevHex) &amp;&amp; (prevHex</span>
<span class="nc" id="L7261">                                                                                       .getLevel() != curHex</span>
<span class="nc bnc" id="L7262" title="All 2 branches missed.">                                                                                       .getLevel())))) {</span>
<span class="nc" id="L7263">            roll.append(new PilotingRollData(getId(), 0, &quot;moving recklessly&quot;));</span>
            // ice conditions
<span class="nc bnc" id="L7265" title="All 2 branches missed.">        } else if (curHex.containsTerrain(Terrains.ICE)) {</span>
<span class="nc" id="L7266">            roll.append(new PilotingRollData(getId(), 0, &quot;moving recklessly&quot;));</span>
        } else {
<span class="nc" id="L7268">            roll.addModifier(TargetRoll.CHECK_FALSE, &quot;not moving recklessly&quot;);</span>
        }

<span class="nc" id="L7271">        adjustDifficultTerrainPSRModifier(roll);</span>

<span class="nc" id="L7273">        return roll;</span>
    }

    /**
     * Checks if the entity is landing (from a jump) with damage that would
     * force a PSR. If so, returns the target roll for the piloting skill check.
     */
    public PilotingRollData checkLandingWithDamage(
            EntityMovementType overallMoveType) {
<span class="nc" id="L7282">        PilotingRollData roll = getBasePilotingRoll(overallMoveType);</span>

<span class="nc" id="L7284">        int gyroHits = getBadCriticals(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_GYRO, Mech.LOC_CT);</span>
        //Heavy duty gyro does not force PSR until second hit
<span class="nc bnc" id="L7286" title="All 4 branches missed.">        if (getGyroType() == Mech.GYRO_HEAVY_DUTY || getGyroType() == Mech.GYRO_SUPERHEAVY) {</span>
<span class="nc" id="L7287">            gyroHits--;</span>
        }
<span class="nc bnc" id="L7289" title="All 4 branches missed.">        if (gyroHits &gt; 0 || hasLegActuatorCrit()) {</span>
            // append the reason modifier
<span class="nc" id="L7291">            roll.append(new PilotingRollData(getId(), 0,</span>
                                             &quot;landing with damaged leg actuator or gyro&quot;));
<span class="nc" id="L7293">            addPilotingModifierForTerrain(roll);</span>
        } else {
<span class="nc" id="L7295">            roll.addModifier(</span>
                    TargetRoll.CHECK_FALSE,
                    &quot;Entity does not have gyro or leg actuator damage -- checking for purposes of determining PSR &quot; +
                    &quot;after jump.&quot;);
        }
<span class="nc" id="L7300">        return roll;</span>
    }

    /**
     * Checks if the entity is landing (from a jump) with a prototype JJ If so,
     * returns the target roll for the piloting skill check.
     */
    public PilotingRollData checkLandingWithPrototypeJJ(
            EntityMovementType overallMoveType) {
<span class="nc" id="L7309">        PilotingRollData roll = getBasePilotingRoll(overallMoveType);</span>

<span class="nc bnc" id="L7311" title="All 2 branches missed.">        if (getJumpType() == Mech.JUMP_PROTOTYPE) {</span>
            // append the reason modifier
<span class="nc" id="L7313">            roll.append(new PilotingRollData(getId(), 3,</span>
                                             &quot;landing with prototype jump jets&quot;));
<span class="nc" id="L7315">            addPilotingModifierForTerrain(roll);</span>
        } else {
<span class="nc" id="L7317">            roll.addModifier(</span>
                    TargetRoll.CHECK_FALSE,
                    &quot;Entity does not have protype jump jets -- checking for purposes of determining PSR after jump.&quot;);
        }
<span class="nc" id="L7321">        return roll;</span>
    }

    /**
     * Checks if an entity is landing (from a jump) in heavy woods.
     */
    public PilotingRollData checkLandingInHeavyWoods(
            EntityMovementType overallMoveType, IHex curHex) {
<span class="nc" id="L7329">        PilotingRollData roll = getBasePilotingRoll(overallMoveType);</span>
<span class="nc bnc" id="L7330" title="All 2 branches missed.">        if (curHex.containsTerrain(Terrains.WOODS, 2)) {</span>
<span class="nc" id="L7331">            roll.append(new PilotingRollData(getId(), 0,</span>
                    &quot;landing in heavy woods&quot;));
<span class="nc" id="L7333">            addPilotingModifierForTerrain(roll);</span>
<span class="nc bnc" id="L7334" title="All 2 branches missed.">        } else if (curHex.containsTerrain(Terrains.WOODS, 3)) {</span>
<span class="nc" id="L7335">            roll.append(new PilotingRollData(getId(), 0,</span>
                    &quot;landing in ultra woods&quot;));
<span class="nc" id="L7337">            addPilotingModifierForTerrain(roll);</span>
        } else {
<span class="nc" id="L7339">            roll.addModifier(TargetRoll.CHECK_FALSE,</span>
                    &quot;hex does not contain heavy or ultra woods&quot;);
        }
<span class="nc" id="L7342">        return roll;</span>
    }

    /**
     * Checks if the entity is landing (from a jump) on ice-covered water.
     */
    public PilotingRollData checkLandingOnIce(
            EntityMovementType overallMoveType, IHex curHex) {
<span class="nc" id="L7350">        PilotingRollData roll = getBasePilotingRoll(overallMoveType);</span>

<span class="nc bnc" id="L7352" title="All 2 branches missed.">        if (curHex.containsTerrain(Terrains.ICE)</span>
<span class="nc bnc" id="L7353" title="All 2 branches missed.">            &amp;&amp; (curHex.terrainLevel(Terrains.WATER) &gt; 0)) {</span>
<span class="nc" id="L7354">            roll.append(new PilotingRollData(getId(), 0,</span>
                                             &quot;landing on ice-covered water&quot;));
<span class="nc" id="L7356">            addPilotingModifierForTerrain(roll);</span>
<span class="nc" id="L7357">            adjustDifficultTerrainPSRModifier(roll);</span>
        } else {
<span class="nc" id="L7359">            roll.addModifier(TargetRoll.CHECK_FALSE,</span>
                             &quot;hex is not covered by ice&quot;);
        }

<span class="nc" id="L7363">        return roll;</span>
    }

    /**
     * return a &lt;code&gt;PilotingRollData&lt;/code&gt; checking for whether this Entity
     * moved too fast due to low gravity
     *
     * @param step
     * @return
     */
    public PilotingRollData checkMovedTooFast(MoveStep step,
            EntityMovementType moveType) {
<span class="nc" id="L7375">        PilotingRollData roll = getBasePilotingRoll(moveType);</span>
<span class="nc" id="L7376">        addPilotingModifierForTerrain(roll, step);</span>
<span class="nc" id="L7377">        int maxSafeMP = 0;</span>
<span class="nc bnc" id="L7378" title="All 3 branches missed.">        switch (moveType) {</span>
            case MOVE_JUMP:
<span class="nc" id="L7380">                maxSafeMP = getJumpMP(false);</span>
<span class="nc" id="L7381">                break;</span>
            case MOVE_SPRINT:
            case MOVE_VTOL_SPRINT:
<span class="nc" id="L7384">                maxSafeMP = getSprintMP(false, true, true) + wigeBonus;</span>
<span class="nc bnc" id="L7385" title="All 4 branches missed.">                if (isEligibleForPavementBonus() &amp;&amp; gotPavementBonus) {</span>
<span class="nc" id="L7386">                    maxSafeMP++;</span>
                }
                break;
            default:
                // Max safe MP is based on whatever is the current maximum.
                // http://bg.battletech.com/forums/index.php?topic=6681.msg154097#msg154097
<span class="nc" id="L7392">                maxSafeMP = getRunMP(false, true, true) + wigeBonus;</span>
<span class="nc bnc" id="L7393" title="All 4 branches missed.">                if (isEligibleForPavementBonus() &amp;&amp; gotPavementBonus) {</span>
<span class="nc" id="L7394">                    maxSafeMP++;</span>
                }
                break;
        }
<span class="nc bnc" id="L7398" title="All 2 branches missed.">        if (step.getMpUsed() &gt; maxSafeMP) {</span>
<span class="nc" id="L7399">            roll.append(new PilotingRollData(getId(), 0,</span>
                    &quot;used more MPs than at 1G possible&quot;));
        } else {
<span class="nc" id="L7402">            roll.addModifier(TargetRoll.CHECK_FALSE,</span>
                    &quot;Check false: Entity did not use more &quot;
                    + &quot;MPs walking/running than possible at 1G&quot;);
        }
<span class="nc" id="L7406">        return roll;</span>
    }

    /**
     * Checks if the entity might skid on pavement. If so, returns the target
     * roll for the piloting skill check.
     */
    public PilotingRollData checkSkid(EntityMovementType moveType, IHex prevHex,
            EntityMovementType overallMoveType, MoveStep prevStep, MoveStep currStep,
            int prevFacing, int curFacing, Coords lastPos, Coords curPos,
            boolean isInfantry, int distance) {

<span class="nc" id="L7418">        PilotingRollData roll = getBasePilotingRoll(overallMoveType);</span>
        // If we aren't traveling along a road, apply terrain modifiers
<span class="nc bnc" id="L7420" title="All 6 branches missed.">        if (!((prevStep == null || prevStep.isPavementStep()) &amp;&amp; currStep.isPavementStep())) {</span>
<span class="nc" id="L7421">            addPilotingModifierForTerrain(roll, lastPos);</span>
        }

<span class="nc bnc" id="L7424" title="All 4 branches missed.">        if (isAirborne() || isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L7425">            roll.addModifier(TargetRoll.CHECK_FALSE,</span>
                    &quot;Check false: flying entities don't skid&quot;);
<span class="nc" id="L7427">            return roll;</span>
        }

<span class="nc bnc" id="L7430" title="All 2 branches missed.">        if (isInfantry) {</span>
<span class="nc" id="L7431">            roll.addModifier(TargetRoll.CHECK_FALSE,</span>
                    &quot;Check false: infantry don't skid&quot;);
<span class="nc" id="L7433">            return roll;</span>
        }

<span class="nc bnc" id="L7436" title="All 2 branches missed.">        if (moveType == EntityMovementType.MOVE_JUMP) {</span>
<span class="nc" id="L7437">            roll.addModifier(TargetRoll.CHECK_FALSE,</span>
                    &quot;Check false: jumping entities don't skid&quot;);
<span class="nc" id="L7439">            return roll;</span>
        }

<span class="nc bnc" id="L7442" title="All 4 branches missed.">        if ((null != prevStep) &amp;&amp; prevStep.isHasJustStood()) {</span>
<span class="nc" id="L7443">            roll.addModifier(TargetRoll.CHECK_FALSE,</span>
                    &quot;Check false: getting up entities don't skid&quot;);
<span class="nc" id="L7445">            return roll;</span>
        }

        /*
         * IHex curHex = null; if (null != curPos) { curHex =
         * game.getBoard().getHex(curPos); }
         */

        boolean prevStepPavement;
<span class="nc bnc" id="L7454" title="All 2 branches missed.">        if (prevStep != null) {</span>
<span class="nc" id="L7455">            prevStepPavement = prevStep.isPavementStep();</span>
        } else {
<span class="nc" id="L7457">            prevStepPavement = prevHex.hasPavement();</span>
        }

        // TODO: add check for elevation of pavement, road,
        // or bridge matches entity elevation.
<span class="nc bnc" id="L7462" title="All 12 branches missed.">        if ((prevHex != null) &amp;&amp; prevHex.containsTerrain(Terrains.ICE)</span>
                &amp;&amp; (((movementMode != EntityMovementMode.HOVER)
                        &amp;&amp; (movementMode != EntityMovementMode.WIGE))
                        || (((movementMode == EntityMovementMode.HOVER)
                                || (movementMode == EntityMovementMode.WIGE))
<span class="nc" id="L7467">                                &amp;&amp; ((game.getPlanetaryConditions()</span>
<span class="nc bnc" id="L7468" title="All 2 branches missed.">                                        .getWeather() == PlanetaryConditions.WE_HEAVY_SNOW)</span>
<span class="nc" id="L7469">                                        || (game.getPlanetaryConditions()</span>
<span class="nc bnc" id="L7470" title="All 2 branches missed.">                                                .getWeather() == PlanetaryConditions.WE_BLIZZARD)</span>
<span class="nc" id="L7471">                                        || (game.getPlanetaryConditions()</span>
<span class="nc bnc" id="L7472" title="All 4 branches missed.">                                                .getWindStrength() &gt;= PlanetaryConditions.WI_STORM))))</span>
<span class="nc bnc" id="L7473" title="All 2 branches missed.">                &amp;&amp; (prevFacing != curFacing) &amp;&amp; !lastPos.equals(curPos)) {</span>
<span class="nc" id="L7474">            roll.append(new PilotingRollData(getId(),</span>
<span class="nc" id="L7475">                    getMovementBeforeSkidPSRModifier(distance),</span>
                    &quot;turning on ice&quot;));
<span class="nc" id="L7477">            adjustDifficultTerrainPSRModifier(roll);</span>
<span class="nc" id="L7478">            return roll;</span>
<span class="nc bnc" id="L7479" title="All 12 branches missed.">        } else if ((prevStepPavement</span>
                &amp;&amp; ((overallMoveType == EntityMovementType.MOVE_RUN)
                        || (overallMoveType == EntityMovementType.MOVE_SPRINT))
                &amp;&amp; (movementMode != EntityMovementMode.HOVER)
                &amp;&amp; (movementMode != EntityMovementMode.WIGE))
<span class="nc bnc" id="L7484" title="All 2 branches missed.">                &amp;&amp; (prevFacing != curFacing) &amp;&amp; !lastPos.equals(curPos)) {</span>
<span class="nc bnc" id="L7485" title="All 2 branches missed.">            if (this instanceof Mech) {</span>
<span class="nc" id="L7486">                roll.append(new PilotingRollData(getId(),</span>
<span class="nc" id="L7487">                        getMovementBeforeSkidPSRModifier(distance),</span>
                        &quot;running &amp; turning on pavement&quot;));
            } else {
<span class="nc" id="L7490">                roll.append(new PilotingRollData(getId(),</span>
<span class="nc" id="L7491">                        getMovementBeforeSkidPSRModifier(distance),</span>
                        &quot;reckless driving on pavement&quot;));
            }
<span class="nc" id="L7494">            adjustDifficultTerrainPSRModifier(roll);</span>
<span class="nc" id="L7495">            return roll;</span>
        } else {
<span class="nc" id="L7497">            roll.addModifier(TargetRoll.CHECK_FALSE,</span>
                    &quot;Check false: Entity is not apparently skidding&quot;);
<span class="nc" id="L7499">            return roll;</span>
        }
    }

    /**
     * Checks if the entity is moving into rubble. If so, returns the target
     * roll for the piloting skill check.
     */
    public PilotingRollData checkRubbleMove(MoveStep step,
            EntityMovementType moveType, IHex curHex, Coords lastPos,
            Coords curPos, boolean isLastStep, boolean isPavementStep) {
<span class="nc" id="L7510">        PilotingRollData roll = getBasePilotingRoll(moveType);</span>
<span class="nc" id="L7511">        boolean enteringRubble = true;</span>
<span class="nc" id="L7512">        addPilotingModifierForTerrain(roll, curPos, enteringRubble);</span>

<span class="nc bnc" id="L7514" title="All 6 branches missed.">        if (!lastPos.equals(curPos)</span>
                &amp;&amp; ((moveType != EntityMovementType.MOVE_JUMP) || isLastStep)
<span class="nc bnc" id="L7516" title="All 4 branches missed.">                &amp;&amp; (curHex.terrainLevel(Terrains.RUBBLE) &gt; 0) &amp;&amp; !isPavementStep</span>
<span class="nc bnc" id="L7517" title="All 4 branches missed.">                &amp;&amp; (step.getElevation() == 0) &amp;&amp; canFall()) {</span>
<span class="nc" id="L7518">            adjustDifficultTerrainPSRModifier(roll);</span>
<span class="nc bnc" id="L7519" title="All 2 branches missed.">            if (hasAbility(OptionsConstants.PILOT_TM_MOUNTAINEER)) {</span>
<span class="nc" id="L7520">                roll.addModifier(-1, &quot;Mountaineer&quot;);</span>
            }
        } else {
<span class="nc" id="L7523">            roll.addModifier(TargetRoll.CHECK_FALSE,</span>
                    &quot;Check false: Entity is not entering rubble&quot;);
        }

<span class="nc" id="L7527">        return roll;</span>
    }

    /**
     * Checks if the entity is moving into a hex that might cause it to bog
     * down. If so, returns the target roll for the piloting skill check.
     */
    public PilotingRollData checkBogDown(MoveStep step,
            EntityMovementType moveType, IHex curHex, Coords lastPos,
            Coords curPos, int lastElev, boolean isPavementStep) {
<span class="nc" id="L7537">        PilotingRollData roll = getBasePilotingRoll(moveType);</span>
<span class="nc" id="L7538">        int bgMod = curHex.getBogDownModifier(getMovementMode(),</span>
                this instanceof LargeSupportTank);
<span class="nc bnc" id="L7540" title="All 8 branches missed.">        if ((!lastPos.equals(curPos) || (step.getElevation() != lastElev))</span>
                &amp;&amp; (bgMod != TargetRoll.AUTOMATIC_SUCCESS)
                &amp;&amp; (moveType != EntityMovementType.MOVE_JUMP)
<span class="nc bnc" id="L7543" title="All 4 branches missed.">                &amp;&amp; (step.getElevation() == 0) &amp;&amp; !isPavementStep) {</span>
<span class="nc" id="L7544">            roll.append(</span>
<span class="nc" id="L7545">                    new PilotingRollData(getId(), bgMod, &quot;avoid bogging down&quot;));</span>
<span class="nc bnc" id="L7546" title="All 4 branches missed.">            if ((this instanceof Mech) &amp;&amp; ((Mech) this).isSuperHeavy()) {</span>
<span class="nc" id="L7547">                roll.addModifier(1, &quot;superheavy mech avoiding bogging down&quot;);</span>
            }
<span class="nc bnc" id="L7549" title="All 2 branches missed.">            if (hasAbility(OptionsConstants.PILOT_TM_SWAMP_BEAST)) {</span>
<span class="nc" id="L7550">                roll.addModifier(-1, &quot;Swamp Beast&quot;);</span>
            }
<span class="nc" id="L7552">            addPilotingModifierForTerrain(roll, curPos, false);</span>
<span class="nc" id="L7553">            adjustDifficultTerrainPSRModifier(roll);</span>
        } else {
<span class="nc" id="L7555">            roll.addModifier(TargetRoll.CHECK_FALSE,</span>
                    &quot;Check false: Not entering bog-down terrain, &quot;
                    + &quot;or jumping/hovering over such terrain&quot;);
        }
<span class="nc" id="L7559">        return roll;</span>
    }

    /**
     * Checks if the entity is moving into depth 1+ water. If so, returns the
     * target roll for the piloting skill check.
     */
    public PilotingRollData checkWaterMove(MoveStep step,
            EntityMovementType moveType, IHex curHex, Coords lastPos,
            Coords curPos, boolean isPavementStep) {
<span class="nc bnc" id="L7569" title="All 2 branches missed.">        if ((curHex.terrainLevel(Terrains.WATER) &gt; 0)</span>
<span class="nc bnc" id="L7570" title="All 6 branches missed.">            &amp;&amp; (step.getElevation() &lt; 0) &amp;&amp; !lastPos.equals(curPos)</span>
            &amp;&amp; (moveType != EntityMovementType.MOVE_JUMP)
<span class="nc bnc" id="L7572" title="All 2 branches missed.">            &amp;&amp; (getMovementMode() != EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L7573" title="All 2 branches missed.">            &amp;&amp; (getMovementMode() != EntityMovementMode.VTOL)</span>
<span class="nc bnc" id="L7574" title="All 2 branches missed.">            &amp;&amp; (getMovementMode() != EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L7575" title="All 2 branches missed.">            &amp;&amp; (getMovementMode() != EntityMovementMode.HYDROFOIL)</span>
<span class="nc bnc" id="L7576" title="All 2 branches missed.">            &amp;&amp; (getMovementMode() != EntityMovementMode.SUBMARINE)</span>
<span class="nc bnc" id="L7577" title="All 2 branches missed.">            &amp;&amp; (getMovementMode() != EntityMovementMode.INF_UMU)</span>
<span class="nc bnc" id="L7578" title="All 2 branches missed.">            &amp;&amp; (getMovementMode() != EntityMovementMode.BIPED_SWIM)</span>
<span class="nc bnc" id="L7579" title="All 2 branches missed.">            &amp;&amp; (getMovementMode() != EntityMovementMode.QUAD_SWIM)</span>
<span class="nc bnc" id="L7580" title="All 2 branches missed.">            &amp;&amp; (getMovementMode() != EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L7581" title="All 4 branches missed.">            &amp;&amp; canFall()</span>
            &amp;&amp; !isPavementStep) {
<span class="nc" id="L7583">            return checkWaterMove(curHex.terrainLevel(Terrains.WATER), moveType);</span>
        }
<span class="nc" id="L7585">        return checkWaterMove(0, moveType);</span>
    }

    /**
     * Checks if the entity is moving into depth 1+ water. If so, returns the
     * target roll for the piloting skill check.
     */
    public PilotingRollData checkWaterMove(int waterLevel,
            EntityMovementType overallMoveType) {
<span class="nc" id="L7594">        PilotingRollData roll = getBasePilotingRoll(overallMoveType);</span>

        int mod;
<span class="nc bnc" id="L7597" title="All 2 branches missed.">        if (waterLevel == 1) {</span>
<span class="nc" id="L7598">            mod = -1;</span>
<span class="nc bnc" id="L7599" title="All 2 branches missed.">        } else if (waterLevel == 2) {</span>
<span class="nc" id="L7600">            mod = 0;</span>
        } else {
<span class="nc" id="L7602">            mod = 1;</span>
        }

<span class="nc bnc" id="L7605" title="All 8 branches missed.">        if ((waterLevel &gt; 1) &amp;&amp; hasAbility(OptionsConstants.PILOT_TM_FROGMAN)</span>
                &amp;&amp; ((this instanceof Mech) || (this instanceof Protomech))) {
<span class="nc" id="L7607">            roll.append(new PilotingRollData(getId(), -1, &quot;Frogman&quot;));</span>
        }
<span class="nc bnc" id="L7609" title="All 2 branches missed.">        if (waterLevel &gt; 0) {</span>
            // append the reason modifier
<span class="nc" id="L7611">            roll.append(new PilotingRollData(getId(), mod,</span>
                    &quot;entering Depth &quot; + waterLevel + &quot; Water&quot;));
<span class="nc" id="L7613">            adjustDifficultTerrainPSRModifier(roll);</span>
        } else {
<span class="nc" id="L7615">            roll.addModifier(TargetRoll.CHECK_FALSE,</span>
                    &quot;Check false: No water here.&quot;);
        }

<span class="nc" id="L7619">        return roll;</span>
    }

    /**
     * Checks if the entity is being swarmed. If so, returns the target roll for
     * the piloting skill check to dislodge them.
     */
    public PilotingRollData checkDislodgeSwarmers(MoveStep step,
            EntityMovementType moveType) {

        // If we're not being swarmed, return CHECK_FALSE
<span class="nc bnc" id="L7630" title="All 2 branches missed.">        if (Entity.NONE == getSwarmAttackerId()) {</span>
<span class="nc" id="L7631">            return new PilotingRollData(getId(), TargetRoll.CHECK_FALSE,</span>
                    &quot;Check false: No swarmers attached&quot;);
        }

        // append the reason modifier
<span class="nc" id="L7636">        PilotingRollData roll = getBasePilotingRoll(moveType);</span>
<span class="nc" id="L7637">        roll.append(new PilotingRollData(getId(), 0,</span>
                &quot;attempting to dislodge swarmers by dropping prone&quot;));
<span class="nc" id="L7639">        addPilotingModifierForTerrain(roll, step);</span>

<span class="nc" id="L7641">        return roll;</span>
    }

    /**
     * Checks to see if an entity is moving through building walls. Note: this
     * method returns true/false, unlike the other checkStuff() methods above.
     *
     * @return 0, no eligible building; 1, exiting; 2, entering; 3, both; 4,
     * stepping on roof, 8 changing elevations within a building
     */
    public int checkMovementInBuilding(MoveStep step, MoveStep prevStep,
                                       Coords curPos, Coords prevPos) {
<span class="nc bnc" id="L7653" title="All 2 branches missed.">        if ((prevPos == null)</span>
<span class="nc bnc" id="L7654" title="All 4 branches missed.">            || (prevPos.equals(curPos) &amp;&amp; !(this instanceof Protomech))) {</span>
<span class="nc" id="L7655">            return 0;</span>
        }
<span class="nc" id="L7657">        IHex curHex = game.getBoard().getHex(curPos);</span>
<span class="nc" id="L7658">        IHex prevHex = game.getBoard().getHex(prevPos);</span>
        // ineligible because of movement type or unit type
<span class="nc bnc" id="L7660" title="All 2 branches missed.">        if (isAirborne()) {</span>
<span class="nc" id="L7661">            return 0;</span>
        }

<span class="nc bnc" id="L7664" title="All 2 branches missed.">        if ((this instanceof Infantry)</span>
<span class="nc bnc" id="L7665" title="All 2 branches missed.">            &amp;&amp; (step.getMovementType(false) != EntityMovementType.MOVE_JUMP)) {</span>
<span class="nc" id="L7666">            return 0;</span>
        }

<span class="nc bnc" id="L7669" title="All 4 branches missed.">        if ((this instanceof Protomech) &amp;&amp; (prevStep != null)</span>
<span class="nc bnc" id="L7670" title="All 2 branches missed.">            &amp;&amp; (prevStep.getMovementType(false) == EntityMovementType.MOVE_JUMP)) {</span>
<span class="nc" id="L7671">            return 0;</span>
        }

        // check for movement inside a hangar
<span class="nc" id="L7675">        Building curBldg = game.getBoard().getBuildingAt(curPos);</span>
<span class="nc bnc" id="L7676" title="All 2 branches missed.">        if ((null != curBldg)</span>
<span class="nc bnc" id="L7677" title="All 2 branches missed.">            &amp;&amp; curBldg.isIn(prevPos)</span>
<span class="nc bnc" id="L7678" title="All 2 branches missed.">            &amp;&amp; (curBldg.getBldgClass() == Building.HANGAR)</span>
<span class="nc bnc" id="L7679" title="All 2 branches missed.">            &amp;&amp; (curHex.terrainLevel(Terrains.BLDG_ELEV) &gt; height())</span>
<span class="nc" id="L7680">            &amp;&amp; (step.getElevation() &lt; curHex</span>
<span class="nc bnc" id="L7681" title="All 2 branches missed.">                .terrainLevel(Terrains.BLDG_ELEV))) {</span>
<span class="nc" id="L7682">            return 0;</span>
        }

<span class="nc" id="L7685">        int rv = 0;</span>
        // check current hex for building
<span class="nc bnc" id="L7687" title="All 2 branches missed.">        if (step.getElevation() &lt; curHex.terrainLevel(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L7688">            rv += 2;</span>
<span class="nc" id="L7689">        } else if (((step.getElevation() == curHex</span>
<span class="nc bnc" id="L7690" title="All 2 branches missed.">                .terrainLevel(Terrains.BLDG_ELEV)) || (step.getElevation() == curHex</span>
<span class="nc bnc" id="L7691" title="All 2 branches missed.">                .terrainLevel(Terrains.BRIDGE_ELEV)))</span>
<span class="nc bnc" id="L7692" title="All 2 branches missed.">                   &amp;&amp; (step.getMovementType(false) != EntityMovementType.MOVE_JUMP)) {</span>
<span class="nc" id="L7693">            rv += 4;</span>
        }
        // check previous hex for building
<span class="nc bnc" id="L7696" title="All 2 branches missed.">        if (prevHex != null) {</span>
<span class="nc" id="L7697">            int prevEl = getElevation();</span>
<span class="nc bnc" id="L7698" title="All 2 branches missed.">            if (prevStep != null) {</span>
<span class="nc" id="L7699">                prevEl = prevStep.getElevation();</span>
            }
<span class="nc bnc" id="L7701" title="All 2 branches missed.">            if ((prevEl &lt; prevHex.terrainLevel(Terrains.BLDG_ELEV))</span>
<span class="nc bnc" id="L7702" title="All 2 branches missed.">                &amp;&amp; ((curHex.terrainLevel(Terrains.BLDG_CLASS) != 1) || (getHeight() &gt;= curHex</span>
<span class="nc bnc" id="L7703" title="All 2 branches missed.">                    .terrainLevel(Terrains.BLDG_ELEV)))) {</span>
<span class="nc" id="L7704">                rv += 1;</span>
            }
        }

        // check to see if its a wall
<span class="nc bnc" id="L7709" title="All 2 branches missed.">        if (rv &gt; 1) {</span>
<span class="nc" id="L7710">            Building bldgEntered = null;</span>
<span class="nc" id="L7711">            bldgEntered = game.getBoard().getBuildingAt(curPos);</span>
<span class="nc bnc" id="L7712" title="All 2 branches missed.">            if (bldgEntered.getType() == Building.WALL) {</span>
<span class="nc" id="L7713">                return 4;</span>
            }
        }

        // Check for changing levels within a building
<span class="nc bnc" id="L7718" title="All 6 branches missed.">        if (curPos.equals(prevPos)</span>
            &amp;&amp; (curBldg != null)
            &amp;&amp; (prevStep != null)
<span class="nc bnc" id="L7721" title="All 2 branches missed.">            &amp;&amp; (step.getElevation() != prevStep.getElevation())</span>
<span class="nc bnc" id="L7722" title="All 4 branches missed.">            &amp;&amp; ((step.getType() == MoveStepType.UP) || (step.getType() == MoveStepType.DOWN))) {</span>
<span class="nc" id="L7723">            rv = 8;</span>
        }

<span class="nc bnc" id="L7726" title="All 4 branches missed.">        if ((this instanceof Infantry) || (this instanceof Protomech)) {</span>
<span class="nc bnc" id="L7727" title="All 6 branches missed.">            if ((rv != 2) &amp;&amp; (rv != 8) &amp;&amp; (rv != 10)) {</span>
<span class="nc" id="L7728">                rv = 0;</span>
            }
        }
<span class="nc" id="L7731">        return rv;</span>
    }

    /**
     * Calculates and returns the roll for an entity moving in buildings.
     */
    public PilotingRollData rollMovementInBuilding(Building bldg, int distance,
                                                   String why, EntityMovementType overallMoveType) {
<span class="nc" id="L7739">        PilotingRollData roll = getBasePilotingRoll(overallMoveType);</span>

<span class="nc bnc" id="L7741" title="All 4 branches missed.">        if ((this instanceof Mech) &amp;&amp; ((Mech) this).isSuperHeavy()) {</span>
<span class="nc" id="L7742">            roll.addModifier(4, &quot;superheavy mech moving in building&quot;);</span>
        }
        
<span class="nc bnc" id="L7745" title="All 2 branches missed.">        if (this.hasQuirk(OptionsConstants.QUIRK_NEG_OVERSIZED)) {</span>
<span class="nc" id="L7746">            roll.addModifier(1, &quot;oversized unit&quot;);</span>
        }

<span class="nc" id="L7749">        int mod = 0;</span>
        String desc;

<span class="nc bnc" id="L7752" title="All 2 branches missed.">        if (why.equals(&quot;&quot;)) {</span>
<span class="nc" id="L7753">            desc = &quot;moving through &quot;;</span>
        } else {
<span class="nc" id="L7755">            desc = why + &quot; &quot;;</span>
        }

<span class="nc bnc" id="L7758" title="All 6 branches missed.">        switch (bldg.getType()) {</span>
            case Building.LIGHT:
<span class="nc" id="L7760">                desc = &quot;Light&quot;;</span>
<span class="nc" id="L7761">                break;</span>
            case Building.MEDIUM:
<span class="nc bnc" id="L7763" title="All 2 branches missed.">                if (bldg.getBldgClass() != Building.HANGAR) {</span>
<span class="nc" id="L7764">                    mod = 1;</span>
<span class="nc" id="L7765">                    desc = &quot;Medium&quot;;</span>
                }
<span class="nc bnc" id="L7767" title="All 2 branches missed.">                if (bldg.getBldgClass() &gt;= Building.FORTRESS) {</span>
<span class="nc" id="L7768">                    mod = 2;</span>
<span class="nc" id="L7769">                    desc = desc + &quot; Fortress&quot;;</span>
                }
                break;
            case Building.HEAVY:
<span class="nc" id="L7773">                mod = 2;</span>
<span class="nc" id="L7774">                desc = &quot;Heavy&quot;;</span>
<span class="nc bnc" id="L7775" title="All 2 branches missed.">                if (bldg.getBldgClass() == Building.HANGAR) {</span>
<span class="nc" id="L7776">                    mod = 1;</span>
<span class="nc" id="L7777">                    desc = desc + &quot; Hangar&quot;;</span>
                }
<span class="nc bnc" id="L7779" title="All 2 branches missed.">                if (bldg.getBldgClass() == Building.FORTRESS) {</span>
<span class="nc" id="L7780">                    mod = 3;</span>
<span class="nc" id="L7781">                    desc = desc + &quot; Fortress&quot;;</span>
                }
                // if(bldg.getBldgClass() == Building.CASTLE_BRIAN) {
                // mod = 4;
                // desc = desc + &quot; Castle Brian&quot;;
                // }
                break;
            case Building.HARDENED:
<span class="nc" id="L7789">                mod = 5;</span>
<span class="nc" id="L7790">                desc = &quot;Hardened&quot;;</span>
<span class="nc bnc" id="L7791" title="All 2 branches missed.">                if (bldg.getBldgClass() == Building.HANGAR) {</span>
<span class="nc" id="L7792">                    mod = 3;</span>
<span class="nc" id="L7793">                    desc = desc + &quot; Hangar&quot;;</span>
                }
<span class="nc bnc" id="L7795" title="All 2 branches missed.">                if (bldg.getBldgClass() == Building.FORTRESS) {</span>
<span class="nc" id="L7796">                    mod = 4;</span>
<span class="nc" id="L7797">                    desc = desc + &quot; Fortress&quot;;</span>
                }
                break;
            case Building.WALL:
<span class="nc" id="L7801">                mod = 12;</span>
<span class="nc" id="L7802">                desc = &quot;&quot;;</span>
                break;
        }

        // append the reason modifier
<span class="nc" id="L7807">        roll.append(new PilotingRollData(getId(), mod, &quot;moving through &quot; + desc</span>
<span class="nc" id="L7808">                                                       + &quot; &quot; + bldg.getName()));</span>
<span class="nc" id="L7809">        adjustDifficultTerrainPSRModifier(roll);</span>

        // Modify the roll by the distance moved so far.
<span class="nc bnc" id="L7812" title="All 2 branches missed.">        if (distance &gt;= 25) {</span>
<span class="nc" id="L7813">            roll.addModifier(6, &quot;moved 25+ hexes&quot;);</span>
<span class="nc bnc" id="L7814" title="All 2 branches missed.">        } else if (distance &gt;= 18) {</span>
<span class="nc" id="L7815">            roll.addModifier(5, &quot;moved 18-24 hexes&quot;);</span>
<span class="nc bnc" id="L7816" title="All 2 branches missed.">        } else if (distance &gt;= 10) {</span>
<span class="nc" id="L7817">            roll.addModifier(4, &quot;moved 10+ hexes&quot;);</span>
<span class="nc bnc" id="L7818" title="All 2 branches missed.">        } else if (distance &gt;= 7) {</span>
<span class="nc" id="L7819">            roll.addModifier(3, &quot;moved 7-9 hexes&quot;);</span>
<span class="nc bnc" id="L7820" title="All 2 branches missed.">        } else if (distance &gt;= 5) {</span>
<span class="nc" id="L7821">            roll.addModifier(2, &quot;moved 5-6 hexes&quot;);</span>
<span class="nc bnc" id="L7822" title="All 2 branches missed.">        } else if (distance &gt;= 3) {</span>
<span class="nc" id="L7823">            roll.addModifier(1, &quot;moved 3-4 hexes&quot;);</span>
        }

<span class="nc" id="L7826">        return roll;</span>
    }

    /**
     * Only check for satisfied turn mode for Tanks or QuadVees in vehicle mode, or LAMs in
     * AirMech mode. Except for LAMs, check whether advanced vehicle ground movement is enabled.
     *
     * @return True if this &lt;code&gt;Entity&lt;/code&gt; must make a driving check for turning too sharply.
     */
    public boolean usesTurnMode() {
<span class="nc" id="L7836">        return false;</span>
    }

    /**
     * If using advanced vehicle ground movement, checks whether the unit is required to make
     * a driving roll for turning, and if so whether it succeeds.
     *
     * @param overallMoveType   The type move movement used this turn.
     * @param straightLineHexes The number of hexes that were moved in a straight line before turning.
     * @param mpUsed            The total number of movement points used by the entity during the current turn.
     * @param currPos           The position of the hex where the turn is taking place, which may
     *                          modify a roll for terrain.
     * @return                  True if the entity failed a driving check due to turning too sharply.
     */
    public PilotingRollData checkTurnModeFailure(EntityMovementType overallMoveType,
            int straightLineHexes, int mpUsed, Coords currPos) {

<span class="nc" id="L7853">        PilotingRollData roll = getBasePilotingRoll(overallMoveType);</span>
        //Turn mode
<span class="nc bnc" id="L7855" title="All 2 branches missed.">        if (!usesTurnMode()) {</span>
<span class="nc" id="L7856">            roll.addModifier(TargetRoll.CHECK_FALSE,</span>
                    &quot;Check false: unit does not use turn modes.&quot;);
<span class="nc" id="L7858">            return roll;</span>
        }

<span class="nc" id="L7861">        int turnMode = mpUsed / 5;</span>
<span class="nc bnc" id="L7862" title="All 2 branches missed.">        if (straightLineHexes &gt;= turnMode) {</span>
<span class="nc" id="L7863">            roll.addModifier(TargetRoll.CHECK_FALSE,</span>
                    &quot;Check false: unit did not exceed turn mode.&quot;);
<span class="nc" id="L7865">            return roll;</span>
        }

<span class="nc bnc" id="L7868" title="All 2 branches missed.">        if (getWeightClass() &lt; EntityWeightClass.WEIGHT_MEDIUM</span>
<span class="nc bnc" id="L7869" title="All 2 branches missed.">                || getWeightClass() == EntityWeightClass.WEIGHT_SMALL_SUPPORT) {</span>
<span class="nc" id="L7870">            roll.addModifier(-1, &quot;light vehicle&quot;);</span>
<span class="nc bnc" id="L7871" title="All 2 branches missed.">        } else if (getWeightClass() == EntityWeightClass.WEIGHT_ASSAULT</span>
<span class="nc bnc" id="L7872" title="All 2 branches missed.">                || getWeightClass() == EntityWeightClass.WEIGHT_SUPER_HEAVY) {</span>
<span class="nc" id="L7873">            roll.addModifier(+1, &quot;assault vehicle&quot;);</span>
        }

<span class="nc" id="L7876">        IHex currHex = game.getBoard().getHex(currPos);</span>
<span class="nc bnc" id="L7877" title="All 6 branches missed.">        if (movementMode != EntityMovementMode.HOVER</span>
                &amp;&amp; movementMode != EntityMovementMode.VTOL
                &amp;&amp; movementMode != EntityMovementMode.WIGE) {
<span class="nc bnc" id="L7880" title="All 2 branches missed.">            if (currHex.containsTerrain(Terrains.MUD)) {</span>
<span class="nc" id="L7881">                roll.addModifier(+1, &quot;mud&quot;);</span>
            }
<span class="nc bnc" id="L7883" title="All 2 branches missed.">            if (currHex.containsTerrain(Terrains.ICE)) {</span>
<span class="nc bnc" id="L7884" title="All 2 branches missed.">                roll.addModifier(movementMode == EntityMovementMode.TRACKED? 1 : 2, &quot;ice&quot;);</span>
            }
<span class="nc bnc" id="L7886" title="All 2 branches missed.">            if (game.getPlanetaryConditions().isSleeting()</span>
<span class="nc bnc" id="L7887" title="All 2 branches missed.">                    || game.getPlanetaryConditions().getFog() == PlanetaryConditions.FOG_HEAVY</span>
<span class="nc bnc" id="L7888" title="All 2 branches missed.">                    || game.getPlanetaryConditions().getWeather() == PlanetaryConditions.WE_HEAVY_RAIN</span>
<span class="nc bnc" id="L7889" title="All 2 branches missed.">                    || game.getPlanetaryConditions().getWeather() == PlanetaryConditions.WE_GUSTING_RAIN</span>
<span class="nc bnc" id="L7890" title="All 2 branches missed.">                    || game.getPlanetaryConditions().getWeather() == PlanetaryConditions.WE_DOWNPOUR) {</span>
<span class="nc" id="L7891">                roll.addModifier(+1, &quot;fog/rain&quot;);</span>
            }
<span class="nc bnc" id="L7893" title="All 2 branches missed.">            if (game.getPlanetaryConditions().getWeather() == PlanetaryConditions.WE_HEAVY_SNOW</span>
<span class="nc bnc" id="L7894" title="All 2 branches missed.">                    || game.getPlanetaryConditions().getWeather() == PlanetaryConditions.WE_BLIZZARD) {</span>
<span class="nc bnc" id="L7895" title="All 2 branches missed.">                roll.addModifier(movementMode == EntityMovementMode.TRACKED? 1 : 2, &quot;snow&quot;);</span>
            }
        }

<span class="nc" id="L7899">        roll.addModifier(turnMode - straightLineHexes, &quot;did not satisfy turn mode&quot;);</span>

<span class="nc" id="L7901">        return roll;</span>
    }

    /**
     * Calculate the piloting skill roll modifier, based upon the number of
     * hexes moved this phase. Used for skidding.
     */
    public int getMovementBeforeSkidPSRModifier(int distance) {
<span class="nc" id="L7909">        int mod = -1;</span>

<span class="nc bnc" id="L7911" title="All 2 branches missed.">        if (distance &gt; 24) {</span>
<span class="nc" id="L7912">            mod = 6;</span>
<span class="nc bnc" id="L7913" title="All 2 branches missed.">        } else if (distance &gt; 17) {</span>
<span class="nc" id="L7914">            mod = 5;</span>
<span class="nc bnc" id="L7915" title="All 2 branches missed.">        } else if (distance &gt; 10) {</span>
<span class="nc" id="L7916">            mod = 4;</span>
<span class="nc bnc" id="L7917" title="All 2 branches missed.">        } else if (distance &gt; 7) {</span>
<span class="nc" id="L7918">            mod = 2;</span>
<span class="nc bnc" id="L7919" title="All 2 branches missed.">        } else if (distance &gt; 4) {</span>
<span class="nc" id="L7920">            mod = 1;</span>
<span class="nc bnc" id="L7921" title="All 2 branches missed.">        } else if (distance &gt; 2) {</span>
<span class="nc" id="L7922">            mod = 0;</span>
        } else {
            // 0-2 hexes
<span class="nc" id="L7925">            mod = -1;</span>
        }

<span class="nc bnc" id="L7928" title="All 2 branches missed.">        if (hasAbility(OptionsConstants.PILOT_MANEUVERING_ACE)) {</span>
<span class="nc" id="L7929">            mod--;</span>
        }

<span class="nc" id="L7932">        return mod;</span>
    }

    /**
     * calculate any changes to the PSR modifier for entering difficult terrain
     */
    private void adjustDifficultTerrainPSRModifier(PilotingRollData psr) {
<span class="nc bnc" id="L7939" title="All 4 branches missed.">        if (hasQuirk(OptionsConstants.QUIRK_POS_EASY_PILOT) &amp;&amp; (getCrew().getPiloting() &gt; 3)) {</span>
<span class="nc" id="L7940">            psr.addModifier(-1, &quot;easy to pilot&quot;);</span>
        }
<span class="nc bnc" id="L7942" title="All 2 branches missed.">        if (hasQuirk(OptionsConstants.QUIRK_NEG_UNBALANCED)) {</span>
<span class="nc" id="L7943">            psr.addModifier(+1, &quot;unbalanced&quot;);</span>
        }
<span class="nc" id="L7945">    }</span>

    /**
     * The maximum elevation change the entity can cross
     */
    public abstract int getMaxElevationChange();

    /**
     * by default, entities can move as far down as they can move up
     */
    public int getMaxElevationDown() {
<span class="nc" id="L7956">        return getMaxElevationDown(getElevation());</span>
    }

    /**
     * Returns the maximum number of downard elevation changes a unit can make.
     * For some units (namely, WiGEs), this can depend upon their current
     * elevation (since elevation determines if the WiGEs is using WiGE movement
     * or not).
     *
     * @param currElevation
     * @return
     */
    public int getMaxElevationDown(int currElevation) {
<span class="nc" id="L7969">        return getMaxElevationChange();</span>
    }

    /**
     * Add a transportation component to this Entity. Please note, this method
     * should only be called during this entity's construction.
     *
     * @param component - One of this new entity's &lt;code&gt;Transporter&lt;/code&gt;s.
     */
    public void addTransporter(Transporter component) {
<span class="nc" id="L7979">        addTransporter(component, false);</span>
<span class="nc" id="L7980">    }</span>

    /**
     * Add a transportation component to this Entity. Please note, this method
     * should only be called during this entity's construction.
     *
     * @param component - One of this new entity's &lt;code&gt;Transporter&lt;/code&gt;s.
     * @param isOmniPod - Whether this is part of an omni unit's pod space.
     */
    public void addTransporter(Transporter component, boolean isOmniPod) {
<span class="nc" id="L7990">        component.setGame(game);</span>
<span class="nc" id="L7991">        transports.add(component);</span>
<span class="nc bnc" id="L7992" title="All 2 branches missed.">        if (isOmniPod) {</span>
<span class="nc" id="L7993">        	omniPodTransports.add(component);</span>
        }
<span class="nc" id="L7995">    }</span>

    public void removeTransporter(Transporter t) {
<span class="nc" id="L7998">        transports.remove(t);</span>
<span class="nc" id="L7999">        omniPodTransports.remove(t);</span>
<span class="nc" id="L8000">    }</span>

    /**
     * Remove all transportation components from this Entity. Should probably
     * only be called during construction.
     */
    public void removeAllTransporters() {
<span class="nc" id="L8007">        transports = new Vector&lt;Transporter&gt;();</span>
<span class="nc" id="L8008">        omniPodTransports.clear();</span>
<span class="nc" id="L8009">    }</span>

    /**
     * Determines if this object can accept the given unit. The unit may not be
     * of the appropriate type or there may be no room for the unit.
     *
     * @param unit - the &lt;code&gt;Entity&lt;/code&gt; to be loaded.
     * @return &lt;code&gt;true&lt;/code&gt; if the unit can be loaded, &lt;code&gt;false&lt;/code&gt;
     * otherwise.
     */
    public boolean canLoad(Entity unit, boolean checkElev) {
        // For now, if it's infantry, it can't load anything.
        // Period!
<span class="nc bnc" id="L8022" title="All 2 branches missed.">        if (this instanceof Infantry) {</span>
<span class="nc" id="L8023">            return false;</span>
        }

        // one can only load one's own team's units!
<span class="nc bnc" id="L8027" title="All 2 branches missed.">        if (!unit.isEnemyOf(this)) {</span>

            /* Mechanized BA and protomechs occupy the same space, and if one is already
             * present the other cannot be loaded. It is still possible for a support vee
             * to carry mechanized BA externally and protos in a bay, so we need to check for
             * external units first then check for conflicts only for other external mounts. */
<span class="nc" id="L8033">            boolean hasExternalBA = false;</span>
<span class="nc" id="L8034">            boolean hasExternalProtos = false;</span>
<span class="nc" id="L8035">            boolean hasExternalUltraheavy = false;</span>
<span class="nc bnc" id="L8036" title="All 2 branches missed.">            if (unit.hasETypeFlag(Entity.ETYPE_BATTLEARMOR)</span>
<span class="nc bnc" id="L8037" title="All 2 branches missed.">                    || unit.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</span>
<span class="nc bnc" id="L8038" title="All 2 branches missed.">                for (Transporter t : transports) {</span>
                    // ProtomechClampMount is a subclass of BattleArmorHandles so we need to check it first
<span class="nc bnc" id="L8040" title="All 2 branches missed.">                    if (t instanceof ProtomechClampMount) {</span>
<span class="nc bnc" id="L8041" title="All 2 branches missed.">                        hasExternalProtos |= t.getUnused() == 0;</span>
<span class="nc" id="L8042">                        hasExternalUltraheavy |= t.getLoadedUnits().stream()</span>
<span class="nc bnc" id="L8043" title="All 2 branches missed.">                                .anyMatch(e -&gt; e.getWeightClass() == EntityWeightClass.WEIGHT_SUPER_HEAVY);</span>
<span class="nc bnc" id="L8044" title="All 2 branches missed.">                    } else if (t instanceof BattleArmorHandles) {</span>
<span class="nc bnc" id="L8045" title="All 2 branches missed.">                        hasExternalBA |= t.getUnused() == 0;</span>
                    }
<span class="nc" id="L8047">                }</span>
            }
            // We can't mix BA and protos, and we can't mount an ultraheavy proto if already carrying another.
<span class="nc bnc" id="L8050" title="All 4 branches missed.">            boolean noExternalMount = (unit.hasETypeFlag(Entity.ETYPE_BATTLEARMOR) &amp;&amp; hasExternalProtos)</span>
<span class="nc bnc" id="L8051" title="All 4 branches missed.">                    || (unit.hasETypeFlag(Entity.ETYPE_PROTOMECH) &amp;&amp; hasExternalBA);</span>

<span class="nc bnc" id="L8053" title="All 4 branches missed.">            if (unit.hasETypeFlag(Entity.ETYPE_PROTOMECH) &amp;&amp; hasExternalProtos) {</span>
<span class="nc bnc" id="L8054" title="All 2 branches missed.">                noExternalMount |= hasExternalUltraheavy</span>
<span class="nc bnc" id="L8055" title="All 2 branches missed.">                        || (unit.getWeightClass() == EntityWeightClass.WEIGHT_SUPER_HEAVY);</span>
            }

<span class="nc bnc" id="L8058" title="All 2 branches missed.">            for (Transporter t : transports) {</span>
<span class="nc bnc" id="L8059" title="All 4 branches missed.">                if (t.canLoad(unit)</span>
<span class="nc bnc" id="L8060" title="All 6 branches missed.">                        &amp;&amp; (!checkElev || unit.getElevation() == getElevation())</span>
                        &amp;&amp; !((t instanceof BattleArmorHandles) &amp;&amp; noExternalMount)) {
<span class="nc" id="L8062">                    return true;</span>
                }
<span class="nc" id="L8064">            }</span>
        }

        // If we got here, none of our transports can carry the unit.
<span class="nc" id="L8068">        return false;</span>
    }

    @Override
    public boolean canLoad(Entity unit) {
<span class="nc" id="L8073">        return this.canLoad(unit, true);</span>
    }

    /**
     * Load the given unit.
     *
     * @param unit - the &lt;code&gt;Entity&lt;/code&gt; to be loaded.
     * @throws IllegalArgumentException If the unit can't be loaded
     */
    public void load(Entity unit, boolean checkElev, int bayNumber) {
        // Walk through this entity's transport components;
        // find the one that can load the unit.
        // Stop looking after the first match.
<span class="nc" id="L8086">        Enumeration&lt;Transporter&gt; iter = transports.elements();</span>
<span class="nc bnc" id="L8087" title="All 2 branches missed.">        while (iter.hasMoreElements()) {</span>
<span class="nc" id="L8088">            Transporter next = iter.nextElement();</span>
<span class="nc bnc" id="L8089" title="All 4 branches missed.">            if (next.canLoad(unit)</span>
<span class="nc bnc" id="L8090" title="All 4 branches missed.">                &amp;&amp; (!checkElev || (unit.getElevation() == getElevation()))</span>
<span class="nc bnc" id="L8091" title="All 2 branches missed.">                &amp;&amp; ((bayNumber == -1) || (((Bay) next).getBayNumber() == bayNumber))) {</span>
<span class="nc" id="L8092">                next.load(unit);</span>
<span class="nc" id="L8093">                unit.setTargetBay(-1); // Reset the target bay for later.</span>
<span class="nc" id="L8094">                return;</span>
            }
<span class="nc" id="L8096">        }</span>

        // If we got to this point, then we can't load the unit.
<span class="nc" id="L8099">        throw new IllegalArgumentException(getShortName() + &quot; can not load &quot;</span>
<span class="nc" id="L8100">                                           + unit.getShortName());</span>
    }

    public void load(Entity unit, boolean checkElev) {
<span class="nc" id="L8104">        this.load(unit, checkElev, -1);</span>
<span class="nc" id="L8105">    }</span>

    public void load(Entity unit, int bayNumber) {
<span class="nc" id="L8108">        this.load(unit, true, bayNumber);</span>
<span class="nc" id="L8109">    }</span>

    @Override
    public void load(Entity unit) {
<span class="nc" id="L8113">        this.load(unit, true, -1);</span>
<span class="nc" id="L8114">    }</span>

    /**
     * Recover the given unit. Only for ASF and Small Craft
     *
     * @param unit - the &lt;code&gt;Entity&lt;/code&gt; to be loaded.
     * @throws IllegalArgumentException If the unit can't be loaded
     */
    public void recover(Entity unit) {
        // Walk through this entity's transport components;
        // find those that can load the unit.
        // load the unit into the best match.
<span class="nc" id="L8126">    	int choice = 0;</span>
<span class="nc bnc" id="L8127" title="All 2 branches missed.">    	for (Transporter nextbay : transports) {</span>
<span class="nc bnc" id="L8128" title="All 4 branches missed.">    		if (nextbay.canLoad(unit) &amp;&amp; (unit.getElevation() == getElevation())) {</span>
<span class="nc bnc" id="L8129" title="All 2 branches missed.">    			if (nextbay instanceof DockingCollar) {</span>
<span class="nc" id="L8130">    				choice = 3;</span>
    			}
<span class="nc bnc" id="L8132" title="All 2 branches missed.">    			if (nextbay instanceof ASFBay) {</span>
<span class="nc" id="L8133">    				choice = 2;</span>
    			}
<span class="nc bnc" id="L8135" title="All 2 branches missed.">    			if (nextbay instanceof SmallCraftBay) {</span>
<span class="nc" id="L8136">    			choice = 1;</span>
    			}
    		}
<span class="nc" id="L8139">    	}</span>
<span class="nc bnc" id="L8140" title="All 2 branches missed.">    	if (choice == 3) {</span>
<span class="nc bnc" id="L8141" title="All 2 branches missed.">    		for (Transporter nextbay : transports) {</span>
<span class="nc bnc" id="L8142" title="All 2 branches missed.">    			while (nextbay instanceof DockingCollar) {</span>
<span class="nc" id="L8143">    				((DockingCollar) nextbay).recover(unit);</span>
<span class="nc" id="L8144">    				return;</span>
    			}
<span class="nc" id="L8146">    		}</span>
<span class="nc bnc" id="L8147" title="All 2 branches missed.">    	}else if (choice == 2) {</span>
<span class="nc bnc" id="L8148" title="All 2 branches missed.">    		for (Bay nextbay : getTransportBays()) {</span>
<span class="nc bnc" id="L8149" title="All 2 branches missed.">    			while (nextbay instanceof ASFBay) {</span>
<span class="nc" id="L8150">    				((ASFBay) nextbay).recover(unit);</span>
<span class="nc" id="L8151">    				return;</span>
    			}
<span class="nc" id="L8153">    		}</span>
<span class="nc bnc" id="L8154" title="All 2 branches missed.">    	} else if (choice == 1) {</span>
<span class="nc bnc" id="L8155" title="All 2 branches missed.">    		for (Bay nextbay : getTransportBays()) {</span>
<span class="nc bnc" id="L8156" title="All 2 branches missed.">    			while (nextbay instanceof SmallCraftBay) {</span>
<span class="nc" id="L8157">    				((SmallCraftBay) nextbay).recover(unit);</span>
<span class="nc" id="L8158">    				return;</span>
    			}
<span class="nc" id="L8160">    		}</span>
    	}
<span class="nc" id="L8162">    }</span>


    /**
     * cycle through and update Bays
     */
    public void updateBays() {
<span class="nc" id="L8169">        Enumeration&lt;Transporter&gt; iter = transports.elements();</span>
<span class="nc bnc" id="L8170" title="All 2 branches missed.">        while (iter.hasMoreElements()) {</span>
<span class="nc" id="L8171">            Transporter next = iter.nextElement();</span>
<span class="nc bnc" id="L8172" title="All 2 branches missed.">            if (next instanceof ASFBay) {</span>
<span class="nc" id="L8173">                ASFBay nextBay = (ASFBay) next;</span>
<span class="nc" id="L8174">                nextBay.updateSlots();</span>
            }
<span class="nc bnc" id="L8176" title="All 2 branches missed.">            if (next instanceof SmallCraftBay) {</span>
<span class="nc" id="L8177">                SmallCraftBay nextBay = (SmallCraftBay) next;</span>
<span class="nc" id="L8178">                nextBay.updateSlots();</span>
            }
<span class="nc" id="L8180">        }</span>
<span class="nc" id="L8181">    }</span>

    /**
     * Damages a randomly determined bay door on the entity, if one exists
     */
    public String damageBayDoor() {

<span class="nc" id="L8188">        String bayType = &quot;none&quot;;</span>

        Vector&lt;Bay&gt; potential;
<span class="nc" id="L8191">        potential = new Vector&lt;Bay&gt;();</span>

<span class="nc" id="L8193">        Enumeration&lt;Transporter&gt; iter = transports.elements();</span>
<span class="nc bnc" id="L8194" title="All 2 branches missed.">        while (iter.hasMoreElements()) {</span>
<span class="nc" id="L8195">            Transporter next = iter.nextElement();</span>
<span class="nc bnc" id="L8196" title="All 2 branches missed.">            if (next instanceof Bay) {</span>
<span class="nc" id="L8197">                Bay nextBay = (Bay) next;</span>
<span class="nc bnc" id="L8198" title="All 2 branches missed.">                if (nextBay.getCurrentDoors() &gt; 0) {</span>
<span class="nc" id="L8199">                    potential.add(nextBay);</span>
                }
            }
<span class="nc" id="L8202">        }</span>

<span class="nc bnc" id="L8204" title="All 2 branches missed.">        if (potential.size() &gt; 0) {</span>
<span class="nc" id="L8205">            Bay chosenBay = potential.elementAt(Compute.randomInt(potential</span>
<span class="nc" id="L8206">                                                                          .size()));</span>
<span class="nc" id="L8207">            chosenBay.destroyDoor();</span>
<span class="nc" id="L8208">            chosenBay.resetDoors();</span>
<span class="nc" id="L8209">            bayType = chosenBay.getType();</span>
        }

<span class="nc" id="L8212">        return bayType;</span>
    }

    /**
     * damage the door of the first bay that can load this unit
     */
    public void damageDoorRecovery(Entity en) {
<span class="nc" id="L8219">        Enumeration&lt;Transporter&gt; iter = transports.elements();</span>
<span class="nc bnc" id="L8220" title="All 2 branches missed.">        while (iter.hasMoreElements()) {</span>
<span class="nc" id="L8221">            Transporter next = iter.nextElement();</span>
<span class="nc bnc" id="L8222" title="All 4 branches missed.">            if ((next instanceof ASFBay) &amp;&amp; next.canLoad(en)) {</span>
<span class="nc" id="L8223">                ((ASFBay) next).destroyDoor();</span>
<span class="nc" id="L8224">                break;</span>
            }
<span class="nc bnc" id="L8226" title="All 4 branches missed.">            if ((next instanceof SmallCraftBay) &amp;&amp; next.canLoad(en)) {</span>
<span class="nc" id="L8227">                ((SmallCraftBay) next).destroyDoor();</span>
<span class="nc" id="L8228">                break;</span>
            }

<span class="nc" id="L8231">        }</span>
<span class="nc" id="L8232">    }</span>

    /**
     * Damages a randomly determined docking collar on the entity, if one exists
     */
    public boolean damageDockCollar() {

<span class="nc" id="L8239">        boolean result = false;</span>

        Vector&lt;DockingCollar&gt; potential;
<span class="nc" id="L8242">        potential = new Vector&lt;DockingCollar&gt;();</span>

<span class="nc" id="L8244">        Enumeration&lt;Transporter&gt; iter = transports.elements();</span>
<span class="nc bnc" id="L8245" title="All 2 branches missed.">        while (iter.hasMoreElements()) {</span>
<span class="nc" id="L8246">            Transporter next = iter.nextElement();</span>
<span class="nc bnc" id="L8247" title="All 2 branches missed.">            if (next instanceof DockingCollar) {</span>
<span class="nc" id="L8248">                DockingCollar nextDC = (DockingCollar) next;</span>
<span class="nc bnc" id="L8249" title="All 2 branches missed.">                if (!nextDC.isDamaged()) {</span>
<span class="nc" id="L8250">                    potential.add(nextDC);</span>
                }
            }
<span class="nc" id="L8253">        }</span>

<span class="nc bnc" id="L8255" title="All 2 branches missed.">        if (potential.size() &gt; 0) {</span>
<span class="nc" id="L8256">            DockingCollar chosenDC = potential.elementAt(Compute</span>
<span class="nc" id="L8257">                                                                 .randomInt(potential.size()));</span>
<span class="nc" id="L8258">            chosenDC.setDamaged(true);</span>
<span class="nc" id="L8259">            result = true;</span>
        }

<span class="nc" id="L8262">        return result;</span>
    }

    public void pickUp(MechWarrior mw) {
<span class="nc" id="L8266">        pickedUpMechWarriors.addElement(mw.getId());</span>
<span class="nc" id="L8267">    }</span>

    /**
     * Get a &lt;code&gt;List&lt;/code&gt; of the units currently loaded into this payload.
     *
     * @return A &lt;code&gt;List&lt;/code&gt; of loaded &lt;code&gt;Entity&lt;/code&gt; units. This
     * list will never be &lt;code&gt;null&lt;/code&gt;, but it may be empty. The
     * returned &lt;code&gt;List&lt;/code&gt; is independent from the under- lying
     * data structure; modifying one does not affect the other.
     */
    @Override
    public List&lt;Entity&gt; getLoadedUnits() {
<span class="nc" id="L8279">        List&lt;Entity&gt; result = new ArrayList&lt;Entity&gt;();</span>

        // Walk through this entity's transport components;
        // add all of their lists to ours.
<span class="nc bnc" id="L8283" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
            //Don't look at trailer hitches here, that's separate
<span class="nc bnc" id="L8285" title="All 2 branches missed.">            if (next instanceof TankTrailerHitch) {</span>
<span class="nc" id="L8286">                continue;</span>
            }
<span class="nc bnc" id="L8288" title="All 2 branches missed.">            for (Entity e : next.getLoadedUnits()) {</span>
<span class="nc bnc" id="L8289" title="All 2 branches missed.">                if(e != null) {</span>
<span class="nc" id="L8290">                    result.add(e);</span>
                }
<span class="nc" id="L8292">            }</span>
<span class="nc" id="L8293">        }</span>

        // Return the list.
<span class="nc" id="L8296">        return result;</span>
    }

    /**
     * @return the number of docking collars
     */
    public int getDocks() {
<span class="nc" id="L8303">        return getDocks(false);</span>
    }

    /**
     * @param forCost Whether this value is being used for cost calculations, in which case
     *                dropshuttle bays count as two collars.
     * @return The number of docking collars
     */
    public int getDocks(boolean forCost) {
<span class="nc" id="L8312">        int n = 0;</span>
<span class="nc bnc" id="L8313" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc bnc" id="L8314" title="All 6 branches missed.">            if ((next instanceof DockingCollar)</span>
                    || (forCost &amp;&amp; (next instanceof DropshuttleBay))) {
<span class="nc" id="L8316">                n += next.hardpointCost();</span>
            }
<span class="nc" id="L8318">        }</span>
<span class="nc" id="L8319">        return n;</span>
    }

    /**
     * only entities in Bays (for cargo damage to Aero units
     *
     * @return
     */
    public Vector&lt;Entity&gt; getBayLoadedUnits() {
<span class="nc" id="L8328">        Vector&lt;Entity&gt; result = new Vector&lt;Entity&gt;();</span>

        // Walk through this entity's transport components;
        // add all of their lists to ours.
<span class="nc bnc" id="L8332" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc bnc" id="L8333" title="All 2 branches missed.">            if (next instanceof Bay) {</span>
<span class="nc bnc" id="L8334" title="All 2 branches missed.">                for (Entity e : next.getLoadedUnits()) {</span>
<span class="nc" id="L8335">                    result.addElement(e);</span>
<span class="nc" id="L8336">                }</span>
            }
<span class="nc" id="L8338">        }</span>

        // Return the list.
<span class="nc" id="L8341">        return result;</span>
    }
    
    /**
     * Generate a list of the Ids of entities stored in bays. 
     * Used by MHQ in cases where we can't get the entities via Game
     *
     * @return
     */
    public List&lt;Integer&gt; getBayLoadedUnitIds() {
<span class="nc" id="L8351">        List&lt;Integer&gt; result = new ArrayList&lt;&gt;();</span>

        // Walk through this entity's transport components;
        // add all of their lists to ours.
<span class="nc bnc" id="L8355" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc bnc" id="L8356" title="All 2 branches missed.">            if (next instanceof Bay) {</span>
<span class="nc" id="L8357">                result.addAll(((Bay) next).getLoadedUnitIds());</span>
            }
<span class="nc" id="L8359">        }</span>

        // Return the list.
<span class="nc" id="L8362">        return result;</span>
    }

    /**
     * return the bay that the given entity is loaded into
     *
     * @param loaded
     * @return
     */
    public Bay getBay(Entity loaded) {
<span class="nc bnc" id="L8372" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc bnc" id="L8373" title="All 2 branches missed.">            if (next instanceof Bay) {</span>
<span class="nc bnc" id="L8374" title="All 2 branches missed.">                for (Entity e : next.getLoadedUnits()) {</span>
<span class="nc bnc" id="L8375" title="All 2 branches missed.">                    if (loaded.getId() == e.getId()) {</span>
<span class="nc" id="L8376">                        return (Bay) next;</span>
                    }
<span class="nc" id="L8378">                }</span>
            }
<span class="nc" id="L8380">        }</span>
<span class="nc" id="L8381">        return null;</span>
    }

    public Bay getBayById(int bayNumber) {
        //TODO: Change transports to a map or other indexed data structure to avoid
        // linear-time algorithm.
<span class="nc bnc" id="L8387" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc bnc" id="L8388" title="All 2 branches missed.">            if (next instanceof Bay) {</span>
<span class="nc bnc" id="L8389" title="All 2 branches missed.">                if (((Bay) next).getBayNumber() == bayNumber) {</span>
<span class="nc" id="L8390">                    return (Bay) next;</span>
                }
            }
<span class="nc" id="L8393">        }</span>
<span class="nc" id="L8394">        return null;</span>
    }
    
    @Nullable
    public DockingCollar getCollarById(int collarNumber) {
        //TODO: Change transports to a map or other indexed data structure to avoid
        // linear-time algorithm.
<span class="nc bnc" id="L8401" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc bnc" id="L8402" title="All 2 branches missed.">            if (next instanceof DockingCollar) {</span>
<span class="nc bnc" id="L8403" title="All 2 branches missed.">                if (((DockingCollar) next).getCollarNumber() == collarNumber) {</span>
<span class="nc" id="L8404">                    return (DockingCollar) next;</span>
                }
            }
<span class="nc" id="L8407">        }</span>
<span class="nc" id="L8408">        return null;</span>
    }

    /**
     * @return only entities in ASF Bays
     */
    public Vector&lt;Entity&gt; getLoadedFighters() {
<span class="nc" id="L8415">        Vector&lt;Entity&gt; result = new Vector&lt;&gt;();</span>

        // Walk through this entity's transport components;
        // add all of their lists to ours.

        // I should only add entities in bays that are functional
<span class="nc bnc" id="L8421" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc bnc" id="L8422" title="All 4 branches missed.">            if ((next instanceof ASFBay) &amp;&amp; (((ASFBay) next).getCurrentDoors() &gt; 0)) {</span>
<span class="nc bnc" id="L8423" title="All 2 branches missed.">                for (Entity e : next.getLoadedUnits()) {</span>
<span class="nc" id="L8424">                    result.addElement(e);</span>
<span class="nc" id="L8425">                }</span>
            }
<span class="nc" id="L8427">        }</span>

        // Return the list.
<span class="nc" id="L8430">        return result;</span>
    }

    /**
     * @return only entities in ASF Bays that can be launched (i.e. not in
     * recovery)
     */
    public Vector&lt;Entity&gt; getLaunchableFighters() {
<span class="nc" id="L8438">        Vector&lt;Entity&gt; result = new Vector&lt;Entity&gt;();</span>

        // Walk through this entity's transport components;
        // add all of their lists to ours.

        // I should only add entities in bays that are functional
<span class="nc bnc" id="L8444" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc bnc" id="L8445" title="All 4 branches missed.">            if ((next instanceof ASFBay) &amp;&amp; (((ASFBay) next).getCurrentDoors() &gt; 0)) {</span>
<span class="nc" id="L8446">                Bay nextbay = (Bay) next;</span>
<span class="nc bnc" id="L8447" title="All 2 branches missed.">                for (Entity e : nextbay.getLaunchableUnits()) {</span>
<span class="nc" id="L8448">                    result.addElement(e);</span>
<span class="nc" id="L8449">                }</span>
            }
<span class="nc" id="L8451">        }</span>

        // Return the list.
<span class="nc" id="L8454">        return result;</span>
    }

    /**
     * @return only entities in that can be combat dropped
     */
    public Vector&lt;Entity&gt; getDroppableUnits() {
<span class="nc" id="L8461">        Vector&lt;Entity&gt; result = new Vector&lt;Entity&gt;();</span>

        // Walk through this entity's transport components;
        // add all of their lists to ours.

        // I should only add entities in bays that are functional
<span class="nc bnc" id="L8467" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc bnc" id="L8468" title="All 4 branches missed.">            if ((next instanceof Bay) &amp;&amp; (((Bay) next).getCurrentDoors() &gt; 0)) {</span>
<span class="nc" id="L8469">                Bay nextbay = (Bay) next;</span>
<span class="nc bnc" id="L8470" title="All 2 branches missed.">                for (Entity e : nextbay.getDroppableUnits()) {</span>
<span class="nc" id="L8471">                    result.addElement(e);</span>
<span class="nc" id="L8472">                }</span>
            }
<span class="nc" id="L8474">        }</span>

        // Return the list.
<span class="nc" id="L8477">        return result;</span>
    }

    /**
     * @return only entities in that can be unloaded on ground
     */
    public Vector&lt;Entity&gt; getUnitsUnloadableFromBays() {
<span class="nc" id="L8484">        Vector&lt;Entity&gt; result = new Vector&lt;Entity&gt;();</span>

        // Walk through this entity's transport components;
        // add all of their lists to ours.

        // I should only add entities in bays that are functional
<span class="nc bnc" id="L8490" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc bnc" id="L8491" title="All 4 branches missed.">            if ((next instanceof Bay) &amp;&amp; (((Bay) next).canUnloadUnits())) {</span>
<span class="nc" id="L8492">                Bay nextbay = (Bay) next;</span>
<span class="nc bnc" id="L8493" title="All 2 branches missed.">                for (Entity e : nextbay.getUnloadableUnits()) {</span>
<span class="nc bnc" id="L8494" title="All 2 branches missed.">                    if (!e.wasLoadedThisTurn()) {</span>
<span class="nc" id="L8495">                        result.addElement(e);</span>
                    }
<span class="nc" id="L8497">                }</span>
            }
<span class="nc" id="L8499">        }</span>

        // Return the list.
<span class="nc" id="L8502">        return result;</span>
    }

    public Bay getLoadedBay(int bayID) {

<span class="nc" id="L8507">        Vector&lt;Bay&gt; bays = getFighterBays();</span>
<span class="nc bnc" id="L8508" title="All 2 branches missed.">        for (int nbay = 0; nbay &lt; bays.size(); nbay++) {</span>
<span class="nc" id="L8509">            Bay currentBay = bays.elementAt(nbay);</span>
<span class="nc" id="L8510">            Vector&lt;Entity&gt; currentFighters = currentBay.getLoadedUnits();</span>
<span class="nc bnc" id="L8511" title="All 2 branches missed.">            for (int nfighter = 0; nfighter &lt; currentFighters.size(); nfighter++) {</span>
<span class="nc" id="L8512">                Entity fighter = currentFighters.elementAt(nfighter);</span>
<span class="nc bnc" id="L8513" title="All 2 branches missed.">                if (fighter.getId() == bayID) {</span>
                    // then we are in the right bay
<span class="nc" id="L8515">                    return currentBay;</span>
                }
            }
        }

<span class="nc" id="L8520">        return null;</span>

    }

    /**
     * @return get the bays separately
     */
    public Vector&lt;Bay&gt; getFighterBays() {
<span class="nc" id="L8528">        Vector&lt;Bay&gt; result = new Vector&lt;Bay&gt;();</span>

<span class="nc bnc" id="L8530" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc bnc" id="L8531" title="All 4 branches missed.">            if (((next instanceof ASFBay) || (next instanceof SmallCraftBay))</span>
<span class="nc bnc" id="L8532" title="All 2 branches missed.">                &amp;&amp; (((Bay) next).getCurrentDoors() &gt; 0)) {</span>
<span class="nc" id="L8533">                result.addElement((Bay) next);</span>
            }
<span class="nc" id="L8535">        }</span>

        // Return the list.
<span class="nc" id="L8538">        return result;</span>

    }

    /**
     * @return get the bays separately
     */
    public Vector&lt;DockingCollar&gt; getDockingCollars() {
<span class="nc" id="L8546">        Vector&lt;DockingCollar&gt; result = new Vector&lt;DockingCollar&gt;();</span>

<span class="nc bnc" id="L8548" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc bnc" id="L8549" title="All 2 branches missed.">            if (next instanceof DockingCollar) {</span>
<span class="nc" id="L8550">                result.addElement((DockingCollar) next);</span>
            }
<span class="nc" id="L8552">        }</span>

        // Return the list.
<span class="nc" id="L8555">        return result;</span>

    }

    /**
     * Returns vector of Transports for everything a unit transports
     *
     * @return
     */
    public Vector&lt;Transporter&gt; getTransports() {
<span class="nc" id="L8565">        return transports;</span>
    }

    public boolean isPodMountedTransport(Transporter t) {
<span class="nc" id="L8569">    	return omniPodTransports.contains(t);</span>
    }

    public Vector&lt;Bay&gt; getTransportBays() {

<span class="nc" id="L8574">        Vector&lt;Bay&gt; result = new Vector&lt;Bay&gt;();</span>

<span class="nc bnc" id="L8576" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc bnc" id="L8577" title="All 2 branches missed.">            if (next instanceof Bay) {</span>
<span class="nc" id="L8578">                result.addElement((Bay) next);</span>
            }
<span class="nc" id="L8580">        }</span>

        // Return the list.
<span class="nc" id="L8583">        return result;</span>
    }

    /**
     * do any damage to bay doors
     */
    public void resetBayDoors() {

<span class="nc bnc" id="L8591" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc bnc" id="L8592" title="All 2 branches missed.">            if (next instanceof Bay) {</span>
<span class="nc" id="L8593">                ((Bay) next).resetDoors();</span>
            }
<span class="nc" id="L8595">        }</span>
<span class="nc" id="L8596">    }</span>

    public void resetBays() {
<span class="nc bnc" id="L8599" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc bnc" id="L8600" title="All 2 branches missed.">            if (next instanceof Bay) {</span>
<span class="nc" id="L8601">                ((Bay) next).resetCounts();</span>
            }
<span class="nc" id="L8603">        }</span>
<span class="nc" id="L8604">    }</span>

    /**
     * @return the launch rate for fighters
     */
    public int getFighterLaunchRate() {
<span class="nc" id="L8610">        int result = 0;</span>

        // Walk through this entity's transport components;
<span class="nc bnc" id="L8613" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc bnc" id="L8614" title="All 2 branches missed.">            if (next instanceof ASFBay) {</span>
<span class="nc" id="L8615">                result += 2 * ((ASFBay) next).getCurrentDoors();</span>
            }
<span class="nc" id="L8617">        }</span>
        // Return the number.
<span class="nc" id="L8619">        return result;</span>
    }

    public Vector&lt;Entity&gt; getLoadedSmallCraft() {
<span class="nc" id="L8623">        Vector&lt;Entity&gt; result = new Vector&lt;Entity&gt;();</span>

        // Walk through this entity's transport components;
        // add all of their lists to ours.
<span class="nc bnc" id="L8627" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc bnc" id="L8628" title="All 2 branches missed.">            if ((next instanceof SmallCraftBay)</span>
<span class="nc bnc" id="L8629" title="All 2 branches missed.">                &amp;&amp; (((SmallCraftBay) next).getCurrentDoors() &gt; 0)) {</span>
<span class="nc bnc" id="L8630" title="All 2 branches missed.">                for (Entity e : next.getLoadedUnits()) {</span>
<span class="nc" id="L8631">                    result.addElement(e);</span>
<span class="nc" id="L8632">                }</span>
            }
<span class="nc" id="L8634">        }</span>

        // Return the list.
<span class="nc" id="L8637">        return result;</span>
    }

    public Vector&lt;Entity&gt; getLaunchableSmallCraft() {
<span class="nc" id="L8641">        Vector&lt;Entity&gt; result = new Vector&lt;Entity&gt;();</span>

        // Walk through this entity's transport components;
        // add all of their lists to ours.
<span class="nc bnc" id="L8645" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc bnc" id="L8646" title="All 2 branches missed.">            if ((next instanceof SmallCraftBay)</span>
<span class="nc bnc" id="L8647" title="All 2 branches missed.">                &amp;&amp; (((SmallCraftBay) next).getCurrentDoors() &gt; 0)) {</span>
<span class="nc" id="L8648">                Bay nextbay = (Bay) next;</span>
<span class="nc bnc" id="L8649" title="All 2 branches missed.">                for (Entity e : nextbay.getLaunchableUnits()) {</span>
<span class="nc" id="L8650">                    result.addElement(e);</span>
<span class="nc" id="L8651">                }</span>
            }
<span class="nc" id="L8653">        }</span>

        // Return the list.
<span class="nc" id="L8656">        return result;</span>
    }

    public Vector&lt;Entity&gt; getLoadedDropships() {
<span class="nc" id="L8660">        Vector&lt;Entity&gt; result = new Vector&lt;Entity&gt;();</span>

        // Walk through this entity's transport components;
        // add all of their lists to ours.
<span class="nc bnc" id="L8664" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc bnc" id="L8665" title="All 2 branches missed.">            if (next instanceof DockingCollar) {</span>
<span class="nc bnc" id="L8666" title="All 2 branches missed.">                for (Entity e : next.getLoadedUnits()) {</span>
<span class="nc" id="L8667">                    result.addElement(e);</span>
<span class="nc" id="L8668">                }</span>
            }
<span class="nc" id="L8670">        }</span>

        // Return the list.
<span class="nc" id="L8673">        return result;</span>
    }

    public Vector&lt;Entity&gt; getLaunchableDropships() {
<span class="nc" id="L8677">        Vector&lt;Entity&gt; result = new Vector&lt;Entity&gt;();</span>

        // Walk through this entity's transport components;
        // add all of their lists to ours.
<span class="nc bnc" id="L8681" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc bnc" id="L8682" title="All 2 branches missed.">            if (next instanceof DockingCollar) {</span>
<span class="nc" id="L8683">                DockingCollar collar = (DockingCollar) next;</span>
<span class="nc bnc" id="L8684" title="All 2 branches missed.">                for (Entity e : collar.getLaunchableUnits()) {</span>
<span class="nc" id="L8685">                    result.addElement(e);</span>
<span class="nc" id="L8686">                }</span>
            }
<span class="nc" id="L8688">        }</span>

        // Return the list.
<span class="nc" id="L8691">        return result;</span>
    }

    /**
     * get the bays separately
     */
    public Vector&lt;SmallCraftBay&gt; getSmallCraftBays() {
<span class="nc" id="L8698">        Vector&lt;SmallCraftBay&gt; result = new Vector&lt;SmallCraftBay&gt;();</span>

<span class="nc bnc" id="L8700" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc bnc" id="L8701" title="All 2 branches missed.">            if ((next instanceof SmallCraftBay)</span>
<span class="nc bnc" id="L8702" title="All 2 branches missed.">                &amp;&amp; (((SmallCraftBay) next).getCurrentDoors() &gt; 0)) {</span>
<span class="nc" id="L8703">                result.addElement((SmallCraftBay) next);</span>
            }
<span class="nc" id="L8705">        }</span>

        // Return the list.
<span class="nc" id="L8708">        return result;</span>

    }

    /**
     * @return launch rate for Small Craft
     */
    public int getSmallCraftLaunchRate() {
<span class="nc" id="L8716">        int result = 0;</span>

        // Walk through this entity's transport components;
<span class="nc bnc" id="L8719" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc bnc" id="L8720" title="All 2 branches missed.">            if (next instanceof SmallCraftBay) {</span>
<span class="nc" id="L8721">                result += 2 * ((SmallCraftBay) next).getCurrentDoors();</span>
            }
<span class="nc" id="L8723">        }</span>
        // Return the number.
<span class="nc" id="L8725">        return result;</span>
    }

    /**
     * Unload the given unit.
     *
     * @param unit - the &lt;code&gt;Entity&lt;/code&gt; to be unloaded.
     * @return &lt;code&gt;true&lt;/code&gt; if the unit was contained in this space,
     * &lt;code&gt;false&lt;/code&gt; otherwise.
     */
    @Override
    public boolean unload(Entity unit) {
        // Walk through this entity's transport components;
        // try to remove the unit from each in turn.
        // Stop after the first match.
<span class="nc" id="L8740">        Enumeration&lt;Transporter&gt; iter = transports.elements();</span>
<span class="nc bnc" id="L8741" title="All 2 branches missed.">        while (iter.hasMoreElements()) {</span>
<span class="nc" id="L8742">            Transporter next = iter.nextElement();</span>
<span class="nc bnc" id="L8743" title="All 2 branches missed.">            if (next.unload(unit)) {</span>
<span class="nc" id="L8744">                return true;</span>
            }
<span class="nc" id="L8746">        }</span>

        // If we got here, none of our transports currently carry the unit.
<span class="nc" id="L8749">        return false;</span>
    }

    @Override
    public void resetTransporter() {
        // Walk through this entity's transport components;
        // and resets them
<span class="nc" id="L8756">        Enumeration&lt;Transporter&gt; iter = transports.elements();</span>
<span class="nc bnc" id="L8757" title="All 2 branches missed.">        while (iter.hasMoreElements()) {</span>
<span class="nc" id="L8758">            Transporter next = iter.nextElement();</span>
<span class="nc" id="L8759">            next.resetTransporter();</span>
<span class="nc" id="L8760">        }</span>
<span class="nc" id="L8761">    }</span>

    /**
     * Return a string that identifies the unused capacity of this transporter.
     *
     * @return A &lt;code&gt;String&lt;/code&gt; meant for a human.
     */
    @Override
    public String getUnusedString() {
<span class="nc" id="L8770">        return getUnusedString(false);</span>
    }

    @Override
    public double getUnused() {
<span class="nc" id="L8775">        double capacity = 0;</span>
<span class="nc bnc" id="L8776" title="All 2 branches missed.">        for (Transporter transport : transports) {</span>
<span class="nc" id="L8777">            capacity += transport.getUnused();</span>
<span class="nc" id="L8778">        }</span>
<span class="nc" id="L8779">        return capacity;</span>
    }

    /**
     * Returns the current amount of cargo space for an entity of the given
     * type.
     *
     * @param e An entity that defines the unit class
     * @return The number of units of the given type that can be loaded in this
     * Entity
     */
    public double getUnused(Entity e) {
<span class="nc" id="L8791">        double capacity = 0;</span>
<span class="nc bnc" id="L8792" title="All 2 branches missed.">        for (Transporter transport : transports) {</span>
<span class="nc bnc" id="L8793" title="All 2 branches missed.">            if (transport.canLoad(e)) {</span>
<span class="nc" id="L8794">                capacity += transport.getUnused();</span>
            }
<span class="nc" id="L8796">        }</span>
<span class="nc" id="L8797">        return capacity;</span>
    }

    /**
     * Return a string that identifies the unused capacity of this transporter.
     *
     * @return A &lt;code&gt;String&lt;/code&gt; meant for a human.
     */
    public String getUnusedString(boolean ishtml) {
<span class="nc" id="L8806">        StringBuffer result = new StringBuffer();</span>

        // Walk through this entity's transport components;
        // add all of their string to ours.
<span class="nc" id="L8810">        Enumeration&lt;Transporter&gt; iter = transports.elements();</span>
<span class="nc bnc" id="L8811" title="All 2 branches missed.">        while (iter.hasMoreElements()) {</span>
<span class="nc" id="L8812">            Transporter next = iter.nextElement();</span>
<span class="nc bnc" id="L8813" title="All 4 branches missed.">            if ((next instanceof Bay) &amp;&amp; ((Bay)next).isQuarters()) {</span>
<span class="nc" id="L8814">                continue;</span>
            }
<span class="nc bnc" id="L8816" title="All 4 branches missed.">            if ((next instanceof DockingCollar) &amp;&amp; ((DockingCollar)next).isDamaged()) {</span>
<span class="nc" id="L8817">                continue;</span>
            }
<span class="nc bnc" id="L8819" title="All 6 branches missed.">            if (ishtml &amp;&amp; (next instanceof Bay) &amp;&amp; (((Bay) next).getBayDamage() &gt; 0)) {</span>
<span class="nc" id="L8820">                result.append(&quot;&lt;font color='red'&gt;&quot;)</span>
<span class="nc" id="L8821">                    .append(next.getUnusedString())</span>
<span class="nc" id="L8822">                    .append(&quot;&lt;/font&gt;&quot;);</span>
            } else {
<span class="nc" id="L8824">                result.append(next.getUnusedString());</span>
            }
<span class="nc bnc" id="L8826" title="All 6 branches missed.">            if (isOmni() &amp;&amp; ((next instanceof TroopSpace)</span>
                    || (next instanceof Bay))) {
<span class="nc bnc" id="L8828" title="All 2 branches missed.">            	if (omniPodTransports.contains(next)) {</span>
<span class="nc" id="L8829">            		result.append(&quot; (Pod)&quot;);</span>
            	} else {
<span class="nc" id="L8831">            		result.append(&quot; (Fixed)&quot;);</span>
            	}
            }
            // Add a newline character between strings.
<span class="nc bnc" id="L8835" title="All 2 branches missed.">            if (iter.hasMoreElements()) {</span>
<span class="nc bnc" id="L8836" title="All 2 branches missed.">                if (ishtml) {</span>
<span class="nc" id="L8837">                    result.append(&quot;&lt;br&gt;&quot;);</span>
                } else {
<span class="nc" id="L8839">                    result.append(&quot;\n&quot;);</span>
                }
            }
<span class="nc" id="L8842">        }</span>

        // Return the String.
<span class="nc" id="L8845">        return result.toString();</span>
    }

    /**
     * Determine if transported units prevent a weapon in the given location
     * from firing.
     *
     * @param loc    - the &lt;code&gt;int&lt;/code&gt; location attempting to fire.
     * @param isRear - a &lt;code&gt;boolean&lt;/code&gt; value stating if the given location
     *               is rear facing; if &lt;code&gt;false&lt;/code&gt;, the location is front
     *               facing.
     * @return &lt;code&gt;true&lt;/code&gt; if a transported unit is in the way,
     * &lt;code&gt;false&lt;/code&gt; if the weapon can fire.
     */
    @Override
    public boolean isWeaponBlockedAt(int loc, boolean isRear) {
        // Walk through this entity's transport components;
        // check each for blockage in turn.
        // Stop after the first match.
<span class="nc bnc" id="L8864" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc bnc" id="L8865" title="All 2 branches missed.">            if (next.isWeaponBlockedAt(loc, isRear)) {</span>
<span class="nc" id="L8866">                return true;</span>
            }
<span class="nc" id="L8868">        }</span>

        // If we got here, none of our transports
        // carry a blocking unit at that location.
<span class="nc" id="L8872">        return false;</span>
    }

    /**
     * If a unit is being transported on the outside of the transporter, it can
     * suffer damage when the transporter is hit by an attack. Currently, no
     * more than one unit can be at any single location; that same unit can be
     * &quot;spread&quot; over multiple locations.
     *
     * @param loc    - the &lt;code&gt;int&lt;/code&gt; location hit by attack.
     * @param isRear - a &lt;code&gt;boolean&lt;/code&gt; value stating if the given location
     *               is rear facing; if &lt;code&gt;false&lt;/code&gt;, the location is front
     *               facing.
     * @return The &lt;code&gt;Entity&lt;/code&gt; being transported on the outside at that
     * location. This value will be &lt;code&gt;null&lt;/code&gt; if no unit is
     * transported on the outside at that location.
     */
    @Override
    public Entity getExteriorUnitAt(int loc, boolean isRear) {
        // Walk through this entity's transport components;
        // check each for an exterior unit in turn.
        // Stop after the first match.
<span class="nc bnc" id="L8894" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc" id="L8895">            Entity exterior = next.getExteriorUnitAt(loc, isRear);</span>
<span class="nc bnc" id="L8896" title="All 2 branches missed.">            if (null != exterior) {</span>
<span class="nc" id="L8897">                return exterior;</span>
            }
<span class="nc" id="L8899">        }</span>

        // If we got here, none of our transports
        // carry an exterior unit at that location.
<span class="nc" id="L8903">        return null;</span>
    }

    @Override
    public ArrayList&lt;Entity&gt; getExternalUnits() {
<span class="nc" id="L8908">        ArrayList&lt;Entity&gt; rv = new ArrayList&lt;Entity&gt;();</span>
<span class="nc bnc" id="L8909" title="All 2 branches missed.">        for (Transporter t : transports) {</span>
<span class="nc" id="L8910">            rv.addAll(t.getExternalUnits());</span>
<span class="nc" id="L8911">        }</span>
<span class="nc" id="L8912">        return rv;</span>
    }

    @Override
    public int getCargoMpReduction(Entity carrier) {
<span class="nc" id="L8917">        int rv = 0;</span>
<span class="nc bnc" id="L8918" title="All 2 branches missed.">        for (Transporter t : transports) {</span>
<span class="nc" id="L8919">            rv += t.getCargoMpReduction(carrier);</span>
<span class="nc" id="L8920">        }</span>
<span class="nc" id="L8921">        return rv;</span>
    }

    public HitData getTrooperAtLocation(HitData hit, Entity transport) {
<span class="nc" id="L8925">        return rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
    }

    /**
     * Record the ID of the &lt;code&gt;Entity&lt;/code&gt; that has loaded this unit. A
     * unit that is unloaded can neither move nor attack for the rest of the
     * turn.
     *
     * @param transportId - the &lt;code&gt;int&lt;/code&gt; ID of our transport. The ID is
     *                    &lt;b&gt;not&lt;/b&gt; validated. This value should be
     *                    &lt;code&gt;Entity.NONE&lt;/code&gt; if this unit has been unloaded.
     */
    public void setTransportId(int transportId) {
<span class="nc" id="L8938">        conveyance = transportId;</span>
        // If we were unloaded, set the appropriate flags.
<span class="nc bnc" id="L8940" title="All 2 branches missed.">        if (transportId == Entity.NONE) {</span>
<span class="nc" id="L8941">            unloadedThisTurn = true;</span>
<span class="nc" id="L8942">            done = true;</span>
        } else {
<span class="nc" id="L8944">            loadedThisTurn = true;</span>
        }
<span class="nc" id="L8946">    }</span>

    /**
     * @return The number of additional crew capacity provided by quarters in transport bays.
     */
    public int getBayPersonnel() {
<span class="nc" id="L8952">        int count = 0;</span>
<span class="nc bnc" id="L8953" title="All 2 branches missed.">        for (Bay bay : this.getTransportBays()) {</span>
<span class="nc" id="L8954">            count += bay.getPersonnel(isClan());</span>
<span class="nc" id="L8955">        }</span>
<span class="nc" id="L8956">        return count;</span>
    }

    /**
     * Get the ID &lt;code&gt;Entity&lt;/code&gt; that has loaded this one.
     *
     * @return the &lt;code&gt;int&lt;/code&gt; ID of our transport. The ID may be invalid.
     * This value should be &lt;code&gt;Entity.NONE&lt;/code&gt; if this unit has
     * not been loaded.
     */
    public int getTransportId() {
<span class="nc" id="L8967">        return conveyance;</span>
    }

    @Override
    public int hardpointCost() {
<span class="nc" id="L8972">        return 0;</span>
    }

    /**
     * Determine if this unit has an active and working stealth system.
     * &lt;p/&gt;
     * Sub-classes are encouraged to override this method.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if this unit has a stealth system that is
     * currently active and it's actually working, &lt;code&gt;false&lt;/code&gt; if
     * there is no stealth system or if it is inactive.
     */
    public boolean isStealthActive() {
<span class="nc" id="L8985">        return false;</span>
    }

    /**
     * Determine if this unit has an active and working stealth system.
     * &lt;p/&gt;
     * Sub-classes are encouraged to override this method.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if this unit has a stealth system that is
     * currently active and it's actually working, &lt;code&gt;false&lt;/code&gt; if
     * there is no stealth system or if it is inactive.
     */
    public boolean isStealthOn() {
<span class="nc" id="L8998">        return false;</span>
    }

    /**
     * Determine if this unit has an active null-signature system.
     * &lt;p/&gt;
     * Sub-classes are encouraged to override this method.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if this unit has a null signature system that
     * is currently active, &lt;code&gt;false&lt;/code&gt; if there is no stealth
     * system or if it is inactive.
     */
    public boolean isNullSigActive() {
<span class="nc" id="L9011">        return false;</span>
    }

    /**
     * Determine if this unit has an active null-signature system.
     * &lt;p/&gt;
     * Sub-classes are encouraged to override this method.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if this unit has a null signature system that
     * is currently active, &lt;code&gt;false&lt;/code&gt; if there is no stealth
     * system or if it is inactive.
     */
    public boolean isNullSigOn() {
<span class="nc" id="L9024">        return false;</span>
    }

    /**
     * Determine if this unit has an active void signature system that is
     * providing its benefits.
     * &lt;p/&gt;
     * Sub-classes are encouraged to override this method.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if this unit has a void signature system that
     * is currently active, &lt;code&gt;false&lt;/code&gt; if there is no stealth
     * system or if it is inactive.
     */
    public boolean isVoidSigActive() {
<span class="nc" id="L9038">        return false;</span>
    }

    /**
     * Determine if this unit has an active void signature system.
     * &lt;p/&gt;
     * Sub-classes are encouraged to override this method.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if this unit has a void signature system that
     * is currently active, &lt;code&gt;false&lt;/code&gt; if there is no stealth
     * system or if it is turned off.
     */
    public boolean isVoidSigOn() {
<span class="nc" id="L9051">        return false;</span>
    }

    /**
     * Determine if this unit has an active chameleon light polarization field.
     * &lt;p/&gt;
     * Sub-classes are encouraged to override this method.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if this unit has a void signature system that
     * is currently active, &lt;code&gt;false&lt;/code&gt; if there is no stealth
     * system or if it is inactive.
     */
    public boolean isChameleonShieldActive() {
<span class="nc" id="L9064">        return false;</span>
    }

    /**
     * Determine if this unit has an active chameleon light polarization field.
     * &lt;p/&gt;
     * Sub-classes are encouraged to override this method.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if this unit has a void signature system that
     * is currently active, &lt;code&gt;false&lt;/code&gt; if there is no stealth
     * system or if it is inactive.
     */
    public boolean isChameleonShieldOn() {
<span class="nc" id="L9077">        return false;</span>
    }

    /**
     * Determine the stealth modifier for firing at this unit from the given
     * range. If the value supplied for &lt;code&gt;range&lt;/code&gt; is not one of the
     * &lt;code&gt;Entity&lt;/code&gt; class range constants, an
     * &lt;code&gt;IllegalArgumentException&lt;/code&gt; will be thrown.
     * &lt;p/&gt;
     * Sub-classes are encouraged to override this method.
     *
     * @param range - an &lt;code&gt;int&lt;/code&gt; value that must match one of the
     *              &lt;code&gt;Compute&lt;/code&gt; class range constants.
     * @param ae    - the entity making the attack, who maybe immune to certain
     *              kinds of stealth
     * @return a &lt;code&gt;TargetRoll&lt;/code&gt; value that contains the stealth
     * modifier for the given range.
     */
    public TargetRoll getStealthModifier(int range, Entity ae) {
<span class="nc" id="L9096">        TargetRoll result = null;</span>

        // Stealth must be active.
<span class="nc bnc" id="L9099" title="All 2 branches missed.">        if (!isStealthActive()) {</span>
<span class="nc" id="L9100">            result = new TargetRoll(0, &quot;stealth not active&quot;);</span>
        }

        // Get the range modifier.
<span class="nc bnc" id="L9104" title="All 2 branches missed.">        switch (range) {</span>
            case RangeType.RANGE_MINIMUM:
            case RangeType.RANGE_SHORT:
            case RangeType.RANGE_MEDIUM:
            case RangeType.RANGE_LONG:
            case RangeType.RANGE_EXTREME:
            case RangeType.RANGE_LOS:
            case RangeType.RANGE_OUT:
<span class="nc" id="L9112">                result = new TargetRoll(0, &quot;stealth not installed&quot;);</span>
<span class="nc" id="L9113">                break;</span>
            default:
<span class="nc" id="L9115">                throw new IllegalArgumentException(&quot;Unknown range constant: &quot;</span>
                                                   + range);
        }

        // Return the result.
<span class="nc" id="L9120">        return result;</span>
    }

    /**
     * Record the ID of the &lt;code&gt;Entity&lt;/code&gt; that is the current target of a
     * swarm attack by this unit. A unit that stops swarming can neither move
     * nor attack for the rest of the turn.
     *
     * @param id - the &lt;code&gt;int&lt;/code&gt; ID of the swarm attack's target. The ID
     *           is &lt;b&gt;not&lt;/b&gt; validated. This value should be
     *           &lt;code&gt;Entity.NONE&lt;/code&gt; if this unit has stopped swarming.
     */
    public void setSwarmTargetId(int id) {
<span class="nc" id="L9133">        swarmTargetId = id;</span>
        // This entity can neither move nor attack for the rest of this turn.
<span class="nc bnc" id="L9135" title="All 2 branches missed.">        if (id == Entity.NONE) {</span>
<span class="nc" id="L9136">            unloadedThisTurn = true;</span>
<span class="nc" id="L9137">            done = true;</span>
        }
<span class="nc" id="L9139">    }</span>

    /**
     * Get the ID of the &lt;code&gt;Entity&lt;/code&gt; that is the current target of a
     * swarm attack by this unit.
     *
     * @return the &lt;code&gt;int&lt;/code&gt; ID of the swarm attack's target The ID may
     * be invalid. This value should be &lt;code&gt;Entity.NONE&lt;/code&gt; if this
     * unit is not swarming.
     */
    public int getSwarmTargetId() {
<span class="nc" id="L9150">        return swarmTargetId;</span>
    }

    /**
     * Record the ID of the &lt;code&gt;Entity&lt;/code&gt; that is attacking this unit with
     * a swarm attack.
     *
     * @param id - the &lt;code&gt;int&lt;/code&gt; ID of the swarm attack's attacker. The
     *           ID is &lt;b&gt;not&lt;/b&gt; validated. This value should be
     *           &lt;code&gt;Entity.NONE&lt;/code&gt; if the swarm attack has ended.
     */
    public void setSwarmAttackerId(int id) {
<span class="nc" id="L9162">        swarmAttackerId = id;</span>
<span class="nc" id="L9163">    }</span>

    /**
     * Get the ID of the &lt;code&gt;Entity&lt;/code&gt; that is attacking this unit with a
     * swarm attack.
     *
     * @return the &lt;code&gt;int&lt;/code&gt; ID of the swarm attack's attacker The ID may
     * be invalid. This value should be &lt;code&gt;Entity.NONE&lt;/code&gt; if this
     * unit is not being swarmed.
     */
    public int getSwarmAttackerId() {
<span class="nc" id="L9174">        return swarmAttackerId;</span>
    }

    /**
     * Scans through the ammo on the unit for any inferno rounds.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if the unit is still loaded with Inferno
     * rounds. &lt;code&gt;false&lt;/code&gt; if no rounds were ever loaded or if
     * they have all been fired.
     */
    public boolean hasInfernoAmmo() {
<span class="nc" id="L9185">        boolean found = false;</span>

        // Walk through the unit's ammo, stop when we find a match.
<span class="nc bnc" id="L9188" title="All 2 branches missed.">        for (Mounted amounted : getAmmo()) {</span>
<span class="nc" id="L9189">            AmmoType atype = (AmmoType) amounted.getType();</span>
<span class="nc bnc" id="L9190" title="All 4 branches missed.">            if (((atype.getAmmoType() == AmmoType.T_SRM) || (atype.getAmmoType() == AmmoType.T_SRM_IMP)</span>
<span class="nc bnc" id="L9191" title="All 4 branches missed.">                    || (atype.getAmmoType() == AmmoType.T_MML)) &amp;&amp; (atype.getMunitionType() == AmmoType.M_INFERNO)</span>
<span class="nc bnc" id="L9192" title="All 2 branches missed.">                    &amp;&amp; (amounted.getHittableShotsLeft() &gt; 0)) {</span>
<span class="nc" id="L9193">                found = true;</span>
            }
<span class="nc bnc" id="L9195" title="All 4 branches missed.">            if ((atype.getAmmoType() == AmmoType.T_IATM) &amp;&amp; (atype.getMunitionType() == AmmoType.M_IATM_IIW)</span>
<span class="nc bnc" id="L9196" title="All 2 branches missed.">                    &amp;&amp; (amounted.getHittableShotsLeft() &gt; 0)) {</span>
<span class="nc" id="L9197">                found = true;</span>
            }
<span class="nc" id="L9199">        }</span>
<span class="nc" id="L9200">        return found;</span>
    }

    /**
     * Record if the unit is just combat-lossed or if it has been utterly
     * destroyed.
     *
     * @param canSalvage - a &lt;code&gt;boolean&lt;/code&gt; that is &lt;code&gt;true&lt;/code&gt; if the unit
     *                   can be repaired (given time and parts); if this value is
     *                   &lt;code&gt;false&lt;/code&gt;, the unit is utterly destroyed.
     */
    public void setSalvage(boolean canSalvage) {
        // Unsalvageable entities aren't in retreat or salvageable.
<span class="nc bnc" id="L9213" title="All 2 branches missed.">        if (!canSalvage) {</span>
<span class="nc" id="L9214">            setRemovalCondition(IEntityRemovalConditions.REMOVE_DEVASTATED);</span>
        }
<span class="nc" id="L9216">        salvageable = canSalvage;</span>
<span class="nc" id="L9217">    }</span>

    /**
     * Determine if the unit is just combat-lossed or if it has been utterly
     * destroyed.
     *
     * @return A &lt;code&gt;boolean&lt;/code&gt; that is &lt;code&gt;true&lt;/code&gt; if the unit has
     * salvageable components; if this value is &lt;code&gt;false&lt;/code&gt; the
     * unit is utterly destroyed.
     * @see #isRepairable()
     */
    public boolean isSalvage() {
<span class="nc" id="L9229">        return salvageable;</span>
    }

    /**
     * Determine if the unit can be repaired, or only harvested for spares.
     *
     * @return A &lt;code&gt;boolean&lt;/code&gt; that is &lt;code&gt;true&lt;/code&gt; if the unit can
     * be repaired (given enough time and parts); if this value is
     * &lt;code&gt;false&lt;/code&gt;, the unit is only a source of spares.
     * @see #isSalvage()
     */
    public boolean isRepairable() {
<span class="nc" id="L9241">        return isSalvage();</span>
    }

    /**
     * Getter for property removalCondition.
     *
     * @return Value of property removalCondition.
     */
    public int getRemovalCondition() {
<span class="nc" id="L9250">        return removalCondition;</span>
    }

    /**
     * Setter for property removalCondition.
     *
     * @param removalCondition New value of property removalCondition.
     */
    public void setRemovalCondition(int removalCondition) {
        // Don't replace a removal condition with a lesser condition.
<span class="nc bnc" id="L9260" title="All 2 branches missed.">        if (this.removalCondition &lt; removalCondition) {</span>
<span class="nc" id="L9261">            this.removalCondition = removalCondition;</span>
        }
<span class="nc" id="L9263">    }</span>

    /**
     * @return whether this entity is clearing a minefield.
     */
    public boolean isClearingMinefield() {
<span class="nc" id="L9269">        return clearingMinefield;</span>
    }

    /**
     * @param clearingMinefield
     */
    public void setClearingMinefield(boolean clearingMinefield) {
<span class="nc" id="L9276">        this.clearingMinefield = clearingMinefield;</span>
<span class="nc" id="L9277">    }</span>

    /**
     * @return whether this entity is spotting this round.
     */
    public boolean isSpotting() {
<span class="nc" id="L9283">        return spotting;</span>
    }

    /**
     * @param spotting
     */
    public void setSpotting(boolean spotting) {
<span class="nc" id="L9290">        this.spotting = spotting;</span>
<span class="nc" id="L9291">    }</span>

    /**
     * Um, basically everything can spot for LRM indirect fire.
     * Except for off-board units and units that sprinted.
     *
     * @return true, if the entity is eligible to spot
     */
    public boolean canSpot() {
<span class="nc bnc" id="L9300" title="All 8 branches missed.">        return isActive() &amp;&amp; !isOffBoard() &amp;&amp; </span>
        		(moved != EntityMovementType.MOVE_SPRINT) &amp;&amp; 
        		(moved != EntityMovementType.MOVE_VTOL_SPRINT);
    }

    @Override
    public String toString() {
<span class="nc" id="L9307">        return &quot;Entity [&quot; + getDisplayName() + &quot;, &quot; + getId() + &quot;]&quot;;</span>
    }

    /**
     * This returns a textual description of the entity for visualy impaired
     * users.
     */
    public String statusToString() {
        // should include additional information like imobile.
<span class="nc" id="L9316">        String str = &quot;Entity [&quot; + getDisplayName() + &quot;, &quot; + getId() + &quot;]: &quot;;</span>
<span class="nc bnc" id="L9317" title="All 2 branches missed.">        if (getPosition() != null) {</span>
<span class="nc" id="L9318">            str = str + &quot;Location: (&quot; + (getPosition().getX() + 1) + &quot;, &quot;</span>
<span class="nc" id="L9319">                  + (getPosition().getY() + 1) + &quot;) &quot;;</span>
        }
<span class="nc" id="L9321">        str = str + &quot;Owner: &quot; + owner.getName() + &quot; Armor: &quot; + getTotalArmor()</span>
<span class="nc" id="L9322">              + &quot;/&quot; + getTotalOArmor() + &quot; Internal Structure: &quot;</span>
<span class="nc" id="L9323">              + getTotalInternal() + &quot;/&quot; + getTotalOInternal();</span>

<span class="nc bnc" id="L9325" title="All 2 branches missed.">        if (!isActive()) {</span>
<span class="nc" id="L9326">            str += &quot; Inactive&quot;;</span>
        }
<span class="nc bnc" id="L9328" title="All 2 branches missed.">        if (isImmobile()) {</span>
<span class="nc" id="L9329">            str += &quot; Immobile&quot;;</span>
        }
<span class="nc bnc" id="L9331" title="All 2 branches missed.">        if (isProne()) {</span>
<span class="nc" id="L9332">            str += &quot; Prone&quot;;</span>
        }
<span class="nc bnc" id="L9334" title="All 2 branches missed.">        if (isDone()) {</span>
<span class="nc" id="L9335">            str += &quot; Done&quot;;</span>
        }

<span class="nc" id="L9338">        return str;</span>
    }

    /**
     * This returns a textual description of a specific location of the entity
     * for visualy impaired users.
     *
     * @param loc the location
     * @return a string descibing the status of the location.
     */
    public String statusToString(int loc) {
<span class="nc bnc" id="L9349" title="All 2 branches missed.">        if (loc == LOC_NONE) {</span>
<span class="nc" id="L9350">            return &quot;No location given.&quot;;</span>
        }

<span class="nc" id="L9353">        return getLocationName(loc) + &quot; (&quot; + getLocationAbbr(loc)</span>
<span class="nc" id="L9354">               + &quot;): Armor: &quot; + getArmorString(loc) + &quot;/&quot; + getOArmor(loc)</span>
<span class="nc" id="L9355">               + &quot; Structure: &quot; + getInternalString(loc) + &quot;/&quot;</span>
<span class="nc" id="L9356">               + getOInternal(loc);</span>
    }

    /**
     * @param str a string defining the location
     * @return the status of the given location.
     */
    public String statusToString(String str) {
<span class="nc" id="L9364">        int loc = LOC_NONE;</span>
<span class="nc" id="L9365">        loc = getLocationFromAbbr(str);</span>

<span class="nc bnc" id="L9367" title="All 2 branches missed.">        if (loc == LOC_NONE) {</span>
            try {
<span class="nc" id="L9369">                loc = Integer.parseInt(str);</span>
<span class="nc" id="L9370">            } catch (NumberFormatException nfe) {</span>
<span class="nc" id="L9371">                loc = LOC_NONE;</span>
<span class="nc" id="L9372">            }</span>
        }

<span class="nc" id="L9375">        return statusToString(loc);</span>
    }

    /**
     * The round the unit will be deployed. We will deploy at the end of a
     * round. So if depoyRound is set to 5, we will deploy when round 5 is over.
     * Any value of zero or less is automatically set to 1
     *
     * @param deployRound an int
     */
    public void setDeployRound(int deployRound) {
<span class="nc" id="L9386">        this.deployRound = deployRound;</span>

        // Entity's that deploy after the start can set their own deploy zone
        // If the deployRound is being set back to 0, make sure we reset the
        // starting position (START_NONE implies inheritance from owning player)
<span class="nc bnc" id="L9391" title="All 2 branches missed.">        if (deployRound == 0) {</span>
<span class="nc" id="L9392">            setStartingPos(Board.START_NONE);</span>
        }
<span class="nc" id="L9394">    }</span>

    /**
     * The round the unit will be deployed
     *
     * @return an int
     */
    public int getDeployRound() {
<span class="nc" id="L9402">        return deployRound;</span>
    }

    /**
     * Toggles if an entity has been deployed
     */
    public void setDeployed(boolean deployed) {
<span class="nc" id="L9409">        this.deployed = deployed;</span>
<span class="nc bnc" id="L9410" title="All 2 branches missed.">        if (deployed) {</span>
<span class="nc" id="L9411">            neverDeployed = false;</span>
        }
<span class="nc" id="L9413">    }</span>

    /**
     * Checks to see if an entity has been deployed
     */
    public boolean isDeployed() {
<span class="nc" id="L9419">        return deployed;</span>
    }

    /**
     * Checks to see if entity was never deployed
     */
    public boolean wasNeverDeployed() {
<span class="nc" id="L9426">        return neverDeployed;</span>
    }

    /**
     * Toggles if an entity has been deployed
     */
    public void setNeverDeployed(boolean neverDeployed) {
<span class="nc" id="L9433">        this.neverDeployed = neverDeployed;</span>
<span class="nc" id="L9434">    }</span>

    /**
     * Returns true if the entity should be deployed
     */
    public boolean shouldDeploy(int round) {
<span class="nc bnc" id="L9440" title="All 2 branches missed.">        return !isDeployed() </span>
<span class="nc bnc" id="L9441" title="All 2 branches missed.">            &amp;&amp; (getDeployRound() &lt;= round)</span>
<span class="nc bnc" id="L9442" title="All 2 branches missed.">            &amp;&amp; !isOffBoard();</span>
    }

    /**
     * Returns true if the offboard entity should be deployed this round.
     * @param round The current round number.
     * @return True if and only if the offboard entity should deploy this
     *         round, otherwise false.
     */
    public boolean shouldOffBoardDeploy(int round) {
<span class="nc bnc" id="L9452" title="All 2 branches missed.">        return isOffBoard() </span>
<span class="nc bnc" id="L9453" title="All 2 branches missed.">            &amp;&amp; !isDeployed() </span>
<span class="nc bnc" id="L9454" title="All 2 branches missed.">            &amp;&amp; (getDeployRound() &lt;= round);</span>
    }

    /**
     * Set the unit number for this entity.
     *
     * @param unit the number for the low-level unit that this
     *             entity belongs to. This entity can be removed from its unit by
     *             passing the value, &lt;code&gt;{@link Entity#NONE}&lt;/code&gt;.
     */
    public void setUnitNumber(final short unit) {
<span class="nc" id="L9465">        unitNumber = unit;</span>
<span class="nc" id="L9466">    }</span>

    /**
     * Get the unit number of this entity.
     *
     * @return The unit number. If the entity does not belong
     * to a unit, &lt;code&gt;{@link Entity#NONE}&lt;/code&gt; will be returned.
     */
    public short getUnitNumber() {
<span class="nc" id="L9475">        return unitNumber;</span>
    }

    /**
     * Returns whether an entity can flee from its current position. Currently
     * returns true if the entity is on the edge of the board.
     */
    public boolean canFlee() {
<span class="nc" id="L9483">        Coords pos = getPosition();</span>
<span class="nc bnc" id="L9484" title="All 2 branches missed.">        return (pos != null)</span>
<span class="nc bnc" id="L9485" title="All 4 branches missed.">               &amp;&amp; ((getWalkMP() &gt; 0) || (this instanceof Infantry))</span>
<span class="nc bnc" id="L9486" title="All 2 branches missed.">               &amp;&amp; !isProne()</span>
<span class="nc bnc" id="L9487" title="All 2 branches missed.">               &amp;&amp; !isStuck()</span>
<span class="nc bnc" id="L9488" title="All 2 branches missed.">               &amp;&amp; !isShutDown()</span>
<span class="nc bnc" id="L9489" title="All 2 branches missed.">               &amp;&amp; !getCrew().isUnconscious()</span>
<span class="nc bnc" id="L9490" title="All 4 branches missed.">               &amp;&amp; ((pos.getX() == 0) || (pos.getX() == (game.getBoard().getWidth() - 1))</span>
<span class="nc bnc" id="L9491" title="All 2 branches missed.">                   || (pos.getY() == 0) || (pos.getY() == (game.getBoard()</span>
<span class="nc bnc" id="L9492" title="All 2 branches missed.">                                                               .getHeight() - 1)));</span>
    }

    public void setEverSeenByEnemy(boolean b) {
<span class="nc" id="L9496">        everSeenByEnemy = b;</span>
<span class="nc" id="L9497">    }</span>

    public boolean isEverSeenByEnemy() {
<span class="nc" id="L9500">        return everSeenByEnemy;</span>
    }

    public void setVisibleToEnemy(boolean b) {
<span class="nc" id="L9504">        visibleToEnemy = b;</span>
<span class="nc" id="L9505">    }</span>

    public boolean isVisibleToEnemy() {
        // If double blind isn't on, the unit is always visible
<span class="nc bnc" id="L9509" title="All 4 branches missed.">        if ((game != null) &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVANCED_DOUBLE_BLIND)) {</span>
<span class="nc" id="L9510">            return true;</span>
        }
<span class="nc" id="L9512">        return visibleToEnemy;</span>
    }

    public void setDetectedByEnemy(boolean b) {
<span class="nc" id="L9516">        detectedByEnemy = b;</span>
<span class="nc" id="L9517">    }</span>

    public boolean isDetectedByEnemy() {
        // If double blind isn't on, the unit is always detected
<span class="nc bnc" id="L9521" title="All 4 branches missed.">        if ((game != null) &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVANCED_DOUBLE_BLIND)) {</span>
<span class="nc" id="L9522">            return true;</span>
        }
<span class="nc" id="L9524">        return detectedByEnemy;</span>
    }

    public void addBeenSeenBy(IPlayer p) {
<span class="nc bnc" id="L9528" title="All 4 branches missed.">        if ((p != null) &amp;&amp; !entitySeenBy.contains(p)) {</span>
<span class="nc" id="L9529">            entitySeenBy.add(p);</span>
        }
<span class="nc" id="L9531">    }</span>

    public Vector&lt;IPlayer&gt; getWhoCanSee() {
<span class="nc" id="L9534">        return entitySeenBy;</span>
    }

    public void setWhoCanSee(Vector&lt;IPlayer&gt; entitySeenBy) {
<span class="nc" id="L9538">        this.entitySeenBy = entitySeenBy;</span>
<span class="nc" id="L9539">    }</span>

    public void clearSeenBy() {
<span class="nc" id="L9542">        entitySeenBy.clear();</span>
<span class="nc" id="L9543">    }</span>

    /**
     * Returns true if the the given player can see this Entity, including
     * teammates if team_vision is on.
     *
     */
    public boolean hasSeenEntity(IPlayer p) {
        // No double blind - everyone sees everything
<span class="nc bnc" id="L9552" title="All 4 branches missed.">        if ((game == null) || !game.getOptions().booleanOption(OptionsConstants.ADVANCED_DOUBLE_BLIND)) {</span>
<span class="nc" id="L9553">            return true;</span>
        }
        // Null players see nothing
<span class="nc bnc" id="L9556" title="All 2 branches missed.">        if (p == null) {</span>
<span class="nc" id="L9557">            return false;</span>
        }
        // A Player can always see their own 'mechs
<span class="nc bnc" id="L9560" title="All 2 branches missed.">        if (getOwner().equals(p)) {</span>
<span class="nc" id="L9561">            return true;</span>
        }

        // If a player can see all, it sees this
<span class="nc bnc" id="L9565" title="All 2 branches missed.">        if (p.canSeeAll()) {</span>
<span class="nc" id="L9566">            return true;</span>
        }

        // Observers can see units spotted by an enemy
<span class="nc bnc" id="L9570" title="All 2 branches missed.">        if (p.isObserver()) {</span>
<span class="nc bnc" id="L9571" title="All 2 branches missed.">            for (IPlayer other : entitySeenBy) {</span>
<span class="nc bnc" id="L9572" title="All 2 branches missed.">                if (other.isEnemyOf(getOwner())) {</span>
<span class="nc" id="L9573">                    return true;</span>
                }
<span class="nc" id="L9575">            }</span>
<span class="nc" id="L9576">            return false;</span>
        }

<span class="nc bnc" id="L9579" title="All 2 branches missed.">        if (entitySeenBy.contains(p)) {</span>
<span class="nc" id="L9580">            return true;</span>
        }
        // If team vision, see if any players on team can see
<span class="nc bnc" id="L9583" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TEAM_VISION)) {</span>
<span class="nc bnc" id="L9584" title="All 2 branches missed.">            for (IPlayer teammate : game.getPlayersVector()) {</span>
<span class="nc bnc" id="L9585" title="All 2 branches missed.">                if ((teammate.getTeam() == p.getTeam())</span>
<span class="nc bnc" id="L9586" title="All 2 branches missed.">                        &amp;&amp; entitySeenBy.contains(teammate)) {</span>
<span class="nc" id="L9587">                    return true;</span>
                }
<span class="nc" id="L9589">            }</span>
        }
        // Can't see
<span class="nc" id="L9592">        return false;</span>
    }

    public void addBeenDetectedBy(IPlayer p) {
        // This is for saved-game backwards compatibility
<span class="nc bnc" id="L9597" title="All 2 branches missed.">        if (entityDetectedBy == null) {</span>
<span class="nc" id="L9598">            entityDetectedBy = new Vector&lt;IPlayer&gt;();</span>
        }
<span class="nc bnc" id="L9600" title="All 4 branches missed.">        if ((p != null) &amp;&amp; !entityDetectedBy.contains(p)) {</span>
<span class="nc" id="L9601">            entityDetectedBy.add(p);</span>
        }
<span class="nc" id="L9603">    }</span>

    public Vector&lt;IPlayer&gt; getWhoCanDetect() {
<span class="nc" id="L9606">        return entityDetectedBy;</span>
    }

    public void setWhoCanDetect(Vector&lt;IPlayer&gt; entityDetectedBy) {
<span class="nc" id="L9610">        this.entityDetectedBy = entityDetectedBy;</span>
<span class="nc" id="L9611">    }</span>

    public void clearDetectedBy() {
        // This is for saved-game backwards compatibility
<span class="nc bnc" id="L9615" title="All 2 branches missed.">        if (entityDetectedBy == null) {</span>
<span class="nc" id="L9616">            entityDetectedBy = new Vector&lt;IPlayer&gt;();</span>
        }
<span class="nc" id="L9618">        entityDetectedBy.clear();</span>
<span class="nc" id="L9619">    }</span>

    /**
     * Returns true if the the given player can see this Entity, including
     * teammates if team_vision is on.
     *
     */
    public boolean hasDetectedEntity(IPlayer p) {
        // No sensors - no one detects anything
<span class="nc bnc" id="L9628" title="All 2 branches missed.">        if ((game == null)</span>
<span class="nc bnc" id="L9629" title="All 2 branches missed.">                || !game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_SENSORS)) {</span>
<span class="nc" id="L9630">            return false;</span>
        }
        // Null players detect nothing
<span class="nc bnc" id="L9633" title="All 2 branches missed.">        if (p == null) {</span>
<span class="nc" id="L9634">            return false;</span>
        }
        // This is for saved-game backwards compatibility
<span class="nc bnc" id="L9637" title="All 2 branches missed.">        if (entityDetectedBy == null) {</span>
<span class="nc" id="L9638">            entityDetectedBy = new Vector&lt;IPlayer&gt;();</span>
        }

        // Observers can detect units detected by an enemy
<span class="nc bnc" id="L9642" title="All 2 branches missed.">        if (p.isObserver()) {</span>
<span class="nc bnc" id="L9643" title="All 2 branches missed.">            for (IPlayer other : entityDetectedBy) {</span>
<span class="nc bnc" id="L9644" title="All 2 branches missed.">                if (other.isEnemyOf(getOwner())) {</span>
<span class="nc" id="L9645">                    return true;</span>
                }
<span class="nc" id="L9647">            }</span>
<span class="nc" id="L9648">            return false;</span>
        }

<span class="nc bnc" id="L9651" title="All 2 branches missed.">        if (entityDetectedBy.contains(p)) {</span>
<span class="nc" id="L9652">            return true;</span>
        }
        // If team vision, see if any players on team can see
<span class="nc bnc" id="L9655" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TEAM_VISION)) {</span>
<span class="nc bnc" id="L9656" title="All 2 branches missed.">            for (IPlayer teammate : game.getPlayersVector()) {</span>
<span class="nc bnc" id="L9657" title="All 2 branches missed.">                if ((teammate.getTeam() == p.getTeam())</span>
<span class="nc bnc" id="L9658" title="All 2 branches missed.">                        &amp;&amp; entityDetectedBy.contains(teammate)) {</span>
<span class="nc" id="L9659">                    return true;</span>
                }
<span class="nc" id="L9661">            }</span>
        }
        // Can't see
<span class="nc" id="L9664">        return false;</span>
    }

    /**
     * Returns whether this Entity is a sensor return to the given player.
     *
     * @param spotter
     *            The player trying to view this unit
     * @return True if the given player can only see this Entity as a sensor
     *         return
     */
    public boolean isSensorReturn(IPlayer spotter) {
<span class="nc" id="L9676">        boolean alliedUnit =</span>
<span class="nc bnc" id="L9677" title="All 2 branches missed.">                !getOwner().isEnemyOf(spotter)</span>
<span class="nc bnc" id="L9678" title="All 2 branches missed.">                || (getOwner().getTeam() == spotter.getTeam()</span>
<span class="nc bnc" id="L9679" title="All 2 branches missed.">                    &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVANCED_TEAM_VISION));</span>

<span class="nc bnc" id="L9681" title="All 2 branches missed.">        boolean sensors = (game.getOptions().booleanOption(</span>
                OptionsConstants.ADVANCED_TACOPS_SENSORS)
<span class="nc bnc" id="L9683" title="All 2 branches missed.">                || game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ADVANCED_SENSORS));</span>
<span class="nc" id="L9684">        boolean sensorsDetectAll = game.getOptions().booleanOption(</span>
                OptionsConstants.ADVANCED_SENSORS_DETECT_ALL);
<span class="nc" id="L9686">        boolean doubleBlind = game.getOptions().booleanOption(</span>
                OptionsConstants.ADVANCED_DOUBLE_BLIND);

<span class="nc bnc" id="L9689" title="All 8 branches missed.">        return sensors &amp;&amp; doubleBlind &amp;&amp; !alliedUnit &amp;&amp; !sensorsDetectAll</span>
<span class="nc bnc" id="L9690" title="All 4 branches missed.">                &amp;&amp; !hasSeenEntity(spotter) &amp;&amp; hasDetectedEntity(spotter);</span>
    }

    protected int applyGravityEffectsOnMP(int MP) {
<span class="nc" id="L9694">        int result = MP;</span>
<span class="nc bnc" id="L9695" title="All 2 branches missed.">        if (game != null) {</span>
<span class="nc" id="L9696">            float fMP = MP / game.getPlanetaryConditions().getGravity();</span>
<span class="nc bnc" id="L9697" title="All 2 branches missed.">            fMP = (Math.abs((Math.round(fMP) - fMP)) == 0.5) ? (float) Math</span>
<span class="nc" id="L9698">                    .floor(fMP) : Math.round(fMP); // the</span>
            // rule
            // requires
            // rounding down on .5
<span class="nc" id="L9702">            result = (int) fMP;</span>
        }
<span class="nc" id="L9704">        return result;</span>
    }

    /**
     * Whether this type of unit can perform charges
     */
    public boolean canCharge() {
<span class="nc bnc" id="L9711" title="All 8 branches missed.">        return !isImmobile() &amp;&amp; (getWalkMP() &gt; 0) &amp;&amp; !isStuck() &amp;&amp; !isProne();</span>
    }

    /**
     * Whether this type of unit can perform DFA attacks
     */
    public boolean canDFA() {
<span class="nc bnc" id="L9718" title="All 8 branches missed.">        return !isImmobile() &amp;&amp; (getJumpMP() &gt; 0) &amp;&amp; !isStuck() &amp;&amp; !isProne();</span>
    }

    /**
     * Whether this type of unit can perform Ramming attacks
     */
    public boolean canRam() {
<span class="nc" id="L9725">        return false;</span>
    }

    public boolean isUsingManAce() {
<span class="nc" id="L9729">        return hasAbility(OptionsConstants.PILOT_MANEUVERING_ACE);</span>
    }

    public Enumeration&lt;Entity&gt; getKills() {
<span class="nc" id="L9733">        final int killer = id;</span>
<span class="nc" id="L9734">        return game.getSelectedOutOfGameEntities(new EntitySelector() {</span>
            @Override
            public boolean accept(Entity entity) {
<span class="nc bnc" id="L9737" title="All 2 branches missed.">                if (killer == entity.killerId) {</span>
<span class="nc" id="L9738">                    return true;</span>
                }
<span class="nc" id="L9740">                return false;</span>
            }
        });
    }

    public int getKillNumber() {
<span class="nc" id="L9746">        final int killer = id;</span>
<span class="nc" id="L9747">        return game.getSelectedOutOfGameEntityCount(new EntitySelector() {</span>
            @Override
            public boolean accept(Entity entity) {
<span class="nc bnc" id="L9750" title="All 2 branches missed.">                if (killer == entity.killerId) {</span>
<span class="nc" id="L9751">                    return true;</span>
                }
<span class="nc" id="L9753">                return false;</span>
            }
        });
    }

    public void addKill(Entity kill) {
<span class="nc" id="L9759">        kill.killerId = id;</span>
<span class="nc" id="L9760">    }</span>

    public boolean getGaveKillCredit() {
<span class="nc bnc" id="L9763" title="All 2 branches missed.">        return killerId != Entity.NONE;</span>
    }

    public int getKillerId() {
<span class="nc" id="L9767">        return killerId;</span>
    }

    /**
     * Determines if an entity is eligible for a phase.
     */
    public boolean isEligibleFor(IGame.Phase phase) {
        // only deploy in deployment phase
<span class="nc bnc" id="L9775" title="All 4 branches missed.">        if ((phase == IGame.Phase.PHASE_DEPLOYMENT) == isDeployed()) {</span>
<span class="nc" id="L9776">            return false;</span>
        }

        // carcass can't do anything
<span class="nc bnc" id="L9780" title="All 2 branches missed.">        if (isCarcass()) {</span>
<span class="nc" id="L9781">            return false;</span>
        }

        // Hidden units shouldn't be counted for turn order, unless deploying
<span class="nc bnc" id="L9785" title="All 6 branches missed.">        if (isHidden() &amp;&amp; phase != Phase.PHASE_DEPLOYMENT</span>
                &amp;&amp; phase != Phase.PHASE_FIRING) {
<span class="nc" id="L9787">            return false;</span>
        }

<span class="nc bnc" id="L9790" title="All 6 branches missed.">        switch (phase) {</span>
            case PHASE_MOVEMENT:
<span class="nc" id="L9792">                return isEligibleForMovement();</span>
            case PHASE_FIRING:
<span class="nc" id="L9794">                return isEligibleForFiring();</span>
            case PHASE_PHYSICAL:
<span class="nc" id="L9796">                return isEligibleForPhysical();</span>
            case PHASE_TARGETING:
<span class="nc" id="L9798">                return isEligibleForTargetingPhase();</span>
            case PHASE_OFFBOARD:
<span class="nc" id="L9800">                return isEligibleForOffboard();</span>
            default:
<span class="nc" id="L9802">                return true;</span>
        }
    }

    /**
     * Determines if an entity is eligible for a phase. Called only if at least
     * one entity returned true to isEligibleFor() This is for using
     * searchlights in physical&amp;offboard phase, without forcing the phase to be
     * played when not needed. However it could be used for other things in the
     * future
     */
    public boolean canAssist(IGame.Phase phase) {
<span class="nc bnc" id="L9814" title="All 6 branches missed.">        if ((phase != IGame.Phase.PHASE_PHYSICAL)</span>
            &amp;&amp; (phase != IGame.Phase.PHASE_FIRING)
            &amp;&amp; (phase != IGame.Phase.PHASE_OFFBOARD)) {
<span class="nc" id="L9817">            return false;</span>
        }
        // if you're charging or finding a club, it's already declared
<span class="nc bnc" id="L9820" title="All 8 branches missed.">        if (isUnjammingRAC() || isCharging() || isMakingDfa() || isRamming()</span>
<span class="nc bnc" id="L9821" title="All 4 branches missed.">            || isFindingClub() || isOffBoard()) {</span>
<span class="nc" id="L9822">            return false;</span>
        }
        // must be active
<span class="nc bnc" id="L9825" title="All 2 branches missed.">        if (!isActive()) {</span>
<span class="nc" id="L9826">            return false;</span>
        }
        // If we have a searchlight, we can use it to assist
<span class="nc bnc" id="L9829" title="All 2 branches missed.">        if (isUsingSpotlight()) {</span>
<span class="nc" id="L9830">            return true;</span>
        }
<span class="nc" id="L9832">        return false;</span>
    }

    /**
     * An entity is eligible for firing if it's not taking some kind of action
     * that prevents it from firing, such as a full-round physical attack
     * or sprinting.
     */
    public boolean isEligibleForFiring() {
        // if you're charging, no shooting
<span class="nc bnc" id="L9842" title="All 8 branches missed.">        if (isUnjammingRAC() || isCharging() || isMakingDfa() || isRamming()) {</span>
<span class="nc" id="L9843">            return false;</span>
        }

        // if you're offboard, no shooting
<span class="nc bnc" id="L9847" title="All 4 branches missed.">        if (isOffBoard() || isAssaultDropInProgress()) {</span>
<span class="nc" id="L9848">            return false;</span>
        }

        // check game options
<span class="nc bnc" id="L9852" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.BASE_SKIP_INELIGABLE_FIRING)) {</span>
<span class="nc" id="L9853">            return true;</span>
        }

        // must be active
<span class="nc bnc" id="L9857" title="All 2 branches missed.">        if (!isActive()) {</span>
<span class="nc" id="L9858">            return false;</span>
        }

<span class="nc" id="L9861">        return true;</span>
    }

    /**
     * Pretty much anybody's eligible for movement. If the game option is
     * toggled on, inactive and immobile entities are not eligible. OffBoard
     * units are always ineligible
     *
     * @return whether or not the entity is allowed to move
     */
    public boolean isEligibleForMovement() {
        // check if entity is offboard
<span class="nc bnc" id="L9873" title="All 6 branches missed.">        if (isOffBoard() || (isAssaultDropInProgress()</span>
                &amp;&amp; !(movementMode == EntityMovementMode.WIGE))) {
<span class="nc" id="L9875">            return false;</span>
        }
        // Prevent ejected crews from moving when advanced movement rule is off
<span class="nc bnc" id="L9878" title="All 6 branches missed.">        if (!game.useVectorMove() &amp;&amp; isSpaceborne() &amp;&amp; this instanceof EjectedCrew) {</span>
<span class="nc" id="L9879">            return false;</span>
        }
        // check game options
<span class="nc bnc" id="L9882" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.BASE_SKIP_INELIGABLE_MOVEMENT)) {</span>
<span class="nc" id="L9883">            return true;</span>
        }
        // Must be active: this is slightly different  from isActive();
        //   we don't want to skip manually shutdown units (so they can restart)
<span class="nc bnc" id="L9887" title="All 6 branches missed.">        boolean isActive = (!shutDown || isManualShutdown()) &amp;&amp; !destroyed</span>
<span class="nc bnc" id="L9888" title="All 6 branches missed.">                &amp;&amp; getCrew().isActive() &amp;&amp; !unloadedThisTurn &amp;&amp; deployed;</span>
<span class="nc bnc" id="L9889" title="All 2 branches missed.">        if (!isActive</span>
<span class="nc bnc" id="L9890" title="All 6 branches missed.">            || (isImmobile() &amp;&amp; !isManualShutdown() &amp;&amp; !canUnjamRAC() &amp;&amp;</span>
<span class="nc bnc" id="L9891" title="All 2 branches missed.">                !game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_VEHICLES_CAN_EJECT))) {</span>
<span class="nc" id="L9892">            return false;</span>
        }

<span class="nc" id="L9895">        return true;</span>
    }

    public boolean isEligibleForOffboard() {

        // if you're charging, no shooting
<span class="nc bnc" id="L9901" title="All 6 branches missed.">        if (isUnjammingRAC() || isCharging() || isMakingDfa()) {</span>
<span class="nc" id="L9902">            return false;</span>
        }

        // if you're offboard, no shooting
<span class="nc bnc" id="L9906" title="All 4 branches missed.">        if (isOffBoard() || isAssaultDropInProgress()) {</span>
<span class="nc" id="L9907">            return false;</span>
        }
<span class="nc bnc" id="L9909" title="All 2 branches missed.">        for (Mounted mounted : getWeaponList()) {</span>
<span class="nc" id="L9910">            WeaponType wtype = (WeaponType) mounted.getType();</span>
<span class="nc bnc" id="L9911" title="All 2 branches missed.">            if ((wtype != null)</span>
<span class="nc bnc" id="L9912" title="All 4 branches missed.">                &amp;&amp; (wtype.hasFlag(WeaponType.F_TAG) &amp;&amp; mounted.isReady())) {</span>
<span class="nc" id="L9913">                return true;</span>
            }
<span class="nc" id="L9915">        }</span>
<span class="nc" id="L9916">        return false;// only things w/ tag are</span>
    }

    public boolean isAttackingThisTurn() {
<span class="nc" id="L9920">        List&lt;EntityAction&gt; actions = game.getActionsVector();</span>
<span class="nc bnc" id="L9921" title="All 2 branches missed.">        for (EntityAction ea : actions) {</span>
<span class="nc bnc" id="L9922" title="All 4 branches missed.">            if ((ea.getEntityId() == getId())</span>
                &amp;&amp; (ea instanceof AbstractAttackAction)) {
<span class="nc" id="L9924">                return true;</span>
            }
<span class="nc" id="L9926">        }</span>
<span class="nc" id="L9927">        return false;</span>
    }

    /**
     * Check if the entity has any valid targets for physical attacks.
     */
    public boolean isEligibleForPhysical() {
<span class="nc" id="L9934">        boolean canHit = false;</span>
<span class="nc" id="L9935">        boolean friendlyFire = game.getOptions().booleanOption(OptionsConstants.BASE_FRIENDLY_FIRE);</span>

<span class="nc bnc" id="L9937" title="All 2 branches missed.">        if ((this instanceof Infantry)</span>
<span class="nc bnc" id="L9938" title="All 2 branches missed.">                &amp;&amp; hasWorkingMisc(MiscType.F_TOOLS,</span>
                        MiscType.S_DEMOLITION_CHARGE)) {
<span class="nc" id="L9940">            IHex hex = game.getBoard().getHex(getPosition());</span>
<span class="nc" id="L9941">            return hex.containsTerrain(Terrains.BUILDING);</span>
        }
        // only mechs and protos have physical attacks (except tank charges)
<span class="nc bnc" id="L9944" title="All 6 branches missed.">        if (!((this instanceof Mech) || (this instanceof Protomech) || (this instanceof Infantry))) {</span>
<span class="nc" id="L9945">            return false;</span>
        }

        // if you're charging or finding a club, it's already declared
<span class="nc bnc" id="L9949" title="All 8 branches missed.">        if (isUnjammingRAC() || isCharging() || isMakingDfa() || isRamming()</span>
<span class="nc bnc" id="L9950" title="All 6 branches missed.">            || isFindingClub() || isOffBoard() || isAssaultDropInProgress()</span>
<span class="nc bnc" id="L9951" title="All 2 branches missed.">            || isDropping()) {</span>
<span class="nc" id="L9952">            return false;</span>
        }

        // check game options
<span class="nc bnc" id="L9956" title="All 4 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ALLOWED_NO_CLAN_PHYSICAL) &amp;&amp; isClan()</span>
<span class="nc bnc" id="L9957" title="All 4 branches missed.">            &amp;&amp; !hasINarcPodsAttached() &amp;&amp; (getSwarmAttackerId() == NONE)) {</span>
<span class="nc" id="L9958">            return false;</span>
        }

        // Issue with Vibroblades only being turned on/off during Physical phase
        // -- Torren
<span class="nc bnc" id="L9963" title="All 2 branches missed.">        if (hasVibroblades()) {</span>
<span class="nc" id="L9964">            return true;</span>
        }

<span class="nc bnc" id="L9967" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.BASE_SKIP_INELIGABLE_PHYSICAL)) {</span>
<span class="nc" id="L9968">            return true;</span>
        }

        // dead mek walking
<span class="nc bnc" id="L9972" title="All 2 branches missed.">        if (!isActive()) {</span>
<span class="nc" id="L9973">            return false;</span>
        }

        // sprinted?
<span class="nc bnc" id="L9977" title="All 4 branches missed.">        if (moved == EntityMovementType.MOVE_SPRINT</span>
                || moved == EntityMovementType.MOVE_VTOL_SPRINT) {
<span class="nc" id="L9979">            return false;</span>
        }

<span class="nc bnc" id="L9982" title="All 2 branches missed.">        if (getPosition() == null) {</span>
<span class="nc" id="L9983">            return false; // not on board?</span>
        }

        // check if we have iNarc pods attached that can be brushed off
<span class="nc bnc" id="L9987" title="All 4 branches missed.">        if (hasINarcPodsAttached() &amp;&amp; (this instanceof Mech)) {</span>
<span class="nc" id="L9988">            return true;</span>
        }

        // Try to find a valid entity target.
<span class="nc" id="L9992">        Iterator&lt;Entity&gt; e = game.getEntities();</span>
<span class="nc bnc" id="L9993" title="All 4 branches missed.">        while (!canHit &amp;&amp; e.hasNext()) {</span>
<span class="nc" id="L9994">            Entity target = e.next();</span>

            // don't shoot at friendlies unless you are into that sort of thing
            // and do not shoot yourself even then
<span class="nc bnc" id="L9998" title="All 4 branches missed.">            if (!(isEnemyOf(target) || (friendlyFire &amp;&amp; (getId() != target</span>
<span class="nc bnc" id="L9999" title="All 2 branches missed.">                    .getId())))) {</span>
<span class="nc" id="L10000">                continue;</span>
            }

<span class="nc bnc" id="L10003" title="All 2 branches missed.">            if (!target.isDeployed()) {</span>
<span class="nc" id="L10004">                continue;</span>
            }
            // No physical attack works at distances &gt; 1.
<span class="nc bnc" id="L10007" title="All 2 branches missed.">            if ((target.getPosition() != null)</span>
<span class="nc bnc" id="L10008" title="All 2 branches missed.">                &amp;&amp; (Compute.effectiveDistance(game, this, target) &gt; 1)) {</span>
<span class="nc" id="L10009">                continue;</span>
            }

<span class="nc" id="L10012">            canHit |= Compute.canPhysicalTarget(game, getId(), target);</span>
            // check if we can dodge and target can attack us,
            // then we are eligible.
<span class="nc bnc" id="L10015" title="All 4 branches missed.">            canHit |= ((this instanceof Mech) &amp;&amp; !isProne()</span>
<span class="nc bnc" id="L10016" title="All 2 branches missed.">                       &amp;&amp; hasAbility(OptionsConstants.PILOT_DODGE_MANEUVER) &amp;&amp; Compute</span>
<span class="nc bnc" id="L10017" title="All 2 branches missed.">                    .canPhysicalTarget(game, target.getId(), this));</span>
<span class="nc" id="L10018">        }</span>

        // If there are no valid Entity targets, check for add valid buildings.
<span class="nc" id="L10021">        Enumeration&lt;Building&gt; bldgs = game.getBoard().getBuildings();</span>
<span class="nc bnc" id="L10022" title="All 4 branches missed.">        while (!canHit &amp;&amp; bldgs.hasMoreElements()) {</span>
<span class="nc" id="L10023">            final Building bldg = bldgs.nextElement();</span>

            // Walk through the hexes of the building.
<span class="nc" id="L10026">            Enumeration&lt;Coords&gt; hexes = bldg.getCoords();</span>
<span class="nc bnc" id="L10027" title="All 4 branches missed.">            while (!canHit &amp;&amp; hexes.hasMoreElements()) {</span>
<span class="nc" id="L10028">                final Coords coords = hexes.nextElement();</span>

                // No physical attack works at distances &gt; 1.
<span class="nc bnc" id="L10031" title="All 2 branches missed.">                if (getPosition().distance(coords) &gt; 1) {</span>
<span class="nc" id="L10032">                    continue;</span>
                }

                // Can the entity target *this* hex of the building?
<span class="nc" id="L10036">                final BuildingTarget target = new BuildingTarget(coords,</span>
<span class="nc" id="L10037">                                                                 game.getBoard(), false);</span>
<span class="nc" id="L10038">                canHit |= Compute.canPhysicalTarget(game, getId(), target);</span>

<span class="nc" id="L10040">            } // Check the next hex of the building</span>

<span class="nc" id="L10042">        } // Check the next building</span>

<span class="nc" id="L10044">        return canHit;</span>
    }

    /**
     * Determines if this Entity is eligible to pre-designate hexes as
     * auto-hits. Per TacOps pg 180, if a player has offboard artillery they get
     * 5 pre- designated hexes per mapsheet.
     *
     * @return
     */
    public boolean isEligibleForArtyAutoHitHexes() {
<span class="nc bnc" id="L10055" title="All 2 branches missed.">        return isEligibleForTargetingPhase()</span>
<span class="nc bnc" id="L10056" title="All 4 branches missed.">               &amp;&amp; (isOffBoard() || game.getOptions().booleanOption(</span>
                OptionsConstants.ADVCOMBAT_ON_MAP_PREDESIGNATE));
    }

    public boolean isEligibleForTargetingPhase() {
<span class="nc bnc" id="L10061" title="All 2 branches missed.">        if (isAssaultDropInProgress()) {</span>
<span class="nc" id="L10062">            return false;</span>
        }
<span class="nc bnc" id="L10064" title="All 2 branches missed.">        for (Mounted mounted : getWeaponList()) {</span>
<span class="nc" id="L10065">            WeaponType wtype = (WeaponType) mounted.getType();</span>
<span class="nc bnc" id="L10066" title="All 4 branches missed.">            if ((wtype != null) &amp;&amp; (wtype.hasFlag(WeaponType.F_ARTILLERY))) {</span>
<span class="nc" id="L10067">                return true;</span>
            }
            //Bearings-only capital missiles fire during the targeting phase
<span class="nc bnc" id="L10070" title="All 6 branches missed.">            if ((wtype instanceof TeleOperatedMissileBayWeapon)</span>
                    || (wtype instanceof CapitalMissileBayWeapon)
                    || (wtype instanceof AR10BayWeapon)) {
<span class="nc bnc" id="L10073" title="All 2 branches missed.">                if (mounted.isInBearingsOnlyMode()) {</span>
<span class="nc" id="L10074">                    return true;</span>
                }
            }
            //Surface to surface capital missiles count as artillery
<span class="nc bnc" id="L10078" title="All 4 branches missed.">            if  (this.getAltitude() == 0</span>
                    &amp;&amp; wtype instanceof CapitalMissileWeapon) {
<span class="nc" id="L10080">                return true;</span>
            }
<span class="nc" id="L10082">        }</span>
<span class="nc" id="L10083">        return false;</span>
    }

    public double getTroopCarryingSpace() {
<span class="nc" id="L10087">        double space = 0;</span>
<span class="nc bnc" id="L10088" title="All 2 branches missed.">        for (Transporter t : transports) {</span>
<span class="nc bnc" id="L10089" title="All 2 branches missed.">            if (t instanceof TroopSpace) {</span>
<span class="nc" id="L10090">                space += ((TroopSpace) t).totalSpace;</span>
            }
<span class="nc" id="L10092">        }</span>
<span class="nc" id="L10093">        return space;</span>
    }

    public double getPodMountedTroopCarryingSpace() {
<span class="nc" id="L10097">        double space = 0;</span>
<span class="nc bnc" id="L10098" title="All 2 branches missed.">        for (Transporter t : omniPodTransports) {</span>
<span class="nc bnc" id="L10099" title="All 2 branches missed.">            if (t instanceof TroopSpace) {</span>
<span class="nc" id="L10100">                space += ((TroopSpace) t).totalSpace;</span>
            }
<span class="nc" id="L10102">        }</span>
<span class="nc" id="L10103">        return space;</span>
    }

    public boolean hasBattleArmorHandles() {
<span class="nc bnc" id="L10107" title="All 2 branches missed.">        for (Transporter t : transports) {</span>
<span class="nc bnc" id="L10108" title="All 2 branches missed.">            if (t instanceof BattleArmorHandles) {</span>
<span class="nc" id="L10109">                return true;</span>
            }
<span class="nc" id="L10111">        }</span>
<span class="nc" id="L10112">        return false;</span>
    }

    /**
     * Returns true if this unit has a ClampMountMech or ClampMountTank that
     * is currently unloaded.
     * @return
     */
    public boolean hasUnloadedClampMount() {
<span class="nc bnc" id="L10121" title="All 2 branches missed.">        for (Transporter t : transports) {</span>
<span class="nc bnc" id="L10122" title="All 4 branches missed.">            if (((t instanceof ClampMountTank) || (t instanceof ClampMountMech))</span>
<span class="nc bnc" id="L10123" title="All 2 branches missed.">                    &amp;&amp; (t.getUnused() &gt; 0)) {</span>
<span class="nc" id="L10124">                return true;</span>
            }
<span class="nc" id="L10126">        }</span>
<span class="nc" id="L10127">        return false;</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see megamek.common.Targetable#isOffBoard()
     */
    @Override
    public boolean isOffBoard() {
<span class="nc bnc" id="L10137" title="All 2 branches missed.">        return offBoardDistance &gt; 0;</span>
    }

    /**
     * Set the unit as an offboard deployment. If a non-zero distance is chosen,
     * the direction must &lt;b&gt;not&lt;/b&gt; be &lt;code&gt;Entity.NONE&lt;/code&gt;. If a direction
     * other than &lt;code&gt;Entity.NONE&lt;/code&gt; is chosen, the distance must
     * &lt;b&gt;not&lt;/b&gt; be zero (0).
     *
     * @param distance  the &lt;code&gt;int&lt;/code&gt; distance in hexes that the unit will be
     *                  deployed from the board; this value must not be negative.
     * @param direction the &lt;code&gt;int&lt;/code&gt; direction from the board that the unit
     *                  will be deployed; a valid value must be selected from: NONE,
     *                  NORTH, SOUTH, EAST, or WEST.
     * @throws IllegalArgumentException if a negative distance, an invalid direction is selected, or
     *                                  the distance does not match the direction.
     */
    public void setOffBoard(int distance, OffBoardDirection direction) {
<span class="nc bnc" id="L10155" title="All 2 branches missed.">        if (distance &lt; 0) {</span>
<span class="nc" id="L10156">            throw new IllegalArgumentException(</span>
                    &quot;negative number given for distance offboard&quot;);
        }
<span class="nc bnc" id="L10159" title="All 4 branches missed.">        if ((0 == distance) &amp;&amp; (OffBoardDirection.NONE != direction)) {</span>
<span class="nc" id="L10160">            throw new IllegalArgumentException(</span>
                    &quot;onboard unit was given an offboard direction&quot;);
        }
<span class="nc bnc" id="L10163" title="All 4 branches missed.">        if ((0 != distance) &amp;&amp; (OffBoardDirection.NONE == direction)) {</span>
<span class="nc" id="L10164">            throw new IllegalArgumentException(</span>
                    &quot;offboard unit was not given an offboard direction&quot;);
        }
<span class="nc bnc" id="L10167" title="All 5 branches missed.">        switch (direction) {</span>
            case NORTH:
<span class="nc" id="L10169">                setFacing(3);</span>
<span class="nc" id="L10170">                break;</span>
            case SOUTH:
<span class="nc" id="L10172">                setFacing(0);</span>
<span class="nc" id="L10173">                break;</span>
            case WEST:
<span class="nc" id="L10175">                setFacing(2);</span>
<span class="nc" id="L10176">                break;</span>
            case EAST:
<span class="nc" id="L10178">                setFacing(4);</span>
<span class="nc" id="L10179">                break;</span>
            default:
                break;
        }
<span class="nc" id="L10183">        offBoardDistance = distance;</span>
<span class="nc" id="L10184">        offBoardDirection = direction;</span>
<span class="nc" id="L10185">    }</span>

    /**
     * Get the distance in hexes from the board that the unit will be deployed.
     * If the unit is to be deployed onboard, the distance will be zero (0).
     *
     * @return the &lt;code&gt;int&lt;/code&gt; distance from the board the unit will be
     * deployed (in hexes); this value will never be negative.
     */
    public int getOffBoardDistance() {
<span class="nc" id="L10195">        return offBoardDistance;</span>
    }

    /**
     * Get the direction the board that the unit will be deployed. If the unit
     * is to be deployed onboard, the distance will be
     * &lt;code&gt;IOffBoardDirections.NONE&lt;/code&gt;, otherwise it will be one of the
     * values:
     * &lt;ul&gt;
     * &lt;li&gt;&lt;code&gt;IOffBoardDirections.NORTH&lt;/code&gt;&lt;/li&gt;
     * &lt;li&gt;&lt;code&gt;IOffBoardDirections.SOUTH&lt;/code&gt;&lt;/li&gt;
     * &lt;li&gt;&lt;code&gt;IOffBoardDirections.EAST&lt;/code&gt;&lt;/li&gt;
     * &lt;li&gt;&lt;code&gt;IOffBoardDirections.WEST&lt;/code&gt;&lt;/li&gt;
     * &lt;/ul&gt;
     *
     * @return the &lt;code&gt;int&lt;/code&gt; direction from the board the unit will be
     * deployed. Only valid values will be returned.
     */
    public OffBoardDirection getOffBoardDirection() {
<span class="nc" id="L10214">        return offBoardDirection;</span>
    }

    /**
     * Deploy this offboard entity at the previously specified distance and
     * direction. This should only be invoked by the &lt;code&gt;Server&lt;/code&gt; after
     * the board has been selected and all the players are ready to start. The
     * side effects of this methods set the unit's position and facing as
     * appropriate (as well as deploying the unit).
     * &lt;p/&gt;
     * Onboard units (units with an offboard distance of zero and a direction of
     * &lt;code&gt;Entity.NONE&lt;/code&gt;) will be unaffected by this method.
     * @param round The current round number.
     */
    public void deployOffBoard(int round) {
<span class="nc bnc" id="L10229" title="All 2 branches missed.">        if (null == game) {</span>
<span class="nc" id="L10230">            throw new IllegalStateException(</span>
                    &quot;game not set; possible serialization error&quot;);
        }
        // N.B. 17 / 2 = 8, but the middle of 1..17 is 9, so we
        // add a bit (because 17 % 2 == 1 and 16 % 2 == 0).
<span class="nc bnc" id="L10235" title="All 6 branches missed.">        switch (offBoardDirection) {</span>
            case NONE:
<span class="nc" id="L10237">                return;</span>
            case NORTH:
<span class="nc" id="L10239">                setPosition(new Coords((game.getBoard().getWidth() / 2)</span>
<span class="nc" id="L10240">                        + (game.getBoard().getWidth() % 2),</span>
<span class="nc" id="L10241">                        -getOffBoardDistance()));</span>
<span class="nc" id="L10242">                setFacing(3);</span>
<span class="nc" id="L10243">                break;</span>
            case SOUTH:
<span class="nc" id="L10245">                setPosition(new Coords((game.getBoard().getWidth() / 2)</span>
<span class="nc" id="L10246">                        + (game.getBoard().getWidth() % 2), game.getBoard()</span>
<span class="nc" id="L10247">                        .getHeight() + getOffBoardDistance()));</span>
<span class="nc" id="L10248">                setFacing(0);</span>
<span class="nc" id="L10249">                break;</span>
            case EAST:
<span class="nc" id="L10251">                setPosition(new Coords(game.getBoard().getWidth()</span>
<span class="nc" id="L10252">                        + getOffBoardDistance(),</span>
<span class="nc" id="L10253">                        (game.getBoard().getHeight() / 2)</span>
<span class="nc" id="L10254">                                + (game.getBoard().getHeight() % 2)));</span>
<span class="nc" id="L10255">                setFacing(5);</span>
<span class="nc" id="L10256">                break;</span>
            case WEST:
<span class="nc" id="L10258">                setPosition(new Coords(-getOffBoardDistance(), (game.getBoard()</span>
<span class="nc" id="L10259">                        .getHeight() / 2) + (game.getBoard().getHeight() % 2)));</span>
<span class="nc" id="L10260">                setFacing(1);</span>
                break;
        }

        // deploy the unit, but only if it should be deployed this round
<span class="nc" id="L10265">        setDeployed(shouldOffBoardDeploy(round));</span>
<span class="nc" id="L10266">    }</span>

    public Vector&lt;Integer&gt; getPickedUpMechWarriors() {
<span class="nc" id="L10269">        return pickedUpMechWarriors;</span>
    }

    /**
     * Has this entity been captured?
     *
     * @return &lt;code&gt;true&lt;/code&gt; if it has.
     */
    public boolean isCaptured() {
<span class="nc bnc" id="L10278" title="All 4 branches missed.">        return captured &amp;&amp; !isDestroyed();</span>
    }

    /**
     * Specify that this entity has been captured.
     *
     * @param arg the &lt;code&gt;boolean&lt;/code&gt; value to assign.
     */
    public void setCaptured(boolean arg) {
<span class="nc" id="L10287">        captured = arg;</span>
<span class="nc" id="L10288">    }</span>

    public void setExternalSpotlight(boolean arg) {
<span class="nc" id="L10291">        hasExternalSpotlight = arg;</span>
<span class="nc" id="L10292">    }</span>

    /**
     * Returns state of hasExternalSpotlight, does not consider mounted
     * spotlights.
     *
     * @return
     */
    public boolean hasExternaSpotlight() {
<span class="nc" id="L10301">        return hasExternalSpotlight;</span>
    }

    /**
     * Returns true if the unit has a usable spotlight. It considers both
     * externally mounted spotlights as well as internally mounted ones.
     *
     * @return
     */
    public boolean hasSpotlight() {
<span class="nc bnc" id="L10311" title="All 2 branches missed.">        for (Mounted m : getMisc()) {</span>
<span class="nc bnc" id="L10312" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_SEARCHLIGHT)</span>
<span class="nc bnc" id="L10313" title="All 2 branches missed.">                &amp;&amp; !m.isInoperable()) {</span>
<span class="nc" id="L10314">                return true;</span>
            }
<span class="nc" id="L10316">        }</span>
<span class="nc" id="L10317">        return hasExternalSpotlight;</span>
    }

    /**
     * Method to destroy a single spotlight on an entity. Spotlights can be
     * destroyed on a roll of 7+ on a torso hit on a mek or on a front/side hit
     * on a combat vehicle.
     */
    public void destroyOneSpotlight() {
<span class="nc bnc" id="L10326" title="All 2 branches missed.">        if (!hasSpotlight()) {</span>
<span class="nc" id="L10327">            return;</span>
        }
        // A random spotlight should be destroyed, but this is easier...
<span class="nc bnc" id="L10330" title="All 2 branches missed.">        if (hasExternalSpotlight) {</span>
<span class="nc" id="L10331">            hasExternalSpotlight = false;</span>
        }

<span class="nc bnc" id="L10334" title="All 2 branches missed.">        for (Mounted m : getMisc()) {</span>
<span class="nc bnc" id="L10335" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_SEARCHLIGHT)</span>
<span class="nc bnc" id="L10336" title="All 2 branches missed.">                &amp;&amp; !m.isInoperable()) {</span>
<span class="nc" id="L10337">                m.setDestroyed(true);</span>
<span class="nc" id="L10338">                break;</span>
            }
<span class="nc" id="L10340">        }</span>

        // Turn off the light all spot lights were destroyed
<span class="nc bnc" id="L10343" title="All 2 branches missed.">        if (!hasSpotlight()) {</span>
<span class="nc" id="L10344">            setSpotlightState(false);</span>
        }

<span class="nc" id="L10347">    }</span>

    public void setSpotlightState(boolean arg) {
<span class="nc bnc" id="L10350" title="All 2 branches missed.">        if (hasSpotlight()) {</span>
<span class="nc" id="L10351">            spotlightIsActive = arg;</span>
<span class="nc bnc" id="L10352" title="All 2 branches missed.">            if (arg) {</span>
<span class="nc" id="L10353">                illuminated = true;</span>
            }
        } else {
<span class="nc" id="L10356">            spotlightIsActive = false;</span>
        }
<span class="nc" id="L10358">    }</span>

    public boolean isIlluminated() {
        // Regardless of illuminated state, if we have a spotlight active we
        //  are illuminated
<span class="nc bnc" id="L10363" title="All 4 branches missed.">        return illuminated || spotlightIsActive;</span>
    }

    public void setIlluminated(boolean arg) {
<span class="nc bnc" id="L10367" title="All 4 branches missed.">        illuminated = spotlightIsActive || arg;</span>
<span class="nc" id="L10368">    }</span>

    public boolean isUsingSpotlight() {
<span class="nc bnc" id="L10371" title="All 4 branches missed.">        return hasSpotlight() &amp;&amp; spotlightIsActive;</span>
    }

    public void setUsedSearchlight(boolean arg) {
<span class="nc" id="L10375">        usedSearchlight = arg;</span>
<span class="nc" id="L10376">    }</span>

    public boolean usedSearchlight() {
<span class="nc" id="L10379">        return usedSearchlight;</span>
    }

    /**
     * Is the Entity stuck in a swamp?
     */
    public boolean isStuck() {
<span class="nc" id="L10386">        return stuckInSwamp;</span>
    }

    /**
     * Set weather this Entity is stuck in a swamp or not
     *
     * @param arg the &lt;code&gt;boolean&lt;/code&gt; value to assign
     */
    public void setStuck(boolean arg) {
<span class="nc" id="L10395">        stuckInSwamp = arg;</span>
<span class="nc" id="L10396">    }</span>

    /**
     * Is the Entity stuck in a swamp?
     */
    public boolean canUnstickByJumping() {
<span class="nc" id="L10402">        return canUnstickByJumping;</span>
    }

    /**
     * Set wether this Enity is stuck in a swamp or not
     *
     * @param arg the &lt;code&gt;boolean&lt;/code&gt; value to assign
     */
    public void setCanUnstickByJumping(boolean arg) {
<span class="nc" id="L10411">        canUnstickByJumping = arg;</span>
<span class="nc" id="L10412">    }</span>

    /*
     * The following methods support the eventual refactoring into the Entity
     * class of a lot of the Server logic surrounding entity damage and death.
     * They are not currently called in Server anywhere, and so may as well not
     * exist.
     */

    public String destroy(String reason, boolean survivable, boolean canSalvage) {
<span class="nc" id="L10422">        StringBuffer sb = new StringBuffer();</span>

<span class="nc" id="L10424">        int condition = IEntityRemovalConditions.REMOVE_SALVAGEABLE;</span>
<span class="nc bnc" id="L10425" title="All 2 branches missed.">        if (!canSalvage) {</span>
<span class="nc" id="L10426">            setSalvage(canSalvage);</span>
<span class="nc" id="L10427">            condition = IEntityRemovalConditions.REMOVE_DEVASTATED;</span>
        }

<span class="nc bnc" id="L10430" title="All 4 branches missed.">        if (isDoomed() || isDestroyed()) {</span>
<span class="nc" id="L10431">            return sb.toString();</span>
        }

        // working under the assumption that entity was neither doomed or
        // destroyed before from here on out

<span class="nc" id="L10437">        setDoomed(true);</span>

<span class="nc" id="L10439">        Enumeration&lt;Integer&gt; iter = getPickedUpMechWarriors().elements();</span>
<span class="nc bnc" id="L10440" title="All 2 branches missed.">        while (iter.hasMoreElements()) {</span>
<span class="nc" id="L10441">            Integer mechWarriorId = iter.nextElement();</span>
<span class="nc" id="L10442">            Entity mw = game.getEntity(mechWarriorId.intValue());</span>
<span class="nc" id="L10443">            mw.setDestroyed(true);</span>
<span class="nc" id="L10444">            game.removeEntity(mw.getId(), condition);</span>
<span class="nc" id="L10445">            sb.append(&quot;\n*** &quot;).append(</span>
<span class="nc" id="L10446">                    mw.getDisplayName() + &quot; died in the wreckage. ***\n&quot;);</span>
<span class="nc" id="L10447">        }</span>
<span class="nc" id="L10448">        return sb.toString();</span>
    }

    /**
     * Add a targeting by a swarm volley from a specified entity
     *
     * @param entityId The &lt;code&gt;int&lt;/code&gt; id of the shooting entity
     * @param weaponId The &lt;code&gt;int&lt;/code&gt; id of the shooting lrm launcher
     */
    public void addTargetedBySwarm(int entityId, int weaponId) {
<span class="nc" id="L10458">        hitBySwarmsEntity.addElement(entityId);</span>
<span class="nc" id="L10459">        hitBySwarmsWeapon.addElement(weaponId);</span>
<span class="nc" id="L10460">    }</span>

    /**
     * Were we targeted by a certain swarm/swarm-i volley this turn?
     *
     * @param entityId The &lt;code&gt;int&lt;/code&gt; id of the shooting entity we are checking
     * @param weaponId The &lt;code&gt;int&lt;/code&gt; id of the launcher to check
     * @return a fitting &lt;code&gt;boolean&lt;/code&gt; value
     */
    public boolean getTargetedBySwarm(int entityId, int weaponId) {
<span class="nc bnc" id="L10470" title="All 2 branches missed.">        for (int i = 0; i &lt; hitBySwarmsEntity.size(); i++) {</span>
<span class="nc" id="L10471">            Integer entityIdToTest = hitBySwarmsEntity.elementAt(i);</span>
<span class="nc" id="L10472">            Integer weaponIdToTest = hitBySwarmsWeapon.elementAt(i);</span>
<span class="nc bnc" id="L10473" title="All 2 branches missed.">            if ((entityId == entityIdToTest.intValue())</span>
<span class="nc bnc" id="L10474" title="All 2 branches missed.">                &amp;&amp; (weaponId == weaponIdToTest.intValue())) {</span>
<span class="nc" id="L10475">                return true;</span>
            }
        }
<span class="nc" id="L10478">        return false;</span>
    }

    public int getShortRangeModifier() {
<span class="nc" id="L10482">        int mod = 0;</span>
<span class="nc bnc" id="L10483" title="All 2 branches missed.">        if (hasAbility(OptionsConstants.GUNNERY_RANGE_MASTER, Crew.RANGEMASTER_MEDIUM)) {</span>
<span class="nc" id="L10484">            mod = 2;</span>
        }
<span class="nc bnc" id="L10486" title="All 2 branches missed.">        if (hasAbility(OptionsConstants.GUNNERY_RANGE_MASTER, Crew.RANGEMASTER_LONG)) {</span>
<span class="nc" id="L10487">            mod = 4;</span>
        }
<span class="nc bnc" id="L10489" title="All 2 branches missed.">        if (hasAbility(OptionsConstants.GUNNERY_RANGE_MASTER, Crew.RANGEMASTER_EXTREME)) {</span>
<span class="nc" id="L10490">            mod = 6;</span>
        }
<span class="nc bnc" id="L10492" title="All 4 branches missed.">        if (hasAbility(OptionsConstants.GUNNERY_SNIPER) &amp;&amp; (mod &gt; 0)) {</span>
<span class="nc" id="L10493">            mod = mod / 2;</span>
        }
<span class="nc bnc" id="L10495" title="All 2 branches missed.">        if (hasQuirk(OptionsConstants.QUIRK_POS_IMP_TARG_S)) {</span>
<span class="nc" id="L10496">            mod--;</span>
        }
<span class="nc bnc" id="L10498" title="All 2 branches missed.">        if (hasQuirk(OptionsConstants.QUIRK_NEG_POOR_TARG_S)) {</span>
<span class="nc" id="L10499">            mod++;</span>
        }
<span class="nc bnc" id="L10501" title="All 2 branches missed.">        if (hasQuirk(OptionsConstants.QUIRK_POS_VAR_RNG_TARG_L)) {</span>
<span class="nc" id="L10502">            mod++;</span>
        }
<span class="nc bnc" id="L10504" title="All 2 branches missed.">        if (hasQuirk(OptionsConstants.QUIRK_POS_VAR_RNG_TARG_S)) {</span>
<span class="nc" id="L10505">            mod--;</span>
        }
<span class="nc" id="L10507">        return mod;</span>
    }

    public int getMediumRangeModifier() {
<span class="nc" id="L10511">        int mod = 2;</span>
<span class="nc bnc" id="L10512" title="All 2 branches missed.">        if (hasAbility(OptionsConstants.GUNNERY_RANGE_MASTER, Crew.RANGEMASTER_MEDIUM)) {</span>
<span class="nc" id="L10513">            mod = 0;</span>
        }
<span class="nc bnc" id="L10515" title="All 4 branches missed.">        if (hasAbility(OptionsConstants.GUNNERY_SNIPER) &amp;&amp; (mod &gt; 0)) {</span>
<span class="nc" id="L10516">            mod = mod / 2;</span>
        }
<span class="nc bnc" id="L10518" title="All 2 branches missed.">        if (hasQuirk(OptionsConstants.QUIRK_POS_IMP_TARG_M)) {</span>
<span class="nc" id="L10519">            mod--;</span>
        }
<span class="nc bnc" id="L10521" title="All 2 branches missed.">        if (hasQuirk(OptionsConstants.QUIRK_NEG_POOR_TARG_M)) {</span>
<span class="nc" id="L10522">            mod++;</span>
        }
<span class="nc" id="L10524">        return mod;</span>
    }

    public int getLongRangeModifier() {
<span class="nc" id="L10528">        int mod = 4;</span>
<span class="nc bnc" id="L10529" title="All 2 branches missed.">        if (hasAbility(OptionsConstants.GUNNERY_RANGE_MASTER, Crew.RANGEMASTER_LONG)) {</span>
<span class="nc" id="L10530">            mod = 0;</span>
        }
<span class="nc bnc" id="L10532" title="All 4 branches missed.">        if (hasAbility(OptionsConstants.GUNNERY_SNIPER) &amp;&amp; (mod &gt; 0)) {</span>
<span class="nc" id="L10533">            mod = mod / 2;</span>
        }
<span class="nc bnc" id="L10535" title="All 2 branches missed.">        if (hasQuirk(OptionsConstants.QUIRK_POS_IMP_TARG_L)) {</span>
<span class="nc" id="L10536">            mod--;</span>
        }
<span class="nc bnc" id="L10538" title="All 2 branches missed.">        if (hasQuirk(OptionsConstants.QUIRK_NEG_POOR_TARG_L)) {</span>
<span class="nc" id="L10539">            mod++;</span>
        }
<span class="nc bnc" id="L10541" title="All 2 branches missed.">        if (hasQuirk(OptionsConstants.QUIRK_POS_VAR_RNG_TARG_L)) {</span>
<span class="nc" id="L10542">            mod--;</span>
        }
<span class="nc bnc" id="L10544" title="All 2 branches missed.">        if (hasQuirk(OptionsConstants.QUIRK_POS_VAR_RNG_TARG_S)) {</span>
<span class="nc" id="L10545">            mod++;</span>
        }
<span class="nc" id="L10547">        return mod;</span>
    }

    public int getExtremeRangeModifier() {
<span class="nc" id="L10551">        int mod = 6;</span>
<span class="nc bnc" id="L10552" title="All 2 branches missed.">        if (hasAbility(OptionsConstants.GUNNERY_RANGE_MASTER, Crew.RANGEMASTER_EXTREME)) {</span>
<span class="nc" id="L10553">            mod = 0;</span>
        }
<span class="nc bnc" id="L10555" title="All 4 branches missed.">        if (hasAbility(OptionsConstants.GUNNERY_SNIPER) &amp;&amp; (mod &gt; 0)) {</span>
<span class="nc" id="L10556">            mod = mod / 2;</span>
        }
<span class="nc" id="L10558">        return mod;</span>
    }

    public int getLOSRangeModifier() {
<span class="nc" id="L10562">        int mod = 8;</span>

<span class="nc" id="L10564">        return mod;</span>
    }

    public void setArmorType(int armType) {
<span class="nc bnc" id="L10568" title="All 2 branches missed.">        for (int i = 0; i &lt; locations(); i++) {</span>
<span class="nc" id="L10569">            armorType[i] = armType;</span>
        }
<span class="nc" id="L10571">    }</span>

    public void setArmorType(int armType, int loc) {
<span class="nc" id="L10574">        armorType[loc] = armType;</span>
<span class="nc" id="L10575">        recalculateTechAdvancement();</span>
<span class="nc" id="L10576">    }</span>

    public void setStructureType(int strucType) {
<span class="nc" id="L10579">        structureType = strucType;</span>
<span class="nc" id="L10580">        structureTechLevel = getTechLevel();</span>
<span class="nc" id="L10581">        recalculateTechAdvancement();</span>
<span class="nc" id="L10582">    }</span>

    public void setStructureTechLevel(int level) {
<span class="nc" id="L10585">        structureTechLevel = level;</span>
<span class="nc" id="L10586">        recalculateTechAdvancement();</span>
<span class="nc" id="L10587">    }</span>

    public void setArmorType(String armType) {
<span class="nc bnc" id="L10590" title="All 4 branches missed.">        if (!(armType.startsWith(&quot;Clan &quot;) || armType.startsWith(&quot;IS &quot;))) {</span>
<span class="nc bnc" id="L10591" title="All 2 branches missed.">            armType = TechConstants.isClan(getArmorTechLevel(0)) ? &quot;Clan &quot;</span>
<span class="nc" id="L10592">                                                                   + armType : &quot;IS &quot; + armType;</span>
        }
<span class="nc" id="L10594">        EquipmentType et = EquipmentType.get(armType);</span>
<span class="nc bnc" id="L10595" title="All 2 branches missed.">        if (et == null) {</span>
<span class="nc" id="L10596">            setArmorType(EquipmentType.T_ARMOR_UNKNOWN);</span>
        } else {
<span class="nc" id="L10598">            setArmorType(EquipmentType.getArmorType(et));</span>
            // TODO: Is this needed? WTF is the point of it?
<span class="nc bnc" id="L10600" title="All 2 branches missed.">            if (et.getCriticals(this) == 0) {</span>
                try {
<span class="nc" id="L10602">                    this.addEquipment(et, LOC_NONE);</span>
<span class="nc" id="L10603">                } catch (LocationFullException e) {</span>
                    // can't happen
<span class="nc" id="L10605">                    e.printStackTrace();</span>
<span class="nc" id="L10606">                }</span>
            }
        }
<span class="nc" id="L10609">        recalculateTechAdvancement();</span>
<span class="nc" id="L10610">    }</span>

    public void setArmorType(String armType, int loc) {
<span class="nc bnc" id="L10613" title="All 4 branches missed.">        if (!(armType.startsWith(&quot;Clan &quot;) || armType.startsWith(&quot;IS &quot;))) {</span>
<span class="nc bnc" id="L10614" title="All 2 branches missed.">            armType = TechConstants.isClan(getArmorTechLevel(0)) ? &quot;Clan &quot;</span>
<span class="nc" id="L10615">                                                                   + armType : &quot;IS &quot; + armType;</span>
        }
<span class="nc" id="L10617">        EquipmentType et = EquipmentType.get(armType);</span>
<span class="nc bnc" id="L10618" title="All 2 branches missed.">        if (et == null) {</span>
<span class="nc" id="L10619">            setArmorType(EquipmentType.T_ARMOR_UNKNOWN, loc);</span>
        } else {
<span class="nc" id="L10621">            setArmorType(EquipmentType.getArmorType(et), loc);</span>
            // TODO: Is this needed? WTF is the point of it?
<span class="nc bnc" id="L10623" title="All 2 branches missed.">            if (et.getCriticals(this) == 0) {</span>
                try {
<span class="nc" id="L10625">                    this.addEquipment(et, LOC_NONE);</span>
<span class="nc" id="L10626">                } catch (LocationFullException e) {</span>
                    // can't happen
<span class="nc" id="L10628">                    e.printStackTrace();</span>
<span class="nc" id="L10629">                }</span>
            }
        }
<span class="nc" id="L10632">        recalculateTechAdvancement();</span>
<span class="nc" id="L10633">    }</span>

    public void setStructureType(String strucType) {
<span class="nc bnc" id="L10636" title="All 4 branches missed.">        if (!(strucType.startsWith(&quot;Clan &quot;) || strucType.startsWith(&quot;IS &quot;))) {</span>
<span class="nc bnc" id="L10637" title="All 2 branches missed.">            strucType = isClan() ? &quot;Clan &quot; + strucType : &quot;IS &quot; + strucType;</span>
        }
<span class="nc" id="L10639">        EquipmentType et = EquipmentType.get(strucType);</span>
<span class="nc" id="L10640">        setStructureType(EquipmentType.getStructureType(et));</span>
<span class="nc bnc" id="L10641" title="All 2 branches missed.">        if (et == null) {</span>
<span class="nc" id="L10642">            structureTechLevel = TechConstants.T_TECH_UNKNOWN;</span>
        } else {
<span class="nc" id="L10644">            structureTechLevel = et.getTechLevel(year);</span>
            // TODO: Is this needed? WTF is the point of it?
<span class="nc bnc" id="L10646" title="All 2 branches missed.">            if (et.getCriticals(this) == 0) {</span>
                try {
<span class="nc" id="L10648">                    this.addEquipment(et, LOC_NONE);</span>
<span class="nc" id="L10649">                } catch (LocationFullException e) {</span>
                    // can't happen
<span class="nc" id="L10651">                    e.printStackTrace();</span>
<span class="nc" id="L10652">                }</span>
            }
        }
<span class="nc" id="L10655">        recalculateTechAdvancement();</span>
<span class="nc" id="L10656">    }</span>

    public int getArmorType(int loc) {
<span class="nc bnc" id="L10659" title="All 4 branches missed.">        if ((loc &gt;= 0 ) &amp;&amp; (loc &lt; armorType.length)) {</span>
<span class="nc" id="L10660">            return armorType[loc];</span>
        } else {
<span class="nc" id="L10662">            return EquipmentType.T_ARMOR_UNKNOWN;</span>
        }
    }

    public void setArmorTechLevel(int newTL) {
<span class="nc bnc" id="L10667" title="All 2 branches missed.">        for (int i = 0; i &lt; locations(); i++) {</span>
<span class="nc" id="L10668">            armorTechLevel[i] = newTL;</span>
        }
<span class="nc" id="L10670">        recalculateTechAdvancement();</span>
<span class="nc" id="L10671">    }</span>

    public void setArmorTechLevel(int newTL, int loc) {
<span class="nc" id="L10674">        armorTechLevel[loc] = newTL;</span>
<span class="nc" id="L10675">        recalculateTechAdvancement();</span>
<span class="nc" id="L10676">    }</span>

    public int getArmorTechLevel(int loc) {
<span class="nc" id="L10679">        return armorTechLevel[loc];</span>
    }

    public int getStructureType() {
<span class="nc" id="L10683">        return structureType;</span>
    }

    public int getStructureTechLevel() {
<span class="nc" id="L10687">        return structureTechLevel;</span>
    }

    public void setWeaponHit(Mounted which) {
<span class="nc bnc" id="L10691" title="All 2 branches missed.">        if (weaponList.contains(which)) {</span>
<span class="nc" id="L10692">            which.setHit(true);</span>
        }
<span class="nc" id="L10694">    }</span>

    public void setTaggedBy(int tagger) {
<span class="nc" id="L10697">        taggedBy = tagger;</span>
<span class="nc" id="L10698">    }</span>

    public int getTaggedBy() {
<span class="nc" id="L10701">        return taggedBy;</span>
    }

    public abstract double getCost(boolean ignoreAmmo);

    /**
     * Returns a multiplier that combines multiplicative construction cost modifiers for this Entity.
     *
     * This includes only modifiers that apply to an Entity's final, total cost (e.g. - the 1.25x modifier for being
     * an omni-unit, or the 32.0x for being an aerodyne dropship). It does NOT include multipliers that only apply to
     * a sub-part of the unit (e.g. the weight based multiplier that applies to a vehicle's internal structure cost).
     *
     * This allows MekHQ to scale the price of a Unit's Parts in a more appropriate manner.
     *
     * Defaults to 1.0
     */
    public double getPriceMultiplier() {
<span class="nc" id="L10718">        return 1.0;</span>
    };

    public long getWeaponsAndEquipmentCost(boolean ignoreAmmo) {
        // bvText = new StringBuffer();
<span class="nc" id="L10723">        long cost = 0;</span>

<span class="nc" id="L10725">        NumberFormat commafy = NumberFormat.getInstance();</span>

<span class="nc bnc" id="L10727" title="All 2 branches missed.">        for (Mounted mounted : getEquipment()) {</span>
<span class="nc bnc" id="L10728" title="All 2 branches missed.">            if (ignoreAmmo</span>
<span class="nc bnc" id="L10729" title="All 2 branches missed.">                &amp;&amp; (mounted.getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L10730" title="All 2 branches missed.">                &amp;&amp; (!(((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_COOLANT_POD))) {</span>
<span class="nc" id="L10731">                continue;</span>
            }
<span class="nc bnc" id="L10733" title="All 2 branches missed.">            if (mounted.isWeaponGroup()) {</span>
<span class="nc" id="L10734">                continue;</span>
            }
<span class="nc" id="L10736">            long itemCost = (long) mounted.getCost();</span>
<span class="nc bnc" id="L10737" title="All 6 branches missed.">            if (!ignoreAmmo &amp;&amp; isSupportVehicle() &amp;&amp; (mounted.getSize() &gt; 1)</span>
<span class="nc bnc" id="L10738" title="All 2 branches missed.">                    &amp;&amp; (mounted.getType() instanceof InfantryWeapon)) {</span>
<span class="nc" id="L10739">                itemCost += (mounted.getSize() - 1)</span>
<span class="nc" id="L10740">                        * ((InfantryWeapon) mounted.getType()).getAmmoCost();</span>
            }

<span class="nc" id="L10743">            cost += itemCost;</span>
<span class="nc bnc" id="L10744" title="All 4 branches missed.">            if ((bvText != null) &amp;&amp; (itemCost &gt; 0)) {</span>
<span class="nc" id="L10745">                bvText.append(startRow);</span>
<span class="nc" id="L10746">                bvText.append(startColumn);</span>
<span class="nc" id="L10747">                bvText.append(mounted.getName());</span>
<span class="nc" id="L10748">                bvText.append(endColumn);</span>

<span class="nc" id="L10750">                bvText.append(startColumn);</span>
<span class="nc" id="L10751">                bvText.append(commafy.format(itemCost));</span>
<span class="nc" id="L10752">                bvText.append(endColumn);</span>
<span class="nc" id="L10753">                bvText.append(endRow);</span>
            }
<span class="nc" id="L10755">        }</span>
<span class="nc" id="L10756">        int count = implicitClanCASE();</span>
<span class="nc bnc" id="L10757" title="All 2 branches missed.">        if (count &gt; 0) {</span>
<span class="nc" id="L10758">            long itemCost = 50000;</span>
<span class="nc" id="L10759">            cost += count * itemCost;</span>
<span class="nc bnc" id="L10760" title="All 2 branches missed.">            if (null != bvText) {</span>
<span class="nc bnc" id="L10761" title="All 2 branches missed.">                for (int i = 0; i &lt; count; i++) {</span>
<span class="nc" id="L10762">                    bvText.append(startColumn);</span>
<span class="nc" id="L10763">                    bvText.append(&quot;CASE&quot;);</span>
<span class="nc" id="L10764">                    bvText.append(endColumn);</span>
<span class="nc" id="L10765">                    bvText.append(startColumn);</span>
<span class="nc" id="L10766">                    bvText.append(commafy.format(itemCost));</span>
<span class="nc" id="L10767">                    bvText.append(endColumn);</span>
<span class="nc" id="L10768">                    bvText.append(endRow);</span>
                }
            }
        }
        // Large craft have a separate section for bays
<span class="nc bnc" id="L10773" title="All 2 branches missed.">        if (!isLargeCraft()) {</span>
<span class="nc" id="L10774">            long seatCost = 0;</span>
<span class="nc" id="L10775">            long quartersCost = 0;</span>
<span class="nc" id="L10776">            long bayCost = 0;</span>
<span class="nc bnc" id="L10777" title="All 2 branches missed.">            for (Bay bay : getTransportBays()) {</span>
<span class="nc bnc" id="L10778" title="All 2 branches missed.">                if (bay instanceof StandardSeatCargoBay) {</span>
<span class="nc" id="L10779">                    seatCost += bay.getCost();</span>
<span class="nc bnc" id="L10780" title="All 2 branches missed.">                } else if (bay.isQuarters()) {</span>
<span class="nc" id="L10781">                    quartersCost += bay.getCost();</span>
                } else {
<span class="nc" id="L10783">                    bayCost += bay.getCost() + 1000L * bay.getDoors();</span>
                }
<span class="nc" id="L10785">            }</span>
<span class="nc bnc" id="L10786" title="All 4 branches missed.">            if (null != bvText &amp;&amp; seatCost &gt; 0) {</span>
<span class="nc" id="L10787">                bvText.append(startColumn);</span>
<span class="nc" id="L10788">                bvText.append(&quot;Seating&quot;);</span>
<span class="nc" id="L10789">                bvText.append(endColumn);</span>
<span class="nc" id="L10790">                bvText.append(startColumn);</span>
<span class="nc" id="L10791">                bvText.append(commafy.format(seatCost));</span>
<span class="nc" id="L10792">                bvText.append(endColumn);</span>
<span class="nc" id="L10793">                bvText.append(endRow);</span>
<span class="nc" id="L10794">                cost += seatCost;</span>
            }
<span class="nc bnc" id="L10796" title="All 4 branches missed.">            if (null != bvText &amp;&amp; quartersCost &gt; 0) {</span>
<span class="nc" id="L10797">                bvText.append(startColumn);</span>
<span class="nc" id="L10798">                bvText.append(&quot;Quarters&quot;);</span>
<span class="nc" id="L10799">                bvText.append(endColumn);</span>
<span class="nc" id="L10800">                bvText.append(startColumn);</span>
<span class="nc" id="L10801">                bvText.append(commafy.format(quartersCost));</span>
<span class="nc" id="L10802">                bvText.append(endColumn);</span>
<span class="nc" id="L10803">                bvText.append(endRow);</span>
<span class="nc" id="L10804">                cost += quartersCost;</span>
            }
<span class="nc bnc" id="L10806" title="All 4 branches missed.">            if (null != bvText &amp;&amp; bayCost &gt; 0) {</span>
<span class="nc" id="L10807">                bvText.append(startColumn);</span>
<span class="nc" id="L10808">                bvText.append(&quot;Bays&quot;);</span>
<span class="nc" id="L10809">                bvText.append(endColumn);</span>
<span class="nc" id="L10810">                bvText.append(startColumn);</span>
<span class="nc" id="L10811">                bvText.append(commafy.format(bayCost));</span>
<span class="nc" id="L10812">                bvText.append(endColumn);</span>
<span class="nc" id="L10813">                bvText.append(endRow);</span>
<span class="nc" id="L10814">                cost += bayCost;</span>
            }
        }
<span class="nc" id="L10817">        return cost;</span>
    }

    /**
     * Used to for cost calculations. Though the TM rules allow a Clan unit to be designed without CASE,
     * MM assumes that CASE is present in any location that has explosive equipment.
     *
     * @return The number of locations protected by Clan CASE beyond what is explicitly mounted.
     */
    protected int implicitClanCASE() {
<span class="nc" id="L10827">        return 0;</span>
    }

    public boolean removePartialCoverHits(int location, int cover, int side) {
<span class="nc bnc" id="L10831" title="All 2 branches missed.">        if (cover &gt; LosEffects.COVER_NONE) {</span>
<span class="nc bnc" id="L10832" title="All 10 branches missed.">            switch (cover) {</span>
                case LosEffects.COVER_LOWLEFT:
<span class="nc bnc" id="L10834" title="All 2 branches missed.">                    if (location == Mech.LOC_LLEG) {</span>
<span class="nc" id="L10835">                        return true;</span>
                    }
                    break;
                case LosEffects.COVER_LOWRIGHT:
<span class="nc bnc" id="L10839" title="All 2 branches missed.">                    if (location == Mech.LOC_RLEG) {</span>
<span class="nc" id="L10840">                        return true;</span>
                    }
                    break;
                case LosEffects.COVER_LEFT:
<span class="nc bnc" id="L10844" title="All 6 branches missed.">                    if ((location == Mech.LOC_LLEG)</span>
                        || (location == Mech.LOC_LARM)
                        || (location == Mech.LOC_LT)) {
<span class="nc" id="L10847">                        return true;</span>
                    }
                    break;
                case LosEffects.COVER_RIGHT:
<span class="nc bnc" id="L10851" title="All 6 branches missed.">                    if ((location == Mech.LOC_RLEG)</span>
                        || (location == Mech.LOC_RARM)
                        || (location == Mech.LOC_RT)) {
<span class="nc" id="L10854">                        return true;</span>
                    }
                    break;
                case LosEffects.COVER_HORIZONTAL:
<span class="nc bnc" id="L10858" title="All 4 branches missed.">                    if ((location == Mech.LOC_LLEG)</span>
                        || (location == Mech.LOC_RLEG)) {
<span class="nc" id="L10860">                        return true;</span>
                    }
                    break;
                case LosEffects.COVER_UPPER:
<span class="nc bnc" id="L10864" title="All 4 branches missed.">                    if ((location == Mech.LOC_LLEG)</span>
                        || (location == Mech.LOC_RLEG)) {
<span class="nc" id="L10866">                        return false;</span>
                    }
<span class="nc" id="L10868">                    return true;</span>
                case LosEffects.COVER_FULL:
<span class="nc" id="L10870">                    return true;</span>
                case LosEffects.COVER_75LEFT:
<span class="nc bnc" id="L10872" title="All 4 branches missed.">                    if ((location == Mech.LOC_RARM)</span>
                        || (location == Mech.LOC_RLEG)) {
<span class="nc" id="L10874">                        return false;</span>
                    }
<span class="nc" id="L10876">                    return true;</span>
                case LosEffects.COVER_75RIGHT:
<span class="nc bnc" id="L10878" title="All 4 branches missed.">                    if ((location == Mech.LOC_LLEG)</span>
                        || (location == Mech.LOC_LARM)) {
<span class="nc" id="L10880">                        return false;</span>
                    }
<span class="nc" id="L10882">                    return true;</span>
            }
        }
<span class="nc" id="L10885">        return false;</span>

    }

    public abstract boolean doomedInExtremeTemp();

    public abstract boolean doomedInVacuum();

    public abstract boolean doomedOnGround();

    public abstract boolean doomedInAtmosphere();

    public abstract boolean doomedInSpace();

    /**
     * Prior to TacOps errata 3.3, armor was rounded up to the nearest half ton
     * As of TacOps errata 3.3, patchwork armor is not rounded by location. Previous editions
     * of the rules required it to be rounded up to the nearest half ton by location.
     * Note:
     * Unless overridden, this should &lt;em&gt;only&lt;/em&gt; be called on units with
     * patchwork armor, as rounding behavior is not guaranteed to be correct or
     * even the same for others and units with a single overall armor type have
     * no real reason to specifically care about weight per location anyway.
     *
     * @param loc The code value for the location in question (unit
     *            type-specific).
     * @return The weight of the armor in the location in tons.
     */
    public double getArmorWeight(int loc) {
<span class="nc" id="L10914">        double armorPerTon = 16.0 * EquipmentType.getArmorPointMultiplier(</span>
                armorType[loc], armorTechLevel[loc]);
<span class="nc" id="L10916">        double points = getOArmor(loc)</span>
<span class="nc bnc" id="L10917" title="All 2 branches missed.">                        + (hasRearArmor(loc) ? getOArmor(loc, true) : 0);</span>
<span class="nc" id="L10918">        return points / armorPerTon;</span>
    }

    /**
     * The total weight of the armor on this unit. This is guaranteed to be
     * rounded properly for both single-type and patchwork armor.
     *
     * @return The armor weight in tons.
     */
    public double getArmorWeight() {
<span class="nc bnc" id="L10928" title="All 2 branches missed.">        if (hasPatchworkArmor()) {</span>
<span class="nc" id="L10929">            double total = 0;</span>
<span class="nc bnc" id="L10930" title="All 2 branches missed.">            for (int loc = 0; loc &lt; locations(); loc++) {</span>
<span class="nc" id="L10931">                total += getArmorWeight(loc);</span>
            }
<span class="nc" id="L10933">            return RoundWeight.standard(total, this);</span>
<span class="nc bnc" id="L10934" title="All 2 branches missed.">        } else if (isSupportVehicle()</span>
<span class="nc bnc" id="L10935" title="All 2 branches missed.">                    &amp;&amp; getArmorType(firstArmorIndex()) == EquipmentType.T_ARMOR_STANDARD) {</span>
<span class="nc" id="L10936">            double total = getTotalOArmor()</span>
<span class="nc" id="L10937">                    * EquipmentType.getSupportVehicleArmorWeightPerPoint(getBARRating(firstArmorIndex()), getArmorTechRating());</span>
<span class="nc" id="L10938">            return RoundWeight.standard(total, this);</span>
        } else {
            // this roundabout method is actually necessary to avoid rounding
            // weirdness. Yeah, it's dumb.
<span class="nc" id="L10942">            double armorPerTon = 16.0 * EquipmentType.getArmorPointMultiplier(</span>
                    armorType[0], armorTechLevel[0]);
<span class="nc" id="L10944">            return RoundWeight.standard(getTotalOArmor() / armorPerTon, this);</span>
        }
    }

    public boolean hasTAG() {
<span class="nc bnc" id="L10949" title="All 2 branches missed.">        for (Mounted m : getWeaponList()) {</span>
<span class="nc" id="L10950">            WeaponType equip = (WeaponType) (m.getType());</span>
<span class="nc bnc" id="L10951" title="All 4 branches missed.">            if ((equip != null) &amp;&amp; (equip.hasFlag(WeaponType.F_TAG))) {</span>
<span class="nc" id="L10952">                return true;</span>
            }
<span class="nc" id="L10954">        }</span>
<span class="nc" id="L10955">        return false;</span>
    }

    public boolean isCanon() {
<span class="nc" id="L10959">        return canon;</span>
    }

    public void setCanon(boolean canon) {
<span class="nc" id="L10963">        this.canon = canon;</span>
<span class="nc" id="L10964">    }</span>

    /**
     * Get the entity's &quot;climbing mode&quot;
     * @return True or false, where true = climb up and false = go through
     */
    public boolean climbMode() {
<span class="nc" id="L10971">        return climbMode;</span>
    }

    public void setClimbMode(boolean state) {
<span class="nc" id="L10975">        climbMode = state;</span>
<span class="nc" id="L10976">    }</span>

    public boolean usedTag() {
<span class="nc bnc" id="L10979" title="All 2 branches missed.">        for (Mounted weapon : getWeaponList()) {</span>
<span class="nc" id="L10980">            WeaponType wtype = (WeaponType) weapon.getType();</span>
<span class="nc bnc" id="L10981" title="All 4 branches missed.">            if (weapon.isUsedThisRound() &amp;&amp; wtype.hasFlag(WeaponType.F_TAG)) {</span>
<span class="nc" id="L10982">                return true;</span>
            }
<span class="nc" id="L10984">        }</span>
<span class="nc" id="L10985">        return false;</span>
    }

    public boolean hasEiCockpit() {
<span class="nc bnc" id="L10989" title="All 4 branches missed.">        return ((game != null) &amp;&amp; game.getOptions().booleanOption(</span>
                OptionsConstants.ADVANCED_ALL_HAVE_EI_COCKPIT));
    }

    public boolean hasActiveEiCockpit() {
<span class="nc bnc" id="L10994" title="All 4 branches missed.">        return (hasEiCockpit() &amp;&amp; hasAbility(OptionsConstants.UNOFF_EI_IMPLANT));</span>
    }

    public boolean isLayingMines() {
<span class="nc" id="L10998">        return layingMines;</span>
    }

    public void setLayingMines(boolean laying) {
<span class="nc" id="L11002">        layingMines = laying;</span>
<span class="nc" id="L11003">    }</span>

    public boolean canLayMine() {
<span class="nc bnc" id="L11006" title="All 2 branches missed.">        for (Object oMount : miscList) {</span>
<span class="nc" id="L11007">            Mounted mount = (Mounted) oMount;</span>
<span class="nc" id="L11008">            EquipmentType type = mount.getType();</span>
<span class="nc bnc" id="L11009" title="All 2 branches missed.">            if (!mount.isMissing()</span>
<span class="nc bnc" id="L11010" title="All 2 branches missed.">                &amp;&amp; (type.hasFlag(MiscType.F_MINE) || type</span>
<span class="nc bnc" id="L11011" title="All 2 branches missed.">                    .hasFlag(MiscType.F_VEHICLE_MINE_DISPENSER))</span>
<span class="nc bnc" id="L11012" title="All 2 branches missed.">                &amp;&amp; !isLayingMines()) {</span>
<span class="nc" id="L11013">                return true;</span>
            }
<span class="nc" id="L11015">        }</span>
<span class="nc" id="L11016">        return false;</span>
    }

    @Override
    public int sideTable(Coords src) {
<span class="nc" id="L11021">        return sideTable(src, false);</span>
    }

    @Override
    public int sideTable(Coords src, boolean usePrior) {
<span class="nc" id="L11026">        return sideTable(src, usePrior, facing);</span>
    }

    public int sideTable(Coords src, boolean usePrior, int face) {
<span class="nc" id="L11030">        return sideTable(src, usePrior, face, getPosition());</span>
    }

    public int sideTable(Coords src, boolean usePrior, int face,
                         Coords effectivePos) {
<span class="nc bnc" id="L11035" title="All 2 branches missed.">        if (usePrior) {</span>
<span class="nc" id="L11036">            effectivePos = getPriorPosition();</span>
        }

<span class="nc bnc" id="L11039" title="All 2 branches missed.">        if (src.equals(effectivePos)) {</span>
            // most places handle 0 range explicitly,
            // this is a safe default (calculation gives SIDE_RIGHT)
<span class="nc" id="L11042">            return ToHitData.SIDE_FRONT;</span>
        }

        // calculate firing angle
<span class="nc" id="L11046">        int fa = (effectivePos.degree(src) + ((6 - face) * 60)) % 360;</span>

<span class="nc" id="L11048">        int leftBetter = 2;</span>
        // if we're right on the line, we need to special case this
        // defender would choose along which hex the LOS gets drawn, and that
        // side also determines the side we hit in
<span class="nc bnc" id="L11052" title="All 2 branches missed.">        if ((fa % 30) == 0) {</span>
<span class="nc" id="L11053">            IHex srcHex = game.getBoard().getHex(src);</span>
<span class="nc" id="L11054">            IHex curHex = game.getBoard().getHex(getPosition());</span>
<span class="nc bnc" id="L11055" title="All 4 branches missed.">            if ((srcHex != null) &amp;&amp; (curHex != null)) {</span>
<span class="nc" id="L11056">                LosEffects.AttackInfo ai = LosEffects.buildAttackInfo(src,</span>
<span class="nc" id="L11057">                                                                      getPosition(), 1, getElevation(), srcHex.floor(),</span>
<span class="nc" id="L11058">                                                                      curHex.floor());</span>
<span class="nc" id="L11059">                ArrayList&lt;Coords&gt; in = Coords.intervening(ai.attackPos,</span>
                                                          ai.targetPos, true);
<span class="nc" id="L11061">                leftBetter = LosEffects.dividedLeftBetter(in, game, ai,</span>
<span class="nc" id="L11062">                                                          Compute.isInBuilding(game, this), new LosEffects());</span>
            }
        }

<span class="nc bnc" id="L11066" title="All 2 branches missed.">        boolean targetIsTank = (this instanceof Tank)</span>
<span class="nc bnc" id="L11067" title="All 4 branches missed.">                               || (game.getOptions().booleanOption(</span>
                OptionsConstants.ADVCOMBAT_TACOPS_ADVANCED_MECH_HIT_LOCATIONS) &amp;&amp; (this instanceof QuadMech));
<span class="nc bnc" id="L11069" title="All 2 branches missed.">        if (targetIsTank) {</span>
<span class="nc bnc" id="L11070" title="All 4 branches missed.">            if ((leftBetter == 1) &amp;&amp; (fa == 150)) {</span>
<span class="nc" id="L11071">                return ToHitData.SIDE_REAR;</span>
<span class="nc bnc" id="L11072" title="All 4 branches missed.">            } else if ((leftBetter == 1) &amp;&amp; (fa == 30)) {</span>
<span class="nc" id="L11073">                return ToHitData.SIDE_RIGHT;</span>
<span class="nc bnc" id="L11074" title="All 4 branches missed.">            } else if ((leftBetter == 0) &amp;&amp; (fa == 330)) {</span>
<span class="nc" id="L11075">                return ToHitData.SIDE_LEFT;</span>
<span class="nc bnc" id="L11076" title="All 4 branches missed.">            } else if ((leftBetter == 0) &amp;&amp; (fa == 210)) {</span>
<span class="nc" id="L11077">                return ToHitData.SIDE_REAR;</span>
<span class="nc bnc" id="L11078" title="All 4 branches missed.">            } else if ((fa &gt; 30) &amp;&amp; (fa &lt;= 150)) {</span>
<span class="nc" id="L11079">                return ToHitData.SIDE_RIGHT;</span>
<span class="nc bnc" id="L11080" title="All 4 branches missed.">            } else if ((fa &gt; 150) &amp;&amp; (fa &lt; 210)) {</span>
<span class="nc" id="L11081">                return ToHitData.SIDE_REAR;</span>
<span class="nc bnc" id="L11082" title="All 4 branches missed.">            } else if ((fa &gt;= 210) &amp;&amp; (fa &lt; 330)) {</span>
<span class="nc" id="L11083">                return ToHitData.SIDE_LEFT;</span>
            } else {
<span class="nc" id="L11085">                return ToHitData.SIDE_FRONT;</span>
            }
        }
<span class="nc bnc" id="L11088" title="All 2 branches missed.">        if (isAero()) {</span>
<span class="nc" id="L11089">            IAero a = (IAero) this;</span>
            // Handle spheroids in atmosphere or on the ground differently
<span class="nc bnc" id="L11091" title="All 6 branches missed.">            if (a.isSpheroid() &amp;&amp; (game != null) &amp;&amp; !game.getBoard().inSpace()) {</span>
<span class="nc bnc" id="L11092" title="All 4 branches missed.">                if ((fa &gt;= 0) &amp;&amp; (fa &lt; 180)) {</span>
<span class="nc" id="L11093">                    return ToHitData.SIDE_RIGHT;</span>
                }
<span class="nc" id="L11095">                return ToHitData.SIDE_LEFT;</span>
            }
<span class="nc bnc" id="L11097" title="All 4 branches missed.">            if ((leftBetter == 1) &amp;&amp; (fa == 150)) {</span>
<span class="nc" id="L11098">                return ToHitData.SIDE_REAR;</span>
<span class="nc bnc" id="L11099" title="All 4 branches missed.">            } else if ((leftBetter == 1) &amp;&amp; (fa == 30)) {</span>
<span class="nc bnc" id="L11100" title="All 2 branches missed.">                if (a.isRolled()) {</span>
<span class="nc" id="L11101">                    return ToHitData.SIDE_LEFT;</span>
                }
<span class="nc" id="L11103">                return ToHitData.SIDE_RIGHT;</span>
<span class="nc bnc" id="L11104" title="All 4 branches missed.">            } else if ((leftBetter == 0) &amp;&amp; (fa == 330)) {</span>
<span class="nc bnc" id="L11105" title="All 2 branches missed.">                if (a.isRolled()) {</span>
<span class="nc" id="L11106">                    return ToHitData.SIDE_RIGHT;</span>
                }
<span class="nc" id="L11108">                return ToHitData.SIDE_LEFT;</span>
<span class="nc bnc" id="L11109" title="All 4 branches missed.">            } else if ((leftBetter == 0) &amp;&amp; (fa == 210)) {</span>
<span class="nc" id="L11110">                return ToHitData.SIDE_REAR;</span>
<span class="nc bnc" id="L11111" title="All 4 branches missed.">            } else if ((fa &gt; 30) &amp;&amp; (fa &lt;= 150)) {</span>
<span class="nc bnc" id="L11112" title="All 2 branches missed.">                if (a.isRolled()) {</span>
<span class="nc" id="L11113">                    return ToHitData.SIDE_LEFT;</span>
                }
<span class="nc" id="L11115">                return ToHitData.SIDE_RIGHT;</span>
<span class="nc bnc" id="L11116" title="All 4 branches missed.">            } else if ((fa &gt; 150) &amp;&amp; (fa &lt; 210)) {</span>
<span class="nc" id="L11117">                return ToHitData.SIDE_REAR;</span>
<span class="nc bnc" id="L11118" title="All 4 branches missed.">            } else if ((fa &gt;= 210) &amp;&amp; (fa &lt; 330)) {</span>
<span class="nc bnc" id="L11119" title="All 2 branches missed.">                if (a.isRolled()) {</span>
<span class="nc" id="L11120">                    return ToHitData.SIDE_RIGHT;</span>
                }
<span class="nc" id="L11122">                return ToHitData.SIDE_LEFT;</span>
            } else {
<span class="nc" id="L11124">                return ToHitData.SIDE_FRONT;</span>
            }
        }
<span class="nc bnc" id="L11127" title="All 4 branches missed.">        if ((fa == 90) &amp;&amp; (leftBetter == 1)) {</span>
<span class="nc" id="L11128">            return ToHitData.SIDE_RIGHT;</span>
<span class="nc bnc" id="L11129" title="All 8 branches missed.">        } else if (((fa == 150) &amp;&amp; (leftBetter == 1))</span>
                   || ((leftBetter == 0) &amp;&amp; (fa == 210))) {
<span class="nc" id="L11131">            return ToHitData.SIDE_REAR;</span>
<span class="nc bnc" id="L11132" title="All 4 branches missed.">        } else if ((leftBetter == 0) &amp;&amp; (fa == 270)) {</span>
<span class="nc" id="L11133">            return ToHitData.SIDE_LEFT;</span>
<span class="nc bnc" id="L11134" title="All 4 branches missed.">        } else if ((fa &gt; 90) &amp;&amp; (fa &lt;= 150)) {</span>
<span class="nc" id="L11135">            return ToHitData.SIDE_RIGHT;</span>
<span class="nc bnc" id="L11136" title="All 4 branches missed.">        } else if ((fa &gt; 150) &amp;&amp; (fa &lt; 210)) {</span>
<span class="nc" id="L11137">            return ToHitData.SIDE_REAR;</span>
<span class="nc bnc" id="L11138" title="All 4 branches missed.">        } else if ((fa &gt;= 210) &amp;&amp; (fa &lt; 270)) {</span>
<span class="nc" id="L11139">            return ToHitData.SIDE_LEFT;</span>
        } else {
<span class="nc" id="L11141">            return ToHitData.SIDE_FRONT;</span>
        }
    }

    /**
     * Method to determine if an entity is currently capable of going hull-down.
     * Note, this is *not* whether the entity can ever go hull-down.
     *
     * @return True if the entity is able to go hull-down, else false.
     */
    public boolean canGoHullDown() {
<span class="nc" id="L11152">        return false;</span>
    }

    public boolean canAssaultDrop() {
<span class="nc" id="L11156">        return false;</span>
    }

    public void setAssaultDropInProgress(boolean flag) {
<span class="nc bnc" id="L11160" title="All 2 branches missed.">        assaultDropInProgress = flag ? 1 : 0;</span>
<span class="nc" id="L11161">    }</span>

    public void setLandedAssaultDrop() {
<span class="nc" id="L11164">        assaultDropInProgress = 2;</span>
<span class="nc" id="L11165">        moved = EntityMovementType.MOVE_JUMP;</span>
<span class="nc" id="L11166">    }</span>

    public boolean isAssaultDropInProgress() {
<span class="nc bnc" id="L11169" title="All 2 branches missed.">        return assaultDropInProgress != 0;</span>
    }

    /**
     * Apply PSR modifier for difficult terrain at the specified coordinates
     *
     * @param roll the PSR to modify
     * @param c    the coordinates where the PSR happens
     */
    public void addPilotingModifierForTerrain(PilotingRollData roll, Coords c) {
<span class="nc" id="L11179">        addPilotingModifierForTerrain(roll, c, false);</span>
<span class="nc" id="L11180">    }</span>

    /**
     * Apply PSR modifier for difficult terrain at the specified coordinates
     *
     * @param roll the PSR to modify
     * @param c    the coordinates where the PSR happens
     * @param enteringRubble True if entering rubble, else false
     */
    public void addPilotingModifierForTerrain(PilotingRollData roll, Coords c,
            boolean enteringRubble) {
<span class="nc bnc" id="L11191" title="All 4 branches missed.">        if ((c == null) || (roll == null)) {</span>
<span class="nc" id="L11192">            return;</span>
        }
<span class="nc bnc" id="L11194" title="All 4 branches missed.">        if (isOffBoard() || !(isDeployed())) {</span>
<span class="nc" id="L11195">            return;</span>
        }
<span class="nc" id="L11197">        IHex hex = game.getBoard().getHex(c);</span>
<span class="nc" id="L11198">        hex.terrainPilotingModifier(getMovementMode(), roll, enteringRubble);</span>

<span class="nc bnc" id="L11200" title="All 4 branches missed.">        if (hex.containsTerrain(Terrains.JUNGLE) &amp;&amp; hasAbility(OptionsConstants.PILOT_TM_FOREST_RANGER)) {</span>
<span class="nc" id="L11201">            roll.addModifier(-1, &quot;Forest Ranger&quot;);</span>
        }
<span class="nc" id="L11203">    }</span>

    /**
     * Apply PSR modifier for difficult terrain at the move step position
     *
     * @param roll the PSR to modify
     * @param step the move step the PSR occurs at
     */
    public void addPilotingModifierForTerrain(PilotingRollData roll,
            MoveStep step) {
<span class="nc bnc" id="L11213" title="All 2 branches missed.">        if (step.getElevation() &gt; 0) {</span>
<span class="nc" id="L11214">            return;</span>
        }
<span class="nc" id="L11216">        addPilotingModifierForTerrain(roll, step.getPosition());</span>
<span class="nc" id="L11217">    }</span>

    /**
     * Apply PSR modifier for difficult terrain in the current position
     *
     * @param roll the PSR to modify
     */
    public void addPilotingModifierForTerrain(PilotingRollData roll) {
<span class="nc bnc" id="L11225" title="All 2 branches missed.">        if (getElevation() &gt; 0) {</span>
<span class="nc" id="L11226">            return;</span>
        }
<span class="nc" id="L11228">        addPilotingModifierForTerrain(roll, getPosition());</span>
<span class="nc" id="L11229">    }</span>

    /**
     * defensively check and correct elevation
     */
    public boolean fixElevation() {
<span class="nc bnc" id="L11235" title="All 4 branches missed.">        if (!isDeployed() || isOffBoard()</span>
<span class="nc bnc" id="L11236" title="All 2 branches missed.">            || !game.getBoard().contains(getPosition())) {</span>
<span class="nc" id="L11237">            return false;</span>
        }
<span class="nc bnc" id="L11239" title="All 2 branches missed.">        if (!isElevationValid(getElevation(),</span>
<span class="nc" id="L11240">                              game.getBoard().getHex(getPosition()))) {</span>
<span class="nc" id="L11241">            System.err.println(getDisplayName() + &quot; in hex &quot;</span>
<span class="nc" id="L11242">                               + HexTarget.coordsToId(getPosition())</span>
<span class="nc" id="L11243">                               + &quot; is at invalid elevation: &quot; + getElevation());</span>
<span class="nc" id="L11244">            setElevation(0 - game.getBoard()</span>
<span class="nc" id="L11245">                                 .getHex(getPosition()).depth());</span>
<span class="nc" id="L11246">            System.err.println(&quot;   moved to elevation &quot; + getElevation());</span>
<span class="nc" id="L11247">            return true;</span>
        }
<span class="nc" id="L11249">        return false;</span>
    }

    public Engine getEngine() {
<span class="nc" id="L11253">        return engine;</span>
    }

    public boolean hasEngine() {
<span class="nc bnc" id="L11257" title="All 2 branches missed.">        return (null != engine);</span>
    }

    public void setEngine(Engine e) {
<span class="nc" id="L11261">        engine = e;</span>
<span class="nc" id="L11262">    }</span>

    public boolean itemOppositeTech(String s) {
<span class="nc bnc" id="L11265" title="All 2 branches missed.">        if (isClan()) { // Clan base</span>
<span class="nc bnc" id="L11266" title="All 2 branches missed.">            if ((s.toLowerCase().indexOf(&quot;(is)&quot;) != -1)</span>
<span class="nc bnc" id="L11267" title="All 2 branches missed.">                || (s.toLowerCase().indexOf(&quot;inner sphere&quot;) != -1)) {</span>
<span class="nc" id="L11268">                return true;</span>
            }
<span class="nc" id="L11270">            return false;</span>
        }
<span class="nc bnc" id="L11272" title="All 2 branches missed.">        if ((s.toLowerCase().indexOf(&quot;(c)&quot;) != -1)</span>
<span class="nc bnc" id="L11273" title="All 2 branches missed.">            || (s.toLowerCase().indexOf(&quot;clan&quot;) != -1)) {</span>
<span class="nc" id="L11274">            return true;</span>
        }
<span class="nc" id="L11276">        return false;</span>
    }

    /**
     * @return Returns the retreatedDirection.
     */
    public OffBoardDirection getRetreatedDirection() {
<span class="nc" id="L11283">        return retreatedDirection;</span>
    }

    /**
     * @param retreatedDirection The retreatedDirection to set.
     */
    public void setRetreatedDirection(OffBoardDirection retreatedDirection) {
<span class="nc" id="L11290">        this.retreatedDirection = retreatedDirection;</span>
<span class="nc" id="L11291">    }</span>

    public void setLastTarget(int id) {
<span class="nc" id="L11294">        lastTarget = id;</span>
<span class="nc" id="L11295">    }</span>

    public int getLastTarget() {
<span class="nc" id="L11298">        return lastTarget;</span>
    }

    public void setLastTargetDisplayName(String name) {
<span class="nc" id="L11302">        lastTargetDisplayName = name;</span>
<span class="nc" id="L11303">    }</span>

    public String getLastTargetDisplayName() {
<span class="nc" id="L11306">        return lastTargetDisplayName;</span>
    }

    /**
     * @returns whether or not the unit is suffering from Electromagnetic
     * Interference
     */
    public boolean isSufferingEMI() {
<span class="nc" id="L11314">        return _isEMId;</span>
    }

    public void setEMI(boolean inVal) {
<span class="nc" id="L11318">        _isEMId = inVal;</span>
<span class="nc" id="L11319">    }</span>

    /**
     * The attack direction modifier for rolls on the motive system hits table
     * for the given side (as defined in {@link ToHitData}). This will return 0
     * if Tactical Operations vehicle effectiveness rules are in effect or if
     * the side parameter falls outside ToHitData's range of &quot;fixed&quot; side
     * values; in particular, it will return 0 if handed
     * {@link ToHitData#SIDE_RANDOM}.
     *
     * @param side
     *            The attack direction as specified above.
     * @return The appropriate directional roll modifier.
     */
    public int getMotiveSideMod(int side) {
<span class="nc bnc" id="L11334" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_VEHICLE_EFFECTIVE)) {</span>
<span class="nc" id="L11335">            return 0;</span>
        }
<span class="nc bnc" id="L11337" title="All 3 branches missed.">        switch (side) {</span>
            case ToHitData.SIDE_LEFT:
            case ToHitData.SIDE_RIGHT:
            case ToHitData.SIDE_FRONTLEFT:
            case ToHitData.SIDE_FRONTRIGHT:
            case ToHitData.SIDE_REARLEFT:
            case ToHitData.SIDE_REARRIGHT:
<span class="nc" id="L11344">                return 2;</span>
            case ToHitData.SIDE_REAR:
<span class="nc" id="L11346">                return 1;</span>
            default:
<span class="nc" id="L11348">                return 0;</span>
        }
    }

    /**
     * Checks if the unit is hardened agaist nuclear strikes.
     *
     * @return true if this is a hardened unit.
     */
    public abstract boolean isNuclearHardened();

    /**
     * Set the isHidden state of this entity (used for hidden units rules, TW
     * pg 259).
     * @param inVal
     */
    public void setHidden(boolean inVal) {
<span class="nc" id="L11365">        isHidden = inVal;</span>
<span class="nc" id="L11366">    }</span>

    public void setMadePointblankShot(boolean inVal) {
<span class="nc" id="L11369">        madePointblankShot = inVal;</span>
<span class="nc" id="L11370">    }</span>

    /**
     * Set a phase for this hidden unit to become active in.
     *
     * @param phase
     */
    public void setHiddeActivationPhase(IGame.Phase phase) {
<span class="nc" id="L11378">        hiddenActivationPhase = phase;</span>
<span class="nc" id="L11379">    }</span>

    /**
     * Returns true if this unit is currently hidden (hidden units, TW pg 259).
     * @return
     */
    public boolean isHidden() {
<span class="nc" id="L11386">        return isHidden;</span>
    }

    /**
     * Returns true if this unit has already made a pointblank shot this round.
     * @return
     */
    public boolean madePointblankShot() {
<span class="nc" id="L11394">        return madePointblankShot;</span>
    }

    /**
     * Returns true if this unit should be considering a hidden unit that is
     * activating.
     * @return
     */
    public boolean isHiddenActivating() {
<span class="nc bnc" id="L11403" title="All 2 branches missed.">        return getHiddenActivationPhase() != null;</span>
    }

    /**
     * Get the phase that this hidden unit will activate in (generally this
     * will be null, indicating that the unit isn't activating).
     * @return
     */
    @Nullable
    public IGame.Phase getHiddenActivationPhase() {
<span class="nc" id="L11413">        return hiddenActivationPhase;</span>
    }

    /**
     * Is this unit a carcass, a carcass can take no action
     */
    public boolean isCarcass() {
<span class="nc" id="L11420">        return carcass;</span>
    }

    /**
     * Sets if this unit is a carcass.
     *
     * @param carcass true if this unit should be a carcass, false otherwise.
     * @see megamek.common.Entity#isCarcass
     */
    public void setCarcass(boolean carcass) {
<span class="nc" id="L11430">        this.carcass = carcass;</span>
<span class="nc" id="L11431">    }</span>

    /**
     * Marks all equipment in a location on this entity as destroyed.
     *
     * @param loc The location that is destroyed.
     */

    public void destroyLocation(int loc) {
<span class="nc" id="L11440">        destroyLocation(loc, false);</span>
<span class="nc" id="L11441">    }</span>

    /**
     * Marks all equipment in a location on this entity as destroyed.
     *
     * @param loc      The location that is destroyed.
     * @param blownOff true if the location was blown off
     */
    public void destroyLocation(int loc, boolean blownOff) {
        // if it's already marked as destroyed, don't bother
<span class="nc bnc" id="L11451" title="All 2 branches missed.">        if (getInternal(loc) &lt; 0) {</span>
<span class="nc" id="L11452">            return;</span>
        }
<span class="nc bnc" id="L11454" title="All 2 branches missed.">        if (blownOff) {</span>
<span class="nc" id="L11455">            setLocationBlownOff(loc, true);</span>
<span class="nc" id="L11456">            setLocationBlownOffThisPhase(loc, true);</span>
        } else {
            // mark armor, internal as doomed
<span class="nc" id="L11459">            setArmor(IArmorState.ARMOR_DOOMED, loc, false);</span>
<span class="nc" id="L11460">            setInternal(IArmorState.ARMOR_DOOMED, loc);</span>
<span class="nc bnc" id="L11461" title="All 2 branches missed.">            if (hasRearArmor(loc)) {</span>
<span class="nc" id="L11462">                setArmor(IArmorState.ARMOR_DOOMED, loc, true);</span>
            }
        }

        // all critical slots set as missing
        // while we're here, if something is mounted in those crits, set it as hit, 
        // instead of looping through all equipment in the unit
<span class="nc bnc" id="L11469" title="All 2 branches missed.">        for (int i = 0; i &lt; getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L11470">            final CriticalSlot cs = getCritical(loc, i);</span>
<span class="nc bnc" id="L11471" title="All 2 branches missed.">            if (cs != null) {</span>
                // count engine hits for maxtech engine explosions
<span class="nc bnc" id="L11473" title="All 2 branches missed.">                if ((cs.getType() == CriticalSlot.TYPE_SYSTEM)</span>
<span class="nc bnc" id="L11474" title="All 2 branches missed.">                    &amp;&amp; (cs.getIndex() == Mech.SYSTEM_ENGINE)</span>
<span class="nc bnc" id="L11475" title="All 2 branches missed.">                    &amp;&amp; !cs.isDamaged()) {</span>
<span class="nc" id="L11476">                    engineHitsThisPhase++;</span>
                }
                
<span class="nc bnc" id="L11479" title="All 4 branches missed.">                final boolean mountOneIsHittable = (cs.getMount() != null) &amp;&amp; cs.getMount().getType().isHittable();</span>
<span class="nc bnc" id="L11480" title="All 4 branches missed.">                final boolean mountTwoIsHittable = (cs.getMount2() != null) &amp;&amp; cs.getMount2().getType().isHittable();</span>
                
<span class="nc bnc" id="L11482" title="All 2 branches missed.">                if (blownOff) {</span>
<span class="nc" id="L11483">                    cs.setMissing(true);</span>
                    
<span class="nc bnc" id="L11485" title="All 2 branches missed.">                    if (mountOneIsHittable) {</span>
<span class="nc" id="L11486">                        cs.getMount().setMissing(true);</span>
                    }
                    
<span class="nc bnc" id="L11489" title="All 2 branches missed.">                    if (mountTwoIsHittable) {</span>
<span class="nc" id="L11490">                        cs.getMount2().setMissing(true);</span>
                    }
                    
                } else {
<span class="nc" id="L11494">                    cs.setHit(true);</span>
                    
<span class="nc bnc" id="L11496" title="All 2 branches missed.">                    if (mountOneIsHittable) {</span>
<span class="nc" id="L11497">                        cs.getMount().setHit(true);</span>
                    }
                    
<span class="nc bnc" id="L11500" title="All 2 branches missed.">                    if (mountTwoIsHittable) {</span>
<span class="nc" id="L11501">                        cs.getMount2().setHit(true);</span>
                    }
                }
            }
        }
        
        // dependent locations destroyed, unless they are already destroyed
<span class="nc bnc" id="L11508" title="All 2 branches missed.">        if ((getDependentLocation(loc) != Entity.LOC_NONE)</span>
<span class="nc bnc" id="L11509" title="All 2 branches missed.">            &amp;&amp; !(getInternal(getDependentLocation(loc)) &lt; 0)) {</span>
<span class="nc" id="L11510">            destroyLocation(getDependentLocation(loc), true);</span>
        }
<span class="nc" id="L11512">    }</span>

    /**
     * Iterates over all Narc and iNarc pods attached to this entity and removes
     * those still 'stuck' to destroyed or missing locations.
     */
    public void clearDestroyedNarcPods() {
<span class="nc bnc" id="L11519" title="All 2 branches missed.">        for (Iterator&lt;NarcPod&gt; i = pendingNarcPods.iterator(); i.hasNext(); ) {</span>
<span class="nc bnc" id="L11520" title="All 2 branches missed.">            if (!locationCanHoldNarcPod(i.next().getLocation())) {</span>
<span class="nc" id="L11521">                i.remove();</span>
            }
        }
<span class="nc bnc" id="L11524" title="All 2 branches missed.">        for (Iterator&lt;NarcPod&gt; i = narcPods.iterator(); i.hasNext(); ) {</span>
<span class="nc bnc" id="L11525" title="All 2 branches missed.">            if (!locationCanHoldNarcPod(i.next().getLocation())) {</span>
<span class="nc" id="L11526">                i.remove();</span>
            }
        }
<span class="nc bnc" id="L11529" title="All 2 branches missed.">        for (Iterator&lt;INarcPod&gt; i = pendingINarcPods.iterator(); i.hasNext(); ) {</span>
<span class="nc bnc" id="L11530" title="All 2 branches missed.">            if (!locationCanHoldNarcPod(i.next().getLocation())) {</span>
<span class="nc" id="L11531">                i.remove();</span>
            }
        }
<span class="nc bnc" id="L11534" title="All 2 branches missed.">        for (Iterator&lt;INarcPod&gt; i = iNarcPods.iterator(); i.hasNext(); ) {</span>
<span class="nc bnc" id="L11535" title="All 2 branches missed.">            if (!locationCanHoldNarcPod(i.next().getLocation())) {</span>
<span class="nc" id="L11536">                i.remove();</span>
            }
        }
<span class="nc" id="L11539">    }</span>

    private boolean locationCanHoldNarcPod(int location) {
<span class="nc bnc" id="L11542" title="All 2 branches missed.">        return (getInternal(location) &gt; 0)</span>
<span class="nc bnc" id="L11543" title="All 2 branches missed.">               &amp;&amp; !isLocationBlownOff(location)</span>
<span class="nc bnc" id="L11544" title="All 2 branches missed.">               &amp;&amp; !isLocationBlownOffThisPhase(location);</span>
    }

    public PilotingRollData checkSideSlip(EntityMovementType moveType,
                                          IHex prevHex, EntityMovementType overallMoveType,
                                          MoveStep prevStep, int prevFacing, int curFacing, Coords lastPos,
                                          Coords curPos, int distance) {
<span class="nc" id="L11551">        PilotingRollData roll = getBasePilotingRoll(overallMoveType);</span>

<span class="nc bnc" id="L11553" title="All 16 branches missed.">        if ((moveType != EntityMovementType.MOVE_JUMP)</span>
                &amp;&amp; (prevHex != null)
                &amp;&amp; (distance &gt; 1)
                &amp;&amp; ((overallMoveType == EntityMovementType.MOVE_RUN)
                        || (overallMoveType == EntityMovementType.MOVE_VTOL_RUN)
                        || (overallMoveType == EntityMovementType.MOVE_SPRINT)
                        || (overallMoveType == EntityMovementType.MOVE_VTOL_SPRINT))
<span class="nc bnc" id="L11560" title="All 6 branches missed.">                &amp;&amp; (prevFacing != curFacing) &amp;&amp; !lastPos.equals(curPos)</span>
                &amp;&amp; !(this instanceof Infantry)
                &amp;&amp; !(this instanceof Protomech)) {
<span class="nc" id="L11563">            roll.append(new PilotingRollData(getId(), 0, &quot;flanking and turning&quot;));</span>
<span class="nc bnc" id="L11564" title="All 2 branches missed.">            if (isUsingManAce()) {</span>
<span class="nc" id="L11565">                roll.addModifier(-1, &quot;Maneuvering Ace&quot;);</span>
            }
<span class="nc bnc" id="L11567" title="All 4 branches missed.">            if ((getMovementMode() == EntityMovementMode.VTOL) &amp;&amp; isMASCUsed()</span>
<span class="nc bnc" id="L11568" title="All 2 branches missed.">                    &amp;&amp; hasWorkingMisc(MiscType.F_JET_BOOSTER)) {</span>
<span class="nc" id="L11569">                roll.addModifier(3, &quot;used VTOL Jet Booster&quot;);</span>
            }
<span class="nc bnc" id="L11571" title="All 4 branches missed.">        } else if (moveType != EntityMovementType.MOVE_JUMP</span>
<span class="nc bnc" id="L11572" title="All 2 branches missed.">                &amp;&amp; prevFacing == curFacing &amp;&amp; !lastPos.equals(curPos)</span>
<span class="nc bnc" id="L11573" title="All 2 branches missed.">                &amp;&amp; lastPos.direction(curPos) % 3 != curFacing % 3</span>
<span class="nc bnc" id="L11574" title="All 6 branches missed.">                &amp;&amp; !(isUsingManAce() &amp;&amp; (overallMoveType == EntityMovementType.MOVE_WALK</span>
                || overallMoveType == EntityMovementType.MOVE_VTOL_WALK))) {
<span class="nc" id="L11576">            roll.append(new PilotingRollData(getId(), 0, &quot;controlled sideslip&quot;));</span>
        } else {
<span class="nc" id="L11578">            roll.addModifier(TargetRoll.CHECK_FALSE,</span>
                    &quot;Check false: not apparently sideslipping&quot;);
        }

<span class="nc" id="L11582">        return roll;</span>
    }

    @Override
    public boolean isAirborneVTOLorWIGE() {
        // stuff that moves like a VTOL is flying unless at elevation 0 or on
        // top of/in a building,
<span class="nc bnc" id="L11589" title="All 2 branches missed.">        if ((getMovementMode() == EntityMovementMode.VTOL)</span>
<span class="nc bnc" id="L11590" title="All 2 branches missed.">                || (getMovementMode() == EntityMovementMode.WIGE)) {</span>
<span class="nc bnc" id="L11591" title="All 2 branches missed.">            if ((game != null)</span>
<span class="nc bnc" id="L11592" title="All 2 branches missed.">                    &amp;&amp; (game.getBoard() != null)</span>
<span class="nc bnc" id="L11593" title="All 2 branches missed.">                    &amp;&amp; (getPosition() != null)</span>
<span class="nc bnc" id="L11594" title="All 2 branches missed.">                    &amp;&amp; (game.getBoard().getHex(getPosition()) != null)</span>
<span class="nc" id="L11595">                    &amp;&amp; ((game.getBoard().getHex(getPosition())</span>
<span class="nc bnc" id="L11596" title="All 2 branches missed.">                            .terrainLevel(Terrains.BLDG_ELEV) &gt;= getElevation()) || (game</span>
<span class="nc" id="L11597">                            .getBoard().getHex(getPosition())</span>
<span class="nc bnc" id="L11598" title="All 2 branches missed.">                            .terrainLevel(Terrains.BRIDGE_ELEV) &gt;= getElevation()))) {</span>
<span class="nc" id="L11599">                return false;</span>
            }
<span class="nc bnc" id="L11601" title="All 2 branches missed.">            return getElevation() &gt; 0;</span>
        }
<span class="nc" id="L11603">        return false;</span>
    }

    public void setSpotTargetId(int targetId) {
<span class="nc" id="L11607">        spotTargetId = targetId;</span>
<span class="nc" id="L11608">    }</span>

    public int getSpotTargetId() {
<span class="nc" id="L11611">        return spotTargetId;</span>
    }

    public void setCommander(boolean arg) {
<span class="nc" id="L11615">        isCommander = arg;</span>
<span class="nc" id="L11616">    }</span>

    public boolean isCommander() {
<span class="nc" id="L11619">        return isCommander;</span>
    }

    public boolean hasLinkedMGA(Mounted mounted) {
<span class="nc bnc" id="L11623" title="All 2 branches missed.">        for (Mounted m : getWeaponList()) {</span>
<span class="nc bnc" id="L11624" title="All 2 branches missed.">            if ((m.getLocation() == mounted.getLocation())</span>
<span class="nc bnc" id="L11625" title="All 2 branches missed.">                &amp;&amp; m.getType().hasFlag(WeaponType.F_MGA)</span>
<span class="nc bnc" id="L11626" title="All 4 branches missed.">                &amp;&amp; !(m.isDestroyed() || m.isBreached())</span>
<span class="nc bnc" id="L11627" title="All 2 branches missed.">                &amp;&amp; m.getBayWeapons().contains(getEquipmentNum(mounted))</span>
<span class="nc bnc" id="L11628" title="All 4 branches missed.">                &amp;&amp; m.getType().hasModes() &amp;&amp; m.curMode().equals(&quot;Linked&quot;)) {</span>
<span class="nc" id="L11629">                return true;</span>
            }
<span class="nc" id="L11631">        }</span>
<span class="nc" id="L11632">        return false;</span>
    }

    public void setReckless(boolean b) {
<span class="nc" id="L11636">        reckless = b;</span>
<span class="nc" id="L11637">    }</span>

    public boolean isReckless() {
<span class="nc" id="L11640">        return reckless;</span>
    }

    /**
     * Helper function to test whether an entity should be treated as an Aero unit (includes
     * LAMs in fighter mode)
     */
    public boolean isAero() {
<span class="nc" id="L11648">        return false;</span>
    }

    /**
     * Helper function to determine whether an entity is an aero unit but not Small Craft/
     * DropShip/JumpShip/WarShip.
     */
    public boolean isFighter() {
<span class="nc" id="L11656">        return isAero();</span>
    }

    public boolean isCapitalFighter() {
<span class="nc" id="L11660">        return isCapitalFighter(false);</span>
    }

    public boolean isCapitalFighter(boolean lounge) {
<span class="nc bnc" id="L11664" title="All 2 branches missed.">        if (null == game) {</span>
<span class="nc" id="L11665">            return false;</span>
        }

        // If we're using the unofficial option for single fighters staying
        // standard scale &amp; we're not a member of a squadron... then false.
<span class="nc bnc" id="L11670" title="All 4 branches missed.">        if (!lounge &amp;&amp; isFighter()</span>
<span class="nc bnc" id="L11671" title="All 2 branches missed.">            &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_SINGLE_NO_CAP)</span>
<span class="nc bnc" id="L11672" title="All 2 branches missed.">            &amp;&amp; !isPartOfFighterSquadron()) {</span>
<span class="nc" id="L11673">            return false;</span>
        }

<span class="nc bnc" id="L11676" title="All 2 branches missed.">        return game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_CAPITAL_FIGHTER)</span>
<span class="nc bnc" id="L11677" title="All 2 branches missed.">               &amp;&amp; isFighter();</span>
    }

    /**
     * a function that let's us know if this entity has capital-scale armor
     *
     * @return
     */
    public boolean isCapitalScale() {

<span class="nc bnc" id="L11687" title="All 4 branches missed.">        if ((this instanceof Jumpship) || (this instanceof FighterSquadron)</span>
<span class="nc bnc" id="L11688" title="All 2 branches missed.">            || isCapitalFighter()) {</span>
<span class="nc" id="L11689">            return true;</span>
        }

<span class="nc" id="L11692">        return false;</span>

    }

    /**
     * a function that let's us know if this entity is using weapons bays
     *
     * @return
     */
    public boolean usesWeaponBays() {
<span class="nc" id="L11702">        return false;</span>
    }

    /**
     * return the bay of the current weapon
     *
     * @param bayID
     * @return
     */
    public Mounted whichBay(int bayID) {

<span class="nc bnc" id="L11713" title="All 2 branches missed.">        for (Mounted m : getWeaponBayList()) {</span>
<span class="nc bnc" id="L11714" title="All 2 branches missed.">            for (int wId : m.getBayWeapons()) {</span>
                // find the weapon and determine if it is there
<span class="nc bnc" id="L11716" title="All 2 branches missed.">                if (wId == bayID) {</span>
<span class="nc" id="L11717">                    return m;</span>
                }
<span class="nc" id="L11719">            }</span>
<span class="nc" id="L11720">        }</span>
<span class="nc" id="L11721">        return null;</span>
    }

    /**
     * return the first bay of the right type in the right location with enough
     * damage to spare
     *
     * @param wtype
     * @param loc
     * @param rearMount
     * @return
     */
    public Mounted getFirstBay(WeaponType wtype, int loc, boolean rearMount) {

<span class="nc" id="L11735">        int weapDamage = wtype.getRoundShortAV();</span>
<span class="nc bnc" id="L11736" title="All 2 branches missed.">        if (wtype.isCapital()) {</span>
<span class="nc" id="L11737">            weapDamage *= 10;</span>
        }

<span class="nc bnc" id="L11740" title="All 2 branches missed.">        for (Mounted m : getWeaponBayList()) {</span>
<span class="nc" id="L11741">            BayWeapon bay = (BayWeapon) m.getType();</span>
<span class="nc" id="L11742">            int damage = bay.getRoundShortAV() + weapDamage;</span>
<span class="nc bnc" id="L11743" title="All 2 branches missed.">            if ((bay.getAtClass() == wtype.getAtClass())</span>
<span class="nc bnc" id="L11744" title="All 2 branches missed.">                &amp;&amp; (m.getLocation() == loc)</span>
<span class="nc bnc" id="L11745" title="All 4 branches missed.">                &amp;&amp; (m.isRearMounted() == rearMount) &amp;&amp; (damage &lt;= 700)) {</span>
<span class="nc" id="L11746">                return m;</span>
            }

<span class="nc" id="L11749">        }</span>
<span class="nc" id="L11750">        return null;</span>
    }

    public int getHeatInArc(int location, boolean rearMount) {

<span class="nc" id="L11755">        int arcHeat = 0;</span>

<span class="nc bnc" id="L11757" title="All 2 branches missed.">        for (Mounted mounted : getTotalWeaponList()) {</span>
            // is the weapon usable?
<span class="nc bnc" id="L11759" title="All 4 branches missed.">            if (mounted.isDestroyed() || mounted.isJammed()) {</span>
<span class="nc" id="L11760">                continue;</span>
            }

<span class="nc bnc" id="L11763" title="All 2 branches missed.">            if ((mounted.getLocation() == location)</span>
<span class="nc bnc" id="L11764" title="All 2 branches missed.">                &amp;&amp; (mounted.isRearMounted() == rearMount)) {</span>
<span class="nc" id="L11765">                arcHeat += mounted.getCurrentHeat();</span>
            }
<span class="nc" id="L11767">        }</span>
<span class="nc" id="L11768">        return arcHeat;</span>
    }

    public int[] getVectors() {
<span class="nc" id="L11772">        return vectors;</span>
    }

    public void setVectors(int[] v) {
<span class="nc bnc" id="L11776" title="All 4 branches missed.">        if ((v == null) || (v.length != 6)) {</span>
<span class="nc" id="L11777">            return;</span>
        }

<span class="nc" id="L11780">        vectors = v;</span>
<span class="nc" id="L11781">    }</span>

    public int getVector(int vectorFacing) {
<span class="nc bnc" id="L11784" title="All 2 branches missed.">        if (vectorFacing &lt; 6) {</span>
<span class="nc" id="L11785">            return vectors[vectorFacing];</span>
        }
<span class="nc" id="L11787">        return 0;</span>
    }

    public int getVelocity() {

<span class="nc" id="L11792">        int total = 0;</span>
<span class="nc bnc" id="L11793" title="All 2 branches missed.">        for (int dir = 0; dir &lt; 6; dir++) {</span>
<span class="nc" id="L11794">            total += getVector(dir);</span>
        }

<span class="nc" id="L11797">        return total;</span>
    }

    public int chooseSide(Coords attackPos, boolean usePrior) {
        // loop through directions and if we have a non-zero vector, then
        // compute
        // the targetsidetable. If we come to a higher vector, then replace. If
        // we come to an equal vector then take it if it is better
<span class="nc" id="L11805">        int thrust = 0;</span>
<span class="nc" id="L11806">        int high = -1;</span>
<span class="nc" id="L11807">        int side = -1;</span>
<span class="nc bnc" id="L11808" title="All 2 branches missed.">        for (int dir = 0; dir &lt; 6; dir++) {</span>
<span class="nc" id="L11809">            thrust = getVector(dir);</span>
<span class="nc bnc" id="L11810" title="All 2 branches missed.">            if (thrust == 0) {</span>
<span class="nc" id="L11811">                continue;</span>
            }

<span class="nc bnc" id="L11814" title="All 2 branches missed.">            if (thrust &gt; high) {</span>
<span class="nc" id="L11815">                high = thrust;</span>
<span class="nc" id="L11816">                side = sideTable(attackPos, usePrior, dir);</span>
            }

            // what if they tie
<span class="nc bnc" id="L11820" title="All 2 branches missed.">            if (thrust == high) {</span>
<span class="nc" id="L11821">                int newside = sideTable(attackPos, usePrior, dir);</span>
                // choose the best
<span class="nc bnc" id="L11823" title="All 4 branches missed.">                if ((newside == ToHitData.SIDE_LEFT)</span>
                    || (newside == ToHitData.SIDE_RIGHT)) {
<span class="nc" id="L11825">                    newside = side;</span>
                }
                // that should be the only case, because it can't shift you from
                // front
                // to aft or vice-versa
            }

        }
<span class="nc" id="L11833">        return side;</span>
    }

    /**
     * return the heading of the unit based on its active vectors if vectors are
     * tied then return two headings
     */
    public Vector&lt;Integer&gt; getHeading() {

<span class="nc" id="L11842">        Vector&lt;Integer&gt; heading = new Vector&lt;Integer&gt;();</span>
<span class="nc" id="L11843">        int high = 0;</span>
<span class="nc" id="L11844">        int curDir = getFacing();</span>
<span class="nc bnc" id="L11845" title="All 2 branches missed.">        for (int dir = 0; dir &lt; 6; dir++) {</span>
<span class="nc" id="L11846">            int thrust = getVector(dir);</span>
<span class="nc bnc" id="L11847" title="All 4 branches missed.">            if ((thrust &gt;= high) &amp;&amp; (thrust &gt; 0)) {</span>
                // if they were equal then add the last direction to the
                // vector before moving on
<span class="nc bnc" id="L11850" title="All 2 branches missed.">                if (thrust == high) {</span>
<span class="nc" id="L11851">                    heading.addElement(curDir);</span>
                }
<span class="nc" id="L11853">                high = getVector(dir);</span>
<span class="nc" id="L11854">                curDir = dir;</span>
            }
        }
<span class="nc" id="L11857">        heading.addElement(curDir);</span>
<span class="nc" id="L11858">        return heading;</span>
    }

    public void setPlayerPickedPassThrough(int attackerId, Coords c) {
<span class="nc bnc" id="L11862" title="All 2 branches missed.">        if (playerPickedPassThrough == null) {</span>
<span class="nc" id="L11863">            playerPickedPassThrough = new HashMap&lt;&gt;();</span>
        }
<span class="nc" id="L11865">        playerPickedPassThrough.put(attackerId, c);</span>
<span class="nc" id="L11866">    }</span>

    public @Nullable Coords getPlayerPickedPassThrough(int attackerId) {
<span class="nc bnc" id="L11869" title="All 2 branches missed.">        if (playerPickedPassThrough == null) {</span>
<span class="nc" id="L11870">            playerPickedPassThrough = new HashMap&lt;&gt;();</span>
        }
<span class="nc" id="L11872">        return playerPickedPassThrough.get(attackerId);</span>
    }

    public void setPassedThrough(Vector&lt;Coords&gt; pass) {
<span class="nc" id="L11876">        passedThrough = pass;</span>
<span class="nc" id="L11877">    }</span>

    public Vector&lt;Coords&gt; getPassedThrough() {
<span class="nc" id="L11880">        return passedThrough;</span>
    }

    public void setPassedThroughFacing(List&lt;Integer&gt; passFacing) {
<span class="nc" id="L11884">        passedThroughFacing = passFacing;</span>
<span class="nc" id="L11885">    }</span>

    public List&lt;Integer&gt; getPassedThroughFacing() {
<span class="nc" id="L11888">        return passedThroughFacing;</span>
    }

    public void addPassedThrough(Coords c) {
<span class="nc" id="L11892">        passedThrough.add(c);</span>
<span class="nc" id="L11893">    }</span>

    /**
     * Method that determines if this Entity passed over another entity during
     * its current path
     *
     * @param t
     * @return
     */
    public boolean passedOver(Targetable t) {
<span class="nc bnc" id="L11903" title="All 2 branches missed.">        for (Coords crd : passedThrough) {</span>
<span class="nc bnc" id="L11904" title="All 2 branches missed.">            if (crd.equals(t.getPosition())) {</span>
<span class="nc" id="L11905">                return true;</span>
            }
<span class="nc bnc" id="L11907" title="All 2 branches missed.">            for (Coords secondary : t.getSecondaryPositions().values()) {</span>
<span class="nc bnc" id="L11908" title="All 2 branches missed.">                if (crd.equals(secondary)) {</span>
<span class="nc" id="L11909">                    return true;</span>
                }
<span class="nc" id="L11911">            }</span>
<span class="nc" id="L11912">        }</span>
<span class="nc" id="L11913">        return false;</span>
    }

    public boolean passedThrough(Coords c) {
<span class="nc bnc" id="L11917" title="All 2 branches missed.">        for (Coords crd : passedThrough) {</span>
<span class="nc bnc" id="L11918" title="All 2 branches missed.">            if (crd.equals(c)) {</span>
<span class="nc" id="L11919">                return true;</span>
            }
<span class="nc" id="L11921">        }</span>
<span class="nc" id="L11922">        return false;</span>
    }

    /**
     * Did the entity pass within a certain number of hexes of these coords?
     */
    public boolean passedWithin(Coords c, int dist) {
<span class="nc bnc" id="L11929" title="All 2 branches missed.">        for (Coords crd : passedThrough) {</span>
<span class="nc bnc" id="L11930" title="All 2 branches missed.">            if (crd.distance(c) &lt;= dist) {</span>
<span class="nc" id="L11931">                return true;</span>
            }
<span class="nc" id="L11933">        }</span>
<span class="nc" id="L11934">        return false;</span>
    }

    /**
     * What coords were passed through previous to the given one
     */
    public Coords passedThroughPrevious(Coords c) {
<span class="nc bnc" id="L11941" title="All 2 branches missed.">        if (passedThrough.size() == 0) {</span>
<span class="nc" id="L11942">            return getPosition();</span>
        }
<span class="nc" id="L11944">        Coords prevCrd = passedThrough.get(0);</span>
<span class="nc bnc" id="L11945" title="All 2 branches missed.">        for (Coords crd : passedThrough) {</span>
<span class="nc bnc" id="L11946" title="All 2 branches missed.">            if (crd.equals(c)) {</span>
<span class="nc" id="L11947">                break;</span>
            }
<span class="nc" id="L11949">            prevCrd = crd;</span>
<span class="nc" id="L11950">        }</span>
<span class="nc" id="L11951">        return prevCrd;</span>
    }

    public void setRamming(boolean b) {
<span class="nc" id="L11955">        ramming = b;</span>
<span class="nc" id="L11956">    }</span>

    public boolean isRamming() {
<span class="nc" id="L11959">        return ramming;</span>
    }

    public void resetFiringArcs() {
<span class="nc" id="L11963">        frontArcFired = new boolean[locations()];</span>
<span class="nc" id="L11964">        rearArcFired = new boolean[locations()];</span>
<span class="nc bnc" id="L11965" title="All 2 branches missed.">        for (int i = 0; i &lt; locations(); i++) {</span>
<span class="nc" id="L11966">            frontArcFired[i] = false;</span>
<span class="nc" id="L11967">            rearArcFired[i] = false;</span>
        }
<span class="nc" id="L11969">    }</span>

    public boolean hasArcFired(int location, boolean rearMount) {
<span class="nc bnc" id="L11972" title="All 4 branches missed.">        if ((null == frontArcFired) || (null == rearArcFired)) {</span>
<span class="nc" id="L11973">            resetFiringArcs();</span>
        }
<span class="nc bnc" id="L11975" title="All 4 branches missed.">        if ((location &gt; locations()) || (location &lt; 0)) {</span>
<span class="nc" id="L11976">            return false;</span>
        }

<span class="nc bnc" id="L11979" title="All 2 branches missed.">        if (rearMount) {</span>
<span class="nc" id="L11980">            return rearArcFired[location];</span>
        }
<span class="nc" id="L11982">        return frontArcFired[location];</span>
    }

    public void setArcFired(int location, boolean rearMount) {
<span class="nc bnc" id="L11986" title="All 4 branches missed.">        if ((null == frontArcFired) || (null == rearArcFired)) {</span>
<span class="nc" id="L11987">            resetFiringArcs();</span>
        }
<span class="nc bnc" id="L11989" title="All 4 branches missed.">        if ((location &gt; locations()) || (location &lt; 0)) {</span>
<span class="nc" id="L11990">            return;</span>
        }

<span class="nc bnc" id="L11993" title="All 2 branches missed.">        if (rearMount) {</span>
<span class="nc" id="L11994">            rearArcFired[location] = true;</span>
        } else {
<span class="nc" id="L11996">            frontArcFired[location] = true;</span>
        }
<span class="nc" id="L11998">    }</span>

    /**
     * Force rapid fire mode to the highest level on RAC and UAC - this is for
     * aeros
     */
    public void setRapidFire() {
<span class="nc bnc" id="L12005" title="All 2 branches missed.">        for (Mounted m : getTotalWeaponList()) {</span>
<span class="nc" id="L12006">            WeaponType wtype = (WeaponType) m.getType();</span>
<span class="nc bnc" id="L12007" title="All 2 branches missed.">            if (wtype.getAmmoType() == AmmoType.T_AC_ROTARY) {</span>
<span class="nc" id="L12008">                m.setMode(&quot;6-shot&quot;);</span>
<span class="nc" id="L12009">                m.setModeSwitchable(false);</span>
<span class="nc bnc" id="L12010" title="All 2 branches missed.">            } else if (wtype.getAmmoType() == AmmoType.T_AC_ULTRA) {</span>
<span class="nc" id="L12011">                m.setMode(&quot;Ultra&quot;);</span>
<span class="nc" id="L12012">                m.setModeSwitchable(false);</span>
            }
<span class="nc" id="L12014">        }</span>
<span class="nc" id="L12015">    }</span>

    /**
     * Set the retractable blade in the given location as extended Takes the
     * first piece of appropriate equipment
     */
    public void extendBlade(int loc) {
<span class="nc bnc" id="L12022" title="All 2 branches missed.">        for (Mounted m : getEquipment()) {</span>
<span class="nc bnc" id="L12023" title="All 6 branches missed.">            if ((m.getLocation() == loc) &amp;&amp; !m.isDestroyed() &amp;&amp; !m.isBreached()</span>
<span class="nc bnc" id="L12024" title="All 2 branches missed.">                &amp;&amp; (m.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L12025" title="All 2 branches missed.">                &amp;&amp; m.getType().hasFlag(MiscType.F_CLUB)</span>
<span class="nc bnc" id="L12026" title="All 2 branches missed.">                &amp;&amp; m.getType().hasSubType(MiscType.S_RETRACTABLE_BLADE)) {</span>
<span class="nc" id="L12027">                m.setMode(&quot;extended&quot;);</span>
<span class="nc" id="L12028">                return;</span>
            }
<span class="nc" id="L12030">        }</span>
<span class="nc" id="L12031">    }</span>

    /**
     * destroys the first retractable blade critical slot found
     */
    public void destroyRetractableBlade(int loc) {
        // check critical slots
<span class="nc bnc" id="L12038" title="All 2 branches missed.">        for (int i = 0; i &lt; this.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L12039">            CriticalSlot slot = getCritical(loc, i);</span>
            // ignore empty &amp; system slots
<span class="nc bnc" id="L12041" title="All 2 branches missed.">            if ((slot == null)</span>
<span class="nc bnc" id="L12042" title="All 2 branches missed.">                || (slot.getType() != CriticalSlot.TYPE_EQUIPMENT)) {</span>
<span class="nc" id="L12043">                continue;</span>
            }
<span class="nc" id="L12045">            Mounted m = slot.getMount();</span>
<span class="nc bnc" id="L12046" title="All 6 branches missed.">            if ((m.getLocation() == loc) &amp;&amp; !m.isHit() &amp;&amp; !m.isBreached()</span>
<span class="nc bnc" id="L12047" title="All 2 branches missed.">                &amp;&amp; (m.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L12048" title="All 2 branches missed.">                &amp;&amp; m.getType().hasFlag(MiscType.F_CLUB)</span>
<span class="nc bnc" id="L12049" title="All 2 branches missed.">                &amp;&amp; m.getType().hasSubType(MiscType.S_RETRACTABLE_BLADE)) {</span>
<span class="nc" id="L12050">                slot.setHit(true);</span>
<span class="nc" id="L12051">                m.setHit(true);</span>
<span class="nc" id="L12052">                return;</span>
            }
        }
<span class="nc" id="L12055">    }</span>

    public TeleMissileTracker getTMTracker() {
<span class="nc" id="L12058">        return tmTracker;</span>
    }

    public void setGrappled(int id, boolean attacker) {
        // This is implemented in subclasses.  Do nothing in general.
<span class="nc" id="L12063">    }</span>

    public boolean isGrappleAttacker() {
<span class="nc" id="L12066">        return false;</span>
    }

    public int getGrappled() {
<span class="nc" id="L12070">        return Entity.NONE;</span>
    }

    public boolean isChainWhipGrappled() {
<span class="nc bnc" id="L12074" title="All 2 branches missed.">        return getGrappleSide() != Entity.GRAPPLE_BOTH;</span>
    }

    public boolean isGrappledThisRound() {
<span class="nc" id="L12078">        return false;</span>
    }

    public void setGrappledThisRound(boolean grappled) {
        // Do nothing here, set in base classes
<span class="nc" id="L12083">    }</span>

    public void setGameOptions() {

<span class="nc bnc" id="L12087" title="All 2 branches missed.">        if (game == null) {</span>
<span class="nc" id="L12088">            return;</span>
        }

<span class="nc" id="L12091">        final GameOptions gameOpts = game.getOptions();</span>

        // if the small craft does not already have ECM, then give them a single
        // hex ECM so they can change the mode
        // FIXME: This is a really hacky way to to do it that results in small
        // craft having
        // ECM when the rule is not in effect and in non-space maps
<span class="nc bnc" id="L12098" title="All 4 branches missed.">        if ((this instanceof SmallCraft) &amp;&amp; !(this instanceof Dropship)</span>
<span class="nc bnc" id="L12099" title="All 4 branches missed.">            &amp;&amp; !hasActiveECM() &amp;&amp; isMilitary()) {</span>
            try {
<span class="nc bnc" id="L12101" title="All 2 branches missed.">                String prefix = isClan() ? &quot;CL&quot; : &quot;IS&quot;;</span>
<span class="nc" id="L12102">                this.addEquipment(</span>
<span class="nc" id="L12103">                        EquipmentType.get(prefix + BattleArmor.SINGLE_HEX_ECM),</span>
                        Aero.LOC_NOSE, false);
<span class="nc" id="L12105">            } catch (LocationFullException ex) {</span>
                // ignore
<span class="nc" id="L12107">            }</span>
        }

<span class="nc bnc" id="L12110" title="All 2 branches missed.">        for (Mounted mounted : getWeaponList()) {</span>
<span class="nc bnc" id="L12111" title="All 2 branches missed.">            if (mounted.getType() instanceof Weapon)</span>
<span class="nc" id="L12112">                ((Weapon) mounted.getType()).adaptToGameOptions(game.getOptions());</span>
<span class="nc" id="L12113">                mounted.setModesForMapType();</span>
<span class="nc" id="L12114">        }</span>

<span class="nc bnc" id="L12116" title="All 2 branches missed.">        for (Mounted misc : getMisc()) {</span>
<span class="nc bnc" id="L12117" title="All 6 branches missed.">            if (misc.getType().hasFlag(MiscType.F_BAP)</span>
                &amp;&amp; (this instanceof Aero || this instanceof LandAirMech)
<span class="nc bnc" id="L12119" title="All 2 branches missed.">                &amp;&amp; gameOpts.booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ECM)) {</span>
<span class="nc" id="L12120">                ArrayList&lt;String&gt; modes = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L12121">                String[] stringArray = {};</span>
<span class="nc" id="L12122">                modes.add(&quot;Short&quot;);</span>
<span class="nc" id="L12123">                modes.add(&quot;Medium&quot;);</span>
<span class="nc" id="L12124">                ((MiscType) misc.getType())</span>
<span class="nc" id="L12125">                        .setModes(modes.toArray(stringArray));</span>
<span class="nc" id="L12126">                ((MiscType) misc.getType()).setInstantModeSwitch(false);</span>
            }
<span class="nc bnc" id="L12128" title="All 2 branches missed.">            if (misc.getType().hasFlag(MiscType.F_ECM)) {</span>
<span class="nc" id="L12129">                ArrayList&lt;String&gt; modes = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L12130">                modes.add(&quot;ECM&quot;);</span>
<span class="nc" id="L12131">                String[] stringArray = {};</span>
<span class="nc bnc" id="L12132" title="All 2 branches missed.">                if (gameOpts.booleanOption(OptionsConstants.ADVANCED_TACOPS_ECCM)) {</span>
<span class="nc" id="L12133">                    modes.add(&quot;ECCM&quot;);</span>
<span class="nc bnc" id="L12134" title="All 2 branches missed.">                    if (misc.getType().hasFlag(MiscType.F_ANGEL_ECM)) {</span>
<span class="nc" id="L12135">                        modes.add(&quot;ECM &amp; ECCM&quot;);</span>
                    }
<span class="nc bnc" id="L12137" title="All 6 branches missed.">                } else if (gameOpts.booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ECM)</span>
                           &amp;&amp; (this instanceof Aero || this instanceof LandAirMech)) {
<span class="nc" id="L12139">                    modes.add(&quot;ECCM&quot;);</span>
<span class="nc bnc" id="L12140" title="All 2 branches missed.">                    if (misc.getType().hasFlag(MiscType.F_ANGEL_ECM)) {</span>
<span class="nc" id="L12141">                        modes.add(&quot;ECM &amp; ECCM&quot;);</span>
                    }
                }
<span class="nc bnc" id="L12144" title="All 2 branches missed.">                if (gameOpts.booleanOption(OptionsConstants.ADVANCED_TACOPS_GHOST_TARGET)) {</span>
<span class="nc bnc" id="L12145" title="All 2 branches missed.">                    if (misc.getType().hasFlag(MiscType.F_ANGEL_ECM)) {</span>
<span class="nc" id="L12146">                        modes.add(&quot;ECM &amp; Ghost Targets&quot;);</span>
<span class="nc bnc" id="L12147" title="All 2 branches missed.">                        if (gameOpts.booleanOption(OptionsConstants.ADVANCED_TACOPS_ECCM)) {</span>
<span class="nc" id="L12148">                            modes.add(&quot;ECCM &amp; Ghost Targets&quot;);</span>
                        }
                    } else {
<span class="nc" id="L12151">                        modes.add(&quot;Ghost Targets&quot;);</span>
                    }
                }
<span class="nc" id="L12154">                ((MiscType) misc.getType())</span>
<span class="nc" id="L12155">                        .setModes(modes.toArray(stringArray));</span>
            }
<span class="nc" id="L12157">        }</span>

<span class="nc" id="L12159">    }</span>

    public void setGrappleSide(int side) {
        // This is implemented in subclasses, do nothing in general
<span class="nc" id="L12163">    }</span>

    public int getGrappleSide() {
<span class="nc" id="L12166">        return Entity.NONE;</span>
    }

    public boolean hasFunctionalArmAES(int location) {
<span class="nc" id="L12170">        return false;</span>
    }

    public boolean hasFunctionalLegAES() {
<span class="nc" id="L12174">        return false;</span>
    }

    public boolean isEvading() {
<span class="nc" id="L12178">        return evading;</span>
    }

    public void setEvading(boolean evasion) {
<span class="nc" id="L12182">        evading = evasion;</span>
<span class="nc" id="L12183">    }</span>

    public int getEvasionBonus() {
<span class="nc bnc" id="L12186" title="All 2 branches missed.">        if (isProne()) {</span>
<span class="nc" id="L12187">            return 0;</span>
        }

<span class="nc bnc" id="L12190" title="All 2 branches missed.">        if (this instanceof SmallCraft) {</span>
<span class="nc" id="L12191">            return 2;</span>
<span class="nc bnc" id="L12192" title="All 2 branches missed.">        } else if (this instanceof Jumpship) {</span>
<span class="nc" id="L12193">            return 1;</span>
<span class="nc bnc" id="L12194" title="All 2 branches missed.">        } else if (isAero()) {</span>
<span class="nc" id="L12195">            return 3;</span>
        } else {
<span class="nc bnc" id="L12197" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_SKILLED_EVASION)) {</span>
<span class="nc" id="L12198">                int piloting = crew.getPiloting();</span>
<span class="nc bnc" id="L12199" title="All 2 branches missed.">                if (piloting &lt; 2) {</span>
<span class="nc" id="L12200">                    return 3;</span>
<span class="nc bnc" id="L12201" title="All 2 branches missed.">                } else if (piloting &lt; 4) {</span>
<span class="nc" id="L12202">                    return 2;</span>
<span class="nc bnc" id="L12203" title="All 2 branches missed.">                } else if (piloting &lt; 6) {</span>
<span class="nc" id="L12204">                    return 1;</span>
                }
<span class="nc" id="L12206">            } else {</span>
<span class="nc" id="L12207">                return 1;</span>
            }
        }
<span class="nc" id="L12210">        return 0;</span>
    }

    public void setCarefulStand(boolean stand) {
<span class="nc" id="L12214">        isCarefulStanding = stand;</span>
<span class="nc" id="L12215">    }</span>

    public boolean isCarefulStand() {
<span class="nc" id="L12218">        return false;</span>
    }

    public Vector&lt;Sensor&gt; getSensors() {
<span class="nc" id="L12222">        return sensors;</span>
    }

    public Sensor getActiveSensor() {
<span class="nc" id="L12226">        return activeSensor;</span>
    }

    public Sensor getNextSensor() {
<span class="nc" id="L12230">        return nextSensor;</span>
    }

    public void setNextSensor(Sensor s) {
<span class="nc" id="L12234">        nextSensor = s;</span>
<span class="nc" id="L12235">    }</span>

    public int getSensorCheck() {
<span class="nc" id="L12238">        return sensorCheck;</span>
    }

    /**
     * A method to determine if an aero has suffered 3 sensor hits.
     * When double-blind is on, this affects both standard visibility and sensor rolls
     */
    public boolean isAeroSensorDestroyed() {
<span class="nc" id="L12246">        return false;</span>
    }

    public boolean hasModularArmor() {
<span class="nc" id="L12250">        return hasModularArmor(-1);</span>
    }

    public boolean hasModularArmor(int loc) {
<span class="nc bnc" id="L12254" title="All 2 branches missed.">        for (Mounted mount : this.getEquipment()) {</span>
<span class="nc bnc" id="L12255" title="All 4 branches missed.">            if ((loc == -1) || (mount.getLocation() == loc)) {</span>
<span class="nc bnc" id="L12256" title="All 2 branches missed.">                if (!mount.isDestroyed()</span>
<span class="nc bnc" id="L12257" title="All 2 branches missed.">                    &amp;&amp; (mount.getType() instanceof MiscType)</span>
<span class="nc" id="L12258">                    &amp;&amp; ((MiscType) mount.getType())</span>
<span class="nc bnc" id="L12259" title="All 2 branches missed.">                        .hasFlag(MiscType.F_MODULAR_ARMOR)) {</span>
<span class="nc" id="L12260">                    return true;</span>
                }
            }
<span class="nc" id="L12263">        }</span>

<span class="nc" id="L12265">        return false;</span>
    }

    public int getDamageReductionFromModularArmor(HitData hit, int damage,
                                                  Vector&lt;Report&gt; vDesc) {
<span class="nc" id="L12270">        int loc = hit.getLocation();</span>
<span class="nc bnc" id="L12271" title="All 2 branches missed.">        if (!hasModularArmor(loc)) {</span>
<span class="nc" id="L12272">            return damage;</span>
        }
<span class="nc bnc" id="L12274" title="All 2 branches missed.">        for (Mounted mount : this.getEquipment()) {</span>
<span class="nc bnc" id="L12275" title="All 2 branches missed.">            if ((mount.getLocation() == loc)</span>
<span class="nc bnc" id="L12276" title="All 2 branches missed.">                &amp;&amp; !mount.isDestroyed()</span>
<span class="nc bnc" id="L12277" title="All 2 branches missed.">                &amp;&amp; (mount.getType() instanceof MiscType)</span>
<span class="nc" id="L12278">                &amp;&amp; ((MiscType) mount.getType())</span>
<span class="nc bnc" id="L12279" title="All 10 branches missed.">                    .hasFlag(MiscType.F_MODULAR_ARMOR)</span>
                // On 'Mech torsos only, modular armor covers either front
                // or rear, as mounted.
                &amp;&amp; (!(this instanceof Mech)
                    || !((loc == Mech.LOC_CT) || (loc == Mech.LOC_LT) || (loc == Mech.LOC_RT)) || (hit
<span class="nc" id="L12284">                                                                                                           .isRear()</span>
                                                                                                   == mount
<span class="nc bnc" id="L12286" title="All 2 branches missed.">                    .isRearMounted()))) {</span>

<span class="nc" id="L12288">                int damageAbsorption = mount.getBaseDamageCapacity()</span>
<span class="nc" id="L12289">                                       - mount.getDamageTaken();</span>
<span class="nc bnc" id="L12290" title="All 2 branches missed.">                if (damageAbsorption &gt; damage) {</span>
<span class="nc" id="L12291">                    mount.damageTaken += damage;</span>
<span class="nc" id="L12292">                    Report r = new Report(3535);</span>
<span class="nc" id="L12293">                    r.subject = getId();</span>
<span class="nc" id="L12294">                    r.add(damage);</span>
<span class="nc" id="L12295">                    r.indent(1);</span>
<span class="nc" id="L12296">                    r.newlines = 0;</span>
<span class="nc" id="L12297">                    vDesc.addElement(r);</span>
<span class="nc" id="L12298">                    Report.addNewline(vDesc);</span>

<span class="nc" id="L12300">                    return 0;</span>
                }

<span class="nc bnc" id="L12303" title="All 2 branches missed.">                if (damageAbsorption == damage) {</span>
<span class="nc" id="L12304">                    Report.addNewline(vDesc);</span>
<span class="nc" id="L12305">                    Report r = new Report(3535);</span>
<span class="nc" id="L12306">                    r.subject = getId();</span>
<span class="nc" id="L12307">                    r.add(damage);</span>
<span class="nc" id="L12308">                    r.indent(1);</span>
<span class="nc" id="L12309">                    r.newlines = 0;</span>
<span class="nc" id="L12310">                    vDesc.addElement(r);</span>
<span class="nc" id="L12311">                    r = new Report(3536);</span>
<span class="nc" id="L12312">                    r.subject = getId();</span>
<span class="nc" id="L12313">                    r.indent();</span>
<span class="nc" id="L12314">                    vDesc.addElement(r);</span>

<span class="nc" id="L12316">                    mount.damageTaken += damage;</span>
<span class="nc" id="L12317">                    mount.setHit(true);</span>
<span class="nc" id="L12318">                    return 0;</span>
                }

<span class="nc bnc" id="L12321" title="All 2 branches missed.">                if (damageAbsorption &lt; damage) {</span>
<span class="nc" id="L12322">                    Report.addNewline(vDesc);</span>
<span class="nc" id="L12323">                    Report r = new Report(3535);</span>
<span class="nc" id="L12324">                    r.subject = getId();</span>
<span class="nc" id="L12325">                    r.add(damageAbsorption);</span>
<span class="nc" id="L12326">                    r.indent(1);</span>
<span class="nc" id="L12327">                    r.newlines = 0;</span>
<span class="nc" id="L12328">                    vDesc.addElement(r);</span>
<span class="nc" id="L12329">                    r = new Report(3536);</span>
<span class="nc" id="L12330">                    r.subject = getId();</span>
<span class="nc" id="L12331">                    r.indent(1);</span>
<span class="nc" id="L12332">                    vDesc.addElement(r);</span>

<span class="nc" id="L12334">                    damage -= mount.baseDamageAbsorptionRate</span>
                              - mount.damageTaken;
<span class="nc" id="L12336">                    mount.damageTaken = mount.baseDamageAbsorptionRate;</span>
<span class="nc" id="L12337">                    mount.setDestroyed(true);</span>
<span class="nc" id="L12338">                    mount.setHit(true);</span>
                }
            }

<span class="nc" id="L12342">        }</span>

<span class="nc" id="L12344">        return damage;</span>
    }

    public int getGhostTargetRoll() {
<span class="nc" id="L12348">        return ghostTargetRoll;</span>
    }

    public int getGhostTargetRollMoS() {
<span class="nc" id="L12352">        return ghostTargetRoll - (getCrew().getSensorOps() + 2);</span>
    }

    public int getGhostTargetOverride() {
<span class="nc" id="L12356">        return ghostTargetOverride;</span>
    }

    public int getCoolantFailureAmount() {
<span class="nc" id="L12360">        return 0;</span>
    }

    public void addCoolantFailureAmount(int amount) {
        // This is implemented in subclasses, do nothing in general
<span class="nc" id="L12365">    }</span>

    public void resetCoolantFailureAmount() {
        // This is implemented in subclasses, do nothing in general
<span class="nc" id="L12369">    }</span>

    /**
     * @return the tonnage of additional mounted communications equipment
     */
    public int getExtraCommGearTons() {
<span class="nc" id="L12375">        int i = 0;</span>
<span class="nc bnc" id="L12376" title="All 2 branches missed.">        for (Mounted mounted : miscList) {</span>
<span class="nc bnc" id="L12377" title="All 2 branches missed.">            if (mounted.getType().hasFlag(MiscType.F_COMMUNICATIONS)</span>
<span class="nc bnc" id="L12378" title="All 2 branches missed.">                &amp;&amp; !mounted.isInoperable()) {</span>
<span class="nc" id="L12379">                i += mounted.getTonnage();</span>
            }
<span class="nc" id="L12381">        }</span>
<span class="nc" id="L12382">        return i;</span>
    }

    /**
     * Returns information (range, location, strength) about ECM if the unit
     * has active ECM or null if it doesn't.  In the case of multiple ECCM
     * system, the best one takes precendence, as a unit can only have one
     * active ECCM at a time.
     *
     * @return
     */
    public ECMInfo getECMInfo() {
        // If we don't have a position, ECM doesn't have an effect
<span class="nc bnc" id="L12395" title="All 6 branches missed.">        if ((getPosition() == null) || isShutDown() || isStealthOn()</span>
<span class="nc bnc" id="L12396" title="All 2 branches missed.">            || (getTransportId() != Entity.NONE)) {</span>
<span class="nc" id="L12397">            return null;</span>
        }

        // E(C)CM operates differently in space (SO pg 110)
<span class="nc bnc" id="L12401" title="All 2 branches missed.">        if (game.getBoard().inSpace()) {</span>
            // No ECM in space unless SO rule is on
<span class="nc bnc" id="L12403" title="All 2 branches missed.">            if (!game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ECM)) {</span>
<span class="nc" id="L12404">                return null;</span>
            }
<span class="nc" id="L12406">            int range = getECMRange();</span>
<span class="nc bnc" id="L12407" title="All 4 branches missed.">            if ((range &gt;= 0) &amp;&amp; hasActiveECM()) {</span>
<span class="nc" id="L12408">                return new ECMInfo(range, 1, this);</span>
            } else {
<span class="nc" id="L12410">                return null;</span>
            }
        }

        // ASF ECM only has an effect if the unit is NOE
<span class="nc bnc" id="L12415" title="All 4 branches missed.">        if (isAirborne() &amp;&amp; !isNOE()) {</span>
<span class="nc" id="L12416">            return null;</span>
        }

<span class="nc" id="L12419">        ECMInfo bestInfo = null;</span>
        Comparator&lt;ECMInfo&gt; ecmComparator;
<span class="nc" id="L12421">        ecmComparator = new ECMInfo.ECCMComparator();</span>
<span class="nc bnc" id="L12422" title="All 2 branches missed.">        for (Mounted m : getMisc()) {</span>
            // Ignore if inoperable
<span class="nc bnc" id="L12424" title="All 2 branches missed.">            if (m.isInoperable()) {</span>
<span class="nc" id="L12425">                continue;</span>
            }
<span class="nc" id="L12427">            ECMInfo newInfo = null;</span>
            // Angel ECM
<span class="nc bnc" id="L12429" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_ANGEL_ECM)) {</span>
<span class="nc bnc" id="L12430" title="All 2 branches missed.">                if (m.curMode().equals(&quot;ECM&quot;)) {</span>
<span class="nc" id="L12431">                    newInfo = new ECMInfo(6, 0, this);</span>
<span class="nc" id="L12432">                    newInfo.setAngelECMStrength(1);</span>
<span class="nc bnc" id="L12433" title="All 2 branches missed.">                } else if (m.curMode().equals(&quot;ECM &amp; ECCM&quot;)</span>
<span class="nc bnc" id="L12434" title="All 2 branches missed.">                           || m.curMode().equals(&quot;ECM &amp; Ghost Targets&quot;)) {</span>
<span class="nc" id="L12435">                    newInfo = new ECMInfo(6, 1, this);</span>
                    // Doesn't count as Angel ECM
                }
                // BA Angel ECM has a shorter range
<span class="nc bnc" id="L12439" title="All 4 branches missed.">                if ((newInfo != null) &amp;&amp; (this instanceof BattleArmor)) {</span>
<span class="nc" id="L12440">                    newInfo.setRange(2);</span>
                }
                // Anything that's not Angel ECM
<span class="nc bnc" id="L12443" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_ECM)</span>
<span class="nc bnc" id="L12444" title="All 2 branches missed.">                       &amp;&amp; m.curMode().equals(&quot;ECM&quot;)) {</span>
<span class="nc" id="L12445">                int range = 6;</span>
<span class="nc bnc" id="L12446" title="All 2 branches missed.">                if (m.getType().hasFlag(MiscType.F_SINGLE_HEX_ECM)) {</span>
<span class="nc" id="L12447">                    range = 0;</span>
<span class="nc bnc" id="L12448" title="All 2 branches missed.">                } else if (m.getType().hasFlag(MiscType.F_EW_EQUIPMENT)</span>
<span class="nc bnc" id="L12449" title="All 2 branches missed.">                           || m.getType().hasFlag(MiscType.F_NOVA)</span>
<span class="nc bnc" id="L12450" title="All 2 branches missed.">                           || m.getType().hasFlag(MiscType.F_WATCHDOG)) {</span>
<span class="nc" id="L12451">                    range = 3;</span>
                }
<span class="nc" id="L12453">                newInfo = new ECMInfo(range, 1, this);</span>
<span class="nc" id="L12454">                newInfo.setECMNova(m.getType().hasFlag(MiscType.F_NOVA));</span>
            }
            // In some type of ECM mode...
<span class="nc bnc" id="L12457" title="All 2 branches missed.">            if (newInfo != null) {</span>
<span class="nc bnc" id="L12458" title="All 2 branches missed.">                if ((bestInfo == null)</span>
<span class="nc bnc" id="L12459" title="All 2 branches missed.">                    || (ecmComparator.compare(newInfo, bestInfo) &gt; 0)) {</span>
<span class="nc" id="L12460">                    bestInfo = newInfo;</span>
                }
            }
<span class="nc" id="L12463">        }</span>
<span class="nc" id="L12464">        return bestInfo;</span>
    }

    /**
     * Returns information (range, location, strength) about ECCM if the unit
     * has active ECCM or null if it doesn't.  In the case of multiple ECCM
     * system, the best one takes precendence, as a unit can only have one
     * active ECCM at a time.
     *
     * @return
     */
    public ECMInfo getECCMInfo() {
        // If we don't have a position, ECM doesn't have an effect
<span class="nc bnc" id="L12477" title="All 6 branches missed.">        if ((getPosition() == null) || isShutDown() || isStealthOn()</span>
<span class="nc bnc" id="L12478" title="All 2 branches missed.">            || (getTransportId() != Entity.NONE)) {</span>
<span class="nc" id="L12479">            return null;</span>
        }
        // E(C)CM operates differently in space (SO pg 110)
<span class="nc bnc" id="L12482" title="All 2 branches missed.">        if (game.getBoard().inSpace()) {</span>
            // No ECCM in space unless SO rule is on
<span class="nc bnc" id="L12484" title="All 2 branches missed.">            if (!game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ECM)) {</span>
<span class="nc" id="L12485">                return null;</span>
            }
<span class="nc" id="L12487">            int bapRange = getBAPRange();</span>
<span class="nc" id="L12488">            int range = getECMRange();</span>
<span class="nc" id="L12489">            ECMInfo eccmInfo = new ECMInfo(0, 0, this);</span>
<span class="nc" id="L12490">            eccmInfo.setECCMStrength(1);</span>
<span class="nc bnc" id="L12491" title="All 2 branches missed.">            if (bapRange &gt; 0) {</span>
<span class="nc" id="L12492">                eccmInfo.setRange(bapRange);</span>
                // Medium range band only effects the nose, so set direction
<span class="nc bnc" id="L12494" title="All 2 branches missed.">                if (bapRange &gt; 6) {</span>
<span class="nc" id="L12495">                    eccmInfo.setDirection(getFacing());</span>
                }
<span class="nc bnc" id="L12497" title="All 4 branches missed.">            } else if ((range &gt;= 0) &amp;&amp; hasActiveECCM()) {</span>
<span class="nc" id="L12498">                eccmInfo.setRange(range);</span>
            } else {
<span class="nc" id="L12500">                eccmInfo = null;</span>
            }
<span class="nc" id="L12502">            return eccmInfo;</span>
        }

<span class="nc" id="L12505">        ECMInfo bestInfo = null;</span>
        Comparator&lt;ECMInfo&gt; ecmComparator;
<span class="nc" id="L12507">        ecmComparator = new ECMInfo.ECCMComparator();</span>
<span class="nc bnc" id="L12508" title="All 2 branches missed.">        for (Mounted m : getMisc()) {</span>
<span class="nc" id="L12509">            ECMInfo newInfo = null;</span>
<span class="nc bnc" id="L12510" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_COMMUNICATIONS)</span>
<span class="nc bnc" id="L12511" title="All 2 branches missed.">                &amp;&amp; m.curMode().equals(&quot;ECCM&quot;)) {</span>
<span class="nc bnc" id="L12512" title="All 2 branches missed.">                if ((getTotalCommGearTons() &gt; 3)) {</span>
<span class="nc" id="L12513">                    newInfo = new ECMInfo(6, 0.5, this);</span>
                }
<span class="nc bnc" id="L12515" title="All 2 branches missed.">                if ((getTotalCommGearTons() &gt; 6)) {</span>
<span class="nc" id="L12516">                    newInfo = new ECMInfo(6, 1, this);</span>
                }
            }
            // Angel ECM
<span class="nc bnc" id="L12520" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_ANGEL_ECM)) {</span>
<span class="nc bnc" id="L12521" title="All 2 branches missed.">                if (m.curMode().equals(&quot;ECCM&quot;)) {</span>
<span class="nc" id="L12522">                    newInfo = new ECMInfo(6, 0, this);</span>
<span class="nc" id="L12523">                    newInfo.setAngelECCMStrength(1);</span>
<span class="nc bnc" id="L12524" title="All 2 branches missed.">                } else if (m.curMode().equals(&quot;ECM &amp; ECCM&quot;)</span>
<span class="nc bnc" id="L12525" title="All 2 branches missed.">                           || m.curMode().equals(&quot;ECCM &amp; Ghost Targets&quot;)) {</span>
<span class="nc" id="L12526">                    newInfo = new ECMInfo(6, 1, this);</span>
                    // Doesn't count as Angel
                }
                // BA Angel ECM has a shorter range
<span class="nc bnc" id="L12530" title="All 4 branches missed.">                if ((newInfo != null) &amp;&amp; (this instanceof BattleArmor)) {</span>
<span class="nc" id="L12531">                    newInfo.setRange(2);</span>
                }
                // Anything that's not Angel ECM
<span class="nc bnc" id="L12534" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_ECM)</span>
<span class="nc bnc" id="L12535" title="All 2 branches missed.">                       &amp;&amp; m.curMode().equals(&quot;ECCM&quot;)) {</span>
<span class="nc" id="L12536">                int range = 6;</span>
<span class="nc bnc" id="L12537" title="All 2 branches missed.">                if (m.getType().hasFlag(MiscType.F_SINGLE_HEX_ECM)) {</span>
<span class="nc" id="L12538">                    range = 0;</span>
<span class="nc bnc" id="L12539" title="All 2 branches missed.">                } else if (m.getType().hasFlag(MiscType.F_EW_EQUIPMENT)</span>
<span class="nc bnc" id="L12540" title="All 2 branches missed.">                           || m.getType().hasFlag(MiscType.F_NOVA)</span>
<span class="nc bnc" id="L12541" title="All 2 branches missed.">                           || m.getType().hasFlag(MiscType.F_WATCHDOG)) {</span>
<span class="nc" id="L12542">                    range = 3;</span>
                }
<span class="nc" id="L12544">                newInfo = new ECMInfo(range, 0, this);</span>
<span class="nc" id="L12545">                newInfo.setECCMStrength(1);</span>
            }
            // In some type of ECCM mode...
<span class="nc bnc" id="L12548" title="All 2 branches missed.">            if (newInfo != null) {</span>
<span class="nc bnc" id="L12549" title="All 2 branches missed.">                if ((bestInfo == null)</span>
<span class="nc bnc" id="L12550" title="All 2 branches missed.">                    || (ecmComparator.compare(newInfo, bestInfo) &gt; 0)) {</span>
<span class="nc" id="L12551">                    bestInfo = newInfo;</span>
                }
            }
<span class="nc" id="L12554">        }</span>
<span class="nc" id="L12555">        return bestInfo;</span>
    }

    /**
     * @return the strength of the ECM field this unit emits
     */
    public double getECMStrength() {
<span class="nc" id="L12562">        int strength = 0;</span>
<span class="nc bnc" id="L12563" title="All 2 branches missed.">        for (Mounted m : getMisc()) {</span>
<span class="nc bnc" id="L12564" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_ANGEL_ECM)) {</span>
<span class="nc bnc" id="L12565" title="All 2 branches missed.">                if (m.curMode().equals(&quot;ECM&quot;)) {</span>
<span class="nc" id="L12566">                    strength = 2;</span>
<span class="nc bnc" id="L12567" title="All 2 branches missed.">                } else if ((strength &lt; 1)</span>
<span class="nc bnc" id="L12568" title="All 2 branches missed.">                           &amp;&amp; (m.curMode().equals(&quot;ECM &amp; ECCM&quot;) || m.curMode()</span>
<span class="nc bnc" id="L12569" title="All 2 branches missed.">                                                                    .equals(&quot;ECM &amp; Ghost Targets&quot;))) {</span>
<span class="nc" id="L12570">                    strength = 1;</span>
                }
<span class="nc bnc" id="L12572" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_ECM)</span>
<span class="nc bnc" id="L12573" title="All 4 branches missed.">                       &amp;&amp; m.curMode().equals(&quot;ECM&quot;) &amp;&amp; (strength &lt; 1)) {</span>
<span class="nc" id="L12574">                strength = 1;</span>
            }
<span class="nc" id="L12576">        }</span>
<span class="nc" id="L12577">        return strength;</span>
    }

    /**
     * @return the strength of the ECCM field this unit emits
     */
    public double getECCMStrength() {
<span class="nc" id="L12584">        double strength = 0;</span>
<span class="nc bnc" id="L12585" title="All 2 branches missed.">        for (Mounted m : getMisc()) {</span>
<span class="nc bnc" id="L12586" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_COMMUNICATIONS)) {</span>
<span class="nc bnc" id="L12587" title="All 4 branches missed.">                if ((getTotalCommGearTons() &gt; 3) &amp;&amp; (strength &lt; 0.5)) {</span>
<span class="nc" id="L12588">                    strength = 0.5;</span>
                }
<span class="nc bnc" id="L12590" title="All 4 branches missed.">                if ((getTotalCommGearTons() &gt; 6) &amp;&amp; (strength &lt; 1)) {</span>
<span class="nc" id="L12591">                    strength = 1;</span>
                }
            }
<span class="nc bnc" id="L12594" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_ANGEL_ECM)) {</span>
<span class="nc bnc" id="L12595" title="All 2 branches missed.">                if (m.curMode().equals(&quot;ECM&quot;)) {</span>
<span class="nc" id="L12596">                    strength = 2;</span>
<span class="nc bnc" id="L12597" title="All 2 branches missed.">                } else if ((strength &lt; 1)</span>
<span class="nc bnc" id="L12598" title="All 2 branches missed.">                           &amp;&amp; (m.curMode().equals(&quot;ECM &amp; ECCM&quot;) || m.curMode()</span>
<span class="nc bnc" id="L12599" title="All 2 branches missed.">                                                                    .equals(&quot;ECCM &amp; Ghost Targets&quot;))) {</span>
<span class="nc" id="L12600">                    strength = 1;</span>
                }
<span class="nc bnc" id="L12602" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_ECM)</span>
<span class="nc bnc" id="L12603" title="All 4 branches missed.">                       &amp;&amp; m.curMode().equals(&quot;ECCM&quot;) &amp;&amp; (strength &lt; 1)) {</span>
<span class="nc" id="L12604">                strength = 1;</span>
            }
<span class="nc" id="L12606">        }</span>
<span class="nc" id="L12607">        return strength;</span>
    }

    /**
     * @return the total tonnage of communications gear in this entity
     */
    public abstract int getTotalCommGearTons();

    /**
     * @return the initiative bonus this Entity grants for HQ
     */
    public int getHQIniBonus() {
<span class="nc" id="L12619">        int bonus = 0;</span>
<span class="nc bnc" id="L12620" title="All 2 branches missed.">        for (Mounted misc : getMisc()) {</span>
<span class="nc bnc" id="L12621" title="All 2 branches missed.">            if (misc.getType().hasFlag(MiscType.F_COMMUNICATIONS)</span>
<span class="nc bnc" id="L12622" title="All 4 branches missed.">                &amp;&amp; misc.curMode().equals(&quot;Default&quot;) &amp;&amp; !misc.isInoperable()) {</span>
<span class="nc bnc" id="L12623" title="All 2 branches missed.">                if (getTotalCommGearTons() &gt;= 3) {</span>
<span class="nc" id="L12624">                    bonus += 1;</span>
                }
<span class="nc bnc" id="L12626" title="All 2 branches missed.">                if (getTotalCommGearTons() &gt;= 7) {</span>
<span class="nc" id="L12627">                    bonus += 1;</span>
                }
                break;
            }
<span class="nc" id="L12631">        }</span>
<span class="nc" id="L12632">        return bonus;</span>
    }

    /**
     * @return the initiative bonus this Entity grants for MD implants
     */
	/*
	 * This has been removed in IO see pg 78
	 *
	 * public int getMDIniBonus() { if
	 * (crew.getOptions().booleanOption(OptionsConstants.MD_COMM_IMPLANT) ||
	 * crew.getOptions().booleanOption(OptionsConstants.MD_BOOST_COMM_IMPLANT))
	 * { return 1; } return 0; }
	 */

    /**
     * @return the initiative bonus this Entity grants for quirks
     */
    public int getQuirkIniBonus() {
        // command battlemech and and battle computer are not cumulative
<span class="nc bnc" id="L12652" title="All 4 branches missed.">        if (hasQuirk(OptionsConstants.QUIRK_POS_BATTLE_COMP) &amp;&amp; !getCrew().isDead()</span>
<span class="nc bnc" id="L12653" title="All 2 branches missed.">            &amp;&amp; !getCrew().isUnconscious()) {</span>
<span class="nc" id="L12654">            return 2;</span>
<span class="nc bnc" id="L12655" title="All 4 branches missed.">        } else if (hasQuirk(OptionsConstants.QUIRK_POS_COMMAND_MECH) &amp;&amp; !getCrew().isDead()</span>
<span class="nc bnc" id="L12656" title="All 2 branches missed.">                   &amp;&amp; !getCrew().isUnconscious()) {</span>
<span class="nc" id="L12657">            return 1;</span>
        }
<span class="nc" id="L12659">        return 0;</span>
    }

    /**
     * get the bay that ammo is associated with
     *
     * @param mammo
     * @return
     */
    public Mounted getBayByAmmo(Mounted mammo) {

<span class="nc bnc" id="L12670" title="All 2 branches missed.">        for (Mounted m : getWeaponBayList()) {</span>
<span class="nc bnc" id="L12671" title="All 2 branches missed.">            for (int bayAmmoId : m.getBayAmmo()) {</span>
<span class="nc" id="L12672">                Mounted bayammo = getEquipment(bayAmmoId);</span>
<span class="nc bnc" id="L12673" title="All 2 branches missed.">                if (bayammo == mammo) {</span>
<span class="nc" id="L12674">                    return m;</span>
                }
<span class="nc" id="L12676">            }</span>
<span class="nc" id="L12677">        }</span>
<span class="nc" id="L12678">        return null;</span>
    }

    /**
     * Return how many BA vibroclaws this &lt;code&gt;Entity&lt;/code&gt; is equipped with
     */
    public int getVibroClaws() {
        // generic entities can't carry vibroclaws
<span class="nc" id="L12686">        return 0;</span>
    }

    /**
     * shut this unit down due to a Taser attack
     *
     * @param turns   - the amount of rounds for which this Entity should be
     *                shutdown
     * @param baTaser - was this due to a BA taser?
     */
    public void taserShutdown(int turns, boolean baTaser) {
<span class="nc" id="L12697">        setShutDown(true);</span>
<span class="nc" id="L12698">        taserShutdownRounds = turns;</span>
<span class="nc" id="L12699">        shutdownByBATaser = baTaser;</span>
<span class="nc" id="L12700">    }</span>

    /**
     * get the number of rounds for which this unit should be shutdown by taser
     *
     * @return
     */
    public int getTaserShutdownRounds() {
<span class="nc" id="L12708">        return taserShutdownRounds;</span>
    }

    public void setTaserShutdownRounds(int rounds) {
<span class="nc" id="L12712">        taserShutdownRounds = rounds;</span>
<span class="nc" id="L12713">    }</span>

    public boolean isBATaserShutdown() {
<span class="nc" id="L12716">        return shutdownByBATaser;</span>
    }

    public void setBATaserShutdown(boolean value) {
<span class="nc" id="L12720">        shutdownByBATaser = value;</span>
<span class="nc" id="L12721">    }</span>

    public boolean getTaserInterferenceHeat() {
<span class="nc" id="L12724">        return taserInterferenceHeat;</span>
    }

    /**
     * set this entity to suffer from taser feedback
     *
     * @param rounds - the number of rounds to suffer from taserfeedback
     */
    public void setTaserFeedback(int rounds) {
<span class="nc" id="L12733">        taserFeedBackRounds = rounds;</span>
<span class="nc" id="L12734">    }</span>

    /**
     * get the rounds for which this entity suffers from taser feedback
     *
     * @return
     */
    public int getTaserFeedBackRounds() {
<span class="nc" id="L12742">        return taserFeedBackRounds;</span>
    }

    public void setTaserInterference(int value, int rounds, boolean heat) {
<span class="nc" id="L12746">        taserInterference = value;</span>
<span class="nc" id="L12747">        taserInterferenceRounds = rounds;</span>
<span class="nc" id="L12748">        taserInterferenceHeat = heat;</span>
<span class="nc" id="L12749">    }</span>

    public int getTaserInterference() {
<span class="nc" id="L12752">        return taserInterference;</span>
    }

    public int getTaserInterferenceRounds() {
<span class="nc" id="L12756">        return taserInterferenceRounds;</span>
    }

    public void addIMPHits(int missiles) {
        // effects last for only one turn.
<span class="nc" id="L12761">        impThisTurn += missiles;</span>
<span class="nc" id="L12762">        int heatAdd = missiles + impThisTurnHeatHelp;</span>
<span class="nc" id="L12763">        impThisTurnHeatHelp = heatAdd % 3;</span>
<span class="nc" id="L12764">        heatAdd = heatAdd - impThisTurnHeatHelp;</span>
<span class="nc" id="L12765">        heatAdd = heatAdd / 3;</span>
<span class="nc" id="L12766">        heatFromExternal += heatAdd;</span>
<span class="nc" id="L12767">    }</span>

    private void doNewRoundIMP() {
<span class="nc" id="L12770">        impLastTurn = impThisTurn;</span>
<span class="nc" id="L12771">        impThisTurn = 0;</span>
<span class="nc" id="L12772">    }</span>

    public int getIMPMoveMod() {
        // this function needs to be added to the MP
        // calculating functions
        //however, since no function calls super, it seems unneccesary complicated
        // really.
<span class="nc" id="L12779">        int max = 2;</span>
<span class="nc" id="L12780">        int modifier = impThisTurn + impLastTurn;</span>
<span class="nc" id="L12781">        modifier = modifier - (modifier % 3);</span>
<span class="nc" id="L12782">        modifier = modifier / 3;</span>
<span class="nc bnc" id="L12783" title="All 2 branches missed.">        return (modifier &gt; max) ? -max : -modifier;</span>
    }

    public int getIMPTHMod() {
<span class="nc" id="L12787">        int max = 2;</span>
<span class="nc" id="L12788">        int modifier = impThisTurn + impLastTurn;</span>
<span class="nc" id="L12789">        modifier = modifier - (modifier % 3);</span>
<span class="nc" id="L12790">        modifier = modifier / 3;</span>
<span class="nc bnc" id="L12791" title="All 2 branches missed.">        return (modifier &gt; max) ? max : modifier;</span>
    }

    /**
     * returns whether the unit is a military unit (as opposed to a civilian
     * unit).
     */
    public boolean isMilitary() {
<span class="nc" id="L12799">        return military;</span>
    }

    /**
     * is this entity a large craft? (dropship, jumpship, warship, or space
     * station)
     */
    public boolean isLargeCraft() {
<span class="nc bnc" id="L12807" title="All 4 branches missed.">        return (this instanceof Dropship) || (this instanceof Jumpship);</span>
    }

    /**
     * Do units loaded onto this entity still have active ECM/ECCM/etc.?
     */
    public boolean loadedUnitsHaveActiveECM() {
<span class="nc" id="L12814">        return false;</span>
    }

    /**
     * is this entity loaded into a fighter squadron?
     */
    public boolean isPartOfFighterSquadron() {
<span class="nc bnc" id="L12821" title="All 2 branches missed.">        if (game == null) {</span>
<span class="nc" id="L12822">            return false;</span>
        }
<span class="nc bnc" id="L12824" title="All 2 branches missed.">        if (conveyance == Entity.NONE) {</span>
<span class="nc" id="L12825">            return false;</span>
        }
<span class="nc" id="L12827">        return game.getEntity(conveyance) instanceof FighterSquadron;</span>
    }

    /**
     * Return a HTML string that describes the BV calculations
     *
     * @return a &lt;code&gt;String&lt;/code&gt; explaining the BV calculation
     */
    public String getBVText() {
<span class="nc bnc" id="L12836" title="All 2 branches missed.">        if (bvText == null) {</span>
<span class="nc" id="L12837">            return &quot;&quot;;</span>
        }

<span class="nc" id="L12840">        return bvText.toString();</span>
    }

    /**
     * Return the BAR-rating of this Entity's armor
     *
     * @return the BAR rating
     */
    public int getBARRating(int loc) {
        // normal armor has a BAR rating of 10
<span class="nc" id="L12850">        return 10;</span>
    }

    /**
     * does this Entity have BAR armor?
     *
     * @return
     */
    public boolean hasBARArmor(int loc) {
<span class="nc bnc" id="L12859" title="All 2 branches missed.">        return getBARRating(loc) &lt; 10;</span>
    }

    /**
     * Sets the barrier armor rating for support vehicles. Has no effect on other unit types.
     * @param rating
     */
<span class="nc" id="L12866">    public void setBARRating(int rating) {}</span>

    /**
     * does this entity have an armored chassis?
     *
     * @return
     */
    public boolean hasArmoredChassis() {
        // normal entities don't, subclasses should
        // override
<span class="nc" id="L12876">        return false;</span>
    }

    /**
     * does this &lt;code&gt;Entity&lt;/code&gt; have Environmental sealing? (only Support
     * Vehicles or IndustrialMechs should mount this)
     *
     * @return
     */
    public boolean hasEnvironmentalSealing() {
<span class="nc bnc" id="L12886" title="All 2 branches missed.">        for (Mounted misc : miscList) {</span>
<span class="nc bnc" id="L12887" title="All 2 branches missed.">            if (misc.getType().hasFlag(MiscType.F_ENVIRONMENTAL_SEALING)) {</span>
<span class="nc" id="L12888">                return true;</span>
            }
<span class="nc" id="L12890">        }</span>
<span class="nc" id="L12891">        return false;</span>
    }

    /**
     * Possibly do a ICE-Engine stall PSR (only intended for Mechs, both
     * Industrial and Battle).
     *
     * @param vPhaseReport the &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt; containing the phase reports
     * @return a Vector&lt;Report&gt; containing the passed in reports, and any
     * additional ones
     */
    public Vector&lt;Report&gt; doCheckEngineStallRoll(Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L12903">        return vPhaseReport;</span>
    }

    /**
     * Check for unstalling of this Entity's engine (only used for ICE-powered
     * 'Mechs).
     *
     * @param vPhaseReport the &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt; containing the phase reports
     */
    public void checkUnstall(Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L12913">        return;</span>
    }

    public boolean hasArmoredEngine() {
<span class="nc" id="L12917">        return false;</span>
    }

    /**
     * Is this Entity's ICE Engine stalled?
     *
     * @return if this Entity's ICE engine is stalled
     */
    public boolean isStalled() {
<span class="nc" id="L12926">        return false;</span>
    }

    /**
     * is this a naval vessel on the surface of the water?
     */
    public boolean isSurfaceNaval() {
        // TODO: assuming submarines on the surface act like surface naval
        // vessels until rules clarified
        // http://www.classicbattletech.com/forums/index.php/topic,48987.0.html
<span class="nc bnc" id="L12936" title="All 4 branches missed.">        return (getElevation() == 0) &amp;&amp; isNaval();</span>
    }

    /**
     * Is this a naval vessel?
     * @return Whether it is or not.
     */
    public boolean isNaval() {
<span class="nc bnc" id="L12944" title="All 2 branches missed.">        return (getMovementMode() == EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L12945" title="All 2 branches missed.">                || (getMovementMode() == EntityMovementMode.HYDROFOIL)</span>
<span class="nc bnc" id="L12946" title="All 2 branches missed.">                || (getMovementMode() == EntityMovementMode.SUBMARINE);</span>
    }

    /**
     * used to set the source of the creation of this entity, i.e RS PPU Custom
     * what not Fluff for MMLab
     *
     * @param source
     */
    public void setSource(String source) {
<span class="nc bnc" id="L12956" title="All 2 branches missed.">        if (source != null) {</span>
<span class="nc" id="L12957">            this.source = source;</span>
        }
<span class="nc" id="L12959">    }</span>

    public String getSource() {
<span class="nc bnc" id="L12962" title="All 2 branches missed.">        if (source == null) {</span>
<span class="nc" id="L12963">            return &quot;&quot;;</span>
        }
<span class="nc" id="L12965">        return source;</span>
    }

    public synchronized void setQuirks(Quirks quirks) {
<span class="nc" id="L12969">        this.quirks = quirks;</span>
<span class="nc" id="L12970">    }</span>

    /**
     * Retrieves the quirks object for entity. DO NOT USE this to check boolean
     * options, as it will not check game options for quirks. Use
     * entity#hasQuirk instead
     *
     * @return
     */
    public synchronized Quirks getQuirks() {
<span class="nc" id="L12980">        return quirks;</span>
    }

    public boolean hasQuirk(String name) {
<span class="nc bnc" id="L12984" title="All 2 branches missed.">        if ((null == game)</span>
<span class="nc bnc" id="L12985" title="All 2 branches missed.">            || !game.getOptions().booleanOption(OptionsConstants.ADVANCED_STRATOPS_QUIRKS)) {</span>
<span class="nc" id="L12986">            return false;</span>
        }
<span class="nc" id="L12988">        return quirks.booleanOption(name);</span>
    }

    public PartialRepairs getPartialRepairs() {
<span class="nc" id="L12992">        return partReps;</span>
    }

    public void clearPartialRepairs() {
<span class="nc" id="L12996">        for (Enumeration&lt;IOptionGroup&gt; i = partReps.getGroups(); i</span>
<span class="nc bnc" id="L12997" title="All 2 branches missed.">                .hasMoreElements(); ) {</span>
<span class="nc" id="L12998">            IOptionGroup group = i.nextElement();</span>
<span class="nc" id="L12999">            for (Enumeration&lt;IOption&gt; j = group.getOptions(); j</span>
<span class="nc bnc" id="L13000" title="All 2 branches missed.">                    .hasMoreElements(); ) {</span>
<span class="nc" id="L13001">                IOption option = j.nextElement();</span>
<span class="nc" id="L13002">                option.clearValue();</span>
<span class="nc" id="L13003">            }</span>
<span class="nc" id="L13004">        }</span>

<span class="nc" id="L13006">    }</span>

    /**
     * count all the quirks for this unit, positive and negative
     */
    public int countQuirks() {
<span class="nc bnc" id="L13012" title="All 2 branches missed.">        if ((null == game)</span>
<span class="nc bnc" id="L13013" title="All 2 branches missed.">            || !game.getOptions().booleanOption(OptionsConstants.ADVANCED_STRATOPS_QUIRKS)) {</span>
<span class="nc" id="L13014">            return 0;</span>
        }

<span class="nc" id="L13017">        return quirks.count();</span>
    }

    public int countWeaponQuirks() {
<span class="nc" id="L13021">        int count = 0;</span>

<span class="nc bnc" id="L13023" title="All 2 branches missed.">        if ((null == game)</span>
<span class="nc bnc" id="L13024" title="All 2 branches missed.">            || !game.getOptions().booleanOption(OptionsConstants.ADVANCED_STRATOPS_QUIRKS)) {</span>
<span class="nc" id="L13025">            return count;</span>
        }

<span class="nc bnc" id="L13028" title="All 2 branches missed.">        for (Mounted m : getEquipment()) {</span>
<span class="nc" id="L13029">            count += m.countQuirks();</span>
<span class="nc" id="L13030">        }</span>
<span class="nc" id="L13031">        return count;</span>
    }

    public int countPartialRepairs() {
<span class="nc bnc" id="L13035" title="All 2 branches missed.">        if((null == game) ||</span>
<span class="nc bnc" id="L13036" title="All 2 branches missed.">                !game.getOptions().booleanOption(OptionsConstants.ADVANCED_STRATOPS_PARTIALREPAIRS)) {</span>
<span class="nc" id="L13037">            return 0;</span>
        }

<span class="nc" id="L13040">        return partReps.count();</span>
    }

    /**
     * count the quirks for this unit, for a given group name
     */
    public int countQuirks(String grpKey) {
<span class="nc bnc" id="L13047" title="All 2 branches missed.">        if ((null == game)</span>
<span class="nc bnc" id="L13048" title="All 2 branches missed.">            || !game.getOptions().booleanOption(OptionsConstants.ADVANCED_STRATOPS_QUIRKS)) {</span>
<span class="nc" id="L13049">            return 0;</span>
        }

<span class="nc" id="L13052">        return quirks.count(grpKey);</span>
    }

    /**
     * Returns a string of all the quirk &quot;codes&quot; for this entity, using sep as
     * the separator
     */
    public String getQuirkList(String sep) {
<span class="nc bnc" id="L13060" title="All 2 branches missed.">        if ((null == game)</span>
<span class="nc bnc" id="L13061" title="All 2 branches missed.">            || !game.getOptions().booleanOption(OptionsConstants.ADVANCED_STRATOPS_QUIRKS)) {</span>
<span class="nc" id="L13062">            return &quot;&quot;;</span>
        }

<span class="nc" id="L13065">        return quirks.getOptionList(sep);</span>
    }

    /**
     * Returns the forward firing arc for this entity - overrided by some units
     */
    public int getForwardArc() {
<span class="nc" id="L13072">        return Compute.ARC_FORWARD;</span>
    }

    /**
     * Returns the rear firing arc for this entity - overrided by some units
     */
    public int getRearArc() {
<span class="nc" id="L13079">        return Compute.ARC_REAR;</span>
    }

    /**
     * returns a description to the current sensing range of the active sensor
     */
    public String getSensorDesc() {
<span class="nc bnc" id="L13086" title="All 2 branches missed.">        if (null == getActiveSensor()) {</span>
<span class="nc" id="L13087">            return &quot;none&quot;;</span>
        }
<span class="nc" id="L13089">        int bracket = Compute.getSensorBracket(getSensorCheck());</span>
<span class="nc bnc" id="L13090" title="All 2 branches missed.">        if (isSpaceborne()) {</span>
<span class="nc" id="L13091">            bracket = Compute.getSensorBracket(7);</span>
        }
<span class="nc" id="L13093">        int range = getActiveSensor().getRangeByBracket();</span>
<span class="nc" id="L13094">        int groundRange = 0;</span>
<span class="nc bnc" id="L13095" title="All 2 branches missed.">        if (getActiveSensor().isBAP()) {</span>
<span class="nc" id="L13096">            groundRange = 2;</span>
        } else {
<span class="nc" id="L13098">            groundRange = 1;</span>
        }

        //ASF sensors change range when in space, so we do that here
<span class="nc bnc" id="L13102" title="All 2 branches missed.">        if (isSpaceborne()) {</span>
<span class="nc bnc" id="L13103" title="All 2 branches missed.">            if (getActiveSensor().getType() == Sensor.TYPE_AERO_SENSOR) {</span>
<span class="nc" id="L13104">                range = Sensor.ASF_RADAR_MAX_RANGE;</span>
            }

            //If Aero/Spacecraft sensors are destroyed while in space, the range is 0.
<span class="nc bnc" id="L13108" title="All 2 branches missed.">            if (isAeroSensorDestroyed()) {</span>
<span class="nc" id="L13109">                range = 0;</span>
            }
        }

        //Dropships using radar in an atmosphere need a range that's a bit more sensible
<span class="nc bnc" id="L13114" title="All 4 branches missed.">        if (hasETypeFlag(Entity.ETYPE_DROPSHIP) &amp;&amp; !isSpaceborne()) {</span>
<span class="nc bnc" id="L13115" title="All 2 branches missed.">            if (getActiveSensor().getType() == Sensor.TYPE_SPACECRAFT_RADAR) {</span>
<span class="nc" id="L13116">                range = Sensor.LC_RADAR_GROUND_RANGE;</span>
            }
        }

<span class="nc" id="L13120">        int maxSensorRange = bracket * range;</span>
<span class="nc" id="L13121">        int minSensorRange = Math.max((bracket - 1) * range, 0);</span>
<span class="nc" id="L13122">        int maxGroundSensorRange = bracket * groundRange;</span>
<span class="nc" id="L13123">        int minGroundSensorRange = Math.max((maxGroundSensorRange - 1), 0);</span>
<span class="nc bnc" id="L13124" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_INCLUSIVE_SENSOR_RANGE)) {</span>
<span class="nc" id="L13125">            minSensorRange = 0;</span>
<span class="nc" id="L13126">            minGroundSensorRange = 0;</span>
        }

<span class="nc bnc" id="L13129" title="All 4 branches missed.">        if (isAirborne() &amp;&amp; game.getBoard().onGround()) {</span>
<span class="nc" id="L13130">            return getActiveSensor().getDisplayName() + &quot; (&quot; + minSensorRange + &quot;-&quot;</span>
                    + maxSensorRange + &quot;)&quot; + &quot; {&quot; + ENTITY_AIR_TO_GROUND_SENSOR_RANGE + &quot; (&quot; + minGroundSensorRange + &quot;-&quot;
                    + maxGroundSensorRange + &quot;)}&quot;;
        }
<span class="nc" id="L13134">        return getActiveSensor().getDisplayName() + &quot; (&quot; + minSensorRange + &quot;-&quot;</span>
               + maxSensorRange + &quot;)&quot;;
    }

    @Override
    public boolean isAirborne() {
<span class="nc bnc" id="L13140" title="All 2 branches missed.">        return (getAltitude() &gt; 0)</span>
<span class="nc bnc" id="L13141" title="All 2 branches missed.">               || (getMovementMode() == EntityMovementMode.AERODYNE)</span>
<span class="nc bnc" id="L13142" title="All 2 branches missed.">               || (getMovementMode() == EntityMovementMode.SPHEROID);</span>
    }

    public boolean isSpaceborne() {
        // for now if you are in space, you are spaceborne, but this will become
        // more complicated when
        // we start adding multiple maps to the same game and so I should try to
        // replace most calls to
        // game.getBoard().inSpace() with this one
<span class="nc bnc" id="L13151" title="All 4 branches missed.">        return game != null &amp;&amp; game.getBoard().inSpace();</span>
    }

    /**
     * is the unit flying Nape of the Earth? (i.e. one elevation above ground)
     */
    public boolean isNOE() {

<span class="nc bnc" id="L13159" title="All 2 branches missed.">        if (!isAirborne()) {</span>
<span class="nc" id="L13160">            return false;</span>
        }
<span class="nc bnc" id="L13162" title="All 2 branches missed.">        if (game.getBoard().inAtmosphere()) {</span>
<span class="nc" id="L13163">            return (1 == (getAltitude() - game.getBoard().getHex(getPosition())</span>
<span class="nc bnc" id="L13164" title="All 2 branches missed.">                    .ceiling(true)));</span>
        }
<span class="nc bnc" id="L13166" title="All 2 branches missed.">        if (game.getBoard().onGround()) {</span>
<span class="nc bnc" id="L13167" title="All 2 branches missed.">            return 1 == getAltitude();</span>
        }
<span class="nc" id="L13169">        return false;</span>
    }

    public int getStartingPos() {
<span class="nc" id="L13173">        return getStartingPos(true);</span>
    }

    public int getStartingPos(boolean inheritFromOwner) {
<span class="nc bnc" id="L13177" title="All 4 branches missed.">        if (inheritFromOwner &amp;&amp; startingPos == Board.START_NONE) {</span>
<span class="nc" id="L13178">            return owner.getStartingPos();</span>
        }
<span class="nc" id="L13180">        return startingPos;</span>
    }

    public void setStartingPos(int i) {
<span class="nc" id="L13184">        startingPos = i;</span>
<span class="nc" id="L13185">    }</span>

    @Override
    public int getAltitude() {
<span class="nc" id="L13189">        return altitude;</span>
    }

    public void setAltitude(int a) {
<span class="nc" id="L13193">        altitude = a;</span>
<span class="nc" id="L13194">    }</span>

    public boolean getUseManualBV() {
<span class="nc" id="L13197">        return useManualBV;</span>
    }

    public void setUseManualBV(boolean bv) {
<span class="nc" id="L13201">        useManualBV = bv;</span>
<span class="nc" id="L13202">    }</span>

    public int getManualBV() {
<span class="nc" id="L13205">        return manualBV;</span>
    }

    public void setManualBV(int bv) {
<span class="nc" id="L13209">        manualBV = bv;</span>
<span class="nc" id="L13210">    }</span>

    /**
     * Gets the initial BV of a unit.
     *
     * Useful for comparisons with the current BV.
     * @return The initial BV of a unit.
     */
    public int getInitialBV() {
<span class="nc" id="L13219">        return initialBV;</span>
    }

    /**
     * Sets the initial BV for a unit.
     *
     * Called when the game is initialized.
     * @param bv The initial BV of a unit.
     */
    public void setInitialBV(int bv) {
<span class="nc" id="L13229">            initialBV = bv;</span>
<span class="nc" id="L13230">    }</span>

    /**
     * produce an int array of the number of bombs of each type based on the
     * current bomblist
     *
     * @return
     */
    public int[] getBombLoadout() {
<span class="nc" id="L13239">        int[] loadout = new int[BombType.B_NUM];</span>
<span class="nc bnc" id="L13240" title="All 2 branches missed.">        for (Mounted bomb : getBombs()) {</span>
<span class="nc bnc" id="L13241" title="All 2 branches missed.">            if ((bomb.getUsableShotsLeft() &gt; 0)</span>
<span class="nc bnc" id="L13242" title="All 2 branches missed.">                &amp;&amp; (bomb.getType() instanceof BombType)) {</span>
<span class="nc" id="L13243">                int type = ((BombType) bomb.getType()).getBombType();</span>
<span class="nc" id="L13244">                loadout[type] = loadout[type] + 1;</span>
            }
<span class="nc" id="L13246">        }</span>
<span class="nc" id="L13247">        return loadout;</span>
    }

    /**
     * Start of Battle Force Conversion Methods
     */

    public int getBattleForcePoints() {
<span class="nc" id="L13255">    	double bv = calculateBattleValue(true, true);</span>
<span class="nc" id="L13256">    	int points = (int) Math.round(bv / 100);</span>
<span class="nc" id="L13257">    	return Math.max(1, points);</span>
    }

    /**
     * Get the movement mode of the entity and return it as a battle force
     * string.
     */
    public String getMovementModeAsBattleForceString() {
<span class="nc bnc" id="L13265" title="All 14 branches missed.">    	switch (getMovementMode()) {</span>
    	case NONE:
    	case BIPED:
    	case BIPED_SWIM:
    	case QUAD:
    	case QUAD_SWIM:
<span class="nc" id="L13271">    		return &quot;&quot;;</span>
    	case TRACKED:
<span class="nc" id="L13273">    		return &quot;t&quot;;</span>
    	case WHEELED:
<span class="nc" id="L13275">    		return &quot;w&quot;;</span>
    	case HOVER:
<span class="nc" id="L13277">    		return &quot;h&quot;;</span>
    	case VTOL:
<span class="nc" id="L13279">    		return &quot;v&quot;;</span>
    	case NAVAL:
    	case HYDROFOIL:
<span class="nc" id="L13282">    		return &quot;n&quot;;</span>
    	case SUBMARINE:
    	case INF_UMU:
<span class="nc" id="L13285">    		return &quot;s&quot;;</span>
    	case INF_LEG:
<span class="nc" id="L13287">    		return &quot;f&quot;;</span>
    	case INF_MOTORIZED:
<span class="nc" id="L13289">    		return &quot;m&quot;;</span>
    	case INF_JUMP:
<span class="nc" id="L13291">    		return &quot;j&quot;;</span>
    	case WIGE:
<span class="nc" id="L13293">    		return &quot;g&quot;;</span>
    	case AERODYNE:
<span class="nc" id="L13295">    		return &quot;a&quot;;</span>
    	case SPHEROID:
<span class="nc" id="L13297">    		return &quot;p&quot;;</span>
    	default:
<span class="nc" id="L13299">    		return &quot;ERROR&quot;;</span>
    	}
    }

    /**
     * Certain unit types can increase this with MASC, supercharger, or jet booster.
     * AlphaStrike needs the fraction retained because it doubles the movement for ground units,
     * while BattleForce rounds this to the nearest integer.
     */
    public double getBaseBattleForceMovement() {
<span class="nc" id="L13309">    	return getOriginalWalkMP();</span>
    }

    /**
     * Handles base, jump, and underwater movement.
     *
     * @return
     */
    public void setBattleForceMovement(Map&lt;String,Integer&gt; movement) {
<span class="nc" id="L13318">    	int baseMove = (int)Math.round(getBaseBattleForceMovement());</span>
<span class="nc" id="L13319">    	int jumpMove = getOriginalJumpMP();</span>
<span class="nc bnc" id="L13320" title="All 4 branches missed.">    	if (jumpMove == baseMove &amp;&amp; getMovementModeAsBattleForceString().length() == 0) {</span>
<span class="nc" id="L13321">    		movement.put(&quot;j&quot;, baseMove);</span>
    	} else {
<span class="nc" id="L13323">    		movement.put(getMovementModeAsBattleForceString(), baseMove);</span>
<span class="nc bnc" id="L13324" title="All 2 branches missed.">    		if (jumpMove &gt;= baseMove) {</span>
<span class="nc" id="L13325">    			movement.put(&quot;j&quot;, jumpMove);</span>
<span class="nc bnc" id="L13326" title="All 2 branches missed.">    		} else if (jumpMove &gt; 0) {</span>
<span class="nc" id="L13327">    			movement.put(&quot;j&quot;, (int)Math.round(jumpMove * 0.66));</span>
    		}
    	}
<span class="nc" id="L13330">    	int umu = getAllUMUCount();</span>
<span class="nc bnc" id="L13331" title="All 2 branches missed.">    	if (umu &gt; 0) {</span>
<span class="nc" id="L13332">    		movement.put(&quot;s&quot;, umu);</span>
    	}
<span class="nc" id="L13334">    }</span>

    /**
     * Doubles base movement. Aero overrides this.
     */
    public void setAlphaStrikeMovement(Map&lt;String,Integer&gt; movement) {
<span class="nc" id="L13340">    	int baseMove = (int)Math.round(getBaseBattleForceMovement() * 2);</span>
<span class="nc" id="L13341">    	int jumpMove = getOriginalJumpMP();</span>
<span class="nc bnc" id="L13342" title="All 2 branches missed.">    	if (jumpMove == baseMove) {</span>
<span class="nc" id="L13343">    		movement.put(&quot;j&quot;, baseMove);</span>
    	} else {
<span class="nc" id="L13345">    		movement.put(getMovementModeAsBattleForceString(), baseMove);</span>
<span class="nc bnc" id="L13346" title="All 2 branches missed.">    		if (jumpMove &gt; 0) {</span>
<span class="nc" id="L13347">    			movement.put(&quot;j&quot;, jumpMove * 2);</span>
    		}
    	}
<span class="nc" id="L13350">    	int umu = getAllUMUCount();</span>
<span class="nc bnc" id="L13351" title="All 2 branches missed.">    	if (umu &gt; 0) {</span>
<span class="nc" id="L13352">    		movement.put(&quot;s&quot;, umu * 2);</span>
    	}
<span class="nc" id="L13354">    }</span>

    public int getBattleForceArmorPoints() {
<span class="nc" id="L13357">    	return (int)Math.round(getBattleForceArmorPointsRaw());</span>
    }

    /**
     * Calculates the intermediate value for armor points (retaining fractional amounts)
     * and adds any special abilities conferred by armor.
     *
     * @return      The armor value of this entity
     */
    public double getBattleForceArmorPointsRaw() {
<span class="nc" id="L13367">    	double armorPoints = 0;</span>

<span class="nc bnc" id="L13369" title="All 2 branches missed.">    	for (int loc = 0; loc &lt; locations(); loc++) {</span>
<span class="nc" id="L13370">    		double armorMod = 1;</span>
<span class="nc bnc" id="L13371" title="All 6 branches missed.">    		switch (getArmorType(loc)) {</span>
    		case EquipmentType.T_ARMOR_COMMERCIAL:
<span class="nc" id="L13373">    			armorMod = .5;</span>
<span class="nc" id="L13374">    			break;</span>
    		case EquipmentType.T_ARMOR_INDUSTRIAL:
    		case EquipmentType.T_ARMOR_HEAVY_INDUSTRIAL:
<span class="nc" id="L13377">    			armorMod = getBARRating(0) / 10;</span>
<span class="nc" id="L13378">    			break;</span>
    		case EquipmentType.T_ARMOR_FERRO_LAMELLOR:
<span class="nc" id="L13380">    			armorMod = 1.2;</span>
<span class="nc" id="L13381">    			break;</span>
    		case EquipmentType.T_ARMOR_HARDENED:
<span class="nc" id="L13383">    			armorMod = 1.5;</span>
<span class="nc" id="L13384">    			break;</span>
    		case EquipmentType.T_ARMOR_REFLECTIVE:
    		case EquipmentType.T_ARMOR_REACTIVE:
<span class="nc" id="L13387">    			armorMod = .75;</span>
    			break;
    		}
<span class="nc" id="L13390">    		armorPoints += Math.ceil(getArmor(loc) * armorMod);</span>

    	}
<span class="nc bnc" id="L13393" title="All 2 branches missed.">    	if (this.hasModularArmor()) {</span>
    		// Modular armor is always &quot;regular&quot; armor
<span class="nc bnc" id="L13395" title="All 2 branches missed.">    		for (Mounted mount : this.getEquipment()) {</span>
<span class="nc bnc" id="L13396" title="All 2 branches missed.">    			if (!mount.isDestroyed()</span>
<span class="nc bnc" id="L13397" title="All 2 branches missed.">    					&amp;&amp; (mount.getType() instanceof MiscType)</span>
<span class="nc" id="L13398">    					&amp;&amp; ((MiscType) mount.getType())</span>
<span class="nc bnc" id="L13399" title="All 2 branches missed.">    					.hasFlag(MiscType.F_MODULAR_ARMOR)) {</span>
<span class="nc" id="L13400">    				armorPoints += 10;</span>
    			}
<span class="nc" id="L13402">    		}</span>
    	}

<span class="nc bnc" id="L13405" title="All 2 branches missed.">    	if (isCapitalScale()) {</span>
<span class="nc" id="L13406">    		return (int)Math.round(armorPoints * 0.33);</span>
    	}
<span class="nc" id="L13408">    	return (int) Math.round(armorPoints / 30);</span>
    }

    /**
     * only used for Aerospace and Dropships
     *
     * @return
     */
    public String getBattleForceDamageThresholdString() {
<span class="nc" id="L13417">    	return &quot;&quot;;</span>
    }

    /**
     * this will be unit specific
     *
     * @return
     */
    public int getBattleForceStructurePoints() {
<span class="nc" id="L13426">    	return 0;</span>
    }

    /**
     * Some units have separate damage values for various locations (turrets, large craft firing arcs)
     * @return
     */
    public int getNumBattleForceWeaponsLocations() {
<span class="nc" id="L13434">    	return 1;</span>
    }

    public int getNumAlphaStrikeWeaponsLocations() {
<span class="nc" id="L13438">    	return getNumBattleForceWeaponsLocations();</span>
    }

    /**
     * @param index - indicates which set of damage values is being calculated
     * @param location - one of the entity's LOC_* constants
     * @return - the damage multiplier for this location; 0 for exclusion
     */
    public double getBattleForceLocationMultiplier(int index, int location, boolean rearMounted) {
<span class="nc" id="L13447">    	return 1.0;</span>
    }

    /**
     * Weapon calculations are the same for BF and AS except for turrets, which are not separated
     * in AS, and warships, which have only four arcs in AS.
     */
    public double getAlphaStrikeLocationMultiplier(int index, int location, boolean rearMounted) {
<span class="nc" id="L13455">    	return getBattleForceLocationMultiplier(index, location, rearMounted);</span>
    }

    public boolean isBattleForceTurretLocation(int index) {
<span class="nc" id="L13459">    	return false;</span>
    }

    public boolean isBattleForceRearLocation(int index) {
<span class="nc" id="L13463">    	return false;</span>
    }

    /**
     * Units with separate weapon locations (turrets or firing arcs) return the name of the location
     * @param index
     * @return
     */
    public String getBattleForceLocationName(int index) {
<span class="nc bnc" id="L13472" title="All 2 branches missed.">    	if (isBattleForceTurretLocation(index)) {</span>
<span class="nc" id="L13473">    		return &quot;TUR&quot;;</span>
    	}
<span class="nc" id="L13475">    	return &quot;&quot;;</span>
    }

    public String getAlphaStrikeLocationName(int index) {
<span class="nc" id="L13479">    	return getBattleForceLocationName(index);</span>
    }

    public boolean useForAlphaStrikePointCalc(int loc) {
<span class="nc bnc" id="L13483" title="All 4 branches missed.">    	return loc == 0 || isBattleForceTurretLocation(loc);</span>
    }

    /**
     * Only used by Mechs and ASFs, which require different approaches to determining rear mountings
     * @param allowRear - Use rear-mounted weapons instead of forward
     * @return - total heat generated by firing all weapons
     */
    public int getBattleForceTotalHeatGeneration(boolean allowRear) {
<span class="nc" id="L13492">    	return 0;</span>
    }

    /**
     * Used by small craft, dropships, jumpships, and warships to compute heat for a specific firing arc
     *
     * @param location
     * @return
     */
    public int getBattleForceTotalHeatGeneration(int location) {
<span class="nc" id="L13502">    	return 0;</span>
    }

    public void addBattleForceSpecialAbilities(Map&lt;BattleForceSPA,Integer&gt; specialAbilities) {
<span class="nc bnc" id="L13506" title="All 2 branches missed.">    	for (Mounted m : getEquipment()) {</span>
<span class="nc bnc" id="L13507" title="All 2 branches missed.">    		if (!(m.getType() instanceof MiscType)) {</span>
<span class="nc" id="L13508">    			continue;</span>
    		}
<span class="nc bnc" id="L13510" title="All 2 branches missed.">    		if (m.getType().hasFlag(MiscType.F_BAP)) {</span>
<span class="nc" id="L13511">    			specialAbilities.put(BattleForceSPA.RCN, null);</span>
<span class="nc bnc" id="L13512" title="All 2 branches missed.">    			if (m.getType().hasFlag(MiscType.F_BLOODHOUND)) {</span>
<span class="nc" id="L13513">    				specialAbilities.put(BattleForceSPA.BH, null);</span>
<span class="nc bnc" id="L13514" title="All 2 branches missed.">    			} else if (m.getType().hasFlag(MiscType.F_BA_EQUIPMENT)) {</span>
<span class="nc" id="L13515">    				specialAbilities.put(BattleForceSPA.LPRB, null);</span>
<span class="nc bnc" id="L13516" title="All 2 branches missed.">    			} else if (m.getType().hasFlag(MiscType.F_WATCHDOG)) {</span>
<span class="nc" id="L13517">    				specialAbilities.put(BattleForceSPA.WAT, null);</span>
<span class="nc" id="L13518">    				specialAbilities.put(BattleForceSPA.LPRB, null);</span>
<span class="nc" id="L13519">    				specialAbilities.put(BattleForceSPA.ECM, null);</span>
    			} else {
<span class="nc" id="L13521">    				specialAbilities.put(BattleForceSPA.PRB, null);</span>
    			}
<span class="nc bnc" id="L13523" title="All 2 branches missed.">    			if (m.getType().hasFlag(MiscType.F_NOVA)) {</span>
<span class="nc" id="L13524">    				specialAbilities.put(BattleForceSPA.NOVA, null);</span>
<span class="nc" id="L13525">    				specialAbilities.put(BattleForceSPA.ECM, null);</span>
<span class="nc" id="L13526">    				specialAbilities.put(BattleForceSPA.MHQ, 3); // count half-tons</span>
    			}
<span class="nc bnc" id="L13528" title="All 2 branches missed.">    		} else if (m.getType().hasFlag(MiscType.F_ECM)) {</span>
<span class="nc bnc" id="L13529" title="All 2 branches missed.">    			if (m.getType().hasFlag(MiscType.F_ANGEL_ECM)) {</span>
<span class="nc" id="L13530">    				specialAbilities.put(BattleForceSPA.AECM, null);</span>
<span class="nc bnc" id="L13531" title="All 2 branches missed.">    			} else if (m.getType().hasFlag(MiscType.F_SINGLE_HEX_ECM)) {</span>
<span class="nc" id="L13532">    				specialAbilities.put(BattleForceSPA.LECM, null);</span>
    			} else {
<span class="nc" id="L13534">    				specialAbilities.put(BattleForceSPA.ECM, null);</span>
    			}
<span class="nc bnc" id="L13536" title="All 2 branches missed.">    		} else if (m.getType().hasFlag(MiscType.F_BOOBY_TRAP)) {</span>
<span class="nc" id="L13537">    			specialAbilities.put(BattleForceSPA.BT, null);</span>
<span class="nc bnc" id="L13538" title="All 2 branches missed.">    		} else if (m.getType().hasFlag(MiscType.F_LIGHT_BRIDGE_LAYER)</span>
<span class="nc bnc" id="L13539" title="All 2 branches missed.">    				|| m.getType().hasFlag(MiscType.F_MEDIUM_BRIDGE_LAYER)</span>
<span class="nc bnc" id="L13540" title="All 2 branches missed.">    				|| m.getType().hasFlag(MiscType.F_HEAVY_BRIDGE_LAYER)) {</span>
<span class="nc" id="L13541">    			specialAbilities.put(BattleForceSPA.BRID, null);</span>
<span class="nc bnc" id="L13542" title="All 2 branches missed.">    		} else if (m.getType().hasFlag(MiscType.F_C3S)) {</span>
<span class="nc bnc" id="L13543" title="All 2 branches missed.">    			if (m.getType().hasFlag(MiscType.F_C3SBS)) {</span>
<span class="nc" id="L13544">    				specialAbilities.put(BattleForceSPA.C3BSS, null);</span>
<span class="nc" id="L13545">    				specialAbilities.merge(BattleForceSPA.MHQ, 4, Integer::sum);</span>
<span class="nc bnc" id="L13546" title="All 2 branches missed.">    			} else if (m.getType().hasFlag(MiscType.F_C3EM)) {</span>
<span class="nc" id="L13547">    				specialAbilities.merge(BattleForceSPA.C3EM, 1, Integer::sum);</span>
<span class="nc" id="L13548">    				specialAbilities.merge(BattleForceSPA.MHQ, 4, Integer::sum);</span>
    			} else {
<span class="nc" id="L13550">    				specialAbilities.put(BattleForceSPA.C3S, null);</span>
<span class="nc" id="L13551">    				specialAbilities.merge(BattleForceSPA.MHQ, 2, Integer::sum);</span>
    			}
<span class="nc bnc" id="L13553" title="All 2 branches missed.">    		} else if (m.getType().hasFlag(MiscType.F_C3I)) {</span>
<span class="nc bnc" id="L13554" title="All 2 branches missed.">    			if ((getEntityType() &amp; ETYPE_AERO) == ETYPE_AERO) {</span>
<span class="nc" id="L13555">    				specialAbilities.put(BattleForceSPA.NC3, null);</span>
    			} else {
<span class="nc" id="L13557">    				specialAbilities.put(BattleForceSPA.C3I, null);</span>
<span class="nc bnc" id="L13558" title="All 2 branches missed.">    				if (m.getType().hasFlag(MiscType.F_BA_EQUIPMENT)) {</span>
<span class="nc" id="L13559">    					specialAbilities.merge(BattleForceSPA.MHQ, 4, Integer::sum);</span>
    				} else {
<span class="nc" id="L13561">    					specialAbilities.merge(BattleForceSPA.MHQ, 5, Integer::sum);</span>
    				}
    			}
<span class="nc bnc" id="L13564" title="All 2 branches missed.">    		} else if (m.getType().hasFlag(MiscType.F_CASE)) {</span>
<span class="nc" id="L13565">    			specialAbilities.put(BattleForceSPA.CASE, null);</span>
<span class="nc bnc" id="L13566" title="All 2 branches missed.">            } else if (m.getType().hasFlag(MiscType.F_CASEP)) { //in BF seems to work the same as CASE</span>
<span class="nc" id="L13567">                specialAbilities.put(BattleForceSPA.CASE, null);</span>
<span class="nc bnc" id="L13568" title="All 2 branches missed.">    		} else if (m.getType().hasFlag(MiscType.F_CASEII)) {</span>
<span class="nc" id="L13569">    			specialAbilities.put(BattleForceSPA.CASEII, null);</span>
<span class="nc bnc" id="L13570" title="All 2 branches missed.">    		} else if (m.getType().hasFlag(MiscType.F_DRONE_OPERATING_SYSTEM)) {</span>
<span class="nc" id="L13571">    			specialAbilities.put(BattleForceSPA.DRO, null);</span>
<span class="nc bnc" id="L13572" title="All 2 branches missed.">    		} else if (m.getType().hasFlag(MiscType.F_DRONE_CARRIER_CONTROL)) {</span>
<span class="nc" id="L13573">    			specialAbilities.merge(BattleForceSPA.DCC, (int) m.getSize(), Integer::sum);</span>
<span class="nc bnc" id="L13574" title="All 2 branches missed.">    		} else if (m.getType().hasFlag(MiscType.F_EJECTION_SEAT)) {</span>
<span class="nc" id="L13575">    			specialAbilities.put(BattleForceSPA.ES, null);</span>
<span class="nc bnc" id="L13576" title="All 2 branches missed.">    		} else if (m.getType().hasFlag(MiscType.F_ECM)) {</span>
<span class="nc" id="L13577">    			specialAbilities.put(BattleForceSPA.ECM, null);</span>
<span class="nc bnc" id="L13578" title="All 2 branches missed.">    		} else if (m.getType().hasFlag(MiscType.F_BULLDOZER)) {</span>
<span class="nc" id="L13579">    			specialAbilities.put(BattleForceSPA.ENG, null);</span>
<span class="nc bnc" id="L13580" title="All 2 branches missed.">    		} else if (m.getType().hasFlag(MiscType.F_CLUB)) {</span>
<span class="nc" id="L13581">    			specialAbilities.put(BattleForceSPA.MEL, null);</span>
<span class="nc bnc" id="L13582" title="All 2 branches missed.">    			if ((m.getType().getSubType() &amp;</span>
    					(MiscType.S_BACKHOE | MiscType.S_PILE_DRIVER
    							| MiscType.S_MINING_DRILL | MiscType.S_ROCK_CUTTER
    							| MiscType.S_WRECKING_BALL)) != 0) {
<span class="nc" id="L13586">    				specialAbilities.put(BattleForceSPA.ENG, null);</span>
<span class="nc bnc" id="L13587" title="All 2 branches missed.">    			} else if ((m.getType().getSubType() &amp;</span>
    					(MiscType.S_DUAL_SAW | MiscType.S_CHAINSAW
    							| MiscType.S_BUZZSAW)) != 0) {
<span class="nc" id="L13590">    				specialAbilities.put(BattleForceSPA.SAW, null);</span>
    			}
<span class="nc bnc" id="L13592" title="All 2 branches missed.">    		} else if (m.getType().hasFlag(MiscType.F_FIRE_RESISTANT)) {</span>
<span class="nc" id="L13593">    			specialAbilities.put(BattleForceSPA.FR, null);</span>
<span class="nc bnc" id="L13594" title="All 2 branches missed.">    		} else if (m.getType().hasFlag(MiscType.F_MOBILE_HPG)) {</span>
<span class="nc" id="L13595">    			specialAbilities.put(BattleForceSPA.HPG, null);</span>
<span class="nc bnc" id="L13596" title="All 2 branches missed.">    		} else if (m.getType().hasFlag(MiscType.F_COMMUNICATIONS)) {</span>
<span class="nc" id="L13597">    			specialAbilities.merge(BattleForceSPA.MHQ, (int) m.getTonnage() * 2,</span>
    					Integer::sum);
<span class="nc bnc" id="L13599" title="All 2 branches missed.">    			if (m.getTonnage() &gt;= getWeight() / 20.0) {</span>
<span class="nc" id="L13600">    				specialAbilities.put(BattleForceSPA.RCN, null);</span>
    			}
<span class="nc bnc" id="L13602" title="All 2 branches missed.">    		} else if (m.getType().hasFlag(MiscType.F_SENSOR_DISPENSER)) {</span>
<span class="nc" id="L13603">    			specialAbilities.merge(BattleForceSPA.RSD, 1, Integer::sum);</span>
<span class="nc" id="L13604">    			specialAbilities.put(BattleForceSPA.RCN, null);</span>
<span class="nc bnc" id="L13605" title="All 2 branches missed.">    		} else if (m.getType().hasFlag(MiscType.F_LOOKDOWN_RADAR)</span>
<span class="nc bnc" id="L13606" title="All 2 branches missed.">    				|| m.getType().hasFlag(MiscType.F_RECON_CAMERA)</span>
<span class="nc bnc" id="L13607" title="All 2 branches missed.">    				|| m.getType().hasFlag(MiscType.F_HIRES_IMAGER)</span>
<span class="nc bnc" id="L13608" title="All 2 branches missed.">    				|| m.getType().hasFlag(MiscType.F_HYPERSPECTRAL_IMAGER)</span>
<span class="nc bnc" id="L13609" title="All 2 branches missed.">    				|| m.getType().hasFlag(MiscType.F_INFRARED_IMAGER)) {</span>
<span class="nc bnc" id="L13610" title="All 2 branches missed.">    		} else if (m.getType().hasFlag(MiscType.F_SEARCHLIGHT)) {</span>
<span class="nc" id="L13611">    			specialAbilities.put(BattleForceSPA.SRCH, null);</span>
<span class="nc bnc" id="L13612" title="All 2 branches missed.">    		} else if (m.getType().hasFlag(MiscType.F_RADICAL_HEATSINK)) {</span>
<span class="nc" id="L13613">    			specialAbilities.put(BattleForceSPA.RHS, null);</span>
<span class="nc bnc" id="L13614" title="All 2 branches missed.">    		} else if (m.getType().hasFlag(MiscType.F_EMERGENCY_COOLANT_SYSTEM)) {</span>
<span class="nc" id="L13615">    			specialAbilities.put(BattleForceSPA.ECS, null);</span>
<span class="nc bnc" id="L13616" title="All 2 branches missed.">    		} else if (m.getType().hasFlag(MiscType.F_VIRAL_JAMMER_DECOY)) {</span>
<span class="nc" id="L13617">    			specialAbilities.put(BattleForceSPA.DJ, null);</span>
<span class="nc bnc" id="L13618" title="All 2 branches missed.">    		} else if (m.getType().hasFlag(MiscType.F_VIRAL_JAMMER_HOMING)) {</span>
<span class="nc" id="L13619">    			specialAbilities.put(BattleForceSPA.HJ, null);</span>
    		}
<span class="nc" id="L13621">    	}</span>

<span class="nc bnc" id="L13623" title="All 2 branches missed.">    	if (isOmni()) {</span>
<span class="nc" id="L13624">    		specialAbilities.put(BattleForceSPA.OMNI, null);</span>
    	}

    	//TODO: Variable Range targeting is not implemented

<span class="nc bnc" id="L13629" title="All 2 branches missed.">    	if (!hasPatchworkArmor()) {</span>
<span class="nc bnc" id="L13630" title="All 11 branches missed.">    		switch (getArmorType(0)) {</span>
    		case EquipmentType.T_ARMOR_COMMERCIAL:
    		case EquipmentType.T_ARMOR_INDUSTRIAL:
    		case EquipmentType.T_ARMOR_HEAVY_INDUSTRIAL:
<span class="nc" id="L13634">    			specialAbilities.put(BattleForceSPA.BAR, null);</span>
<span class="nc" id="L13635">    			break;</span>
    		case EquipmentType.T_ARMOR_FERRO_LAMELLOR:
<span class="nc" id="L13637">    			specialAbilities.put(BattleForceSPA.CR, null);</span>
<span class="nc" id="L13638">    			break;</span>
    		case EquipmentType.T_ARMOR_STEALTH:
    		case EquipmentType.T_ARMOR_STEALTH_VEHICLE:
<span class="nc" id="L13641">    			specialAbilities.put(BattleForceSPA.STL, null);</span>
<span class="nc" id="L13642">    			specialAbilities.put(BattleForceSPA.ECM, null);</span>
<span class="nc" id="L13643">    			break;</span>
    		case EquipmentType.T_ARMOR_BA_STEALTH:
    		case EquipmentType.T_ARMOR_BA_STEALTH_BASIC:
    		case EquipmentType.T_ARMOR_BA_STEALTH_IMP:
    		case EquipmentType.T_ARMOR_BA_STEALTH_PROTOTYPE:
<span class="nc" id="L13648">    			specialAbilities.put(BattleForceSPA.STL, null);</span>
<span class="nc" id="L13649">    			specialAbilities.put(BattleForceSPA.LECM, null);</span>
<span class="nc" id="L13650">    			break;</span>
    		case EquipmentType.T_ARMOR_ANTI_PENETRATIVE_ABLATION:
<span class="nc" id="L13652">    			specialAbilities.put(BattleForceSPA.ABA, null);</span>
<span class="nc" id="L13653">    			break;</span>
    		case EquipmentType.T_ARMOR_BALLISTIC_REINFORCED:
<span class="nc" id="L13655">    			specialAbilities.put(BattleForceSPA.BRA, null);</span>
<span class="nc" id="L13656">    			break;</span>
    		case EquipmentType.T_ARMOR_BA_FIRE_RESIST:
<span class="nc" id="L13658">    			specialAbilities.put(BattleForceSPA.FR, null);</span>
<span class="nc" id="L13659">    			break;</span>
    		case EquipmentType.T_ARMOR_IMPACT_RESISTANT:
<span class="nc" id="L13661">    			specialAbilities.put(BattleForceSPA.IRA, null);</span>
<span class="nc" id="L13662">    			break;</span>
    		case EquipmentType.T_ARMOR_REACTIVE:
<span class="nc" id="L13664">    			specialAbilities.put(BattleForceSPA.RCA, null);</span>
<span class="nc" id="L13665">    			break;</span>
    		case EquipmentType.T_ARMOR_REFLECTIVE:
<span class="nc" id="L13667">    			specialAbilities.put(BattleForceSPA.RFA, null);</span>
    			break;
    		}
    	}

<span class="nc bnc" id="L13672" title="All 2 branches missed.">    	if (getAmmo().size() &gt; 0) {</span>
<span class="nc bnc" id="L13673" title="All 2 branches missed.">    		if (isClan()) {</span>
<span class="nc" id="L13674">    			specialAbilities.put(BattleForceSPA.CASE, null);</span>
    		}
    	} else {
<span class="nc" id="L13677">    		specialAbilities.put(BattleForceSPA.ENE, null);</span>
    	}

<span class="nc" id="L13680">    	if (getAmmo().stream().map(m -&gt; (AmmoType)m.getType())</span>
<span class="nc bnc" id="L13681" title="All 2 branches missed.">    			.anyMatch(at -&gt; at.hasFlag(AmmoType.F_TELE_MISSILE))) {</span>
<span class="nc" id="L13682">    		specialAbilities.put(BattleForceSPA.TELE, null);</span>
    	}

<span class="nc bnc" id="L13685" title="All 2 branches missed.">    	if (hasEngine()) {</span>
<span class="nc bnc" id="L13686" title="All 2 branches missed.">    		if (getEngine().getEngineType() == Engine.STEAM</span>
<span class="nc bnc" id="L13687" title="All 2 branches missed.">    				&amp;&amp; getEngine().getEngineType() == Engine.FUEL_CELL) {</span>
<span class="nc" id="L13688">    			specialAbilities.put(BattleForceSPA.EE, null);</span>
<span class="nc bnc" id="L13689" title="All 2 branches missed.">    		} else if (getEngine().getEngineType() == Engine.STEAM) {</span>
<span class="nc" id="L13690">    			specialAbilities.put(BattleForceSPA.FC, null);</span>
    		} else {
<span class="nc" id="L13692">    			specialAbilities.put(BattleForceSPA.EEE, null);</span>
    		}
    	}

<span class="nc bnc" id="L13696" title="All 2 branches missed.">    	for (Transporter t : getTransports()) {</span>
<span class="nc bnc" id="L13697" title="All 2 branches missed.">    		if (t instanceof ASFBay) {</span>
<span class="nc" id="L13698">    			specialAbilities.merge(BattleForceSPA.AT, (int)((ASFBay)t).getCapacity(), Integer::sum);</span>
<span class="nc" id="L13699">    			specialAbilities.merge(BattleForceSPA.ATxD, ((ASFBay)t).getDoors(), Integer::sum);</span>
<span class="nc" id="L13700">    			specialAbilities.put(BattleForceSPA.MFB, null);</span>
<span class="nc bnc" id="L13701" title="All 2 branches missed.">    		} else if (t instanceof CargoBay) {</span>
<span class="nc" id="L13702">    			specialAbilities.merge(BattleForceSPA.CT, (int)((CargoBay)t).getCapacity(), Integer::sum);</span>
<span class="nc" id="L13703">    			specialAbilities.merge(BattleForceSPA.CTxD, ((CargoBay)t).getDoors(), Integer::sum);</span>
<span class="nc bnc" id="L13704" title="All 2 branches missed.">    		} else if (t instanceof DockingCollar) {</span>
<span class="nc" id="L13705">    			specialAbilities.merge(BattleForceSPA.DT, 1, Integer::sum);</span>
<span class="nc bnc" id="L13706" title="All 2 branches missed.">    		} else if (t instanceof InfantryBay) {</span>
    			// We do not record number of doors for infantry
<span class="nc" id="L13708">    			specialAbilities.merge(BattleForceSPA.IT, (int)((InfantryBay)t).getCapacity(), Integer::sum);</span>
<span class="nc bnc" id="L13709" title="All 2 branches missed.">    		} else if (t instanceof MechBay) {</span>
<span class="nc" id="L13710">    			specialAbilities.merge(BattleForceSPA.MT, (int)((MechBay)t).getCapacity(), Integer::sum);</span>
<span class="nc" id="L13711">    			specialAbilities.merge(BattleForceSPA.MTxD, ((MechBay)t).getDoors(), Integer::sum);</span>
<span class="nc" id="L13712">    			specialAbilities.put(BattleForceSPA.MFB, null);</span>
<span class="nc bnc" id="L13713" title="All 2 branches missed.">    		} else if (t instanceof ProtomechBay) {</span>
<span class="nc" id="L13714">    			specialAbilities.merge(BattleForceSPA.PT, (int)((ProtomechBay)t).getCapacity(), Integer::sum);</span>
<span class="nc" id="L13715">    			specialAbilities.merge(BattleForceSPA.PTxD, ((ProtomechBay)t).getDoors(), Integer::sum);</span>
<span class="nc" id="L13716">    			specialAbilities.put(BattleForceSPA.MFB, null);</span>
<span class="nc bnc" id="L13717" title="All 2 branches missed.">    		} else if (t instanceof SmallCraftBay) {</span>
<span class="nc" id="L13718">    			specialAbilities.merge(BattleForceSPA.ST, (int)((SmallCraftBay)t).getCapacity(), Integer::sum);</span>
<span class="nc" id="L13719">    			specialAbilities.merge(BattleForceSPA.STxD, ((SmallCraftBay)t).getDoors(), Integer::sum);</span>
<span class="nc" id="L13720">    			specialAbilities.put(BattleForceSPA.MFB, null);</span>
<span class="nc bnc" id="L13721" title="All 2 branches missed.">    		} else if (t instanceof LightVehicleBay) {</span>
<span class="nc" id="L13722">    			specialAbilities.merge(BattleForceSPA.VTM, (int)((LightVehicleBay)t).getCapacity(), Integer::sum);</span>
<span class="nc" id="L13723">    			specialAbilities.merge(BattleForceSPA.VTMxD, ((LightVehicleBay)t).getDoors(), Integer::sum);</span>
<span class="nc" id="L13724">    			specialAbilities.put(BattleForceSPA.MFB, null);</span>
<span class="nc bnc" id="L13725" title="All 2 branches missed.">    		} else if (t instanceof HeavyVehicleBay) {</span>
<span class="nc" id="L13726">    			specialAbilities.merge(BattleForceSPA.VTH, (int)((HeavyVehicleBay)t).getCapacity(), Integer::sum);</span>
<span class="nc" id="L13727">    			specialAbilities.merge(BattleForceSPA.VTHxD, ((HeavyVehicleBay)t).getDoors(), Integer::sum);</span>
<span class="nc" id="L13728">    			specialAbilities.put(BattleForceSPA.MFB, null);</span>
    		}
<span class="nc" id="L13730">    	}</span>

<span class="nc bnc" id="L13732" title="All 2 branches missed.">    	topLoop: for (int location = 0; location &lt; locations(); location++) {</span>
<span class="nc bnc" id="L13733" title="All 2 branches missed.">    		for (int slot = 0; slot &lt; getNumberOfCriticals(location); slot++) {</span>
<span class="nc" id="L13734">    			CriticalSlot crit = getCritical(location, slot);</span>
<span class="nc bnc" id="L13735" title="All 2 branches missed.">    			if (null != crit) {</span>
<span class="nc bnc" id="L13736" title="All 2 branches missed.">    				if (crit.isArmored()) {</span>
<span class="nc" id="L13737">    					specialAbilities.put(BattleForceSPA.ARM, null);</span>
<span class="nc" id="L13738">    					break topLoop;</span>
<span class="nc bnc" id="L13739" title="All 2 branches missed.">    				} else if (crit.getType() == CriticalSlot.TYPE_EQUIPMENT) {</span>
<span class="nc" id="L13740">    					Mounted mount = crit.getMount();</span>
<span class="nc bnc" id="L13741" title="All 2 branches missed.">    					if (mount.isArmored()) {</span>
<span class="nc" id="L13742">    						specialAbilities.put(BattleForceSPA.ARM, null);</span>
<span class="nc" id="L13743">    						break topLoop;</span>
    					}
    				}
    			}
    		}
    	}
<span class="nc" id="L13749">    }</span>

    public int getBattleForceSize() {
    	// the default BF Size is for ground Combat elements. Other types will
    	// need to override this
    	// The tables are on page 356 of StartOps
<span class="nc bnc" id="L13755" title="All 2 branches missed.">    	if (getWeight() &lt; 40) {</span>
<span class="nc" id="L13756">    		return 1;</span>
    	}
<span class="nc bnc" id="L13758" title="All 2 branches missed.">    	if (getWeight() &lt; 60) {</span>
<span class="nc" id="L13759">    		return 2;</span>
    	}
<span class="nc bnc" id="L13761" title="All 2 branches missed.">    	if (getWeight() &lt; 80) {</span>
<span class="nc" id="L13762">    		return 3;</span>
    	}

<span class="nc" id="L13765">    	return 4;</span>
    }

    @Override
    public Map&lt;Integer, Coords&gt; getSecondaryPositions() {
<span class="nc" id="L13770">        return secondaryPositions;</span>
    }

    /**
     * Checks to see if this unit has a functional Blue Shield Particle Field
     * Damper that is turned on
     *
     * @return &lt;code&gt;true&lt;/code&gt; if the entity has a working, switched on blue
     * field &lt;code&gt;false&lt;/code&gt; otherwise
     */
    public boolean hasActiveBlueShield() {
<span class="nc bnc" id="L13781" title="All 2 branches missed.">        if (!isShutDown()) {</span>
<span class="nc bnc" id="L13782" title="All 2 branches missed.">            for (Mounted m : getMisc()) {</span>
<span class="nc" id="L13783">                EquipmentType type = m.getType();</span>
<span class="nc bnc" id="L13784" title="All 2 branches missed.">                if ((type instanceof MiscType)</span>
<span class="nc bnc" id="L13785" title="All 2 branches missed.">                    &amp;&amp; type.hasFlag(MiscType.F_BLUE_SHIELD)</span>
<span class="nc bnc" id="L13786" title="All 2 branches missed.">                    &amp;&amp; m.curMode().equals(&quot;On&quot;)) {</span>
<span class="nc bnc" id="L13787" title="All 8 branches missed.">                    return !(m.isDestroyed() || m.isMissing() || m.isBreached() || isShutDown());</span>
                }
<span class="nc" id="L13789">            }</span>
        }
<span class="nc" id="L13791">        return false;</span>
    }

    public int getBlueShieldRounds() {
<span class="nc" id="L13795">        return blueShieldRounds;</span>
    }

    public boolean isDropping() {
<span class="nc bnc" id="L13799" title="All 4 branches missed.">        return isAirborne() &amp;&amp; !(isAero());</span>
    }

    /**
     * does this unit have stealth armor?
     *
     * @return
     */
    public boolean hasStealth() {
        // only non-patchwork stealth actually works as stealth
<span class="nc bnc" id="L13809" title="All 4 branches missed.">        if (((getArmorType(1) == EquipmentType.T_ARMOR_STEALTH) || (getArmorType(1) == EquipmentType</span>
                .T_ARMOR_STEALTH_VEHICLE))
<span class="nc bnc" id="L13811" title="All 2 branches missed.">            &amp;&amp; !hasPatchworkArmor()) {</span>
<span class="nc" id="L13812">            return true;</span>
        }
<span class="nc" id="L13814">        return false;</span>
    }

    /**
     * Computes and returns the power amplifier weight for this entity, if any.
     * Returns 0.0 if the entity needs no amplifiers due to engine type or not
     * carrying any weapons requiring them.
     *
     * @return the power amplifier weight in tons.
     */
    public double getPowerAmplifierWeight() {
        // If we're fusion- or fission-powered, we need no amplifiers to begin
        // with.
<span class="nc bnc" id="L13827" title="All 6 branches missed.">        if (hasEngine() &amp;&amp; (getEngine().isFusion() || (getEngine().getEngineType() == Engine.FISSION))) {</span>
<span class="nc" id="L13828">            return 0.0;</span>
        }
        // Small support vehicles do not need power amplifiers.
<span class="nc bnc" id="L13831" title="All 2 branches missed.">        if (getWeightClass() == EntityWeightClass.WEIGHT_SMALL_SUPPORT) {</span>
<span class="nc" id="L13832">            return 0.0;</span>
        }
        // Otherwise we need to iterate over our weapons, find out which of them
        // require amplification, and keep a running weight total of those.
<span class="nc" id="L13836">        double total = 0.0;</span>
<span class="nc bnc" id="L13837" title="All 2 branches missed.">        for (Mounted m : getWeaponList()) {</span>
<span class="nc" id="L13838">            WeaponType wt = (WeaponType) m.getType();</span>
<span class="nc bnc" id="L13839" title="All 4 branches missed.">            if ((wt.hasFlag(WeaponType.F_LASER) &amp;&amp; (wt.getAmmoType() == AmmoType.T_NA))</span>
<span class="nc bnc" id="L13840" title="All 2 branches missed.">                    || wt.hasFlag(WeaponType.F_PPC)</span>
<span class="nc bnc" id="L13841" title="All 2 branches missed.">                    || wt.hasFlag(WeaponType.F_PLASMA)</span>
<span class="nc bnc" id="L13842" title="All 2 branches missed.">                    || wt.hasFlag(WeaponType.F_PLASMA_MFUK)</span>
<span class="nc bnc" id="L13843" title="All 4 branches missed.">                    || (wt.hasFlag(WeaponType.F_FLAMER) &amp;&amp; (wt.getAmmoType() == AmmoType.T_NA))) {</span>
<span class="nc" id="L13844">                total += m.getTonnage();</span>
            }
<span class="nc bnc" id="L13846" title="All 4 branches missed.">            if ((m.getLinkedBy() != null) &amp;&amp; (m.getLinkedBy().getType() instanceof</span>
<span class="nc" id="L13847">                    MiscType) &amp;&amp; m.getLinkedBy().getType().</span>
<span class="nc bnc" id="L13848" title="All 2 branches missed.">                    hasFlag(MiscType.F_PPC_CAPACITOR)) {</span>
<span class="nc" id="L13849">                total += m.getLinkedBy().getTonnage();</span>
            }
<span class="nc" id="L13851">        }</span>
<span class="nc bnc" id="L13852" title="All 2 branches missed.">        for (Mounted m : getMisc()) {</span>
<span class="nc bnc" id="L13853" title="All 4 branches missed.">            if (m.getType().hasFlag(MiscType.F_CLUB) &amp;&amp; m.getType().hasSubType(MiscType.S_SPOT_WELDER)) {</span>
<span class="nc" id="L13854">                total += m.getTonnage();</span>
            }
<span class="nc" id="L13856">        }</span>
        // Finally use that total to compute and return the actual power
        // amplifier weight.
<span class="nc" id="L13859">        return RoundWeight.nextHalfTon(total);</span>
    }

    public Vector&lt;Integer&gt; getLoadedKeepers() {
<span class="nc" id="L13863">        return loadedKeepers;</span>
    }

    public void setLoadedKeepers(Vector&lt;Integer&gt; v) {
<span class="nc" id="L13867">        loadedKeepers = v;</span>
<span class="nc" id="L13868">    }</span>

    public int getExtraC3BV(int baseBV) {
        // extra from c3 networks. a valid network requires at least 2 members
        // some hackery and magic numbers here. could be better
        // also, each 'has' loops through all equipment. inefficient to do it 3
        // times
<span class="nc" id="L13875">        int xbv = 0;</span>
<span class="nc bnc" id="L13876" title="All 2 branches missed.">        if ((game != null)</span>
<span class="nc bnc" id="L13877" title="All 4 branches missed.">            &amp;&amp; ((hasC3MM() &amp;&amp; (calculateFreeC3MNodes() &lt; 2))</span>
<span class="nc bnc" id="L13878" title="All 4 branches missed.">                || (hasC3M() &amp;&amp; (calculateFreeC3Nodes() &lt; 3))</span>
<span class="nc bnc" id="L13879" title="All 10 branches missed.">                || (hasC3S() &amp;&amp; (c3Master &gt; NONE)) || ((hasC3i() || hasNavalC3()) &amp;&amp; (calculateFreeC3Nodes() &lt; 5)))) {</span>
<span class="nc" id="L13880">            int totalForceBV = 0;</span>
<span class="nc" id="L13881">            totalForceBV += baseBV;</span>
<span class="nc bnc" id="L13882" title="All 2 branches missed.">            for (Entity e : game.getC3NetworkMembers(this)) {</span>
<span class="nc bnc" id="L13883" title="All 4 branches missed.">                if (!equals(e) &amp;&amp; onSameC3NetworkAs(e)) {</span>
<span class="nc" id="L13884">                    totalForceBV += e.calculateBattleValue(true, true);</span>
                }
<span class="nc" id="L13886">            }</span>
<span class="nc" id="L13887">            double multiplier = 0.05;</span>
<span class="nc bnc" id="L13888" title="All 2 branches missed.">            if (hasBoostedC3()) {</span>
<span class="nc" id="L13889">                multiplier = 0.07;</span>
            }
<span class="nc" id="L13891">            xbv += totalForceBV * multiplier;</span>
        }
<span class="nc" id="L13893">        return xbv;</span>
    }

    public boolean hasUnloadedUnitsFromBays() {
<span class="nc bnc" id="L13897" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc bnc" id="L13898" title="All 2 branches missed.">            if ((next instanceof Bay)</span>
<span class="nc bnc" id="L13899" title="All 2 branches missed.">                &amp;&amp; (((Bay) next).getNumberUnloadedThisTurn() &gt; 0)) {</span>
<span class="nc" id="L13900">                return true;</span>
            }
<span class="nc" id="L13902">        }</span>
<span class="nc" id="L13903">        return false;</span>
    }

    public boolean getMovedBackwards() {
<span class="nc" id="L13907">        return movedBackwards;</span>
    }

    public void setMovedBackwards(boolean back) {
<span class="nc" id="L13911">        movedBackwards = back;</span>
<span class="nc" id="L13912">    }</span>

    public boolean isPowerReverse() {
<span class="nc" id="L13915">        return isPowerReverse;</span>
    }

    public void setPowerReverse(boolean isPowerReverse) {
<span class="nc" id="L13919">        this.isPowerReverse = isPowerReverse;</span>
<span class="nc" id="L13920">    }</span>

    /**
     * Tracks whether a WiGE lifted off this turn (or a LAM hovered). Needed to track state
     * in case movement is continued from an interruption, so that the unit does not have a minimum
     * movement for the turn.
     *
     * @return whether a WiGE lifted off during this turn's movement
     */
    public boolean wigeLiftoffHover() {
<span class="nc" id="L13930">        return wigeLiftoffHover;</span>
    }

    public void setWigeLiftoffHover(boolean lifted) {
<span class="nc" id="L13934">        wigeLiftoffHover = lifted;</span>
<span class="nc" id="L13935">    }</span>

    public void setHardenedArmorDamaged(HitData hit, boolean damaged) {
<span class="nc" id="L13938">        hardenedArmorDamaged[hit.getLocation()] = damaged;</span>
<span class="nc" id="L13939">    }</span>

    /**
     * do we have a half-hit hardened armor point in the location struck by
     * this?
     *
     * @param hit
     * @return
     */
    public boolean isHardenedArmorDamaged(HitData hit) {
<span class="nc" id="L13949">        return hardenedArmorDamaged[hit.getLocation()];</span>
    }

    public void setLocationBlownOff(int loc, boolean damaged) {
<span class="nc" id="L13953">        locationBlownOff[loc] = damaged;</span>
<span class="nc" id="L13954">    }</span>

    public boolean isLocationBlownOff(int loc) {
<span class="nc" id="L13957">        return locationBlownOff[loc];</span>
    }

    /**
     * Marks the location as blown off in the current phase. This should be
     * called together with {@link #setLocationBlownOff(int, boolean) } whenever
     * a location gets blown off &lt;em&gt;during play&lt;/em&gt;, to allow relevant methods
     * (notably {@link #isLocationBad(int) }) to distinguish between fresh and
     * preexisting damage. A location's &quot;newly blown off&quot; status resets with the
     * next call to {@link #applyDamage() }.
     *
     * @param loc     Subclass-dependent code for the location.
     * @param damaged The location's &quot;recently blown off&quot; status.
     */
    public void setLocationBlownOffThisPhase(int loc, boolean damaged) {
<span class="nc" id="L13972">        locationBlownOffThisPhase[loc] = damaged;</span>
<span class="nc" id="L13973">    }</span>

    /**
     * Has the indicated location been blown off this phase (as opposed to
     * either earlier or not at all)?
     *
     * @param loc Subclass-dependent code for the location.
     * @return The locations &quot;recently blown off&quot; status.
     */
    public boolean isLocationBlownOffThisPhase(int loc) {
<span class="nc" id="L13983">        return locationBlownOffThisPhase[loc];</span>
    }

    /**
     * does this entity have patchwork armor?
     *
     * @return
     */
    public boolean hasPatchworkArmor() {
<span class="nc" id="L13992">        int type = armorType[0];</span>
<span class="nc" id="L13993">        int level = armorTechLevel[0];</span>
<span class="nc bnc" id="L13994" title="All 2 branches missed.">        for (int i = 1; i &lt; locations(); i++) {</span>
<span class="nc bnc" id="L13995" title="All 4 branches missed.">            if ((armorType[i] != type) || (armorTechLevel[i] != level)) {</span>
<span class="nc" id="L13996">                return true;</span>
            }
        }
<span class="nc" id="L13999">        return false;</span>
    }

    public boolean hasHardenedArmor() {
<span class="nc bnc" id="L14003" title="All 2 branches missed.">        for (int i = 0; i &lt; locations(); i++) {</span>
<span class="nc bnc" id="L14004" title="All 2 branches missed.">            if ((armorType[i] == EquipmentType.T_ARMOR_HARDENED)) {</span>
<span class="nc" id="L14005">                return true;</span>
            }
        }
<span class="nc" id="L14008">        return false;</span>
    }

    /**
     * Get the number of turns MASC has been used continuously.
     * &lt;p/&gt;
     * This method should &lt;strong&gt;only&lt;/strong&gt; be used during serialization.
     *
     * @return the &lt;code&gt;int&lt;/code&gt; number of turns MASC has been used.
     */
    public int getMASCTurns() {
<span class="nc" id="L14019">        return nMASCLevel;</span>
    }

    /**
     * Set the number of turns MASC has been used continuously.
     * &lt;p/&gt;
     * This method should &lt;strong&gt;only&lt;/strong&gt; be used during deserialization.
     *
     * @param turns The &lt;code&gt;int&lt;/code&gt; number of turns MASC has been used.
     */
    public void setMASCTurns(int turns) {
<span class="nc" id="L14030">        nMASCLevel = turns;</span>
<span class="nc" id="L14031">    }</span>

    /**
     * Determine if MASC has been used this turn.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if MASC has been used.
     */
    public boolean isMASCUsed() {
<span class="nc" id="L14039">        return usedMASC;</span>
    }

    /**
     * Set whether MASC has been used.
     * &lt;p/&gt;
     * This method should &lt;strong&gt;only&lt;/strong&gt; be used during deserialization.
     *
     * @param used The &lt;code&gt;boolean&lt;/code&gt; whether MASC has been used.
     */
    public void setMASCUsed(boolean used) {
<span class="nc" id="L14050">        usedMASC = used;</span>
<span class="nc" id="L14051">    }</span>

    public int getMASCTarget() {
<span class="nc bnc" id="L14054" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_ALTERNATE_MASC_ENHANCED)) {</span>
<span class="nc" id="L14055">            return ALTERNATE_MASC_FAILURE_ENHANCED[nMASCLevel];</span>
<span class="nc bnc" id="L14056" title="All 2 branches missed.">        } else if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_ALTERNATE_MASC)) {</span>
<span class="nc" id="L14057">            return ALTERNATE_MASC_FAILURE[nMASCLevel];</span>
        } else {
<span class="nc" id="L14059">            return MASC_FAILURE[nMASCLevel];</span>
        }
    }

    /**
     * This function cheks for masc failure.
     *
     * @param md         the movement path.
     * @param vDesc      the description off the masc failure. used as output.
     * @param vCriticals contains tuple of intiger and critical slot. used as output.
     * @return true if there was a masc failure.
     */
    public boolean checkForMASCFailure(MovePath md, Vector&lt;Report&gt; vDesc,
                                       HashMap&lt;Integer, List&lt;CriticalSlot&gt;&gt; vCriticals) {
<span class="nc bnc" id="L14073" title="All 2 branches missed.">        if (md.hasActiveMASC()) {</span>
<span class="nc" id="L14074">            boolean bFailure = false;</span>

            // If usedMASC is already set, then we've already checked MASC
            // this turn. If we succeded before, return false.
            // If we failed before, the MASC was destroyed, and we wouldn't
            // have gotten here (hasActiveMASC would return false)
<span class="nc bnc" id="L14080" title="All 2 branches missed.">            if (!usedMASC) {</span>
<span class="nc" id="L14081">                Mounted masc = getMASC();</span>
<span class="nc" id="L14082">                Mounted superCharger = getSuperCharger();</span>
<span class="nc" id="L14083">                bFailure = doMASCCheckFor(masc, vDesc, vCriticals);</span>
<span class="nc" id="L14084">                boolean bSuperChargeFailure = doMASCCheckFor(superCharger,</span>
                                                             vDesc, vCriticals);
<span class="nc" id="L14086">                usedMASC = true;</span>
<span class="nc bnc" id="L14087" title="All 4 branches missed.">                return bFailure || bSuperChargeFailure;</span>
            }
        }
<span class="nc" id="L14090">        return false;</span>
    }

    /**
     * check one masc system for failure
     *
     * @param masc
     * @param vDesc
     * @param vCriticals
     * @return
     */
    private boolean doMASCCheckFor(Mounted masc, Vector&lt;Report&gt; vDesc,
                                   HashMap&lt;Integer, List&lt;CriticalSlot&gt;&gt; vCriticals) {
<span class="nc bnc" id="L14103" title="All 4 branches missed.">        if ((masc != null) &amp;&amp; masc.curMode().equals(&quot;Armed&quot;)) {</span>
<span class="nc" id="L14104">            boolean bFailure = false;</span>
<span class="nc" id="L14105">            int nRoll = Compute.d6(2);</span>
<span class="nc bnc" id="L14106" title="All 4 branches missed.">            if (masc.getType().hasSubType(MiscType.S_SUPERCHARGER)</span>
<span class="nc bnc" id="L14107" title="All 6 branches missed.">                &amp;&amp; (((this instanceof Mech) &amp;&amp; ((Mech) this).isIndustrial())</span>
                    || (this instanceof SupportTank) || (this instanceof SupportVTOL))) {
<span class="nc" id="L14109">                nRoll -= 1;</span>
            }
<span class="nc" id="L14111">            usedMASC = true;</span>
<span class="nc" id="L14112">            Report r = new Report(2365);</span>
<span class="nc" id="L14113">            r.subject = getId();</span>
<span class="nc" id="L14114">            r.addDesc(this);</span>
<span class="nc" id="L14115">            r.add(masc.getName());</span>
<span class="nc" id="L14116">            vDesc.addElement(r);</span>
<span class="nc" id="L14117">            r = new Report(2370);</span>
<span class="nc" id="L14118">            r.subject = getId();</span>
<span class="nc" id="L14119">            r.indent();</span>
<span class="nc" id="L14120">            r.add(getMASCTarget());</span>
<span class="nc" id="L14121">            r.add(nRoll);</span>

<span class="nc bnc" id="L14123" title="All 2 branches missed.">            if (nRoll &lt; getMASCTarget()) {</span>
                // uh oh
<span class="nc" id="L14125">                bFailure = true;</span>
<span class="nc" id="L14126">                r.choose(false);</span>
<span class="nc" id="L14127">                vDesc.addElement(r);</span>

<span class="nc" id="L14129">                if (((MiscType) (masc.getType()))</span>
<span class="nc bnc" id="L14130" title="All 2 branches missed.">                        .hasSubType(MiscType.S_SUPERCHARGER)) {</span>
                    // do the damage - engine crits
<span class="nc" id="L14132">                    int hits = 0;</span>
<span class="nc" id="L14133">                    int roll = Compute.d6(2);</span>
<span class="nc" id="L14134">                    r = new Report(6310);</span>
<span class="nc" id="L14135">                    r.subject = getId();</span>
<span class="nc" id="L14136">                    r.add(roll);</span>
<span class="nc" id="L14137">                    r.newlines = 0;</span>
<span class="nc" id="L14138">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L14139" title="All 2 branches missed.">                    if (roll &lt;= 7) {</span>
                        // no effect
<span class="nc" id="L14141">                        r = new Report(6005);</span>
<span class="nc" id="L14142">                        r.subject = getId();</span>
<span class="nc" id="L14143">                        r.newlines = 0;</span>
<span class="nc" id="L14144">                        vDesc.addElement(r);</span>
<span class="nc bnc" id="L14145" title="All 4 branches missed.">                    } else if ((roll &gt;= 8) &amp;&amp; (roll &lt;= 9)) {</span>
<span class="nc" id="L14146">                        hits = 1;</span>
<span class="nc" id="L14147">                        r = new Report(6315);</span>
<span class="nc" id="L14148">                        r.subject = getId();</span>
<span class="nc" id="L14149">                        r.newlines = 0;</span>
<span class="nc" id="L14150">                        vDesc.addElement(r);</span>
<span class="nc bnc" id="L14151" title="All 4 branches missed.">                    } else if ((roll &gt;= 10) &amp;&amp; (roll &lt;= 11)) {</span>
<span class="nc" id="L14152">                        hits = 2;</span>
<span class="nc" id="L14153">                        r = new Report(6320);</span>
<span class="nc" id="L14154">                        r.subject = getId();</span>
<span class="nc" id="L14155">                        r.newlines = 0;</span>
<span class="nc" id="L14156">                        vDesc.addElement(r);</span>
<span class="nc bnc" id="L14157" title="All 2 branches missed.">                    } else if (roll == 12) {</span>
<span class="nc" id="L14158">                        hits = 3;</span>
<span class="nc" id="L14159">                        r = new Report(6325);</span>
<span class="nc" id="L14160">                        r.subject = getId();</span>
<span class="nc" id="L14161">                        r.newlines = 0;</span>
<span class="nc" id="L14162">                        vDesc.addElement(r);</span>
                    }
<span class="nc bnc" id="L14164" title="All 2 branches missed.">                    if (this instanceof Mech) {</span>
<span class="nc" id="L14165">                        vCriticals.put(Mech.LOC_CT,</span>
                                       new LinkedList&lt;CriticalSlot&gt;());
<span class="nc bnc" id="L14167" title="All 4 branches missed.">                        for (int i = 0; (i &lt; 12) &amp;&amp; (hits &gt; 0); i++) {</span>
<span class="nc" id="L14168">                            CriticalSlot cs = getCritical(Mech.LOC_CT, i);</span>
<span class="nc bnc" id="L14169" title="All 2 branches missed.">                            if ((cs.getType() == CriticalSlot.TYPE_SYSTEM)</span>
<span class="nc bnc" id="L14170" title="All 2 branches missed.">                                &amp;&amp; (cs.getIndex() == Mech.SYSTEM_ENGINE)</span>
<span class="nc bnc" id="L14171" title="All 2 branches missed.">                                &amp;&amp; cs.isHittable()) {</span>
<span class="nc" id="L14172">                                vCriticals.get(Mech.LOC_CT)</span>
<span class="nc" id="L14173">                                          .add(cs);</span>
<span class="nc" id="L14174">                                hits--;</span>
                            }
                        }
                    } else {
                        // this must be a Tank
<span class="nc" id="L14179">                        Tank tank = (Tank) this;</span>
<span class="nc bnc" id="L14180" title="All 2 branches missed.">                        boolean vtolStabilizerHit = (this instanceof VTOL)</span>
<span class="nc bnc" id="L14181" title="All 2 branches missed.">                                                    &amp;&amp; tank.isStabiliserHit(VTOL.LOC_ROTOR);</span>
<span class="nc" id="L14182">                        boolean minorMovementDamage = tank</span>
<span class="nc" id="L14183">                                .hasMinorMovementDamage();</span>
<span class="nc" id="L14184">                        boolean moderateMovementDamage = tank</span>
<span class="nc" id="L14185">                                .hasModerateMovementDamage();</span>
<span class="nc" id="L14186">                        boolean heavyMovementDamage = tank</span>
<span class="nc" id="L14187">                                .hasHeavyMovementDamage();</span>
<span class="nc" id="L14188">                        vCriticals.put(Tank.LOC_BODY, new LinkedList&lt;&gt;());</span>
<span class="nc" id="L14189">                        vCriticals.put(-1, new LinkedList&lt;&gt;());</span>
<span class="nc bnc" id="L14190" title="All 2 branches missed.">                        if (tank instanceof VTOL) {</span>
<span class="nc" id="L14191">                            vCriticals.put(VTOL.LOC_ROTOR, new LinkedList&lt;&gt;());</span>
                        }
<span class="nc bnc" id="L14193" title="All 2 branches missed.">                        for (int i = 0; i &lt; hits; i++) {</span>
<span class="nc bnc" id="L14194" title="All 2 branches missed.">                            if (tank instanceof VTOL) {</span>
<span class="nc bnc" id="L14195" title="All 2 branches missed.">                                if (vtolStabilizerHit) {</span>
<span class="nc" id="L14196">                                    vCriticals.get(Tank.LOC_BODY).add(new CriticalSlot(</span>
                                                      CriticalSlot.TYPE_SYSTEM,
                                                      Tank.CRIT_ENGINE));
                                } else {
<span class="nc" id="L14200">                                    vCriticals</span>
<span class="nc" id="L14201">                                            .get(VTOL.LOC_ROTOR).add(new CriticalSlot(</span>
                                                    CriticalSlot.TYPE_SYSTEM,
                                                    VTOL.CRIT_FLIGHT_STABILIZER));
<span class="nc" id="L14204">                                    vtolStabilizerHit = true;</span>
                                }
                            } else {
<span class="nc bnc" id="L14207" title="All 2 branches missed.">                                if (heavyMovementDamage) {</span>
<span class="nc" id="L14208">                                    vCriticals.get(Tank.LOC_BODY).add(new CriticalSlot(</span>
                                                      CriticalSlot.TYPE_SYSTEM,
                                                      Tank.CRIT_ENGINE));
<span class="nc bnc" id="L14211" title="All 2 branches missed.">                                } else if (moderateMovementDamage) {</span>
                                    // HACK: we abuse the criticalslot item to
                                    // signify the calling function to deal
                                    // movement damage
<span class="nc" id="L14215">                                    vCriticals</span>
<span class="nc" id="L14216">                                            .get(-1).add(new CriticalSlot(</span>
                                                    CriticalSlot.TYPE_SYSTEM, 3));
<span class="nc" id="L14218">                                    heavyMovementDamage = true;</span>
<span class="nc bnc" id="L14219" title="All 2 branches missed.">                                } else if (minorMovementDamage) {</span>
                                    // HACK: we abuse the criticalslot item to
                                    // signify the calling function to deal
                                    // movement damage
<span class="nc" id="L14223">                                    vCriticals</span>
<span class="nc" id="L14224">                                            .get(-1).add(new CriticalSlot(</span>
                                                    CriticalSlot.TYPE_SYSTEM, 2));
<span class="nc" id="L14226">                                    moderateMovementDamage = true;</span>
                                } else {
                                    // HACK: we abuse the criticalslot item to
                                    // signify the calling function to deal
                                    // movement damage
<span class="nc" id="L14231">                                    vCriticals</span>
<span class="nc" id="L14232">                                            .get(-1).add(new CriticalSlot(</span>
                                                    CriticalSlot.TYPE_SYSTEM, 1));
<span class="nc" id="L14234">                                    minorMovementDamage = true;</span>
                                }
                            }
                        }
                    }

<span class="nc" id="L14240">                } else {</span>
                    // do the damage.
                    // random crit on each leg, but MASC is not destroyed
<span class="nc bnc" id="L14243" title="All 2 branches missed.">                    for (int loc = 0; loc &lt; locations(); loc++) {</span>
<span class="nc bnc" id="L14244" title="All 2 branches missed.">                        if (locationIsLeg(loc)</span>
<span class="nc bnc" id="L14245" title="All 2 branches missed.">                            &amp;&amp; (getHittableCriticals(loc) &gt; 0)) {</span>
<span class="nc" id="L14246">                            CriticalSlot slot = null;</span>
                            do {
<span class="nc" id="L14248">                                int slotIndex = Compute</span>
<span class="nc" id="L14249">                                        .randomInt(getNumberOfCriticals(loc));</span>
<span class="nc" id="L14250">                                slot = getCritical(loc, slotIndex);</span>
<span class="nc bnc" id="L14251" title="All 4 branches missed.">                            } while ((slot == null) || !slot.isHittable());</span>
<span class="nc" id="L14252">                            vCriticals.put(loc, new LinkedList&lt;&gt;());</span>
<span class="nc" id="L14253">                            vCriticals.get(loc).add(slot);</span>
                        }
                    }
                }
                // failed a PSR, check for stalling
<span class="nc" id="L14258">                doCheckEngineStallRoll(vDesc);</span>
            } else {
<span class="nc" id="L14260">                r.choose(true);</span>
<span class="nc" id="L14261">                vDesc.addElement(r);</span>
            }
<span class="nc" id="L14263">            return bFailure;</span>
        }
<span class="nc" id="L14265">        return false;</span>
    }

    /**
     * get non-supercharger MASC mounted on this entity
     *
     * @return
     */
    public Mounted getMASC() {
<span class="nc bnc" id="L14274" title="All 2 branches missed.">        for (Mounted m : getMisc()) {</span>
<span class="nc" id="L14275">            MiscType mtype = (MiscType) m.getType();</span>
<span class="nc bnc" id="L14276" title="All 4 branches missed.">            if (mtype.hasFlag(MiscType.F_MASC) &amp;&amp; m.isReady()</span>
<span class="nc bnc" id="L14277" title="All 2 branches missed.">                &amp;&amp; !mtype.hasSubType(MiscType.S_SUPERCHARGER)</span>
<span class="nc bnc" id="L14278" title="All 2 branches missed.">                &amp;&amp; !mtype.hasSubType(MiscType.S_JETBOOSTER)) {</span>
<span class="nc" id="L14279">                return m;</span>
            }
<span class="nc" id="L14281">        }</span>
<span class="nc" id="L14282">        return null;</span>
    }

    /**
     * get a supercharger mounted on this mech
     *
     * @return
     */
    public Mounted getSuperCharger() {
<span class="nc bnc" id="L14291" title="All 2 branches missed.">        for (Mounted m : getMisc()) {</span>
<span class="nc" id="L14292">            MiscType mtype = (MiscType) m.getType();</span>
<span class="nc bnc" id="L14293" title="All 4 branches missed.">            if (mtype.hasFlag(MiscType.F_MASC) &amp;&amp; m.isReady()</span>
<span class="nc bnc" id="L14294" title="All 2 branches missed.">                &amp;&amp; mtype.hasSubType(MiscType.S_SUPERCHARGER)) {</span>
<span class="nc" id="L14295">                return m;</span>
            }
<span class="nc" id="L14297">        }</span>
<span class="nc" id="L14298">        return null;</span>
    }

    public abstract int getEngineHits();

    /**
     * Returns the number of destroyed jump jets.
     */
    public int damagedJumpJets() {
<span class="nc" id="L14307">        int jumpJets = 0;</span>
<span class="nc bnc" id="L14308" title="All 2 branches missed.">        for (Mounted mounted : getMisc()) {</span>
<span class="nc" id="L14309">            EquipmentType etype = mounted.getType();</span>
<span class="nc bnc" id="L14310" title="All 2 branches missed.">            if (!mounted.isDestroyed()) {</span>
<span class="nc" id="L14311">                continue;</span>
            }
<span class="nc bnc" id="L14313" title="All 2 branches missed.">            if (etype.hasFlag(MiscType.F_JUMP_JET)) {</span>
<span class="nc" id="L14314">                jumpJets++;</span>
            }
<span class="nc" id="L14316">        }</span>
<span class="nc" id="L14317">        return jumpJets;</span>
    }

    public abstract String getLocationDamage(int loc);

    /**
     * This method returns a true if the unit can reasonably escape from the
     * board. It can be used to determine whether some non-destroyed units
     * should be considered possible salvage.
     *
     * @return
     */
    public boolean canEscape() {
<span class="nc bnc" id="L14330" title="All 2 branches missed.">        if(null == getCrew()) {</span>
<span class="nc" id="L14331">            return false;</span>
        }
        //if the crew is unconscious, dead, or ejected, no escape
<span class="nc bnc" id="L14334" title="All 2 branches missed.">        if(getCrew().isUnconscious()</span>
<span class="nc bnc" id="L14335" title="All 2 branches missed.">                || getCrew().isDead()</span>
<span class="nc bnc" id="L14336" title="All 4 branches missed.">                || (getCrew().isEjected() &amp;&amp; !(this instanceof EjectedCrew))) {</span>
<span class="nc" id="L14337">            return false;</span>
        }

        //what else? If its permaneantly immobilized or shutdown it can't escape
        //TODO: should stalled and stuck be here?
<span class="nc bnc" id="L14342" title="All 4 branches missed.">        return !isPermanentlyImmobilized(false) &amp;&amp; !isShutDown();</span>
    }

    /**
     * Returns TRUE if the entity meets the requirements for crippling damage as
     * detailed in TW pg 258.
     *
     * @return boolean
     */
    public abstract boolean isCrippled();

    /**
     * Returns TRUE if the entity meets the requirements for crippling damage as
     * detailed in TW pg 258. Excepting dead or non-existing crew issues
     *
     * @return boolean
     */
    public abstract boolean isCrippled(boolean checkCrew);

    /**
     * Returns TRUE if the entity has been heavily damaged.
     *
     * @return boolean
     */
    public abstract boolean isDmgHeavy();

    /**
     * Returns TRUE if the entity has been moderately damaged.
     *
     * @return boolean
     */
    public abstract boolean isDmgModerate();

    /**
     * Returns TRUE if the entity has been lightly damaged.
     *
     * @return boolean
     */
    public abstract boolean isDmgLight();

    /**
     * Returns the entity's current damage level.
     *
     * @return DMG_CRIPLED, DMG_HEAVY, DMG_MODERATE, DMG_LIGHT or DMG_NONE.
     */
    public int getDamageLevel() {
<span class="nc" id="L14388">        return getDamageLevel(true);</span>
    }

    /**
     * Returns the entity's current damage level.
     *
     * @return DMG_CRIPLED, DMG_HEAVY, DMG_MODERATE, DMG_LIGHT or DMG_NONE.
     */
    public int getDamageLevel(boolean checkCrew) {
<span class="nc bnc" id="L14397" title="All 2 branches missed.">        if (isCrippled(checkCrew)) {</span>
<span class="nc" id="L14398">            return DMG_CRIPPLED;</span>
        }
<span class="nc bnc" id="L14400" title="All 2 branches missed.">        if (isDmgHeavy()) {</span>
<span class="nc" id="L14401">            return DMG_HEAVY;</span>
        }
<span class="nc bnc" id="L14403" title="All 2 branches missed.">        if (isDmgModerate()) {</span>
<span class="nc" id="L14404">            return DMG_MODERATE;</span>
        }
<span class="nc bnc" id="L14406" title="All 2 branches missed.">        if (isDmgLight()) {</span>
<span class="nc" id="L14407">            return DMG_LIGHT;</span>
        }
<span class="nc" id="L14409">        return DMG_NONE;</span>
    }

    // Make a UUID for this entity and assign it to entity's String c3UUID
    public void setC3UUID() {
<span class="nc" id="L14414">        UUID id = UUID.randomUUID();</span>

<span class="nc" id="L14416">        setC3UUIDAsString(id.toString());</span>
<span class="nc" id="L14417">    }</span>

    public void setC3UUIDAsString(String c3id) {
<span class="nc" id="L14420">        c3UUID = c3id;</span>
<span class="nc" id="L14421">    }</span>

    public String getC3UUIDAsString() {
<span class="nc" id="L14424">        return c3UUID;</span>
    }

    public void setC3MasterIsUUIDAsString(String c3id) {
<span class="nc" id="L14428">        c3MasterIsUUID = c3id;</span>
<span class="nc" id="L14429">    }</span>

    public String getC3MasterIsUUIDAsString() {
<span class="nc" id="L14432">        return c3MasterIsUUID;</span>
    }

    public void setC3iNextUUIDAsString(int pos, String c3id) {
<span class="nc" id="L14436">        c3iUUIDs[pos] = c3id;</span>
<span class="nc" id="L14437">    }</span>

    public String getC3iNextUUIDAsString(int pos) {
<span class="nc" id="L14440">        return c3iUUIDs[pos];</span>
    }

    public int getFreeC3iUUID() {
<span class="nc" id="L14444">        int pos = 0;</span>
<span class="nc bnc" id="L14445" title="All 2 branches missed.">        while (c3iUUIDs[pos] != null) {</span>
<span class="nc" id="L14446">            pos++;</span>
<span class="nc bnc" id="L14447" title="All 2 branches missed.">            if (pos &gt;= MAX_C3i_NODES) {</span>
<span class="nc" id="L14448">                return -1;</span>
            }
        }
<span class="nc" id="L14451">        return pos;</span>
    }

    public void setNC3NextUUIDAsString(int pos, String c3id) {
<span class="nc" id="L14455">        NC3UUIDs[pos] = c3id;</span>
<span class="nc" id="L14456">    }</span>

    public String getNC3NextUUIDAsString(int pos) {
<span class="nc" id="L14459">        return NC3UUIDs[pos];</span>
    }

    public int getFreeNC3UUID() {
<span class="nc" id="L14463">        int pos = 0;</span>
<span class="nc bnc" id="L14464" title="All 2 branches missed.">        while (NC3UUIDs[pos] != null) {</span>
<span class="nc" id="L14465">            pos++;</span>
<span class="nc bnc" id="L14466" title="All 2 branches missed.">            if (pos &gt;= MAX_C3i_NODES) {</span>
<span class="nc" id="L14467">                return -1;</span>
            }
        }
<span class="nc" id="L14470">        return pos;</span>
    }

    /**
     * Indicates if a unit was physically struck (punch, kick, DFA, etc).
     *
     * @return
     */
    public boolean wasStruck() {
<span class="nc" id="L14479">        return struck;</span>
    }

    /**
     * Indicates if a unit was physically struck (punch, kick, DFA, etc).
     *
     * @return
     */
    public void setStruck(boolean struck) {
<span class="nc" id="L14488">        this.struck = struck;</span>
<span class="nc" id="L14489">    }</span>

    /**
     * Indicates if a unit has falling in the current phase.
     *
     * @return
     */
    public boolean hasFallen() {
<span class="nc" id="L14497">        return fell;</span>
    }

    /**
     * Indicates if a unit has falling in the current phase.
     *
     * @return
     */
    public void setFallen(boolean fell) {
<span class="nc" id="L14506">        this.fell = fell;</span>
<span class="nc" id="L14507">    }</span>

    /**
     * This is used to get an alternative cost that will be added to the
     * MechSummaryCache - at the moment it is primarily used to rework infantry
     * costs for MekHQ, but it could be applied to other unit types as well -
     * defaults to -1, so there is no confusion
     *
     * @return
     */
    public double getAlternateCost() {
<span class="nc" id="L14518">        return -1;</span>
    }

    /**
     * Are we trapped inside of a destroyed transport? If so we shouldn't count
     * for BV, which is why we have this check.
     */
    public boolean isTrapped() {
<span class="nc bnc" id="L14526" title="All 2 branches missed.">        if (getTransportId() != Entity.NONE) {</span>
<span class="nc" id="L14527">            Entity transport = game.getEntity(getTransportId());</span>
<span class="nc bnc" id="L14528" title="All 2 branches missed.">            if (transport == null) {</span>
<span class="nc" id="L14529">                transport = game.getOutOfGameEntity(getTransportId());</span>
            }
<span class="nc bnc" id="L14531" title="All 2 branches missed.">            if (transport.isDestroyed()) {</span>
<span class="nc" id="L14532">                return true;</span>
            }
        }
<span class="nc" id="L14535">        return false;</span>
    }

    // Deal with per entity camo
    public Camouflage getCamouflage() {
<span class="nc" id="L14540">        return camouflage;</span>
    }

    public Camouflage getCamouflageOrElse(Camouflage camouflage) {
<span class="nc bnc" id="L14544" title="All 2 branches missed.">        return getCamouflage().hasDefaultCategory() ? camouflage : getCamouflage();</span>
    }

    public void setCamouflage(Camouflage camouflage) {
<span class="nc" id="L14548">        this.camouflage = camouflage;</span>
<span class="nc" id="L14549">    }</span>

    @Deprecated
    public void setCamoCategory(String name) {
<span class="nc" id="L14553">        getCamouflage().setCategory(name);</span>
<span class="nc" id="L14554">    }</span>

    @Deprecated
    public String getCamoCategory() {
<span class="nc" id="L14558">        return getCamouflage().getCategory();</span>
    }

    @Deprecated
    public void setCamoFileName(String name) {
<span class="nc" id="L14563">        getCamouflage().setFilename(name);</span>
<span class="nc" id="L14564">    }</span>

    @Deprecated
    public String getCamoFileName() {
<span class="nc" id="L14568">        return getCamouflage().getFilename();</span>
    }

    public boolean getSelfDestructing() {
<span class="nc" id="L14572">        return selfDestructing;</span>
    }

    public void setSelfDestructing(boolean tf) {
<span class="nc" id="L14576">        selfDestructing = tf;</span>
<span class="nc" id="L14577">    }</span>

    public boolean getSelfDestructInitiated() {
<span class="nc" id="L14580">        return selfDestructInitiated;</span>
    }

    public void setSelfDestructInitiated(boolean tf) {
<span class="nc" id="L14584">        selfDestructInitiated = tf;</span>
<span class="nc" id="L14585">    }</span>

    public boolean getSelfDestructedThisTurn() {
<span class="nc" id="L14588">        return selfDestructedThisTurn;</span>
    }

    public void setSelfDestructedThisTurn(boolean tf) {
<span class="nc" id="L14592">        selfDestructedThisTurn = tf;</span>
<span class="nc" id="L14593">    }</span>

    public void setIsJumpingNow(boolean jumped) {
<span class="nc" id="L14596">        isJumpingNow = jumped;</span>
<span class="nc" id="L14597">    }</span>

    public boolean getIsJumpingNow() {
<span class="nc" id="L14600">        return isJumpingNow;</span>
    }

    public void setConvertingNow(boolean converting) {
<span class="nc" id="L14604">        convertingNow = converting;</span>
<span class="nc" id="L14605">    }</span>

    public boolean isConvertingNow() {
<span class="nc" id="L14608">        return convertingNow;</span>
    }

    public int getConversionMode() {
<span class="nc" id="L14612">        return conversionMode;</span>
    }

    /**
     * Units capable of converting mode should override this to perform any other necessary changes.
     * @param mode
     */
    public void setConversionMode(int mode) {
<span class="nc" id="L14620">        conversionMode = mode;</span>
<span class="nc" id="L14621">    }</span>

    /**
     * Entities that can convert movement modes (LAMs, QuadVees) report the next mode to assume
     * when a convert movement command is processed. This provides a set order for cycling through
     * available modes.
     *
     * @param afterMode The movement mode to convert from.
     * @return          The next movement mode in the sequence.
     */
    public EntityMovementMode nextConversionMode(EntityMovementMode afterMode) {
<span class="nc" id="L14632">        return movementMode;</span>
    }

    /**
     * Sets the movement mode to the next in the conversion sequence for QuadVees, LAMs, and Mechs
     * with tracks. In most cases this switches between two available modes, but LAMs that start
     * the turn in AirMech mode have three available.
     */
    public void toggleConversionMode() {
<span class="nc" id="L14641">        setMovementMode(nextConversionMode(movementMode));</span>
<span class="nc" id="L14642">    }</span>

    /**
     * Only applicable to Mechs, but here for convenience. Mechs that are already prone, or
     * QuadVees and LAMs in non-leg mode are not subject to PSRs for falling. Note that PSRs
     * are sometimes required for other reasons.
     *
     * @param gyroLegDamage Whether the potential fall is due to damage to gyro or leg actuators,
     *                      in which case Mechs using tracks are not subject to falls.
     * @return              Whether the &lt;code&gt;Entity&lt;/code&gt; is required to make PSRs to avoid falling.
     */
    public boolean canFall(boolean gyroLegDamage) {
<span class="nc" id="L14654">        return false;</span>
    }

    /**
     * Only applicable to Mechs, but here for convenience. Mechs that are already prone, or
     * QuadVees and LAMs in fighter mode are not subject to PSRs for falling. Note that PSRs
     * are sometimes required for other reasons.
     *
     * @return Whether the &lt;code&gt;Entity&lt;/code&gt; is required to make PSRs to avoid falling.
     */
    public boolean canFall() {
<span class="nc" id="L14665">        return canFall(false);</span>
    }

    public void setTraitorId(int id) {
<span class="nc" id="L14669">        traitorId = id;</span>
<span class="nc" id="L14670">    }</span>

    public int getTraitorId() {
<span class="nc" id="L14673">        return traitorId;</span>
    }

    /**
     * Used to determine net velocity of ramming attack
     */
    public int sideTableRam(Coords src) {
<span class="nc" id="L14680">        return sideTableRam(src, facing);</span>
    }

    public int sideTableRam(Coords src, int facing) {
<span class="nc" id="L14684">        int fa = (getPosition().degree(src) + ((6 - facing) * 60)) % 360;</span>
<span class="nc bnc" id="L14685" title="All 8 branches missed.">        if (((fa &gt; 30) &amp;&amp; (fa &lt;= 90)) || ((fa &lt; 330) &amp;&amp; (fa &gt;= 270))) {</span>
<span class="nc" id="L14686">            return Aero.RAM_TOWARD_OBL;</span>
<span class="nc bnc" id="L14687" title="All 4 branches missed.">        } else if ((fa &gt; 150) &amp;&amp; (fa &lt; 210)) {</span>
<span class="nc" id="L14688">            return Aero.RAM_AWAY_DIR;</span>
<span class="nc bnc" id="L14689" title="All 8 branches missed.">        } else if (((fa &gt; 90) &amp;&amp; (fa &lt;= 150)) || ((fa &lt; 270) &amp;&amp; (fa &gt;= 210))) {</span>
<span class="nc" id="L14690">            return Aero.RAM_AWAY_OBL;</span>
        } else {
<span class="nc" id="L14692">            return Aero.RAM_TOWARD_DIR;</span>
        }
    }

    public void setArmorTonnage(double ton) {
<span class="nc" id="L14697">        armorTonnage = ton;</span>
<span class="nc" id="L14698">    }</span>

    public double getLabArmorTonnage() {
<span class="nc" id="L14701">        return armorTonnage;</span>
    }

    public int getLabTotalArmorPoints() {
<span class="nc bnc" id="L14705" title="All 4 branches missed.">        if (isSupportVehicle() &amp;&amp; (getArmorType(firstArmorIndex()) == EquipmentType.T_ARMOR_STANDARD)</span>
<span class="nc bnc" id="L14706" title="All 2 branches missed.">            &amp;&amp; !hasPatchworkArmor()) {</span>
<span class="nc" id="L14707">            return (int) Math.floor(armorTonnage</span>
<span class="nc" id="L14708">                    / EquipmentType.getSupportVehicleArmorWeightPerPoint(getBARRating(firstArmorIndex()),</span>
<span class="nc" id="L14709">                    getArmorTechRating()));</span>
        }
<span class="nc" id="L14711">        double armorPerTon = 16.0 * EquipmentType.getArmorPointMultiplier(</span>
                armorType[0], armorTechLevel[0]);
<span class="nc" id="L14713">        return (int) Math.floor(armorPerTon * armorTonnage);</span>
    }

    public void loadDefaultCustomWeaponOrder() {
<span class="nc" id="L14717">        WeaponOrderHandler.WeaponOrder weapOrder = WeaponOrderHandler.getWeaponOrder(</span>
<span class="nc" id="L14718">                getChassis(), getModel());</span>

<span class="nc bnc" id="L14720" title="All 2 branches missed.">        if (weapOrder != null) {</span>
<span class="nc" id="L14721">            setWeaponSortOrder(weapOrder.orderType);</span>
<span class="nc" id="L14722">            setCustomWeaponOrder(weapOrder.customWeaponOrderMap);</span>
        }
<span class="nc" id="L14724">    }</span>

    public void loadDefaultQuirks() {

        // Get a list of quirks for this entity.
<span class="nc" id="L14729">        List&lt;QuirkEntry&gt; quirks = QuirksHandler.getQuirks(this);</span>

        // If this unit has no quirks, we do not need to proceed further.
<span class="nc bnc" id="L14732" title="All 4 branches missed.">        if ((quirks == null) || quirks.isEmpty()) {</span>
<span class="nc" id="L14733">            return;</span>
        }

        // System.out.println(&quot;Loading quirks for &quot; + getChassis() + &quot; &quot; +
        // getModel());

        // Load all the unit's quirks.
<span class="nc bnc" id="L14740" title="All 2 branches missed.">        for (QuirkEntry q : quirks) {</span>

            // System.out.print(&quot;  &quot; + q.toLog() + &quot;... &quot;);

            // If the quirk doesn't have a location, then it is a unit quirk,
            // not a weapon quirk.
<span class="nc bnc" id="L14746" title="All 2 branches missed.">            if (StringUtil.isNullOrEmpty(q.getLocation())) {</span>

                // Activate the unit quirk.
<span class="nc bnc" id="L14749" title="All 2 branches missed.">                if (getQuirks().getOption(q.getQuirk()) == null) {</span>
<span class="nc" id="L14750">                    System.out.println(q.toLog() + &quot; failed for &quot;</span>
<span class="nc" id="L14751">                                       + getChassis() + &quot; &quot; + getModel()</span>
                                       + &quot; - Invalid quirk!&quot;);
<span class="nc" id="L14753">                    continue;</span>
                }
<span class="nc" id="L14755">                getQuirks().getOption(q.getQuirk()).setValue(true);</span>
                // System.out.println(&quot;Loaded.&quot;);
<span class="nc" id="L14757">                continue;</span>
            }

            // Get the weapon in the indicated location and slot.
            // System.out.print(&quot;Getting CriticalSlot... &quot;);
<span class="nc" id="L14762">            CriticalSlot cs = getCritical(getLocationFromAbbr(q.getLocation()),</span>
<span class="nc" id="L14763">                                          q.getSlot());</span>
<span class="nc bnc" id="L14764" title="All 2 branches missed.">            if (cs == null) {</span>
<span class="nc" id="L14765">                System.out.println(q.toLog() + &quot; failed for &quot; + getChassis()</span>
<span class="nc" id="L14766">                                   + &quot; &quot; + getModel() + &quot; - Critical slot (&quot;</span>
<span class="nc" id="L14767">                                   + q.getLocation() + &quot;-&quot; + q.getSlot()</span>
                                   + &quot;) did not load!&quot;);
<span class="nc" id="L14769">                continue;</span>
            }
<span class="nc" id="L14771">            Mounted m = cs.getMount();</span>
<span class="nc bnc" id="L14772" title="All 2 branches missed.">            if (m == null) {</span>
<span class="nc" id="L14773">                System.out.println(q.toLog() + &quot; failed for &quot; + getChassis()</span>
<span class="nc" id="L14774">                                   + &quot; &quot; + getModel() + &quot; - Critical slot (&quot;</span>
<span class="nc" id="L14775">                                   + q.getLocation() + &quot;-&quot; + q.getSlot() + &quot;) is empty!&quot;);</span>
<span class="nc" id="L14776">                continue;</span>
            }

            // Make sure this is a weapon.
            // System.out.print(&quot;Getting WeaponType... &quot;);
<span class="nc bnc" id="L14781" title="All 2 branches missed.">            if (!(m.getType() instanceof WeaponType)</span>
<span class="nc bnc" id="L14782" title="All 2 branches missed.">                    &amp;&amp; !(m.getType().hasFlag(MiscType.F_CLUB))) {</span>
<span class="nc" id="L14783">                System.out.println(q.toLog() + &quot; failed for &quot; + getChassis()</span>
<span class="nc" id="L14784">                                   + &quot; &quot; + getModel() + &quot; - &quot; + m.getName()</span>
                                   + &quot; is not a weapon!&quot;);
<span class="nc" id="L14786">                continue;</span>
            }

            // Make sure it is the weapon we expect.
            // System.out.print(&quot;Matching weapon... &quot;);
<span class="nc" id="L14791">            boolean matchFound = false;</span>
<span class="nc" id="L14792">            Enumeration&lt;String&gt; typeNames = m.getType().getNames();</span>
<span class="nc bnc" id="L14793" title="All 2 branches missed.">            while (typeNames.hasMoreElements()) {</span>
<span class="nc" id="L14794">                String typeName = typeNames.nextElement();</span>
                // System.out.print(typeName + &quot;... &quot;);
<span class="nc bnc" id="L14796" title="All 2 branches missed.">                if (typeName.equals(q.getWeaponName())) {</span>
<span class="nc" id="L14797">                    matchFound = true;</span>
<span class="nc" id="L14798">                    break;</span>
                }
<span class="nc" id="L14800">            }</span>
<span class="nc bnc" id="L14801" title="All 2 branches missed.">            if (!matchFound) {</span>
<span class="nc" id="L14802">                System.out.println(q.toLog() + &quot; failed for &quot; + getChassis()</span>
<span class="nc" id="L14803">                                   + &quot; &quot; + getModel() + &quot; - &quot; + m.getType().getName()</span>
<span class="nc" id="L14804">                                   + &quot; != &quot; + q.getWeaponName());</span>
<span class="nc" id="L14805">                continue;</span>
            }

            // Activate the weapon quirk.
            // System.out.print(&quot;Activating quirk... &quot;);
<span class="nc bnc" id="L14810" title="All 2 branches missed.">            if (m.getQuirks().getOption(q.getQuirk()) == null) {</span>
<span class="nc" id="L14811">                System.out.println(q.toLog() + &quot; failed for &quot; + getChassis()</span>
<span class="nc" id="L14812">                                   + &quot; &quot; + getModel() + &quot; - Invalid quirk!&quot;);</span>
<span class="nc" id="L14813">                continue;</span>
            }
<span class="nc" id="L14815">            m.getQuirks().getOption(q.getQuirk()).setValue(true);</span>
            // System.out.println(&quot;Loaded.&quot;);
<span class="nc" id="L14817">        }</span>
<span class="nc" id="L14818">    }</span>

    @Override
    public void newPhase(IGame.Phase phase) {
<span class="nc bnc" id="L14822" title="All 2 branches missed.">        for (Mounted m : getEquipment()) {</span>
<span class="nc" id="L14823">            m.newPhase(phase);</span>
<span class="nc" id="L14824">        }</span>
<span class="nc bnc" id="L14825" title="All 2 branches missed.">        if (getCrew().isDoomed()) {</span>
<span class="nc" id="L14826">            getCrew().setDoomed(false);</span>
<span class="nc" id="L14827">            getCrew().setDead(true);</span>
<span class="nc bnc" id="L14828" title="All 2 branches missed.">            if (this instanceof Tank) {</span>
<span class="nc" id="L14829">                setCarcass(true);</span>
<span class="nc" id="L14830">                ((Tank) this).immobilize();</span>
            } else {
<span class="nc" id="L14832">                setDestroyed(true);</span>
            }
        }
<span class="nc" id="L14835">        setIsJumpingNow(false);</span>
<span class="nc" id="L14836">    }</span>

    /**
     * Checks to see if the entities' elevation is below the surface of a water
     * hex.
     *
     * @return True if the entity is underwater, else false.
     */
    public boolean isUnderwater() {
<span class="nc" id="L14845">        IHex occupiedHex = game.getBoard().getHex(getPosition());</span>
<span class="nc bnc" id="L14846" title="All 2 branches missed.">        if (occupiedHex.containsTerrain(Terrains.WATER)</span>
<span class="nc bnc" id="L14847" title="All 2 branches missed.">            &amp;&amp; (relHeight() &lt; occupiedHex.surface())) {</span>
<span class="nc" id="L14848">            return true;</span>
        }
<span class="nc" id="L14850">        return false;</span>
    }

    public int getTechLevelYear() {
<span class="nc bnc" id="L14854" title="All 2 branches missed.">        if (game != null) {</span>
<span class="nc" id="L14855">            return game.getOptions().intOption(OptionsConstants.ALLOWED_YEAR);</span>
        }
<span class="nc" id="L14857">        return year;</span>
    }

    public int getTargetBay() {
<span class="nc" id="L14861">        return targetBay;</span>
    }

    public void setTargetBay(int tb) {
<span class="nc" id="L14865">        targetBay = tb;</span>
<span class="nc" id="L14866">    }</span>

    public abstract long getEntityType();

    /**
     * Convenience method that checks whether a bit is set in the entity type field.
     *
     * @param flag An ETYPE_* value
     * @return     true if getEntityType() has the flag set
     */
    public boolean hasETypeFlag(long flag) {
<span class="nc bnc" id="L14877" title="All 2 branches missed.">        return (getEntityType() &amp; flag) == flag;</span>
    }

    /**
     * Given an Entity type, return the name of the major class it belongs to
     * (eg: Mech, Aero, Tank, Infantry).
     *
     * @param typeId The type Id to get a major name for
     * @return The major class name for the given type id
     */
    public static String getEntityMajorTypeName(long typeId) {
<span class="nc bnc" id="L14888" title="All 2 branches missed.">        if ((typeId &amp; ETYPE_MECH) == ETYPE_MECH) {</span>
<span class="nc" id="L14889">            return &quot;Mech&quot;;</span>
<span class="nc bnc" id="L14890" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_AERO) == ETYPE_AERO) {</span>
<span class="nc" id="L14891">            return &quot;Aero&quot;;</span>
<span class="nc bnc" id="L14892" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_VTOL) == ETYPE_VTOL) {</span>
<span class="nc" id="L14893">            return &quot;VTOL&quot;;</span>
<span class="nc bnc" id="L14894" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_TANK) == ETYPE_TANK) {</span>
<span class="nc" id="L14895">            return &quot;Tank&quot;;</span>
<span class="nc bnc" id="L14896" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_INFANTRY) == ETYPE_INFANTRY) {</span>
<span class="nc" id="L14897">            return &quot;Infantry&quot;;</span>
<span class="nc bnc" id="L14898" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_PROTOMECH) == ETYPE_PROTOMECH) {</span>
<span class="nc" id="L14899">            return &quot;Protomech&quot;;</span>
        } else {
<span class="nc" id="L14901">            return &quot;Unknown&quot;;</span>
        }
    }

    /**
     * Returns the specific entity type name for the given type id
     * (eg: Biped Mech, Conventional Fighter, VTOL).
     *
     * @param typeId
     * @return
     */
    public static String getEntityTypeName(long typeId) {

<span class="nc bnc" id="L14914" title="All 2 branches missed.">        if ((typeId &amp; ETYPE_BIPED_MECH) == ETYPE_BIPED_MECH) {</span>
<span class="nc" id="L14915">            return &quot;Biped Mech&quot;;</span>
<span class="nc bnc" id="L14916" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_LAND_AIR_MECH) == ETYPE_LAND_AIR_MECH) {</span>
<span class="nc" id="L14917">            return &quot;Landair Mech&quot;;</span>
<span class="nc bnc" id="L14918" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_QUAD_MECH) == ETYPE_QUAD_MECH) {</span>
<span class="nc" id="L14919">            return &quot;Quad Mech&quot;;</span>
<span class="nc bnc" id="L14920" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_TRIPOD_MECH) == ETYPE_TRIPOD_MECH) {</span>
<span class="nc" id="L14921">            return &quot;Tripod Mech&quot;;</span>
<span class="nc bnc" id="L14922" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_ARMLESS_MECH) == ETYPE_ARMLESS_MECH) {</span>
<span class="nc" id="L14923">            return &quot;Armless Mech&quot;;</span>
<span class="nc bnc" id="L14924" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_MECH) == ETYPE_MECH) {</span>
<span class="nc" id="L14925">            return &quot;Mech&quot;;</span>
<span class="nc bnc" id="L14926" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_JUMPSHIP) == ETYPE_JUMPSHIP) {</span>
<span class="nc" id="L14927">            return &quot;JumpShip&quot;;</span>
<span class="nc bnc" id="L14928" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_WARSHIP) == ETYPE_WARSHIP) {</span>
<span class="nc" id="L14929">            return &quot;WarShip&quot;;</span>
<span class="nc bnc" id="L14930" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_SPACE_STATION) == ETYPE_SPACE_STATION) {</span>
<span class="nc" id="L14931">            return &quot;Space Station&quot;;</span>
<span class="nc bnc" id="L14932" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_CONV_FIGHTER) == ETYPE_CONV_FIGHTER) {</span>
<span class="nc" id="L14933">            return &quot;Conventional Fighter&quot;;</span>
<span class="nc bnc" id="L14934" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_FIXED_WING_SUPPORT) == ETYPE_FIXED_WING_SUPPORT) {</span>
<span class="nc" id="L14935">            return &quot;Fixed Wing Support&quot;;</span>
<span class="nc bnc" id="L14936" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_FIGHTER_SQUADRON) == ETYPE_FIGHTER_SQUADRON) {</span>
<span class="nc" id="L14937">            return &quot;Fighter Squadron&quot;;</span>
<span class="nc bnc" id="L14938" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_SMALL_CRAFT) == ETYPE_SMALL_CRAFT) {</span>
<span class="nc" id="L14939">            return &quot;Small Craft&quot;;</span>
<span class="nc bnc" id="L14940" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_DROPSHIP) == ETYPE_DROPSHIP) {</span>
<span class="nc" id="L14941">            return &quot;DropShip&quot;;</span>
<span class="nc bnc" id="L14942" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_TELEMISSILE) == ETYPE_TELEMISSILE) {</span>
<span class="nc" id="L14943">            return &quot;Telemissile&quot;;</span>
<span class="nc bnc" id="L14944" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_AERO) == ETYPE_AERO) {</span>
<span class="nc" id="L14945">            return &quot;Aerospace fighter&quot;;</span>
<span class="nc bnc" id="L14946" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_BATTLEARMOR) == ETYPE_BATTLEARMOR) {</span>
<span class="nc" id="L14947">            return &quot;Battlearmor&quot;;</span>
<span class="nc bnc" id="L14948" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_MECHWARRIOR) == ETYPE_MECHWARRIOR) {</span>
<span class="nc" id="L14949">            return &quot;Mechwarrior&quot;;</span>
<span class="nc bnc" id="L14950" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_PROTOMECH) == ETYPE_PROTOMECH) {</span>
<span class="nc" id="L14951">            return &quot;ProtoMech&quot;;</span>
<span class="nc bnc" id="L14952" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_INFANTRY) == ETYPE_INFANTRY) {</span>
<span class="nc" id="L14953">            return &quot;Infantry&quot;;</span>
<span class="nc bnc" id="L14954" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_GUN_EMPLACEMENT) == ETYPE_GUN_EMPLACEMENT) {</span>
<span class="nc" id="L14955">            return &quot;Gun Emplacement&quot;;</span>
<span class="nc bnc" id="L14956" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_SUPER_HEAVY_TANK) == ETYPE_SUPER_HEAVY_TANK) {</span>
<span class="nc" id="L14957">            return &quot;Superheavy Tank&quot;;</span>
<span class="nc bnc" id="L14958" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_SUPPORT_TANK) == ETYPE_SUPPORT_TANK) {</span>
<span class="nc" id="L14959">            return &quot;Support Tank&quot;;</span>
<span class="nc bnc" id="L14960" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_LARGE_SUPPORT_TANK) == ETYPE_LARGE_SUPPORT_TANK) {</span>
<span class="nc" id="L14961">            return &quot;Large Support Tank&quot;;</span>
<span class="nc bnc" id="L14962" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_VTOL) == ETYPE_VTOL) {</span>
<span class="nc" id="L14963">            return &quot;VTOL&quot;;</span>
<span class="nc bnc" id="L14964" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_SUPPORT_VTOL) == ETYPE_SUPPORT_VTOL) {</span>
<span class="nc" id="L14965">            return &quot;Support VTOL&quot;;</span>
<span class="nc bnc" id="L14966" title="All 2 branches missed.">        } else if ((typeId &amp; ETYPE_TANK) == ETYPE_TANK) {</span>
<span class="nc" id="L14967">            return &quot;Tank&quot;;</span>
        } else {
<span class="nc" id="L14969">            return &quot;Unknown&quot;;</span>
        }
    }

    public void damageSystem(int type, int slot, int hits) {
<span class="nc bnc" id="L14974" title="All 2 branches missed.">        for (int loc = 0; loc &lt; locations(); loc++) {</span>
<span class="nc" id="L14975">            damageSystem(type, slot, loc, hits);</span>
        }
<span class="nc" id="L14977">    }</span>

    public void damageSystem(int type, int slot, int loc, int hits) {
<span class="nc" id="L14980">        int nhits = 0;</span>
<span class="nc bnc" id="L14981" title="All 2 branches missed.">        for (int i = 0; i &lt; getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L14982">            CriticalSlot cs = getCritical(loc, i);</span>
            // ignore empty &amp; system slots
<span class="nc bnc" id="L14984" title="All 4 branches missed.">            if ((cs == null) || (cs.getType() != type)) {</span>
<span class="nc" id="L14985">                continue;</span>
            }
<span class="nc" id="L14987">            Mounted m = null;</span>
<span class="nc bnc" id="L14988" title="All 2 branches missed.">            if (type == CriticalSlot.TYPE_EQUIPMENT) {</span>
<span class="nc" id="L14989">                m = getEquipment(slot);</span>
            }
<span class="nc bnc" id="L14991" title="All 6 branches missed.">            if (((type == CriticalSlot.TYPE_SYSTEM) &amp;&amp; (cs.getIndex() == slot))</span>
                || ((type == CriticalSlot.TYPE_EQUIPMENT)
<span class="nc bnc" id="L14993" title="All 4 branches missed.">                    &amp;&amp; (m.equals(cs.getMount()) || m.equals(cs.getMount2())))) {</span>
<span class="nc bnc" id="L14994" title="All 2 branches missed.">                if (nhits &lt; hits) {</span>
<span class="nc" id="L14995">                    cs.setHit(true);</span>
<span class="nc" id="L14996">                    cs.setDestroyed(true);</span>
<span class="nc" id="L14997">                    nhits++;</span>
                } else {
<span class="nc" id="L14999">                    cs.setHit(false);</span>
<span class="nc" id="L15000">                    cs.setDestroyed(false);</span>
<span class="nc" id="L15001">                    cs.setRepairable(true);</span>
                }
            }
        }
<span class="nc" id="L15005">    }</span>

    // Most units cannot eject.
    // ToDo Look up ejection rules for ASF.
    public boolean isEjectionPossible() {
<span class="nc" id="L15010">        return false;</span>
    }

    public int getAllowedPhysicalAttacks() {
<span class="nc bnc" id="L15014" title="All 4 branches missed.">        if ((null != crew) &amp;&amp; hasAbility(OptionsConstants.PILOT_MELEE_MASTER)) {</span>
<span class="nc" id="L15015">            return 2;</span>
        }
<span class="nc" id="L15017">        return 1;</span>
    }

    /**
     * The max weapons range of this entity, taking into account whether or not
     * we're on an air/space map, using extreme range. Assumes target is not airborne
     * if we are on a ground map.
     * @return
     */
    public int getMaxWeaponRange() {
<span class="nc" id="L15027">        return getMaxWeaponRange(false);</span>
    }
    
    /**
     * The max weapons range of this entity, taking into account whether or not
     * we're on an air/space map, using extreme range, and whether or not the target is
     * air borne.
     * @param targetIsAirborne
     * @return
     */
    public int getMaxWeaponRange(boolean targetIsAirborne) {
        // Aeros on the ground map must shoot along their flight path, giving
        // them effectively 0 range
<span class="nc bnc" id="L15040" title="All 4 branches missed.">        if (isAirborneAeroOnGroundMap() &amp;&amp; !targetIsAirborne) {</span>
<span class="nc" id="L15041">            return 0;</span>
        }

<span class="nc" id="L15044">        int maxRange = 0;</span>
<span class="nc bnc" id="L15045" title="All 2 branches missed.">        if ((ETYPE_MECH == getEntityType())</span>
<span class="nc bnc" id="L15046" title="All 2 branches missed.">                || (ETYPE_INFANTRY == getEntityType())</span>
<span class="nc bnc" id="L15047" title="All 2 branches missed.">                || (ETYPE_PROTOMECH == getEntityType())) {</span>
            // account for physical attacks.
<span class="nc" id="L15049">            maxRange = 1;</span>
        }

<span class="nc bnc" id="L15052" title="All 2 branches missed.">        for (Mounted weapon : getWeaponList()) {</span>
<span class="nc bnc" id="L15053" title="All 2 branches missed.">            if (!weapon.isReady()) {</span>
<span class="nc" id="L15054">                continue;</span>
            }

<span class="nc" id="L15057">            WeaponType type = (WeaponType) weapon.getType();</span>
            int range;
            
<span class="nc bnc" id="L15060" title="All 2 branches missed.">            if(isAirborne()) {</span>
<span class="nc bnc" id="L15061" title="All 2 branches missed.">                int rangeMultiplier = type.isCapital() ? 2 : 1;</span>
<span class="nc bnc" id="L15062" title="All 2 branches missed.">                rangeMultiplier *= isAirborneAeroOnGroundMap() ? 8 : 1;</span>
                
<span class="nc" id="L15064">                range = WeaponType.AIRBORNE_WEAPON_RANGES[type.getMaxRange(weapon)] * rangeMultiplier;</span>
<span class="nc" id="L15065">            } else {</span>
<span class="nc bnc" id="L15066" title="All 2 branches missed.">                range = (game.getOptions().booleanOption(</span>
<span class="nc" id="L15067">                    OptionsConstants.ADVCOMBAT_TACOPS_RANGE) ? type.getExtremeRange()</span>
<span class="nc" id="L15068">                    : type.getLongRange());</span>
            }
            
<span class="nc bnc" id="L15071" title="All 2 branches missed.">            if (range &gt; maxRange) {</span>
<span class="nc" id="L15072">                maxRange = range;</span>
            }
<span class="nc" id="L15074">        }</span>
<span class="nc" id="L15075">        return maxRange;</span>
    }

    public int getHeat() {
<span class="nc" id="L15079">        return heat;</span>
    }

    public int getTsempHitsThisTurn() {
<span class="nc" id="L15083">        return tsempHitsThisTurn;</span>
    }

    public void addTsempHitThisTurn() {
<span class="nc" id="L15087">        tsempHitsThisTurn++;</span>
<span class="nc" id="L15088">    }</span>

    public int getTsempEffect() {
<span class="nc" id="L15091">        return tsempEffect;</span>
    }

    public void setTsempEffect(int tsempEffect) {
<span class="nc" id="L15095">        this.tsempEffect = tsempEffect;</span>
<span class="nc" id="L15096">    }</span>

    public boolean isFiredTsempThisTurn() {
<span class="nc" id="L15099">        return firedTsempThisTurn;</span>
    }

    public void setFiredTsempThisTurn(boolean firedTsempThisTurn) {
<span class="nc" id="L15103">        this.firedTsempThisTurn = firedTsempThisTurn;</span>
<span class="nc" id="L15104">    }</span>

    public boolean hasFiredTsemp() {
<span class="nc" id="L15107">        return hasFiredTsemp;</span>
    }

    public void setHasFiredTsemp(boolean hasFiredTSEMP) {
<span class="nc" id="L15111">        hasFiredTsemp = hasFiredTSEMP;</span>
<span class="nc" id="L15112">    }</span>

    /*
     * Sets the number of rounds that the entity is affected by an ASEW missile
     * @param turns - integer specifying the number of end phases that the effects last through
     * Technically, about 1.5 turns elapse per the rules for ASEW missiles in TO
     */
    public void setASEWAffected(int turns) {
<span class="nc" id="L15120">        asewAffectedTurns = turns;</span>
<span class="nc" id="L15121">    }</span>

    /*
     * Returns the number of rounds that the entity is affected by an ASEW missile
     */
    public int getASEWAffected() {
<span class="nc" id="L15127">        return asewAffectedTurns;</span>
    }

    public boolean hasActivatedRadicalHS() {
<span class="nc bnc" id="L15131" title="All 2 branches missed.">        for (Mounted m : getMisc()) {</span>
<span class="nc bnc" id="L15132" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_RADICAL_HEATSINK)</span>
<span class="nc bnc" id="L15133" title="All 2 branches missed.">                &amp;&amp; m.curMode().equals(&quot;On&quot;)) {</span>
<span class="nc" id="L15134">                return true;</span>
            }
<span class="nc" id="L15136">        }</span>
<span class="nc" id="L15137">        return false;</span>
    }

    public void deactivateRadicalHS() {
<span class="nc bnc" id="L15141" title="All 2 branches missed.">        for (Mounted m : getMisc()) {</span>
<span class="nc bnc" id="L15142" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_RADICAL_HEATSINK)) {</span>
<span class="nc" id="L15143">                m.setMode(&quot;Off&quot;);</span>
                // Can only have one radical heat sink
<span class="nc" id="L15145">                break;</span>
            }
<span class="nc" id="L15147">        }</span>
<span class="nc" id="L15148">    }</span>

    public int getConsecutiveRHSUses() {
<span class="nc" id="L15151">        return consecutiveRHSUses;</span>
    }

    public void setConsecutiveRHSUses(int consecutiveRHSUses) {
<span class="nc" id="L15155">        this.consecutiveRHSUses = consecutiveRHSUses;</span>
<span class="nc" id="L15156">    }</span>

    public boolean hasDamagedRHS() {
<span class="nc" id="L15159">        return hasDamagedRHS;</span>
    }

    public void setHasDamagedRHS(boolean hasDamagedRHS) {
<span class="nc" id="L15163">        this.hasDamagedRHS = hasDamagedRHS;</span>
<span class="nc" id="L15164">    }</span>

    public boolean isUseGeometricBV() {
<span class="nc" id="L15167">        return useGeometricBV;</span>
    }

    public void setUseGeometricBV(boolean useGeometricBV) {
<span class="nc" id="L15171">        this.useGeometricBV = useGeometricBV;</span>
<span class="nc" id="L15172">    }</span>

    public boolean isUseReducedOverheatModifierBV() {
<span class="nc" id="L15175">        return useReducedOverheatModifierBV;</span>
    }

    public void setUseReducedOverheatModifierBV(boolean useReducedOverheatModifierBV) {
<span class="nc" id="L15179">        this.useReducedOverheatModifierBV = useReducedOverheatModifierBV;</span>
<span class="nc" id="L15180">    }</span>

    public void addAttackedByThisTurn(int entityId) {
<span class="nc" id="L15183">        attackedByThisTurn.add(entityId);</span>
<span class="nc" id="L15184">    }</span>

    public void clearAttackedByThisTurn() {
<span class="nc" id="L15187">        attackedByThisTurn.clear();</span>
<span class="nc" id="L15188">    }</span>

    public Collection&lt;Integer&gt; getAttackedByThisTurn() {
<span class="nc" id="L15191">        return new HashSet&lt;&gt;(attackedByThisTurn);</span>
    }

    public WeaponSortOrder getWeaponSortOrder() {
<span class="nc bnc" id="L15195" title="All 2 branches missed.">        if (weaponSortOrder == null) {</span>
<span class="nc" id="L15196">            return WeaponSortOrder.DEFAULT;</span>
        }
<span class="nc" id="L15198">        return weaponSortOrder;</span>
    }

    public void setWeaponSortOrder(WeaponSortOrder weaponSortOrder) {
<span class="nc bnc" id="L15202" title="All 2 branches missed.">        if (weaponSortOrder != this.weaponSortOrder) {</span>
<span class="nc" id="L15203">            setWeapOrderChanged(true);</span>
        }
        // If sort mode is custom, and the custom order is null, create it
        // and make the order the same as default (based on eqId)
<span class="nc bnc" id="L15207" title="All 4 branches missed.">        if ((weaponSortOrder == WeaponSortOrder.CUSTOM)</span>
            &amp;&amp; (customWeapOrder == null)) {
<span class="nc" id="L15209">            customWeapOrder = new HashMap&lt;Integer, Integer&gt;();</span>
<span class="nc bnc" id="L15210" title="All 2 branches missed.">            for (Mounted weap : weaponList) {</span>
<span class="nc" id="L15211">                int eqId = getEquipmentNum(weap);</span>
<span class="nc" id="L15212">                customWeapOrder.put(eqId, eqId);</span>
<span class="nc" id="L15213">            }</span>
        }
<span class="nc" id="L15215">        this.weaponSortOrder = weaponSortOrder;</span>
<span class="nc" id="L15216">    }</span>

    public Map&lt;Integer, Integer&gt; getCustomWeaponOrder() {
<span class="nc" id="L15219">        return customWeapOrder;</span>
    }

    public void setCustomWeaponOrder(Map&lt;Integer, Integer&gt; customWeapOrder) {
<span class="nc" id="L15223">        this.customWeapOrder = customWeapOrder;</span>
<span class="nc" id="L15224">    }</span>

    public int getCustomWeaponOrder(Mounted weapon) {
<span class="nc" id="L15227">        int eqId = getEquipmentNum(weapon);</span>
<span class="nc bnc" id="L15228" title="All 2 branches missed.">        if (customWeapOrder == null) {</span>
<span class="nc" id="L15229">            return eqId;</span>
        }
<span class="nc" id="L15231">        Integer order = customWeapOrder.get(eqId);</span>
<span class="nc bnc" id="L15232" title="All 2 branches missed.">        if (order == null) {</span>
<span class="nc" id="L15233">            return -1;</span>
        } else {
<span class="nc" id="L15235">            return order;</span>
        }
    }

    public void setCustomWeaponOrder(Mounted weapon, int order) {
<span class="nc" id="L15240">        setWeapOrderChanged(true);</span>
<span class="nc" id="L15241">        int eqId = getEquipmentNum(weapon);</span>
<span class="nc bnc" id="L15242" title="All 2 branches missed.">        if (eqId == -1) {</span>
<span class="nc" id="L15243">            return;</span>
        }
<span class="nc" id="L15245">        customWeapOrder.put(eqId, order);</span>
<span class="nc" id="L15246">    }</span>

    public boolean isWeapOrderChanged() {
<span class="nc" id="L15249">        return weapOrderChanged;</span>
    }

    public void setWeapOrderChanged(boolean weapOrderChanged) {
<span class="nc" id="L15253">        this.weapOrderChanged = weapOrderChanged;</span>
<span class="nc" id="L15254">    }</span>

    public int getMpUsedLastRound() {
<span class="nc" id="L15257">        return mpUsedLastRound;</span>
    }

    public void setMpUsedLastRound(int mpUsedLastRound) {
<span class="nc" id="L15261">        this.mpUsedLastRound = mpUsedLastRound;</span>
<span class="nc" id="L15262">    }</span>

    /**
     * Flag that determines if the Entity is a support vehicle.
     * @return
     */
    public boolean isSupportVehicle() {
<span class="nc" id="L15269">        return false;</span>
    }

    /**
     * @return Whether the unit uses primitive or retrotech construction rules
     */
    public boolean isPrimitive() {
<span class="nc" id="L15276">        return false;</span>
    }

    public int getStructuralTechRating() {
<span class="nc" id="L15280">        return structuralTechRating;</span>
    }

    public void setStructuralTechRating(int structuralTechRating) {
<span class="nc" id="L15284">        this.structuralTechRating = structuralTechRating;</span>
<span class="nc" id="L15285">    }</span>

    /**
     * Returns the base engine value for support vehicles, see TM pg 120.  Non
     * support vehicle Entities will return 0.
     *
     * @return
     */
    public double getBaseEngineValue() {
<span class="nc" id="L15294">        return 0;</span>
    }

    /**
     * Returns the base chassis value for support vehicles, see TM pg 120.  Non
     * support vehicle Entities will return 0.
     *
     * @return
     */
    public double getBaseChassisValue() {
<span class="nc" id="L15304">        return 0;</span>
    }

    public int getArmorTechRating() {
<span class="nc bnc" id="L15308" title="All 2 branches missed.">        if (armorTechRating == USE_STRUCTURAL_RATING) {</span>
<span class="nc" id="L15309">            return structuralTechRating;</span>
        }
<span class="nc" id="L15311">        return armorTechRating;</span>
    }

    public void setArmorTechRating(int armorTechRating) {
<span class="nc" id="L15315">        this.armorTechRating = armorTechRating;</span>
<span class="nc" id="L15316">    }</span>

    public int getEngineTechRating() {
<span class="nc bnc" id="L15319" title="All 2 branches missed.">        if (engineTechRating == USE_STRUCTURAL_RATING) {</span>
<span class="nc" id="L15320">            return structuralTechRating;</span>
        }
<span class="nc" id="L15322">        return engineTechRating;</span>
    }

    public void setEngineTechRating(int engineTechRating) {
<span class="nc" id="L15326">        this.engineTechRating = engineTechRating;</span>
<span class="nc" id="L15327">    }</span>

    /**
     * Used by omni support vehicles to track the weight of fire control systems.
     * This limits the tonnage that can be devoted to weapons in pods.
     *
     * @return The fixed weight of fire control systems.
     */
    public double getBaseChassisFireConWeight() {
<span class="nc" id="L15336">        return baseChassisFireConWeight;</span>
    }

    /**
     *  Used by omni support vehicles to set the weight of fixed fire control systems in the base chassis.
     *
     * @param weight The weight of fixed fire control systems.
     */
    public void setBaseChassisFireConWeight(double weight) {
<span class="nc" id="L15345">        baseChassisFireConWeight = weight;</span>
<span class="nc" id="L15346">    }</span>

    /**
     * Units with construction data that varies by year (such as engine and control system weight
     * for some primitive aerospace units) require tracking the original build year separately
     * from the intro year for the model to account for refits that don't affect the core components.
     *
     * @return The year to use for core component construction data.
     */
    public int getOriginalBuildYear() {
<span class="nc bnc" id="L15356" title="All 2 branches missed.">        if (originalBuildYear &lt; 0) {</span>
<span class="nc" id="L15357">            return year;</span>
        }
<span class="nc" id="L15359">        return originalBuildYear;</span>
    }

    public void setOriginalBuildYear(int year) {
<span class="nc" id="L15363">        originalBuildYear = year;</span>
<span class="nc" id="L15364">    }</span>

    /**
     * This method (and getActiveSubEntities()) is meant for groups of entities handled as a
     * singular one. Examples include fighter squadrons on space maps or lances in BattleForce
     * game modes.
     * &lt;p&gt;
     * To check if a given entity consists of multiple sub-entities, use
     * &lt;pre&gt;
     * if(entity.getSubEntities().isPresent()) {
     *     ...
     * }
     * &lt;/pre&gt;
     * To iterate over entities (if present), use:
     * &lt;pre&gt;
     * entity.getSubEntities().ifPresent(entities -&gt; entities.forEach(
     *     subEntity -&gt; {
     *         ...
     *     });
     * &lt;/pre&gt;
     *
     * @return an optional collection of sub-entities, if this entity is considered a grouping of them.
     */
    public Optional&lt;List&lt;Entity&gt;&gt; getSubEntities() {
<span class="nc" id="L15388">        return Optional.empty();</span>
    }

    /**
     * The default implementation calls getSubEntities(), then filters them. This might not be
     * the optimal code for many applications, so feel free to override both if needed.
     *
     * @return an optional collection of sub-entities, if this entity is considered a grouping of them,
     *         pre-filtered to only contain active (non-destroyed and non-doomed) entities.
     */
    public Optional&lt;List&lt;Entity&gt;&gt; getActiveSubEntities() {
<span class="nc" id="L15399">        return getSubEntities().map(</span>
<span class="nc" id="L15400">            ents -&gt; ents.stream().filter(</span>
<span class="nc bnc" id="L15401" title="All 4 branches missed.">                ent -&gt; !(ent.isDestroyed() || ent.isDoomed())).collect(Collectors.toList()));</span>
    }

    /**
     * Used to determine the draw priority of different Entity subclasses.
     * This allows different unit types to always be draw above/below other
     * types.
     *
     * @return
     */
    public int getSpriteDrawPriority() {
<span class="nc" id="L15412">        return 0;</span>
    }

    /**
     * Entities that use different sprites for different modes should override this
     * @return a code identifying the mode, or an empty string for the default sprite
     */
    public String getTilesetModeString() {
<span class="nc" id="L15420">        return &quot;&quot;;</span>
    }

    //Tractors and trailers, tugs, etc

    /**
     * Used to determine if this vehicle can be towed by a tractor
     *
     * @return
     */
    public boolean isTrailer() {
<span class="nc" id="L15431">        return false;</span>
    }

    /**
     * Used to determine if this vehicle can be the engine/tractor
     * for a bunch of trailers
     *
     * @return
     */
    public boolean isTractor() {
<span class="nc" id="L15441">        return false;</span>
    }

    /**
     * Returns a list of Coords that need to be checked for entities that can be towed
     * This accounts for the hexes occupied by each entity in the 'train', plus hexes
     * in front of or behind each trailer hitch
     *
     * @return
     */
    public Set&lt;Coords&gt; getHitchLocations() {
<span class="nc" id="L15452">        Set&lt;Coords&gt; trailerPos = new HashSet&lt;Coords&gt;();</span>
        //First, set up a list of all the entities in this train
<span class="nc" id="L15454">        ArrayList&lt;Entity&gt; thisTrain = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L15455">        thisTrain.add(this);</span>
<span class="nc bnc" id="L15456" title="All 2 branches missed.">        for (int id : getAllTowedUnits()) {</span>
<span class="nc" id="L15457">            Entity trailer = game.getEntity(id);</span>
<span class="nc" id="L15458">            thisTrain.add(trailer);</span>
<span class="nc" id="L15459">        }</span>
        //Check each Entity in the train for working hitches. When found, add the hex
        // that Entity is in and the hex the hitch faces.
<span class="nc bnc" id="L15462" title="All 2 branches missed.">        for (Entity e : thisTrain) {</span>
<span class="nc bnc" id="L15463" title="All 2 branches missed.">            for (Transporter t : e.getTransports()) {</span>
<span class="nc bnc" id="L15464" title="All 4 branches missed.">                if ((t instanceof TankTrailerHitch) &amp;&amp; (t.getUnused() &gt; 0)) {</span>
<span class="nc" id="L15465">                    trailerPos.add(e.getPosition());</span>
<span class="nc" id="L15466">                    int dir = e.getFacing();</span>
<span class="nc bnc" id="L15467" title="All 2 branches missed.">                    if (((TankTrailerHitch) t).getRearMounted()) {</span>
<span class="nc" id="L15468">                        dir = (dir + 3) % 6;</span>
                    }
<span class="nc" id="L15470">                    trailerPos.add(e.getPosition().translated(dir));</span>
                }
<span class="nc" id="L15472">            }</span>
<span class="nc" id="L15473">        }</span>
<span class="nc" id="L15474">        return trailerPos;</span>
    }

    /**
     * Matches up a trailer hitch transporter with its Id #
     *
     * @param bayNumber - the index of the transporter we're trying to find.
     * @returns the trailerhitch corresponding to the passed-in value
     */
    public TankTrailerHitch getHitchById(int bayNumber) {
<span class="nc" id="L15484">        Transporter transporter = transports.get(bayNumber);</span>
<span class="nc bnc" id="L15485" title="All 2 branches missed.">        if (transporter instanceof TankTrailerHitch) {</span>
<span class="nc" id="L15486">            return (TankTrailerHitch) transporter;</span>
        }
<span class="nc" id="L15488">        return null;</span>
    }

    /**
     * Finds the trailer hitch transporter that is carrying a given entityId
     * Hitches move around in Transports on loading a saved game
     *
     * @param id - the id of the loaded Entity we're trying to find
     * @returns the trailerhitch corresponding to the passed-in value
     */
    public TankTrailerHitch getHitchCarrying(int id) {
<span class="nc bnc" id="L15499" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc bnc" id="L15500" title="All 2 branches missed.">            if (next instanceof TankTrailerHitch) {</span>
<span class="nc bnc" id="L15501" title="All 2 branches missed.">                if (next.getLoadedUnits().contains(game.getEntity(id))) {</span>
<span class="nc" id="L15502">                    return (TankTrailerHitch) next;</span>
                }
            }
<span class="nc" id="L15505">        }</span>
<span class="nc" id="L15506">        return null;</span>
    }

    /**
     * Adds a trailer hitch to any tracked or wheeled military vehicle, or SupportVee with
     * Tractor chassis mod that doesn't already have one
     */
    public void addTrailerHitchEquipment() {

<span class="nc" id="L15515">    }</span>

    /**
     * Determines if this vehicle is currently able to tow designated trailer.
     *
     * @param trailerId - the ID of the &lt;code&gt;Entity&lt;/code&gt; to be towed.
     * @return &lt;code&gt;true&lt;/code&gt; if the trailer can be towed, &lt;code&gt;false&lt;/code&gt;
     * otherwise.
     */
    public boolean canTow(int trailerId) {
<span class="nc" id="L15525">        Entity trailer = game.getEntity(trailerId);</span>

        //Null check
<span class="nc bnc" id="L15528" title="All 2 branches missed.">        if (trailer == null) {</span>
<span class="nc" id="L15529">            return false;</span>
        }

        //Shouldn't be using this method if Trailer isn't a trailer
<span class="nc bnc" id="L15533" title="All 2 branches missed.">        if (!trailer.isTrailer()) {</span>
<span class="nc" id="L15534">            return false;</span>
        }

        //Can't tow if we aren't a tractor
<span class="nc bnc" id="L15538" title="All 2 branches missed.">        if (!isTractor()) {</span>
<span class="nc" id="L15539">            return false;</span>
        }

        //If this entity is in a transport bay, it can't tow another
<span class="nc bnc" id="L15543" title="All 2 branches missed.">        if (getTransportId() != Entity.NONE) {</span>
<span class="nc" id="L15544">            return false;</span>
        }

        //If Trailer moved or is already being towed, discard it
<span class="nc bnc" id="L15548" title="All 2 branches missed.">        if (!trailer.isLoadableThisTurn()) {</span>
<span class="nc" id="L15549">            return false;</span>
        }

        // Can't tow yourself, either.
<span class="nc bnc" id="L15553" title="All 2 branches missed.">        if (trailer.equals(this)) {</span>
<span class="nc" id="L15554">            return false;</span>
        }

        // one can only tow friendly units!
<span class="nc bnc" id="L15558" title="All 2 branches missed.">        if (trailer.isEnemyOf(this)) {</span>
<span class="nc" id="L15559">            return false;</span>
        }

        //Can't tow if hitch and trailer aren't at the same elevation
<span class="nc bnc" id="L15563" title="All 2 branches missed.">        if (trailer.getElevation() != getElevation()) {</span>
<span class="nc" id="L15564">            return false;</span>
        }

        //If none of the above happen, assume that we can't tow the trailer...
<span class="nc" id="L15568">        boolean result = false;</span>

        //First, set up a list of all the entities in this train
<span class="nc" id="L15571">        ArrayList&lt;Entity&gt; thisTrain = new ArrayList&lt;Entity&gt;();</span>
<span class="nc" id="L15572">        thisTrain.add(this);</span>
<span class="nc bnc" id="L15573" title="All 2 branches missed.">        for (int id : getAllTowedUnits()) {</span>
<span class="nc" id="L15574">            Entity tr = game.getEntity(id);</span>
<span class="nc" id="L15575">            thisTrain.add(tr);</span>
<span class="nc" id="L15576">        }</span>

        //Add up the weight of all carried trailers. A tractor can tow a total tonnage equal to its own.
<span class="nc" id="L15579">        double tractorWeight = getWeight();</span>
<span class="nc" id="L15580">        double trailerWeight = 0;</span>
        //Add up what the tractor's already towing
<span class="nc bnc" id="L15582" title="All 2 branches missed.">        for (int id : getAllTowedUnits()) {</span>
<span class="nc" id="L15583">            Entity tr = game.getEntity(id);</span>
<span class="nc" id="L15584">            trailerWeight += tr.getWeight();</span>
<span class="nc" id="L15585">        }</span>
<span class="nc bnc" id="L15586" title="All 2 branches missed.">        if (trailerWeight + trailer.getWeight() &gt; tractorWeight) {</span>
<span class="nc" id="L15587">            return false;</span>
        }

        //Next, look for an empty hitch somewhere in the train
<span class="nc" id="L15591">        boolean hitchFound = false;</span>
<span class="nc bnc" id="L15592" title="All 2 branches missed.">        for (Entity e : thisTrain) {</span>
            //Quit looking if we've already found a valid hitch
<span class="nc bnc" id="L15594" title="All 2 branches missed.">            if (hitchFound) {</span>
<span class="nc" id="L15595">                break;</span>
            }
<span class="nc bnc" id="L15597" title="All 2 branches missed.">            for (Transporter t : e.getTransports()) {</span>
<span class="nc bnc" id="L15598" title="All 2 branches missed.">                if (t.canTow(trailer)) {</span>
<span class="nc" id="L15599">                    result = true;</span>
<span class="nc" id="L15600">                    hitchFound = true;</span>
                    //stop looking
<span class="nc" id="L15602">                    break;</span>
                }
<span class="nc" id="L15604">            }</span>
<span class="nc" id="L15605">        }</span>
<span class="nc" id="L15606">        return result;</span>
    }


    /**
     * Used with MoveStep.TOW to find and update the correct entity when adding it to a train
     */
<span class="nc" id="L15613">    private int isTowing = Entity.NONE;</span>

    /**
     * Returns the entity to be towed
     *
     * @return
     */
    public int getTowing() {
<span class="nc" id="L15621">        return isTowing;</span>
    }

    /**
     * Change the towed status of this entity
     *
     * @param id - the ID of the entity being towed
     */
    public void setTowing(int id) {
<span class="nc" id="L15630">        isTowing = id;</span>
<span class="nc" id="L15631">    }</span>

    /**
     * The id of the powered tractor towing the whole train
     * this entity is part of. This will often be the same
     * entity as towedBy
     */
<span class="nc" id="L15638">    private int tractor = Entity.NONE;</span>

    /**
     * Returns the tractor towing the train this entity is part of
     *
     * @return
     */
    public int getTractor() {
<span class="nc" id="L15646">        return tractor;</span>
    }

    /**
     * Sets the tractor towing the train this entity is part of
     *
     * @param id - id of the tractor towing this train
     */
    public void setTractor(int id) {
<span class="nc" id="L15655">        tractor = id;</span>
<span class="nc" id="L15656">    }</span>

    /**
     * The ID of the entity directly towing this one
     * Used to find and set the correct Transporter
     */
<span class="nc" id="L15662">    private int towedBy = Entity.NONE;</span>

    /**
     * Returns the Entity that is directly towing this one
     *
     * @return
     */
    public int getTowedBy() {
<span class="nc" id="L15670">        return towedBy;</span>
    }

    /**
     * Sets the Entity that is directly towing this one
     *
     * @param id - the id of the Entity towing this trailer
     */
    public void setTowedBy(int id) {
<span class="nc" id="L15679">        towedBy = id;</span>
<span class="nc" id="L15680">    }</span>

    /**
     * A list of entity IDs being towed behind this entity, if present
     *
     * Used to ensure all following trailers are disconnected if the train
     * is broken at this entity.
     */
<span class="nc" id="L15688">    private List&lt;Integer&gt; connectedUnits = new ArrayList&lt;Integer&gt;();</span>

    /**
     * Returns the entities towed behind this entity
     *
     * @return
     */
    public List&lt;Integer&gt; getConnectedUnits() {
<span class="nc" id="L15696">        return Collections.unmodifiableList(connectedUnits);</span>
    }

    /**
     * Attaches a trailer to this train
     *
     * @param id - if of the entity to be added to this train
     */
    public void towUnit(int id) {
<span class="nc" id="L15705">        Entity towed = game.getEntity(id);</span>
        //Add this trailer to the connected list for all trailers already in this train
<span class="nc bnc" id="L15707" title="All 2 branches missed.">        for (int tr : getAllTowedUnits()) {</span>
<span class="nc" id="L15708">            Entity trailer = game.getEntity(tr);</span>
<span class="nc" id="L15709">            trailer.connectedUnits.add(id);</span>
<span class="nc" id="L15710">        }</span>
<span class="nc" id="L15711">        addTowedUnit(id);</span>
<span class="nc" id="L15712">        towed.setTractor(this.getId());</span>
        //Now, find the transporter and the actual towing entity (trailer or tractor)
<span class="nc" id="L15714">        Entity towingEnt = game.getEntity(towed.towedBy);</span>
<span class="nc bnc" id="L15715" title="All 2 branches missed.">        if (towingEnt != null) {</span>
<span class="nc" id="L15716">            Transporter hitch = towingEnt.getHitchById(towed.getTargetBay());</span>
<span class="nc bnc" id="L15717" title="All 2 branches missed.">            if (hitch != null) {</span>
<span class="nc" id="L15718">                hitch.load(towed);</span>
            }
        }
<span class="nc" id="L15721">    }</span>

    /**
     * Detaches an entity from this entity's towing mechanism
     * also detaches all trailers behind this one from the whole
     * train
     *
     * @param id - the id of entity to be detached
     */
    public void disconnectUnit(int id) {
<span class="nc" id="L15731">        Entity towed = game.getEntity(id);</span>
<span class="nc" id="L15732">        Entity tractor = game.getEntity(towed.getTractor());</span>
        //Remove the designated trailer from the tractor's carried units
<span class="nc" id="L15734">        removeTowedUnit(id);</span>
        //Now, find and empty the transporter on the actual towing entity (trailer or tractor)
<span class="nc" id="L15736">        Entity towingEnt = game.getEntity(towed.getTowedBy());</span>
<span class="nc" id="L15737">        towingEnt.connectedUnits.clear();</span>
<span class="nc bnc" id="L15738" title="All 2 branches missed.">        if (towingEnt != null) {</span>
<span class="nc" id="L15739">            Transporter hitch = towingEnt.getHitchCarrying(id);</span>
<span class="nc bnc" id="L15740" title="All 2 branches missed.">            if (hitch != null) {</span>
<span class="nc" id="L15741">                hitch.unload(towed);</span>
            }
        }
        //If there are other trailers behind the one being dropped, disconnect all of them
        //from the tractor and from each other, so they can be picked up again later
<span class="nc bnc" id="L15746" title="All 2 branches missed.">        for (int i : towed.getConnectedUnits()) {</span>
<span class="nc" id="L15747">            Entity trailer = game.getEntity(i);</span>
<span class="nc" id="L15748">            trailer.setTractor(Entity.NONE);</span>
<span class="nc" id="L15749">            tractor.removeTowedUnit(i);</span>
<span class="nc" id="L15750">            towingEnt = game.getEntity(trailer.getTowedBy());</span>
<span class="nc bnc" id="L15751" title="All 2 branches missed.">            if (towingEnt != null) {</span>
<span class="nc" id="L15752">                Transporter hitch = towingEnt.getHitchCarrying(i);</span>
<span class="nc bnc" id="L15753" title="All 2 branches missed.">                if (hitch != null) {</span>
<span class="nc" id="L15754">                    hitch.unload(trailer);</span>
                }
            }
<span class="nc" id="L15757">            trailer.setTowedBy(Entity.NONE);</span>
<span class="nc" id="L15758">            trailer.connectedUnits.clear();</span>
<span class="nc" id="L15759">        }</span>
        //Update these last, or we get concurrency issues
<span class="nc" id="L15761">        towed.setTractor(Entity.NONE);</span>
<span class="nc" id="L15762">        towed.setTowedBy(Entity.NONE);</span>
<span class="nc" id="L15763">        towed.setTowing(Entity.NONE);</span>
<span class="nc" id="L15764">        towed.connectedUnits.clear();</span>
<span class="nc" id="L15765">    }</span>

    /**
     * A list of all the entity IDs towed by this entity,
     * including those connected to other towed trailers
     *
     * Use this for the tractor/engine/tug
     */
<span class="nc" id="L15773">    private List&lt;Integer&gt; isTractorFor = new ArrayList&lt;Integer&gt;();</span>

    /**
     * Returns a list of all entities towed behind this tractor.
     *
     * @return
     */
    public List&lt;Integer&gt; getAllTowedUnits() {
<span class="nc" id="L15781">        return Collections.unmodifiableList(isTractorFor);</span>
    }

    /**
     * Adds an entity to this tractor's train
     */
    public void addTowedUnit(int id) {
<span class="nc" id="L15788">        isTractorFor.add(id);</span>
<span class="nc" id="L15789">    }</span>

    /**
     * Removes an entity from this tractor's train
     */
    public void removeTowedUnit(int id) {
<span class="nc" id="L15795">        isTractorFor.remove(isTractorFor.indexOf(id));</span>
<span class="nc bnc" id="L15796" title="All 2 branches missed.">        if (getTowing() == id) {</span>
<span class="nc" id="L15797">            setTowing(Entity.NONE);</span>
        }
<span class="nc" id="L15799">    }</span>

    /**
     * Get a &lt;code&gt;List&lt;/code&gt; of the trailers currently loaded into this payload.
     *
     * @return A &lt;code&gt;List&lt;/code&gt; of loaded &lt;code&gt;Entity&lt;/code&gt; units. This
     * list will never be &lt;code&gt;null&lt;/code&gt;, but it may be empty. The
     * returned &lt;code&gt;List&lt;/code&gt; is independant from the under- lying
     * data structure; modifying one does not affect the other.
     *
     * This will only return loaded trailers
     */
    public List&lt;Entity&gt; getLoadedTrailers() {
<span class="nc" id="L15812">        List&lt;Entity&gt; result = new ArrayList&lt;Entity&gt;();</span>

        // Walk through this entity's transport components;
        // add any trailers we find there
<span class="nc bnc" id="L15816" title="All 2 branches missed.">        for (Transporter next : transports) {</span>
<span class="nc bnc" id="L15817" title="All 2 branches missed.">            for (Entity e : next.getLoadedUnits()) {</span>
<span class="nc bnc" id="L15818" title="All 2 branches missed.">                if (e.isTrailer()) {</span>
<span class="nc" id="L15819">                    result.add(e);</span>
                }
<span class="nc" id="L15821">            }</span>
<span class="nc" id="L15822">        }</span>

        //Now do the same for any additional trailers being carried by those trailers
<span class="nc bnc" id="L15825" title="All 2 branches missed.">        for (int id : getAllTowedUnits()) {</span>
<span class="nc" id="L15826">            Entity trailer = game.getEntity(id);</span>
<span class="nc bnc" id="L15827" title="All 2 branches missed.">            for (Transporter next : trailer.transports) {</span>
<span class="nc bnc" id="L15828" title="All 2 branches missed.">                for (Entity e : next.getLoadedUnits()) {</span>
<span class="nc bnc" id="L15829" title="All 2 branches missed.">                    if (e.isTrailer()) {</span>
<span class="nc" id="L15830">                        result.add(e);</span>
                    }
<span class="nc" id="L15832">                }</span>
<span class="nc" id="L15833">            }</span>
<span class="nc" id="L15834">        }</span>

        // Return the list.
<span class="nc" id="L15837">        return result;</span>
    }

    /**
     * Determine if a connected tractor/trailer prevents a weapon in the given location
     * from firing.
     *
     * @param loc    - the &lt;code&gt;int&lt;/code&gt; location attempting to fire.
     * @param secondaryFacing    - the &lt;code&gt;int&lt;/code&gt; direction the turret is facing if the weapon is mounted there.
     * @param isRear - a &lt;code&gt;boolean&lt;/code&gt; value stating if the given location
     *               is rear facing; if &lt;code&gt;false&lt;/code&gt;, the location is front
     *               facing.
     * @return &lt;code&gt;true&lt;/code&gt; if a tractor/trailer unit is in the way,
     * &lt;code&gt;false&lt;/code&gt; if the weapon can fire.
     */
    public boolean isWeaponBlockedByTowing(int loc, int secondaryFacing, boolean isRear) {
        //Per TW p205, assume our trailer is being towed from the front.
<span class="nc bnc" id="L15854" title="All 2 branches missed.">        if (getTowedBy() != Entity.NONE) {</span>
<span class="nc bnc" id="L15855" title="All 10 branches missed.">            if (loc == Tank.LOC_FRONT ||</span>
                    ((loc == Tank.LOC_TURRET
                            || loc == Tank.LOC_TURRET_2
                            || loc == SuperHeavyTank.LOC_TURRET
                            || loc == SuperHeavyTank.LOC_TURRET_2)
<span class="nc bnc" id="L15860" title="All 2 branches missed.">                            &amp;&amp; (secondaryFacing == getFacing()))) {</span>
<span class="nc" id="L15861">                return true;</span>
            }
        }
<span class="nc bnc" id="L15864" title="All 4 branches missed.">        if (!getAllTowedUnits().isEmpty() || !getConnectedUnits().isEmpty()) {</span>
            //If we're towing something, check for a front or rear hitch
<span class="nc" id="L15866">            Entity towed = null;</span>
<span class="nc bnc" id="L15867" title="All 2 branches missed.">            if (!getAllTowedUnits().isEmpty()) {</span>
<span class="nc" id="L15868">                towed = game.getEntity(getAllTowedUnits().get(0));</span>
            } else {
<span class="nc" id="L15870">                towed = game.getEntity(getConnectedUnits().get(0));</span>
            }
<span class="nc bnc" id="L15872" title="All 2 branches missed.">            if (towed == null) {</span>
                //shouldn't happen, but just in case
<span class="nc" id="L15874">                return false;</span>
            }
<span class="nc" id="L15876">            TankTrailerHitch hitch = getHitchCarrying(towed.getId());</span>
<span class="nc bnc" id="L15877" title="All 2 branches missed.">            if (hitch != null) {</span>
<span class="nc bnc" id="L15878" title="All 16 branches missed.">                if ((hitch.getRearMounted()) &amp;&amp; loc == Tank.LOC_REAR</span>
                        || isRear
                        || loc == SuperHeavyTank.LOC_REAR ||
                        ((loc == Tank.LOC_TURRET
                                || loc == Tank.LOC_TURRET_2
                                || loc == SuperHeavyTank.LOC_TURRET
                                || loc == SuperHeavyTank.LOC_TURRET_2)
<span class="nc bnc" id="L15885" title="All 2 branches missed.">                                &amp;&amp; (secondaryFacing == ((getFacing() + 3) % 6)))) {</span>
<span class="nc" id="L15886">                    return true;</span>
<span class="nc bnc" id="L15887" title="All 12 branches missed.">                } else if (!hitch.getRearMounted() &amp;&amp; (loc == Tank.LOC_FRONT ||</span>
                        ((loc == Tank.LOC_TURRET
                        || loc == Tank.LOC_TURRET_2
                        || loc == SuperHeavyTank.LOC_TURRET
                        || loc == SuperHeavyTank.LOC_TURRET_2)
<span class="nc bnc" id="L15892" title="All 2 branches missed.">                        &amp;&amp; (secondaryFacing == getFacing())))) {</span>
<span class="nc" id="L15893">                    return true;</span>
                }
            }
        }
<span class="nc" id="L15897">        return false;</span>
    }

    /**
     * determine if an entity has an ability that is identified by its presence or absence only.
     * The entity may gain this ability from different places, not exclusively the crew.
     * @param name - name of the ability as recorded in the options
     * @return true if the entity has this ability from some source
     */
    public boolean hasAbility(String name) {
<span class="nc bnc" id="L15907" title="All 2 branches missed.">        if(null != getCrew()) {</span>
<span class="nc" id="L15908">            return getCrew().getOptions().booleanOption(name);</span>
        }
        //TODO: look for the ability at the player level
<span class="nc" id="L15911">        return false;</span>
    }

    /**
     * determine if an entity has an ability at a given level.
     * The entity may gain this ability from different places, not exclusively the crew.
     * @param name - name of the ability as recorded in the optionsme
     * @param choice - A string indicating the given level being asked about
     * @return true if the entity has this ability at the given choice from some source
     */
    public boolean hasAbility(String name, String choice) {
<span class="nc bnc" id="L15922" title="All 2 branches missed.">        if(null != getCrew()) {</span>
<span class="nc" id="L15923">            return getCrew().getOptions().stringOption(name).equals(choice);</span>
        }
<span class="nc" id="L15925">        return false;</span>
    }

    public int modifyPhysicalDamageForMeleeSpecialist() {
<span class="nc bnc" id="L15929" title="All 2 branches missed.">        if (!hasAbility(OptionsConstants.PILOT_MELEE_SPECIALIST)) {</span>
<span class="nc" id="L15930">            return 0;</span>
        }

<span class="nc" id="L15933">        return 1;</span>
    }
    
    
    //Getters and setters for sensor contacts and firing solutions. Currently only used in space combat
    /**
     * Retrieves the IDs of all entities that this entity has detected with sensors
     * @return the contents of this entity's sensorContacts set
     */
    public Set&lt;Integer&gt; getSensorContacts() {
<span class="nc" id="L15943">        return sensorContacts;</span>
    }
    
    /**
     * Checks the sensorContacts set for a specific target's ID number
     * @param targetId the ID number of the target entity to check for
     * @return true if the entity's sensorContacts set contains the passed-in target ID
     */
    public boolean hasSensorContactFor(int targetId) {
<span class="nc" id="L15952">        return sensorContacts.contains(targetId);</span>
    }
    
    /**
     * Adds the specified target entity's ID to this entity's sensorContacts
     * @param targetId the ID number of the target entity to add
     */
    public void addSensorContact(int targetId) {
<span class="nc" id="L15960">        sensorContacts.add(targetId);</span>
<span class="nc" id="L15961">    }</span>
    
    /**
     * Removes the specified target entity's ID from this entity's sensorContacts
     * @param targetIds the ID number of the target entity to remove
     */
    public void removeSensorContact(Collection&lt;Integer&gt; targetIds) {
<span class="nc" id="L15968">        sensorContacts.removeAll(targetIds);</span>
<span class="nc" id="L15969">    }</span>
    
    /**
     * Empties this entity's sensorContacts
     * Used when it dies or moves offboard
     */
    public void clearSensorContacts() {
<span class="nc" id="L15976">        sensorContacts.clear();</span>
<span class="nc" id="L15977">    }</span>
    
    /**
     * Retrieves the IDs of all entities that this entity has established firing solutions on
     * @return the contents of this entity's firingSolutions set
     */
    public Set&lt;Integer&gt; getFiringSolutions() {
<span class="nc" id="L15984">        return firingSolutions;</span>
    }
    
    /**
     * Checks the firingSolutions set for a specific target's ID number
     * @param targetId the ID number of the target entity to check for
     * @return true if the entity's firingSolutions set contains the passed-in target ID
     */
    public boolean hasFiringSolutionFor(int targetId) {
<span class="nc" id="L15993">        return firingSolutions.contains(targetId);</span>
    }
    
    /**
     * Adds the specified target entity's ID to this entity's firingSolutions
     * @param targetId the ID number of the target entity to add
     */
    public void addFiringSolution(int targetId) {
<span class="nc" id="L16001">        firingSolutions.add(targetId);</span>
<span class="nc" id="L16002">    }</span>
    
    /**
     * Removes the specified target entity's ID from this entity's firingSolutions
     * @param targetIds the ID number of the target entity to remove
     */
    public void removeFiringSolution(Collection&lt;Integer&gt; targetIds) {
<span class="nc" id="L16009">        firingSolutions.removeAll(targetIds);</span>
<span class="nc" id="L16010">    }</span>
    
    /**
     * Empties this entity's firingSolutions
     * Used when it dies or moves offboard
     */
    public void clearFiringSolutions() {
<span class="nc" id="L16017">        firingSolutions.clear();</span>
<span class="nc" id="L16018">    }</span>
    
    /**
     * Indicate that an off-board artillery attack by this entity has been observed by a particular team
     */
    public void addOffBoardObserver(int teamID) {
<span class="nc" id="L16024">        offBoardShotObservers.add(teamID);</span>
<span class="nc" id="L16025">    }</span>
    
    /**
     * Has the given team observed an off-board artillery attack by this entity?
     */
    public boolean isOffBoardObserved(int teamID) {
<span class="nc" id="L16031">        return offBoardShotObservers.contains(teamID);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>