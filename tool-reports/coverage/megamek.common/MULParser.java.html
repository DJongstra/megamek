<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="nl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MULParser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">PlayerTest Coverage Results</a> &gt; <a href="index.source.html" class="el_package">megamek.common</a> &gt; <span class="el_source">MULParser.java</span></div><h1>MULParser.java</h1><pre class="source lang-java linenums">/*
* MegaMek -
* Copyright (C) 2014 The MegaMek Team
*
* This program is free software; you can redistribute it and/or modify it under
* the terms of the GNU General Public License as published by the Free Software
* Foundation; either version 2 of the License, or (at your option) any later
* version.
*
* This program is distributed in the hope that it will be useful, but WITHOUT
* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
* FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
* details.
*/

package megamek.common;

import java.io.InputStream;
import java.util.HashMap;
import java.util.Hashtable;
import java.util.Iterator;
import java.util.Map;
import java.util.StringTokenizer;
import java.util.Vector;

import javax.xml.parsers.DocumentBuilder;

import megamek.MegaMek;
import megamek.client.generator.RandomNameGenerator;
import megamek.common.enums.Gender;
import megamek.common.weapons.infantry.InfantryWeapon;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;

import megamek.common.loaders.EntityLoadingException;
import megamek.utils.MegaMekXmlUtil;

/**
 * Class for reading in and parsing MUL XML files.  The MUL xsl is defined in
 * the docs directory.
 *
 * @author arlith
 *
 */
public class MULParser {

    public static final String VERSION = &quot;version&quot;;

    /**
     * The names of the various elements recognized by this parser.
     */
    private static final String RECORD = &quot;record&quot;;
    private static final String SURVIVORS = &quot;survivors&quot;;
    private static final String ALLIES = &quot;allies&quot;;
    private static final String SALVAGE = &quot;salvage&quot;;
    private static final String RETREATED = &quot;retreated&quot;;
    private static final String DEVASTATED = &quot;devastated&quot;;
    private static final String UNIT = &quot;unit&quot;;
    private static final String ENTITY = &quot;entity&quot;;
    private static final String PILOT = &quot;pilot&quot;;
    private static final String CREW = &quot;crew&quot;;
    private static final String CREWTYPE = &quot;crewType&quot;;
    private static final String CREWMEMBER = &quot;crewMember&quot;;
    private static final String KILLS = &quot;kills&quot;;
    private static final String KILL = &quot;kill&quot;;
    private static final String LOCATION = &quot;location&quot;;
    private static final String ARMOR = &quot;armor&quot;;
    private static final String SLOT = &quot;slot&quot;;
    private static final String MOVEMENT = &quot;motive&quot;;
    private static final String TURRETLOCK = &quot;turretlock&quot;;
    private static final String TURRET2LOCK = &quot;turret2lock&quot;;
    private static final String SI = &quot;structural&quot;;
    private static final String HEAT = &quot;heat&quot;;
    private static final String FUEL = &quot;fuel&quot;;
    private static final String KF = &quot;KF&quot;;
    private static final String SAIL = &quot;sail&quot;;
    private static final String AEROCRIT = &quot;acriticals&quot;;
    private static final String DROPCRIT = &quot;dcriticals&quot;;
    private static final String TANKCRIT = &quot;tcriticals&quot;;
    private static final String STABILIZER = &quot;stabilizer&quot;;
    private static final String BREACH = &quot;breached&quot;;
    private static final String BLOWN_OFF = &quot;blownOff&quot;;
    private static final String C3I = &quot;c3iset&quot;;
    private static final String C3ILINK = &quot;c3i_link&quot;;
    private static final String NC3 = &quot;NC3set&quot;;
    private static final String NC3LINK = &quot;NC3_link&quot;;
    private static final String LINK = &quot;link&quot;;
    private static final String RFMG = &quot;rfmg&quot;;
    private static final String ESCCRAFT = &quot;EscapeCraft&quot;;
    private static final String ID = &quot;id&quot;;
    private static final String ESCCREW = &quot;EscapedCrew&quot;;
    private static final String ESCPASS = &quot;EscapedPassengers&quot;;
    private static final String NUMBER = &quot;number&quot;;
    private static final String ORIG_PODS = &quot;ONumberOfPods&quot;;
    private static final String ORIG_MEN = &quot;ONumberOfMen&quot;;
    private static final String CONVEYANCE = &quot;Conveyance&quot;;
    private static final String GAME = &quot;Game&quot;;

    /**
     * The names of attributes generally associated with Entity tags
     */
    private static final String CHASSIS = &quot;chassis&quot;;
    private static final String MODEL = &quot;model&quot;;
    private static final String CAMO_CATEGORY = &quot;camoCategory&quot;;
    private static final String CAMO_FILENAME = &quot;camoFileName&quot;;

    /**
     * The names of the attributes recognized by this parser. Not every
     * attribute is valid for every element.
     */

    private static final String NAME = &quot;name&quot;;
    private static final String SIZE = &quot;size&quot;;
    private static final String CURRENTSIZE = &quot;currentsize&quot;;

    private static final String EXT_ID = &quot;externalId&quot;;
    private static final String PICKUP_ID = &quot;pickUpId&quot;;
    private static final String NICK = &quot;nick&quot;;
    private static final String GENDER = &quot;gender&quot;;
    private static final String CAT_PORTRAIT = &quot;portraitCat&quot;;
    private static final String FILE_PORTRAIT = &quot;portraitFile&quot;;
    private static final String GUNNERY = &quot;gunnery&quot;;
    private static final String GUNNERYL = &quot;gunneryL&quot;;
    private static final String GUNNERYM = &quot;gunneryM&quot;;
    private static final String GUNNERYB = &quot;gunneryB&quot;;
    private static final String PILOTING = &quot;piloting&quot;;
    private static final String ARTILLERY = &quot;artillery&quot;;
    private static final String TOUGH = &quot;toughness&quot;;
    private static final String INITB = &quot;initB&quot;;
    private static final String COMMANDB = &quot;commandB&quot;;
    private static final String HITS = &quot;hits&quot;;
    private static final String ADVS = &quot;advantages&quot;;
    private static final String EDGE = &quot;edge&quot;;
    private static final String IMPLANTS = &quot;implants&quot;;
    private static final String QUIRKS = &quot;quirks&quot;;
    private static final String TROOPER_MISS = &quot;trooperMiss&quot;;
    private static final String DRIVER = &quot;driver&quot;;
    private static final String COMMANDER = &quot;commander&quot;;
    private static final String OFFBOARD = &quot;offboard&quot;;
    private static final String OFFBOARD_DISTANCE = &quot;offboard_distance&quot;;
    private static final String OFFBOARD_DIRECTION = &quot;offboard_direction&quot;;
    private static final String HIDDEN = &quot;hidden&quot;;
    public static final String DEPLOYMENT = &quot;deployment&quot;;
    private static final String DEPLOYMENT_ZONE = &quot;deploymentZone&quot;;
    private static final String NEVER_DEPLOYED = &quot;neverDeployed&quot;;
    private static final String VELOCITY = &quot;velocity&quot;;
    private static final String ALTITUDE = &quot;altitude&quot;;
    private static final String AUTOEJECT = &quot;autoeject&quot;;
    private static final String CONDEJECTAMMO = &quot;condejectammo&quot;;
    private static final String CONDEJECTENGINE = &quot;condejectengine&quot;;
    private static final String CONDEJECTCTDEST = &quot;condejectctdest&quot;;
    private static final String CONDEJECTHEADSHOT = &quot;condejectheadshot&quot;;
    private static final String EJECTED = &quot;ejected&quot;;
    private static final String INDEX = &quot;index&quot;;
    private static final String IS_DESTROYED = &quot;isDestroyed&quot;;
    private static final String IS_REPAIRABLE = &quot;isRepairable&quot;;
    private static final String POINTS = &quot;points&quot;;
    private static final String TYPE = &quot;type&quot;;
    private static final String SHOTS = &quot;shots&quot;;
    private static final String CAPACITY = &quot;capacity&quot;;
    private static final String IS_HIT = &quot;isHit&quot;;
    private static final String MUNITION = &quot;munition&quot;;
    private static final String STANDARD = &quot;standard&quot;;
    private static final String INFERNO = &quot;inferno&quot;;
    private static final String DIRECTION = &quot;direction&quot;;
    private static final String INTEGRITY = &quot;integrity&quot;;
    private static final String SINK = &quot;sinks&quot;;
    private static final String LEFT = &quot;left&quot;;
    private static final String AVIONICS = &quot;avionics&quot;;
    private static final String SENSORS = &quot;sensors&quot;;
    private static final String ENGINE = &quot;engine&quot;;
    private static final String FCS = &quot;fcs&quot;;
    private static final String CIC = &quot;cic&quot;;
    private static final String LEFT_THRUST = &quot;leftThrust&quot;;
    private static final String RIGHT_THRUST = &quot;rightThrust&quot;;
    private static final String LIFE_SUPPORT = &quot;lifeSupport&quot;;
    private static final String GEAR = &quot;gear&quot;;
    private static final String DOCKING_COLLAR = &quot;dockingcollar&quot;;
    private static final String KFBOOM = &quot;kfboom&quot;;
    private static final String BAYDOORS = &quot;doors&quot;;
    private static final String BAY = &quot;transportBay&quot;;
    private static final String LOADED = &quot;loaded&quot;;
    private static final String BAYDAMAGE = &quot;damage&quot;;
    private static final String WEAPONS_BAY_INDEX = &quot;weaponsBayIndex&quot;;
    private static final String MDAMAGE = &quot;damage&quot;;
    private static final String MPENALTY = &quot;penalty&quot;;
    private static final String C3MASTERIS = &quot;c3MasterIs&quot;;
    private static final String C3UUID = &quot;c3UUID&quot;;
    private static final String BOMBS = &quot;bombs&quot;;
    private static final String BOMB = &quot;bomb&quot;;
    private static final String LOAD = &quot;load&quot;;
    private static final String BA_MEA = &quot;modularEquipmentMount&quot;;
    private static final String BA_APM = &quot;antiPersonnelMount&quot;;
    private static final String BA_APM_MOUNT_NUM = &quot;baAPMMountNum&quot;;
    private static final String BA_APM_TYPE_NAME = &quot;baAPMTypeName&quot;;
    private static final String BA_MEA_MOUNT_LOC = &quot;baMEAMountLoc&quot;;
    private static final String BA_MEA_TYPE_NAME = &quot;baMEATypeName&quot;;
    private static final String KILLED = &quot;killed&quot;;
    private static final String KILLER = &quot;killer&quot;;
    private static final String EXTRA_DATA = &quot;extraData&quot;;

    public static final String ARMOR_DIVISOR = &quot;armorDivisor&quot;;
    public static final String ARMOR_ENC = &quot;armorEncumbering&quot;;
    public static final String DEST_ARMOR = &quot;destArmor&quot;;
    public static final String SPACESUIT = &quot;spacesuit&quot;;
    public static final String SNEAK_CAMO = &quot;sneakCamo&quot;;
    public static final String SNEAK_IR = &quot;sneakIR&quot;;
    public static final String SNEAK_ECM = &quot;sneakECM&quot;;
    public static final String INF_SPEC = &quot;infantrySpecializations&quot;;
    public static final String INF_SQUAD_NUM = &quot;squadNum&quot;;


    /**
     * Special values recognized by this parser.
     */
    private static final String DEAD = &quot;Dead&quot;;
    private static final String NA = &quot;N/A&quot;;
    private static final String DESTROYED = &quot;Destroyed&quot;;
    private static final String FRONT = &quot;Front&quot;;
    private static final String REAR = &quot;Rear&quot;;
    private static final String INTERNAL = &quot;Internal&quot;;
    private static final String EMPTY = &quot;Empty&quot;;
    private static final String SYSTEM = &quot;System&quot;;


    /**
     * Stores all of the  Entity's read in. This is for general use saving and loading to the chat lounge
     */
    Vector&lt;Entity&gt; entities;

    /**
     * Stores all of the  surviving Entity's read in.
     */
    Vector&lt;Entity&gt; survivors;

    /**
     * Stores all of the allied Entity's read in.
     */
    Vector&lt;Entity&gt; allies;

    /**
     * Stores all of the enemy retreated entities read in.
     */
    Vector&lt;Entity&gt; retreated;

    /**
     * Stores all the salvage entities read in
     */
    Vector&lt;Entity&gt; salvage;

    /**
     * Stores all the devastated entities read in
     */
    Vector&lt;Entity&gt; devastated;

    /**
     * Keep a separate list of pilot/crews parsed because dismounted pilots may
     * need to be read separately
     */
    private Vector&lt;Crew&gt; pilots;

    /**
     * A hashtable containing the names of killed units as the key and the external id
     * of the killer as the value
     */
    private Hashtable&lt;String, String&gt; kills;


    StringBuffer warning;

<span class="nc" id="L273">    public MULParser(){</span>
<span class="nc" id="L274">        warning = new StringBuffer();</span>
<span class="nc" id="L275">        entities = new Vector&lt;&gt;();</span>
<span class="nc" id="L276">        survivors = new Vector&lt;&gt;();</span>
<span class="nc" id="L277">        allies = new Vector&lt;&gt;();</span>
<span class="nc" id="L278">        salvage = new Vector&lt;&gt;();</span>
<span class="nc" id="L279">        retreated = new Vector&lt;&gt;();</span>
<span class="nc" id="L280">        devastated = new Vector&lt;&gt;();</span>
<span class="nc" id="L281">        kills = new Hashtable&lt;&gt;();</span>
<span class="nc" id="L282">        pilots = new Vector&lt;&gt;();</span>
<span class="nc" id="L283">    }</span>

    public MULParser(InputStream fin){
<span class="nc" id="L286">        this();</span>
<span class="nc" id="L287">        parse(fin);</span>
<span class="nc" id="L288">    }</span>

    public void parse(InputStream fin){
        // Reset the warning message.
<span class="nc" id="L292">        warning = new StringBuffer();</span>

        // Clear the entities.
<span class="nc" id="L295">        entities.removeAllElements();</span>
<span class="nc" id="L296">        survivors.removeAllElements();</span>
<span class="nc" id="L297">        allies.removeAllElements();</span>
<span class="nc" id="L298">        salvage.removeAllElements();</span>
<span class="nc" id="L299">        retreated.removeAllElements();</span>
<span class="nc" id="L300">        devastated.removeAllElements();</span>
<span class="nc" id="L301">        pilots.removeAllElements();</span>
<span class="nc" id="L302">        kills.clear();</span>

        Document xmlDoc;

        try {
            // Using factory get an instance of document builder
<span class="nc" id="L308">            DocumentBuilder db = MegaMekXmlUtil.newSafeDocumentBuilder();</span>

            // Parse using builder to get DOM representation of the XML file
<span class="nc" id="L311">            xmlDoc = db.parse(fin);</span>
<span class="nc" id="L312">        } catch (Exception ex) {</span>
<span class="nc" id="L313">            System.err.println(ex.getMessage());</span>
<span class="nc" id="L314">            ex.printStackTrace(System.err);</span>
<span class="nc" id="L315">            warning.append(&quot;Error parsing MUL file!\n&quot;);</span>
<span class="nc" id="L316">            return;</span>
<span class="nc" id="L317">        }</span>

<span class="nc" id="L319">        Element element = xmlDoc.getDocumentElement();</span>

        // Get rid of empty text nodes and adjacent text nodes...
        // Stupid weird parsing of XML. At least this cleans it up.
<span class="nc" id="L323">        element.normalize();</span>

<span class="nc" id="L325">        parse(element);</span>
<span class="nc" id="L326">    }</span>

    public void parse(Element element) {
<span class="nc" id="L329">        String version = element.getAttribute(VERSION);</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">        if (version.equals(&quot;&quot;)){</span>
<span class="nc" id="L331">            warning.append(&quot;Warning: No version specified, correct parsing &quot;)</span>
<span class="nc" id="L332">                    .append(&quot;not guaranteed!\n&quot;);</span>
        }

<span class="nc" id="L335">        String nodeName = element.getNodeName();</span>
<span class="nc bnc" id="L336" title="All 2 branches missed.">        if(nodeName.equalsIgnoreCase(RECORD)) {</span>
<span class="nc" id="L337">            parseRecord(element);</span>
<span class="nc bnc" id="L338" title="All 2 branches missed.">        } else if (nodeName.equalsIgnoreCase(UNIT)){</span>
<span class="nc" id="L339">            parseUnit(element, entities);</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">        } else if (nodeName.equalsIgnoreCase(ENTITY)){</span>
<span class="nc" id="L341">            parseEntity(element, entities);</span>
        } else {
<span class="nc" id="L343">            warning.append(&quot;Error: root element isn't a Record, Unit, or Entity tag! &quot;)</span>
<span class="nc" id="L344">                    .append(&quot;Nothing to parse!\n&quot;);</span>
        }
<span class="nc" id="L346">    }</span>

    /**
     * Parse a Unit tag.  Unit tags will contain a list of Entity tags.
     * @param unitNode
     */
    private void parseRecord(Element unitNode){
<span class="nc" id="L353">        NodeList nl = unitNode.getChildNodes();</span>

        // Iterate through the children, looking for Entity tags
<span class="nc bnc" id="L356" title="All 2 branches missed.">        for (int i = 0; i &lt; nl.getLength(); i++) {</span>
<span class="nc" id="L357">            Node currNode = nl.item(i);</span>

<span class="nc bnc" id="L359" title="All 2 branches missed.">            if (currNode.getParentNode() != unitNode) {</span>
<span class="nc" id="L360">                continue;</span>
            }
<span class="nc" id="L362">            int nodeType = currNode.getNodeType();</span>
<span class="nc bnc" id="L363" title="All 2 branches missed.">            if (nodeType == Node.ELEMENT_NODE) {</span>
<span class="nc" id="L364">                String nodeName = currNode.getNodeName();</span>
<span class="nc bnc" id="L365" title="All 2 branches missed.">                if (nodeName.equalsIgnoreCase(UNIT)){</span>
<span class="nc" id="L366">                    parseUnit((Element)currNode, entities);</span>
<span class="nc bnc" id="L367" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(SURVIVORS)){</span>
<span class="nc" id="L368">                    parseUnit((Element)currNode, survivors);</span>
<span class="nc bnc" id="L369" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(ALLIES)){</span>
<span class="nc" id="L370">                    parseUnit((Element)currNode, allies);</span>
<span class="nc bnc" id="L371" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(SALVAGE)){</span>
<span class="nc" id="L372">                    parseUnit((Element)currNode, salvage);</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(RETREATED)){</span>
<span class="nc" id="L374">                    parseUnit((Element)currNode, retreated);</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(DEVASTATED)){</span>
<span class="nc" id="L376">                    parseUnit((Element)currNode, devastated);</span>
<span class="nc bnc" id="L377" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(KILLS)){</span>
<span class="nc" id="L378">                    parseKills((Element)currNode);</span>
<span class="nc bnc" id="L379" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(ENTITY)){</span>
<span class="nc" id="L380">                    parseUnit((Element)currNode, entities);</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(PILOT)){</span>
<span class="nc" id="L382">                    parsePilot((Element)currNode);</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(CREW)){</span>
<span class="nc" id="L384">                    parseCrew((Element)currNode);</span>
                }
            }
        }
<span class="nc" id="L388">    }</span>

    /**
     * Parse a Unit tag.  Unit tags will contain a list of Entity tags.
     * @param unitNode
     * @param list - which list to add found entities too
     */
    private void parseUnit(Element unitNode, Vector&lt;Entity&gt; list){
<span class="nc" id="L396">        NodeList nl = unitNode.getChildNodes();</span>

        // Iterate through the children, looking for Entity tags
<span class="nc bnc" id="L399" title="All 2 branches missed.">        for (int i = 0; i &lt; nl.getLength(); i++) {</span>
<span class="nc" id="L400">            Node currNode = nl.item(i);</span>

<span class="nc bnc" id="L402" title="All 2 branches missed.">            if (currNode.getParentNode() != unitNode) {</span>
<span class="nc" id="L403">                continue;</span>
            }
<span class="nc" id="L405">            int nodeType = currNode.getNodeType();</span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">            if (nodeType == Node.ELEMENT_NODE) {</span>
<span class="nc" id="L407">                String nodeName = currNode.getNodeName();</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">                if (nodeName.equalsIgnoreCase(ENTITY)) {</span>
<span class="nc" id="L409">                    parseEntity((Element)currNode, list);</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(PILOT)) {</span>
<span class="nc" id="L411">                    parsePilot((Element)currNode);</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(CREW)) {</span>
<span class="nc" id="L413">                    parseCrew((Element)currNode);</span>
                }
            }
        }
<span class="nc" id="L417">    }</span>

    /**
     * Parse a kills tag.
     * @param killNode
     */
    private void parseKills(Element killNode){
<span class="nc" id="L424">        NodeList nl = killNode.getChildNodes();</span>

        // Iterate through the children, looking for Entity tags
<span class="nc bnc" id="L427" title="All 2 branches missed.">        for (int i = 0; i &lt; nl.getLength(); i++) {</span>
<span class="nc" id="L428">            Node currNode = nl.item(i);</span>

<span class="nc bnc" id="L430" title="All 2 branches missed.">            if (currNode.getParentNode() != killNode) {</span>
<span class="nc" id="L431">                continue;</span>
            }
<span class="nc" id="L433">            int nodeType = currNode.getNodeType();</span>
<span class="nc bnc" id="L434" title="All 2 branches missed.">            if (nodeType == Node.ELEMENT_NODE) {</span>
<span class="nc" id="L435">                String nodeName = currNode.getNodeName();</span>
<span class="nc bnc" id="L436" title="All 2 branches missed.">                if (nodeName.equalsIgnoreCase(KILL)){</span>
<span class="nc" id="L437">                    String killed =  ((Element)currNode).getAttribute(KILLED);</span>
<span class="nc" id="L438">                    String killer = ((Element)currNode).getAttribute(KILLER);</span>
<span class="nc bnc" id="L439" title="All 8 branches missed.">                    if(null != killed &amp;&amp; null != killer &amp;&amp; !killed.isEmpty() &amp;&amp; !killer.isEmpty()) {</span>
<span class="nc" id="L440">                        kills.put(killed, killer);</span>
                    }
                }
            }
        }
<span class="nc" id="L445">    }</span>

    /**
     * Parse an Entity tag.  Entity tags will have a number of attributes such
     * as model, chassis, type, etc.  They should also have a child Pilot tag
     * and they may also contain some number of location tags.
     *
     * @param entityNode
     * @param list - which list to add found entities too
     */
    private void parseEntity(Element entityNode, Vector&lt;Entity&gt; list) {
<span class="nc" id="L456">        Entity entity = null;</span>

        // We need to get a new Entity, use the chassis and model to create one
<span class="nc" id="L459">        String chassis =  entityNode.getAttribute(CHASSIS);</span>
<span class="nc" id="L460">        String model = entityNode.getAttribute(MODEL);</span>

        // Create a new entity
<span class="nc" id="L463">        entity = getEntity(chassis, model);</span>

        // Make sure we've got an Entity
<span class="nc bnc" id="L466" title="All 2 branches missed.">        if (entity == null) {</span>
<span class="nc" id="L467">            warning.append(&quot;Failed to load entity!&quot;);</span>
<span class="nc" id="L468">            return;</span>
        }

        // Set the attributes for the entity
<span class="nc" id="L472">        parseEntityAttributes(entity, entityNode);</span>

        // Deal with any child nodes
<span class="nc" id="L475">        NodeList nl = entityNode.getChildNodes();</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">        for (int i = 0; i &lt; nl.getLength(); i++) {</span>
<span class="nc" id="L477">            Node currNode = nl.item(i);</span>
<span class="nc bnc" id="L478" title="All 2 branches missed.">            if (currNode.getParentNode() != entityNode) {</span>
<span class="nc" id="L479">                continue;</span>
            }
<span class="nc" id="L481">            int nodeType = currNode.getNodeType();</span>
<span class="nc bnc" id="L482" title="All 2 branches missed.">            if (nodeType == Node.ELEMENT_NODE) {</span>
<span class="nc" id="L483">                Element currEle = (Element) currNode;</span>
<span class="nc" id="L484">                String nodeName = currNode.getNodeName();</span>
<span class="nc bnc" id="L485" title="All 2 branches missed.">                if (nodeName.equalsIgnoreCase(PILOT)) {</span>
<span class="nc" id="L486">                    parsePilot(currEle, entity);</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(CREW)) {</span>
<span class="nc" id="L488">                    parseCrew(currEle, entity);</span>
<span class="nc bnc" id="L489" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(LOCATION)) {</span>
<span class="nc" id="L490">                    parseLocation(currEle, entity);</span>
<span class="nc bnc" id="L491" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(MOVEMENT)) {</span>
<span class="nc" id="L492">                    parseMovement(currEle, entity);</span>
<span class="nc bnc" id="L493" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(TURRETLOCK)) {</span>
<span class="nc" id="L494">                    parseTurretLock(currEle, entity);</span>
<span class="nc bnc" id="L495" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(TURRET2LOCK)) {</span>
<span class="nc" id="L496">                    parseTurret2Lock(currEle, entity);</span>
<span class="nc bnc" id="L497" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(SI)) {</span>
<span class="nc" id="L498">                    parseSI(currEle, entity);</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(HEAT)) {</span>
<span class="nc" id="L500">                    parseHeat(currEle, entity);</span>
<span class="nc bnc" id="L501" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(FUEL)) {</span>
<span class="nc" id="L502">                    parseFuel(currEle, entity);</span>
<span class="nc bnc" id="L503" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(KF)) {</span>
<span class="nc" id="L504">                    parseKF(currEle, entity);</span>
<span class="nc bnc" id="L505" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(SAIL)) {</span>
<span class="nc" id="L506">                    parseSail(currEle, entity);</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(BAY)) {</span>
<span class="nc" id="L508">                    parseTransportBay(currEle, entity);</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(AEROCRIT)) {</span>
<span class="nc" id="L510">                    parseAeroCrit(currEle, entity);</span>
<span class="nc bnc" id="L511" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(DROPCRIT)) {</span>
<span class="nc" id="L512">                    parseDropCrit(currEle, entity);</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(TANKCRIT)) {</span>
<span class="nc" id="L514">                    parseTankCrit(currEle, entity);</span>
<span class="nc bnc" id="L515" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(BOMBS)) {</span>
<span class="nc" id="L516">                    parseBombs(currEle, entity);</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(C3I)) {</span>
<span class="nc" id="L518">                    parseC3I(currEle, entity);</span>
<span class="nc bnc" id="L519" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(NC3)) {</span>
<span class="nc" id="L520">                    parseNC3(currEle, entity);</span>
<span class="nc bnc" id="L521" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(BA_MEA)) {</span>
<span class="nc" id="L522">                    parseBAMEA(currEle, entity);</span>
<span class="nc bnc" id="L523" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(BA_APM)) {</span>
<span class="nc" id="L524">                    parseBAAPM(currEle, entity);</span>
<span class="nc bnc" id="L525" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(ESCCRAFT)) {</span>
<span class="nc" id="L526">                    parseEscapeCraft(currEle, entity);</span>
<span class="nc bnc" id="L527" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(ESCPASS)) {</span>
<span class="nc" id="L528">                    parseEscapedPassengers(currEle, entity);</span>
<span class="nc bnc" id="L529" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(ESCCREW)) {</span>
<span class="nc" id="L530">                    parseEscapedCrew(currEle, entity);</span>
<span class="nc bnc" id="L531" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(ORIG_PODS)) {</span>
<span class="nc" id="L532">                    parseOSI(currEle, entity);</span>
<span class="nc bnc" id="L533" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(ORIG_MEN)) {</span>
<span class="nc" id="L534">                    parseOMen(currEle, entity);</span>
<span class="nc bnc" id="L535" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(CONVEYANCE)) {</span>
<span class="nc" id="L536">                    parseConveyance(currEle, entity);</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(GAME)) {</span>
<span class="nc" id="L538">                    parseId(currEle, entity);</span>
                }
            }
        }

        //Now we should be done setting up the Entity, add it to the list
<span class="nc" id="L544">        list.add(entity);</span>
<span class="nc" id="L545">    }</span>

    /**
     * Create a new &lt;code&gt;Entity&lt;/code&gt; instance given a mode and chassis name.
     *
     * @param chassis
     * @param model
     * @return
     */
    private Entity getEntity(String chassis, String model){
<span class="nc" id="L555">        Entity newEntity = null;</span>

        //first check for ejected mechwarriors, vee crews, escape pods and spacecraft crews
<span class="nc bnc" id="L558" title="All 2 branches missed.">        if (chassis.equals(EjectedCrew.VEE_EJECT_NAME) </span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">                || chassis.equals(EjectedCrew.SPACE_EJECT_NAME)) {</span>
<span class="nc" id="L560">            return new EjectedCrew();</span>
<span class="nc bnc" id="L561" title="All 2 branches missed.">        } else if (chassis.equals(EjectedCrew.PILOT_EJECT_NAME)</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">                    || chassis.equals(EjectedCrew.MW_EJECT_NAME)) {</span>
<span class="nc" id="L563">            return new MechWarrior();</span>
<span class="nc bnc" id="L564" title="All 2 branches missed.">        } else if (chassis.equals(EscapePods.POD_EJECT_NAME)) {</span>
<span class="nc" id="L565">            return new EscapePods();</span>
        }

        // Did we find required attributes?
<span class="nc bnc" id="L569" title="All 4 branches missed.">        if ((chassis == null) || (chassis.length() == 0)) {</span>
<span class="nc" id="L570">            warning.append(&quot;Could not find chassis for Entity.\n&quot;);</span>
        } else {
            // Try to find the entity.
<span class="nc" id="L573">            MechSummary ms = null;</span>
<span class="nc" id="L574">            StringBuffer key = new StringBuffer(chassis);</span>
<span class="nc" id="L575">            ms = MechSummaryCache.getInstance().getMech(key.toString());</span>
<span class="nc bnc" id="L576" title="All 4 branches missed.">            if ((model != null) &amp;&amp; (model.length() &gt; 0)) {</span>
<span class="nc" id="L577">                key.append(&quot; &quot;).append(model);</span>
<span class="nc" id="L578">                ms = MechSummaryCache.getInstance().getMech(</span>
<span class="nc" id="L579">                        key.toString());</span>
                // That didn't work. Try swaping model and chassis.
<span class="nc bnc" id="L581" title="All 2 branches missed.">                if (ms == null) {</span>
<span class="nc" id="L582">                    key = new StringBuffer(model);</span>
<span class="nc" id="L583">                    key.append(&quot; &quot;).append(chassis);</span>
<span class="nc" id="L584">                    ms = MechSummaryCache.getInstance().getMech(</span>
<span class="nc" id="L585">                            key.toString());</span>
                }
            }
            // We should have found the mech.
<span class="nc bnc" id="L589" title="All 2 branches missed.">            if (ms == null) {</span>
<span class="nc" id="L590">                warning.append(&quot;Could not find Entity with chassis: &quot;).append(chassis);</span>
<span class="nc bnc" id="L591" title="All 4 branches missed.">                if ((model != null) &amp;&amp; (model.length() &gt; 0)) {</span>
<span class="nc" id="L592">                    warning.append(&quot;, and model: &quot;).append(model);</span>
                }
<span class="nc" id="L594">                warning.append(&quot;.\n&quot;);</span>
            } else {
                // Try to load the new mech.
                try {
<span class="nc" id="L598">                    newEntity = new MechFileParser(ms.getSourceFile(),</span>
<span class="nc" id="L599">                            ms.getEntryName()).getEntity();</span>
<span class="nc" id="L600">                } catch (EntityLoadingException excep) {</span>
<span class="nc" id="L601">                    excep.printStackTrace(System.err);</span>
<span class="nc" id="L602">                    warning.append(&quot;Unable to load mech: &quot;)</span>
<span class="nc" id="L603">                            .append(ms.getSourceFile()).append(&quot;: &quot;)</span>
<span class="nc" id="L604">                            .append(ms.getEntryName()).append(&quot;: &quot;)</span>
<span class="nc" id="L605">                            .append(excep.getMessage());</span>
<span class="nc" id="L606">                }</span>
            } // End found-MechSummary
        }
<span class="nc" id="L609">        return newEntity;</span>
    }

    /**
     * An Entity tag can define numerous attributes for the &lt;code&gt;Entity&lt;/code&gt;,
     * check and set all of the relevant attributes.
     *
     * @param entity    The newly created Entity that we are setting state for
     * @param entityTag The Entity tag that defines the attributes
     */
    private void parseEntityAttributes(Entity entity, Element entityTag){
        // commander
<span class="nc" id="L621">        boolean commander =</span>
<span class="nc" id="L622">                Boolean.parseBoolean(entityTag.getAttribute(COMMANDER));</span>
<span class="nc" id="L623">        entity.setCommander(commander);</span>

        // hidden
        try {
<span class="nc" id="L627">            boolean isHidden =</span>
<span class="nc" id="L628">                    Boolean.parseBoolean(entityTag.getAttribute(HIDDEN));</span>
<span class="nc" id="L629">            entity.setHidden(isHidden);</span>
<span class="nc" id="L630">        } catch (Exception e) {</span>
<span class="nc" id="L631">            entity.setHidden(false);</span>
<span class="nc" id="L632">        }</span>

        // deploy offboard
        try {
<span class="nc" id="L636">            boolean offBoard =</span>
<span class="nc" id="L637">                    Boolean.parseBoolean(entityTag.getAttribute(OFFBOARD));</span>
<span class="nc bnc" id="L638" title="All 2 branches missed.">            if (offBoard) {</span>
<span class="nc" id="L639">                int distance = Integer.parseInt(entityTag</span>
<span class="nc" id="L640">                        .getAttribute(OFFBOARD_DISTANCE));</span>
<span class="nc" id="L641">                OffBoardDirection dir = OffBoardDirection.getDirection(Integer</span>
<span class="nc" id="L642">                        .parseInt(entityTag.getAttribute(OFFBOARD_DIRECTION)));</span>
<span class="nc" id="L643">                entity.setOffBoard(distance, dir);</span>
            }
<span class="nc" id="L645">        } catch (Exception ignored) {</span>
<span class="nc" id="L646">        }</span>

        // deployment round
        try {
<span class="nc" id="L650">            int deployRound = Integer.parseInt(entityTag.getAttribute(DEPLOYMENT));</span>
<span class="nc" id="L651">            entity.setDeployRound(deployRound);</span>
<span class="nc" id="L652">        } catch (Exception e) {</span>
<span class="nc" id="L653">            entity.setDeployRound(0);</span>
<span class="nc" id="L654">        }</span>

        // deployment zone
        try {
<span class="nc" id="L658">            int deployZone = Integer.parseInt(entityTag.getAttribute(DEPLOYMENT_ZONE));</span>
<span class="nc" id="L659">            entity.setStartingPos(deployZone);</span>
<span class="nc" id="L660">        } catch (Exception e) {</span>
<span class="nc" id="L661">            entity.setStartingPos(Board.START_NONE);</span>
<span class="nc" id="L662">        }</span>



        // Was never deployed
        try {
<span class="nc" id="L668">            String ndeploy = entityTag.getAttribute(NEVER_DEPLOYED);</span>
<span class="nc" id="L669">            boolean wasNeverDeployed =</span>
<span class="nc" id="L670">                    Boolean.parseBoolean(entityTag.getAttribute(NEVER_DEPLOYED));</span>
<span class="nc bnc" id="L671" title="All 4 branches missed.">            if(null == ndeploy || ndeploy.isEmpty()) {</span>
                //this will default to false above, but we want it to default to true
<span class="nc" id="L673">                wasNeverDeployed = true;</span>
            }
<span class="nc" id="L675">            entity.setNeverDeployed(wasNeverDeployed);</span>
<span class="nc" id="L676">        } catch (Exception e) {</span>
<span class="nc" id="L677">            entity.setNeverDeployed(true);</span>
<span class="nc" id="L678">        }</span>

<span class="nc bnc" id="L680" title="All 2 branches missed.">        if (entity.isAero()) {</span>
<span class="nc" id="L681">            String velString = entityTag.getAttribute(VELOCITY);</span>
<span class="nc" id="L682">            String altString = entityTag.getAttribute(ALTITUDE);</span>

<span class="nc" id="L684">            IAero a = (IAero) entity;</span>
<span class="nc bnc" id="L685" title="All 2 branches missed.">            if (velString.length() &gt; 0){</span>
<span class="nc" id="L686">                int velocity = Integer.parseInt(velString);</span>
<span class="nc" id="L687">                a.setCurrentVelocity(velocity);</span>
<span class="nc" id="L688">                a.setNextVelocity(velocity);</span>
            }
<span class="nc bnc" id="L690" title="All 2 branches missed.">            if (altString.length() &gt; 0){</span>
<span class="nc" id="L691">                int altitude = Integer.parseInt(altString);</span>
<span class="nc bnc" id="L692" title="All 2 branches missed.">                if (altitude &lt;= 0) {</span>
<span class="nc" id="L693">                    a.land();</span>
                } else {
<span class="nc" id="L695">                    a.liftOff(altitude);</span>
                }
            }
        }

        // Camo
        // Must be a null, and not an empty string, if it isn't being used. - Dylan 2014-04-04
<span class="nc bnc" id="L702" title="All 2 branches missed.">        entity.setCamoCategory(entityTag.getAttribute(CAMO_CATEGORY).equals(&quot;&quot;) ? null : entityTag.getAttribute(CAMO_CATEGORY));</span>
<span class="nc bnc" id="L703" title="All 2 branches missed.">        entity.setCamoFileName(entityTag.getAttribute(CAMO_FILENAME).equals(&quot;&quot;) ? null : entityTag.getAttribute(CAMO_FILENAME));</span>

        // external id
<span class="nc" id="L706">        String extId = entityTag.getAttribute(EXT_ID);</span>
<span class="nc bnc" id="L707" title="All 4 branches missed.">        if ((null == extId) || (extId.length() == 0)) {</span>
<span class="nc" id="L708">            extId = &quot;-1&quot;;</span>
        }
<span class="nc" id="L710">        entity.setExternalIdAsString(extId);</span>

        // external id
<span class="nc bnc" id="L713" title="All 2 branches missed.">        if(entity instanceof MechWarrior) {</span>
<span class="nc" id="L714">            String pickUpId = entityTag.getAttribute(PICKUP_ID);</span>
<span class="nc bnc" id="L715" title="All 4 branches missed.">            if ((null == pickUpId) || (pickUpId.length() == 0)) {</span>
<span class="nc" id="L716">                pickUpId = &quot;-1&quot;;</span>
            }
<span class="nc" id="L718">            ((MechWarrior)entity).setPickedUpByExternalId(pickUpId);</span>
        }


        // quirks
<span class="nc" id="L723">        String quirks = entityTag.getAttribute(QUIRKS);</span>
<span class="nc bnc" id="L724" title="All 4 branches missed.">        if ((null != quirks) &amp;&amp; (quirks.trim().length() &gt; 0)) {</span>
<span class="nc" id="L725">            StringTokenizer st = new StringTokenizer(quirks, &quot;::&quot;);</span>
<span class="nc bnc" id="L726" title="All 2 branches missed.">            while (st.hasMoreTokens()) {</span>
<span class="nc" id="L727">                String quirk = st.nextToken();</span>
<span class="nc" id="L728">                String quirkName = Crew.parseAdvantageName(quirk);</span>
<span class="nc" id="L729">                Object value = Crew.parseAdvantageValue(quirk);</span>

                try {
<span class="nc" id="L732">                    entity.getQuirks().getOption(quirkName)</span>
<span class="nc" id="L733">                            .setValue(value);</span>
<span class="nc" id="L734">                } catch (Exception e) {</span>
<span class="nc" id="L735">                    warning.append(&quot;Error restoring quirk: &quot;)</span>
<span class="nc" id="L736">                            .append(quirk).append(&quot;.\n&quot;);</span>
<span class="nc" id="L737">                }</span>
<span class="nc" id="L738">            }</span>
        }

        // Setup for C3 Relinking
<span class="nc" id="L742">        String c3masteris = entityTag.getAttribute(C3MASTERIS);</span>
<span class="nc bnc" id="L743" title="All 2 branches missed.">        if (c3masteris.length() &gt; 0) {</span>
<span class="nc" id="L744">            entity.setC3MasterIsUUIDAsString(c3masteris);</span>
        }
<span class="nc" id="L746">        String c3uuid = entityTag.getAttribute(C3UUID);</span>
<span class="nc bnc" id="L747" title="All 2 branches missed.">        if (c3uuid.length() &gt; 0) {</span>
<span class="nc" id="L748">            entity.setC3UUIDAsString(c3uuid);</span>
        }

        // Load some values for conventional infantry
<span class="nc bnc" id="L752" title="All 4 branches missed.">        if ((entity instanceof Infantry)</span>
                &amp;&amp; !(entity instanceof BattleArmor)) {
<span class="nc" id="L754">            Infantry inf = (Infantry) entity;</span>
<span class="nc" id="L755">            String armorDiv = entityTag.getAttribute(ARMOR_DIVISOR);</span>
<span class="nc bnc" id="L756" title="All 2 branches missed.">            if (armorDiv.length() &gt; 0) {</span>
<span class="nc" id="L757">                inf.setArmorDamageDivisor(Double.parseDouble(armorDiv));</span>
            }
<span class="nc bnc" id="L759" title="All 2 branches missed.">            if (entityTag.getAttribute(ARMOR_ENC).length() &gt; 0) {</span>
<span class="nc" id="L760">                inf.setArmorEncumbering(true);</span>
            }
<span class="nc bnc" id="L762" title="All 2 branches missed.">            if (entityTag.getAttribute(SPACESUIT).length() &gt; 0) {</span>
<span class="nc" id="L763">                inf.setSpaceSuit(true);</span>
            }
<span class="nc bnc" id="L765" title="All 2 branches missed.">            if (entityTag.getAttribute(DEST_ARMOR).length() &gt; 0) {</span>
<span class="nc" id="L766">                inf.setDEST(true);</span>
            }
<span class="nc bnc" id="L768" title="All 2 branches missed.">            if (entityTag.getAttribute(SNEAK_CAMO).length() &gt; 0) {</span>
<span class="nc" id="L769">                inf.setSneakCamo(true);</span>
            }
<span class="nc bnc" id="L771" title="All 2 branches missed.">            if (entityTag.getAttribute(SNEAK_IR).length() &gt; 0) {</span>
<span class="nc" id="L772">                inf.setSneakIR(true);</span>
            }
<span class="nc bnc" id="L774" title="All 2 branches missed.">            if (entityTag.getAttribute(SNEAK_ECM).length() &gt; 0) {</span>
<span class="nc" id="L775">                inf.setSneakECM(true);</span>
            }
<span class="nc" id="L777">            String infSpec = entityTag.getAttribute(INF_SPEC);</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">            if (infSpec.length() &gt; 0) {</span>
<span class="nc" id="L779">                inf.setSpecializations(Integer.parseInt(infSpec));</span>
            }
            
<span class="nc" id="L782">            String infSquadNum = entityTag.getAttribute(INF_SQUAD_NUM);</span>
<span class="nc bnc" id="L783" title="All 2 branches missed.">            if(infSquadNum.length() &gt; 0) {</span>
<span class="nc" id="L784">                inf.setSquadN(Integer.parseInt(infSquadNum));</span>
<span class="nc" id="L785">                inf.autoSetInternal();</span>
            }
        }
<span class="nc" id="L788">    }</span>

    /**
     * Convenience function that calls &lt;code&gt;parsePilot&lt;/code&gt; with a null
     * Entity.
     *
     * @param pilotNode The Pilot tag to create a &lt;code&gt;Crew&lt;/code&gt; from
     */
    private void parsePilot(Element pilotNode){
<span class="nc" id="L797">        parsePilot(pilotNode, null);</span>
<span class="nc" id="L798">    }</span>

    /**
     * Given a pilot tag, read the attributes and create a new &lt;code&gt;Crew&lt;/code&gt;
     * instance.  If a non-null &lt;code&gt;Entity&lt;/code&gt; is passed, the new crew will
     * be set as the crew for the given &lt;code&gt;Entity&lt;/code&gt;.
     *
     * @param pilotNode The Pilot tag to create a &lt;code&gt;Crew&lt;/code&gt; from
     * @param entity    If non-null, the new &lt;code&gt;Crew&lt;/code&gt; will be set as
     *                  the crew of this &lt;code&gt;Entity&lt;/code&gt;
     */
    private void parsePilot(Element pilotNode, Entity entity) {
<span class="nc" id="L810">        Map&lt;String,String&gt; attributes = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L811" title="All 2 branches missed.">        for (int i = 0; i &lt; pilotNode.getAttributes().getLength(); i++) {</span>
<span class="nc" id="L812">            final Node node = pilotNode.getAttributes().item(i);</span>
<span class="nc" id="L813">            attributes.put(node.getNodeName(), node.getTextContent());</span>
        }

        Crew crew;
<span class="nc bnc" id="L817" title="All 2 branches missed.">        if (null != entity) {</span>
<span class="nc" id="L818">            crew = new Crew(entity.getCrew().getCrewType());</span>
        } else {
<span class="nc" id="L820">            crew = new Crew(CrewType.SINGLE);</span>
        }
<span class="nc" id="L822">        setCrewAttributes(crew, attributes, entity);</span>
<span class="nc" id="L823">        setPilotAttributes(crew, 0, attributes);</span>
        // LAMs have a second set of gunnery and piloting stats, so we create a dummy crew
        // and parse a copy of the attributes with the aero stats altered to their non-aero keys,
        // then copy the results into the aero skills of the LAMPilot.
<span class="nc bnc" id="L827" title="All 2 branches missed.">        if (entity instanceof LandAirMech) {</span>
<span class="nc" id="L828">            crew = LAMPilot.convertToLAMPilot((LandAirMech)entity, crew);</span>
<span class="nc" id="L829">            Crew aeroCrew = new Crew(CrewType.SINGLE);</span>
<span class="nc" id="L830">            Map&lt;String,String&gt; aeroAttributes = new HashMap&lt;&gt;(attributes);</span>
<span class="nc bnc" id="L831" title="All 2 branches missed.">            for (String key : attributes.keySet()) {</span>
<span class="nc bnc" id="L832" title="All 2 branches missed.">                if (key.contains(&quot;Aero&quot;)) {</span>
<span class="nc" id="L833">                    aeroAttributes.put(key.replace(&quot;Aero&quot;, &quot;&quot;), attributes.get(key));</span>
                }
<span class="nc" id="L835">            }</span>
<span class="nc" id="L836">            setPilotAttributes(aeroCrew, 0, aeroAttributes);</span>
<span class="nc" id="L837">            ((LAMPilot)crew).setGunneryAero(aeroCrew.getGunnery());</span>
<span class="nc" id="L838">            ((LAMPilot)crew).setGunneryAeroM(aeroCrew.getGunneryM());</span>
<span class="nc" id="L839">            ((LAMPilot)crew).setGunneryAeroB(aeroCrew.getGunneryB());</span>
<span class="nc" id="L840">            ((LAMPilot)crew).setGunneryAeroL(aeroCrew.getGunneryL());</span>
<span class="nc" id="L841">            ((LAMPilot)crew).setPilotingAero(aeroCrew.getPiloting());</span>
<span class="nc" id="L842">            entity.setCrew(crew);</span>
        }
<span class="nc" id="L844">        pilots.add(crew);</span>
<span class="nc" id="L845">    }</span>

    /**
    /**
     * Convenience function that calls &lt;code&gt;parseCrew&lt;/code&gt; with a null
     * Entity.
     *
     * @param crewNode The crew tag to create a &lt;code&gt;Crew&lt;/code&gt; from
     */
    private void parseCrew(Element crewNode) {
<span class="nc" id="L855">        parseCrew(crewNode, null);</span>
<span class="nc" id="L856">    }</span>

    /**
     * Used for multi-crew cockpits.
     * Given a tag, read the attributes and create a new &lt;code&gt;Crew&lt;/code&gt;
     * instance.  If a non-null &lt;code&gt;Entity&lt;/code&gt; is passed, the new crew will
     * be set as the crew for the given &lt;code&gt;Entity&lt;/code&gt;.
     *
     * @param crewNode The crew tag to create a &lt;code&gt;Crew&lt;/code&gt; from
     * @param entity   If non-null, the new &lt;code&gt;Crew&lt;/code&gt; will be set as
     *                 the crew of this &lt;code&gt;Entity&lt;/code&gt;
     */
    private void parseCrew(Element crewNode, Entity entity) {
<span class="nc" id="L869">        final Map&lt;String, String&gt; crewAttr = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L870" title="All 2 branches missed.">        for (int i = 0; i &lt; crewNode.getAttributes().getLength(); i++) {</span>
<span class="nc" id="L871">            final Node node = crewNode.getAttributes().item(i);</span>
<span class="nc" id="L872">            crewAttr.put(node.getNodeName(), node.getTextContent());</span>
        }
        //Do not assign crew attributes until after individual crew members have been processed because
        //we cannot assign hits to ejected crew.

        Crew crew;
<span class="nc" id="L878">        CrewType crewType = null;</span>
<span class="nc bnc" id="L879" title="All 2 branches missed.">        if (crewAttr.containsKey(CREWTYPE)) {</span>
<span class="nc bnc" id="L880" title="All 2 branches missed.">            for (CrewType ct : CrewType.values()) {</span>
<span class="nc bnc" id="L881" title="All 2 branches missed.">                if (ct.toString().equalsIgnoreCase(crewAttr.get(CREWTYPE))) {</span>
<span class="nc" id="L882">                    crewType = ct;</span>
<span class="nc" id="L883">                    break;</span>
                }
            }
        }
<span class="nc bnc" id="L887" title="All 2 branches missed.">        if (null != crewType) {</span>
<span class="nc" id="L888">            crew = new Crew(crewType);</span>
        } else {
<span class="nc" id="L890">            crew = new Crew(CrewType.SINGLE);</span>
        }
<span class="nc" id="L892">        pilots.add(crew);</span>
<span class="nc bnc" id="L893" title="All 2 branches missed.">        for (int i = 0; i &lt; crew.getSlotCount(); i++) {</span>
<span class="nc" id="L894">            crew.setMissing(true, i);</span>
        }

<span class="nc bnc" id="L897" title="All 2 branches missed.">        for (int n = 0; n &lt; crewNode.getChildNodes().getLength(); n++) {</span>
<span class="nc" id="L898">            final Node pilotNode = crewNode.getChildNodes().item(n);</span>
<span class="nc bnc" id="L899" title="All 2 branches missed.">            if (pilotNode.getNodeName().equalsIgnoreCase(CREWMEMBER)) {</span>
<span class="nc" id="L900">                final Map&lt;String, String&gt; pilotAttr = new HashMap&lt;&gt;(crewAttr);</span>
<span class="nc bnc" id="L901" title="All 2 branches missed.">                for (int i = 0; i &lt; pilotNode.getAttributes().getLength(); i++) {</span>
<span class="nc" id="L902">                    final Node node = pilotNode.getAttributes().item(i);</span>
<span class="nc" id="L903">                    pilotAttr.put(node.getNodeName(), node.getTextContent());</span>
                }
<span class="nc" id="L905">                int slot = -1;</span>
<span class="nc bnc" id="L906" title="All 4 branches missed.">                if (pilotAttr.containsKey(SLOT) &amp;&amp; pilotAttr.get(SLOT).length() &gt; 0) {</span>
                    try {
<span class="nc" id="L908">                        slot = Integer.parseInt(pilotAttr.get(SLOT));</span>
<span class="nc" id="L909">                    } catch (NumberFormatException ex) {</span>
<span class="nc" id="L910">                        warning.append(&quot;Illegal crew slot index: &quot;).append(pilotAttr.get(SLOT));</span>
<span class="nc" id="L911">                    }</span>
                }
<span class="nc bnc" id="L913" title="All 4 branches missed.">                if (slot &lt; 0 &amp;&amp; slot &gt;= crew.getSlotCount()) {</span>
<span class="nc" id="L914">                    warning.append(&quot;Illegal crew slot index for &quot;).append(crewType)</span>
<span class="nc" id="L915">                            .append(&quot; cockpit: &quot;).append(slot);</span>
                } else {
<span class="nc" id="L917">                    crew.setMissing(false, slot);</span>
<span class="nc" id="L918">                    setPilotAttributes(crew, slot, pilotAttr);</span>
                }
            }
        }
<span class="nc" id="L922">        setCrewAttributes(crew, crewAttr, entity);</span>
<span class="nc" id="L923">    }</span>

    /**
     * Helper method that sets field values for the crew as a whole, either from a &lt;pilot&gt; element
     * (single/collective crews) or a &lt;crew&gt; element (multi-crew cockpits). If an &lt;code&gt;Entity&lt;/code&gt;
     * is provided, the crew will be assigned to it.
     *
     * @param crew       The crew to set fields for.
     * @param attributes Attribute values of the &lt;code&gt;pilot&lt;/code&gt; or &lt;code&gt;crew&lt;/code&gt;
     *                   element mapped to the attribute name.
     * @param entity     The &lt;code&gt;Entity&lt;/code&gt; for this crew (or null if the crew has abandoned the unit).
     */
    private void setCrewAttributes(Crew crew, Map&lt;String,String&gt; attributes, Entity entity) {
        // init bonus
<span class="nc" id="L937">        int initBVal = 0;</span>
<span class="nc bnc" id="L938" title="All 4 branches missed.">        if ((attributes.containsKey(INITB)) &amp;&amp; (attributes.get(INITB).length() &gt; 0)) {</span>
            try {
<span class="nc" id="L940">                initBVal = Integer.parseInt(attributes.get(INITB));</span>
<span class="nc" id="L941">            } catch (NumberFormatException excep) {</span>
                // Handled by the next if test.
<span class="nc" id="L943">            }</span>
        }
<span class="nc" id="L945">        int commandBVal = 0;</span>
<span class="nc bnc" id="L946" title="All 4 branches missed.">        if ((attributes.containsKey(COMMANDB)) &amp;&amp; (attributes.get(COMMANDB).length() &gt; 0)) {</span>
            try {
<span class="nc" id="L948">                commandBVal = Integer.parseInt(attributes.get(COMMANDB));</span>
<span class="nc" id="L949">            } catch (NumberFormatException ignored) {</span>
                // Handled by the next if test.
<span class="nc" id="L951">            }</span>
        }

<span class="nc bnc" id="L954" title="All 2 branches missed.">        if (attributes.containsKey(SIZE)) {</span>
<span class="nc bnc" id="L955" title="All 2 branches missed.">            if (attributes.get(SIZE).length() &gt; 0) {</span>
<span class="nc" id="L956">                int crewSize = 1;</span>
                try {
<span class="nc" id="L958">                    crewSize = Integer.parseInt(attributes.get(SIZE));</span>
<span class="nc" id="L959">                } catch (NumberFormatException ignored) {</span>
                    // Do nothing, this field isn't required
<span class="nc" id="L961">                }</span>
<span class="nc" id="L962">                crew.setSize(crewSize);</span>
<span class="nc bnc" id="L963" title="All 2 branches missed.">            } else if (null != entity) {</span>
<span class="nc" id="L964">                crew.setSize(Compute.getFullCrewSize(entity));</span>
                //Reset the currentSize equal to the max size
<span class="nc" id="L966">                crew.setCurrentSize(Compute.getFullCrewSize(entity));</span>
            }
        }
        
<span class="nc bnc" id="L970" title="All 2 branches missed.">        if (attributes.containsKey(CURRENTSIZE)) {</span>
<span class="nc bnc" id="L971" title="All 2 branches missed.">            if (attributes.get(CURRENTSIZE).length() &gt; 0) {</span>
<span class="nc" id="L972">                int crewCurrentSize = 1;</span>
                try {
<span class="nc" id="L974">                    crewCurrentSize = Integer.parseInt(attributes.get(CURRENTSIZE));</span>
<span class="nc" id="L975">                } catch (NumberFormatException e) {</span>
                    // Do nothing, this field isn't required
<span class="nc" id="L977">                }</span>
<span class="nc" id="L978">                crew.setCurrentSize(crewCurrentSize);</span>
<span class="nc bnc" id="L979" title="All 2 branches missed.">            } else if (null != entity) {</span>
                //Reset the currentSize equal to the max size
<span class="nc" id="L981">                crew.setCurrentSize(Compute.getFullCrewSize(entity));</span>
            }
        }

<span class="nc" id="L985">        crew.setInitBonus(initBVal);</span>
<span class="nc" id="L986">        crew.setCommandBonus(commandBVal);</span>
<span class="nc bnc" id="L987" title="All 4 branches missed.">        if (attributes.containsKey(ADVS) &amp;&amp; (attributes.get(ADVS).trim().length() &gt; 0)) {</span>
<span class="nc" id="L988">            StringTokenizer st = new StringTokenizer(attributes.get(ADVS), &quot;::&quot;);</span>
<span class="nc bnc" id="L989" title="All 2 branches missed.">            while (st.hasMoreTokens()) {</span>
<span class="nc" id="L990">                String adv = st.nextToken();</span>
<span class="nc" id="L991">                String advName = Crew.parseAdvantageName(adv);</span>
<span class="nc" id="L992">                Object value = Crew.parseAdvantageValue(adv);</span>

                try {
<span class="nc" id="L995">                    crew.getOptions().getOption(advName).setValue(value);</span>
<span class="nc" id="L996">                } catch (Exception e) {</span>
<span class="nc" id="L997">                    warning.append(&quot;Error restoring advantage: &quot;).append(adv).append(&quot;.\n&quot;);</span>
<span class="nc" id="L998">                }</span>
<span class="nc" id="L999">            }</span>

        }
<span class="nc bnc" id="L1002" title="All 4 branches missed.">        if (attributes.containsKey(EDGE) &amp;&amp; (attributes.get(EDGE).trim().length() &gt; 0)) {</span>
<span class="nc" id="L1003">            StringTokenizer st = new StringTokenizer(attributes.get(EDGE), &quot;::&quot;);</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">            while (st.hasMoreTokens()) {</span>
<span class="nc" id="L1005">                String edg = st.nextToken();</span>
<span class="nc" id="L1006">                String edgeName = Crew.parseAdvantageName(edg);</span>
<span class="nc" id="L1007">                Object value = Crew.parseAdvantageValue(edg);</span>

                try {
<span class="nc" id="L1010">                    crew.getOptions().getOption(edgeName).setValue(value);</span>
<span class="nc" id="L1011">                } catch (Exception e) {</span>
<span class="nc" id="L1012">                    warning.append(&quot;Error restoring edge: &quot;).append(edg).append(&quot;.\n&quot;);</span>
<span class="nc" id="L1013">                }</span>
<span class="nc" id="L1014">            }</span>
        }
<span class="nc bnc" id="L1016" title="All 4 branches missed.">        if (attributes.containsKey(IMPLANTS) &amp;&amp; (attributes.get(IMPLANTS).trim().length() &gt; 0)) {</span>
<span class="nc" id="L1017">            StringTokenizer st = new StringTokenizer(attributes.get(IMPLANTS), &quot;::&quot;);</span>
<span class="nc bnc" id="L1018" title="All 2 branches missed.">            while (st.hasMoreTokens()) {</span>
<span class="nc" id="L1019">                String implant = st.nextToken();</span>
<span class="nc" id="L1020">                String implantName = Crew.parseAdvantageName(implant);</span>
<span class="nc" id="L1021">                Object value = Crew.parseAdvantageValue(implant);</span>

                try {
<span class="nc" id="L1024">                    crew.getOptions().getOption(implantName).setValue(value);</span>
<span class="nc" id="L1025">                } catch (Exception e) {</span>
<span class="nc" id="L1026">                    warning.append(&quot;Error restoring implants: &quot;).append(implant).append(&quot;.\n&quot;);</span>
<span class="nc" id="L1027">                }</span>
<span class="nc" id="L1028">            }</span>
        }

<span class="nc bnc" id="L1031" title="All 4 branches missed.">        if (attributes.containsKey(EJECTED) &amp;&amp; attributes.get(EJECTED).length() &gt; 0) {</span>
<span class="nc" id="L1032">            crew.setEjected(Boolean.parseBoolean(attributes.get(EJECTED)));</span>
        }

<span class="nc bnc" id="L1035" title="All 2 branches missed.">        if (null != entity) {</span>
            // Set the crew for this entity.
<span class="nc" id="L1037">            entity.setCrew(crew);</span>

<span class="nc bnc" id="L1039" title="All 4 branches missed.">            if (attributes.containsKey(AUTOEJECT) &amp;&amp; attributes.get(AUTOEJECT).length() &gt; 0) {</span>
<span class="nc" id="L1040">                ((Mech)entity).setAutoEject(Boolean.parseBoolean(attributes.get(AUTOEJECT)));</span>
            }
<span class="nc bnc" id="L1042" title="All 4 branches missed.">            if (attributes.containsKey(CONDEJECTAMMO) &amp;&amp; attributes.get(CONDEJECTAMMO).length() &gt; 0) {</span>
<span class="nc" id="L1043">                ((Mech)entity).setCondEjectAmmo(Boolean.parseBoolean(attributes.get(CONDEJECTAMMO)));</span>
            }
<span class="nc bnc" id="L1045" title="All 4 branches missed.">            if (attributes.containsKey(CONDEJECTENGINE) &amp;&amp; attributes.get(CONDEJECTENGINE).length() &gt; 0) {</span>
<span class="nc" id="L1046">                ((Mech)entity).setCondEjectEngine(Boolean.parseBoolean(attributes.get(CONDEJECTENGINE)));</span>
            }
<span class="nc bnc" id="L1048" title="All 4 branches missed.">            if (attributes.containsKey(CONDEJECTCTDEST) &amp;&amp; attributes.get(CONDEJECTCTDEST).length() &gt; 0) {</span>
<span class="nc" id="L1049">                ((Mech)entity).setCondEjectCTDest(Boolean.parseBoolean(attributes.get(CONDEJECTCTDEST)));</span>
            }
<span class="nc bnc" id="L1051" title="All 4 branches missed.">            if (attributes.containsKey(CONDEJECTHEADSHOT) &amp;&amp; attributes.get(CONDEJECTHEADSHOT).length() &gt; 0) {</span>
<span class="nc" id="L1052">                ((Mech)entity).setCondEjectHeadshot(Boolean.parseBoolean(attributes.get(CONDEJECTHEADSHOT)));</span>
            }
        }
<span class="nc" id="L1055">    }</span>

    /**
     *      * Helper method that parses attributes common to both single/collective crews and individual
     * slots of a unit with a multi-crew cockpit.
     *
     * @param crew The crew object for set values for
     * @param slot The slot of the crew object that corresponds to these attributes.
     * @param attributes A map of attribute values keyed to the attribute names.
     */
    private void setPilotAttributes(Crew crew, int slot, Map&lt;String, String&gt; attributes) {
<span class="nc bnc" id="L1066" title="All 4 branches missed.">        final boolean hasGun = attributes.containsKey(GUNNERY) &amp;&amp; (attributes.get(GUNNERY).length() &gt; 0);</span>
<span class="nc bnc" id="L1067" title="All 4 branches missed.">        final boolean hasRpgGun = attributes.containsKey(GUNNERYL) &amp;&amp; (attributes.get(GUNNERYL).length() &gt; 0) &amp;&amp;</span>
<span class="nc bnc" id="L1068" title="All 4 branches missed.">                attributes.containsKey(GUNNERYM) &amp;&amp; (attributes.get(GUNNERYM).length() &gt; 0) &amp;&amp;</span>
<span class="nc bnc" id="L1069" title="All 4 branches missed.">                attributes.containsKey(GUNNERYB) &amp;&amp; (attributes.get(GUNNERYB).length() &gt; 0);</span>

        // Did we find required attributes?
<span class="nc bnc" id="L1072" title="All 4 branches missed.">        if (!hasGun &amp;&amp; !hasRpgGun) {</span>
<span class="nc" id="L1073">            warning.append(&quot;Could not find gunnery for pilot.\n&quot;);</span>
<span class="nc bnc" id="L1074" title="All 4 branches missed.">        } else if (!attributes.containsKey(PILOTING) || (attributes.get(PILOTING).length() == 0)) {</span>
<span class="nc" id="L1075">            warning.append(&quot;Could not find piloting for pilot.\n&quot;);</span>
        } else {
            // Try to get a good gunnery value.
<span class="nc" id="L1078">            int gunVal = -1;</span>
<span class="nc bnc" id="L1079" title="All 2 branches missed.">            if (hasGun) {</span>
                try {
<span class="nc" id="L1081">                    gunVal = Integer.parseInt(attributes.get(GUNNERY));</span>
<span class="nc" id="L1082">                } catch (NumberFormatException ignored) {</span>
                    // Handled by the next if test.
<span class="nc" id="L1084">                }</span>

<span class="nc bnc" id="L1086" title="All 4 branches missed.">                if ((gunVal &lt; 0)</span>
                        || (gunVal &gt; Crew.MAX_SKILL)) {
<span class="nc" id="L1088">                    warning.append(&quot;Found invalid gunnery value: &quot;)</span>
<span class="nc" id="L1089">                            .append(attributes.get(GUNNERY)).append(&quot;.\n&quot;);</span>
<span class="nc" id="L1090">                    return;</span>
                }
            }

            // get RPG skills
<span class="nc" id="L1095">            int gunneryLVal = -1;</span>
<span class="nc" id="L1096">            int gunneryMVal = -1;</span>
<span class="nc" id="L1097">            int gunneryBVal = -1;</span>
<span class="nc bnc" id="L1098" title="All 2 branches missed.">            if (hasRpgGun) {</span>
<span class="nc bnc" id="L1099" title="All 4 branches missed.">                if ((attributes.containsKey(GUNNERYL)) &amp;&amp; (attributes.get(GUNNERYL).length() &gt; 0)) {</span>
                    try {
<span class="nc" id="L1101">                        gunneryLVal = Integer.parseInt(attributes.get(GUNNERYL));</span>
<span class="nc" id="L1102">                    } catch (NumberFormatException ignored) {</span>
                        // Handled by the next if test.
<span class="nc" id="L1104">                    }</span>
<span class="nc bnc" id="L1105" title="All 4 branches missed.">                    if ((gunneryLVal &lt; 0)</span>
                            || (gunneryLVal &gt; Crew.MAX_SKILL)) {
<span class="nc" id="L1107">                        warning.append(&quot;Found invalid piloting value: &quot;)</span>
<span class="nc" id="L1108">                                .append(attributes.get(GUNNERYL)).append(&quot;.\n&quot;);</span>
<span class="nc" id="L1109">                        return;</span>
                    }
                }
<span class="nc bnc" id="L1112" title="All 4 branches missed.">                if ((attributes.containsKey(GUNNERYM)) &amp;&amp; (attributes.get(GUNNERYM).length() &gt; 0)) {</span>
                    try {
<span class="nc" id="L1114">                        gunneryMVal = Integer.parseInt(attributes.get(GUNNERYM));</span>
<span class="nc" id="L1115">                    } catch (NumberFormatException ignored) {</span>
                        // Handled by the next if test.
<span class="nc" id="L1117">                    }</span>
<span class="nc bnc" id="L1118" title="All 4 branches missed.">                    if ((gunneryMVal &lt; 0)</span>
                            || (gunneryMVal &gt; Crew.MAX_SKILL)) {
<span class="nc" id="L1120">                        warning.append(&quot;Found invalid piloting value: &quot;)</span>
<span class="nc" id="L1121">                                .append(attributes.get(GUNNERYM)).append(&quot;.\n&quot;);</span>
<span class="nc" id="L1122">                        return;</span>
                    }
                }
<span class="nc bnc" id="L1125" title="All 4 branches missed.">                if ((attributes.containsKey(GUNNERYB)) &amp;&amp; (attributes.get(GUNNERYB).length() &gt; 0)) {</span>
                    try {
<span class="nc" id="L1127">                        gunneryBVal = Integer.parseInt(attributes.get(GUNNERYB));</span>
<span class="nc" id="L1128">                    } catch (NumberFormatException ignored) {</span>
                        // Handled by the next if test.
<span class="nc" id="L1130">                    }</span>
<span class="nc bnc" id="L1131" title="All 4 branches missed.">                    if ((gunneryBVal &lt; 0)</span>
                            || (gunneryBVal &gt; Crew.MAX_SKILL)) {
<span class="nc" id="L1133">                        warning.append(&quot;Found invalid piloting value: &quot;)</span>
<span class="nc" id="L1134">                                .append(attributes.get(GUNNERYB)).append(&quot;.\n&quot;);</span>
<span class="nc" id="L1135">                        return;</span>
                    }
                }
            }

<span class="nc bnc" id="L1140" title="All 2 branches missed.">            if (!hasGun) {</span>
<span class="nc" id="L1141">                gunVal = (gunneryLVal + gunneryMVal + gunneryBVal) / 3;</span>
<span class="nc bnc" id="L1142" title="All 2 branches missed.">            } else if (!hasRpgGun) {</span>
<span class="nc" id="L1143">                gunneryLVal = gunVal;</span>
<span class="nc" id="L1144">                gunneryMVal = gunVal;</span>
<span class="nc" id="L1145">                gunneryBVal = gunVal;</span>
            }

            // Try to get a good piloting value.
<span class="nc" id="L1149">            int pilotVal = -1;</span>
            try {
<span class="nc" id="L1151">                pilotVal = Integer.parseInt(attributes.get(PILOTING));</span>
<span class="nc" id="L1152">            } catch (NumberFormatException ignored) {</span>
                // Handled by the next if test.
<span class="nc" id="L1154">            }</span>
<span class="nc bnc" id="L1155" title="All 4 branches missed.">            if ((pilotVal &lt; 0) || (pilotVal &gt; Crew.MAX_SKILL)) {</span>
<span class="nc" id="L1156">                warning.append(&quot;Found invalid piloting value: &quot;)</span>
<span class="nc" id="L1157">                        .append(attributes.get(PILOTING)).append(&quot;.\n&quot;);</span>
<span class="nc" id="L1158">                return;</span>
            }

            // toughness
<span class="nc" id="L1162">            int toughVal = 0;</span>
<span class="nc bnc" id="L1163" title="All 4 branches missed.">            if ((attributes.containsKey(TOUGH)) &amp;&amp; (attributes.get(TOUGH).length() &gt; 0)) {</span>
                try {
<span class="nc" id="L1165">                    toughVal = Integer.parseInt(attributes.get(TOUGH));</span>
<span class="nc" id="L1166">                } catch (NumberFormatException ignored) {</span>
                    // Handled by the next if test.
<span class="nc" id="L1168">                }</span>
            }

<span class="nc" id="L1171">            int artVal = gunVal;</span>
<span class="nc bnc" id="L1172" title="All 4 branches missed.">            if ((attributes.containsKey(ARTILLERY)) &amp;&amp; (attributes.get(ARTILLERY).length() &gt; 0)) {</span>
                try {
<span class="nc" id="L1174">                    artVal = Integer.parseInt(attributes.get(ARTILLERY));</span>
<span class="nc" id="L1175">                } catch (NumberFormatException ignored) {</span>
                    // Handled by the next if test.
<span class="nc" id="L1177">                }</span>
<span class="nc bnc" id="L1178" title="All 4 branches missed.">                if ((artVal &lt; 0) || (artVal &gt; Crew.MAX_SKILL)) {</span>
<span class="nc" id="L1179">                    warning.append(&quot;Found invalid artillery value: &quot;)</span>
<span class="nc" id="L1180">                            .append(attributes.get(ARTILLERY)).append(&quot;.\n&quot;);</span>
<span class="nc" id="L1181">                    return;</span>
                }
            }

<span class="nc" id="L1185">            crew.setGunnery(gunVal, slot);</span>
<span class="nc" id="L1186">            crew.setGunneryL(gunneryLVal, slot);</span>
<span class="nc" id="L1187">            crew.setGunneryM(gunneryMVal, slot);</span>
<span class="nc" id="L1188">            crew.setGunneryB(gunneryBVal, slot);</span>
<span class="nc" id="L1189">            crew.setArtillery(artVal, slot);</span>
<span class="nc" id="L1190">            crew.setPiloting(pilotVal, slot);</span>
<span class="nc" id="L1191">            crew.setToughness(toughVal, slot);</span>

<span class="nc bnc" id="L1193" title="All 4 branches missed.">            if ((attributes.containsKey(NAME)) &amp;&amp; (attributes.get(NAME).length() &gt; 0)) {</span>
<span class="nc" id="L1194">                crew.setName(attributes.get(NAME), slot);</span>
            } else {
<span class="nc" id="L1196">                crew.setName(RandomNameGenerator.UNNAMED_FULL_NAME, slot);</span>
            }

<span class="nc bnc" id="L1199" title="All 4 branches missed.">            if ((attributes.containsKey(NICK)) &amp;&amp; (attributes.get(NICK).length() &gt; 0)) {</span>
<span class="nc" id="L1200">                crew.setNickname(attributes.get(NICK), slot);</span>
            }

<span class="nc bnc" id="L1203" title="All 4 branches missed.">            if ((attributes.containsKey(GENDER)) &amp;&amp; (attributes.get(GENDER).length() &gt; 0)){</span>
<span class="nc" id="L1204">                crew.setGender(Gender.parseFromString(attributes.get(GENDER)), slot);</span>
            }

<span class="nc bnc" id="L1207" title="All 4 branches missed.">            if ((attributes.containsKey(CAT_PORTRAIT)) &amp;&amp; (attributes.get(CAT_PORTRAIT).length() &gt; 0)) {</span>
<span class="nc" id="L1208">                crew.setPortraitCategory(attributes.get(CAT_PORTRAIT), slot);</span>
            }
<span class="nc bnc" id="L1210" title="All 4 branches missed.">            if ((attributes.containsKey(FILE_PORTRAIT)) &amp;&amp; (attributes.get(FILE_PORTRAIT).length() &gt; 0)) {</span>
<span class="nc" id="L1211">                crew.setPortraitFileName(attributes.get(FILE_PORTRAIT), slot);</span>
            }

            // Was the crew wounded?
<span class="nc bnc" id="L1215" title="All 4 branches missed.">            if (attributes.containsKey(HITS) &amp;&amp; attributes.get(HITS).length() &gt; 0) {</span>
                // Try to get a good hits value.
<span class="nc" id="L1217">                int hitVal = -1;</span>
                try {
<span class="nc" id="L1219">                    hitVal = Integer.parseInt(attributes.get(HITS));</span>
<span class="nc" id="L1220">                } catch (NumberFormatException ignored) {</span>
                    // Handled by the next if test.
<span class="nc" id="L1222">                }</span>
<span class="nc bnc" id="L1223" title="All 2 branches missed.">                if (attributes.get(HITS).equals(DEAD)) {</span>
<span class="nc" id="L1224">                    crew.setDead(true, slot);</span>
<span class="nc" id="L1225">                    warning.append(crew.getNameAndRole(slot)).append(&quot; is dead.\n&quot;);</span>
<span class="nc bnc" id="L1226" title="All 4 branches missed.">                } else if ((hitVal &lt; 0) || (hitVal &gt; 5)) {</span>
<span class="nc" id="L1227">                    warning.append(&quot;Found invalid hits value: &quot;)</span>
<span class="nc" id="L1228">                            .append(attributes.get(HITS)).append(&quot;.\n&quot;);</span>
                } else {
<span class="nc" id="L1230">                    crew.setHits(hitVal, slot);</span>
                }

            } // End have-hits

<span class="nc bnc" id="L1235" title="All 4 branches missed.">            if ((attributes.containsKey(EXT_ID)) &amp;&amp; (attributes.get(EXT_ID).length() &gt; 0)) {</span>
<span class="nc" id="L1236">                crew.setExternalIdAsString(attributes.get(EXT_ID), slot);</span>
            }

<span class="nc bnc" id="L1239" title="All 2 branches missed.">            if (attributes.containsKey(EXTRA_DATA)) {</span>
                try {
<span class="nc" id="L1241">                    Map&lt;String, String&gt; extraData = new HashMap&lt;&gt;();</span>
<span class="nc" id="L1242">                    String[] valuePairs = attributes.get(EXTRA_DATA).split(&quot;\\|&quot;);</span>
                    String[] values;
<span class="nc bnc" id="L1244" title="All 2 branches missed.">                    for (String valuePair : valuePairs) {</span>
<span class="nc" id="L1245">                        values = valuePair.split(&quot;=&quot;);</span>
<span class="nc" id="L1246">                        extraData.put(values[0], values[1]);</span>
                    }
<span class="nc" id="L1248">                    crew.setExtraDataForCrewMember(slot, extraData);</span>
<span class="nc" id="L1249">                } catch (Exception e) {</span>
<span class="nc" id="L1250">                    MegaMek.getLogger().error(&quot;Error in loading MUL, issues with extraData elements!&quot;);</span>
<span class="nc" id="L1251">                }</span>
            }
        } // End have-required-fields
<span class="nc" id="L1254">    }</span>

    /**
     * Parse a location tag and update the given &lt;code&gt;Entity&lt;/code&gt; based on
     * the contents.
     *
     * @param locationTag
     * @param entity
     */
    private void parseLocation(Element locationTag, Entity entity) {
        // Look for the element's attributes.
<span class="nc" id="L1265">        String index = locationTag.getAttribute(INDEX);</span>
<span class="nc" id="L1266">        String destroyed = locationTag.getAttribute(IS_DESTROYED);</span>

        int loc;
        // Some units, like tanks and protos, keep track as Ammo slots as N/A
        // Since they don't have slot indices, they are accessed in order so
        // we keep track of the number of ammo slots processed for a loc
<span class="nc" id="L1272">        int locAmmoCount = 0;</span>
        // Did we find required attributes?
<span class="nc bnc" id="L1274" title="All 4 branches missed.">        if ((index == null) || (index.length() == 0)) {</span>
<span class="nc" id="L1275">            warning.append(&quot;Could not find index for location.\n&quot;);</span>
<span class="nc" id="L1276">            return;</span>
        } else {
            // Try to get a good index value.
<span class="nc" id="L1279">            loc = -1;</span>
            try {
<span class="nc" id="L1281">                loc = Integer.parseInt(index);</span>
<span class="nc" id="L1282">            } catch (NumberFormatException excep) {</span>
                // Handled by the next if test.
<span class="nc" id="L1284">            }</span>
<span class="nc bnc" id="L1285" title="All 2 branches missed.">            if (loc &lt; 0) {</span>
<span class="nc" id="L1286">                warning.append(</span>
                        &quot;Found invalid index value for location: &quot;)
<span class="nc" id="L1288">                        .append(index).append(&quot;.\n&quot;);</span>
<span class="nc" id="L1289">                return;</span>
<span class="nc bnc" id="L1290" title="All 2 branches missed.">            } else if (loc &gt;= entity.locations()) {</span>
<span class="nc" id="L1291">                warning.append(&quot;The entity, &quot;)</span>
<span class="nc" id="L1292">                        .append(entity.getShortName())</span>
<span class="nc" id="L1293">                        .append(&quot; does not have a location at index: &quot;)</span>
<span class="nc" id="L1294">                        .append(loc).append(&quot;.\n&quot;);</span>
<span class="nc" id="L1295">                return;</span>
            } else {
                try {
<span class="nc bnc" id="L1298" title="All 2 branches missed.">                    if (Boolean.parseBoolean(destroyed)) {</span>
<span class="nc" id="L1299">                        destroyLocation(entity, loc);</span>
                    }
<span class="nc" id="L1301">                } catch (Throwable excep) {</span>
<span class="nc" id="L1302">                    warning.append(&quot;Found invalid isDestroyed value: &quot;)</span>
<span class="nc" id="L1303">                            .append(destroyed).append(&quot;.\n&quot;);</span>
<span class="nc" id="L1304">                }</span>
            } // End have-valid-index
        } // End have-required-fields

        // Handle children
<span class="nc" id="L1309">        NodeList nl = locationTag.getChildNodes();</span>
<span class="nc bnc" id="L1310" title="All 2 branches missed.">        for (int i = 0; i &lt; nl.getLength(); i++) {</span>
<span class="nc" id="L1311">            Node currNode = nl.item(i);</span>

<span class="nc bnc" id="L1313" title="All 2 branches missed.">            if (currNode.getParentNode() != locationTag) {</span>
<span class="nc" id="L1314">                continue;</span>
            }
<span class="nc" id="L1316">            int nodeType = currNode.getNodeType();</span>
<span class="nc bnc" id="L1317" title="All 2 branches missed.">            if (nodeType == Node.ELEMENT_NODE) {</span>
<span class="nc" id="L1318">                Element currEle = (Element)currNode;</span>
<span class="nc" id="L1319">                String nodeName = currNode.getNodeName();</span>
<span class="nc bnc" id="L1320" title="All 2 branches missed.">                if (nodeName.equalsIgnoreCase(ARMOR)){</span>
<span class="nc" id="L1321">                    parseArmor(currEle, entity, loc);</span>
<span class="nc bnc" id="L1322" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(BREACH)){</span>
<span class="nc" id="L1323">                    breachLocation(entity, loc);</span>
<span class="nc bnc" id="L1324" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(BLOWN_OFF)){</span>
<span class="nc" id="L1325">                    blowOffLocation(entity, loc);</span>
<span class="nc bnc" id="L1326" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(SLOT)){</span>
<span class="nc" id="L1327">                    locAmmoCount = parseSlot(currEle, entity, loc, locAmmoCount);</span>
<span class="nc bnc" id="L1328" title="All 2 branches missed.">                } else if (nodeName.equalsIgnoreCase(STABILIZER)){</span>
<span class="nc" id="L1329">                    String hit = currEle.getAttribute(IS_HIT);</span>
<span class="nc bnc" id="L1330" title="All 2 branches missed.">                    if (!hit.equals(&quot;&quot;)) {</span>
<span class="nc" id="L1331">                        ((Tank) entity).setStabiliserHit(loc);</span>
                    }
                }
            }
        }
<span class="nc" id="L1336">    }</span>

    /**
     * Parse an armor tag for the given Entity and location.
     *
     * @param armorTag
     * @param entity
     * @param loc
     */
    private void parseArmor(Element armorTag, Entity entity, int loc){
     // Look for the element's attributes.
<span class="nc" id="L1347">        String points = armorTag.getAttribute(POINTS);</span>
<span class="nc" id="L1348">        String type = armorTag.getAttribute(TYPE);</span>

        // Did we find required attributes?
<span class="nc bnc" id="L1351" title="All 4 branches missed.">        if ((points == null) || (points.length() == 0)) {</span>
<span class="nc" id="L1352">            warning.append(&quot;Could not find points for armor.\n&quot;);</span>
        } else {

            // Try to get a good points value.
<span class="nc" id="L1356">            int pointsVal = -1;</span>
            try {
<span class="nc" id="L1358">                pointsVal = Integer.parseInt(points);</span>
<span class="nc" id="L1359">            } catch (NumberFormatException excep) {</span>
                // Handled by the next if test.
<span class="nc" id="L1361">            }</span>
<span class="nc bnc" id="L1362" title="All 2 branches missed.">            if (points.equals(NA)) {</span>
<span class="nc" id="L1363">                pointsVal = IArmorState.ARMOR_NA;</span>
<span class="nc bnc" id="L1364" title="All 2 branches missed.">            } else if (points.equals(DESTROYED)) {</span>
<span class="nc" id="L1365">                pointsVal = IArmorState.ARMOR_DESTROYED;</span>
<span class="nc bnc" id="L1366" title="All 4 branches missed.">            } else if ((pointsVal &lt; 0) || (pointsVal &gt; 2000)) {</span>
<span class="nc" id="L1367">                warning.append(&quot;Found invalid points value: &quot;)</span>
<span class="nc" id="L1368">                        .append(points).append(&quot;.\n&quot;);</span>
<span class="nc" id="L1369">                return;</span>
            }

            // Assign the points to the correct location.
            // Sanity check the armor value before setting it.
<span class="nc bnc" id="L1374" title="All 4 branches missed.">            if ((type.length() == 0) || type.equals(FRONT)) {</span>
<span class="nc bnc" id="L1375" title="All 2 branches missed.">                if (entity.getOArmor(loc) &lt; pointsVal) {</span>
<span class="nc" id="L1376">                    warning.append(&quot;The entity, &quot;)</span>
<span class="nc" id="L1377">                            .append(entity.getShortName())</span>
<span class="nc" id="L1378">                            .append(&quot; does not start with &quot;)</span>
<span class="nc" id="L1379">                            .append(pointsVal)</span>
<span class="nc" id="L1380">                            .append(&quot; points of armor for location: &quot;)</span>
<span class="nc" id="L1381">                            .append(loc).append(&quot;.\n&quot;);</span>
                } else {
<span class="nc" id="L1383">                    entity.setArmor(pointsVal, loc);</span>
                }
<span class="nc bnc" id="L1385" title="All 2 branches missed.">            } else if (type.equals(INTERNAL)) {</span>
<span class="nc bnc" id="L1386" title="All 2 branches missed.">                if (entity.getOInternal(loc) &lt; pointsVal) {</span>
<span class="nc" id="L1387">                    warning.append(&quot;The entity, &quot;)</span>
<span class="nc" id="L1388">                            .append(entity.getShortName())</span>
<span class="nc" id="L1389">                            .append(&quot; does not start with &quot;)</span>
<span class="nc" id="L1390">                            .append(pointsVal)</span>
<span class="nc" id="L1391">                            .append(&quot; points of internal structure for &quot; +</span>
                                    &quot;location: &quot;)
<span class="nc" id="L1393">                            .append(loc).append(&quot;.\n&quot;);</span>
                } else {
<span class="nc" id="L1395">                    entity.setInternal(pointsVal, loc);</span>
                }
<span class="nc bnc" id="L1397" title="All 2 branches missed.">            } else if (type.equals(REAR)) {</span>
<span class="nc bnc" id="L1398" title="All 2 branches missed.">                if (!entity.hasRearArmor(loc)) {</span>
<span class="nc" id="L1399">                    warning.append(&quot;The entity, &quot;)</span>
<span class="nc" id="L1400">                            .append(entity.getShortName())</span>
<span class="nc" id="L1401">                            .append(&quot; has no rear armor for location: &quot;)</span>
<span class="nc" id="L1402">                            .append(loc).append(&quot;.\n&quot;);</span>
<span class="nc bnc" id="L1403" title="All 2 branches missed.">                } else if (entity.getOArmor(loc, true) &lt; pointsVal) {</span>
<span class="nc" id="L1404">                    warning.append(&quot;The entity, &quot;)</span>
<span class="nc" id="L1405">                            .append(entity.getShortName())</span>
<span class="nc" id="L1406">                            .append(&quot; does not start with &quot;)</span>
<span class="nc" id="L1407">                            .append(pointsVal)</span>
<span class="nc" id="L1408">                            .append(&quot; points of rear armor for location: &quot;)</span>
<span class="nc" id="L1409">                            .append(loc).append(&quot;.\n&quot;);</span>
                } else {
<span class="nc" id="L1411">                    entity.setArmor(pointsVal, loc, true);</span>
                }
            }
        }
<span class="nc" id="L1415">    }</span>

    /**
     * Parse a slot tag for the given Entity and location.
     *
     * @param slotTag
     * @param entity
     * @param loc
     */
    private int parseSlot(Element slotTag, Entity entity, int loc,
            int locAmmoCount) {
        // Look for the element's attributes.
<span class="nc" id="L1427">        String index = slotTag.getAttribute(INDEX);</span>
<span class="nc" id="L1428">        String type = slotTag.getAttribute(TYPE);</span>
        // String rear = slotTag.getAttribute( IS_REAR ); // is never read.
<span class="nc" id="L1430">        String shots = slotTag.getAttribute(SHOTS);</span>
<span class="nc" id="L1431">        String capacity = slotTag.getAttribute(CAPACITY);</span>
<span class="nc" id="L1432">        String hit = slotTag.getAttribute(IS_HIT);</span>
<span class="nc" id="L1433">        String destroyed = slotTag.getAttribute(IS_DESTROYED);</span>
<span class="nc bnc" id="L1434" title="All 2 branches missed.">        String repairable = (slotTag.getAttribute(IS_REPAIRABLE).equals(&quot;&quot;) ? &quot;true&quot; : slotTag.getAttribute(IS_REPAIRABLE));</span>
<span class="nc" id="L1435">        String munition = slotTag.getAttribute(MUNITION);</span>
<span class="nc" id="L1436">        String standard = slotTag.getAttribute(STANDARD);</span>
<span class="nc" id="L1437">        String inferno = slotTag.getAttribute(INFERNO);</span>
<span class="nc" id="L1438">        String quirks = slotTag.getAttribute(QUIRKS);</span>
<span class="nc" id="L1439">        String trooperMiss = slotTag.getAttribute(TROOPER_MISS);</span>
<span class="nc" id="L1440">        String rfmg = slotTag.getAttribute(RFMG);</span>
<span class="nc" id="L1441">        String bayIndex = slotTag.getAttribute(WEAPONS_BAY_INDEX);</span>

        // Did we find required attributes?
<span class="nc bnc" id="L1444" title="All 4 branches missed.">        if ((index == null) || (index.length() == 0)) {</span>
<span class="nc" id="L1445">            warning.append(&quot;Could not find index for slot.\n&quot;);</span>
<span class="nc" id="L1446">            return locAmmoCount;</span>
<span class="nc bnc" id="L1447" title="All 4 branches missed.">        } else if ((type == null) || (type.length() == 0)) {</span>
<span class="nc" id="L1448">            warning.append(&quot;Could not find type for slot.\n&quot;);</span>
<span class="nc" id="L1449">            return locAmmoCount;</span>
        } else {
            // Try to get a good index value.
            // Remember, slot index starts at 1.
<span class="nc" id="L1453">            int indexVal = -1;</span>
            try {
<span class="nc" id="L1455">                indexVal = Integer.parseInt(index);</span>
<span class="nc" id="L1456">                indexVal -= 1;</span>
<span class="nc" id="L1457">            } catch (NumberFormatException excep) {</span>
                // Handled by the next if test.
<span class="nc" id="L1459">            }</span>
<span class="nc bnc" id="L1460" title="All 2 branches missed.">            if (index.equals(NA)) {</span>
<span class="nc" id="L1461">                indexVal = IArmorState.ARMOR_NA;</span>

                // Protomechs only have system slots,
                // so we have to handle the ammo specially.
<span class="nc bnc" id="L1465" title="All 4 branches missed.">                if (entity instanceof Protomech || entity instanceof GunEmplacement) {</span>
                    // Get the saved ammo load.
<span class="nc" id="L1467">                    EquipmentType newLoad = EquipmentType.get(type);</span>
<span class="nc bnc" id="L1468" title="All 2 branches missed.">                    if (newLoad instanceof AmmoType) {</span>
<span class="nc" id="L1469">                        int counter = -1;</span>
<span class="nc" id="L1470">                        Iterator&lt;Mounted&gt; ammo = entity.getAmmo()</span>
<span class="nc" id="L1471">                                .iterator();</span>
<span class="nc bnc" id="L1472" title="All 4 branches missed.">                        while (ammo.hasNext()</span>
                                &amp;&amp; (counter &lt; locAmmoCount)) {

                            // Is this mounted in the current location?
<span class="nc" id="L1476">                            Mounted mounted = ammo.next();</span>
<span class="nc bnc" id="L1477" title="All 2 branches missed.">                            if (mounted.getLocation() == loc) {</span>

                                // Increment the loop counter.
<span class="nc" id="L1480">                                counter++;</span>

                                // Is this the one we want to handle?
<span class="nc bnc" id="L1483" title="All 2 branches missed.">                                if (counter == locAmmoCount) {</span>

                                    // Increment the counter of ammo
                                    // handled for this location.
<span class="nc" id="L1487">                                    locAmmoCount++;</span>

                                    // Reset transient values.
<span class="nc" id="L1490">                                    mounted.restore();</span>

                                    // Try to get a good shots value.
<span class="nc" id="L1493">                                    int shotsVal = -1;</span>
                                    try {
<span class="nc" id="L1495">                                        shotsVal = Integer</span>
<span class="nc" id="L1496">                                                .parseInt(shots);</span>
<span class="nc" id="L1497">                                    } catch (NumberFormatException excep) {</span>
                                        // Handled by the next if test.
<span class="nc" id="L1499">                                    }</span>
<span class="nc bnc" id="L1500" title="All 2 branches missed.">                                    if (shots.equals(NA)) {</span>
<span class="nc" id="L1501">                                        shotsVal = IArmorState.ARMOR_NA;</span>
<span class="nc" id="L1502">                                        warning.append(</span>
                                                &quot;Expected to find number of &quot; +
                                                &quot;shots for &quot;)
<span class="nc" id="L1505">                                                .append(type)</span>
<span class="nc" id="L1506">                                                .append(&quot;, but found &quot;)</span>
<span class="nc" id="L1507">                                                .append(shots)</span>
<span class="nc" id="L1508">                                                .append(&quot; instead.\n&quot;);</span>
<span class="nc bnc" id="L1509" title="All 4 branches missed.">                                    } else if ((shotsVal &lt; 0)</span>
                                            || (shotsVal &gt; 200)) {
<span class="nc" id="L1511">                                        warning.append(</span>
                                                &quot;Found invalid shots value &quot; +
                                                &quot;for slot: &quot;)
<span class="nc" id="L1514">                                                .append(shots)</span>
<span class="nc" id="L1515">                                                .append(&quot;.\n&quot;);</span>
                                    } else {

                                        // Change to the saved
                                        // ammo type and shots.
<span class="nc" id="L1520">                                        mounted.changeAmmoType((AmmoType)</span>
                                                newLoad);
<span class="nc" id="L1522">                                        mounted.setShotsLeft(shotsVal);</span>

                                    } // End have-good-shots-value

                                    // Stop looking for a match.
<span class="nc" id="L1527">                                    break;</span>

                                } // End found-match-for-slot

                            } // End ammo-in-this-loc

<span class="nc" id="L1533">                        } // Check the next ammo.</span>

<span class="nc" id="L1535">                    } else {</span>
                        // Bad XML equipment.
<span class="nc" id="L1537">                        warning.append(&quot;XML file lists &quot;)</span>
<span class="nc" id="L1538">                                .append(type)</span>
<span class="nc" id="L1539">                                .append(&quot; equipment at location &quot;)</span>
<span class="nc" id="L1540">                                .append(loc)</span>
<span class="nc" id="L1541">                                .append(&quot;.  XML parser expected ammo.\n&quot;);</span>
                    } // End not-ammo-type

                } // End is-tank

                // TODO: handle slotless equipment.
<span class="nc" id="L1547">                return locAmmoCount;</span>
<span class="nc bnc" id="L1548" title="All 2 branches missed.">            } else if ((indexVal &lt; 0)) {</span>
<span class="nc" id="L1549">                warning.append(&quot;Found invalid index value for slot: &quot;)</span>
<span class="nc" id="L1550">                        .append(index).append(&quot;.\n&quot;);</span>
<span class="nc" id="L1551">                return locAmmoCount;</span>
            }

            // Is this index valid for this entity?
<span class="nc bnc" id="L1555" title="All 2 branches missed.">            if (indexVal &gt; entity.getNumberOfCriticals(loc)) {</span>
<span class="nc" id="L1556">                warning.append(&quot;The entity, &quot;)</span>
<span class="nc" id="L1557">                        .append(entity.getShortName())</span>
<span class="nc" id="L1558">                        .append(&quot; does not have &quot;).append(index)</span>
<span class="nc" id="L1559">                        .append(&quot; slots in location &quot;).append(loc)</span>
<span class="nc" id="L1560">                        .append(&quot;.\n&quot;);</span>
<span class="nc" id="L1561">                return locAmmoCount;</span>
            }

            // Try to get a good isHit value.
<span class="nc" id="L1565">            boolean hitFlag = Boolean.parseBoolean(hit);</span>

            // Is the location destroyed?
<span class="nc" id="L1568">            boolean destFlag = Boolean.parseBoolean(destroyed);</span>

            // Is the location repairable?
<span class="nc" id="L1571">            boolean repairFlag = Boolean.parseBoolean(repairable);</span>

            // Try to get the critical slot.
<span class="nc" id="L1574">            CriticalSlot slot = entity.getCritical(loc, indexVal);</span>

            // If we couldn't find a critical slot,
            // it's possible that this is &quot;extra&quot; ammo in a weapons bay, so we may attempt
            // to shove it in there
<span class="nc bnc" id="L1579" title="All 2 branches missed.">            if (slot == null) {</span>
<span class="nc bnc" id="L1580" title="All 4 branches missed.">                if((entity.usesWeaponBays() </span>
                        || entity instanceof Dropship) 
<span class="nc bnc" id="L1582" title="All 2 branches missed.">                        &amp;&amp; !bayIndex.isEmpty()) {</span>
<span class="nc" id="L1583">                    addExtraAmmoToBay(entity, loc, type, bayIndex);</span>
<span class="nc" id="L1584">                    slot = entity.getCritical(loc, indexVal);</span>
                }
            }

<span class="nc bnc" id="L1588" title="All 2 branches missed.">            if (slot == null) {</span>
<span class="nc bnc" id="L1589" title="All 2 branches missed.">                if (!type.equals(EMPTY)) {</span>
<span class="nc" id="L1590">                    warning.append(&quot;Could not find the &quot;)</span>
<span class="nc" id="L1591">                            .append(type)</span>
<span class="nc" id="L1592">                            .append(&quot; equipment that was expected at index &quot;)</span>
<span class="nc" id="L1593">                            .append(indexVal).append(&quot; of location &quot;)</span>
<span class="nc" id="L1594">                            .append(loc).append(&quot;.\n&quot;);</span>
                }
<span class="nc" id="L1596">                return locAmmoCount;</span>
            }

            // Is the slot for a critical system?
<span class="nc bnc" id="L1600" title="All 2 branches missed.">            if (slot.getType() == CriticalSlot.TYPE_SYSTEM) {</span>

                // Does the XML file have some other kind of equipment?
<span class="nc bnc" id="L1603" title="All 2 branches missed.">                if (!type.equals(SYSTEM)) {</span>
<span class="nc" id="L1604">                    warning.append(&quot;XML file expects to find &quot;)</span>
<span class="nc" id="L1605">                            .append(type)</span>
<span class="nc" id="L1606">                            .append(&quot; equipment at index &quot;)</span>
<span class="nc" id="L1607">                            .append(indexVal).append(&quot; of location &quot;)</span>
<span class="nc" id="L1608">                            .append(loc)</span>
<span class="nc" id="L1609">                            .append(&quot;, but Entity has a system.\n&quot;);</span>
                }

            } else {

                // Nope, we've got equipment. Get this slot's mounted.
<span class="nc" id="L1615">                Mounted mounted = slot.getMount();</span>

                // Reset transient values.
<span class="nc" id="L1618">                mounted.restore();</span>

                // quirks
<span class="nc bnc" id="L1621" title="All 4 branches missed.">                if ((null != quirks) &amp;&amp; (quirks.trim().length() &gt; 0)) {</span>
<span class="nc" id="L1622">                    StringTokenizer st = new StringTokenizer(quirks,</span>
                            &quot;::&quot;);
<span class="nc bnc" id="L1624" title="All 2 branches missed.">                    while (st.hasMoreTokens()) {</span>
<span class="nc" id="L1625">                        String quirk = st.nextToken();</span>
<span class="nc" id="L1626">                        String quirkName = Crew</span>
<span class="nc" id="L1627">                                .parseAdvantageName(quirk);</span>
<span class="nc" id="L1628">                        Object value = Crew.parseAdvantageValue(quirk);</span>

                        try {
<span class="nc" id="L1631">                            mounted.getQuirks().getOption(quirkName)</span>
<span class="nc" id="L1632">                                    .setValue(value);</span>
<span class="nc" id="L1633">                        } catch (Exception e) {</span>
<span class="nc" id="L1634">                            warning.append(&quot;Error restoring quirk: &quot;)</span>
<span class="nc" id="L1635">                                    .append(quirk).append(&quot;.\n&quot;);</span>
<span class="nc" id="L1636">                        }</span>
<span class="nc" id="L1637">                    }</span>
                }

                // trooper missing equipment
<span class="nc bnc" id="L1641" title="All 4 branches missed.">                if ((null != trooperMiss) &amp;&amp; (trooperMiss.trim().length() &gt; 0)) {</span>
<span class="nc" id="L1642">                    StringTokenizer st = new StringTokenizer(trooperMiss,</span>
                            &quot;::&quot;);
<span class="nc" id="L1644">                    int i = BattleArmor.LOC_TROOPER_1;</span>
<span class="nc bnc" id="L1645" title="All 4 branches missed.">                    while (st.hasMoreTokens() &amp;&amp; i &lt;= BattleArmor.LOC_TROOPER_6) {</span>
<span class="nc" id="L1646">                        String tmiss = st.nextToken();</span>
<span class="nc" id="L1647">                        mounted.setMissingForTrooper(i, Boolean.parseBoolean(tmiss));</span>
<span class="nc" id="L1648">                        i++;</span>
<span class="nc" id="L1649">                    }</span>
                }

                // Hit and destroy the mounted, according to the flags.
<span class="nc bnc" id="L1653" title="All 4 branches missed.">                mounted.setDestroyed(hitFlag || destFlag);</span>

<span class="nc" id="L1655">                mounted.setRepairable(repairFlag);</span>

<span class="nc" id="L1657">                mounted.setRapidfire(Boolean.parseBoolean(rfmg));</span>

                // Is the mounted a type of ammo?
<span class="nc bnc" id="L1660" title="All 2 branches missed.">                if (mounted.getType() instanceof AmmoType) {</span>

                    // Get the saved ammo load.
<span class="nc" id="L1663">                    EquipmentType newLoad = EquipmentType.get(type);</span>
<span class="nc bnc" id="L1664" title="All 2 branches missed.">                    if (newLoad instanceof AmmoType) {</span>

                        // Try to get a good shots value.
<span class="nc" id="L1667">                        int shotsVal = -1;</span>
                        try {
<span class="nc" id="L1669">                            shotsVal = Integer.parseInt(shots);</span>
<span class="nc" id="L1670">                        } catch (NumberFormatException excep) {</span>
                            // Handled by the next if test.
<span class="nc" id="L1672">                        }</span>
<span class="nc bnc" id="L1673" title="All 2 branches missed.">                        if (shots.equals(NA)) {</span>
<span class="nc" id="L1674">                            shotsVal = IArmorState.ARMOR_NA;</span>
<span class="nc" id="L1675">                            warning.append(</span>
                                    &quot;Expected to find number of shots for &quot;)
<span class="nc" id="L1677">                                    .append(type)</span>
<span class="nc" id="L1678">                                    .append(&quot;, but found &quot;)</span>
<span class="nc" id="L1679">                                    .append(shots)</span>
<span class="nc" id="L1680">                                    .append(&quot; instead.\n&quot;);</span>
<span class="nc bnc" id="L1681" title="All 4 branches missed.">                        } else if ((shotsVal &lt; 0) || (shotsVal &gt; 200)) {</span>
<span class="nc" id="L1682">                            warning.append(</span>
                                    &quot;Found invalid shots value for slot: &quot;)
<span class="nc" id="L1684">                                    .append(shots).append(&quot;.\n&quot;);</span>
                        } else {

                            // Change to the saved ammo type and shots.
<span class="nc" id="L1688">                            mounted.changeAmmoType((AmmoType) newLoad);</span>
<span class="nc" id="L1689">                            mounted.setShotsLeft(shotsVal);</span>

                        } // End have-good-shots-value
                        try {
<span class="nc" id="L1693">                            double capVal = Double.parseDouble(capacity);</span>
<span class="nc" id="L1694">                            mounted.setAmmoCapacity(capVal);</span>
<span class="nc" id="L1695">                        } catch (NumberFormatException excep) {</span>
                            // Handled by the next if test.
<span class="nc" id="L1697">                        }</span>
<span class="nc bnc" id="L1698" title="All 2 branches missed.">                        if (capacity.equals(NA)) {</span>
<span class="nc bnc" id="L1699" title="All 2 branches missed.">                            if (entity.hasETypeFlag(Entity.ETYPE_BATTLEARMOR)</span>
<span class="nc bnc" id="L1700" title="All 2 branches missed.">                                    || entity.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</span>
<span class="nc" id="L1701">                                mounted.setAmmoCapacity(mounted.getOriginalShots()</span>
<span class="nc" id="L1702">                                         * ((AmmoType) mounted.getType()).getKgPerShot() * 1000);</span>
                            } else {
<span class="nc" id="L1704">                                mounted.setAmmoCapacity(mounted.getOriginalShots()</span>
<span class="nc" id="L1705">                                        * mounted.getTonnage()</span>
<span class="nc" id="L1706">                                        / ((AmmoType) mounted.getType()).getShots());</span>
                            }
                        }


<span class="nc" id="L1711">                    } else {</span>
                        // Bad XML equipment.
<span class="nc" id="L1713">                        warning.append(&quot;XML file expects &quot;)</span>
<span class="nc" id="L1714">                                .append(type)</span>
<span class="nc" id="L1715">                                .append(&quot; equipment at index &quot;)</span>
<span class="nc" id="L1716">                                .append(indexVal)</span>
<span class="nc" id="L1717">                                .append(&quot; of location &quot;)</span>
<span class="nc" id="L1718">                                .append(loc)</span>
<span class="nc" id="L1719">                                .append(&quot;, but Entity has &quot;)</span>
<span class="nc" id="L1720">                                .append(mounted.getType()</span>
<span class="nc" id="L1721">                                        .getInternalName())</span>
<span class="nc" id="L1722">                                .append(&quot;there .\n&quot;);</span>
                    }

<span class="nc" id="L1725">                } // End slot-for-ammo</span>

                // Not an ammo slot... does file agree with template?
<span class="nc" id="L1728">                else if (!mounted.getType().getInternalName()</span>
<span class="nc bnc" id="L1729" title="All 2 branches missed.">                        .equals(type)) {</span>
                    // Bad XML equipment.
<span class="nc" id="L1731">                    warning.append(&quot;XML file expects &quot;)</span>
<span class="nc" id="L1732">                            .append(type)</span>
<span class="nc" id="L1733">                            .append(&quot; equipment at index &quot;)</span>
<span class="nc" id="L1734">                            .append(indexVal)</span>
<span class="nc" id="L1735">                            .append(&quot; of location &quot;)</span>
<span class="nc" id="L1736">                            .append(loc)</span>
<span class="nc" id="L1737">                            .append(&quot;, but Entity has &quot;)</span>
<span class="nc" id="L1738">                            .append(mounted.getType().getInternalName())</span>
<span class="nc" id="L1739">                            .append(&quot;there .\n&quot;);</span>
                }

                // Check for munition attribute.
<span class="nc bnc" id="L1743" title="All 2 branches missed.">                if (munition.length() &gt; 0) {</span>
                    // Retrieve munition by name.
<span class="nc" id="L1745">                    EquipmentType munType = EquipmentType.get(munition);</span>

                    // Make sure munition is a type of ammo.
<span class="nc bnc" id="L1748" title="All 2 branches missed.">                    if (munType instanceof AmmoType) {</span>
                        // Change to the saved munition type.
<span class="nc" id="L1750">                        mounted.getLinked().changeAmmoType(</span>
                                (AmmoType) munType);
                    } else {
                        // Bad XML equipment.
<span class="nc" id="L1754">                        warning.append(&quot;XML file expects&quot;)</span>
<span class="nc" id="L1755">                                .append(&quot; ammo for munition argument of&quot;)</span>
<span class="nc" id="L1756">                                .append(&quot; slot tag.\n&quot;);</span>
                    }
                }
<span class="nc bnc" id="L1759" title="All 4 branches missed.">                if (entity.isSupportVehicle() &amp;&amp; (mounted.getType() instanceof InfantryWeapon)) {</span>
<span class="nc" id="L1760">                    int clipSize = ((InfantryWeapon) mounted.getType()).getShots();</span>
<span class="nc bnc" id="L1761" title="All 2 branches missed.">                    for (Mounted ammo = mounted.getLinked(); ammo != null; ammo = ammo.getLinked()) {</span>
<span class="nc bnc" id="L1762" title="All 2 branches missed.">                        if (((AmmoType) ammo.getType()).getMunitionType() == AmmoType.M_INFERNO) {</span>
<span class="nc bnc" id="L1763" title="All 2 branches missed.">                            if (!inferno.isEmpty()) {</span>
<span class="nc" id="L1764">                                String[] fields = inferno.split(&quot;:&quot;);</span>
<span class="nc" id="L1765">                                ammo.setShotsLeft(Integer.parseInt(fields[0]));</span>
<span class="nc" id="L1766">                                ammo.setOriginalShots(Integer.parseInt(fields[1]));</span>
<span class="nc" id="L1767">                            }</span>
                        } else {
<span class="nc bnc" id="L1769" title="All 2 branches missed.">                            if (!standard.isEmpty()) {</span>
<span class="nc" id="L1770">                                String[] fields = standard.split(&quot;:&quot;);</span>
<span class="nc" id="L1771">                                ammo.setShotsLeft(Integer.parseInt(fields[0]));</span>
<span class="nc" id="L1772">                                ammo.setOriginalShots(Integer.parseInt(fields[1]));</span>
                            }
                        }
                    }
                }

            } // End have-equipment

            // Hit and destroy the slot, according to the flags.
<span class="nc" id="L1781">            slot.setHit(hitFlag);</span>
<span class="nc" id="L1782">            slot.setDestroyed(destFlag);</span>
<span class="nc" id="L1783">            slot.setRepairable(repairFlag);</span>

        } // End have-required-fields
<span class="nc" id="L1786">        return locAmmoCount;</span>
    }

    /**
     * Parse a movement tag for the given &lt;code&gt;Entity&lt;/code&gt;.
     *
     * @param movementTag
     * @param entity
     */
    private void parseMovement(Element movementTag, Entity entity){
<span class="nc" id="L1796">        String value = movementTag.getAttribute(MDAMAGE);</span>
        try {
<span class="nc" id="L1798">            int motiveDamage = Integer.parseInt(value);</span>
<span class="nc" id="L1799">            ((Tank) entity).setMotiveDamage(motiveDamage);</span>
<span class="nc bnc" id="L1800" title="All 2 branches missed.">            if (motiveDamage &gt;= ((Tank) entity).getOriginalWalkMP()) {</span>
<span class="nc" id="L1801">                ((Tank) entity).immobilize();</span>
<span class="nc" id="L1802">                ((Tank) entity).applyDamage();</span>
            }
<span class="nc" id="L1804">        } catch (Exception e) {</span>
<span class="nc" id="L1805">            warning.append(&quot;Invalid motive damage value in movement tag.\n&quot;);</span>
<span class="nc" id="L1806">        }</span>
<span class="nc" id="L1807">        value = movementTag.getAttribute(MPENALTY);</span>
        try {
<span class="nc" id="L1809">            int motivePenalty = Integer.parseInt(value);</span>
<span class="nc" id="L1810">            ((Tank) entity).setMotivePenalty(motivePenalty);</span>
<span class="nc" id="L1811">        } catch (Exception e) {</span>
<span class="nc" id="L1812">            warning.append(&quot;Invalid motive penalty value in movement tag.\n&quot;);</span>
<span class="nc" id="L1813">        }</span>
<span class="nc" id="L1814">    }</span>

    /**
     * Parse a turretlock tag for the given &lt;code&gt;Entity&lt;/code&gt;.
     *
     * @param turretLockTag
     * @param entity
     */
    private void parseTurretLock(Element turretLockTag, Entity entity){
<span class="nc" id="L1823">        String value = turretLockTag.getAttribute(DIRECTION);</span>
        try {
<span class="nc" id="L1825">            int turDir = Integer.parseInt(value);</span>
<span class="nc" id="L1826">            ((Tank) entity).setSecondaryFacing(turDir);</span>
<span class="nc" id="L1827">            ((Tank) entity).lockTurret(((Tank)entity).getLocTurret());</span>
<span class="nc" id="L1828">        } catch (Exception e) {</span>
<span class="nc" id="L1829">            System.err.println(e);</span>
<span class="nc" id="L1830">            e.printStackTrace();</span>
<span class="nc" id="L1831">            warning.append(&quot;Invalid turret lock direction value in &quot; +</span>
                    &quot;movement tag.\n&quot;);
<span class="nc" id="L1833">        }</span>
<span class="nc" id="L1834">    }</span>

    /**
     * Parse a turret2lock tag for the given &lt;code&gt;Entity&lt;/code&gt;.
     *
     * @param turret2LockTag
     * @param entity
     */
    private void parseTurret2Lock(Element turret2LockTag, Entity entity){
<span class="nc" id="L1843">        String value = turret2LockTag.getAttribute(DIRECTION);</span>
        try {
<span class="nc" id="L1845">            int turDir = Integer.parseInt(value);</span>
<span class="nc" id="L1846">            ((Tank) entity).setDualTurretOffset(turDir);</span>
<span class="nc" id="L1847">            ((Tank) entity).lockTurret(((Tank)entity).getLocTurret2());</span>
<span class="nc" id="L1848">        } catch (Exception e) {</span>
<span class="nc" id="L1849">            System.err.println(e);</span>
<span class="nc" id="L1850">            e.printStackTrace();</span>
<span class="nc" id="L1851">            warning.append(&quot;Invalid turret2 lock direction value in &quot; +</span>
                    &quot;movement tag.\n&quot;);
<span class="nc" id="L1853">        }</span>
<span class="nc" id="L1854">    }</span>

    /**
     * Parse a si tag for the given &lt;code&gt;Entity&lt;/code&gt;.
     *
     * @param siTag
     * @param entity
     */
    private void parseSI(Element siTag, Entity entity){
<span class="nc" id="L1863">        String value = siTag.getAttribute(INTEGRITY);</span>
        try {
<span class="nc" id="L1865">            int newSI = Integer.parseInt(value);</span>
<span class="nc" id="L1866">            ((Aero) entity).setSI(newSI);</span>
<span class="nc" id="L1867">        } catch (Exception e) {</span>
<span class="nc" id="L1868">            warning.append(&quot;Invalid SI value in structural integrity tag.\n&quot;);</span>
<span class="nc" id="L1869">        }</span>
<span class="nc" id="L1870">    }</span>

    /**
     * Parse a heat tag for the given &lt;code&gt;Entity&lt;/code&gt;.
     *
     * @param heatTag
     * @param entity
     */
    private void parseHeat(Element heatTag, Entity entity){
<span class="nc" id="L1879">        String value = heatTag.getAttribute(SINK);</span>
        try {
<span class="nc" id="L1881">            int newSinks = Integer.parseInt(value);</span>
<span class="nc" id="L1882">            ((Aero) entity).setHeatSinks(newSinks);</span>
<span class="nc" id="L1883">        } catch (Exception e) {</span>
<span class="nc" id="L1884">            warning.append(&quot;Invalid heat sink value in heat sink tag.\n&quot;);</span>
<span class="nc" id="L1885">        }</span>
<span class="nc" id="L1886">    }</span>

    /**
     * Parse a fuel tag for the given &lt;code&gt;Entity&lt;/code&gt;.
     *
     * @param fuelTag
     * @param entity
     */
    private void parseFuel(Element fuelTag, Entity entity){
<span class="nc" id="L1895">        String value = fuelTag.getAttribute(LEFT);</span>
        try {
<span class="nc" id="L1897">            int newFuel = Integer.parseInt(value);</span>
<span class="nc" id="L1898">            ((IAero) entity).setFuel(newFuel);</span>
<span class="nc" id="L1899">        } catch (Exception e) {</span>
<span class="nc" id="L1900">            warning.append(&quot;Invalid fuel value in fuel tag.\n&quot;);</span>
<span class="nc" id="L1901">        }</span>
<span class="nc" id="L1902">    }</span>

    /**
     * Parse a kf tag for the given &lt;code&gt;Entity&lt;/code&gt;.
     *
     * @param kfTag
     * @param entity
     */
    private void parseKF(Element kfTag, Entity entity){
<span class="nc" id="L1911">        String value = kfTag.getAttribute(INTEGRITY);</span>
        try {
<span class="nc" id="L1913">            int newIntegrity = Integer.parseInt(value);</span>
<span class="nc" id="L1914">            ((Jumpship) entity).setKFIntegrity(newIntegrity);</span>
<span class="nc" id="L1915">        } catch (Exception e) {</span>
<span class="nc" id="L1916">            warning.append(&quot;Invalid KF integrity value in KF integrity tag.\n&quot;);</span>
<span class="nc" id="L1917">        }</span>
<span class="nc" id="L1918">    }</span>

    /**
     * Parse a sail tag for the given &lt;code&gt;Entity&lt;/code&gt;.
     *
     * @param sailTag
     * @param entity
     */
    private void parseSail(Element sailTag, Entity entity){
<span class="nc" id="L1927">        String value = sailTag.getAttribute(INTEGRITY);</span>
        try {
<span class="nc" id="L1929">            int newIntegrity = Integer.parseInt(value);</span>
<span class="nc" id="L1930">            ((Jumpship) entity).setSailIntegrity(newIntegrity);</span>
<span class="nc" id="L1931">        } catch (Exception e) {</span>
<span class="nc" id="L1932">            warning.append(&quot;Invalid sail integrity value in sail &quot; +</span>
                    &quot;integrity tag.\n&quot;);
<span class="nc" id="L1934">        }</span>
<span class="nc" id="L1935">    }</span>

    /**
     * Parse an aeroCrit tag for the given &lt;code&gt;Entity&lt;/code&gt;.
     *
     * @param aeroCritTag
     * @param entity
     */
    private void parseAeroCrit(Element aeroCritTag, Entity entity){
<span class="nc" id="L1944">        String avionics = aeroCritTag.getAttribute(AVIONICS);</span>
<span class="nc" id="L1945">        String sensors = aeroCritTag.getAttribute(SENSORS);</span>
<span class="nc" id="L1946">        String engine = aeroCritTag.getAttribute(ENGINE);</span>
<span class="nc" id="L1947">        String fcs = aeroCritTag.getAttribute(FCS);</span>
<span class="nc" id="L1948">        String cic = aeroCritTag.getAttribute(CIC);</span>
<span class="nc" id="L1949">        String leftThrust = aeroCritTag.getAttribute(LEFT_THRUST);</span>
<span class="nc" id="L1950">        String rightThrust = aeroCritTag.getAttribute(RIGHT_THRUST);</span>
<span class="nc" id="L1951">        String lifeSupport = aeroCritTag.getAttribute(LIFE_SUPPORT);</span>
<span class="nc" id="L1952">        String gear = aeroCritTag.getAttribute(GEAR);</span>

<span class="nc" id="L1954">        Aero a = (Aero) entity;</span>

<span class="nc bnc" id="L1956" title="All 2 branches missed.">        if (avionics.length() &gt; 0) {</span>
<span class="nc" id="L1957">            a.setAvionicsHits(Integer.parseInt(avionics));</span>
        }

<span class="nc bnc" id="L1960" title="All 2 branches missed.">        if (sensors.length() &gt; 0) {</span>
<span class="nc" id="L1961">            a.setSensorHits(Integer.parseInt(sensors));</span>
        }

<span class="nc bnc" id="L1964" title="All 2 branches missed.">        if (engine.length() &gt; 0) {</span>
<span class="nc" id="L1965">            a.setEngineHits(Integer.parseInt(engine));</span>
        }

<span class="nc bnc" id="L1968" title="All 2 branches missed.">        if (fcs.length() &gt; 0) {</span>
<span class="nc" id="L1969">            a.setFCSHits(Integer.parseInt(fcs));</span>
        }

<span class="nc bnc" id="L1972" title="All 2 branches missed.">        if (cic.length() &gt; 0) {</span>
<span class="nc" id="L1973">            a.setCICHits(Integer.parseInt(cic));</span>
        }

<span class="nc bnc" id="L1976" title="All 2 branches missed.">        if (leftThrust.length() &gt; 0) {</span>
<span class="nc" id="L1977">            a.setLeftThrustHits(Integer.parseInt(leftThrust));</span>
        }

<span class="nc bnc" id="L1980" title="All 2 branches missed.">        if (rightThrust.length() &gt; 0) {</span>
<span class="nc" id="L1981">            a.setRightThrustHits(Integer.parseInt(rightThrust));</span>
        }

<span class="nc bnc" id="L1984" title="All 2 branches missed.">        if (lifeSupport.length() &gt; 0) {</span>
<span class="nc" id="L1985">            a.setLifeSupport(false);</span>
        }

<span class="nc bnc" id="L1988" title="All 2 branches missed.">        if (gear.length() &gt; 0) {</span>
<span class="nc" id="L1989">            a.setGearHit(true);</span>
        }
<span class="nc" id="L1991">    }</span>

    /**
     *  Parse a dropCrit tag for the given &lt;code&gt;Entity&lt;/code&gt;.
     *  @param dropCritTag
     *  @param entity
     */
    private void parseDropCrit(Element dropCritTag, Entity entity){
<span class="nc" id="L1999">    	String dockingcollar = dropCritTag.getAttribute(DOCKING_COLLAR);</span>
<span class="nc" id="L2000">    	String kfboom = dropCritTag.getAttribute(KFBOOM);</span>

<span class="nc" id="L2002">    	Dropship d = (Dropship) entity;</span>

<span class="nc bnc" id="L2004" title="All 2 branches missed.">    	if (dockingcollar.length() &gt; 0) {</span>
<span class="nc" id="L2005">    		d.setDamageDockCollar(true);</span>
    	}
<span class="nc bnc" id="L2007" title="All 2 branches missed.">    	if (kfboom.length() &gt; 0) {</span>
<span class="nc" id="L2008">    		d.setDamageKFBoom(true);</span>
    	}
<span class="nc" id="L2010">    }</span>

    /**
     *  Parse cargo bay and door the given &lt;code&gt;Entity&lt;/code&gt;.
     *  Borrowed all this from the code that handles vehicle stabilizer crits by location.
     *
     *  @param entity
     */
    private void parseTransportBay (Element bayTag, Entity entity) {
    	// Look for the element's attributes.
<span class="nc" id="L2020">    	String index = bayTag.getAttribute(INDEX);</span>

    	int bay;
    	// Did we find the required index?
<span class="nc bnc" id="L2024" title="All 4 branches missed.">    	if ((index == null) || (index.length() == 0)) {</span>
<span class="nc" id="L2025">    		warning.append(&quot;Could not find index for bay.\n&quot;);</span>
<span class="nc" id="L2026">    		return;</span>
    	} else {
    	// Try to get a good index value.
<span class="nc" id="L2029">    		bay = -1;</span>
    		try {
<span class="nc" id="L2031">    			bay = Integer.parseInt(index);</span>
<span class="nc" id="L2032">    		} catch (NumberFormatException excep) {</span>
    			// Handled by the next if test
<span class="nc" id="L2034">    		}</span>
<span class="nc bnc" id="L2035" title="All 2 branches missed.">    		if (bay &lt; 0) {</span>
<span class="nc" id="L2036">    			warning.append(&quot;Found invalid index value for bay: &quot;).append(index).append(&quot;.\n&quot;);</span>
<span class="nc" id="L2037">    			return;</span>
<span class="nc bnc" id="L2038" title="All 2 branches missed.">    		} else if (entity.getBayById(bay) == null) {</span>
<span class="nc" id="L2039">    			warning.append(&quot;The entity, &quot;)</span>
<span class="nc" id="L2040">    			.append(entity.getShortName())</span>
<span class="nc" id="L2041">    			.append(&quot; does not have a bay at index: &quot;)</span>
<span class="nc" id="L2042">    			.append(bay).append(&quot;.\n&quot;);</span>
<span class="nc" id="L2043">    			return;</span>
    		}
    	} // End check for required fields

<span class="nc" id="L2047">    	Bay currentbay = entity.getBayById(bay);</span>

    	// Handle children for each bay.
<span class="nc" id="L2050">    	NodeList nl = bayTag.getChildNodes();</span>
<span class="nc bnc" id="L2051" title="All 2 branches missed.">    	for (int i = 0; i &lt; nl.getLength(); i++) {</span>
<span class="nc" id="L2052">    		Node currNode = nl.item(i);</span>

<span class="nc bnc" id="L2054" title="All 2 branches missed.">    		if (currNode.getParentNode() != bayTag) {</span>
<span class="nc" id="L2055">    			continue;</span>
    		}
<span class="nc" id="L2057">    		int nodeType = currNode.getNodeType();</span>
<span class="nc bnc" id="L2058" title="All 2 branches missed.">    		if (nodeType == Node.ELEMENT_NODE) {</span>
<span class="nc" id="L2059">    			String nodeName = currNode.getNodeName();</span>
<span class="nc bnc" id="L2060" title="All 2 branches missed.">    			if (nodeName.equalsIgnoreCase(BAYDAMAGE)) {</span>
<span class="nc" id="L2061">    				currentbay.setBayDamage(Double.parseDouble(currNode.getTextContent()));</span>
<span class="nc bnc" id="L2062" title="All 2 branches missed.">    			} else if (nodeName.equalsIgnoreCase(BAYDOORS)) {</span>
<span class="nc" id="L2063">                    currentbay.setCurrentDoors(Integer.parseInt(currNode.getTextContent()));</span>
<span class="nc bnc" id="L2064" title="All 2 branches missed.">    		    } else if (nodeName.equalsIgnoreCase(LOADED)) {</span>
<span class="nc" id="L2065">                    currentbay.troops.add(Integer.parseInt(currNode.getTextContent()));</span>
                }
    	    }
        }
<span class="nc" id="L2069">    } // End parseTransportBay</span>

    /**
     * Parse a tankCrit tag for the given &lt;code&gt;Entity&lt;/code&gt;.
     *
     * @param tankCrit
     * @param entity
     */
    private void parseTankCrit(Element tankCrit, Entity entity){
<span class="nc" id="L2078">        String sensors = tankCrit.getAttribute(SENSORS);</span>
<span class="nc" id="L2079">        String engine = tankCrit.getAttribute(ENGINE);</span>
<span class="nc" id="L2080">        String driver = tankCrit.getAttribute(DRIVER);</span>
<span class="nc" id="L2081">        String commander = tankCrit.getAttribute(COMMANDER);</span>

<span class="nc" id="L2083">        Tank t = (Tank) entity;</span>

<span class="nc bnc" id="L2085" title="All 2 branches missed.">        if (sensors.length() &gt; 0) {</span>
<span class="nc" id="L2086">            t.setSensorHits(Integer.parseInt(sensors));</span>
        }

<span class="nc bnc" id="L2089" title="All 2 branches missed.">        if (engine.equalsIgnoreCase(&quot;hit&quot;)) {</span>
<span class="nc" id="L2090">            t.engineHit();</span>
<span class="nc" id="L2091">            t.applyDamage();</span>
        }

<span class="nc bnc" id="L2094" title="All 2 branches missed.">        if (driver.equalsIgnoreCase(&quot;hit&quot;)) {</span>
<span class="nc" id="L2095">            t.setDriverHit(true);</span>
        }

<span class="nc bnc" id="L2098" title="All 2 branches missed.">        if (commander.equalsIgnoreCase(&quot;console&quot;)) {</span>
<span class="nc" id="L2099">            t.setUsingConsoleCommander(true);</span>
<span class="nc bnc" id="L2100" title="All 2 branches missed.">        } else if (commander.equalsIgnoreCase(&quot;hit&quot;)) {</span>
<span class="nc" id="L2101">            t.setCommanderHit(true);</span>
        }

<span class="nc" id="L2104">    }</span>

    /**
     * Parse a bombs tag for the given &lt;code&gt;Entity&lt;/code&gt;.
     *
     * @param bombsTag
     * @param entity
     */
    private void parseBombs(Element bombsTag, Entity entity){
<span class="nc bnc" id="L2113" title="All 2 branches missed.">        if (!(entity instanceof IBomber)) {</span>
<span class="nc" id="L2114">            warning.append(&quot;Found a bomb but Entity cannot carry bombs.\n&quot;);</span>
<span class="nc" id="L2115">            return;</span>
        }

        // Deal with any child nodes
<span class="nc" id="L2119">        NodeList nl = bombsTag.getChildNodes();</span>
<span class="nc bnc" id="L2120" title="All 2 branches missed.">        for (int i = 0; i &lt; nl.getLength(); i++) {</span>
<span class="nc" id="L2121">            Node currNode = nl.item(i);</span>

<span class="nc bnc" id="L2123" title="All 2 branches missed.">            if (currNode.getParentNode() != bombsTag) {</span>
<span class="nc" id="L2124">                continue;</span>
            }
<span class="nc" id="L2126">            int nodeType = currNode.getNodeType();</span>
<span class="nc bnc" id="L2127" title="All 2 branches missed.">            if (nodeType == Node.ELEMENT_NODE) {</span>
<span class="nc" id="L2128">                Element currEle = (Element)currNode;</span>
<span class="nc" id="L2129">                String nodeName = currNode.getNodeName();</span>
<span class="nc bnc" id="L2130" title="All 2 branches missed.">                if (nodeName.equalsIgnoreCase(BOMB)){</span>
<span class="nc" id="L2131">                    int[] bombChoices = ((IBomber) entity).getBombChoices();</span>
<span class="nc" id="L2132">                    String type = currEle.getAttribute(TYPE);</span>
<span class="nc" id="L2133">                    String load = currEle.getAttribute(LOAD);</span>
<span class="nc bnc" id="L2134" title="All 4 branches missed.">                    if (type.length() &gt; 0 &amp;&amp; load.length() &gt; 0){</span>
<span class="nc" id="L2135">                        int bombType = BombType.getBombTypeFromInternalName(type);</span>
<span class="nc bnc" id="L2136" title="All 4 branches missed.">                        if(bombType &lt;= BombType.B_NONE || bombType &gt;= BombType.B_NUM) {</span>
<span class="nc" id="L2137">                            continue;</span>
                        }

<span class="nc" id="L2140">                        bombChoices[bombType] += Integer.parseInt(load);</span>
<span class="nc" id="L2141">                        ((IBomber) entity).setBombChoices(bombChoices);</span>
                    }
                }
            } else {
                continue;
            }
        }
<span class="nc" id="L2148">    }</span>

    /**
     * Parse a c3i tag for the given &lt;code&gt;Entity&lt;/code&gt;.
     *
     * @param c3iTag
     * @param entity
     */
    private void parseC3I(Element c3iTag, Entity entity){
        // Deal with any child nodes
<span class="nc" id="L2158">        NodeList nl = c3iTag.getChildNodes();</span>
<span class="nc bnc" id="L2159" title="All 2 branches missed.">        for (int i = 0; i &lt; nl.getLength(); i++) {</span>
<span class="nc" id="L2160">            Node currNode = nl.item(i);</span>

<span class="nc bnc" id="L2162" title="All 2 branches missed.">            if (currNode.getParentNode() != c3iTag) {</span>
<span class="nc" id="L2163">                continue;</span>
            }
<span class="nc" id="L2165">            int nodeType = currNode.getNodeType();</span>
<span class="nc bnc" id="L2166" title="All 2 branches missed.">            if (nodeType == Node.ELEMENT_NODE) {</span>
<span class="nc" id="L2167">                Element currEle = (Element)currNode;</span>
<span class="nc" id="L2168">                String nodeName = currNode.getNodeName();</span>
<span class="nc bnc" id="L2169" title="All 2 branches missed.">                if (nodeName.equalsIgnoreCase(C3ILINK)){</span>
<span class="nc" id="L2170">                    String link = currEle.getAttribute(LINK);</span>
<span class="nc" id="L2171">                    int pos = entity.getFreeC3iUUID();</span>
<span class="nc bnc" id="L2172" title="All 4 branches missed.">                    if ((link.length() &gt; 0) &amp;&amp; (pos != -1)) {</span>
<span class="nc" id="L2173">                        System.out.println(&quot;Loading C3i UUID &quot; + pos +</span>
                                &quot;: &quot; + link);
<span class="nc" id="L2175">                        entity.setC3iNextUUIDAsString(pos, link);</span>
                    }
                }
            } else {
                continue;
            }
        }
<span class="nc" id="L2182">    }</span>

    /**
     * Parse an NC3 tag for the given &lt;code&gt;Entity&lt;/code&gt;.
     *
     * @param nc3Tag
     * @param entity
     */
    private void parseNC3(Element nc3Tag, Entity entity){
        // Deal with any child nodes
<span class="nc" id="L2192">        NodeList nl = nc3Tag.getChildNodes();</span>
<span class="nc bnc" id="L2193" title="All 2 branches missed.">        for (int i = 0; i &lt; nl.getLength(); i++) {</span>
<span class="nc" id="L2194">            Node currNode = nl.item(i);</span>

<span class="nc bnc" id="L2196" title="All 2 branches missed.">            if (currNode.getParentNode() != nc3Tag) {</span>
<span class="nc" id="L2197">                continue;</span>
            }
<span class="nc" id="L2199">            int nodeType = currNode.getNodeType();</span>
<span class="nc bnc" id="L2200" title="All 2 branches missed.">            if (nodeType == Node.ELEMENT_NODE) {</span>
<span class="nc" id="L2201">                Element currEle = (Element)currNode;</span>
<span class="nc" id="L2202">                String nodeName = currNode.getNodeName();</span>
<span class="nc bnc" id="L2203" title="All 2 branches missed.">                if (nodeName.equalsIgnoreCase(NC3LINK)){</span>
<span class="nc" id="L2204">                    String link = currEle.getAttribute(LINK);</span>
<span class="nc" id="L2205">                    int pos = entity.getFreeNC3UUID();</span>
<span class="nc bnc" id="L2206" title="All 4 branches missed.">                    if ((link.length() &gt; 0) &amp;&amp; (pos != -1)) {</span>
<span class="nc" id="L2207">                        System.out.println(&quot;Loading NC3 UUID &quot; + pos +</span>
                                &quot;: &quot; + link);
<span class="nc" id="L2209">                        entity.setNC3NextUUIDAsString(pos, link);</span>
                    }
                }
            } else {
                continue;
            }
        }
<span class="nc" id="L2216">    }</span>
    
    /**
     * Parse an EscapeCraft tag for the given &lt;code&gt;Entity&lt;/code&gt;.
     *
     * @param escCraftTag
     * @param entity
     */
    private void parseEscapeCraft(Element escCraftTag, Entity entity){
<span class="nc bnc" id="L2225" title="All 4 branches missed.">        if (!(entity instanceof SmallCraft || entity instanceof Jumpship)) {</span>
<span class="nc" id="L2226">            warning.append(&quot;Found an EscapeCraft tag but Entity is not a &quot; +</span>
                    &quot;Crewed Spacecraft!\n&quot;);
<span class="nc" id="L2228">            return;</span>
        }
        try {
<span class="nc" id="L2231">            String id = escCraftTag.getAttribute(ID);</span>
<span class="nc" id="L2232">            ((Aero) entity).addEscapeCraft(id);</span>
<span class="nc" id="L2233">        } catch (Exception e) {</span>
<span class="nc" id="L2234">            warning.append(&quot;Invalid external entity id in EscapeCraft tag.\n&quot;);</span>
<span class="nc" id="L2235">        }</span>
<span class="nc" id="L2236">    }</span>
    
    /**
     * Parse an EscapedPassengers tag for the given &lt;code&gt;Entity&lt;/code&gt;.
     *
     * @param escPassTag
     * @param entity
     */
    private void parseEscapedPassengers(Element escPassTag, Entity entity){
<span class="nc bnc" id="L2245" title="All 4 branches missed.">        if (!(entity instanceof EjectedCrew || entity instanceof SmallCraft)) {</span>
<span class="nc" id="L2246">            warning.append(&quot;Found an EscapedPassengers tag but Entity is not a &quot; +</span>
                    &quot;Spacecraft Crew or Small Craft!\n&quot;);
<span class="nc" id="L2248">            return;</span>
        }
        // Deal with any child nodes
<span class="nc" id="L2251">        NodeList nl = escPassTag.getChildNodes();</span>
<span class="nc bnc" id="L2252" title="All 2 branches missed.">        for (int i = 0; i &lt; nl.getLength(); i++) {</span>
<span class="nc" id="L2253">            Node currNode = nl.item(i);</span>
<span class="nc" id="L2254">            int nodeType = currNode.getNodeType();</span>
<span class="nc bnc" id="L2255" title="All 2 branches missed.">            if (nodeType == Node.ELEMENT_NODE) {</span>
<span class="nc" id="L2256">                Element currEle = (Element)currNode;</span>
<span class="nc" id="L2257">                String id = currEle.getAttribute(ID);</span>
<span class="nc" id="L2258">                String number = currEle.getAttribute(NUMBER);</span>
<span class="nc" id="L2259">                int value = Integer.parseInt(number);</span>
<span class="nc bnc" id="L2260" title="All 2 branches missed.">                if (entity instanceof EjectedCrew) {</span>
<span class="nc" id="L2261">                    ((EjectedCrew) entity).addPassengers(id, value);</span>
<span class="nc bnc" id="L2262" title="All 2 branches missed.">                } else if (entity instanceof SmallCraft) {</span>
<span class="nc" id="L2263">                    ((SmallCraft) entity).addPassengers(id, value);</span>
                }
            }
        }
<span class="nc" id="L2267">    }</span>
    
    /**
     * Parse an EscapedCrew tag for the given &lt;code&gt;Entity&lt;/code&gt;.
     *
     * @param escCrewTag
     * @param entity
     */
    private void parseEscapedCrew(Element escCrewTag, Entity entity){
<span class="nc bnc" id="L2276" title="All 4 branches missed.">        if (!(entity instanceof EjectedCrew || entity instanceof SmallCraft)) {</span>
<span class="nc" id="L2277">            warning.append(&quot;Found an EscapedCrew tag but Entity is not a &quot; +</span>
                    &quot;Spacecraft Crew or Small Craft!\n&quot;);
<span class="nc" id="L2279">            return;</span>
        }
        // Deal with any child nodes
<span class="nc" id="L2282">        NodeList nl = escCrewTag.getChildNodes();</span>
<span class="nc bnc" id="L2283" title="All 2 branches missed.">        for (int i = 0; i &lt; nl.getLength(); i++) {</span>
<span class="nc" id="L2284">            Node currNode = nl.item(i);</span>
<span class="nc" id="L2285">            int nodeType = currNode.getNodeType();</span>
<span class="nc bnc" id="L2286" title="All 2 branches missed.">            if (nodeType == Node.ELEMENT_NODE) {</span>
<span class="nc" id="L2287">                Element currEle = (Element)currNode;</span>
<span class="nc" id="L2288">                String id = currEle.getAttribute(ID);</span>
<span class="nc" id="L2289">                String number = currEle.getAttribute(NUMBER);</span>
<span class="nc" id="L2290">                int value = Integer.parseInt(number);</span>
<span class="nc bnc" id="L2291" title="All 2 branches missed.">                if (entity instanceof EjectedCrew) {</span>
<span class="nc" id="L2292">                    ((EjectedCrew) entity).addNOtherCrew(id, value);</span>
<span class="nc bnc" id="L2293" title="All 2 branches missed.">                } else if (entity instanceof SmallCraft) {</span>
<span class="nc" id="L2294">                    ((SmallCraft) entity).addNOtherCrew(id, value);</span>
                }
            }
        }
<span class="nc" id="L2298">    }</span>
    
    /**
     * Parse an original si tag for the given &lt;code&gt;Entity&lt;/code&gt;. Used by Escape Pods
     *
     * @param OsiTag
     * @param entity
     */
    private void parseOSI(Element OsiTag, Entity entity){
<span class="nc" id="L2307">        String value = OsiTag.getAttribute(NUMBER);</span>
        try {
<span class="nc" id="L2309">            int newSI = Integer.parseInt(value);</span>
<span class="nc" id="L2310">            ((Aero) entity).set0SI(newSI);</span>
<span class="nc" id="L2311">        } catch (Exception e) {</span>
<span class="nc" id="L2312">            warning.append(&quot;Invalid SI value in original structural integrity tag.\n&quot;);</span>
<span class="nc" id="L2313">        }</span>
<span class="nc" id="L2314">    }</span>
    
    /**
     * Parse an original men tag for the given &lt;code&gt;Entity&lt;/code&gt;. Used by Escaped spacecraft crew
     *
     * @param OMenTag
     * @param entity
     */
    private void parseOMen(Element OMenTag, Entity entity){
<span class="nc" id="L2323">        String value = OMenTag.getAttribute(NUMBER);</span>
        try {
<span class="nc" id="L2325">            int newMen = Integer.parseInt(value);</span>
<span class="nc" id="L2326">            ((Infantry) entity).initializeInternal(newMen, Infantry.LOC_INFANTRY);</span>
<span class="nc" id="L2327">        } catch (Exception e) {</span>
<span class="nc" id="L2328">            warning.append(&quot;Invalid internal value in original number of men tag.\n&quot;);</span>
<span class="nc" id="L2329">        }</span>
<span class="nc" id="L2330">    }</span>
    
    /**
     * Parse a conveyance tag for the given &lt;code&gt;Entity&lt;/code&gt;. Used to resolve crew damage to transported entities
     *
     * @param conveyanceTag
     * @param entity
     */
    private void parseConveyance(Element conveyanceTag, Entity entity){
<span class="nc" id="L2339">        String value = conveyanceTag.getAttribute(ID);</span>
        try {
<span class="nc" id="L2341">            int id = Integer.parseInt(value);</span>
<span class="nc" id="L2342">            entity.setTransportId(id);</span>
<span class="nc" id="L2343">        } catch (Exception e) {</span>
<span class="nc" id="L2344">            warning.append(&quot;Invalid transport id in conveyance tag.\n&quot;);</span>
<span class="nc" id="L2345">        }</span>
<span class="nc" id="L2346">    }</span>
    
    /**
     * Parse an id tag for the given &lt;code&gt;Entity&lt;/code&gt;. Used to resolve crew damage to transported entities
     *
     * @param idTag
     * @param entity
     */
    private void parseId(Element idTag, Entity entity){
<span class="nc" id="L2355">        String value = idTag.getAttribute(ID);</span>
        //Safety. We don't want to mess with autoassigned game Ids
<span class="nc bnc" id="L2357" title="All 2 branches missed.">        if (entity.getGame() != null) {</span>
<span class="nc" id="L2358">            return;</span>
        }
        try {
<span class="nc" id="L2361">            int id = Integer.parseInt(value);</span>
<span class="nc" id="L2362">            entity.setId(id);</span>
<span class="nc" id="L2363">        } catch (Exception e) {</span>
<span class="nc" id="L2364">            warning.append(&quot;Invalid id in conveyance tag.\n&quot;);</span>
<span class="nc" id="L2365">        }</span>
<span class="nc" id="L2366">    }</span>

    /**
     * Parase a modularEquipmentMount tag for the supplied &lt;code&gt;Entity&lt;/code&gt;.
     *
     * @param meaTag
     * @param entity
     */
    private void parseBAMEA(Element meaTag, Entity entity){
<span class="nc bnc" id="L2375" title="All 2 branches missed.">        if (!(entity instanceof BattleArmor)){</span>
<span class="nc" id="L2376">            warning.append(&quot;Found a BA MEA tag but Entity is not &quot; +</span>
                    &quot;BattleArmor!\n&quot;);
<span class="nc" id="L2378">            return;</span>
        }

<span class="nc" id="L2381">        String meaMountLocString = meaTag.getAttribute(BA_MEA_MOUNT_LOC);</span>
<span class="nc" id="L2382">        String manipTypeName = meaTag.getAttribute(BA_MEA_TYPE_NAME);</span>

        // Make sure we got a mount number
<span class="nc bnc" id="L2385" title="All 2 branches missed.">        if (meaMountLocString.length() == 0){</span>
<span class="nc" id="L2386">            warning.append(&quot;antiPersonnelMount tag does not specify &quot; +</span>
                    &quot;a baMeaMountLoc!\n&quot;);
<span class="nc" id="L2388">            return;</span>
        }

        // We could have no mounted manipulator
<span class="nc" id="L2392">        EquipmentType manipType = null;</span>
<span class="nc bnc" id="L2393" title="All 2 branches missed.">        if (manipTypeName.length() &gt; 0){</span>
<span class="nc" id="L2394">            manipType = EquipmentType.get(manipTypeName);</span>
        }

        // Find the Mounted instance for the MEA
<span class="nc" id="L2398">        Mounted mountedManip = null;</span>
<span class="nc" id="L2399">        int meaMountLoc = Integer.parseInt(meaMountLocString);</span>
<span class="nc" id="L2400">        boolean foundMea = false;</span>
<span class="nc bnc" id="L2401" title="All 2 branches missed.">        for (Mounted m : entity.getEquipment()){</span>
<span class="nc bnc" id="L2402" title="All 2 branches missed.">            if (m.getBaMountLoc() != meaMountLoc){</span>
<span class="nc" id="L2403">                continue;</span>
            }
<span class="nc bnc" id="L2405" title="All 2 branches missed.">            if (m.getType().hasFlag(MiscType.F_BA_MEA)){</span>
<span class="nc" id="L2406">                foundMea = true;</span>
<span class="nc" id="L2407">                break;</span>
            }
<span class="nc" id="L2409">        }</span>
<span class="nc bnc" id="L2410" title="All 2 branches missed.">        if (!foundMea){</span>
<span class="nc" id="L2411">            warning.append(&quot;No modular equipment mount found in specified &quot; + &quot;location! Location: &quot;)</span>
<span class="nc" id="L2412">                    .append(meaMountLoc).append(&quot;\n&quot;);</span>
<span class="nc" id="L2413">            return;</span>
        }
<span class="nc bnc" id="L2415" title="All 2 branches missed.">        if (meaMountLoc == BattleArmor.MOUNT_LOC_LARM){</span>
<span class="nc" id="L2416">            mountedManip = ((BattleArmor)entity).getLeftManipulator();</span>
<span class="nc bnc" id="L2417" title="All 2 branches missed.">        } else if (meaMountLoc == BattleArmor.MOUNT_LOC_RARM){</span>
<span class="nc" id="L2418">            mountedManip = ((BattleArmor)entity).getRightManipulator();</span>
        }

<span class="nc bnc" id="L2421" title="All 2 branches missed.">        if (mountedManip != null){</span>
<span class="nc" id="L2422">            entity.getEquipment().remove(mountedManip);</span>
<span class="nc" id="L2423">            entity.getMisc().remove(mountedManip);</span>
        }

        // Was no manipulator selected?
<span class="nc bnc" id="L2427" title="All 2 branches missed.">        if (manipType == null){</span>
<span class="nc" id="L2428">            return;</span>
        }

        // Add the newly mounted maniplator
        try{
<span class="nc" id="L2433">            int baMountLoc = mountedManip.getBaMountLoc();</span>
<span class="nc" id="L2434">            mountedManip = entity.addEquipment(manipType,</span>
<span class="nc" id="L2435">                    mountedManip.getLocation());</span>
<span class="nc" id="L2436">            mountedManip.setBaMountLoc(baMountLoc);</span>
<span class="nc" id="L2437">        } catch (LocationFullException ex){</span>
            // This shouldn't happen for BA...
<span class="nc" id="L2439">            ex.printStackTrace();</span>
<span class="nc" id="L2440">        }</span>
<span class="nc" id="L2441">    }</span>

    /**
     * Parase a antiPersonnelMount tag for the supplied &lt;code&gt;Entity&lt;/code&gt;.
     *
     * @param apmTag
     * @param entity
     */
    private void parseBAAPM(Element apmTag, Entity entity){
<span class="nc bnc" id="L2450" title="All 2 branches missed.">        if (!(entity instanceof BattleArmor)){</span>
<span class="nc" id="L2451">            warning.append(&quot;Found a BA APM tag but Entity is not &quot; +</span>
                    &quot;BattleArmor!\n&quot;);
<span class="nc" id="L2453">            return;</span>
        }

<span class="nc" id="L2456">        String mountNumber = apmTag.getAttribute(BA_APM_MOUNT_NUM);</span>
<span class="nc" id="L2457">        String apTypeName = apmTag.getAttribute(BA_APM_TYPE_NAME);</span>

        // Make sure we got a mount number
<span class="nc bnc" id="L2460" title="All 2 branches missed.">        if (mountNumber.length() == 0){</span>
<span class="nc" id="L2461">            warning.append(&quot;antiPersonnelMount tag does not specify &quot; +</span>
                    &quot;a baAPMountNum!\n&quot;);
<span class="nc" id="L2463">            return;</span>
        }

<span class="nc" id="L2466">        Mounted apMount = entity.getEquipment(Integer.parseInt(mountNumber));</span>
        // We may mount no AP weapon
<span class="nc" id="L2468">        EquipmentType apType = null;</span>
<span class="nc bnc" id="L2469" title="All 2 branches missed.">        if (apTypeName.length() &gt; 0){</span>
<span class="nc" id="L2470">            apType = EquipmentType.get(apTypeName);</span>
        }

        // Remove any currently mounted AP weapon
<span class="nc bnc" id="L2474" title="All 2 branches missed.">        if (apMount.getLinked() != null</span>
<span class="nc bnc" id="L2475" title="All 2 branches missed.">                &amp;&amp; apMount.getLinked().getType() != apType){</span>
<span class="nc" id="L2476">            Mounted apWeapon = apMount.getLinked();</span>
<span class="nc" id="L2477">            entity.getEquipment().remove(apWeapon);</span>
<span class="nc" id="L2478">            entity.getWeaponList().remove(apWeapon);</span>
<span class="nc" id="L2479">            entity.getTotalWeaponList().remove(apWeapon);</span>
            // We need to make sure that the weapon has been removed
            //  from the criticals, otherwise it can cause issues
<span class="nc bnc" id="L2482" title="All 2 branches missed.">            for (int loc = 0; loc &lt; entity.locations(); loc++) {</span>
<span class="nc" id="L2483">                for (int c = 0;</span>
<span class="nc bnc" id="L2484" title="All 2 branches missed.">                        c &lt; entity.getNumberOfCriticals(loc); c++) {</span>
<span class="nc" id="L2485">                    CriticalSlot crit = entity.getCritical(loc, c);</span>
<span class="nc bnc" id="L2486" title="All 4 branches missed.">                    if (crit != null &amp;&amp; crit.getMount() != null</span>
<span class="nc bnc" id="L2487" title="All 2 branches missed.">                            &amp;&amp; crit.getMount().equals(apWeapon)) {</span>
<span class="nc" id="L2488">                        entity.setCritical(loc, c, null);</span>
                    }
                }
            }
        }

        // Did the selection not change, or no weapon was selected
<span class="nc bnc" id="L2495" title="All 2 branches missed.">        if ((apMount.getLinked() != null</span>
<span class="nc bnc" id="L2496" title="All 4 branches missed.">                &amp;&amp; apMount.getLinked().getType() == apType)</span>
                || (apType == null)){
<span class="nc" id="L2498">            return;</span>
        }

        // Add the newly mounted weapon
        try{
<span class="nc" id="L2503">            Mounted newWeap =  entity.addEquipment(apType,</span>
<span class="nc" id="L2504">                    apMount.getLocation());</span>
<span class="nc" id="L2505">            apMount.setLinked(newWeap);</span>
<span class="nc" id="L2506">            newWeap.setLinked(apMount);</span>
<span class="nc" id="L2507">            newWeap.setAPMMounted(true);</span>
<span class="nc" id="L2508">        } catch (LocationFullException ex){</span>
            // This shouldn't happen for BA...
<span class="nc" id="L2510">            ex.printStackTrace();</span>
<span class="nc" id="L2511">        }</span>

<span class="nc" id="L2513">    }</span>

    /**
     * Worker function that takes an entity, a location, an ammo type string and the critical index
     * of a weapons bay in the given location and attempts to add the ammo type there.
     * @param entity The entity we're working on loading
     * @param loc The location index on the entity
     * @param type The ammo type string
     * @param bayIndex The crit index of the bay where we want to load the ammo on the location where the bay is
     */
    private void addExtraAmmoToBay(Entity entity, int loc, String type, String bayIndex) {
        // here, we need to do the following:
        // 1: get the bay to which this ammo belongs, and add it to said bay
        // 2: add the ammo to the entity as a &quot;new&quot; piece of equipment
        // 3: add the ammo to a crit slot on the bay's location

<span class="nc" id="L2529">        int bayCritIndex = Integer.parseInt(bayIndex);</span>
<span class="nc" id="L2530">        Mounted bay = entity.getCritical(loc, bayCritIndex - 1).getMount();</span>

<span class="nc" id="L2532">        Mounted ammo = new Mounted(entity, AmmoType.get(type));</span>

        try {
<span class="nc" id="L2535">            entity.addEquipment(ammo, loc, bay.isRearMounted());</span>
<span class="nc" id="L2536">        } catch(LocationFullException lfe) {</span>
            // silently swallow it, since dropship locations have about a hundred crit slots
<span class="nc" id="L2538">        }</span>

<span class="nc" id="L2540">        bay.addAmmoToBay(entity.getEquipmentNum(ammo));</span>
<span class="nc" id="L2541">    }</span>

    /**
     * Determine if unexpected XML entities were encountered during parsing.
     *
     * @return &lt;code&gt;true&lt;/code&gt; if a non-fatal warning occured.
     */
    public boolean hasWarningMessage() {
<span class="nc bnc" id="L2549" title="All 2 branches missed.">        return (warning.length() &gt; 0);</span>
    }

    /**
     * Get the warning message from the last parse.
     *
     * @return The &lt;code&gt;String&lt;/code&gt; warning message from the last parse. If
     *         there is no warning message, then an &lt;code&gt;null&lt;/code&gt; value is
     *         returned.
     */
    public String getWarningMessage() {
<span class="nc bnc" id="L2560" title="All 2 branches missed.">        if (warning.length() &gt; 0) {</span>
<span class="nc" id="L2561">            return warning.toString();</span>
        }
<span class="nc" id="L2563">        return null;</span>
    }

    /**
     * Returns a list of all of the  Entity's parsed from the input, should be
     * called after &lt;code&gt;parse&lt;/code&gt;. This is for entities that we want to be loaded
     * into the chat lounge, so functional
     * @return
     */
    public Vector&lt;Entity&gt; getEntities(){
<span class="nc" id="L2573">        Vector&lt;Entity&gt; toReturn = entities;</span>
<span class="nc bnc" id="L2574" title="All 2 branches missed.">        for(Entity e : survivors) {</span>
<span class="nc bnc" id="L2575" title="All 2 branches missed.">            if(e instanceof EjectedCrew) {</span>
<span class="nc" id="L2576">                continue;</span>
            }
<span class="nc" id="L2578">            toReturn.add(e);</span>
<span class="nc" id="L2579">        }</span>
<span class="nc" id="L2580">        return toReturn;</span>
    }

    /**
     * Returns a list of all of the salvaged Entity's parsed from the input, should be
     * called after &lt;code&gt;parse&lt;/code&gt;.
     * @return
     */
    public Vector&lt;Entity&gt; getSurvivors(){
<span class="nc" id="L2589">        return survivors;</span>
    }

    /**
     * Returns a list of all of the allied Entity's parsed from the input, should be
     * called after &lt;code&gt;parse&lt;/code&gt;.
     * @return
     */
    public Vector&lt;Entity&gt; getAllies(){
<span class="nc" id="L2598">        return allies;</span>
    }

    /**
     * Returns a list of all of the salvaged Entity's parsed from the input, should be
     * called after &lt;code&gt;parse&lt;/code&gt;.
     * @return
     */
    public Vector&lt;Entity&gt; getSalvage(){
<span class="nc" id="L2607">        return salvage;</span>
    }

    /**
     * Returns a list of all of the enemy retreated entities parsed from the input, should be
     * called after &lt;code&gt;parse&lt;/code&gt;.
     * @return
     */
    public Vector&lt;Entity&gt; getRetreated(){
<span class="nc" id="L2616">        return retreated;</span>
    }

    /**
     * Returns a list of all of the devastated Entity's parsed from the input, should be
     * called after &lt;code&gt;parse&lt;/code&gt;.
     * @return
     */
    public Vector&lt;Entity&gt; getDevastated(){
<span class="nc" id="L2625">        return devastated;</span>
    }

    /**
     * Returns a list of all of the Pilots parsed from the input, should be
     * called after &lt;code&gt;parse&lt;/code&gt;.
     *
     * @return
     */
    public Vector&lt;Crew&gt; getPilots() {
<span class="nc" id="L2635">        return pilots;</span>
    }

    /**
     * Returns the kills hashtable
     *
     * @return
     */
    public Hashtable&lt;String, String&gt; getKills() {
<span class="nc" id="L2644">        return kills;</span>
    }

    /**
     * Marks all equipment in a location on an &lt;code&gt;Entity&lt;code&gt; as destroyed.
     *
     * @param en
     *            - the &lt;code&gt;Entity&lt;/code&gt; whose location is destroyed.
     * @param loc
     *            - the &lt;code&gt;int&lt;/code&gt; index of the destroyed location.
     */
    private void destroyLocation(Entity en, int loc) {

        // mark armor, internal as destroyed
<span class="nc" id="L2658">        en.setArmor(IArmorState.ARMOR_DESTROYED, loc, false);</span>
<span class="nc" id="L2659">        en.setInternal(IArmorState.ARMOR_DESTROYED, loc);</span>
<span class="nc bnc" id="L2660" title="All 2 branches missed.">        if (en.hasRearArmor(loc)) {</span>
<span class="nc" id="L2661">            en.setArmor(IArmorState.ARMOR_DESTROYED, loc, true);</span>
        }
        // equipment marked missing
<span class="nc bnc" id="L2664" title="All 2 branches missed.">        for (Mounted mounted : en.getEquipment()) {</span>
<span class="nc bnc" id="L2665" title="All 2 branches missed.">            if (mounted.getLocation() == loc) {</span>
<span class="nc" id="L2666">                mounted.setDestroyed(true);</span>
            }
<span class="nc" id="L2668">        }</span>
        // all critical slots set as missing
<span class="nc bnc" id="L2670" title="All 2 branches missed.">        for (int i = 0; i &lt; en.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L2671">            final CriticalSlot cs = en.getCritical(loc, i);</span>
<span class="nc bnc" id="L2672" title="All 2 branches missed.">            if (cs != null) {</span>
<span class="nc" id="L2673">                cs.setDestroyed(true);</span>
            }
        }
<span class="nc" id="L2676">    }</span>

    private void breachLocation(Entity en, int loc) {
        // equipment marked breached
<span class="nc bnc" id="L2680" title="All 2 branches missed.">        for (Mounted mounted : en.getEquipment()) {</span>
<span class="nc bnc" id="L2681" title="All 2 branches missed.">            if (mounted.getLocation() == loc) {</span>
<span class="nc" id="L2682">                mounted.setBreached(true);</span>
            }
<span class="nc" id="L2684">        }</span>
        // all critical slots set as breached
<span class="nc bnc" id="L2686" title="All 2 branches missed.">        for (int i = 0; i &lt; en.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L2687">            final CriticalSlot cs = en.getCritical(loc, i);</span>
<span class="nc bnc" id="L2688" title="All 2 branches missed.">            if (cs != null) {</span>
<span class="nc" id="L2689">                cs.setBreached(true);</span>
            }
        }
<span class="nc" id="L2692">        en.setLocationStatus(loc, ILocationExposureStatus.BREACHED);</span>
<span class="nc" id="L2693">    }</span>

    private void blowOffLocation(Entity en, int loc) {
<span class="nc" id="L2696">        en.setLocationBlownOff(loc, true);</span>
<span class="nc bnc" id="L2697" title="All 2 branches missed.">        for (Mounted mounted : en.getEquipment()) {</span>
<span class="nc bnc" id="L2698" title="All 2 branches missed.">            if (mounted.getLocation() == loc) {</span>
<span class="nc" id="L2699">                mounted.setMissing(true);</span>
            }
<span class="nc" id="L2701">        }</span>
<span class="nc bnc" id="L2702" title="All 2 branches missed.">        for (int i = 0; i &lt; en.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L2703">            final CriticalSlot cs = en.getCritical(loc, i);</span>
<span class="nc bnc" id="L2704" title="All 2 branches missed.">            if (cs != null) {</span>
<span class="nc" id="L2705">                cs.setMissing(true);</span>
            }
        }
<span class="nc" id="L2708">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>