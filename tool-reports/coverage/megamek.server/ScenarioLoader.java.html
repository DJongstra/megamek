<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="nl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ScenarioLoader.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">PlayerTest Coverage Results</a> &gt; <a href="index.source.html" class="el_package">megamek.server</a> &gt; <span class="el_source">ScenarioLoader.java</span></div><h1>ScenarioLoader.java</h1><pre class="source lang-java linenums">/*
 * MegaMek - Copyright (C) 2003, 2004, 2005 Ben Mazur (bmazur@sev.org)
 * ScenarioLoader - Copyright (C) 2002 Josh Yockey
 * Copyright Â© 2013 Edward Cullen (eddy@obsessedcomputers.co.uk)
 *
 *  This program is free software; you can redistribute it and/or modify it
 *  under the terms of the GNU General Public License as published by the Free
 *  Software Foundation; either version 2 of the License, or (at your option)
 *  any later version.
 *
 *  This program is distributed in the hope that it will be useful, but
 *  WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
 *  or FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License
 *  for more details.
 */
package megamek.server;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.HashMap;
import java.util.IllegalFormatException;
import java.util.Iterator;
import java.util.LinkedList;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Queue;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import megamek.MegaMek;
import megamek.client.generator.RandomGenderGenerator;
import megamek.client.ui.swing.tileset.MMStaticDirectoryManager;
import megamek.client.ui.swing.util.PlayerColour;
import megamek.common.AmmoType;
import megamek.common.BattleArmor;
import megamek.common.Board;
import megamek.common.Compute;
import megamek.common.Configuration;
import megamek.common.Coords;
import megamek.common.Crew;
import megamek.common.CriticalSlot;
import megamek.common.Entity;
import megamek.common.EquipmentType;
import megamek.common.Game;
import megamek.common.HitData;
import megamek.common.IAero;
import megamek.common.IArmorState;
import megamek.common.IBoard;
import megamek.common.IGame;
import megamek.common.IPlayer;
import megamek.common.IStartingPositions;
import megamek.common.Infantry;
import megamek.common.MapSettings;
import megamek.common.Mech;
import megamek.common.MechFileParser;
import megamek.common.MechSummary;
import megamek.common.MechSummaryCache;
import megamek.common.Mounted;
import megamek.common.Player;
import megamek.common.Protomech;
import megamek.common.SimpleTechLevel;
import megamek.common.Tank;
import megamek.common.TechConstants;
import megamek.common.ToHitData;
import megamek.common.WeaponType;
import megamek.common.enums.Gender;
import megamek.common.icons.AbstractIcon;
import megamek.common.icons.Camouflage;
import megamek.common.loaders.EntityLoadingException;
import megamek.common.options.IOption;
import megamek.common.options.OptionsConstants;
import megamek.common.util.BoardUtilities;
import megamek.common.util.StringUtil;
import megamek.common.util.fileUtils.MegaMekFile;

public class ScenarioLoader {
    private static final String COMMENT_MARK = &quot;#&quot;;
    
    private static final String SEPARATOR_PROPERTY = &quot;=&quot;;
    private static final String SEPARATOR_COMMA = &quot;,&quot;;
    private static final String SEPARATOR_SPACE = &quot; &quot;;
    private static final String SEPARATOR_COLON = &quot;:&quot;;
    private static final String SEPARATOR_UNDERSCORE = &quot;_&quot;;

    private static final String FILE_SUFFIX_BOARD = &quot;.board&quot;;

    private static final String PARAM_MMSVERSION = &quot;MMSVersion&quot;;
    private static final String PARAM_GAME_OPTIONS_FILE = &quot;GameOptionsFile&quot;;
    private static final String PARAM_GAME_EXTERNAL_ID = &quot;ExternalId&quot;;
    private static final String PARAM_FACTIONS = &quot;Factions&quot;;

    private static final String PARAM_MAP_WIDTH = &quot;MapWidth&quot;;
    private static final String PARAM_MAP_HEIGHT = &quot;MapHeight&quot;;
    private static final String PARAM_BOARD_WIDTH = &quot;BoardWidth&quot;;
    private static final String PARAM_BOARD_HEIGHT = &quot;BoardHeight&quot;;
    private static final String PARAM_BRIDGE_CF = &quot;BridgeCF&quot;;
    private static final String PARAM_MAPS = &quot;Maps&quot;;
    private static final String PARAM_MAP_DIRECTORIES = &quot;RandomDirs&quot;;

    private static final String PARAM_TEAM = &quot;Team&quot;;
    private static final String PARAM_LOCATION = &quot;Location&quot;;
    private static final String PARAM_MINEFIELDS = &quot;Minefields&quot;;
    private static final String PARAM_DAMAGE = &quot;Damage&quot;;
    private static final String PARAM_SPECIFIC_DAMAGE = &quot;DamageSpecific&quot;;
    private static final String PARAM_CRITICAL_HIT = &quot;CritHit&quot;;
    private static final String PARAM_AMMO_AMOUNT = &quot;SetAmmoTo&quot;;
    private static final String PARAM_AMMO_TYPE = &quot;SetAmmoType&quot;;
    private static final String PARAM_PILOT_HITS = &quot;PilotHits&quot;;
    private static final String PARAM_EXTERNAL_ID = &quot;ExternalID&quot;;
    private static final String PARAM_ADVANTAGES = &quot;Advantages&quot;;
    private static final String PARAM_AUTO_EJECT = &quot;AutoEject&quot;;
    private static final String PARAM_COMMANDER = &quot;Commander&quot;;
    private static final String PARAM_DEPLOYMENT_ROUND = &quot;DeploymentRound&quot;;
    private static final String PARAM_CAMO = &quot;Camo&quot;;
    private static final String PARAM_ALTITUDE = &quot;Altitude&quot;;

    private static final String MAP_RANDOM = &quot;RANDOM&quot;;

    private final File scenarioFile;
    // copied from ChatLounge.java
<span class="nc" id="L129">    private final List&lt;DamagePlan&gt; damagePlans = new ArrayList&lt;&gt;();</span>
    // Used to store Crit Hits
<span class="nc" id="L131">    private final List&lt;CritHitPlan&gt; critHitPlans = new ArrayList&lt;&gt;();</span>
    // Used to set ammo Spec Ammounts
<span class="nc" id="L133">    private final List&lt;SetAmmoPlan&gt; ammoPlans = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L135">    public ScenarioLoader(File f) {</span>
<span class="nc" id="L136">        scenarioFile = f;</span>
<span class="nc" id="L137">    }</span>
    
    // TODO: legal/valid ammo type handling and game options, since they are set at this point
    private AmmoType getValidAmmoType(IGame game, Mounted mounted, String ammoString) {
<span class="nc" id="L141">        final Entity e = mounted.getEntity();</span>
<span class="nc" id="L142">        final int year = game.getOptions().intOption(OptionsConstants.ALLOWED_YEAR);</span>
<span class="nc" id="L143">        final EquipmentType currentAmmoType = mounted.getType();</span>
<span class="nc" id="L144">        final Mounted currentWeapon = mounted.getLinkedBy();</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">        final EquipmentType currentWeaponType = (null != currentWeapon) ? currentWeapon.getType() : null;</span>
<span class="nc" id="L146">        final EquipmentType newAmmoType = EquipmentType.get(ammoString);</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (newAmmoType == null) {</span>
<span class="nc" id="L148">            MegaMek.getLogger().error(String.format(&quot;Ammo type '%s' not found&quot;, ammoString));</span>
<span class="nc" id="L149">            return null;</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">        } else if (!(newAmmoType instanceof AmmoType)) {</span>
<span class="nc" id="L151">            MegaMek.getLogger().error(String.format(&quot;Equipment %s is not an ammo type&quot;, newAmmoType.getName()));</span>
<span class="nc" id="L152">            return null;</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">        } else if (!newAmmoType.isLegal(year, SimpleTechLevel.getGameTechLevel(game), e.isClan(), e.isMixedTech())) {</span>
<span class="nc" id="L154">            MegaMek.getLogger().warning(String.format(&quot;Ammo %s (TL %d) is not legal for year %d (TL %d)&quot;,</span>
<span class="nc" id="L155">                    newAmmoType.getName(), newAmmoType.getTechLevel(year), year,</span>
<span class="nc" id="L156">                    TechConstants.getGameTechLevel(game, e.isClan())));</span>
<span class="nc" id="L157">            return null;</span>
<span class="nc bnc" id="L158" title="All 4 branches missed.">        } else if (e.isClan() &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ALLOWED_CLAN_IGNORE_EQ_LIMITS)) {</span>
            // Check for clan weapon restrictions
<span class="nc" id="L160">            final long muniType = ((AmmoType) newAmmoType).getMunitionType() &amp; ~AmmoType.M_INCENDIARY_LRM;</span>
<span class="nc bnc" id="L161" title="All 24 branches missed.">            if ((muniType == AmmoType.M_SEMIGUIDED) || (muniType == AmmoType.M_SWARM_I)</span>
                || (muniType == AmmoType.M_THUNDER_AUGMENTED) || (muniType == AmmoType.M_THUNDER_INFERNO)
                || (muniType == AmmoType.M_THUNDER_VIBRABOMB) || (muniType == AmmoType.M_THUNDER_ACTIVE)
                || (muniType == AmmoType.M_INFERNO_IV) || (muniType == AmmoType.M_VIBRABOMB_IV)
                || (muniType == AmmoType.M_LISTEN_KILL) || (muniType == AmmoType.M_ANTI_TSM)
                || (muniType == AmmoType.M_DEAD_FIRE) || (muniType == AmmoType.M_MINE_CLEARANCE)) {
<span class="nc" id="L167">                MegaMek.getLogger().warning(String.format(&quot;Ammo type %s not allowed by Clan rules&quot;, newAmmoType.getName()));</span>
<span class="nc" id="L168">                return null;</span>
            }
        }

<span class="nc bnc" id="L172" title="All 2 branches missed.">        if (AmmoType.canDeliverMinefield((AmmoType) newAmmoType)</span>
<span class="nc bnc" id="L173" title="All 2 branches missed.">                &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVANCED_MINEFIELDS)) {</span>
<span class="nc" id="L174">            MegaMek.getLogger().warning(String.format(&quot;Minefield-creating ammo type %s forbidden by game rules&quot;,</span>
<span class="nc" id="L175">                    newAmmoType.getName()));</span>
<span class="nc" id="L176">            return null;</span>
        }

<span class="nc bnc" id="L179" title="All 2 branches missed.">        int weaponAmmoType = (currentWeaponType instanceof WeaponType) ? ((WeaponType) currentWeaponType).getAmmoType() : 0;</span>
<span class="nc bnc" id="L180" title="All 2 branches missed.">        if ((((AmmoType) newAmmoType).getRackSize() == ((AmmoType) currentAmmoType).getRackSize())</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">                &amp;&amp; (newAmmoType.hasFlag(AmmoType.F_BATTLEARMOR) == currentAmmoType.hasFlag(AmmoType.F_BATTLEARMOR))</span>
<span class="nc bnc" id="L182" title="All 2 branches missed.">                &amp;&amp; (newAmmoType.hasFlag(AmmoType.F_ENCUMBERING) == currentAmmoType.hasFlag(AmmoType.F_ENCUMBERING))</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">                &amp;&amp; (newAmmoType.getTonnage(e) == currentAmmoType.getTonnage(e))</span>
<span class="nc bnc" id="L184" title="All 2 branches missed.">                &amp;&amp; (((AmmoType) newAmmoType).getAmmoType() == weaponAmmoType)) {</span>
<span class="nc" id="L185">            return (AmmoType) newAmmoType;</span>
        } else {
<span class="nc" id="L187">            return null;</span>
        }
    }

    /**
     * The damage procedures are built into a server object, so we delay dealing
     * the random damage until a server is made available to us.
     */
    public void applyDamage(Server s) {
<span class="nc bnc" id="L196" title="All 2 branches missed.">        for (DamagePlan damagePlan : damagePlans) {</span>
<span class="nc" id="L197">            MegaMek.getLogger().debug(String.format(&quot;Applying damage to %s&quot;, damagePlan.entity.getShortName()));</span>
<span class="nc bnc" id="L198" title="All 2 branches missed.">            for (int y = 0; y &lt; damagePlan.nBlocks; ++ y) {</span>
<span class="nc" id="L199">                HitData hit = damagePlan.entity.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L200">                MegaMek.getLogger().debug(&quot;[s.damageEntity(dp.entity, hit, 5)]&quot;);</span>
<span class="nc" id="L201">                s.damageEntity(damagePlan.entity, hit, 5);</span>
            }

            // Apply Spec Damage
<span class="nc bnc" id="L205" title="All 2 branches missed.">            for (SpecDam specDamage : damagePlan.specificDammage) {</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">                if (damagePlan.entity.locations() &lt;= specDamage.loc) {</span>
                    // location is valid
<span class="nc" id="L208">                    MegaMek.getLogger().error(String.format(&quot;\tInvalid location specified %d&quot;, specDamage.loc));</span>
                } else {
                    // Infantry only take damage to &quot;internal&quot;
<span class="nc bnc" id="L211" title="All 6 branches missed.">                    if (specDamage.internal</span>
                        || ((damagePlan.entity instanceof Infantry) &amp;&amp; !(damagePlan.entity instanceof BattleArmor))) {
<span class="nc bnc" id="L213" title="All 2 branches missed.">                        if (damagePlan.entity.getOInternal(specDamage.loc) &gt; specDamage.setArmorTo) {</span>
<span class="nc" id="L214">                            damagePlan.entity.setInternal(specDamage.setArmorTo, specDamage.loc);</span>
<span class="nc" id="L215">                            MegaMek.getLogger().debug(String.format(&quot;\tSet armor value for (internal %s) to %d&quot;,</span>
<span class="nc" id="L216">                                    damagePlan.entity.getLocationName(specDamage.loc), specDamage.setArmorTo));</span>
<span class="nc bnc" id="L217" title="All 2 branches missed.">                            if (specDamage.setArmorTo == 0) {</span>
<span class="nc" id="L218">                                MegaMek.getLogger().debug(String.format(&quot;\tSection destoyed %s&quot;,</span>
<span class="nc" id="L219">                                        damagePlan.entity.getLocationName(specDamage.loc)));</span>
<span class="nc" id="L220">                                damagePlan.entity.destroyLocation(specDamage.loc);</span>
                            }
                        }
                    } else {
<span class="nc bnc" id="L224" title="All 4 branches missed.">                        if (specDamage.rear &amp;&amp; damagePlan.entity.hasRearArmor(specDamage.loc)) {</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">                            if (damagePlan.entity.getOArmor(specDamage.loc, true) &gt; specDamage.setArmorTo) {</span>
<span class="nc" id="L226">                                MegaMek.getLogger().debug(String.format(&quot;\tSet armor value for (rear %s) to %d&quot;,</span>
<span class="nc" id="L227">                                        damagePlan.entity.getLocationName(specDamage.loc), specDamage.setArmorTo));</span>
<span class="nc" id="L228">                                damagePlan.entity.setArmor(specDamage.setArmorTo, specDamage.loc, true);</span>
                            }
                        } else {
<span class="nc bnc" id="L231" title="All 2 branches missed.">                            if (damagePlan.entity.getOArmor(specDamage.loc, false) &gt; specDamage.setArmorTo) {</span>
<span class="nc" id="L232">                                MegaMek.getLogger().debug(String.format(&quot;\tSet armor value for (%s) to %d&quot;,</span>
<span class="nc" id="L233">                                        damagePlan.entity.getLocationName(specDamage.loc), specDamage.setArmorTo));</span>

                                // Battle Armor Handled Differently
                                // If armor set to Zero kill the Armor sport
                                // which represents one member of the squad
<span class="nc bnc" id="L238" title="All 2 branches missed.">                                if (damagePlan.entity instanceof BattleArmor) {</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">                                    if (specDamage.setArmorTo == 0) {</span>
<span class="nc" id="L240">                                        damagePlan.entity.setArmor(IArmorState.ARMOR_DOOMED, specDamage.loc, false);</span>
<span class="nc" id="L241">                                        damagePlan.entity.setInternal(IArmorState.ARMOR_DOOMED, specDamage.loc);</span>
                                    } else {
                                        // For some reason setting armor to 1 will result in 2 armor points
                                        // left on the GUI. Dont know why but adjust here!
<span class="nc" id="L245">                                        damagePlan.entity.setArmor(specDamage.setArmorTo - 1, specDamage.loc);</span>
                                    }
                                } else {
<span class="nc" id="L248">                                    damagePlan.entity.setArmor(specDamage.setArmorTo, specDamage.loc);</span>
                                }
                            }
                        }
                    }
                }
<span class="nc" id="L254">            }</span>
<span class="nc" id="L255">        }</span>

        // Loop throught Crit Hits
<span class="nc bnc" id="L258" title="All 2 branches missed.">        for (CritHitPlan chp : critHitPlans) {</span>
<span class="nc" id="L259">            MegaMek.getLogger().debug(&quot;Applying critical hits to &quot; + chp.entity.getShortName());</span>
<span class="nc bnc" id="L260" title="All 2 branches missed.">            for (CritHit critHit : chp.critHits) {</span>
                // Apply a critical hit to the indicated slot.
<span class="nc bnc" id="L262" title="All 2 branches missed.">                if (chp.entity.locations() &lt;= critHit.loc) {</span>
<span class="nc" id="L263">                    MegaMek.getLogger().error(&quot;Invalid location specified &quot; + critHit.loc);</span>
                } else {
                    // Make sure that we have crit spot to hit
<span class="nc bnc" id="L266" title="All 4 branches missed.">                    if ((chp.entity instanceof Mech) || (chp.entity instanceof Protomech)) {</span>
                        // Is this a torso weapon slot?
<span class="nc" id="L268">                        CriticalSlot cs = null;</span>
<span class="nc bnc" id="L269" title="All 8 branches missed.">                        if ((chp.entity instanceof Protomech)</span>
                                &amp;&amp; (Protomech.LOC_TORSO == critHit.loc)
                                &amp;&amp; ((Protomech.SYSTEM_TORSO_WEAPON_A == critHit.slot) || (Protomech.SYSTEM_TORSO_WEAPON_B == critHit.slot))) {
<span class="nc" id="L272">                            cs = new CriticalSlot(CriticalSlot.TYPE_SYSTEM, critHit.slot);</span>
                        }
                        // Is this a valid slot number?
<span class="nc bnc" id="L275" title="All 2 branches missed.">                        else if ((critHit.slot &lt; 0)</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">                                || (critHit.slot &gt; chp.entity.getNumberOfCriticals(critHit.loc))) {</span>
<span class="nc" id="L277">                            MegaMek.getLogger().error(String.format(&quot;%s - invalid slot specified %d: %d&quot;,</span>
<span class="nc" id="L278">                                    chp.entity.getShortName(), critHit.loc, (critHit.slot + 1)));</span>
                        }
                        // Get the slot from the entity.
                        else {
<span class="nc" id="L282">                            cs = chp.entity.getCritical(critHit.loc, critHit.slot);</span>
                        }

                        // Ignore invalid, unhittable, and damaged slots.
<span class="nc bnc" id="L286" title="All 4 branches missed.">                        if ((null == cs) || !cs.isHittable()) {</span>
<span class="nc" id="L287">                            MegaMek.getLogger().error(String.format(&quot;%s - slot not hittable %d: %d&quot;,</span>
<span class="nc" id="L288">                                    chp.entity.getShortName(), critHit.loc, (critHit.slot + 1)));</span>
                        } else {
<span class="nc" id="L290">                            MegaMek.getLogger().debug(&quot;[s.applyCriticalHit(chp.entity, ch.loc, cs, false)]&quot;);</span>
<span class="nc" id="L291">                            s.applyCriticalHit(chp.entity, critHit.loc, cs, false, 0, false);</span>
                        }
<span class="nc" id="L293">                    }</span>
                    // Handle Tanks differently.
<span class="nc bnc" id="L295" title="All 2 branches missed.">                    else if (chp.entity instanceof Tank) {</span>
<span class="nc bnc" id="L296" title="All 4 branches missed.">                        if ((critHit.slot &lt; 0) || (critHit.slot &gt;= 6)) {</span>
<span class="nc" id="L297">                            MegaMek.getLogger().error(String.format(&quot;%s - invalid slot specified %d: %d&quot;,</span>
<span class="nc" id="L298">                                    chp.entity.getShortName(), critHit.loc, (critHit.slot + 1)));</span>
                        } else {
<span class="nc" id="L300">                            CriticalSlot cs = new CriticalSlot(CriticalSlot.TYPE_SYSTEM, critHit.slot + 1);</span>
<span class="nc" id="L301">                            MegaMek.getLogger().debug(&quot;[s.applyCriticalHit(chp.entity, ch.loc, cs, false)]&quot;);</span>
<span class="nc" id="L302">                            s.applyCriticalHit(chp.entity, Entity.NONE, cs, false, 0, false);</span>
                        }
                    }
                }
<span class="nc" id="L306">            }</span>
<span class="nc" id="L307">        }</span>

        // Loop throught Set Ammo To
<span class="nc bnc" id="L310" title="All 2 branches missed.">        for (SetAmmoPlan sap : ammoPlans) {</span>
<span class="nc" id="L311">            MegaMek.getLogger().debug(&quot;Applying ammo adjustment to &quot; + sap.entity.getShortName());</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">            for (SetAmmoType sa : sap.ammoSetType) {</span>
                // Limit to 'Mechs for now (needs to be extended later)
<span class="nc bnc" id="L314" title="All 2 branches missed.">                if (sap.entity instanceof Mech) {</span>
<span class="nc bnc" id="L315" title="All 2 branches missed.">                    if (sa.slot &lt; sap.entity.getNumberOfCriticals(sa.loc)) {</span>
<span class="nc" id="L316">                        CriticalSlot cs = sap.entity.getCritical(sa.loc, sa.slot);</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">                        if (cs != null) {</span>
<span class="nc" id="L318">                            Mounted ammo = sap.entity.getCritical(sa.loc, sa.slot).getMount();</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">                            if (ammo == null) {</span>
<span class="nc" id="L320">                                MegaMek.getLogger().error(String.format(&quot;%s - invalid slot specified %d: %d&quot;,</span>
<span class="nc" id="L321">                                        sap.entity.getShortName(), sa.loc, sa.slot + 1));</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">                            } else if (ammo.getType() instanceof AmmoType) {</span>
<span class="nc" id="L323">                                AmmoType newAmmoType = getValidAmmoType(s.getGame(), ammo, sa.type);</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">                                if (newAmmoType != null) {</span>
<span class="nc" id="L325">                                    ammo.changeAmmoType(newAmmoType);</span>
                                } else {
<span class="nc" id="L327">                                    MegaMek.getLogger().warning(String.format(&quot;Illegal ammo type '%s' for unit %s, slot %s&quot;,</span>
<span class="nc" id="L328">                                            sa.type, sap.entity.getDisplayName(), ammo.getName()));</span>
                                }
                            }
                        }
                    }
                }
<span class="nc" id="L334">            }</span>

<span class="nc bnc" id="L336" title="All 2 branches missed.">            for (SetAmmoTo sa : sap.ammoSetTo) {</span>
                // Only can be done against Mechs
<span class="nc bnc" id="L338" title="All 2 branches missed.">                if (sap.entity instanceof Mech) {</span>
<span class="nc bnc" id="L339" title="All 2 branches missed.">                    if (sa.slot &lt; sap.entity.getNumberOfCriticals(sa.loc)) {</span>
                        // Get the piece of equipment and check to make sure it
                        // is a ammo item then set its amount!
<span class="nc" id="L342">                        CriticalSlot cs = sap.entity.getCritical(sa.loc, sa.slot);</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">                        if (cs != null) {</span>
<span class="nc" id="L344">                            Mounted ammo = sap.entity.getCritical(sa.loc, sa.slot).getMount();</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">                            if (ammo == null) {</span>
<span class="nc" id="L346">                                MegaMek.getLogger().error(String.format(&quot;%s - invalid slot specified %d: %d&quot;,</span>
<span class="nc" id="L347">                                        sap.entity.getShortName(), sa.loc, sa.slot + 1));</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">                            } else if (ammo.getType() instanceof AmmoType) {</span>
                                // Also make sure we dont exceed the max allowed
<span class="nc" id="L350">                                ammo.setShotsLeft(Math.min(sa.setAmmoTo, ammo.getBaseShotsLeft()));</span>
                            }
                        }
                    }
                }
<span class="nc" id="L355">            }</span>
<span class="nc" id="L356">        }</span>
<span class="nc" id="L357">    }</span>

    public IGame createGame() throws Exception {
<span class="nc" id="L360">        MegaMek.getLogger().info(&quot;Loading scenario from &quot; + scenarioFile);</span>
<span class="nc" id="L361">        StringMultiMap p = load();</span>

<span class="nc" id="L363">        String sCheck = p.getString(PARAM_MMSVERSION);</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">        if (sCheck == null) {</span>
<span class="nc" id="L365">            throw new ScenarioLoaderException(&quot;missingMMSVersion&quot;);</span>
        }

<span class="nc" id="L368">        Game g = new Game();</span>

        // build the board
<span class="nc" id="L371">        g.board = createBoard(p);</span>

        // build the faction players
<span class="nc" id="L374">        Collection&lt;Player&gt; players = createPlayers(p);</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">        for (Player player : players) {</span>
<span class="nc" id="L376">            g.addPlayer(player.getId(), player);</span>
<span class="nc" id="L377">        }</span>

        // build the entities
<span class="nc" id="L380">        int entityId = 0;</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">        for (Player player : players) {</span>
<span class="nc" id="L382">            Collection&lt;Entity&gt; entities = buildFactionEntities(p, player);</span>
<span class="nc bnc" id="L383" title="All 2 branches missed.">            for (Entity entity : entities) {</span>
<span class="nc" id="L384">                entity.setOwner(player);</span>
<span class="nc" id="L385">                entity.setId(entityId);</span>
<span class="nc" id="L386">                ++ entityId;</span>
<span class="nc" id="L387">                g.addEntity(entity);</span>
<span class="nc" id="L388">            }</span>
<span class="nc" id="L389">        }</span>
        // game's ready
<span class="nc" id="L391">        g.getOptions().initialize();</span>
<span class="nc" id="L392">        String optionFile = p.getString(PARAM_GAME_OPTIONS_FILE);</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">        if (optionFile == null) {</span>
<span class="nc" id="L394">            g.getOptions().loadOptions();</span>
        } else {
<span class="nc" id="L396">            g.getOptions().loadOptions(new MegaMekFile(scenarioFile.getParentFile(), optionFile).getFile(), true);</span>
        }

        // set wind
<span class="nc" id="L400">        g.getPlanetaryConditions().determineWind();</span>

        // Set up the teams (for initiative)
<span class="nc" id="L403">        g.setupTeams();</span>

<span class="nc" id="L405">        g.setPhase(IGame.Phase.PHASE_STARTING_SCENARIO);</span>

<span class="nc" id="L407">        g.setupRoundDeployment();</span>

        // Read the external game id from the scenario file
<span class="nc" id="L410">        g.setExternalGameId(parseExternalGameId(p));</span>

<span class="nc" id="L412">        g.setVictoryContext(new HashMap&lt;&gt;());</span>
<span class="nc" id="L413">        g.createVictoryConditions();</span>

<span class="nc" id="L415">        return g;</span>
    }

    private Collection&lt;Entity&gt; buildFactionEntities(StringMultiMap p, IPlayer player) throws ScenarioLoaderException {
<span class="nc" id="L419">        String faction = player.getName();</span>
<span class="nc" id="L420">        Pattern unitPattern = Pattern.compile(String.format(&quot;^Unit_\\Q%s\\E_[^_]+$&quot;, faction));</span>
<span class="nc" id="L421">        Pattern unitDataPattern = Pattern.compile(String.format(&quot;^(Unit_\\Q%s\\E_[^_]+)_([A-Z][^_]+)$&quot;, faction));</span>

<span class="nc" id="L423">        Map&lt;String, Entity&gt; entities = new HashMap&lt;&gt;();</span>
        
        // Gather all defined units
<span class="nc bnc" id="L426" title="All 2 branches missed.">        for (String key : p.keySet()) {</span>
<span class="nc bnc" id="L427" title="All 4 branches missed.">            if (unitPattern.matcher(key).matches() &amp;&amp; (p.getNumValues(key) &gt; 0)) {</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">                if (p.getNumValues(key) &gt; 1) {</span>
<span class="nc" id="L429">                    MegaMek.getLogger().error(String.format(&quot;Scenario loading: Unit declaration %s found %d times&quot;,</span>
<span class="nc" id="L430">                            key, p.getNumValues(key)));</span>
<span class="nc" id="L431">                    throw new ScenarioLoaderException(&quot;multipleUnitDeclarations&quot;, key);</span>
                }
<span class="nc" id="L433">                entities.put(key, parseEntityLine(p.getString(key)));</span>
            }
<span class="nc" id="L435">        }</span>
        
        // Add other information
<span class="nc bnc" id="L438" title="All 2 branches missed.">        for (String key: p.keySet()) {</span>
<span class="nc" id="L439">            Matcher dataMatcher = unitDataPattern.matcher(key);</span>
<span class="nc bnc" id="L440" title="All 2 branches missed.">            if (dataMatcher.matches()) {</span>
<span class="nc" id="L441">                String unitKey = dataMatcher.group(1);</span>
<span class="nc bnc" id="L442" title="All 2 branches missed.">                if (!entities.containsKey(unitKey)) {</span>
<span class="nc" id="L443">                    MegaMek.getLogger().warning(&quot;Scenario loading: Data for undeclared unit encountered, ignoring: &quot; + key);</span>
<span class="nc" id="L444">                    continue;</span>
                }
<span class="nc" id="L446">                Entity e = entities.get(unitKey);</span>
<span class="nc bnc" id="L447" title="All 14 branches missed.">                switch (dataMatcher.group(2)) {</span>
                    case PARAM_DAMAGE:
<span class="nc bnc" id="L449" title="All 2 branches missed.">                        for (String val : p.get(key)) {</span>
<span class="nc" id="L450">                            damagePlans.add(new DamagePlan(e, Integer.parseInt(val)));</span>
<span class="nc" id="L451">                        }</span>
<span class="nc" id="L452">                        break;</span>
                    case PARAM_SPECIFIC_DAMAGE:
<span class="nc" id="L454">                        DamagePlan dp = new DamagePlan(e);</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">                        for (String val : p.getString(key).split(SEPARATOR_COMMA, -1)) {</span>
<span class="nc" id="L456">                            dp.addSpecificDamage(val);</span>
                        }
<span class="nc" id="L458">                        damagePlans.add(dp);</span>
<span class="nc" id="L459">                        break;</span>
                    case PARAM_CRITICAL_HIT:
<span class="nc" id="L461">                        CritHitPlan chp = new CritHitPlan(e);</span>
<span class="nc bnc" id="L462" title="All 2 branches missed.">                        for (String val : p.getString(key).split(SEPARATOR_COMMA, -1)) {</span>
<span class="nc" id="L463">                            chp.addCritHit(val);</span>
                        }
<span class="nc" id="L465">                        critHitPlans.add(chp);</span>
<span class="nc" id="L466">                        break;</span>
                    case PARAM_AMMO_AMOUNT:
<span class="nc" id="L468">                        SetAmmoPlan amountSap = new SetAmmoPlan(e);</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">                        for (String val : p.getString(key).split(SEPARATOR_COMMA, -1)) {</span>
<span class="nc" id="L470">                            amountSap.addSetAmmoTo(val);</span>
                        }
<span class="nc" id="L472">                        ammoPlans.add(amountSap);</span>
<span class="nc" id="L473">                        break;</span>
                    case PARAM_AMMO_TYPE:
<span class="nc" id="L475">                        SetAmmoPlan typeSap = new SetAmmoPlan(e);</span>
<span class="nc bnc" id="L476" title="All 2 branches missed.">                        for (String val : p.getString(key).split(SEPARATOR_COMMA, -1)) {</span>
<span class="nc" id="L477">                            typeSap.addSetAmmoType(val);</span>
                        }
<span class="nc" id="L479">                        ammoPlans.add(typeSap);</span>
<span class="nc" id="L480">                        break;</span>
                    case PARAM_PILOT_HITS:
<span class="nc" id="L482">                        int hits = Integer.parseInt(p.getString(key));</span>
<span class="nc" id="L483">                        e.getCrew().setHits(Math.min(hits, 5), 0);</span>
<span class="nc" id="L484">                        break;</span>
                    case PARAM_EXTERNAL_ID:
<span class="nc" id="L486">                        e.setExternalIdAsString(p.getString(key));</span>
<span class="nc" id="L487">                        break;</span>
                    case PARAM_ADVANTAGES:
<span class="nc" id="L489">                        parseAdvantages(e, p.getString(key, SEPARATOR_SPACE));</span>
<span class="nc" id="L490">                        break;</span>
                    case PARAM_AUTO_EJECT:
<span class="nc" id="L492">                        parseAutoEject(e, p.getString(key));</span>
<span class="nc" id="L493">                        break;</span>
                    case PARAM_COMMANDER:
<span class="nc" id="L495">                        parseCommander(e, p.getString(key));</span>
<span class="nc" id="L496">                        break;</span>
                    case PARAM_DEPLOYMENT_ROUND:
<span class="nc" id="L498">                        int round = Integer.parseInt(p.getString(key));</span>
<span class="nc bnc" id="L499" title="All 2 branches missed.">                        if (round &gt; 0) {</span>
<span class="nc" id="L500">                            MegaMek.getLogger().debug(String.format(&quot;%s will be deployed before round %d&quot;,</span>
<span class="nc" id="L501">                                e.getDisplayName(), round));</span>
<span class="nc" id="L502">                            e.setDeployRound(round);</span>
<span class="nc" id="L503">                            e.setDeployed(false);</span>
<span class="nc" id="L504">                            e.setNeverDeployed(false);</span>
<span class="nc" id="L505">                            e.setPosition(null);</span>
                        }
                        break;
                    case PARAM_CAMO:
<span class="nc" id="L509">                        parseCamo(e, p.getString(key));</span>
<span class="nc" id="L510">                        break;</span>
                    case PARAM_ALTITUDE:
<span class="nc" id="L512">                        int altitude = Math.min(Integer.parseInt(p.getString(key)), 10);</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">                        if (e.isAero()) {</span>
<span class="nc" id="L514">                            e.setAltitude(altitude);</span>
<span class="nc bnc" id="L515" title="All 2 branches missed.">                            if (altitude &lt;= 0) {</span>
<span class="nc" id="L516">                                ((IAero) e).land();</span>
                            }
                        } else {
<span class="nc" id="L519">                            MegaMek.getLogger().warning(String.format(&quot;Altitude setting for a non-aerospace unit %s; ignoring&quot;,</span>
<span class="nc" id="L520">                                    e.getShortName()));</span>
                        }
<span class="nc" id="L522">                        break;</span>
                    default:
<span class="nc" id="L524">                        MegaMek.getLogger().error(&quot;Scenario loading: Unknown unit data key &quot; + key);</span>
                }
            }
<span class="nc" id="L527">        }</span>
        
<span class="nc" id="L529">        return entities.values();</span>
    }

    private Entity parseEntityLine(String s) throws ScenarioLoaderException {
        try {
<span class="nc" id="L534">            String[] parts = s.split(SEPARATOR_COMMA, -1);</span>
            int i;
<span class="nc" id="L536">            MechSummary ms = MechSummaryCache.getInstance().getMech(parts[0]);</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">            if (ms == null) {</span>
<span class="nc" id="L538">                throw new ScenarioLoaderException(&quot;missingRequiredEntity&quot;, parts[0]);</span>
            }
<span class="nc" id="L540">            MegaMek.getLogger().debug(String.format(&quot;Loading %s&quot;, ms.getName()));</span>
<span class="nc" id="L541">            Entity e = new MechFileParser(ms.getSourceFile(), ms.getEntryName()).getEntity();</span>

            // The following section is used to determine if part 4 of the string includes gender or not
            // The regex is used to match a number that might be negative. As the direction is never
            // a number, if a number is found it must be gender.
            // The i value must be included to ensure that the correct indexes are used for the
            // direction calculation below.
<span class="nc bnc" id="L548" title="All 4 branches missed.">            if ((parts.length &gt; 4) &amp;&amp; parts[4].matches(&quot;-?\\d+&quot;)) {</span>
<span class="nc" id="L549">                e.setCrew(new Crew(e.getCrew().getCrewType(), parts[1], 1,</span>
<span class="nc" id="L550">                        Integer.parseInt(parts[2]), Integer.parseInt(parts[3]),</span>
<span class="nc" id="L551">                        Gender.parseFromString(parts[4]), null));</span>
<span class="nc" id="L552">                i = 5; // direction will be part 5, as the scenario has the gender of its pilots included</span>
            } else {
<span class="nc" id="L554">                e.setCrew(new Crew(e.getCrew().getCrewType(), parts[1], 1,</span>
<span class="nc" id="L555">                        Integer.parseInt(parts[2]), Integer.parseInt(parts[3]),</span>
<span class="nc" id="L556">                        RandomGenderGenerator.generate(), null));</span>
<span class="nc" id="L557">                i = 4; // direction will be part 4, as the scenario does not contain gender</span>
            }

            // This uses the i value to ensure it is calculated correctly
<span class="nc bnc" id="L561" title="All 2 branches missed.">            if (parts.length &gt;= 7) {</span>
<span class="nc" id="L562">                String direction = parts[i++].toUpperCase(Locale.ROOT); //grab value at i, then increment</span>
<span class="nc bnc" id="L563" title="All 7 branches missed.">                switch (direction) {</span>
                    case &quot;N&quot;:
<span class="nc" id="L565">                        e.setFacing(0);</span>
<span class="nc" id="L566">                        break;</span>
                    case &quot;NW&quot;:
<span class="nc" id="L568">                        e.setFacing(5);</span>
<span class="nc" id="L569">                        break;</span>
                    case &quot;SW&quot;:
<span class="nc" id="L571">                        e.setFacing(4);</span>
<span class="nc" id="L572">                        break;</span>
                    case &quot;S&quot;:
<span class="nc" id="L574">                        e.setFacing(3);</span>
<span class="nc" id="L575">                        break;</span>
                    case &quot;SE&quot;:
<span class="nc" id="L577">                        e.setFacing(2);</span>
<span class="nc" id="L578">                        break;</span>
                    case &quot;NE&quot;:
<span class="nc" id="L580">                        e.setFacing(1);</span>
<span class="nc" id="L581">                        break;</span>
                    default:
                        break;
                }
<span class="nc" id="L585">                int x = Integer.parseInt(parts[i++]) - 1;</span>
<span class="nc" id="L586">                int y = Integer.parseInt(parts[i]) - 1;</span>
<span class="nc" id="L587">                e.setPosition(new Coords(x, y));</span>
<span class="nc" id="L588">                e.setDeployed(true);</span>
            }
<span class="nc" id="L590">            return e;</span>
<span class="nc" id="L591">        } catch (NumberFormatException | IndexOutOfBoundsException | EntityLoadingException ex) {</span>
<span class="nc" id="L592">            MegaMek.getLogger().error(ex);</span>
<span class="nc" id="L593">            throw new ScenarioLoaderException(&quot;unparsableEntityLine&quot;, s);</span>
        }
    }

    private void parseAdvantages(Entity entity, String adv) {
<span class="nc" id="L598">        String[] advantages = adv.split(SEPARATOR_SPACE, -1);</span>

<span class="nc bnc" id="L600" title="All 2 branches missed.">        for (String curAdv : advantages) {</span>
<span class="nc" id="L601">            String[] advantageData = curAdv.split(SEPARATOR_COLON, -1);</span>
<span class="nc" id="L602">            IOption option = entity.getCrew().getOptions().getOption(advantageData[0]);</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">            if (option == null) {</span>
<span class="nc" id="L604">                MegaMek.getLogger().error(String.format(&quot;Ignoring invalid pilot advantage '%s'&quot;, curAdv));</span>
            } else {
<span class="nc" id="L606">                MegaMek.getLogger().debug(String.format(&quot;Adding pilot advantage '%s' to %s&quot;,</span>
<span class="nc" id="L607">                        curAdv, entity.getDisplayName()));</span>
<span class="nc bnc" id="L608" title="All 2 branches missed.">                if (advantageData.length &gt; 1) {</span>
<span class="nc" id="L609">                    option.setValue(advantageData[1]);</span>
                } else {
<span class="nc" id="L611">                    option.setValue(true);</span>
                }
            }
        }
<span class="nc" id="L615">    }</span>

    private void parseAutoEject(Entity entity, String eject) {
<span class="nc bnc" id="L618" title="All 2 branches missed.">        if (entity instanceof Mech) {</span>
<span class="nc" id="L619">            Mech mech = (Mech) entity;</span>
<span class="nc" id="L620">            mech.setAutoEject(Boolean.parseBoolean(eject));</span>
        }
<span class="nc" id="L622">    }</span>

    private void parseCommander(Entity entity, String commander) {
<span class="nc" id="L625">        entity.setCommander(Boolean.parseBoolean(commander));</span>
<span class="nc" id="L626">    }</span>

    private String getValidCamoGroup(String camoGroup) {
        // Translate base categories for userfriendliness.
<span class="nc bnc" id="L630" title="All 4 branches missed.">        if (camoGroup.equals(&quot;No Camo&quot;) || camoGroup.equals(&quot;None&quot;)) {</span>
<span class="nc" id="L631">            camoGroup = Camouflage.NO_CAMOUFLAGE;</span>
<span class="nc bnc" id="L632" title="All 2 branches missed.">        } else if (camoGroup.equals(&quot;General&quot;)) {</span>
<span class="nc" id="L633">            camoGroup = AbstractIcon.ROOT_CATEGORY;</span>
        } else {
            // If CamoGroup does not have a trailing slash, add one, since all
            // subdirectories require it
<span class="nc bnc" id="L637" title="All 2 branches missed.">            if (camoGroup.charAt(camoGroup.length() - 1) != '/') {</span>
<span class="nc" id="L638">                camoGroup += &quot;/&quot;; //$NON-NLS-1$</span>
            }
        }
        
<span class="nc" id="L642">        boolean validGroup = false;</span>

<span class="nc bnc" id="L644" title="All 4 branches missed.">        if (Camouflage.NO_CAMOUFLAGE.equals(camoGroup) || AbstractIcon.ROOT_CATEGORY.equals(camoGroup)) {</span>
<span class="nc" id="L645">            validGroup = true;</span>
        } else {
<span class="nc" id="L647">            Iterator&lt;String&gt; catNames = MMStaticDirectoryManager.getCamouflage().getCategoryNames();</span>
<span class="nc bnc" id="L648" title="All 2 branches missed.">            while (catNames.hasNext()) {</span>
<span class="nc" id="L649">                String s = catNames.next();</span>
<span class="nc bnc" id="L650" title="All 2 branches missed.">                if (s.equals(camoGroup)) {</span>
<span class="nc" id="L651">                    validGroup = true;</span>
                }
<span class="nc" id="L653">            }</span>
        }

<span class="nc bnc" id="L656" title="All 2 branches missed.">        return validGroup ? camoGroup : null;</span>
    }
    
    private String getValidCamoName(String camoGroup, String camoName) {
<span class="nc" id="L660">        boolean validName = false;</span>

        // Validate CamoName
<span class="nc bnc" id="L663" title="All 4 branches missed.">        if (Camouflage.NO_CAMOUFLAGE.equals(camoGroup) &amp;&amp; !StringUtil.isNullOrEmpty(camoGroup)) {</span>
<span class="nc" id="L664">            return PlayerColour.parseFromString(camoName).name();</span>
        } else {
            Iterator&lt;String&gt; camoNames;
<span class="nc bnc" id="L667" title="All 2 branches missed.">            if (AbstractIcon.ROOT_CATEGORY.equals(camoGroup)) {</span>
<span class="nc" id="L668">                camoNames = MMStaticDirectoryManager.getCamouflage().getItemNames(&quot;&quot;);</span>
            } else {
<span class="nc" id="L670">                camoNames = MMStaticDirectoryManager.getCamouflage().getItemNames(camoGroup);</span>
            }
<span class="nc bnc" id="L672" title="All 2 branches missed.">            while (camoNames.hasNext()) {</span>
<span class="nc" id="L673">                String s = camoNames.next();</span>
<span class="nc bnc" id="L674" title="All 2 branches missed.">                if (s.equals(camoName)) {</span>
<span class="nc" id="L675">                    validName = true;</span>
                }
<span class="nc" id="L677">            }</span>
        }
        
<span class="nc bnc" id="L680" title="All 2 branches missed.">        return validName ? camoName : null;</span>
    }
    
    /*
     * Camo Parser/Validator for Individual Entity Camo
     */
    private void parseCamo(Entity entity, String camoString) throws ScenarioLoaderException {
<span class="nc" id="L687">        String[] camoData = camoString.split(SEPARATOR_COMMA, -1);</span>
<span class="nc" id="L688">        String camoGroup = getValidCamoGroup(camoData[0]);</span>
<span class="nc bnc" id="L689" title="All 2 branches missed.">        if (camoGroup == null) {</span>
<span class="nc" id="L690">            throw new ScenarioLoaderException(&quot;invalidIndividualCamoGroup&quot;,</span>
<span class="nc" id="L691">                camoData[0], entity.getDisplayName());</span>
        }
<span class="nc" id="L693">        String camoName = getValidCamoName(camoGroup, camoData[1]);</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">        if (camoName == null) {</span>
<span class="nc" id="L695">            throw new ScenarioLoaderException(&quot;invalidIndividualCamoName&quot;,</span>
<span class="nc" id="L696">                camoData[1], camoGroup, entity.getDisplayName());</span>
        }

<span class="nc" id="L699">        entity.setCamoCategory(camoGroup);</span>
<span class="nc" id="L700">        entity.setCamoFileName(camoName);</span>
<span class="nc" id="L701">    }</span>

    /*
     * Camo Parser/Validator for Faction Camo
     */
    private void parseCamo(IPlayer player, String camoString) throws ScenarioLoaderException {
<span class="nc" id="L707">        String[] camoData = camoString.split(SEPARATOR_COMMA, -1);</span>
<span class="nc" id="L708">        String camoGroup = getValidCamoGroup(camoData[0]);</span>
<span class="nc bnc" id="L709" title="All 2 branches missed.">        if (camoGroup == null) {</span>
<span class="nc" id="L710">            throw new ScenarioLoaderException(&quot;invalidFactionCamoGroup&quot;,</span>
<span class="nc" id="L711">                camoData[0], player.getName());</span>
        }
<span class="nc" id="L713">        String camoName = getValidCamoName(camoGroup, camoData[1]);</span>
<span class="nc bnc" id="L714" title="All 2 branches missed.">        if (camoName == null) {</span>
<span class="nc" id="L715">            throw new ScenarioLoaderException(&quot;invalidFactionCamoName&quot;,</span>
<span class="nc" id="L716">                camoData[1], camoGroup, player.getName());</span>
        }

<span class="nc" id="L719">        player.setCamoCategory(camoGroup);</span>
<span class="nc" id="L720">        player.setCamoFileName(camoName);</span>
<span class="nc" id="L721">    }</span>

    private int findIndex(String[] sa, String s) {
<span class="nc bnc" id="L724" title="All 2 branches missed.">        for (int x = 0; x &lt; sa.length; x++) {</span>
<span class="nc bnc" id="L725" title="All 2 branches missed.">            if (sa[x].equalsIgnoreCase(s)) {</span>
<span class="nc" id="L726">                return x;</span>
            }
        }
<span class="nc" id="L729">        return -1;</span>
    }

    private String getFactionParam(String faction, String param) {
<span class="nc" id="L733">        return param + SEPARATOR_UNDERSCORE + faction;</span>
    }
    
    private Collection&lt;Player&gt; createPlayers(StringMultiMap p) throws ScenarioLoaderException {
<span class="nc" id="L737">        String sFactions = p.getString(PARAM_FACTIONS);</span>
<span class="nc bnc" id="L738" title="All 4 branches missed.">        if ((sFactions == null) || sFactions.isEmpty()) {</span>
<span class="nc" id="L739">            throw new ScenarioLoaderException(&quot;missingFactions&quot;);</span>
        }
<span class="nc" id="L741">        String[] factions = sFactions.split(SEPARATOR_COMMA, -1);</span>
<span class="nc" id="L742">        List&lt;Player&gt; result = new ArrayList&lt;&gt;(factions.length);</span>

<span class="nc" id="L744">        int playerId = 0;</span>
<span class="nc" id="L745">        int teamId = 0;</span>
<span class="nc bnc" id="L746" title="All 2 branches missed.">        for (String faction : factions) {</span>
<span class="nc" id="L747">            Player player = new Player(playerId, faction);</span>
<span class="nc" id="L748">            result.add(player);</span>
<span class="nc" id="L749">            playerId++;</span>

            // scenario players start out as ghosts to be logged into
<span class="nc" id="L752">            player.setGhost(true);</span>
            
<span class="nc" id="L754">            String loc = p.getString(getFactionParam(faction, PARAM_LOCATION));</span>
<span class="nc bnc" id="L755" title="All 2 branches missed.">            if (loc == null) {</span>
<span class="nc" id="L756">                loc = &quot;Any&quot;;</span>
            }
<span class="nc" id="L758">            int dir = Math.max(findIndex(IStartingPositions.START_LOCATION_NAMES, loc), 0);</span>
<span class="nc" id="L759">            player.setStartingPos(dir);</span>
            
<span class="nc" id="L761">            String camo = p.getString(getFactionParam(faction, PARAM_CAMO));</span>
<span class="nc bnc" id="L762" title="All 4 branches missed.">            if ((camo != null) &amp;&amp; !camo.isEmpty()) {</span>
<span class="nc" id="L763">                parseCamo(player, camo);</span>
            }
            
<span class="nc" id="L766">            String team = p.getString(getFactionParam(faction, PARAM_TEAM));</span>
<span class="nc bnc" id="L767" title="All 4 branches missed.">            if ((team != null) &amp;&amp; !team.isEmpty()) {</span>
                try {
<span class="nc" id="L769">                    teamId = Integer.parseInt(team);</span>
<span class="nc" id="L770">                } catch(NumberFormatException ignored) {</span>
<span class="nc" id="L771">                    teamId++;</span>
<span class="nc" id="L772">                }</span>
            } else {
<span class="nc" id="L774">                teamId++;</span>
            }
<span class="nc" id="L776">            player.setTeam(Math.min(teamId, IPlayer.MAX_TEAMS - 1));</span>
            
<span class="nc" id="L778">            String minefields = p.getString(getFactionParam(faction, PARAM_MINEFIELDS));</span>
<span class="nc bnc" id="L779" title="All 4 branches missed.">            if ((minefields != null) &amp;&amp; !minefields.isEmpty()) {</span>
<span class="nc" id="L780">                String[] mines = minefields.split(SEPARATOR_COMMA, -1);</span>
<span class="nc bnc" id="L781" title="All 2 branches missed.">                if (mines.length &gt;= 3) {</span>
                    try {
<span class="nc" id="L783">                        int minesConventional = Integer.parseInt(mines[0]);</span>
<span class="nc" id="L784">                        int minesCommand = Integer.parseInt(mines[1]);</span>
<span class="nc" id="L785">                        int minesVibra = Integer.parseInt(mines[2]);</span>
<span class="nc" id="L786">                        player.setNbrMFConventional(minesConventional);</span>
<span class="nc" id="L787">                        player.setNbrMFCommand(minesCommand);</span>
<span class="nc" id="L788">                        player.setNbrMFVibra(minesVibra);</span>
<span class="nc" id="L789">                    } catch (NumberFormatException nfex) {</span>
<span class="nc" id="L790">                        MegaMek.getLogger().error(String.format(&quot;Format error with minefields string '%s' for %s&quot;,</span>
                                minefields, faction));
<span class="nc" id="L792">                    }</span>
                }
            }
        }
        
<span class="nc" id="L797">        return result;</span>
    }

    /**
     * Load board files and create the megaboard.
     */
    private IBoard createBoard(StringMultiMap p) throws ScenarioLoaderException {
<span class="nc" id="L804">        int mapWidth = 16, mapHeight = 17;</span>
<span class="nc bnc" id="L805" title="All 2 branches missed.">        if (p.getString(PARAM_MAP_WIDTH) == null) {</span>
<span class="nc" id="L806">            MegaMek.getLogger().info(&quot;No map width specified; using &quot; + mapWidth);</span>
        } else {
<span class="nc" id="L808">            mapWidth = Integer.parseInt(p.getString(PARAM_MAP_WIDTH));</span>
        }

<span class="nc bnc" id="L811" title="All 2 branches missed.">        if (p.getString(PARAM_MAP_HEIGHT) == null) {</span>
<span class="nc" id="L812">            MegaMek.getLogger().info(&quot;No map height specified; using &quot; + mapHeight);</span>
        } else {
<span class="nc" id="L814">            mapHeight = Integer.parseInt(p.getString(PARAM_MAP_HEIGHT));</span>
        }

<span class="nc" id="L817">        int nWidth = 1, nHeight = 1;</span>
<span class="nc bnc" id="L818" title="All 2 branches missed.">        if (p.getString(PARAM_BOARD_WIDTH) == null) {</span>
<span class="nc" id="L819">            MegaMek.getLogger().info(&quot;No board width specified; using &quot; + nWidth);</span>
        } else {
<span class="nc" id="L821">            nWidth = Integer.parseInt(p.getString(PARAM_BOARD_WIDTH));</span>
        }

<span class="nc bnc" id="L824" title="All 2 branches missed.">        if (p.getString(PARAM_BOARD_HEIGHT) == null) {</span>
<span class="nc" id="L825">            MegaMek.getLogger().info(&quot;No board height specified; using &quot; + nHeight);</span>
        } else {
<span class="nc" id="L827">            nHeight = Integer.parseInt(p.getString(PARAM_BOARD_HEIGHT));</span>
        }

<span class="nc" id="L830">        MegaMek.getLogger().debug(String.format(&quot;Mapsheets are %d by %d hexes.&quot;, mapWidth, mapHeight));</span>
<span class="nc" id="L831">        MegaMek.getLogger().debug(String.format(&quot;Constructing %d by %d board.&quot;, nWidth, nHeight));</span>
<span class="nc" id="L832">        int cf = 0;</span>
<span class="nc bnc" id="L833" title="All 2 branches missed.">        if (p.getString(PARAM_BRIDGE_CF) == null) {</span>
<span class="nc" id="L834">            MegaMek.getLogger().debug(&quot;No CF for bridges defined. Using map file defaults.&quot;);</span>
        } else {
<span class="nc" id="L836">            cf = Integer.parseInt(p.getString(PARAM_BRIDGE_CF));</span>
<span class="nc" id="L837">            MegaMek.getLogger().debug(&quot;Overriding map-defined bridge CFs with &quot; + cf);</span>
        }
        // load available boards
        // basically copied from Server.java. Should get moved somewhere neutral
<span class="nc" id="L841">        List&lt;String&gt; boards = new ArrayList&lt;&gt;();</span>

        // Find subdirectories given in the scenario file
<span class="nc" id="L844">        List&lt;String&gt; allDirs = new LinkedList&lt;&gt;();</span>
        // &quot;&quot; entry stands for the boards base directory 
<span class="nc" id="L846">        allDirs.add(&quot;&quot;);</span>

<span class="nc bnc" id="L848" title="All 2 branches missed.">        if (p.getString(PARAM_MAP_DIRECTORIES) != null) {</span>
<span class="nc" id="L849">            allDirs = Arrays.asList(p.getString(PARAM_MAP_DIRECTORIES)</span>
<span class="nc" id="L850">                    .split(SEPARATOR_COMMA, -1));</span>
        }

<span class="nc bnc" id="L853" title="All 2 branches missed.">        for (String dir: allDirs) {</span>
<span class="nc" id="L854">            File curDir = new File(Configuration.boardsDir(), dir);</span>
<span class="nc bnc" id="L855" title="All 2 branches missed.">            if (curDir.exists()) {</span>
<span class="nc bnc" id="L856" title="All 2 branches missed.">                for (String file : curDir.list()) {</span>
<span class="nc bnc" id="L857" title="All 2 branches missed.">                    if (file.toLowerCase(Locale.ROOT).endsWith(FILE_SUFFIX_BOARD)) {</span>
<span class="nc" id="L858">                        boards.add(dir+&quot;/&quot;+file.substring(0, file.length() - FILE_SUFFIX_BOARD.length()));</span>
                    }
                }
            }
<span class="nc" id="L862">        }</span>

<span class="nc" id="L864">        IBoard[] ba = new IBoard[nWidth * nHeight];</span>
<span class="nc" id="L865">        Queue&lt;String&gt; maps = new LinkedList&lt;&gt;(</span>
<span class="nc" id="L866">            Arrays.asList(p.getString(PARAM_MAPS).split(SEPARATOR_COMMA, -1)));</span>
<span class="nc" id="L867">        List&lt;Boolean&gt; rotateBoard = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L868" title="All 2 branches missed.">        for (int x = 0; x &lt; nWidth; x++) {</span>
<span class="nc bnc" id="L869" title="All 2 branches missed.">            for (int y = 0; y &lt; nHeight; y++) {</span>
<span class="nc" id="L870">                int n = (y * nWidth) + x;</span>
<span class="nc" id="L871">                String board = MAP_RANDOM;</span>
<span class="nc bnc" id="L872" title="All 2 branches missed.">                if (!maps.isEmpty()) {</span>
<span class="nc" id="L873">                    board = maps.poll();</span>
                }
<span class="nc" id="L875">                MegaMek.getLogger().debug(String.format(&quot;(%d,%d) %s&quot;, x, y, board));</span>

<span class="nc" id="L877">                boolean isRotated = false;</span>
<span class="nc bnc" id="L878" title="All 2 branches missed.">                if (board.startsWith(Board.BOARD_REQUEST_ROTATION)) {</span>
<span class="nc" id="L879">                    isRotated = true;</span>
<span class="nc" id="L880">                    board = board.substring(Board.BOARD_REQUEST_ROTATION.length());</span>
                }

                String sBoardFile;
<span class="nc bnc" id="L884" title="All 2 branches missed.">                if (board.equals(MAP_RANDOM)) {</span>
<span class="nc" id="L885">                    sBoardFile = (boards.get(Compute.randomInt(boards.size()))) + FILE_SUFFIX_BOARD;</span>
                } else {
<span class="nc" id="L887">                    sBoardFile = board + FILE_SUFFIX_BOARD;</span>
                }
<span class="nc" id="L889">                File fBoard = new MegaMekFile(Configuration.boardsDir(), sBoardFile).getFile();</span>
<span class="nc bnc" id="L890" title="All 2 branches missed.">                if (!fBoard.exists()) {</span>
<span class="nc" id="L891">                    throw new ScenarioLoaderException(&quot;nonexistantBoard&quot;, board);</span>
                }
<span class="nc" id="L893">                ba[n] = new Board();</span>
<span class="nc" id="L894">                ba[n].load(new MegaMekFile(Configuration.boardsDir(), sBoardFile).getFile());</span>
<span class="nc bnc" id="L895" title="All 2 branches missed.">                if (cf &gt; 0) {</span>
<span class="nc" id="L896">                    ba[n].setBridgeCF(cf);</span>
                }
<span class="nc" id="L898">                BoardUtilities.flip(ba[n], isRotated, isRotated);</span>
<span class="nc" id="L899">                rotateBoard.add(isRotated);</span>
            }
        }

        // if only one board just return it.
<span class="nc bnc" id="L904" title="All 2 branches missed.">        if (ba.length == 1) {</span>
<span class="nc" id="L905">            return ba[0];</span>
        }
        // construct the big board
<span class="nc" id="L908">        return BoardUtilities.combine(mapWidth, mapHeight, nWidth, nHeight, ba, rotateBoard, MapSettings.MEDIUM_GROUND);</span>
    }

    private StringMultiMap load() throws ScenarioLoaderException {
<span class="nc" id="L912">        StringMultiMap props = new StringMultiMap();</span>
<span class="nc" id="L913">        try (BufferedReader reader = new BufferedReader(new InputStreamReader(new FileInputStream(scenarioFile), StandardCharsets.UTF_8))) {</span>
            String line;
<span class="nc" id="L915">            int lineNum = 0;</span>
<span class="nc bnc" id="L916" title="All 2 branches missed.">            while ((line = reader.readLine()) != null) {</span>
<span class="nc" id="L917">                lineNum++;</span>
<span class="nc" id="L918">                line = line.trim();</span>
<span class="nc bnc" id="L919" title="All 4 branches missed.">                if (line.startsWith(COMMENT_MARK) || (line.length() == 0)) {</span>
<span class="nc" id="L920">                    continue;</span>
<span class="nc bnc" id="L921" title="All 2 branches missed.">                } else if (!line.contains(SEPARATOR_PROPERTY)) {</span>
<span class="nc" id="L922">                    MegaMek.getLogger().error(String.format(&quot;Equality sign in scenario file %s on line %d missing; ignoring&quot;,</span>
<span class="nc" id="L923">                            scenarioFile, lineNum));</span>
<span class="nc" id="L924">                    continue;</span>
                }
<span class="nc" id="L926">                String[] elements = line.split(SEPARATOR_PROPERTY, -1);</span>
<span class="nc bnc" id="L927" title="All 2 branches missed.">                if (elements.length &gt; 2) {</span>
<span class="nc" id="L928">                    MegaMek.getLogger().error(String.format(&quot;Multiple equality signs in scenario file %s on line %d; ignoring&quot;,</span>
<span class="nc" id="L929">                            scenarioFile, lineNum));</span>
<span class="nc" id="L930">                    continue;</span>
                }
<span class="nc" id="L932">                props.put(elements[0].trim(), elements[1].trim());</span>
<span class="nc" id="L933">            }</span>
<span class="nc" id="L934">        } catch (IOException e) {</span>
<span class="nc" id="L935">            MegaMek.getLogger().error(e);</span>
<span class="nc" id="L936">            throw new ScenarioLoaderException(&quot;exceptionReadingFile&quot;, scenarioFile);</span>
<span class="nc" id="L937">        }</span>
<span class="nc" id="L938">        return props;</span>
    }

    /**
     * Parses out the external game id from the scenario file
     */
    private int parseExternalGameId(StringMultiMap p) {
<span class="nc" id="L945">        String sExternalId = p.getString(PARAM_GAME_EXTERNAL_ID);</span>
<span class="nc" id="L946">        int ExternalGameId = 0;</span>
<span class="nc bnc" id="L947" title="All 2 branches missed.">        if (sExternalId != null) {</span>
<span class="nc" id="L948">            ExternalGameId = Integer.parseInt(sExternalId);</span>
        }
<span class="nc" id="L950">        return ExternalGameId;</span>
    }

    public static void main(String[] saArgs) throws Exception {
<span class="nc" id="L954">        ScenarioLoader sl = new ScenarioLoader(new File(saArgs[0]));</span>
<span class="nc" id="L955">        IGame g = sl.createGame();</span>
<span class="nc bnc" id="L956" title="All 2 branches missed.">        if (g != null) {</span>
<span class="nc" id="L957">            MegaMek.getLogger().info(&quot;Successfully loaded.&quot;);</span>
        }
<span class="nc" id="L959">    }</span>

    /**
     * This is used specify the critical hit location
     */
    private static class CritHit {
        public int loc;
        public int slot;

<span class="nc" id="L968">        public CritHit(int l, int s) {</span>
<span class="nc" id="L969">            loc = l;</span>
<span class="nc" id="L970">            slot = s;</span>
<span class="nc" id="L971">        }</span>
    }

    /**
     * This class is used to store the critical hit plan for a entity it is
     * loaded from the scenario file. It contains a vector of CritHit.
     */
    private class CritHitPlan {
        public Entity entity;
<span class="nc" id="L980">        List&lt;CritHit&gt; critHits = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L982">        public CritHitPlan(Entity e) {</span>
<span class="nc" id="L983">            entity = e;</span>
<span class="nc" id="L984">        }</span>

        public void addCritHit(String s) {
<span class="nc" id="L987">            int ewSpot = s.indexOf(':');</span>
<span class="nc" id="L988">            int loc = Integer.parseInt(s.substring(0, ewSpot));</span>
<span class="nc" id="L989">            int slot = Integer.parseInt(s.substring(ewSpot + 1));</span>
            
<span class="nc" id="L991">            critHits.add(new CritHit(loc, slot - 1));</span>
<span class="nc" id="L992">        }</span>
    }

    /**
     * This is used to store the armor to change ammo at a given location
     */
    private static class SetAmmoTo {
        public final int loc;
        public final int slot;
        public final int setAmmoTo;

<span class="nc" id="L1003">        public SetAmmoTo(int loc, int slot, int setAmmoTo) {</span>
<span class="nc" id="L1004">            this.loc = loc;</span>
<span class="nc" id="L1005">            this.slot = slot;</span>
<span class="nc" id="L1006">            this.setAmmoTo = setAmmoTo;</span>
<span class="nc" id="L1007">        }</span>
    }
    
    private static class SetAmmoType {
        public final int loc;
        public final int slot;
        public final String type;
        
<span class="nc" id="L1015">        public SetAmmoType(int loc, int slot, String type) {</span>
<span class="nc" id="L1016">            this.loc = loc;</span>
<span class="nc" id="L1017">            this.slot = slot;</span>
<span class="nc" id="L1018">            this.type = type;</span>
<span class="nc" id="L1019">        }</span>
    }

    /**
     * This class is used to store the ammo Adjustments it is loaded from the
     * scenario file. It contains a vector of SetAmmoTo.
     */
    private class SetAmmoPlan {
        public final Entity entity;
<span class="nc" id="L1028">        public final List&lt;SetAmmoTo&gt; ammoSetTo = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1029">        public final List&lt;SetAmmoType&gt; ammoSetType = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L1031">        public SetAmmoPlan(Entity e) {</span>
<span class="nc" id="L1032">            entity = e;</span>
<span class="nc" id="L1033">        }</span>

        /**
         * Converts 2:1-34 to Location 2 Slot 1 set Ammo to 34
         */
        public void addSetAmmoTo(String s) {
<span class="nc" id="L1039">            int ewSpot = s.indexOf(':');</span>
<span class="nc" id="L1040">            int amSpot = s.indexOf('-');</span>
<span class="nc bnc" id="L1041" title="All 6 branches missed.">            if (s.isEmpty() || (ewSpot &lt; 1) || (amSpot &lt; ewSpot)) {</span>
<span class="nc" id="L1042">                return;</span>
            }
<span class="nc" id="L1044">            int loc = Integer.parseInt(s.substring(0, ewSpot));</span>
<span class="nc" id="L1045">            int slot = Integer.parseInt(s.substring(ewSpot + 1, amSpot));</span>
<span class="nc" id="L1046">            int setTo = Integer.parseInt(s.substring(amSpot + 1));</span>

<span class="nc" id="L1048">            ammoSetTo.add(new SetAmmoTo(loc, slot - 1, setTo));</span>
<span class="nc" id="L1049">        }</span>
        
        public void addSetAmmoType(String s) {
<span class="nc" id="L1052">            int ewSpot = s.indexOf(':');</span>
<span class="nc" id="L1053">            int atSpot = s.indexOf('-');</span>
<span class="nc bnc" id="L1054" title="All 6 branches missed.">            if (s.isEmpty() || (ewSpot &lt; 1) || (atSpot &lt; ewSpot)) {</span>
<span class="nc" id="L1055">                return;</span>
            }
<span class="nc" id="L1057">            int loc = Integer.parseInt(s.substring(0, ewSpot));</span>
<span class="nc" id="L1058">            int slot = Integer.parseInt(s.substring(ewSpot + 1, atSpot));</span>
            
<span class="nc" id="L1060">            ammoSetType.add(new SetAmmoType(loc, slot - 1, s.substring(atSpot + 1)));</span>
<span class="nc" id="L1061">        }</span>
    }

    /**
     * This is used specify the one damage location
     */
    private static class SpecDam {
        public final int loc;
        public final int setArmorTo;
        public final boolean rear;
        public final boolean internal;

<span class="nc" id="L1073">        public SpecDam(int Location, int SetArmorTo, boolean RearHit, boolean Internal) {</span>
<span class="nc" id="L1074">            loc = Location;</span>
<span class="nc" id="L1075">            setArmorTo = SetArmorTo;</span>
<span class="nc" id="L1076">            rear = RearHit;</span>
<span class="nc" id="L1077">            internal = Internal;</span>
<span class="nc" id="L1078">        }</span>
    }

    /**
     * This class is used to store the damage plan for a entity it is loaded
     * from the scenario file. It contains a vector of SpecDam.
     */
    private class DamagePlan {
        public final Entity entity;
        public final int nBlocks;
<span class="nc" id="L1088">        public final List&lt;SpecDam&gt; specificDammage = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L1090">        public DamagePlan(Entity e, int n) {</span>
<span class="nc" id="L1091">            entity = e;</span>
<span class="nc" id="L1092">            nBlocks = n;</span>
<span class="nc" id="L1093">        }</span>

<span class="nc" id="L1095">        public DamagePlan(Entity e) {</span>
<span class="nc" id="L1096">            entity = e;</span>
<span class="nc" id="L1097">            nBlocks = 0;</span>
<span class="nc" id="L1098">        }</span>

        /**
         * Converts N2:1 to Nornam hit to location 2 set armor to 1!
         */
        public void addSpecificDamage(String s) {
<span class="nc" id="L1104">            int ewSpot = s.indexOf(':');</span>
<span class="nc bnc" id="L1105" title="All 4 branches missed.">            if (s.isEmpty() || (ewSpot &lt; 1)) {</span>
<span class="nc" id="L1106">                return;</span>
            }
<span class="nc" id="L1108">            int loc = Integer.parseInt(s.substring(1, ewSpot));</span>
<span class="nc" id="L1109">            int setTo = Integer.parseInt(s.substring(ewSpot + 1));</span>
<span class="nc bnc" id="L1110" title="All 2 branches missed.">            boolean rear = (s.charAt(0) == 'R');</span>
<span class="nc bnc" id="L1111" title="All 2 branches missed.">            boolean internal = (s.charAt(0) == 'I');</span>
            
<span class="nc" id="L1113">            specificDammage.add(new SpecDam(loc, setTo, rear, internal));</span>
<span class="nc" id="L1114">        }</span>
    }
    
    private static class ScenarioLoaderException extends Exception {
        private static final long serialVersionUID = 8622648319531348199L;
        
        private final Object[] params;

        public ScenarioLoaderException(String errorKey) {
<span class="nc" id="L1123">            super(errorKey);</span>
<span class="nc" id="L1124">            this.params = null;</span>
<span class="nc" id="L1125">        }</span>
        
        public ScenarioLoaderException(String errorKey, Object... params) {
<span class="nc" id="L1128">            super(errorKey);</span>
<span class="nc" id="L1129">            this.params = params;</span>
<span class="nc" id="L1130">        }</span>
        
        @Override
        public String getMessage() {
<span class="nc" id="L1134">            String result = Messages.getString(&quot;ScenarioLoaderException.&quot; + super.getMessage());</span>
<span class="nc bnc" id="L1135" title="All 2 branches missed.">            if (params != null) {</span>
                try {
<span class="nc" id="L1137">                    return String.format(result, params);</span>
<span class="nc" id="L1138">                } catch (IllegalFormatException ignored) {</span>
                    // Ignore, return the base translation instead
                }
            }
<span class="nc" id="L1142">            return result;</span>
        }
    }
    
    private static class StringMultiMap extends HashMap&lt;String, Collection&lt;String&gt;&gt; {
        private static final long serialVersionUID = 2171662843329151622L;

        public void put(String key, String value) {
<span class="nc" id="L1150">            Collection&lt;String&gt; values = get(key);</span>
<span class="nc bnc" id="L1151" title="All 2 branches missed.">            if (values == null) {</span>
<span class="nc" id="L1152">                values = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1153">                put(key, values);</span>
            }
<span class="nc" id="L1155">            values.add(value);</span>
<span class="nc" id="L1156">        }</span>

        public String getString(String key) {
<span class="nc" id="L1159">            return getString(key, SEPARATOR_COMMA);</span>
        }

        public String getString(String key, String separator) {
<span class="nc" id="L1163">            Collection&lt;String&gt; values = get(key);</span>
<span class="nc bnc" id="L1164" title="All 4 branches missed.">            if ((values == null) || (values.size() == 0)) {</span>
<span class="nc" id="L1165">                return null;</span>
            }
            
<span class="nc" id="L1168">            boolean firstElement = true;</span>
<span class="nc" id="L1169">            StringBuilder sb = new StringBuilder();</span>
<span class="nc bnc" id="L1170" title="All 2 branches missed.">            for (String val : values) {</span>
<span class="nc bnc" id="L1171" title="All 2 branches missed.">                if (firstElement) {</span>
<span class="nc" id="L1172">                    firstElement = false;</span>
                } else {
<span class="nc" id="L1174">                    sb.append(separator);</span>
                }
<span class="nc" id="L1176">                sb.append(val);</span>
<span class="nc" id="L1177">            }</span>
<span class="nc" id="L1178">            return sb.toString();</span>
        }
        
        /** @return the number of values for this key in the file */
        public int getNumValues(String key) {
<span class="nc" id="L1183">            Collection&lt;String&gt; values = get(key);</span>
<span class="nc bnc" id="L1184" title="All 2 branches missed.">            return (values == null) ? 0 : values.size();</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>