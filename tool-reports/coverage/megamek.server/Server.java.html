<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="nl"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Server.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">PlayerTest Coverage Results</a> &gt; <a href="index.source.html" class="el_package">megamek.server</a> &gt; <span class="el_source">Server.java</span></div><h1>Server.java</h1><pre class="source lang-java linenums">/*
* MegaMek -
* Copyright (C) 2000, 2001, 2002, 2003, 2004, 2005 Ben Mazur (bmazur@sev.org)
* Copyright (C) 2013 Edward Cullen (eddy@obsessedcomputers.co.uk)
* Copyright (C) 2018, 2020 The MegaMek Team
*
* This program is free software; you can redistribute it and/or modify it under
* the terms of the GNU General Public License as published by the Free Software
* Foundation; either version 2 of the License, or (at your option) any later
* version.
*
* This program is distributed in the hope that it will be useful, but WITHOUT
* ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
* FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
* details.
*/
package megamek.server;

import java.io.*;
import java.net.HttpURLConnection;
import java.net.InetAddress;
import java.net.ServerSocket;
import java.net.Socket;
import java.net.URL;
import java.net.URLEncoder;
import java.net.UnknownHostException;
import java.nio.charset.StandardCharsets;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.Enumeration;
import java.util.HashMap;
import java.util.HashSet;
import java.util.Hashtable;
import java.util.Iterator;
import java.util.LinkedHashSet;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Set;
import java.util.Timer;
import java.util.TimerTask;
import java.util.TreeMap;
import java.util.TreeSet;
import java.util.Vector;
import java.util.concurrent.ConcurrentLinkedQueue;
import java.util.stream.Collectors;
import java.util.zip.GZIPInputStream;
import java.util.zip.GZIPOutputStream;

import com.thoughtworks.xstream.XStream;

import megamek.MegaMek;
import megamek.client.ui.swing.util.PlayerColour;
import megamek.common.*;
import megamek.common.Building.BasementType;
import megamek.common.Building.DemolitionCharge;
import megamek.common.IGame.Phase;
import megamek.common.MovePath.MoveStepType;
import megamek.common.actions.AbstractAttackAction;
import megamek.common.actions.AirmechRamAttackAction;
import megamek.common.actions.ArtilleryAttackAction;
import megamek.common.actions.AttackAction;
import megamek.common.actions.BAVibroClawAttackAction;
import megamek.common.actions.BreakGrappleAttackAction;
import megamek.common.actions.BrushOffAttackAction;
import megamek.common.actions.ChargeAttackAction;
import megamek.common.actions.ClearMinefieldAction;
import megamek.common.actions.ClubAttackAction;
import megamek.common.actions.DfaAttackAction;
import megamek.common.actions.DodgeAction;
import megamek.common.actions.EntityAction;
import megamek.common.actions.FindClubAction;
import megamek.common.actions.FlipArmsAction;
import megamek.common.actions.GrappleAttackAction;
import megamek.common.actions.JumpJetAttackAction;
import megamek.common.actions.KickAttackAction;
import megamek.common.actions.LayExplosivesAttackAction;
import megamek.common.actions.ProtomechPhysicalAttackAction;
import megamek.common.actions.PunchAttackAction;
import megamek.common.actions.PushAttackAction;
import megamek.common.actions.RamAttackAction;
import megamek.common.actions.RepairWeaponMalfunctionAction;
import megamek.common.actions.SearchlightAttackAction;
import megamek.common.actions.SpotAction;
import megamek.common.actions.TeleMissileAttackAction;
import megamek.common.actions.ThrashAttackAction;
import megamek.common.actions.TorsoTwistAction;
import megamek.common.actions.TriggerAPPodAction;
import megamek.common.actions.TriggerBPodAction;
import megamek.common.actions.TripAttackAction;
import megamek.common.actions.UnjamAction;
import megamek.common.actions.UnjamTurretAction;
import megamek.common.actions.UnloadStrandedAction;
import megamek.common.actions.WeaponAttackAction;
import megamek.common.containers.PlayerIDandList;
import megamek.common.event.GameListener;
import megamek.common.event.GameVictoryEvent;
import megamek.common.icons.Camouflage;
import megamek.common.net.ConnectionFactory;
import megamek.common.net.ConnectionListenerAdapter;
import megamek.common.net.DisconnectedEvent;
import megamek.common.net.IConnection;
import megamek.common.net.Packet;
import megamek.common.net.PacketReceivedEvent;
import megamek.common.options.GameOptions;
import megamek.common.options.IBasicOption;
import megamek.common.options.IOption;
import megamek.common.options.OptionsConstants;
import megamek.common.preference.PreferenceManager;
import megamek.common.util.BoardUtilities;
import megamek.common.util.fileUtils.MegaMekFile;
import megamek.common.util.SerializationHelper;
import megamek.common.util.StringUtil;
import megamek.common.verifier.EntityVerifier;
import megamek.common.verifier.TestAero;
import megamek.common.verifier.TestBattleArmor;
import megamek.common.verifier.TestEntity;
import megamek.common.verifier.TestMech;
import megamek.common.verifier.TestSupportVehicle;
import megamek.common.verifier.TestTank;
import megamek.common.weapons.AreaEffectHelper;
import megamek.common.weapons.AreaEffectHelper.DamageFalloff;
import megamek.common.weapons.AreaEffectHelper.NukeStats;
import megamek.common.weapons.ArtilleryBayWeaponIndirectHomingHandler;
import megamek.common.weapons.ArtilleryWeaponIndirectHomingHandler;
import megamek.common.weapons.AttackHandler;
import megamek.common.weapons.CapitalMissileBearingsOnlyHandler;
import megamek.common.weapons.TAGHandler;
import megamek.common.weapons.Weapon;
import megamek.common.weapons.WeaponHandler;
import megamek.common.weapons.infantry.InfantryWeapon;
import megamek.common.weapons.other.TSEMPWeapon;
import megamek.server.commands.AddBotCommand;
import megamek.server.commands.AllowTeamChangeCommand;
import megamek.server.commands.AssignNovaNetServerCommand;
import megamek.server.commands.CheckBVCommand;
import megamek.server.commands.CheckBVTeamCommand;
import megamek.server.commands.DefeatCommand;
import megamek.server.commands.ExportListCommand;
import megamek.server.commands.FixElevationCommand;
import megamek.server.commands.HelpCommand;
import megamek.server.commands.JoinTeamCommand;
import megamek.server.commands.KickCommand;
import megamek.server.commands.ListEntitiesCommand;
import megamek.server.commands.ListSavesCommand;
import megamek.server.commands.LoadGameCommand;
import megamek.server.commands.LocalLoadGameCommand;
import megamek.server.commands.LocalSaveGameCommand;
import megamek.server.commands.NukeCommand;
import megamek.server.commands.ResetCommand;
import megamek.server.commands.RollCommand;
import megamek.server.commands.RulerCommand;
import megamek.server.commands.SaveGameCommand;
import megamek.server.commands.SeeAllCommand;
import megamek.server.commands.ServerCommand;
import megamek.server.commands.ShowEntityCommand;
import megamek.server.commands.ShowTileCommand;
import megamek.server.commands.ShowValidTargetsCommand;
import megamek.server.commands.SkipCommand;
import megamek.server.commands.TeamCommand;
import megamek.server.commands.TraitorCommand;
import megamek.server.commands.VictoryCommand;
import megamek.server.commands.WhoCommand;
import megamek.server.victory.VictoryResult;

/**
 * @author Ben Mazur
 */
public class Server implements Runnable {
    private static class EntityTargetPair {
        Entity ent;

        Targetable target;

<span class="nc" id="L181">        EntityTargetPair (Entity e, Targetable t) {</span>
<span class="nc" id="L182">            ent = e;</span>
<span class="nc" id="L183">            target = t;</span>
<span class="nc" id="L184">        }</span>

        @Override
        public boolean equals(Object o) {
<span class="nc bnc" id="L188" title="All 2 branches missed.">            if (this == o) {</span>
<span class="nc" id="L189">                return true;</span>
            }
<span class="nc bnc" id="L191" title="All 4 branches missed.">            if ((null == o) || (getClass() != o.getClass())) {</span>
<span class="nc" id="L192">                return false;</span>
            }
<span class="nc" id="L194">            final EntityTargetPair other = (EntityTargetPair) o;</span>
<span class="nc bnc" id="L195" title="All 4 branches missed.">            return Objects.equals(ent, other.ent) &amp;&amp; Objects.equals(target, other.target);</span>
        }

        @Override
        public int hashCode() {
<span class="nc" id="L200">            return Objects.hash(ent, target);</span>
        }

    }
    /**
     * The DamageType enumeration is used for the damageEntity function.
     */
<span class="nc" id="L207">    public enum DamageType {</span>
<span class="nc" id="L208">        NONE, FRAGMENTATION, FLECHETTE, ACID, INCENDIARY, IGNORE_PASSENGER, ANTI_TSM, ANTI_INFANTRY, NAIL_RIVET,</span>
<span class="nc" id="L209">        NONPENETRATING</span>
    }

    // public static final String LEGAL_CHARS =
    // &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789_.-&quot;;
    private static final String DEFAULT_BOARD = MapSettings.BOARD_SURPRISE;

    // server setup
    private String password;

    private final String metaServerUrl;

    private ServerSocket serverSocket;

    private String motd;

    private static class ReceivedPacket {
        public int connId;
        public Packet packet;

<span class="nc" id="L229">        ReceivedPacket(int cid, Packet p) {</span>
<span class="nc" id="L230">            packet = p;</span>
<span class="nc" id="L231">            connId = cid;</span>
<span class="nc" id="L232">        }</span>

    }

    private class PacketPump implements Runnable {

        boolean shouldStop;

<span class="nc" id="L240">        PacketPump() {</span>
<span class="nc" id="L241">            shouldStop = false;</span>
<span class="nc" id="L242">        }</span>

        void signalEnd() {
<span class="nc" id="L245">            shouldStop = true;</span>
<span class="nc" id="L246">        }</span>

        @Override
        public void run() {
<span class="nc bnc" id="L250" title="All 2 branches missed.">            while (!shouldStop) {</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">                while (!packetQueue.isEmpty()) {</span>
<span class="nc" id="L252">                    ReceivedPacket rp = packetQueue.poll();</span>
<span class="nc" id="L253">                    synchronized (serverLock) {</span>
<span class="nc" id="L254">                        handle(rp.connId, rp.packet);</span>
<span class="nc" id="L255">                    }</span>
<span class="nc" id="L256">                }</span>
                try {
<span class="nc" id="L258">                    synchronized (packetQueue) {</span>
<span class="nc" id="L259">                        packetQueue.wait();</span>
<span class="nc" id="L260">                    }</span>
<span class="nc" id="L261">                } catch (InterruptedException e) {</span>
                    // If we are interrupted, just keep going, generally
                    // this happens after we are signalled to stop.
<span class="nc" id="L264">                }</span>
            }
<span class="nc" id="L266">        }</span>

    }

    // game info
<span class="nc" id="L271">    private Vector&lt;IConnection&gt; connections = new Vector&lt;&gt;(4);</span>

<span class="nc" id="L273">    private Hashtable&lt;Integer, ConnectionHandler&gt; connectionHandlers = new Hashtable&lt;&gt;();</span>

<span class="nc" id="L275">    private final ConcurrentLinkedQueue&lt;ReceivedPacket&gt; packetQueue = new ConcurrentLinkedQueue&lt;&gt;();</span>

    /**
     * Special packet queue for client feedback requests.
     */
<span class="nc" id="L280">    private final ConcurrentLinkedQueue&lt;ReceivedPacket&gt; cfrPacketQueue = new ConcurrentLinkedQueue&lt;&gt;();</span>

<span class="nc" id="L282">    private Vector&lt;IConnection&gt; connectionsPending = new Vector&lt;&gt;(4);</span>

<span class="nc" id="L284">    private Hashtable&lt;Integer, IConnection&gt; connectionIds = new Hashtable&lt;&gt;();</span>

    private int connectionCounter;

<span class="nc" id="L288">    private IGame game = new Game();</span>

<span class="nc" id="L290">    private Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>

    public Vector&lt;Report&gt; getvPhaseReport() {
<span class="nc" id="L293">        return vPhaseReport;</span>
    }

<span class="nc" id="L296">    private MapSettings mapSettings = MapSettings.getInstance();</span>

    // commands
<span class="nc" id="L299">    private Hashtable&lt;String, ServerCommand&gt; commandsHash = new Hashtable&lt;&gt;();</span>

    // listens for and connects players
    private Thread connector;

    private PacketPump packetPump;
    private Thread packetPumpThread;

    // Track buildings that are affected by an entity's movement.
<span class="nc" id="L308">    private Hashtable&lt;Building, Boolean&gt; affectedBldgs = new Hashtable&lt;&gt;();</span>

    // Track Physical Action results, HACK to deal with opposing pushes
    // canceling each other
<span class="nc" id="L312">    private Vector&lt;PhysicalResult&gt; physicalResults = new Vector&lt;&gt;();</span>

<span class="nc" id="L314">    private Vector&lt;DynamicTerrainProcessor&gt; terrainProcessors = new Vector&lt;&gt;();</span>

<span class="nc" id="L316">    private Timer watchdogTimer = new Timer(&quot;Watchdog Timer&quot;);</span>

    private static EntityVerifier entityVerifier;

<span class="nc" id="L320">    private ArrayList&lt;int[]&gt; scheduledNukes = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L322">    private static Server serverInstance = null;</span>

<span class="nc" id="L324">    private String serverAccessKey = null;</span>

<span class="nc" id="L326">    private Timer serverBrowserUpdateTimer = null;</span>

    /**
     * Keeps track of what team a player requested to join.
     */
<span class="nc" id="L331">    private int requestedTeam = IPlayer.TEAM_NONE;</span>

    /**
     * Keeps track of what player made a request to change teams.
     */
<span class="nc" id="L336">    private IPlayer playerChangingTeam = null;</span>

    /**
     * Flag that is set to true when all players have voted to allow another
     * player to change teams.
     */
<span class="nc" id="L342">    private boolean changePlayersTeam = false;</span>

    /**
     * Stores a set of &lt;code&gt;Coords&lt;/code&gt; that have changed during this phase.
     */
<span class="nc" id="L347">    private Set&lt;Coords&gt; hexUpdateSet = new LinkedHashSet&lt;&gt;();</span>

<span class="nc" id="L349">    private List&lt;DemolitionCharge&gt; explodingCharges = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L351">    private ConnectionListenerAdapter connectionListener = new ConnectionListenerAdapter() {</span>

        /**
         * Called when it is sensed that a connection has terminated.
         */
        @Override
        public void disconnected(DisconnectedEvent e) {
<span class="nc" id="L358">            synchronized (serverLock) {</span>
<span class="nc" id="L359">                IConnection conn = e.getConnection();</span>

                // write something in the log
<span class="nc" id="L362">                MegaMek.getLogger().info(&quot;s: connection &quot; + conn.getId() + &quot; disconnected&quot;);</span>

<span class="nc" id="L364">                connections.removeElement(conn);</span>
<span class="nc" id="L365">                connectionsPending.removeElement(conn);</span>
<span class="nc" id="L366">                connectionIds.remove(conn.getId());</span>
<span class="nc" id="L367">                ConnectionHandler ch = connectionHandlers.get(conn.getId());</span>
<span class="nc bnc" id="L368" title="All 2 branches missed.">                if (ch != null) {</span>
<span class="nc" id="L369">                    ch.signalStop();</span>
<span class="nc" id="L370">                    connectionHandlers.remove(conn.getId());</span>
                }

                // if there's a player for this connection, remove it too
<span class="nc" id="L374">                IPlayer player = getPlayer(conn.getId());</span>
<span class="nc bnc" id="L375" title="All 2 branches missed.">                if (null != player) {</span>
<span class="nc" id="L376">                    Server.this.disconnected(player);</span>
                }
<span class="nc" id="L378">            }</span>
<span class="nc" id="L379">        }</span>

        @Override
        public void packetReceived(PacketReceivedEvent e) {
<span class="nc" id="L383">            ReceivedPacket rp = new ReceivedPacket(e.getConnection().getId(),</span>
<span class="nc" id="L384">                    e.getPacket());</span>
<span class="nc" id="L385">            int cmd = e.getPacket().getCommand();</span>
            // Handled CFR packets specially
<span class="nc bnc" id="L387" title="All 2 branches missed.">            if (cmd == Packet.COMMAND_CLIENT_FEEDBACK_REQUEST) {</span>
<span class="nc" id="L388">                synchronized (cfrPacketQueue) {</span>
<span class="nc" id="L389">                    cfrPacketQueue.add(rp);</span>
<span class="nc" id="L390">                    cfrPacketQueue.notifyAll();</span>
<span class="nc" id="L391">                }</span>
            // Some packets should be handled immediately
<span class="nc bnc" id="L393" title="All 8 branches missed.">            } else if ((cmd == Packet.COMMAND_CLOSE_CONNECTION)</span>
                    || (cmd == Packet.COMMAND_CLIENT_NAME)
                    || (cmd == Packet.COMMAND_CLIENT_VERSIONS)
                    || (cmd == Packet.COMMAND_CHAT)) {
<span class="nc" id="L397">                handle(rp.connId, rp.packet);</span>
            } else {
<span class="nc" id="L399">                synchronized (packetQueue) {</span>
<span class="nc" id="L400">                    packetQueue.add(rp);</span>
<span class="nc" id="L401">                    packetQueue.notifyAll();</span>
<span class="nc" id="L402">                }</span>
            }
<span class="nc" id="L404">        }</span>

    };

    /**
     * Used to ensure only one thread at a time is accessing this particular
     * instance of the server.
     */
<span class="nc" id="L412">    private final Object serverLock = new Object();</span>

    public Server(String password, int port) throws IOException {
<span class="nc" id="L415">        this(password, port, false, &quot;&quot;);</span>
<span class="nc" id="L416">    }</span>

    /**
     * Construct a new GameHost and begin listening for incoming clients.
     *
     * @param password                  the &lt;code&gt;String&lt;/code&gt; that is set as a password
     * @param port                      the &lt;code&gt;int&lt;/code&gt; value that specifies the port that is
     *                                  used
     * @param registerWithServerBrowser a &lt;code&gt;boolean&lt;/code&gt; indicating whether we should register
     *                                  with the master server browser on megamek.info
     */
    public Server(String password, int port, boolean registerWithServerBrowser,
<span class="nc" id="L428">                  String metaServerUrl) throws IOException {</span>
<span class="nc" id="L429">        this.metaServerUrl = metaServerUrl;</span>
<span class="nc bnc" id="L430" title="All 2 branches missed.">        this.password = password.length() &gt; 0 ? password : null;</span>
        // initialize server socket
<span class="nc" id="L432">        serverSocket = new ServerSocket(port);</span>

<span class="nc" id="L434">        motd = createMotd();</span>

<span class="nc" id="L436">        game.getOptions().initialize();</span>
<span class="nc" id="L437">        game.getOptions().loadOptions();</span>

<span class="nc" id="L439">        changePhase(IGame.Phase.PHASE_LOUNGE);</span>

        // display server start text
<span class="nc" id="L442">        MegaMek.getLogger().info(&quot;s: starting a new server...&quot;);</span>

        try {
<span class="nc" id="L445">            StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L446">            String host = InetAddress.getLocalHost().getHostName();</span>
<span class="nc" id="L447">            sb.append(&quot;s: hostname = '&quot;);</span>
<span class="nc" id="L448">            sb.append(host);</span>
<span class="nc" id="L449">            sb.append(&quot;' port = &quot;);</span>
<span class="nc" id="L450">            sb.append(serverSocket.getLocalPort());</span>
<span class="nc" id="L451">            sb.append(&quot;\n&quot;);</span>
<span class="nc" id="L452">            InetAddress[] addresses = InetAddress.getAllByName(host);</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">            for (InetAddress address : addresses) {</span>
<span class="nc" id="L454">                sb.append(&quot;s: hosting on address = &quot;);</span>
<span class="nc" id="L455">                sb.append(address.getHostAddress());</span>
<span class="nc" id="L456">                sb.append(&quot;\n&quot;);</span>
            }

<span class="nc" id="L459">            MegaMek.getLogger().info(sb.toString());</span>
<span class="nc" id="L460">        } catch (UnknownHostException ignored) {</span>
            // oh well.
<span class="nc" id="L462">        }</span>

<span class="nc" id="L464">        MegaMek.getLogger().info(&quot;s: password = &quot; + this.password);</span>

        // register commands
<span class="nc" id="L467">        registerCommand(new DefeatCommand(this));</span>
<span class="nc" id="L468">        registerCommand(new ExportListCommand(this));</span>
<span class="nc" id="L469">        registerCommand(new FixElevationCommand(this));</span>
<span class="nc" id="L470">        registerCommand(new HelpCommand(this));</span>
<span class="nc" id="L471">        registerCommand(new KickCommand(this));</span>
<span class="nc" id="L472">        registerCommand(new ListSavesCommand(this));</span>
<span class="nc" id="L473">        registerCommand(new LocalSaveGameCommand(this));</span>
<span class="nc" id="L474">        registerCommand(new LocalLoadGameCommand(this));</span>
<span class="nc" id="L475">        registerCommand(new ResetCommand(this));</span>
<span class="nc" id="L476">        registerCommand(new RollCommand(this));</span>
<span class="nc" id="L477">        registerCommand(new SaveGameCommand(this));</span>
<span class="nc" id="L478">        registerCommand(new LoadGameCommand(this));</span>
<span class="nc" id="L479">        registerCommand(new SeeAllCommand(this));</span>
<span class="nc" id="L480">        registerCommand(new SkipCommand(this));</span>
<span class="nc" id="L481">        registerCommand(new VictoryCommand(this));</span>
<span class="nc" id="L482">        registerCommand(new WhoCommand(this));</span>
<span class="nc" id="L483">        registerCommand(new TeamCommand(this));</span>
<span class="nc" id="L484">        registerCommand(new ShowTileCommand(this));</span>
<span class="nc" id="L485">        registerCommand(new ShowEntityCommand(this));</span>
<span class="nc" id="L486">        registerCommand(new RulerCommand(this));</span>
<span class="nc" id="L487">        registerCommand(new ShowValidTargetsCommand(this));</span>
<span class="nc" id="L488">        registerCommand(new AddBotCommand(this));</span>
<span class="nc" id="L489">        registerCommand(new CheckBVCommand(this));</span>
<span class="nc" id="L490">        registerCommand(new CheckBVTeamCommand(this));</span>
<span class="nc" id="L491">        registerCommand(new NukeCommand(this));</span>
<span class="nc" id="L492">        registerCommand(new TraitorCommand(this));</span>
<span class="nc" id="L493">        registerCommand(new ListEntitiesCommand(this));</span>
<span class="nc" id="L494">        registerCommand(new AssignNovaNetServerCommand(this));</span>
<span class="nc" id="L495">        registerCommand(new AllowTeamChangeCommand(this));</span>
<span class="nc" id="L496">        registerCommand(new JoinTeamCommand(this));</span>

        // register terrain processors
<span class="nc" id="L499">        terrainProcessors.add(new FireProcessor(this));</span>
<span class="nc" id="L500">        terrainProcessors.add(new SmokeProcessor(this));</span>
<span class="nc" id="L501">        terrainProcessors.add(new GeyserProcessor(this));</span>
<span class="nc" id="L502">        terrainProcessors.add(new ElevatorProcessor(this));</span>
<span class="nc" id="L503">        terrainProcessors.add(new ScreenProcessor(this));</span>
<span class="nc" id="L504">        terrainProcessors.add(new WeatherProcessor(this));</span>
<span class="nc" id="L505">        terrainProcessors.add(new QuicksandProcessor(this));</span>

<span class="nc" id="L507">        packetPump = new PacketPump();</span>
<span class="nc" id="L508">        packetPumpThread = new Thread(packetPump, &quot;Packet Pump&quot;);</span>
<span class="nc" id="L509">        packetPumpThread.start();</span>

<span class="nc bnc" id="L511" title="All 2 branches missed.">        if (registerWithServerBrowser) {</span>

<span class="nc" id="L513">            final TimerTask register = new TimerTask() {</span>
                @Override
                public void run() {
<span class="nc" id="L516">                    registerWithServerBrowser(true,</span>
<span class="nc" id="L517">                                              Server.getServerInstance().metaServerUrl);</span>
<span class="nc" id="L518">                }</span>
            };
<span class="nc" id="L520">            serverBrowserUpdateTimer = new Timer(</span>
                    &quot;Server Browser Register Timer&quot;, true);
<span class="nc" id="L522">            serverBrowserUpdateTimer.schedule(register, 1, 40000);</span>
        }

        // Fully initialised, now accept connections
<span class="nc" id="L526">        connector = new Thread(this, &quot;Connection Listener&quot;);</span>
<span class="nc" id="L527">        connector.start();</span>

<span class="nc" id="L529">        serverInstance = this;</span>
<span class="nc" id="L530">    }</span>

    /**
     * Sets the game for this server. Restores any transient fields, and sets
     * all players as ghosts. This should only be called during server
     * initialization before any players have connected.
     */
    public void setGame(IGame g) {
        // game listeners are transient so we need to save and restore them
<span class="nc" id="L539">        Vector&lt;GameListener&gt; gameListenersClone = new Vector&lt;&gt;(getGame().getGameListeners());</span>

<span class="nc" id="L541">        game = g;</span>

<span class="nc bnc" id="L543" title="All 2 branches missed.">        for (GameListener listener : gameListenersClone) {</span>
<span class="nc" id="L544">            getGame().addGameListener(listener);</span>
<span class="nc" id="L545">        }</span>

<span class="nc" id="L547">        List&lt;Integer&gt; orphanEntities = new ArrayList&lt;&gt;();</span>
                
        // reattach the transient fields and ghost the players
<span class="nc bnc" id="L550" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext(); ) {</span>
<span class="nc" id="L551">            Entity ent = e.next();</span>
<span class="nc" id="L552">            ent.setGame(game);</span>
            
<span class="nc bnc" id="L554" title="All 2 branches missed.">            if(ent.getOwner() == null) {</span>
<span class="nc" id="L555">                orphanEntities.add(ent.getId());</span>
<span class="nc" id="L556">                continue;</span>
            }
            
<span class="nc bnc" id="L559" title="All 2 branches missed.">            if (ent instanceof Mech) {</span>
<span class="nc" id="L560">                ((Mech) ent).setBAGrabBars();</span>
<span class="nc" id="L561">                ((Mech) ent).setProtomechClampMounts();</span>
            }
<span class="nc bnc" id="L563" title="All 2 branches missed.">            if (ent instanceof Tank) {</span>
<span class="nc" id="L564">                ((Tank) ent).setBAGrabBars();</span>
            }
<span class="nc" id="L566">        }</span>
        
<span class="nc" id="L568">        game.removeEntities(orphanEntities, IEntityRemovalConditions.REMOVE_UNKNOWN);</span>
        
<span class="nc" id="L570">        game.setOutOfGameEntitiesVector(game.getOutOfGameEntitiesVector());</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; e = game.getPlayers(); e.hasMoreElements(); ) {</span>
<span class="nc" id="L572">            IPlayer p = e.nextElement();</span>
<span class="nc" id="L573">            p.setGame(game);</span>
<span class="nc" id="L574">            p.setGhost(true);</span>
<span class="nc" id="L575">        }</span>
        // might need to restore weapon type for some attacks that take multiple
        // turns (like artillery)
<span class="nc" id="L578">        for (Enumeration&lt;AttackHandler&gt; a = game.getAttacks(); a</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">                .hasMoreElements(); ) {</span>
<span class="nc" id="L580">            AttackHandler handler = a.nextElement();</span>
<span class="nc bnc" id="L581" title="All 2 branches missed.">            if (handler instanceof WeaponHandler) {</span>
<span class="nc" id="L582">                ((WeaponHandler) handler).restore();</span>
            }
<span class="nc" id="L584">        }</span>

<span class="nc" id="L586">    }</span>

    /**
     * Returns the current game object
     */
    public IGame getGame() {
<span class="nc" id="L592">        return game;</span>
    }

    /**
     * Make a default message o' the day containing the version string, and if
     * it was found, the build timestamp
     */
    private String createMotd() {
<span class="nc" id="L600">        StringBuilder motd = new StringBuilder();</span>
<span class="nc" id="L601">        motd.append(&quot;Welcome to MegaMek.  Server is running version &quot;).append(MegaMek.VERSION)</span>
<span class="nc" id="L602">                .append(&quot;, build date &quot;);</span>
<span class="nc bnc" id="L603" title="All 2 branches missed.">        if (MegaMek.TIMESTAMP &gt; 0L) {</span>
<span class="nc" id="L604">            motd.append(new Date(MegaMek.TIMESTAMP).toString());</span>
        } else {
<span class="nc" id="L606">            motd.append(&quot;unknown&quot;);</span>
        }
<span class="nc" id="L608">        motd.append('.');</span>

<span class="nc" id="L610">        return motd.toString();</span>
    }

    /**
     * @return true if the server has a password
     */
    public boolean isPassworded() {
<span class="nc bnc" id="L617" title="All 2 branches missed.">        return password != null;</span>
    }

    /**
     * @return true if the password matches
     */
    public boolean isPassword(Object guess) {
<span class="nc" id="L624">        return password.equals(guess);</span>
    }

    /**
     * Registers a new command in the server command table
     */
    private void registerCommand(ServerCommand command) {
<span class="nc" id="L631">        commandsHash.put(command.getName(), command);</span>
<span class="nc" id="L632">    }</span>

    /**
     * Returns the command associated with the specified name
     */
    public ServerCommand getCommand(String name) {
<span class="nc" id="L638">        return commandsHash.get(name);</span>
    }

    /**
     * Shuts down the server.
     */
    public void die() {
<span class="nc" id="L645">        watchdogTimer.cancel();</span>

        // kill thread accepting new connections
<span class="nc" id="L648">        connector = null;</span>
<span class="nc" id="L649">        packetPump.signalEnd();</span>
<span class="nc" id="L650">        packetPumpThread.interrupt();</span>
<span class="nc" id="L651">        packetPumpThread = null;</span>

        // close socket
        try {
<span class="nc" id="L655">            serverSocket.close();</span>
<span class="nc" id="L656">        } catch (IOException ignored) {</span>
<span class="nc" id="L657">        }</span>

        // kill pending connections
<span class="nc" id="L660">        for (Enumeration&lt;IConnection&gt; connEnum = connectionsPending.elements(); connEnum</span>
<span class="nc bnc" id="L661" title="All 2 branches missed.">                .hasMoreElements(); ) {</span>
<span class="nc" id="L662">            IConnection conn = connEnum.nextElement();</span>
<span class="nc" id="L663">            conn.close();</span>
<span class="nc" id="L664">        }</span>
<span class="nc" id="L665">        connectionsPending.removeAllElements();</span>

        // Send &quot;kill&quot; commands to all connections
        // N.B. I may be starting a race here.
<span class="nc bnc" id="L669" title="All 2 branches missed.">        for (Enumeration&lt;IConnection&gt; connEnum = connections.elements(); connEnum.hasMoreElements(); ) {</span>
<span class="nc" id="L670">            IConnection conn = connEnum.nextElement();</span>
<span class="nc" id="L671">            send(conn.getId(), new Packet(Packet.COMMAND_CLOSE_CONNECTION));</span>
<span class="nc" id="L672">        }</span>

        // kill active connections
<span class="nc bnc" id="L675" title="All 2 branches missed.">        for (Enumeration&lt;IConnection&gt; connEnum = connections.elements(); connEnum.hasMoreElements(); ) {</span>
<span class="nc" id="L676">            IConnection conn = connEnum.nextElement();</span>
<span class="nc" id="L677">            conn.close();</span>
<span class="nc" id="L678">        }</span>

<span class="nc" id="L680">        connections.removeAllElements();</span>
<span class="nc" id="L681">        connectionIds.clear();</span>
<span class="nc bnc" id="L682" title="All 2 branches missed.">        if (serverBrowserUpdateTimer != null) {</span>
<span class="nc" id="L683">            serverBrowserUpdateTimer.cancel();</span>
        }
<span class="nc bnc" id="L685" title="All 2 branches missed.">        if (!metaServerUrl.equals(&quot;&quot;)) {</span>
<span class="nc" id="L686">            registerWithServerBrowser(false, metaServerUrl);</span>
        }

        // TODO : Not sure that this still needs to be here after updating to the new logging methods.
<span class="nc" id="L690">        System.out.flush();</span>
<span class="nc" id="L691">    }</span>

    /**
     * Returns an enumeration of all the command names
     */
    public Enumeration&lt;String&gt; getAllCommandNames() {
<span class="nc" id="L697">        return commandsHash.keys();</span>
    }

    /**
     * Sent when a client attempts to connect.
     */
    void greeting(int cn) {
        // send server greeting -- client should reply with client info.
<span class="nc" id="L705">        sendToPending(cn, new Packet(Packet.COMMAND_SERVER_GREETING));</span>
<span class="nc" id="L706">    }</span>

    /**
     * Returns a free connection id.
     */
    public int getFreeConnectionId() {
<span class="nc bnc" id="L712" title="All 2 branches missed.">        while ((getPendingConnection(connectionCounter) != null)</span>
<span class="nc bnc" id="L713" title="All 2 branches missed.">               || (getConnection(connectionCounter) != null)</span>
<span class="nc bnc" id="L714" title="All 2 branches missed.">               || (getPlayer(connectionCounter) != null)) {</span>
<span class="nc" id="L715">            connectionCounter++;</span>
        }
<span class="nc" id="L717">        return connectionCounter;</span>
    }

    /**
     * Returns a free entity id. Perhaps this should be in Game instead.
     */
    public int getFreeEntityId() {
<span class="nc" id="L724">        return game.getNextEntityId();</span>
    }

    /**
     * Allow the player to set whatever parameters he is able to
     */
    private void receivePlayerInfo(Packet packet, int connId) {
<span class="nc" id="L731">        IPlayer player = (IPlayer) packet.getObject(0);</span>
<span class="nc" id="L732">        IPlayer gamePlayer = game.getPlayer(connId);</span>
<span class="nc bnc" id="L733" title="All 2 branches missed.">        if (null != gamePlayer) {</span>
<span class="nc" id="L734">            gamePlayer.setColour(player.getColour());</span>
<span class="nc" id="L735">            gamePlayer.setStartingPos(player.getStartingPos());</span>
<span class="nc" id="L736">            gamePlayer.setTeam(player.getTeam());</span>
<span class="nc" id="L737">            gamePlayer.setCamoCategory(player.getCamoCategory());</span>
<span class="nc" id="L738">            gamePlayer.setCamoFileName(player.getCamoFileName());</span>
<span class="nc" id="L739">            gamePlayer.setNbrMFConventional(player.getNbrMFConventional());</span>
<span class="nc" id="L740">            gamePlayer.setNbrMFCommand(player.getNbrMFCommand());</span>
<span class="nc" id="L741">            gamePlayer.setNbrMFVibra(player.getNbrMFVibra());</span>
<span class="nc" id="L742">            gamePlayer.setNbrMFActive(player.getNbrMFActive());</span>
<span class="nc" id="L743">            gamePlayer.setNbrMFInferno(player.getNbrMFInferno());</span>
<span class="nc" id="L744">            if (gamePlayer.getConstantInitBonus()</span>
<span class="nc bnc" id="L745" title="All 2 branches missed.">                != player.getConstantInitBonus()) {</span>
<span class="nc" id="L746">                sendServerChat(&quot;Player &quot; + gamePlayer.getName()</span>
                               + &quot; changed their initiative bonus from &quot;
<span class="nc" id="L748">                               + gamePlayer.getConstantInitBonus()</span>
<span class="nc" id="L749">                               + &quot; to &quot; + player.getConstantInitBonus() + &quot;.&quot;);</span>
            }
<span class="nc" id="L751">            gamePlayer.setConstantInitBonus(player.getConstantInitBonus());</span>
        }
<span class="nc" id="L753">    }</span>

    /**
     * Correct a duplicate player name
     *
     * @param oldName the &lt;code&gt;String&lt;/code&gt; old player name, that is a duplicate
     * @return the &lt;code&gt;String&lt;/code&gt; new player name
     */
    private String correctDupeName(String oldName) {
<span class="nc bnc" id="L762" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L763">            IPlayer player = i.nextElement();</span>
<span class="nc bnc" id="L764" title="All 2 branches missed.">            if (player.getName().equals(oldName)) {</span>
                // We need to correct it.
<span class="nc" id="L766">                String newName = oldName;</span>
                int dupNum;
                try {
<span class="nc" id="L769">                    dupNum = Integer.parseInt(oldName.substring(oldName.lastIndexOf(&quot;.&quot;) + 1));</span>
<span class="nc" id="L770">                    dupNum++;</span>
<span class="nc" id="L771">                    newName = oldName.substring(0, oldName.lastIndexOf(&quot;.&quot;));</span>
<span class="nc" id="L772">                } catch (Exception e) {</span>
                    // If this fails, we don't care much.
                    // Just assume it's the first time for this name.
<span class="nc" id="L775">                    dupNum = 2;</span>
<span class="nc" id="L776">                }</span>
<span class="nc" id="L777">                newName = newName.concat(&quot;.&quot;).concat(Integer.toString(dupNum));</span>
<span class="nc" id="L778">                return correctDupeName(newName);</span>
            }
<span class="nc" id="L780">        }</span>
<span class="nc" id="L781">        return oldName;</span>
    }

    private void receivePlayerVersion(Packet packet, int connId) {
<span class="nc" id="L785">        String version = (String) packet.getObject(0);</span>
<span class="nc" id="L786">        String clientChecksum = (String) packet.getObject(1);</span>
<span class="nc" id="L787">        String serverChecksum = MegaMek.getMegaMekSHA256();</span>
<span class="nc" id="L788">        StringBuilder buf = new StringBuilder();</span>
<span class="nc" id="L789">        boolean needs = false;</span>
<span class="nc bnc" id="L790" title="All 2 branches missed.">        if (!version.equals(MegaMek.VERSION)) {</span>
<span class="nc" id="L791">            buf.append(&quot;Client/Server version mismatch. Server reports: &quot;).append(MegaMek.VERSION)</span>
<span class="nc" id="L792">                    .append(&quot;, Client reports: &quot;).append(version);</span>
<span class="nc" id="L793">            MegaMek.getLogger().error(&quot;Client/Server Version Mismatch -- Client: &quot; </span>
                    + version + &quot; Server: &quot; + MegaMek.VERSION);
<span class="nc" id="L795">            needs = true;</span>
        }
        // print a message indicating client doesn't have jar file
<span class="nc bnc" id="L798" title="All 2 branches missed.">        if (clientChecksum == null) {</span>
<span class="nc bnc" id="L799" title="All 2 branches missed.">            if (!version.equals(MegaMek.VERSION)) {</span>
<span class="nc" id="L800">                buf.append(System.lineSeparator()).append(System.lineSeparator());</span>
            }
<span class="nc" id="L802">            buf.append(&quot;Client Checksum is null. Client may not have a jar file&quot;);</span>
<span class="nc" id="L803">            MegaMek.getLogger().info(&quot;Client does not have a jar file&quot;);</span>
<span class="nc" id="L804">            needs = true;</span>
        // print message indicating server doesn't have jar file
<span class="nc bnc" id="L806" title="All 2 branches missed.">        } else if (serverChecksum == null) {</span>
<span class="nc bnc" id="L807" title="All 2 branches missed.">            if (!version.equals(MegaMek.VERSION)) {</span>
<span class="nc" id="L808">                buf.append(System.lineSeparator()).append(System.lineSeparator());</span>
            }
<span class="nc" id="L810">            buf.append(&quot;Server Checksum is null. Server may not have a jar file&quot;);</span>
<span class="nc" id="L811">            MegaMek.getLogger().info(&quot;Server does not have a jar file&quot;);</span>
<span class="nc" id="L812">            needs = true;</span>
        // print message indicating a client/server checksum mismatch
<span class="nc bnc" id="L814" title="All 2 branches missed.">        } else if (!clientChecksum.equals(serverChecksum)) {</span>
<span class="nc bnc" id="L815" title="All 2 branches missed.">            if (!version.equals(MegaMek.VERSION)) {</span>
<span class="nc" id="L816">                buf.append(System.lineSeparator());</span>
<span class="nc" id="L817">                buf.append(System.lineSeparator());</span>
            }
<span class="nc" id="L819">            buf.append(&quot;Client/Server checksum mismatch. Server reports: &quot;).append(serverChecksum)</span>
<span class="nc" id="L820">                    .append(&quot;, Client reports: &quot;).append(clientChecksum);</span>
<span class="nc" id="L821">            MegaMek.getLogger().error(&quot;Client/Server Checksum Mismatch -- Client: &quot; + clientChecksum </span>
                    + &quot; Server: &quot; + serverChecksum);

<span class="nc" id="L824">            needs = true;</span>
        }

        // Now, if we need to, send message!
<span class="nc bnc" id="L828" title="All 2 branches missed.">        if (needs) {</span>
<span class="nc" id="L829">            IPlayer player = getPlayer(connId);</span>
<span class="nc bnc" id="L830" title="All 2 branches missed.">            if (null != player) {</span>
<span class="nc" id="L831">                sendServerChat(&quot;For &quot; + player.getName() + &quot; Server reports:&quot;</span>
<span class="nc" id="L832">                        + System.lineSeparator()</span>
<span class="nc" id="L833">                        + buf.toString());</span>
            }
<span class="nc" id="L835">        } else {</span>
<span class="nc" id="L836">            MegaMek.getLogger().info(&quot;SUCCESS: Client/Server Version (&quot; + version + &quot;) and Checksum (&quot; </span>
                    + clientChecksum + &quot;) matched&quot;);
        }
<span class="nc" id="L839">    }</span>

    /**
     * Receives a player name, sent from a pending connection, and connects that
     * connection.
     */
    private void receivePlayerName(Packet packet, int connId) {
<span class="nc" id="L846">        final IConnection conn = getPendingConnection(connId);</span>
<span class="nc" id="L847">        String name = (String) packet.getObject(0);</span>
<span class="nc" id="L848">        boolean returning = false;</span>

        // this had better be from a pending connection
<span class="nc bnc" id="L851" title="All 2 branches missed.">        if (conn == null) {</span>
<span class="nc" id="L852">            MegaMek.getLogger().warning(&quot;Got a client name from a non-pending connection&quot;);</span>
<span class="nc" id="L853">            return;</span>
        }

        // check if they're connecting with the same name as a ghost player
<span class="nc bnc" id="L857" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L858">            IPlayer player = i.nextElement();</span>
<span class="nc bnc" id="L859" title="All 2 branches missed.">            if (player.getName().equals(name)) {</span>
<span class="nc bnc" id="L860" title="All 2 branches missed.">                if (player.isGhost()) {</span>
<span class="nc" id="L861">                    returning = true;</span>
<span class="nc" id="L862">                    player.setGhost(false);</span>
                    // switch id
<span class="nc" id="L864">                    connId = player.getId();</span>
<span class="nc" id="L865">                    conn.setId(connId);</span>
                }
            }
<span class="nc" id="L868">        }</span>

<span class="nc bnc" id="L870" title="All 2 branches missed.">        if (!returning) {</span>
            // Check to avoid duplicate names...
<span class="nc" id="L872">            name = correctDupeName(name);</span>
<span class="nc" id="L873">            sendToPending(connId, new Packet(Packet.COMMAND_SERVER_CORRECT_NAME, name));</span>
        }

        // right, switch the connection into the &quot;active&quot; bin
<span class="nc" id="L877">        connectionsPending.removeElement(conn);</span>
<span class="nc" id="L878">        connections.addElement(conn);</span>
<span class="nc" id="L879">        connectionIds.put(conn.getId(), conn);</span>

        // add and validate the player info
<span class="nc bnc" id="L882" title="All 2 branches missed.">        if (!returning) {</span>
<span class="nc" id="L883">            addNewPlayer(connId, name);</span>
        }

        // if it is not the lounge phase, this player becomes an observer
<span class="nc" id="L887">        IPlayer player = getPlayer(connId);</span>
<span class="nc bnc" id="L888" title="All 4 branches missed.">        if ((game.getPhase() != IGame.Phase.PHASE_LOUNGE) &amp;&amp; (null != player)</span>
<span class="nc bnc" id="L889" title="All 2 branches missed.">            &amp;&amp; (game.getEntitiesOwnedBy(player) &lt; 1)) {</span>
<span class="nc" id="L890">            player.setObserver(true);</span>
        }

        // send the player the motd
<span class="nc" id="L894">        sendServerChat(connId, motd);</span>

        // send info that the player has connected
<span class="nc" id="L897">        send(createPlayerConnectPacket(connId));</span>

        // tell them their local playerId
<span class="nc" id="L900">        send(connId, new Packet(Packet.COMMAND_LOCAL_PN, connId));</span>

        // send current game info
<span class="nc" id="L903">        sendCurrentInfo(connId);</span>

        try {
<span class="nc" id="L906">            InetAddress[] addresses = InetAddress.getAllByName(InetAddress</span>
<span class="nc" id="L907">                    .getLocalHost().getHostName());</span>
<span class="nc bnc" id="L908" title="All 2 branches missed.">            for (InetAddress addresse : addresses) {</span>
<span class="nc" id="L909">                sendServerChat(connId,</span>
<span class="nc" id="L910">                               &quot;Machine IP is &quot; + addresse.getHostAddress());</span>
            }
<span class="nc" id="L912">        } catch (UnknownHostException e) {</span>
            // oh well.
<span class="nc" id="L914">        }</span>

        // Send the port we're listening on. Only useful for the player
        // on the server machine to check.
<span class="nc" id="L918">        sendServerChat(connId,</span>
<span class="nc" id="L919">                       &quot;Listening on port &quot; + serverSocket.getLocalPort());</span>

        // Get the player *again*, because they may have disconnected.
<span class="nc" id="L922">        player = getPlayer(connId);</span>
<span class="nc bnc" id="L923" title="All 2 branches missed.">        if (null != player) {</span>
<span class="nc" id="L924">            String who = player.getName() + &quot; connected from &quot; + getClient(connId).getInetAddress();</span>
<span class="nc" id="L925">            MegaMek.getLogger().info(&quot;s: player #&quot; + connId + &quot;, &quot; + who);</span>
<span class="nc" id="L926">            sendServerChat(who);</span>

        } // Found the player

<span class="nc" id="L930">    }</span>

    /**
     * Sends a player the info they need to look at the current phase. This is
     * triggered when a player first connects to the server.
     */
    public void sendCurrentInfo(int connId) {
        // why are these two outside the player != null check below?
<span class="nc" id="L938">        transmitAllPlayerConnects(connId);</span>
<span class="nc" id="L939">        send(connId, createGameSettingsPacket());</span>
<span class="nc" id="L940">        send(connId, createPlanetaryConditionsPacket());</span>

<span class="nc" id="L942">        IPlayer player = game.getPlayer(connId);</span>
<span class="nc bnc" id="L943" title="All 2 branches missed.">        if (null != player) {</span>
<span class="nc" id="L944">            send(connId,</span>
                 new Packet(Packet.COMMAND_SENDING_MINEFIELDS, player
<span class="nc" id="L946">                         .getMinefields()));</span>

<span class="nc bnc" id="L948" title="All 2 branches missed.">            if (game.getPhase() == Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L949">                send(connId, createMapSettingsPacket());</span>
<span class="nc" id="L950">                send(createMapSizesPacket());</span>
                // Send Entities *after* the Lounge Phase Change
<span class="nc" id="L952">                send(connId,</span>
<span class="nc" id="L953">                        new Packet(Packet.COMMAND_PHASE_CHANGE, game.getPhase()));</span>
<span class="nc bnc" id="L954" title="All 2 branches missed.">                if (doBlind()) {</span>
<span class="nc" id="L955">                    send(connId, createFilteredFullEntitiesPacket(player));</span>
                } else {
<span class="nc" id="L957">                    send(connId, createFullEntitiesPacket());</span>
                }
            } else {
<span class="nc" id="L960">                send(connId, new Packet(Packet.COMMAND_ROUND_UPDATE, game.getRoundCount()));</span>
<span class="nc" id="L961">                send(connId, createBoardPacket());</span>
<span class="nc" id="L962">                send(connId, createAllReportsPacket(player));</span>

                // Send entities *before* other phase changes.
<span class="nc bnc" id="L965" title="All 2 branches missed.">                if (doBlind()) {</span>
<span class="nc" id="L966">                    send(connId, createFilteredFullEntitiesPacket(player));</span>
                } else {
<span class="nc" id="L968">                    send(connId, createFullEntitiesPacket());</span>
                }
<span class="nc bnc" id="L970" title="All 2 branches missed.">                player.setDone(game.getEntitiesOwnedBy(player) &lt;= 0);</span>
<span class="nc" id="L971">                send(connId, new Packet(Packet.COMMAND_PHASE_CHANGE, game.getPhase()));</span>
            }
<span class="nc bnc" id="L973" title="All 2 branches missed.">            if ((game.getPhase() == IGame.Phase.PHASE_FIRING)</span>
<span class="nc bnc" id="L974" title="All 2 branches missed.">                    || (game.getPhase() == IGame.Phase.PHASE_TARGETING)</span>
<span class="nc bnc" id="L975" title="All 2 branches missed.">                    || (game.getPhase() == IGame.Phase.PHASE_OFFBOARD)</span>
<span class="nc bnc" id="L976" title="All 2 branches missed.">                    || (game.getPhase() == IGame.Phase.PHASE_PHYSICAL)) {</span>
                // can't go above, need board to have been sent
<span class="nc" id="L978">                send(connId, createAttackPacket(game.getActionsVector(), 0));</span>
<span class="nc" id="L979">                send(connId, createAttackPacket(game.getChargesVector(), 1));</span>
<span class="nc" id="L980">                send(connId, createAttackPacket(game.getRamsVector(), 1));</span>
<span class="nc" id="L981">                send(connId, createAttackPacket(game.getTeleMissileAttacksVector(), 1));</span>
            }
            
<span class="nc bnc" id="L984" title="All 4 branches missed.">            if (game.phaseHasTurns(game.getPhase()) &amp;&amp; game.hasMoreTurns()) {</span>
<span class="nc" id="L985">                send(connId, createTurnVectorPacket());</span>
<span class="nc" id="L986">                send(connId, createTurnIndexPacket(connId));</span>
<span class="nc bnc" id="L987" title="All 2 branches missed.">            } else if (game.getPhase() != IGame.Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L988">                endCurrentPhase();</span>
            }

<span class="nc" id="L991">            send(connId, createArtilleryPacket(player));</span>
<span class="nc" id="L992">            send(connId, createFlarePacket());</span>
<span class="nc" id="L993">            send(connId, createSpecialHexDisplayPacket(connId));</span>

        } // Found the player.

<span class="nc" id="L997">    }</span>

    /**
     * Resend entities to the player called by SeeAll command
     */
    public void sendEntities(int connId) {
<span class="nc bnc" id="L1003" title="All 2 branches missed.">        if (doBlind()) {</span>
<span class="nc" id="L1004">            send(connId, createFilteredEntitiesPacket(getPlayer(connId), null));</span>
        } else {
<span class="nc" id="L1006">            send(connId, createEntitiesPacket());</span>
        }
<span class="nc" id="L1008">    }</span>

    /**
     * Adds a new player to the game
     */
    private IPlayer addNewPlayer(int connId, String name) {
<span class="nc" id="L1014">        int team = IPlayer.TEAM_UNASSIGNED;</span>
<span class="nc bnc" id="L1015" title="All 2 branches missed.">        if (game.getPhase() == Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L1016">            team = IPlayer.TEAM_NONE;</span>
<span class="nc bnc" id="L1017" title="All 2 branches missed.">            for (IPlayer p : game.getPlayersVector()) {</span>
<span class="nc bnc" id="L1018" title="All 2 branches missed.">                if (p.getTeam() &gt; team) {</span>
<span class="nc" id="L1019">                    team = p.getTeam();</span>
                }
<span class="nc" id="L1021">            }</span>
<span class="nc" id="L1022">            team++;</span>
        }
<span class="nc" id="L1024">        IPlayer newPlayer = new Player(connId, name);</span>
<span class="nc" id="L1025">        PlayerColour colour = newPlayer.getColour();</span>
<span class="nc" id="L1026">        Enumeration&lt;IPlayer&gt; players = game.getPlayers();</span>
<span class="nc" id="L1027">        final PlayerColour[] colours = PlayerColour.values();</span>
<span class="nc bnc" id="L1028" title="All 2 branches missed.">        while (players.hasMoreElements()) {</span>
<span class="nc" id="L1029">            final IPlayer p = players.nextElement();</span>
<span class="nc bnc" id="L1030" title="All 2 branches missed.">            if (p.getId() == newPlayer.getId()) {</span>
<span class="nc" id="L1031">                continue;</span>
            }

<span class="nc bnc" id="L1034" title="All 4 branches missed.">            if ((p.getColour() == colour) &amp;&amp; (colours.length &gt; (colour.ordinal() + 1))) {</span>
<span class="nc" id="L1035">                colour = colours[colour.ordinal() + 1];</span>
            }
<span class="nc" id="L1037">        }</span>
<span class="nc" id="L1038">        newPlayer.setColour(colour);</span>
<span class="nc" id="L1039">        newPlayer.setCamoCategory(Camouflage.COLOUR_CAMOUFLAGE);</span>
<span class="nc" id="L1040">        newPlayer.setCamoFileName(colour.name());</span>
<span class="nc" id="L1041">        newPlayer.setTeam(Math.min(team, 5));</span>
<span class="nc" id="L1042">        game.addPlayer(connId, newPlayer);</span>
<span class="nc" id="L1043">        validatePlayerInfo(connId);</span>
<span class="nc" id="L1044">        return newPlayer;</span>
    }

    /**
     * Validates the player info.
     */
    public void validatePlayerInfo(int playerId) {
<span class="nc" id="L1051">        final IPlayer player = getPlayer(playerId);</span>

<span class="nc bnc" id="L1053" title="All 2 branches missed.">        if (player != null) {</span>
            // TODO : check for duplicate or reserved names

            // Colour Assignment
<span class="nc" id="L1057">            final PlayerColour[] playerColours = PlayerColour.values();</span>
<span class="nc" id="L1058">            boolean allUsed = true;</span>
<span class="nc" id="L1059">            Set&lt;PlayerColour&gt; colourUtilization = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L1060" title="All 2 branches missed.">            for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L1061">                final IPlayer otherPlayer = i.nextElement();</span>
<span class="nc bnc" id="L1062" title="All 2 branches missed.">                if (otherPlayer.getId() != playerId) {</span>
<span class="nc" id="L1063">                    colourUtilization.add(otherPlayer.getColour());</span>
                } else {
<span class="nc" id="L1065">                    allUsed = false;</span>
                }
<span class="nc" id="L1067">            }</span>

<span class="nc bnc" id="L1069" title="All 4 branches missed.">            if (!allUsed &amp;&amp; colourUtilization.contains(player.getColour())) {</span>
<span class="nc bnc" id="L1070" title="All 2 branches missed.">                for (PlayerColour colour : playerColours) {</span>
<span class="nc bnc" id="L1071" title="All 2 branches missed.">                    if (!colourUtilization.contains(colour)) {</span>
<span class="nc" id="L1072">                        player.setColour(colour);</span>
<span class="nc" id="L1073">                        break;</span>
                    }
                }
            }
        }
<span class="nc" id="L1078">    }</span>

    /**
     * Called when it's been determined that an actual player disconnected.
     * Notifies the other players and does the appropriate housekeeping.
     */
    void disconnected(IPlayer player) {
<span class="nc" id="L1085">        IGame.Phase phase = game.getPhase();</span>

        // in the lounge, just remove all entities for that player
<span class="nc bnc" id="L1088" title="All 2 branches missed.">        if (phase == IGame.Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L1089">            removeAllEntitiesOwnedBy(player);</span>
        }

        // if a player has active entities, he becomes a ghost
        // except the VICTORY_PHASE when the disconnected
        // player is most likely the Bot disconnected after receiving
        // the COMMAND_END_OF_GAME command
        // see the Bug 1225949.
        // Ghost players (Bots mostly) are now removed during the
        // resetGame(), so we don't need to do it here.
        // This fixes Bug 3399000 without reintroducing 1225949
<span class="nc bnc" id="L1100" title="All 4 branches missed.">        if ((phase == IGame.Phase.PHASE_VICTORY)</span>
<span class="nc bnc" id="L1101" title="All 2 branches missed.">            || (phase == IGame.Phase.PHASE_LOUNGE) || player.isObserver()) {</span>
<span class="nc" id="L1102">            game.removePlayer(player.getId());</span>
<span class="nc" id="L1103">            send(new Packet(Packet.COMMAND_PLAYER_REMOVE, player.getId()));</span>
            // Prevent situation where all players but the disconnected one
            // are done, and the disconnecting player causes the game to start
<span class="nc bnc" id="L1106" title="All 2 branches missed.">            if (phase == IGame.Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L1107">                resetActivePlayersDone();</span>
            }
        } else {
<span class="nc" id="L1110">            player.setGhost(true);</span>
<span class="nc" id="L1111">            player.setDone(true);</span>
<span class="nc" id="L1112">            send(createPlayerUpdatePacket(player.getId()));</span>
        }

        // make sure the game advances
<span class="nc bnc" id="L1116" title="All 4 branches missed.">        if (game.phaseHasTurns(game.getPhase()) &amp;&amp; (null != game.getTurn())) {</span>
<span class="nc bnc" id="L1117" title="All 2 branches missed.">            if (game.getTurn().isValid(player.getId(), game)) {</span>
<span class="nc" id="L1118">                sendGhostSkipMessage(player);</span>
            }
        } else {
<span class="nc" id="L1121">            checkReady();</span>
        }

        // notify other players
<span class="nc" id="L1125">        sendServerChat(player.getName() + &quot; disconnected.&quot;);</span>

        // log it
<span class="nc" id="L1128">        MegaMek.getLogger().info(&quot;s: removed player &quot; + player.getName());</span>

        // Reset the game after Elvis has left the building.
<span class="nc bnc" id="L1131" title="All 2 branches missed.">        if (0 == game.getNoOfPlayers()) {</span>
<span class="nc" id="L1132">            resetGame();</span>
        }
<span class="nc" id="L1134">    }</span>

    /**
     * Checks each player to see if he has no entities, and if true, sets the
     * observer flag for that player. An exception is that there are no
     * observers during the lounge phase.
     */
    public void checkForObservers() {
<span class="nc bnc" id="L1142" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; e = game.getPlayers(); e.hasMoreElements(); ) {</span>
<span class="nc" id="L1143">            IPlayer p = e.nextElement();</span>
<span class="nc bnc" id="L1144" title="All 2 branches missed.">            p.setObserver((game.getEntitiesOwnedBy(p) &lt; 1)</span>
<span class="nc bnc" id="L1145" title="All 2 branches missed.">                          &amp;&amp; (game.getPhase() != IGame.Phase.PHASE_LOUNGE));</span>
<span class="nc" id="L1146">        }</span>
<span class="nc" id="L1147">    }</span>

    /**
     * Reset the game back to the lounge.
     * TODO : couldn't this be a hazard if there are other things executing at the same time?
     */
    public void resetGame() {
        // remove all entities
<span class="nc" id="L1155">        game.reset();</span>
<span class="nc" id="L1156">        send(createEntitiesPacket());</span>
<span class="nc" id="L1157">        send(new Packet(Packet.COMMAND_SENDING_MINEFIELDS, new Vector&lt;&gt;()));</span>

        // remove ghosts
<span class="nc" id="L1160">        List&lt;IPlayer&gt; ghosts = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1161" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; players = game.getPlayers(); players.hasMoreElements(); ) {</span>
<span class="nc" id="L1162">            IPlayer p = players.nextElement();</span>
<span class="nc bnc" id="L1163" title="All 2 branches missed.">            if (p.isGhost()) {</span>
<span class="nc" id="L1164">                ghosts.add(p);</span>
            } else {
                // non-ghosts set their starting positions to any
<span class="nc" id="L1167">                p.setStartingPos(Board.START_ANY);</span>
<span class="nc" id="L1168">                send(createPlayerUpdatePacket(p.getId()));</span>
            }
<span class="nc" id="L1170">        }</span>
<span class="nc bnc" id="L1171" title="All 2 branches missed.">        for (IPlayer p : ghosts) {</span>
<span class="nc" id="L1172">            game.removePlayer(p.getId());</span>
<span class="nc" id="L1173">            send(new Packet(Packet.COMMAND_PLAYER_REMOVE, p.getId()));</span>
<span class="nc" id="L1174">        }</span>

        // reset all players
<span class="nc" id="L1177">        resetPlayersDone();</span>
<span class="nc" id="L1178">        transmitAllPlayerDones();</span>

        // Write end of game to stdout so controlling scripts can rotate logs.
<span class="nc" id="L1181">        SimpleDateFormat format = new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss z&quot;);</span>
<span class="nc" id="L1182">        MegaMek.getLogger().info(format.format(new Date()) + &quot; END OF GAME&quot;);</span>

<span class="nc" id="L1184">        changePhase(IGame.Phase.PHASE_LOUNGE);</span>
<span class="nc" id="L1185">    }</span>

    /**
     * automatically save the game
     */
    public void autoSave() {
<span class="nc" id="L1191">        String fileName = &quot;autosave&quot;;</span>
<span class="nc bnc" id="L1192" title="All 2 branches missed.">        if (PreferenceManager.getClientPreferences().stampFilenames()) {</span>
<span class="nc" id="L1193">            fileName = StringUtil.addDateTimeStamp(fileName);</span>
        }
<span class="nc" id="L1195">        saveGame(fileName, game.getOptions().booleanOption(OptionsConstants.BASE_AUTOSAVE_MSG));</span>
<span class="nc" id="L1196">    }</span>

    /**
     * save the game and send it to the specified connection
     *
     * @param connId     The &lt;code&gt;int&lt;/code&gt; connection id to send to
     * @param sFile      The &lt;code&gt;String&lt;/code&gt; filename to use
     * @param sLocalPath The &lt;code&gt;String&lt;/code&gt; path to the file to be used on the
     *                   client
     */
    public void sendSaveGame(int connId, String sFile, String sLocalPath) {
<span class="nc" id="L1207">        saveGame(sFile, false);</span>
<span class="nc" id="L1208">        String sFinalFile = sFile;</span>
<span class="nc bnc" id="L1209" title="All 2 branches missed.">        if (!sFinalFile.endsWith(&quot;.sav.gz&quot;)) {</span>
<span class="nc bnc" id="L1210" title="All 2 branches missed.">            if (sFinalFile.endsWith(&quot;.sav&quot;)) {</span>
<span class="nc" id="L1211">                sFinalFile = sFile + &quot;.gz&quot;;</span>
            } else {
<span class="nc" id="L1213">                sFinalFile = sFile + &quot;.sav.gz&quot;;</span>
            }
        }
<span class="nc" id="L1216">        sLocalPath = sLocalPath.replaceAll(&quot;\\|&quot;, &quot; &quot;);</span>
<span class="nc" id="L1217">        String localFile = &quot;savegames&quot; + File.separator + sFinalFile;</span>
<span class="nc" id="L1218">        try (InputStream in = new FileInputStream(localFile); InputStream bin = new BufferedInputStream(in)) {</span>
<span class="nc" id="L1219">            List&lt;Integer&gt; data = new ArrayList&lt;&gt;();</span>
            int input;
<span class="nc bnc" id="L1221" title="All 2 branches missed.">            while ((input = bin.read()) != -1) {</span>
<span class="nc" id="L1222">                data.add(input);</span>
            }
<span class="nc" id="L1224">            send(connId, new Packet(Packet.COMMAND_SEND_SAVEGAME, new Object[]{</span>
                    sFinalFile, data, sLocalPath}));
<span class="nc" id="L1226">            sendChat(connId, &quot;***Server&quot;, &quot;Save game has been sent to you.&quot;);</span>
<span class="nc" id="L1227">        } catch (Exception e) {</span>
<span class="nc" id="L1228">            MegaMek.getLogger().error(&quot;Unable to load file: &quot; + localFile, e);</span>
<span class="nc" id="L1229">        }</span>
<span class="nc" id="L1230">    }</span>

    /**
     * save the game
     *
     * @param sFile    The &lt;code&gt;String&lt;/code&gt; filename to use
     * @param sendChat A &lt;code&gt;boolean&lt;/code&gt; value whether or not to announce the
     *                 saving to the server chat.
     */
    public void saveGame(String sFile, boolean sendChat) {
        // We need to strip the .gz if it exists,
        // otherwise we'll double up on it.
<span class="nc bnc" id="L1242" title="All 2 branches missed.">        if (sFile.endsWith(&quot;.gz&quot;)) {</span>
<span class="nc" id="L1243">            sFile = sFile.replace(&quot;.gz&quot;, &quot;&quot;);</span>
        }
<span class="nc" id="L1245">        XStream xstream = new XStream();</span>

        // This will make save games much smaller
        // by using a more efficient means of referencing
        // objects in the XML graph
<span class="nc" id="L1250">        xstream.setMode(XStream.ID_REFERENCES);</span>

<span class="nc" id="L1252">        String sFinalFile = sFile;</span>
<span class="nc bnc" id="L1253" title="All 2 branches missed.">        if (!sFinalFile.endsWith(&quot;.sav&quot;)) {</span>
<span class="nc" id="L1254">            sFinalFile = sFile + &quot;.sav&quot;;</span>
        }
<span class="nc" id="L1256">        File sDir = new File(&quot;savegames&quot;);</span>
<span class="nc bnc" id="L1257" title="All 2 branches missed.">        if (!sDir.exists()) {</span>
<span class="nc" id="L1258">            sDir.mkdir();</span>
        }

<span class="nc" id="L1261">        sFinalFile = sDir + File.separator + sFinalFile;</span>

<span class="nc" id="L1263">        try (OutputStream os = new FileOutputStream(sFinalFile + &quot;.gz&quot;);</span>
<span class="nc" id="L1264">             OutputStream gzo = new GZIPOutputStream(os);</span>
<span class="nc" id="L1265">             Writer writer = new OutputStreamWriter(gzo, StandardCharsets.UTF_8)) {</span>

<span class="nc" id="L1267">            xstream.toXML(game, writer);</span>
<span class="nc" id="L1268">        } catch (Exception e) {</span>
<span class="nc" id="L1269">            MegaMek.getLogger().error(&quot;Unable to save file: &quot; + sFinalFile, e);</span>
<span class="nc" id="L1270">        }</span>

<span class="nc bnc" id="L1272" title="All 2 branches missed.">        if (sendChat) {</span>
<span class="nc" id="L1273">            sendChat(&quot;MegaMek&quot;, &quot;Game saved to &quot; + sFinalFile);</span>
        }
<span class="nc" id="L1275">    }</span>

    /**
     * save the game
     *
     * @param sFile The &lt;code&gt;String&lt;/code&gt; filename to use
     */
    public void saveGame(String sFile) {
<span class="nc" id="L1283">        saveGame(sFile, true);</span>
<span class="nc" id="L1284">    }</span>

    /**
     * send a packet to the connection tells it load a locally saved game
     *
     * @param connId The &lt;code&gt;int&lt;/code&gt; connection id to send to
     * @param sFile  The &lt;code&gt;String&lt;/code&gt; filename to use
     */
    public void sendLoadGame(int connId, String sFile) {
<span class="nc" id="L1293">        String sFinalFile = sFile;</span>
<span class="nc bnc" id="L1294" title="All 4 branches missed.">        if (!sFinalFile.endsWith(&quot;.sav&quot;) &amp;&amp; !sFinalFile.endsWith(&quot;.sav.gz&quot;)) {</span>
<span class="nc" id="L1295">            sFinalFile = sFile + &quot;.sav&quot;;</span>
        }
<span class="nc bnc" id="L1297" title="All 2 branches missed.">        if (!sFinalFile.endsWith(&quot;.gz&quot;)) {</span>
<span class="nc" id="L1298">            sFinalFile = sFinalFile + &quot;.gz&quot;;</span>
        }
<span class="nc" id="L1300">        send(connId, new Packet(Packet.COMMAND_LOAD_SAVEGAME, new Object[]{sFinalFile}));</span>
<span class="nc" id="L1301">    }</span>

    /**
     * load the game
     *
     * @param f The &lt;code&gt;File&lt;/code&gt; to load
     * @return A &lt;code&gt;boolean&lt;/code&gt; value whether or not the loading was successful
     */
    public boolean loadGame(File f) {
<span class="nc" id="L1310">        return loadGame(f, true);</span>
    }

    /**
     * load the game
     *
     * @param f
     *            The &lt;code&gt;File&lt;/code&gt; to load
     * @param sendInfo
     *            Determines whether the connections should be updated with
     *            current info. This may be false if some reconnection remapping
     *            needs to be done first.
     * @return A &lt;code&gt;boolean&lt;/code&gt; value whether or not the loading was successful
     */
    public boolean loadGame(File f, boolean sendInfo) {
<span class="nc" id="L1325">        MegaMek.getLogger().info(&quot;s: loading saved game file '&quot; + f + &quot;'&quot;);</span>

        IGame newGame;
<span class="nc" id="L1328">        try (InputStream is = new FileInputStream(f); InputStream gzi = new GZIPInputStream(is)) {</span>
<span class="nc" id="L1329">            XStream xstream = SerializationHelper.getXStream();</span>
<span class="nc" id="L1330">            newGame = (IGame) xstream.fromXML(gzi);</span>
<span class="nc" id="L1331">        } catch (Exception e) {</span>
<span class="nc" id="L1332">            MegaMek.getLogger().error(&quot;Unable to load file: &quot; + f, e);</span>
<span class="nc" id="L1333">            return false;</span>
<span class="nc" id="L1334">        }</span>

<span class="nc" id="L1336">        setGame(newGame);</span>

<span class="nc bnc" id="L1338" title="All 2 branches missed.">        if (!sendInfo) {</span>
<span class="nc" id="L1339">            return true;</span>
        }

        // update all the clients with the new game info
<span class="nc bnc" id="L1343" title="All 2 branches missed.">        for (IConnection conn : connections) {</span>
<span class="nc" id="L1344">            sendCurrentInfo(conn.getId());</span>
<span class="nc" id="L1345">        }</span>
<span class="nc" id="L1346">        return true;</span>
    }

    /**
     * When the load command is used, there is a list of already connected
     * players which have assigned names and player id numbers with the id
     * numbers matching the connection numbers. When a new game is loaded, this
     * mapping may need to be updated. This method takes a map of player names
     * to their current ids, and uses the list of players to figure out what the
     * current ids should change to.
     *
     * @param nameToIdMap
     *            This maps a player name to the current connection ID
     * @param idToNameMap
     *            This maps a current conn ID to a player name, and is just the
     *            inverse mapping from nameToIdMap
     */
    public void remapConnIds(Map&lt;String, Integer&gt; nameToIdMap, Map&lt;Integer, String&gt; idToNameMap) {
        // Keeps track of connections without Ids
<span class="nc" id="L1365">        List&lt;IConnection&gt; unassignedConns = new ArrayList&lt;&gt;();</span>
       // Keep track of which ids are used
<span class="nc" id="L1367">        Set&lt;Integer&gt; usedPlayerIds = new HashSet&lt;&gt;();</span>
<span class="nc" id="L1368">        Set&lt;String&gt; currentPlayerNames = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L1369" title="All 2 branches missed.">        for (IPlayer p : game.getPlayersVector()) {</span>
<span class="nc" id="L1370">            currentPlayerNames.add(p.getName());</span>
<span class="nc" id="L1371">        }</span>
        // Map the old connection Id to new value
<span class="nc" id="L1373">        Map&lt;Integer,Integer&gt; connIdRemapping = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L1374" title="All 2 branches missed.">        for (IPlayer p : game.getPlayersVector()) {</span>
            // Check to see if this player was already connected
<span class="nc" id="L1376">            Integer oldId = nameToIdMap.get(p.getName());</span>
<span class="nc bnc" id="L1377" title="All 4 branches missed.">            if ((oldId != null) &amp;&amp; (oldId != p.getId())) {</span>
<span class="nc" id="L1378">                connIdRemapping.put(oldId, p.getId());</span>
            }
            // If the old and new Ids match, make sure we remove ghost status
<span class="nc bnc" id="L1381" title="All 4 branches missed.">            if ((oldId != null) &amp;&amp; (oldId == p.getId())) {</span>
<span class="nc" id="L1382">                p.setGhost(false);</span>
            }
            // Check to see if this player's Id is taken
<span class="nc" id="L1385">            String oldName = idToNameMap.get(p.getId());</span>
<span class="nc bnc" id="L1386" title="All 4 branches missed.">            if ((oldName != null) &amp;&amp; !oldName.equals(p.getName())) {</span>
                // If this name doesn't belong to a current player, unassign it
<span class="nc bnc" id="L1388" title="All 2 branches missed.">                if (!currentPlayerNames.contains(oldName)) {</span>
<span class="nc" id="L1389">                    unassignedConns.add(connectionIds.get(p.getId()));</span>
                    // Make sure we don't add this to unassigned connections twice
<span class="nc" id="L1391">                    connectionIds.remove(p.getId());</span>
                }
                // If it does belong to a current player, it'll get handled
                // when that player comes up
            }
            // Keep track of what Ids are used
<span class="nc" id="L1397">            usedPlayerIds.add(p.getId());</span>
<span class="nc" id="L1398">        }</span>

        // Remap old connection Ids to new ones
<span class="nc bnc" id="L1401" title="All 2 branches missed.">        for (Integer currConnId : connIdRemapping.keySet()) {</span>
<span class="nc" id="L1402">            Integer newId = connIdRemapping.get(currConnId);</span>
<span class="nc" id="L1403">            IConnection conn = connectionIds.get(currConnId);</span>
<span class="nc" id="L1404">            conn.setId(newId);</span>
            // If this Id is used, make sure we reassign that connection
<span class="nc bnc" id="L1406" title="All 2 branches missed.">            if (connectionIds.containsKey(newId)) {</span>
<span class="nc" id="L1407">                unassignedConns.add(connectionIds.get(newId));</span>
            }
            // Map the new Id
<span class="nc" id="L1410">            connectionIds.put(newId, conn);</span>

<span class="nc" id="L1412">            game.getPlayer(newId).setGhost(false);</span>
<span class="nc" id="L1413">            send(newId, new Packet(Packet.COMMAND_LOCAL_PN, newId));</span>
<span class="nc" id="L1414">        }</span>

        // It's possible we have players not in the saved game, add 'em
<span class="nc bnc" id="L1417" title="All 2 branches missed.">        for (IConnection conn : unassignedConns) {</span>
<span class="nc" id="L1418">            int newId = 0;</span>
<span class="nc bnc" id="L1419" title="All 2 branches missed.">            while (usedPlayerIds.contains(newId)) {</span>
<span class="nc" id="L1420">                newId++;</span>
            }
<span class="nc" id="L1422">            String name = idToNameMap.get(conn.getId());</span>
<span class="nc" id="L1423">            conn.setId(newId);</span>
<span class="nc" id="L1424">            IPlayer newPlayer = addNewPlayer(newId, name);</span>
<span class="nc" id="L1425">            newPlayer.setObserver(true);</span>
<span class="nc" id="L1426">            connectionIds.put(newId,  conn);</span>
<span class="nc" id="L1427">            send(newId, new Packet(Packet.COMMAND_LOCAL_PN, newId));</span>
<span class="nc" id="L1428">        }</span>

        // Ensure all clients are up-to-date on player info
<span class="nc" id="L1431">        transmitAllPlayerUpdates();</span>
<span class="nc" id="L1432">    }</span>

    /**
     * Shortcut to game.getPlayer(id)
     */
    public IPlayer getPlayer(int id) {
<span class="nc" id="L1438">        return game.getPlayer(id);</span>
    }

    /**
     * Removes all entities owned by a player. Should only be called when it
     * won't cause trouble (the lounge, for instance, or between phases.)
     *
     * @param player whose entities are to be removed
     */
    private void removeAllEntitiesOwnedBy(IPlayer player) {
<span class="nc" id="L1448">        Vector&lt;Entity&gt; toRemove = new Vector&lt;&gt;();</span>

<span class="nc bnc" id="L1450" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext(); ) {</span>
<span class="nc" id="L1451">            final Entity entity = e.next();</span>

<span class="nc bnc" id="L1453" title="All 2 branches missed.">            if (entity.getOwner().equals(player)) {</span>
<span class="nc" id="L1454">                toRemove.addElement(entity);</span>
            }
<span class="nc" id="L1456">        }</span>

<span class="nc bnc" id="L1458" title="All 2 branches missed.">        for (Entity entity : toRemove) {</span>
<span class="nc" id="L1459">            int id = entity.getId();</span>
<span class="nc" id="L1460">            game.removeEntity(id, IEntityRemovalConditions.REMOVE_NEVER_JOINED);</span>
<span class="nc" id="L1461">            send(createRemoveEntityPacket(id, IEntityRemovalConditions.REMOVE_NEVER_JOINED));</span>
<span class="nc" id="L1462">        }</span>
<span class="nc" id="L1463">    }</span>

    /**
     * a shorter name for getConnection()
     */
    private IConnection getClient(int connId) {
<span class="nc" id="L1469">        return getConnection(connId);</span>
    }

    /**
     * Returns a connection, indexed by id
     */
    public Enumeration&lt;IConnection&gt; getConnections() {
<span class="nc" id="L1476">        return connections.elements();</span>
    }

    /**
     * Returns a connection, indexed by id
     */
    public IConnection getConnection(int connId) {
<span class="nc" id="L1483">        return connectionIds.get(connId);</span>
    }

    /**
     * Returns a pending connection
     */
    IConnection getPendingConnection(int connId) {
<span class="nc bnc" id="L1490" title="All 2 branches missed.">        for (IConnection conn : connectionsPending) {</span>
<span class="nc bnc" id="L1491" title="All 2 branches missed.">            if (conn.getId() == connId) {</span>
<span class="nc" id="L1492">                return conn;</span>
            }
<span class="nc" id="L1494">        }</span>
<span class="nc" id="L1495">        return null;</span>
    }

    /**
     * Called at the beginning of each game round to reset values on this entity
     * that are reset every round
     */
    private void resetEntityRound() {
<span class="nc bnc" id="L1503" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext(); ) {</span>
<span class="nc" id="L1504">            Entity entity = e.next();</span>

<span class="nc" id="L1506">            entity.newRound(game.getRoundCount());</span>
<span class="nc" id="L1507">        }</span>
<span class="nc" id="L1508">    }</span>

    /**
     * Check a list of entity Ids for doomed entities and destroy those.
     */
    private void destroyDoomedEntities(Vector&lt;Integer&gt; entityIds) {
<span class="nc" id="L1514">        Vector&lt;Entity&gt; toRemove = new Vector&lt;&gt;(0, 10);</span>
<span class="nc bnc" id="L1515" title="All 2 branches missed.">        for (Integer entityId : entityIds) {</span>
<span class="nc" id="L1516">            Entity entity = game.getEntity(entityId);</span>
<span class="nc bnc" id="L1517" title="All 2 branches missed.">            if (entity.isDoomed()) {</span>
<span class="nc" id="L1518">                entity.setDestroyed(true);</span>

                // Is this unit swarming somebody? Better let go before
                // it's too late.
<span class="nc" id="L1522">                final int swarmedId = entity.getSwarmTargetId();</span>
<span class="nc bnc" id="L1523" title="All 2 branches missed.">                if (Entity.NONE != swarmedId) {</span>
<span class="nc" id="L1524">                    final Entity swarmed = game.getEntity(swarmedId);</span>
<span class="nc" id="L1525">                    swarmed.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L1526">                    entity.setSwarmTargetId(Entity.NONE);</span>
<span class="nc" id="L1527">                    Report r = new Report(5165);</span>
<span class="nc" id="L1528">                    r.subject = swarmedId;</span>
<span class="nc" id="L1529">                    r.addDesc(swarmed);</span>
<span class="nc" id="L1530">                    addReport(r);</span>
<span class="nc" id="L1531">                    entityUpdate(swarmedId);</span>
                }
            }

<span class="nc bnc" id="L1535" title="All 2 branches missed.">            if (entity.isDestroyed()) {</span>
<span class="nc" id="L1536">                toRemove.addElement(entity);</span>
            }
<span class="nc" id="L1538">        }</span>

        // actually remove all flagged entities
<span class="nc bnc" id="L1541" title="All 2 branches missed.">        for (Entity entity : toRemove) {</span>
<span class="nc" id="L1542">            int condition = IEntityRemovalConditions.REMOVE_SALVAGEABLE;</span>
<span class="nc bnc" id="L1543" title="All 2 branches missed.">            if (!entity.isSalvage()) {</span>
<span class="nc" id="L1544">                condition = IEntityRemovalConditions.REMOVE_DEVASTATED;</span>
            }
            // If we removed a unit during the movement phase that hasn't moved,
            // remove its turn.
<span class="nc bnc" id="L1548" title="All 4 branches missed.">            if ((game.getPhase() == Phase.PHASE_MOVEMENT) &amp;&amp; entity.isSelectableThisTurn()) {</span>
<span class="nc" id="L1549">                game.removeTurnFor(entity);</span>
<span class="nc" id="L1550">                send(createTurnVectorPacket());</span>
            }
<span class="nc" id="L1552">            entityUpdate(entity.getId());</span>
<span class="nc" id="L1553">            game.removeEntity(entity.getId(), condition);</span>
<span class="nc" id="L1554">            send(createRemoveEntityPacket(entity.getId(), condition));</span>
<span class="nc" id="L1555">        }</span>
<span class="nc" id="L1556">    }</span>

    /**
     * Deploys elligible offboard entities.
     */
    private void deployOffBoardEntities() {
        // place off board entities actually off-board
<span class="nc" id="L1563">        Iterator&lt;Entity&gt; entities = game.getEntities();</span>
<span class="nc bnc" id="L1564" title="All 2 branches missed.">        while (entities.hasNext()) {</span>
<span class="nc" id="L1565">            Entity en = entities.next();</span>
<span class="nc bnc" id="L1566" title="All 4 branches missed.">            if (en.isOffBoard() &amp;&amp; !en.isDeployed()) {</span>
<span class="nc" id="L1567">                en.deployOffBoard(game.getRoundCount());</span>
            }
<span class="nc" id="L1569">        }</span>
<span class="nc" id="L1570">    }</span>

    /**
     * Called at the beginning of each phase. Sets and resets any entity
     * parameters that need to be reset.
     */
    private void resetEntityPhase(IGame.Phase phase) {
        // first, mark doomed entities as destroyed and flag them
<span class="nc" id="L1578">        Vector&lt;Entity&gt; toRemove = new Vector&lt;&gt;(0, 10);</span>
<span class="nc bnc" id="L1579" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext(); ) {</span>
<span class="nc" id="L1580">            final Entity entity = e.next();</span>
<span class="nc" id="L1581">            entity.newPhase(phase);</span>
<span class="nc bnc" id="L1582" title="All 2 branches missed.">            if (entity.isDoomed()) {</span>
<span class="nc" id="L1583">                entity.setDestroyed(true);</span>

                // Is this unit swarming somebody? Better let go before
                // it's too late.
<span class="nc" id="L1587">                final int swarmedId = entity.getSwarmTargetId();</span>
<span class="nc bnc" id="L1588" title="All 2 branches missed.">                if (Entity.NONE != swarmedId) {</span>
<span class="nc" id="L1589">                    final Entity swarmed = game.getEntity(swarmedId);</span>
<span class="nc" id="L1590">                    swarmed.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L1591">                    entity.setSwarmTargetId(Entity.NONE);</span>
<span class="nc" id="L1592">                    Report r = new Report(5165);</span>
<span class="nc" id="L1593">                    r.subject = swarmedId;</span>
<span class="nc" id="L1594">                    r.addDesc(swarmed);</span>
<span class="nc" id="L1595">                    addReport(r);</span>
<span class="nc" id="L1596">                    entityUpdate(swarmedId);</span>
                }
            }

<span class="nc bnc" id="L1600" title="All 2 branches missed.">            if (entity.isDestroyed()) {</span>
<span class="nc bnc" id="L1601" title="All 2 branches missed.">                if (game.getEntity(entity.getTransportId()) != null</span>
<span class="nc bnc" id="L1602" title="All 2 branches missed.">                        &amp;&amp; game.getEntity(entity.getTransportId()).isLargeCraft()) {</span>
                    //Leaving destroyed entities in dropship bays alone here
                } else {
<span class="nc" id="L1605">                    toRemove.addElement(entity);</span>
                }
            }
<span class="nc" id="L1608">        }</span>

        // actually remove all flagged entities
<span class="nc bnc" id="L1611" title="All 2 branches missed.">        for (Entity entity : toRemove) {</span>
<span class="nc" id="L1612">            int condition = IEntityRemovalConditions.REMOVE_SALVAGEABLE;</span>
<span class="nc bnc" id="L1613" title="All 2 branches missed.">            if (!entity.isSalvage()) {</span>
<span class="nc" id="L1614">                condition = IEntityRemovalConditions.REMOVE_DEVASTATED;</span>
            }

<span class="nc" id="L1617">            entityUpdate(entity.getId());</span>
<span class="nc" id="L1618">            game.removeEntity(entity.getId(), condition);</span>
<span class="nc" id="L1619">            send(createRemoveEntityPacket(entity.getId(), condition));</span>
<span class="nc" id="L1620">        }</span>

        // do some housekeeping on all the remaining
<span class="nc bnc" id="L1623" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext(); ) {</span>
<span class="nc" id="L1624">            final Entity entity = e.next();</span>

<span class="nc" id="L1626">            entity.applyDamage();</span>

<span class="nc" id="L1628">            entity.reloadEmptyWeapons();</span>

            // reset damage this phase
            // telemissiles need a record of damage last phase
<span class="nc" id="L1632">            entity.damageThisRound += entity.damageThisPhase;</span>
<span class="nc" id="L1633">            entity.damageThisPhase = 0;</span>
<span class="nc" id="L1634">            entity.engineHitsThisPhase = 0;</span>
<span class="nc" id="L1635">            entity.rolledForEngineExplosion = false;</span>
<span class="nc" id="L1636">            entity.dodging = false;</span>
<span class="nc" id="L1637">            entity.setShutDownThisPhase(false);</span>
<span class="nc" id="L1638">            entity.setStartupThisPhase(false);</span>

            // reset done to false

<span class="nc bnc" id="L1642" title="All 2 branches missed.">            if (phase == IGame.Phase.PHASE_DEPLOYMENT) {</span>
<span class="nc bnc" id="L1643" title="All 2 branches missed.">                entity.setDone(!entity.shouldDeploy(game.getRoundCount()));</span>
            } else {
<span class="nc" id="L1645">                entity.setDone(false);</span>
            }

            // reset spotlights
<span class="nc" id="L1649">            entity.setIlluminated(false);</span>
<span class="nc" id="L1650">            entity.setUsedSearchlight(false);</span>
<span class="nc" id="L1651">            entity.setCarefulStand(false);</span>
<span class="nc" id="L1652">            entity.setNetworkBAP(false);</span>

<span class="nc bnc" id="L1654" title="All 2 branches missed.">            if (entity instanceof MechWarrior) {</span>
<span class="nc" id="L1655">                ((MechWarrior) entity).setLanded(true);</span>
            }
<span class="nc" id="L1657">        }</span>
<span class="nc" id="L1658">        game.clearIlluminatedPositions();</span>
<span class="nc" id="L1659">        send(new Packet(Packet.COMMAND_CLEAR_ILLUM_HEXES));</span>
<span class="nc" id="L1660">    }</span>

    /*
     *  Called during the end phase. Checks each entity for ASEW effects counters and decrements them by 1 if &gt; 0
     */

    public void decrementASEWTurns() {
<span class="nc bnc" id="L1667" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext(); ) {</span>
<span class="nc" id="L1668">            final Entity entity = e.next();</span>
            // Decrement ASEW effects
<span class="nc bnc" id="L1670" title="All 2 branches missed.">            if ((entity.getEntityType() &amp; Entity.ETYPE_DROPSHIP) == Entity.ETYPE_DROPSHIP) {</span>
<span class="nc" id="L1671">                Dropship d = (Dropship) entity;</span>
<span class="nc bnc" id="L1672" title="All 2 branches missed.">                for (int loc = 0; loc &lt; d.locations(); loc++) {</span>
<span class="nc bnc" id="L1673" title="All 2 branches missed.">                    if (d.getASEWAffected(loc) &gt; 0) {</span>
<span class="nc" id="L1674">                        d.setASEWAffected(loc, d.getASEWAffected(loc) - 1);</span>
                    }
                }
<span class="nc bnc" id="L1677" title="All 2 branches missed.">            } else if ((entity.getEntityType() &amp; Entity.ETYPE_JUMPSHIP) != 0) {</span>
<span class="nc" id="L1678">                Jumpship j = (Jumpship) entity;</span>
<span class="nc bnc" id="L1679" title="All 2 branches missed.">                for (int loc = 0; loc &lt; j.locations(); loc++) {</span>
<span class="nc bnc" id="L1680" title="All 2 branches missed.">                    if (j.getASEWAffected(loc) &gt; 0) {</span>
<span class="nc" id="L1681">                        j.setASEWAffected(loc, j.getASEWAffected(loc) - 1);</span>
                    }
                }
<span class="nc" id="L1684">            } else {</span>
<span class="nc bnc" id="L1685" title="All 2 branches missed.">                if (entity.getASEWAffected() &gt; 0) {</span>
<span class="nc" id="L1686">                    entity.setASEWAffected(entity.getASEWAffected() - 1);</span>
                }
            }
<span class="nc" id="L1689">        }</span>
<span class="nc" id="L1690">    }</span>


    /**
     * are we currently in a reporting phase
     *
     * @return &lt;code&gt;true&lt;/code&gt; if we are or &lt;code&gt;false&lt;/code&gt; if not.
     */
    private boolean isReportingPhase() {
<span class="nc bnc" id="L1699" title="All 2 branches missed.">        return (game.getPhase() == IGame.Phase.PHASE_FIRING_REPORT)</span>
<span class="nc bnc" id="L1700" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_INITIATIVE_REPORT)</span>
<span class="nc bnc" id="L1701" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_MOVEMENT_REPORT)</span>
<span class="nc bnc" id="L1702" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_OFFBOARD_REPORT)</span>
<span class="nc bnc" id="L1703" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_PHYSICAL_REPORT);</span>
    }

    /**
     * Called at the beginning of certain phases to make every player not ready.
     */
    private void resetPlayersDone() {
<span class="nc bnc" id="L1710" title="All 2 branches missed.">        if (isReportingPhase()) {</span>
<span class="nc" id="L1711">            return;</span>
        }
<span class="nc bnc" id="L1713" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L1714">            final IPlayer player = i.nextElement();</span>
<span class="nc" id="L1715">            player.setDone(false);</span>
<span class="nc" id="L1716">        }</span>
<span class="nc" id="L1717">        transmitAllPlayerDones();</span>
<span class="nc" id="L1718">    }</span>

    /**
     * Called at the beginning of certain phases to make every active player not
     * ready.
     */
    private void resetActivePlayersDone() {
        /*
         * if (isReportingPhase()) { return; }
         */
<span class="nc bnc" id="L1728" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L1729">            final IPlayer player = i.nextElement();</span>

<span class="nc bnc" id="L1731" title="All 2 branches missed.">            player.setDone(game.getEntitiesOwnedBy(player) &lt;= 0);</span>

<span class="nc" id="L1733">        }</span>
<span class="nc" id="L1734">        transmitAllPlayerDones();</span>
<span class="nc" id="L1735">    }</span>

    /**
     * Writes the victory report
     */
    private void prepareVictoryReport() {
        Report r;

        // remove carcasses to the graveyard
<span class="nc" id="L1744">        Vector&lt;Entity&gt; toRemove = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L1745" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L1746" title="All 4 branches missed.">            if (e.isCarcass() &amp;&amp; !e.isDestroyed()) {</span>
<span class="nc" id="L1747">                toRemove.add(e);</span>
            }
<span class="nc" id="L1749">        }</span>
<span class="nc bnc" id="L1750" title="All 2 branches missed.">        for (Entity e : toRemove) {</span>
<span class="nc" id="L1751">            destroyEntity(e, &quot;crew death&quot;, false, true);</span>
<span class="nc" id="L1752">            game.removeEntity(e.getId(), IEntityRemovalConditions.REMOVE_SALVAGEABLE);</span>
<span class="nc" id="L1753">            e.setDestroyed(true);</span>
<span class="nc" id="L1754">        }</span>

<span class="nc" id="L1756">        addReport(new Report(7000, Report.PUBLIC));</span>

        // Declare the victor
<span class="nc" id="L1759">        r = new Report(1210);</span>
<span class="nc" id="L1760">        r.type = Report.PUBLIC;</span>
<span class="nc bnc" id="L1761" title="All 2 branches missed.">        if (game.getVictoryTeam() == IPlayer.TEAM_NONE) {</span>
<span class="nc" id="L1762">            IPlayer player = getPlayer(game.getVictoryPlayerId());</span>
<span class="nc bnc" id="L1763" title="All 2 branches missed.">            if (null == player) {</span>
<span class="nc" id="L1764">                r.messageId = 7005;</span>
            } else {
<span class="nc" id="L1766">                r.messageId = 7010;</span>
<span class="nc" id="L1767">                r.add(Server.getColorForPlayer(player));</span>
            }
<span class="nc" id="L1769">        } else {</span>
            // Team victory
<span class="nc" id="L1771">            r.messageId = 7015;</span>
<span class="nc" id="L1772">            r.add(game.getVictoryTeam());</span>
        }
<span class="nc" id="L1774">        addReport(r);</span>

        // Show player BVs
<span class="nc" id="L1777">        Enumeration&lt;IPlayer&gt; players = game.getPlayers();</span>
<span class="nc bnc" id="L1778" title="All 2 branches missed.">        while (players.hasMoreElements()) {</span>
<span class="nc" id="L1779">            IPlayer player = players.nextElement();</span>
            // Players who started the game as observers get ignored
<span class="nc bnc" id="L1781" title="All 2 branches missed.">            if (player.getInitialBV() == 0) {</span>
<span class="nc" id="L1782">                continue;</span>
            }
<span class="nc" id="L1784">            r = new Report();</span>
<span class="nc" id="L1785">            r.type = Report.PUBLIC;</span>
<span class="nc" id="L1786">            r.messageId = 7016;</span>
<span class="nc" id="L1787">            r.add(Server.getColorForPlayer(player));</span>
<span class="nc" id="L1788">            r.add(player.getBV());</span>
<span class="nc" id="L1789">            r.add(Double.toString(Math.round((double) player.getBV() / player.getInitialBV() * 10000.0) / 100.0));</span>
<span class="nc" id="L1790">            r.add(player.getInitialBV());</span>
<span class="nc" id="L1791">            r.add(player.getFledBV());</span>
<span class="nc" id="L1792">            addReport(r);</span>
<span class="nc" id="L1793">        }</span>

        // List the survivors
<span class="nc" id="L1796">        Iterator&lt;Entity&gt; survivors = game.getEntities();</span>
<span class="nc bnc" id="L1797" title="All 2 branches missed.">        if (survivors.hasNext()) {</span>
<span class="nc" id="L1798">            addReport(new Report(7020, Report.PUBLIC));</span>
<span class="nc bnc" id="L1799" title="All 2 branches missed.">            while (survivors.hasNext()) {</span>
<span class="nc" id="L1800">                Entity entity = survivors.next();</span>

<span class="nc bnc" id="L1802" title="All 2 branches missed.">                if (!entity.isDeployed()) {</span>
<span class="nc" id="L1803">                    continue;</span>
                }

<span class="nc" id="L1806">                addReport(entity.victoryReport());</span>
<span class="nc" id="L1807">            }</span>
        }
        // List units that never deployed
<span class="nc" id="L1810">        Iterator&lt;Entity&gt; undeployed = game.getEntities();</span>
<span class="nc bnc" id="L1811" title="All 2 branches missed.">        if (undeployed.hasNext()) {</span>
<span class="nc" id="L1812">            boolean wroteHeader = false;</span>

<span class="nc bnc" id="L1814" title="All 2 branches missed.">            while (undeployed.hasNext()) {</span>
<span class="nc" id="L1815">                Entity entity = undeployed.next();</span>

<span class="nc bnc" id="L1817" title="All 2 branches missed.">                if (entity.isDeployed()) {</span>
<span class="nc" id="L1818">                    continue;</span>
                }

<span class="nc bnc" id="L1821" title="All 2 branches missed.">                if (!wroteHeader) {</span>
<span class="nc" id="L1822">                    addReport(new Report(7075, Report.PUBLIC));</span>
<span class="nc" id="L1823">                    wroteHeader = true;</span>
                }

<span class="nc" id="L1826">                addReport(entity.victoryReport());</span>
<span class="nc" id="L1827">            }</span>
        }
        // List units that retreated
<span class="nc" id="L1830">        Enumeration&lt;Entity&gt; retreat = game.getRetreatedEntities();</span>
<span class="nc bnc" id="L1831" title="All 2 branches missed.">        if (retreat.hasMoreElements()) {</span>
<span class="nc" id="L1832">            addReport(new Report(7080, Report.PUBLIC));</span>
<span class="nc bnc" id="L1833" title="All 2 branches missed.">            while (retreat.hasMoreElements()) {</span>
<span class="nc" id="L1834">                Entity entity = retreat.nextElement();</span>
<span class="nc" id="L1835">                addReport(entity.victoryReport());</span>
<span class="nc" id="L1836">            }</span>
        }
        // List destroyed units
<span class="nc" id="L1839">        Enumeration&lt;Entity&gt; graveyard = game.getGraveyardEntities();</span>
<span class="nc bnc" id="L1840" title="All 2 branches missed.">        if (graveyard.hasMoreElements()) {</span>
<span class="nc" id="L1841">            addReport(new Report(7085, Report.PUBLIC));</span>
<span class="nc bnc" id="L1842" title="All 2 branches missed.">            while (graveyard.hasMoreElements()) {</span>
<span class="nc" id="L1843">                Entity entity = graveyard.nextElement();</span>
<span class="nc" id="L1844">                addReport(entity.victoryReport());</span>
<span class="nc" id="L1845">            }</span>
        }
        // List devastated units (not salvageable)
<span class="nc" id="L1848">        Enumeration&lt;Entity&gt; devastated = game.getDevastatedEntities();</span>
<span class="nc bnc" id="L1849" title="All 2 branches missed.">        if (devastated.hasMoreElements()) {</span>
<span class="nc" id="L1850">            addReport(new Report(7090, Report.PUBLIC));</span>

<span class="nc bnc" id="L1852" title="All 2 branches missed.">            while (devastated.hasMoreElements()) {</span>
<span class="nc" id="L1853">                Entity entity = devastated.nextElement();</span>
<span class="nc" id="L1854">                addReport(entity.victoryReport());</span>
<span class="nc" id="L1855">            }</span>
        }
        // Let player know about entitystatus.txt file
<span class="nc" id="L1858">        addReport(new Report(7095, Report.PUBLIC));</span>
<span class="nc" id="L1859">    }</span>

    /**
     * Generates a detailed report for campaign use
     */
    private String getDetailedVictoryReport() {
<span class="nc" id="L1865">        StringBuilder sb = new StringBuilder();</span>

<span class="nc" id="L1867">        Vector&lt;Entity&gt; vAllUnits = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L1868" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L1869">            vAllUnits.addElement(i.next());</span>
        }

<span class="nc bnc" id="L1872" title="All 2 branches missed.">        for (Enumeration&lt;Entity&gt; i = game.getRetreatedEntities(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L1873">            vAllUnits.addElement(i.nextElement());</span>
        }

<span class="nc bnc" id="L1876" title="All 2 branches missed.">        for (Enumeration&lt;Entity&gt; i = game.getGraveyardEntities(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L1877">            vAllUnits.addElement(i.nextElement());</span>
        }

<span class="nc bnc" id="L1880" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
            // Record the player.
<span class="nc" id="L1882">            IPlayer p = i.nextElement();</span>
<span class="nc" id="L1883">            sb.append(&quot;++++++++++ &quot;).append(p.getName()).append(&quot; ++++++++++&quot;);</span>
<span class="nc" id="L1884">            sb.append(CommonConstants.NL);</span>

            // Record the player's alive, retreated, or salvageable units.
<span class="nc bnc" id="L1887" title="All 2 branches missed.">            for (int x = 0; x &lt; vAllUnits.size(); x++) {</span>
<span class="nc" id="L1888">                Entity e = vAllUnits.elementAt(x);</span>
<span class="nc bnc" id="L1889" title="All 2 branches missed.">                if (e.getOwner() == p) {</span>
<span class="nc" id="L1890">                    sb.append(UnitStatusFormatter.format(e));</span>
                }
            }

            // Record the player's devastated units.
<span class="nc" id="L1895">            Enumeration&lt;Entity&gt; devastated = game.getDevastatedEntities();</span>
<span class="nc bnc" id="L1896" title="All 2 branches missed.">            if (devastated.hasMoreElements()) {</span>
<span class="nc" id="L1897">                sb.append(&quot;=============================================================&quot;);</span>
<span class="nc" id="L1898">                sb.append(CommonConstants.NL);</span>
<span class="nc" id="L1899">                sb.append(&quot;The following utterly destroyed units are not available for salvage:&quot;);</span>
<span class="nc" id="L1900">                sb.append(CommonConstants.NL);</span>
<span class="nc bnc" id="L1901" title="All 2 branches missed.">                while (devastated.hasMoreElements()) {</span>
<span class="nc" id="L1902">                    Entity e = devastated.nextElement();</span>
<span class="nc bnc" id="L1903" title="All 2 branches missed.">                    if (e.getOwner() == p) {</span>
<span class="nc" id="L1904">                        sb.append(e.getShortName());</span>
<span class="nc bnc" id="L1905" title="All 2 branches missed.">                        for (int pos = 0; pos &lt; e.getCrew().getSlotCount(); pos++) {</span>
<span class="nc" id="L1906">                            sb.append(&quot;, &quot;).append(e.getCrew().getNameAndRole(pos)).append(&quot; (&quot;)</span>
<span class="nc" id="L1907">                                .append(e.getCrew().getGunnery()).append('/')</span>
<span class="nc" id="L1908">                                .append(e.getCrew().getPiloting()).append(')');</span>
<span class="nc" id="L1909">                            sb.append(CommonConstants.NL);</span>
                        }
                    }
<span class="nc" id="L1912">                } // Handle the next non-salvageable unit for the player</span>
<span class="nc" id="L1913">                sb.append(&quot;=============================================================&quot;);</span>
<span class="nc" id="L1914">                sb.append(CommonConstants.NL);</span>
            }

<span class="nc" id="L1917">        } // Handle the next player</span>

<span class="nc" id="L1919">        return sb.toString();</span>
    }

    /**
     * Forces victory for the specified player, or his/her team at the end of
     * the round.
     */
    public void forceVictory(IPlayer victor) {
<span class="nc" id="L1927">        game.setForceVictory(true);</span>
<span class="nc bnc" id="L1928" title="All 2 branches missed.">        if (victor.getTeam() == IPlayer.TEAM_NONE) {</span>
<span class="nc" id="L1929">            game.setVictoryPlayerId(victor.getId());</span>
<span class="nc" id="L1930">            game.setVictoryTeam(IPlayer.TEAM_NONE);</span>
        } else {
<span class="nc" id="L1932">            game.setVictoryPlayerId(IPlayer.PLAYER_NONE);</span>
<span class="nc" id="L1933">            game.setVictoryTeam(victor.getTeam());</span>
        }

<span class="nc" id="L1936">        Vector&lt;IPlayer&gt; playersVector = game.getPlayersVector();</span>
<span class="nc bnc" id="L1937" title="All 2 branches missed.">        for (int i = 0; i &lt; playersVector.size(); i++) {</span>
<span class="nc" id="L1938">            IPlayer player = playersVector.elementAt(i);</span>
<span class="nc" id="L1939">            player.setAdmitsDefeat(false);</span>
        }
<span class="nc" id="L1941">    }</span>

    /**
     * Cancels the force victory
     */
    public void cancelVictory() {
<span class="nc" id="L1947">        game.setForceVictory(false);</span>
<span class="nc" id="L1948">        game.setVictoryPlayerId(IPlayer.PLAYER_NONE);</span>
<span class="nc" id="L1949">        game.setVictoryTeam(IPlayer.TEAM_NONE);</span>
<span class="nc" id="L1950">    }</span>

    public void requestTeamChange(int team, IPlayer player) {
<span class="nc" id="L1953">        requestedTeam = team;</span>
<span class="nc" id="L1954">        playerChangingTeam = player;</span>
<span class="nc" id="L1955">        changePlayersTeam = false;</span>
<span class="nc" id="L1956">    }</span>

    public void allowTeamChange() {
<span class="nc" id="L1959">        changePlayersTeam = true;</span>
<span class="nc" id="L1960">    }</span>

    public boolean isTeamChangeRequestInProgress() {
<span class="nc bnc" id="L1963" title="All 2 branches missed.">        return playerChangingTeam != null;</span>
    }

    public IPlayer getPlayerRequestingTeamChange() {
<span class="nc" id="L1967">        return playerChangingTeam;</span>
    }

    public int getRequestedTeam() {
<span class="nc" id="L1971">        return requestedTeam;</span>
    }

    private void processTeamChange() {
<span class="nc bnc" id="L1975" title="All 2 branches missed.">        if (playerChangingTeam != null) {</span>
<span class="nc" id="L1976">            playerChangingTeam.setTeam(requestedTeam);</span>
<span class="nc" id="L1977">            game.setupTeams();</span>
<span class="nc" id="L1978">            send(createPlayerUpdatePacket(playerChangingTeam.getId()));</span>
<span class="nc" id="L1979">            String teamString = &quot;Team &quot; + requestedTeam + &quot;!&quot;;</span>
<span class="nc bnc" id="L1980" title="All 2 branches missed.">            if (requestedTeam == IPlayer.TEAM_UNASSIGNED) {</span>
<span class="nc" id="L1981">                teamString = &quot; unassigned!&quot;;</span>
<span class="nc bnc" id="L1982" title="All 2 branches missed.">            } else if (requestedTeam == IPlayer.TEAM_NONE) {</span>
<span class="nc" id="L1983">                teamString = &quot; lone wolf!&quot;;</span>
            }
<span class="nc" id="L1985">            sendServerChat(playerChangingTeam.getName() + &quot; has changed teams to &quot; + teamString);</span>
<span class="nc" id="L1986">            playerChangingTeam = null;</span>
        }
<span class="nc" id="L1988">        changePlayersTeam = false;</span>
<span class="nc" id="L1989">    }</span>

    /**
     * Called when a player declares that he is &quot;done.&quot; Checks to see if all
     * players are done, and if so, moves on to the next phase.
     */
    private void checkReady() {
        // check if all active players are done
<span class="nc bnc" id="L1997" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L1998">            final IPlayer player = i.nextElement();</span>
<span class="nc bnc" id="L1999" title="All 6 branches missed.">            if (!player.isGhost() &amp;&amp; !player.isObserver() &amp;&amp; !player.isDone()) {</span>
<span class="nc" id="L2000">                return;</span>
            }
<span class="nc" id="L2002">        }</span>

        // Tactical Genius pilot special ability (lvl 3)
<span class="nc bnc" id="L2005" title="All 2 branches missed.">        if (game.getNoOfInitiativeRerollRequests() &gt; 0) {</span>
<span class="nc" id="L2006">            resetActivePlayersDone();</span>
<span class="nc" id="L2007">            game.rollInitAndResolveTies();</span>

<span class="nc" id="L2009">            determineTurnOrder(IGame.Phase.PHASE_INITIATIVE);</span>
<span class="nc" id="L2010">            clearReports();</span>
<span class="nc" id="L2011">            writeInitiativeReport(true);</span>
<span class="nc" id="L2012">            sendReport(true);</span>
<span class="nc" id="L2013">            return; // don't end the phase yet, players need to see new report</span>
        }

        // need at least one entity in the game for the lounge phase to end
<span class="nc bnc" id="L2017" title="All 4 branches missed.">        if (!game.phaseHasTurns(game.getPhase()) &amp;&amp; ((game.getPhase() != IGame.Phase.PHASE_LOUNGE)</span>
<span class="nc bnc" id="L2018" title="All 2 branches missed.">                || (game.getNoOfEntities() &gt; 0))) {</span>
<span class="nc" id="L2019">            endCurrentPhase();</span>
        }
<span class="nc" id="L2021">    }</span>

    /**
     * Called when the current player has done his current turn and the turn
     * counter needs to be advanced. Also enforces the &quot;protos_move_multi&quot; and
     * the &quot;protos_move_multi&quot; option. If the player has just moved
     * infantry/protos with a &quot;normal&quot; turn, adds up to
     * Game.INF_AND_PROTOS_MOVE_MULTI - 1 more infantry/proto-specific turns
     * after the current turn.
     */
    private void endCurrentTurn(Entity entityUsed) {
        // Enforce &quot;inf_move_multi&quot; and &quot;protos_move_multi&quot; options.
        // The &quot;isNormalTurn&quot; flag is checking to see if any non-Infantry
        // or non-ProtoMech units can move during the current turn.
<span class="nc" id="L2035">        boolean turnsChanged = false;</span>
<span class="nc" id="L2036">        boolean outOfOrder = false;</span>
<span class="nc" id="L2037">        GameTurn turn = game.getTurn();</span>
<span class="nc bnc" id="L2038" title="All 4 branches missed.">        if (game.isPhaseSimultaneous()</span>
            &amp;&amp; (entityUsed != null)
<span class="nc bnc" id="L2040" title="All 2 branches missed.">            &amp;&amp; !turn.isValid(entityUsed.getOwnerId(), game)) {</span>
            // turn played out of order
<span class="nc" id="L2042">            outOfOrder = true;</span>
<span class="nc" id="L2043">            entityUsed.setDone(false);</span>
<span class="nc" id="L2044">            GameTurn removed = game.removeFirstTurnFor(entityUsed);</span>
<span class="nc" id="L2045">            entityUsed.setDone(true);</span>
<span class="nc" id="L2046">            turnsChanged = true;</span>
<span class="nc bnc" id="L2047" title="All 2 branches missed.">            if (removed != null) {</span>
<span class="nc" id="L2048">                turn = removed;</span>
            }
        }
<span class="nc" id="L2051">        final Phase currPhase = game.getPhase();</span>
<span class="nc" id="L2052">        final GameOptions gameOpts = game.getOptions();</span>
<span class="nc bnc" id="L2053" title="All 2 branches missed.">        final int playerId = null == entityUsed ? IPlayer.PLAYER_NONE : entityUsed.getOwnerId();</span>
<span class="nc" id="L2054">        boolean infMoved = entityUsed instanceof Infantry;</span>
<span class="nc bnc" id="L2055" title="All 8 branches missed.">        boolean infMoveMulti = gameOpts.booleanOption(OptionsConstants.INIT_INF_MOVE_MULTI)</span>
               &amp;&amp; ((currPhase == IGame.Phase.PHASE_MOVEMENT)
                   || (currPhase == IGame.Phase.PHASE_DEPLOYMENT)
                   || (currPhase == IGame.Phase.PHASE_INITIATIVE));
<span class="nc" id="L2059">        boolean protosMoved = entityUsed instanceof Protomech;</span>
<span class="nc" id="L2060">        boolean protosMoveMulti = gameOpts.booleanOption(OptionsConstants.INIT_PROTOS_MOVE_MULTI);</span>
<span class="nc" id="L2061">        boolean tanksMoved = entityUsed instanceof Tank;</span>
<span class="nc bnc" id="L2062" title="All 8 branches missed.">        boolean tanksMoveMulti = gameOpts.booleanOption(</span>
                OptionsConstants.ADVGRNDMOV_VEHICLE_LANCE_MOVEMENT)
                &amp;&amp; ((currPhase == IGame.Phase.PHASE_MOVEMENT)
                    || (currPhase == IGame.Phase.PHASE_DEPLOYMENT)
                    || (currPhase == IGame.Phase.PHASE_INITIATIVE));
<span class="nc" id="L2067">        boolean meksMoved = entityUsed instanceof Mech;</span>
<span class="nc bnc" id="L2068" title="All 8 branches missed.">        boolean meksMoveMulti = gameOpts.booleanOption(OptionsConstants.ADVGRNDMOV_MEK_LANCE_MOVEMENT)</span>
                &amp;&amp; ((currPhase == IGame.Phase.PHASE_MOVEMENT)
                    || (currPhase == IGame.Phase.PHASE_DEPLOYMENT)
                    || (currPhase == IGame.Phase.PHASE_INITIATIVE));

        // If infantry or protos move multi see if any
        // other unit types can move in the current turn.
<span class="nc" id="L2075">        int multiMask = 0;</span>
<span class="nc bnc" id="L2076" title="All 4 branches missed.">        if (infMoveMulti &amp;&amp; infMoved) {</span>
<span class="nc" id="L2077">            multiMask = GameTurn.CLASS_INFANTRY;</span>
<span class="nc bnc" id="L2078" title="All 4 branches missed.">        } else if (protosMoveMulti &amp;&amp; protosMoved) {</span>
<span class="nc" id="L2079">            multiMask = GameTurn.CLASS_PROTOMECH;</span>
<span class="nc bnc" id="L2080" title="All 4 branches missed.">        } else if (tanksMoveMulti &amp;&amp; tanksMoved) {</span>
<span class="nc" id="L2081">            multiMask = GameTurn.CLASS_TANK;</span>
<span class="nc bnc" id="L2082" title="All 4 branches missed.">        } else if (meksMoveMulti &amp;&amp; meksMoved) {</span>
<span class="nc" id="L2083">            multiMask = GameTurn.CLASS_MECH;</span>
        }

        // In certain cases, a new SpecificEntityTurn could have been added for
        // the Entity whose turn we are ending as the next turn. If this has
        // happened, the remaining entity count will be off and we must ensure
        // that the SpecificEntityTurn for this unit remains the next turn
<span class="nc" id="L2090">        List&lt;GameTurn&gt; turnVector = game.getTurnVector();</span>
<span class="nc" id="L2091">        int turnIndex = game.getTurnIndex();</span>
<span class="nc" id="L2092">        boolean usedEntityNotDone = false;</span>
<span class="nc bnc" id="L2093" title="All 2 branches missed.">        if ((turnIndex + 1) &lt; turnVector.size()) {</span>
<span class="nc" id="L2094">            GameTurn nextTurn = turnVector.get(turnIndex + 1);</span>
<span class="nc bnc" id="L2095" title="All 2 branches missed.">            if (nextTurn instanceof GameTurn.SpecificEntityTurn) {</span>
<span class="nc" id="L2096">                GameTurn.SpecificEntityTurn seTurn = (GameTurn.SpecificEntityTurn) nextTurn;</span>
<span class="nc bnc" id="L2097" title="All 4 branches missed.">                if ((entityUsed != null) &amp;&amp; (seTurn.getEntityNum() == entityUsed.getId())) {</span>
<span class="nc" id="L2098">                    turnIndex++;</span>
<span class="nc" id="L2099">                    usedEntityNotDone = true;</span>
                }
            }
        }

        // Was the turn we just took added as part of a multi-turn?
        //  This determines if we should add more multi-turns
<span class="nc" id="L2106">        boolean isMultiTurn = turn.isMultiTurn();</span>

        // Unless overridden by the &quot;protos_move_multi&quot; option, all ProtoMechs
        // in a unit declare fire, and they don't mix with infantry.
<span class="nc bnc" id="L2110" title="All 8 branches missed.">        if (protosMoved &amp;&amp; !protosMoveMulti &amp;&amp; !isMultiTurn &amp;&amp; (entityUsed != null)) {</span>

            // What's the unit number and ID of the entity used?
<span class="nc" id="L2113">            final short movingUnit = entityUsed.getUnitNumber();</span>
<span class="nc" id="L2114">            final int movingId = entityUsed.getId();</span>

            // How many other ProtoMechs are in the unit that can fire?
<span class="nc" id="L2117">            int protoTurns = game.getSelectedEntityCount(new EntitySelector() {</span>
<span class="nc" id="L2118">                private final int ownerId = playerId;</span>

<span class="nc" id="L2120">                private final int entityId = movingId;</span>

<span class="nc" id="L2122">                private final short unitNum = movingUnit;</span>

                public boolean accept(Entity entity) {
<span class="nc bnc" id="L2125" title="All 2 branches missed.">                    return (entity instanceof Protomech)</span>
<span class="nc bnc" id="L2126" title="All 2 branches missed.">                            &amp;&amp; entity.isSelectableThisTurn()</span>
<span class="nc bnc" id="L2127" title="All 2 branches missed.">                            &amp;&amp; (ownerId == entity.getOwnerId())</span>
<span class="nc bnc" id="L2128" title="All 2 branches missed.">                            &amp;&amp; (entityId != entity.getId())</span>
<span class="nc bnc" id="L2129" title="All 2 branches missed.">                            &amp;&amp; (unitNum == entity.getUnitNumber());</span>
                }
            });

            // Add the correct number of turns for the ProtoMech unit number.
<span class="nc bnc" id="L2134" title="All 2 branches missed.">            for (int i = 0; i &lt; protoTurns; i++) {</span>
<span class="nc" id="L2135">                GameTurn newTurn = new GameTurn.UnitNumberTurn(playerId, movingUnit);</span>
<span class="nc" id="L2136">                newTurn.setMultiTurn(true);</span>
<span class="nc" id="L2137">                game.insertTurnAfter(newTurn, turnIndex);</span>
<span class="nc" id="L2138">                turnsChanged = true;</span>
            }
<span class="nc" id="L2140">        }</span>
        // Otherwise, we may need to add turns for the &quot;*_move_multi&quot; options.
<span class="nc bnc" id="L2142" title="All 10 branches missed.">        else if (((infMoved &amp;&amp; infMoveMulti) || (protosMoved &amp;&amp; protosMoveMulti)) &amp;&amp; !isMultiTurn) {</span>
<span class="nc" id="L2143">            int remaining = 0;</span>

            // Calculate the number of EntityClassTurns need to be added.
<span class="nc bnc" id="L2146" title="All 4 branches missed.">            if (infMoveMulti &amp;&amp; infMoved) {</span>
<span class="nc" id="L2147">                remaining += game.getInfantryLeft(playerId);</span>
            }
<span class="nc bnc" id="L2149" title="All 4 branches missed.">            if (protosMoveMulti &amp;&amp; protosMoved) {</span>
<span class="nc" id="L2150">                remaining += game.getProtomechsLeft(playerId);</span>
            }
<span class="nc bnc" id="L2152" title="All 2 branches missed.">            if (usedEntityNotDone) {</span>
<span class="nc" id="L2153">                remaining--;</span>
            }
<span class="nc" id="L2155">            int moreInfAndProtoTurns = Math.min(</span>
<span class="nc" id="L2156">                    gameOpts.intOption(OptionsConstants.INIT_INF_PROTO_MOVE_MULTI) - 1, remaining);</span>

            // Add the correct number of turns for the right unit classes.
<span class="nc bnc" id="L2159" title="All 2 branches missed.">            for (int i = 0; i &lt; moreInfAndProtoTurns; i++) {</span>
<span class="nc" id="L2160">                GameTurn newTurn = new GameTurn.EntityClassTurn(playerId, multiMask);</span>
<span class="nc" id="L2161">                newTurn.setMultiTurn(true);</span>
<span class="nc" id="L2162">                game.insertTurnAfter(newTurn, turnIndex);</span>
<span class="nc" id="L2163">                turnsChanged = true;</span>
            }
        }

<span class="nc bnc" id="L2167" title="All 6 branches missed.">        if (tanksMoved &amp;&amp; tanksMoveMulti &amp;&amp; !isMultiTurn) {</span>
<span class="nc" id="L2168">            int remaining = game.getVehiclesLeft(playerId);</span>
<span class="nc bnc" id="L2169" title="All 2 branches missed.">            if (usedEntityNotDone) {</span>
<span class="nc" id="L2170">                remaining--;</span>
            }
<span class="nc" id="L2172">            int moreVeeTurns = Math.min(</span>
<span class="nc" id="L2173">                    gameOpts.intOption(OptionsConstants.ADVGRNDMOV_VEHICLE_LANCE_MOVEMENT_NUMBER) - 1,</span>
                    remaining);

            // Add the correct number of turns for the right unit classes.
<span class="nc bnc" id="L2177" title="All 2 branches missed.">            for (int i = 0; i &lt; moreVeeTurns; i++) {</span>
<span class="nc" id="L2178">                GameTurn newTurn = new GameTurn.EntityClassTurn(playerId, multiMask);</span>
<span class="nc" id="L2179">                newTurn.setMultiTurn(true);</span>
<span class="nc" id="L2180">                game.insertTurnAfter(newTurn, turnIndex);</span>
<span class="nc" id="L2181">                turnsChanged = true;</span>
            }
        }

<span class="nc bnc" id="L2185" title="All 6 branches missed.">        if (meksMoved &amp;&amp; meksMoveMulti &amp;&amp; !isMultiTurn) {</span>
<span class="nc" id="L2186">            int remaining = game.getMechsLeft(playerId);</span>
<span class="nc bnc" id="L2187" title="All 2 branches missed.">            if (usedEntityNotDone) {</span>
<span class="nc" id="L2188">                remaining--;</span>
            }
<span class="nc" id="L2190">            int moreMekTurns = Math.min(</span>
<span class="nc" id="L2191">                    gameOpts.intOption(OptionsConstants.ADVGRNDMOV_MEK_LANCE_MOVEMENT_NUMBER) - 1,</span>
                    remaining);

            // Add the correct number of turns for the right unit classes.
<span class="nc bnc" id="L2195" title="All 2 branches missed.">            for (int i = 0; i &lt; moreMekTurns; i++) {</span>
<span class="nc" id="L2196">                GameTurn newTurn = new GameTurn.EntityClassTurn(playerId, multiMask);</span>
<span class="nc" id="L2197">                newTurn.setMultiTurn(true);</span>
<span class="nc" id="L2198">                game.insertTurnAfter(newTurn, turnIndex);</span>
<span class="nc" id="L2199">                turnsChanged = true;</span>
            }
        }

        // brief everybody on the turn update, if they changed
<span class="nc bnc" id="L2204" title="All 2 branches missed.">        if (turnsChanged) {</span>
<span class="nc" id="L2205">            send(createTurnVectorPacket());</span>
        }

        // move along
<span class="nc bnc" id="L2209" title="All 2 branches missed.">        if (outOfOrder) {</span>
<span class="nc" id="L2210">            send(createTurnIndexPacket(playerId));</span>
        } else {
<span class="nc" id="L2212">            changeToNextTurn(playerId);</span>
        }
<span class="nc" id="L2214">    }</span>

    /**
     * Changes the current phase, does some bookkeeping and then tells the
     * players.
     *
     * @param phase the &lt;code&gt;int&lt;/code&gt; id of the phase to change to
     */
    private void changePhase(IGame.Phase phase) {
<span class="nc" id="L2223">        game.setLastPhase(game.getPhase());</span>
<span class="nc" id="L2224">        game.setPhase(phase);</span>

        // prepare for the phase
<span class="nc" id="L2227">        prepareForPhase(phase);</span>

<span class="nc bnc" id="L2229" title="All 2 branches missed.">        if (isPhasePlayable(phase)) {</span>
            // tell the players about the new phase
<span class="nc" id="L2231">            send(new Packet(Packet.COMMAND_PHASE_CHANGE, phase));</span>

            // post phase change stuff
<span class="nc" id="L2234">            executePhase(phase);</span>
        } else {
<span class="nc" id="L2236">            endCurrentPhase();</span>
        }
<span class="nc" id="L2238">    }</span>

    /**
     * Prepares for, presumably, the next phase. This typically involves
     * resetting the states of entities in the game and making sure the client
     * has the information it needs for the new phase.
     *
     * @param phase the &lt;code&gt;int&lt;/code&gt; id of the phase to prepare for
     */
    private void prepareForPhase(IGame.Phase phase) {
<span class="nc bnc" id="L2248" title="All 10 branches missed.">        switch (phase) {</span>
            case PHASE_LOUNGE:
<span class="nc" id="L2250">                clearReports();</span>
<span class="nc" id="L2251">                mapSettings.setBoardsAvailableVector(scanForBoards(new BoardDimensions(</span>
<span class="nc" id="L2252">                        mapSettings.getBoardWidth(), mapSettings.getBoardHeight())));</span>
<span class="nc" id="L2253">                mapSettings.setNullBoards(DEFAULT_BOARD);</span>
<span class="nc" id="L2254">                send(createMapSettingsPacket());</span>
<span class="nc" id="L2255">                send(createMapSizesPacket());</span>
<span class="nc" id="L2256">                checkForObservers();</span>
<span class="nc" id="L2257">                transmitAllPlayerUpdates();</span>
<span class="nc" id="L2258">                break;</span>
            case PHASE_INITIATIVE:
                // remove the last traces of last round
<span class="nc" id="L2261">                game.handleInitiativeCompensation();</span>
<span class="nc" id="L2262">                game.resetActions();</span>
<span class="nc" id="L2263">                game.resetTagInfo();</span>
<span class="nc" id="L2264">                sendTagInfoReset();</span>
<span class="nc" id="L2265">                clearReports();</span>
<span class="nc" id="L2266">                resetEntityRound();</span>
<span class="nc" id="L2267">                resetEntityPhase(phase);</span>
<span class="nc" id="L2268">                checkForObservers();</span>
<span class="nc" id="L2269">                transmitAllPlayerUpdates();</span>

                // roll 'em
<span class="nc" id="L2272">                resetActivePlayersDone();</span>
<span class="nc" id="L2273">                rollInitiative();</span>
                //Cockpit command consoles that switched crew on the previous round are ineligible for force
                //commander initiative bonus. Now that initiative is rolled, clear the flag.
<span class="nc" id="L2276">                game.getEntities().forEachRemaining(e -&gt; e.getCrew().resetActedFlag());</span>

<span class="nc bnc" id="L2278" title="All 2 branches missed.">                if (!game.shouldDeployThisRound()) {</span>
<span class="nc" id="L2279">                    incrementAndSendGameRound();</span>
                }

                // setIneligible(phase);
<span class="nc" id="L2283">                determineTurnOrder(phase);</span>
<span class="nc" id="L2284">                writeInitiativeReport(false);</span>

                // checks for environmental survival
<span class="nc" id="L2287">                checkForConditionDeath();</span>

<span class="nc" id="L2289">                checkForBlueShieldDamage();</span>
<span class="nc bnc" id="L2290" title="All 2 branches missed.">                if (game.getBoard().inAtmosphere()) {</span>
<span class="nc" id="L2291">                    checkForAtmosphereDeath();</span>
                }
<span class="nc bnc" id="L2293" title="All 2 branches missed.">                if (game.getBoard().inSpace()) {</span>
<span class="nc" id="L2294">                    checkForSpaceDeath();</span>
                }

<span class="nc" id="L2297">                MegaMek.getLogger().info(&quot;Round &quot; + game.getRoundCount() + &quot; memory usage: &quot; + MegaMek.getMemoryUsed());</span>
<span class="nc" id="L2298">                break;</span>
            case PHASE_DEPLOY_MINEFIELDS:
<span class="nc" id="L2300">                checkForObservers();</span>
<span class="nc" id="L2301">                transmitAllPlayerUpdates();</span>
<span class="nc" id="L2302">                resetActivePlayersDone();</span>
<span class="nc" id="L2303">                setIneligible(phase);</span>

<span class="nc" id="L2305">                Enumeration&lt;IPlayer&gt; e = game.getPlayers();</span>
<span class="nc" id="L2306">                Vector&lt;GameTurn&gt; turns = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L2307" title="All 2 branches missed.">                while (e.hasMoreElements()) {</span>
<span class="nc" id="L2308">                    IPlayer p = e.nextElement();</span>
<span class="nc bnc" id="L2309" title="All 4 branches missed.">                    if (p.hasMinefields() &amp;&amp; game.getBoard().onGround()) {</span>
<span class="nc" id="L2310">                        GameTurn gt = new GameTurn(p.getId());</span>
<span class="nc" id="L2311">                        turns.addElement(gt);</span>
                    }
<span class="nc" id="L2313">                }</span>
<span class="nc" id="L2314">                game.setTurnVector(turns);</span>
<span class="nc" id="L2315">                game.resetTurnIndex();</span>

                // send turns to all players
<span class="nc" id="L2318">                send(createTurnVectorPacket());</span>
<span class="nc" id="L2319">                break;</span>
            case PHASE_SET_ARTYAUTOHITHEXES:
<span class="nc" id="L2321">                deployOffBoardEntities();</span>
<span class="nc" id="L2322">                checkForObservers();</span>
<span class="nc" id="L2323">                transmitAllPlayerUpdates();</span>
<span class="nc" id="L2324">                resetActivePlayersDone();</span>
<span class="nc" id="L2325">                setIneligible(phase);</span>

<span class="nc" id="L2327">                Enumeration&lt;IPlayer&gt; players = game.getPlayers();</span>
<span class="nc" id="L2328">                Vector&lt;GameTurn&gt; turn = new Vector&lt;&gt;();</span>

                // Walk through the players of the game, and add
                // a turn for all players with artillery weapons.
<span class="nc bnc" id="L2332" title="All 2 branches missed.">                while (players.hasMoreElements()) {</span>

                    // Get the next player.
<span class="nc" id="L2335">                    final IPlayer p = players.nextElement();</span>

                    // Does the player have any artillery-equipped units?
<span class="nc" id="L2338">                    EntitySelector playerArtySelector = new EntitySelector() {</span>
<span class="nc" id="L2339">                        private IPlayer owner = p;</span>

                        public boolean accept(Entity entity) {
<span class="nc bnc" id="L2342" title="All 4 branches missed.">                            return owner.equals(entity.getOwner()) &amp;&amp; entity.isEligibleForArtyAutoHitHexes();</span>
                        }
                    };
<span class="nc bnc" id="L2345" title="All 2 branches missed.">                    if (game.getSelectedEntities(playerArtySelector).hasNext()) {</span>
                        // Yes, the player has arty-equipped units.
<span class="nc" id="L2347">                        GameTurn gt = new GameTurn(p.getId());</span>
<span class="nc" id="L2348">                        turn.addElement(gt);</span>
                    }
<span class="nc" id="L2350">                }</span>
<span class="nc" id="L2351">                game.setTurnVector(turn);</span>
<span class="nc" id="L2352">                game.resetTurnIndex();</span>

                // send turns to all players
<span class="nc" id="L2355">                send(createTurnVectorPacket());</span>
<span class="nc" id="L2356">                break;</span>
            case PHASE_MOVEMENT:
            case PHASE_DEPLOYMENT:
            case PHASE_FIRING:
            case PHASE_PHYSICAL:
            case PHASE_TARGETING:
            case PHASE_OFFBOARD:
<span class="nc" id="L2363">                deployOffBoardEntities();</span>

                // Check for activating hidden units
<span class="nc bnc" id="L2366" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_HIDDEN_UNITS)) {</span>
<span class="nc bnc" id="L2367" title="All 2 branches missed.">                    for (Entity ent : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L2368" title="All 2 branches missed.">                        if (ent.getHiddenActivationPhase() == phase) {</span>
<span class="nc" id="L2369">                            ent.setHidden(false);</span>
                        }
<span class="nc" id="L2371">                    }</span>
                }
                // Update visibility indications if using double blind.
<span class="nc bnc" id="L2374" title="All 2 branches missed.">                if (doBlind()) {</span>
<span class="nc" id="L2375">                    updateVisibilityIndicator(null);</span>
                }
<span class="nc" id="L2377">                resetEntityPhase(phase);</span>
<span class="nc" id="L2378">                checkForObservers();</span>
<span class="nc" id="L2379">                transmitAllPlayerUpdates();</span>
<span class="nc" id="L2380">                resetActivePlayersDone();</span>
<span class="nc" id="L2381">                setIneligible(phase);</span>
<span class="nc" id="L2382">                determineTurnOrder(phase);</span>
                // send(createEntitiesPacket());
<span class="nc" id="L2384">                entityAllUpdate();</span>
<span class="nc" id="L2385">                clearReports();</span>
<span class="nc" id="L2386">                doTryUnstuck();</span>
<span class="nc" id="L2387">                break;</span>
            case PHASE_END:
<span class="nc" id="L2389">                resetEntityPhase(phase);</span>
<span class="nc" id="L2390">                clearReports();</span>
<span class="nc" id="L2391">                resolveHeat();</span>
<span class="nc bnc" id="L2392" title="All 2 branches missed.">                if (game.getPlanetaryConditions().isSandBlowing()</span>
<span class="nc bnc" id="L2393" title="All 2 branches missed.">                    &amp;&amp; (game.getPlanetaryConditions().getWindStrength() &gt; PlanetaryConditions.WI_LIGHT_GALE)) {</span>
<span class="nc" id="L2394">                    addReport(resolveBlowingSandDamage());</span>
                }
<span class="nc" id="L2396">                addReport(resolveControlRolls());</span>
<span class="nc" id="L2397">                addReport(checkForTraitors());</span>
                // write End Phase header
<span class="nc" id="L2399">                addReport(new Report(5005, Report.PUBLIC));</span>
<span class="nc" id="L2400">                checkLayExplosives();</span>
<span class="nc" id="L2401">                resolveHarJelRepairs();</span>
<span class="nc" id="L2402">                resolveEmergencyCoolantSystem();</span>
<span class="nc" id="L2403">                checkForSuffocation();</span>
<span class="nc" id="L2404">                game.getPlanetaryConditions().determineWind();</span>
<span class="nc" id="L2405">                send(createPlanetaryConditionsPacket());</span>

<span class="nc" id="L2407">                applyBuildingDamage();</span>
<span class="nc" id="L2408">                addReport(game.ageFlares());</span>
<span class="nc" id="L2409">                send(createFlarePacket());</span>
<span class="nc" id="L2410">                resolveAmmoDumps();</span>
<span class="nc" id="L2411">                resolveCrewWakeUp();</span>
<span class="nc" id="L2412">                resolveConsoleCrewSwaps();</span>
<span class="nc" id="L2413">                resolveSelfDestruct();</span>
<span class="nc" id="L2414">                resolveShutdownCrashes();</span>
<span class="nc" id="L2415">                checkForIndustrialEndOfTurn();</span>
<span class="nc" id="L2416">                resolveMechWarriorPickUp();</span>
<span class="nc" id="L2417">                resolveVeeINarcPodRemoval();</span>
<span class="nc" id="L2418">                resolveFortify();</span>

                // Moved this to the very end because it makes it difficult to see
                // more important updates when you have 300+ messages of smoke filling
                // whatever hex. Please don't move it above the other things again.
                // Thanks! Ralgith - 2018/03/15
<span class="nc" id="L2424">                hexUpdateSet.clear();</span>
<span class="nc bnc" id="L2425" title="All 2 branches missed.">                for (DynamicTerrainProcessor tp : terrainProcessors) {</span>
<span class="nc" id="L2426">                    tp.doEndPhaseChanges(vPhaseReport);</span>
<span class="nc" id="L2427">                }</span>
<span class="nc" id="L2428">                sendChangedHexes(hexUpdateSet);</span>

<span class="nc" id="L2430">                checkForObservers();</span>
<span class="nc" id="L2431">                transmitAllPlayerUpdates();</span>
<span class="nc" id="L2432">                entityAllUpdate();</span>
<span class="nc" id="L2433">                break;</span>
            case PHASE_INITIATIVE_REPORT:
<span class="nc" id="L2435">                autoSave();</span>
                // Show player BVs
<span class="nc" id="L2437">                Enumeration&lt;IPlayer&gt; players2 = game.getPlayers();</span>
<span class="nc bnc" id="L2438" title="All 2 branches missed.">                while (players2.hasMoreElements()) {</span>
<span class="nc" id="L2439">                    IPlayer player = players2.nextElement();</span>
                    // Players who started the game as observers get ignored
<span class="nc bnc" id="L2441" title="All 2 branches missed.">                    if (player.getInitialBV() == 0) {</span>
<span class="nc" id="L2442">                        continue;</span>
                    }
<span class="nc" id="L2444">                    Report r = new Report();</span>
<span class="nc" id="L2445">                    r.type = Report.PUBLIC;</span>
<span class="nc bnc" id="L2446" title="All 4 branches missed.">                    if (doBlind() &amp;&amp; suppressBlindBV()) {</span>
<span class="nc" id="L2447">                        r.type = Report.PLAYER;</span>
<span class="nc" id="L2448">                        r.player = player.getId();</span>
                    }
<span class="nc" id="L2450">                    r.messageId = 7016;</span>
<span class="nc" id="L2451">                    r.add(Server.getColorForPlayer(player));</span>
<span class="nc" id="L2452">                    r.add(player.getBV());</span>
<span class="nc" id="L2453">                    r.add(Double.toString(Math.round((double) player.getBV() / player.getInitialBV() * 10000.0) / 100.0));</span>
<span class="nc" id="L2454">                    r.add(player.getInitialBV());</span>
<span class="nc" id="L2455">                    r.add(player.getFledBV());</span>
<span class="nc" id="L2456">                    addReport(r);</span>
<span class="nc" id="L2457">                }</span>
            case PHASE_TARGETING_REPORT:
            case PHASE_MOVEMENT_REPORT:
            case PHASE_OFFBOARD_REPORT:
            case PHASE_FIRING_REPORT:
            case PHASE_PHYSICAL_REPORT:
            case PHASE_END_REPORT:
<span class="nc" id="L2464">                resetActivePlayersDone();</span>
<span class="nc" id="L2465">                sendReport();</span>
<span class="nc bnc" id="L2466" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.BASE_PARANOID_AUTOSAVE)) {</span>
<span class="nc" id="L2467">                    autoSave();</span>
                }
                break;
            case PHASE_VICTORY:
<span class="nc" id="L2471">                resetPlayersDone();</span>
<span class="nc" id="L2472">                clearReports();</span>
<span class="nc" id="L2473">                prepareVictoryReport();</span>
<span class="nc" id="L2474">                game.addReports(vPhaseReport);</span>
                // Before we send the full entities packet we need to loop
                // through the fighters in squadrons and damage them.
<span class="nc bnc" id="L2477" title="All 2 branches missed.">                for (Iterator&lt;Entity&gt; ents = game.getEntities(); ents.hasNext(); ) {</span>
<span class="nc" id="L2478">                    Entity entity = ents.next();</span>
<span class="nc bnc" id="L2479" title="All 4 branches missed.">                    if ((entity.isFighter()) &amp;&amp; !(entity instanceof FighterSquadron)) {</span>
<span class="nc bnc" id="L2480" title="All 4 branches missed.">                        if (entity.isPartOfFighterSquadron() || entity.isCapitalFighter()) {</span>
<span class="nc" id="L2481">                            ((IAero) entity).doDisbandDamage();</span>
                        }
                    }
                // fix the armor and SI of aeros if using aero sanity rules for
                // the MUL
<span class="nc bnc" id="L2486" title="All 4 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)</span>
                        &amp;&amp; (entity instanceof Aero)) {
                    // need to rescale SI and armor
<span class="nc" id="L2489">                    int scale = 1;</span>
<span class="nc bnc" id="L2490" title="All 2 branches missed.">                    if (entity.isCapitalScale()) {</span>
<span class="nc" id="L2491">                        scale = 10;</span>
                    }
<span class="nc" id="L2493">                    Aero a = (Aero) entity;</span>
<span class="nc" id="L2494">                    int currentSI = a.getSI() / (2 * scale);</span>
<span class="nc" id="L2495">                    a.set0SI(a.get0SI() / (2 * scale));</span>
<span class="nc bnc" id="L2496" title="All 2 branches missed.">                    if (currentSI &gt; 0) {</span>
<span class="nc" id="L2497">                        a.setSI(currentSI);</span>
                    }
                    //Fix for #587. MHQ tracks fighters at standard scale and doesn't (currently)
                    //track squadrons. Squadrons don't save to MUL either, so... only convert armor for JS/WS/SS?
                    //Do we ever need to save capital fighter armor to the final MUL or entityStatus?
<span class="nc bnc" id="L2502" title="All 2 branches missed.">                    if (!entity.hasETypeFlag(Entity.ETYPE_JUMPSHIP)) {</span>
<span class="nc" id="L2503">                        scale = 1;</span>
                    }
<span class="nc bnc" id="L2505" title="All 2 branches missed.">                    if (scale &gt; 1) {</span>
<span class="nc bnc" id="L2506" title="All 2 branches missed.">                        for (int loc = 0; loc &lt; entity.locations(); loc++) {</span>
<span class="nc" id="L2507">                            int currentArmor = entity.getArmor(loc) / scale;</span>
<span class="nc bnc" id="L2508" title="All 2 branches missed.">                            if (entity.getOArmor(loc) &gt; 0) {</span>
<span class="nc" id="L2509">                                entity.initializeArmor(entity.getOArmor(loc) / scale, loc);</span>
                            }
<span class="nc bnc" id="L2511" title="All 2 branches missed.">                            if (entity.getArmor(loc) &gt; 0) {</span>
<span class="nc" id="L2512">                                entity.setArmor(currentArmor, loc);</span>
                            }
                        }
                    }
                }
<span class="nc" id="L2517">            }</span>
<span class="nc" id="L2518">                send(createFullEntitiesPacket());</span>
<span class="nc" id="L2519">                send(createReportPacket(null));</span>
<span class="nc" id="L2520">                send(createEndOfGamePacket());</span>
<span class="nc" id="L2521">                break;</span>
            default:
        }
<span class="nc" id="L2524">    }</span>

    /**
     * Should we play this phase or skip it?
     */
    private boolean isPhasePlayable(IGame.Phase phase) {
<span class="nc bnc" id="L2530" title="All 4 branches missed.">        switch (phase) {</span>
            case PHASE_INITIATIVE:
            case PHASE_END:
<span class="nc" id="L2533">                return false;</span>
            case PHASE_SET_ARTYAUTOHITHEXES:
            case PHASE_DEPLOY_MINEFIELDS:
            case PHASE_DEPLOYMENT:
            case PHASE_MOVEMENT:
            case PHASE_FIRING:
            case PHASE_PHYSICAL:
            case PHASE_TARGETING:
<span class="nc" id="L2541">                return game.hasMoreTurns();</span>
            case PHASE_OFFBOARD:
<span class="nc" id="L2543">                return isOffboardPlayable();</span>
            default:
<span class="nc" id="L2545">                return true;</span>
        }
    }

    /**
     * Skip offboard phase, if there is no homing / semiguided ammo in play
     */
    private boolean isOffboardPlayable() {
<span class="nc bnc" id="L2553" title="All 2 branches missed.">        if (!game.hasMoreTurns()) {</span>
<span class="nc" id="L2554">            return false;</span>
        }
        
<span class="nc bnc" id="L2557" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext();) {</span>
<span class="nc" id="L2558">            Entity entity = e.next();</span>
<span class="nc bnc" id="L2559" title="All 2 branches missed.">            for (Mounted mounted : entity.getAmmo()) {</span>
<span class="nc" id="L2560">                AmmoType ammoType = (AmmoType) mounted.getType();</span>
                
                // per errata, TAG will spot for LRMs and such
<span class="nc bnc" id="L2563" title="All 2 branches missed.">                if ((ammoType.getAmmoType() == AmmoType.T_LRM)</span>
<span class="nc bnc" id="L2564" title="All 2 branches missed.">                        || (ammoType.getAmmoType() == AmmoType.T_LRM_IMP)</span>
<span class="nc bnc" id="L2565" title="All 2 branches missed.">                        || (ammoType.getAmmoType() == AmmoType.T_MML)</span>
<span class="nc bnc" id="L2566" title="All 2 branches missed.">                        || (ammoType.getAmmoType() == AmmoType.T_NLRM)</span>
<span class="nc bnc" id="L2567" title="All 2 branches missed.">                        || (ammoType.getAmmoType() == AmmoType.T_MEK_MORTAR)) {</span>
<span class="nc" id="L2568">                    return true;</span>
                }
                
<span class="nc bnc" id="L2571" title="All 2 branches missed.">                if (((ammoType.getAmmoType() == AmmoType.T_ARROW_IV)</span>
<span class="nc bnc" id="L2572" title="All 2 branches missed.">                        || (ammoType.getAmmoType() == AmmoType.T_LONG_TOM)</span>
<span class="nc bnc" id="L2573" title="All 2 branches missed.">                        || (ammoType.getAmmoType() == AmmoType.T_SNIPER)</span>
<span class="nc bnc" id="L2574" title="All 2 branches missed.">                        || (ammoType.getAmmoType() == AmmoType.T_THUMPER))</span>
<span class="nc bnc" id="L2575" title="All 2 branches missed.">                        &amp;&amp; (ammoType.getMunitionType() == AmmoType.M_HOMING)) {</span>
<span class="nc" id="L2576">                    return true;</span>
                }
<span class="nc" id="L2578">            }</span>
            
<span class="nc bnc" id="L2580" title="All 2 branches missed.">            for (Mounted b : entity.getBombs()) {</span>
<span class="nc bnc" id="L2581" title="All 4 branches missed.">                if (!b.isDestroyed() &amp;&amp; (b.getUsableShotsLeft() &gt; 0)</span>
<span class="nc bnc" id="L2582" title="All 2 branches missed.">                    &amp;&amp; (((BombType) b.getType()).getBombType() == BombType.B_LG)) {</span>
<span class="nc" id="L2583">                    return true;</span>
                }
<span class="nc" id="L2585">            }</span>
<span class="nc" id="L2586">        }</span>
        
        // loop through all current attacks
        // if there are any that use homing ammo, we are playable
        // we need to do this because we might have a homing arty shot in flight
        // when the unit that mounted that ammo is no longer on the field
<span class="nc bnc" id="L2592" title="All 2 branches missed.">        for (Enumeration&lt;AttackHandler&gt; attacks = game.getAttacks(); attacks.hasMoreElements(); ) {</span>
<span class="nc" id="L2593">            AttackHandler attackHandler = attacks.nextElement();</span>
<span class="nc" id="L2594">            Mounted ammo = attackHandler.getWaa().getEntity(game)</span>
<span class="nc" id="L2595">                    .getEquipment(attackHandler.getWaa().getAmmoId());</span>
<span class="nc bnc" id="L2596" title="All 2 branches missed.">            if (ammo != null) {</span>
<span class="nc" id="L2597">                AmmoType ammoType = (AmmoType) ammo.getType();</span>
<span class="nc bnc" id="L2598" title="All 2 branches missed.">                if (ammoType.getMunitionType() == AmmoType.M_HOMING) {</span>
<span class="nc" id="L2599">                    return true;</span>
                }
            }
<span class="nc" id="L2602">        }</span>
<span class="nc" id="L2603">        return false;</span>
    }

    /**
     * Do anything we seed to start the new phase, such as give a turn to the
     * first player to play.
     */
    private void executePhase(IGame.Phase phase) {
<span class="nc bnc" id="L2611" title="All 4 branches missed.">        switch (phase) {</span>
            case PHASE_EXCHANGE:
<span class="nc" id="L2613">                resetPlayersDone();</span>
<span class="nc" id="L2614">                calculatePlayerBVs();</span>
                // Update initial BVs, as things may have been modified in lounge
<span class="nc bnc" id="L2616" title="All 2 branches missed.">                for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc" id="L2617">                    e.setInitialBV(e.calculateBattleValue(false, false));</span>
<span class="nc" id="L2618">                }</span>
                // Build teams vector
<span class="nc" id="L2620">                game.setupTeams();</span>
<span class="nc" id="L2621">                applyBoardSettings();</span>
<span class="nc" id="L2622">                game.getPlanetaryConditions().determineWind();</span>
<span class="nc" id="L2623">                send(createPlanetaryConditionsPacket());</span>
                // transmit the board to everybody
<span class="nc" id="L2625">                send(createBoardPacket());</span>
<span class="nc" id="L2626">                game.setupRoundDeployment();</span>
<span class="nc" id="L2627">                game.setVictoryContext(new HashMap&lt;&gt;());</span>
<span class="nc" id="L2628">                game.createVictoryConditions();</span>
                // some entities may need to be checked and updated
<span class="nc" id="L2630">                checkEntityExchange();</span>
<span class="nc" id="L2631">                break;</span>
            case PHASE_MOVEMENT:
                // write Movement Phase header to report
<span class="nc" id="L2634">                addReport(new Report(2000, Report.PUBLIC));</span>
            case PHASE_SET_ARTYAUTOHITHEXES:
            case PHASE_DEPLOY_MINEFIELDS:
            case PHASE_DEPLOYMENT:
            case PHASE_FIRING:
            case PHASE_PHYSICAL:
            case PHASE_TARGETING:
            case PHASE_OFFBOARD:
<span class="nc" id="L2642">                changeToNextTurn(-1);</span>
<span class="nc bnc" id="L2643" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.BASE_PARANOID_AUTOSAVE)) {</span>
<span class="nc" id="L2644">                    autoSave();</span>
                }
                break;
            default:
        }
<span class="nc" id="L2649">    }</span>

    /**
     * Calculates all players initial BV, should only be called at start of game
     */
    public void calculatePlayerBVs() {
<span class="nc bnc" id="L2655" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; players = game.getPlayers(); players.hasMoreElements(); ) {</span>
<span class="nc" id="L2656">            players.nextElement().setInitialBV();</span>
        }
<span class="nc" id="L2658">    }</span>

    /**
     * loop through entities in the exchange phase (i.e. after leaving
     * chat lounge) and do any actions that need to be done
     */
    public void checkEntityExchange() {
<span class="nc bnc" id="L2665" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; entities = game.getEntities(); entities.hasNext(); ) {</span>
<span class="nc" id="L2666">            Entity entity = entities.next();</span>
            // apply bombs
<span class="nc bnc" id="L2668" title="All 2 branches missed.">            if (entity.isBomber()) {</span>
<span class="nc" id="L2669">                ((IBomber)entity).applyBombs();</span>
            }

<span class="nc bnc" id="L2672" title="All 2 branches missed.">            if (entity.isAero()) {</span>
<span class="nc" id="L2673">                IAero a = (IAero) entity;</span>
<span class="nc bnc" id="L2674" title="All 2 branches missed.">                if (a.isSpaceborne()) {</span>
                    // altitude and elevation don't matter in space
<span class="nc" id="L2676">                    a.liftOff(0);</span>
                } else {
                    // check for grounding
<span class="nc bnc" id="L2679" title="All 4 branches missed.">                    if (game.getBoard().inAtmosphere() &amp;&amp; !entity.isAirborne()) {</span>
                        // you have to be airborne on the atmospheric map
<span class="nc" id="L2681">                        a.liftOff(entity.getAltitude());</span>
                    }
                }

<span class="nc bnc" id="L2685" title="All 2 branches missed.">                if (entity.isFighter()) {</span>
<span class="nc" id="L2686">                    a.updateWeaponGroups();</span>
<span class="nc" id="L2687">                    entity.loadAllWeapons();</span>
                }
            }

            // if units were loaded in the chat lounge, I need to keep track of
            // it here because they can get dumped in the deployment phase
<span class="nc bnc" id="L2693" title="All 2 branches missed.">            if (entity.getLoadedUnits().size() &gt; 0) {</span>
<span class="nc" id="L2694">                Vector&lt;Integer&gt; v = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L2695" title="All 2 branches missed.">                for (Entity en : entity.getLoadedUnits()) {</span>
<span class="nc" id="L2696">                    v.add(en.getId());</span>
<span class="nc" id="L2697">                }</span>
<span class="nc" id="L2698">                entity.setLoadedKeepers(v);</span>
            }

<span class="nc bnc" id="L2701" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)</span>
<span class="nc bnc" id="L2702" title="All 2 branches missed.">                    &amp;&amp; (entity.isAero())) {</span>
<span class="nc" id="L2703">                Aero a = null;</span>
<span class="nc bnc" id="L2704" title="All 2 branches missed.">                if (entity instanceof Aero) {</span>
<span class="nc" id="L2705">                    a = (Aero) entity;</span>
                }
<span class="nc bnc" id="L2707" title="All 2 branches missed.">                if (entity.isCapitalScale()) {</span>
<span class="nc bnc" id="L2708" title="All 2 branches missed.">                    if (a != null) {</span>
<span class="nc" id="L2709">                        int currentSI = a.getSI() * 20;</span>
<span class="nc" id="L2710">                        a.initializeSI(a.get0SI() * 20);</span>
<span class="nc" id="L2711">                        a.setSI(currentSI);</span>
                    }
<span class="nc bnc" id="L2713" title="All 2 branches missed.">                    if (entity.isCapitalFighter()) {</span>
<span class="nc" id="L2714">                        ((IAero)entity).autoSetCapArmor();</span>
<span class="nc" id="L2715">                        ((IAero)entity).autoSetFatalThresh();</span>
                    } else {
                        // all armor and SI is going to be at standard scale, so
                        // we need to adjust
<span class="nc bnc" id="L2719" title="All 2 branches missed.">                        for (int loc = 0; loc &lt; entity.locations(); loc++) {</span>
<span class="nc bnc" id="L2720" title="All 2 branches missed.">                            if (entity.getArmor(loc) &gt; 0) {</span>
<span class="nc" id="L2721">                                int currentArmor = entity.getArmor(loc) * 10;</span>
<span class="nc" id="L2722">                                entity.initializeArmor(entity.getOArmor(loc) * 10, loc);</span>
<span class="nc" id="L2723">                                entity.setArmor(currentArmor, loc);</span>

                            }
                        }
                    }
<span class="nc bnc" id="L2728" title="All 2 branches missed.">                } else if (a != null) {</span>
<span class="nc" id="L2729">                    int currentSI = a.getSI() * 2;</span>
<span class="nc" id="L2730">                    a.initializeSI(a.get0SI() * 2);</span>
<span class="nc" id="L2731">                    a.setSI(currentSI);</span>
                }
            }
            // Give the unit a spotlight, if it has the spotlight quirk
<span class="nc bnc" id="L2735" title="All 2 branches missed.">            entity.setExternalSpotlight(entity.hasExternaSpotlight()</span>
<span class="nc bnc" id="L2736" title="All 2 branches missed.">                    || entity.hasQuirk(OptionsConstants.QUIRK_POS_SEARCHLIGHT));</span>
<span class="nc" id="L2737">            entityUpdate(entity.getId());</span>

            // Remove hot-loading some from LRMs for meks
<span class="nc bnc" id="L2740" title="All 2 branches missed.">            if (!game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_HOTLOAD_IN_GAME)) {</span>
<span class="nc bnc" id="L2741" title="All 2 branches missed.">                for (Entity e : game.getEntitiesVector()) {</span>
                    // Vehicles are allowed to hot load, just meks cannot
<span class="nc bnc" id="L2743" title="All 2 branches missed.">                    if (!(e instanceof Mech)) {</span>
<span class="nc" id="L2744">                        continue;</span>
                    }
<span class="nc bnc" id="L2746" title="All 2 branches missed.">                    for (Mounted weapon : e.getWeaponList()) {</span>
<span class="nc" id="L2747">                        weapon.getType().removeMode(&quot;HotLoad&quot;);</span>
<span class="nc" id="L2748">                    }</span>
<span class="nc bnc" id="L2749" title="All 2 branches missed.">                    for (Mounted ammo : e.getAmmo()) {</span>
<span class="nc" id="L2750">                        ammo.getType().removeMode(&quot;HotLoad&quot;);</span>
<span class="nc" id="L2751">                    }</span>
<span class="nc" id="L2752">                }</span>
            }
<span class="nc" id="L2754">        }</span>
<span class="nc" id="L2755">    }</span>

    /**
     * Ends this phase and moves on to the next.
     */
    private void endCurrentPhase() {
<span class="nc bnc" id="L2761" title="All 21 branches missed.">        switch (game.getPhase()) {</span>
            case PHASE_LOUNGE:
<span class="nc" id="L2763">                game.addReports(vPhaseReport);</span>
<span class="nc" id="L2764">                changePhase(IGame.Phase.PHASE_EXCHANGE);</span>
<span class="nc" id="L2765">                break;</span>
            case PHASE_EXCHANGE:
            case PHASE_STARTING_SCENARIO:
<span class="nc" id="L2768">                game.addReports(vPhaseReport);</span>
<span class="nc" id="L2769">                changePhase(IGame.Phase.PHASE_SET_ARTYAUTOHITHEXES);</span>
<span class="nc" id="L2770">                break;</span>
            case PHASE_SET_ARTYAUTOHITHEXES:
<span class="nc" id="L2772">                sendSpecialHexDisplayPackets();</span>
<span class="nc" id="L2773">                Enumeration&lt;IPlayer&gt; e = game.getPlayers();</span>
<span class="nc" id="L2774">                boolean mines = false;</span>
<span class="nc bnc" id="L2775" title="All 4 branches missed.">                while (e.hasMoreElements() &amp;&amp; !mines) {</span>
<span class="nc" id="L2776">                    IPlayer p = e.nextElement();</span>
<span class="nc bnc" id="L2777" title="All 2 branches missed.">                    if (p.hasMinefields()) {</span>
<span class="nc" id="L2778">                        mines = true;</span>
                    }
<span class="nc" id="L2780">                }</span>
<span class="nc" id="L2781">                game.addReports(vPhaseReport);</span>
<span class="nc bnc" id="L2782" title="All 2 branches missed.">                if (mines) {</span>
<span class="nc" id="L2783">                    changePhase(IGame.Phase.PHASE_DEPLOY_MINEFIELDS);</span>
                } else {
<span class="nc" id="L2785">                    changePhase(IGame.Phase.PHASE_INITIATIVE);</span>
                }
<span class="nc" id="L2787">                break;</span>
            case PHASE_DEPLOY_MINEFIELDS:
<span class="nc" id="L2789">                changePhase(IGame.Phase.PHASE_INITIATIVE);</span>
<span class="nc" id="L2790">                break;</span>
            case PHASE_DEPLOYMENT:
<span class="nc" id="L2792">                game.clearDeploymentThisRound();</span>
<span class="nc" id="L2793">                game.checkForCompleteDeployment();</span>
<span class="nc" id="L2794">                Enumeration&lt;IPlayer&gt; pls = game.getPlayers();</span>
<span class="nc bnc" id="L2795" title="All 2 branches missed.">                while (pls.hasMoreElements()) {</span>
<span class="nc" id="L2796">                    IPlayer p = pls.nextElement();</span>
<span class="nc" id="L2797">                    p.adjustStartingPosForReinforcements();</span>
<span class="nc" id="L2798">                }</span>

<span class="nc bnc" id="L2800" title="All 2 branches missed.">                if (game.getRoundCount() &lt; 1) {</span>
<span class="nc" id="L2801">                    changePhase(IGame.Phase.PHASE_INITIATIVE);</span>
                } else {
<span class="nc" id="L2803">                    changePhase(IGame.Phase.PHASE_TARGETING);</span>
                }
<span class="nc" id="L2805">                break;</span>
            case PHASE_INITIATIVE:
<span class="nc" id="L2807">                resolveWhatPlayersCanSeeWhatUnits();</span>
<span class="nc" id="L2808">                detectSpacecraft();</span>
<span class="nc" id="L2809">                game.addReports(vPhaseReport);</span>
<span class="nc" id="L2810">                changePhase(IGame.Phase.PHASE_INITIATIVE_REPORT);</span>
<span class="nc" id="L2811">                break;</span>
            case PHASE_INITIATIVE_REPORT:
                // NOTE: now that aeros can come and go from the battlefield, I
                // need
                // to update the
                // deployment table every round. I think this it is OK to go
                // here.
                // (Taharqa)
<span class="nc" id="L2819">                game.setupRoundDeployment();</span>
                // boolean doDeploy = game.shouldDeployThisRound() &amp;&amp;
                // (game.getLastPhase() != IGame.Phase.PHASE_DEPLOYMENT);
<span class="nc bnc" id="L2822" title="All 2 branches missed.">                if (game.shouldDeployThisRound()) {</span>
<span class="nc" id="L2823">                    changePhase(IGame.Phase.PHASE_DEPLOYMENT);</span>
                } else {
<span class="nc" id="L2825">                    changePhase(IGame.Phase.PHASE_TARGETING);</span>
                }
<span class="nc" id="L2827">                break;</span>
            case PHASE_MOVEMENT:
<span class="nc" id="L2829">                detectHiddenUnits();</span>
<span class="nc" id="L2830">                updateSpacecraftDetection();</span>
<span class="nc" id="L2831">                detectSpacecraft();</span>
<span class="nc" id="L2832">                resolveWhatPlayersCanSeeWhatUnits();</span>
<span class="nc" id="L2833">                doAllAssaultDrops();</span>
<span class="nc" id="L2834">                addMovementHeat();</span>
<span class="nc" id="L2835">                applyBuildingDamage();</span>
<span class="nc" id="L2836">                checkForPSRFromDamage();</span>
<span class="nc" id="L2837">                addReport(resolvePilotingRolls()); // Skids cause damage in</span>
                // movement phase
<span class="nc" id="L2839">                checkForFlamingDamage();</span>
<span class="nc" id="L2840">                checkForTeleMissileAttacks();</span>
<span class="nc" id="L2841">                cleanupDestroyedNarcPods();</span>
<span class="nc" id="L2842">                checkForFlawedCooling();</span>
<span class="nc" id="L2843">                resolveCallSupport();</span>
                // check phase report
<span class="nc bnc" id="L2845" title="All 2 branches missed.">                if (vPhaseReport.size() &gt; 1) {</span>
<span class="nc" id="L2846">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2847">                    changePhase(IGame.Phase.PHASE_MOVEMENT_REPORT);</span>
                } else {
                    // just the header, so we'll add the &lt;nothing&gt; label
<span class="nc" id="L2850">                    addReport(new Report(1205, Report.PUBLIC));</span>
<span class="nc" id="L2851">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2852">                    sendReport();</span>
<span class="nc" id="L2853">                    changePhase(IGame.Phase.PHASE_OFFBOARD);</span>
                }
<span class="nc" id="L2855">                break;</span>
            case PHASE_MOVEMENT_REPORT:
<span class="nc" id="L2857">                changePhase(IGame.Phase.PHASE_OFFBOARD);</span>
<span class="nc" id="L2858">                break;</span>
            case PHASE_FIRING:
                // write Weapon Attack Phase header
<span class="nc" id="L2861">                addReport(new Report(3000, Report.PUBLIC));</span>
<span class="nc" id="L2862">                resolveWhatPlayersCanSeeWhatUnits();</span>
<span class="nc" id="L2863">                resolveAllButWeaponAttacks();</span>
<span class="nc" id="L2864">                resolveSelfDestructions();</span>
<span class="nc" id="L2865">                reportGhostTargetRolls();</span>
<span class="nc" id="L2866">                reportLargeCraftECCMRolls();</span>
<span class="nc" id="L2867">                resolveOnlyWeaponAttacks();</span>
<span class="nc" id="L2868">                assignAMS();</span>
<span class="nc" id="L2869">                handleAttacks();</span>
<span class="nc" id="L2870">                resolveScheduledNukes();</span>
<span class="nc" id="L2871">                applyBuildingDamage();</span>
<span class="nc" id="L2872">                checkForPSRFromDamage();</span>
<span class="nc" id="L2873">                cleanupDestroyedNarcPods();</span>
<span class="nc" id="L2874">                addReport(resolvePilotingRolls());</span>
<span class="nc" id="L2875">                checkForFlawedCooling();</span>
                // check phase report
<span class="nc bnc" id="L2877" title="All 2 branches missed.">                if (vPhaseReport.size() &gt; 1) {</span>
<span class="nc" id="L2878">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2879">                    changePhase(IGame.Phase.PHASE_FIRING_REPORT);</span>
                } else {
                    // just the header, so we'll add the &lt;nothing&gt; label
<span class="nc" id="L2882">                    addReport(new Report(1205, Report.PUBLIC));</span>
<span class="nc" id="L2883">                    sendReport();</span>
<span class="nc" id="L2884">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2885">                    changePhase(IGame.Phase.PHASE_PHYSICAL);</span>
                }
<span class="nc" id="L2887">                break;</span>
            case PHASE_FIRING_REPORT:
<span class="nc" id="L2889">                changePhase(IGame.Phase.PHASE_PHYSICAL);</span>
<span class="nc" id="L2890">                break;</span>
            case PHASE_PHYSICAL:
<span class="nc" id="L2892">                resolveWhatPlayersCanSeeWhatUnits();</span>
<span class="nc" id="L2893">                resolvePhysicalAttacks();</span>
<span class="nc" id="L2894">                applyBuildingDamage();</span>
<span class="nc" id="L2895">                checkForPSRFromDamage();</span>
<span class="nc" id="L2896">                addReport(resolvePilotingRolls());</span>
<span class="nc" id="L2897">                resolveSinkVees();</span>
<span class="nc" id="L2898">                cleanupDestroyedNarcPods();</span>
<span class="nc" id="L2899">                checkForFlawedCooling();</span>
<span class="nc" id="L2900">                checkForChainWhipGrappleChecks();</span>
                // check phase report
<span class="nc bnc" id="L2902" title="All 2 branches missed.">                if (vPhaseReport.size() &gt; 1) {</span>
<span class="nc" id="L2903">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2904">                    changePhase(IGame.Phase.PHASE_PHYSICAL_REPORT);</span>
                } else {
                    // just the header, so we'll add the &lt;nothing&gt; label
<span class="nc" id="L2907">                    addReport(new Report(1205, Report.PUBLIC));</span>
<span class="nc" id="L2908">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2909">                    sendReport();</span>
<span class="nc" id="L2910">                    changePhase(IGame.Phase.PHASE_END);</span>
                }
<span class="nc" id="L2912">                break;</span>
            case PHASE_PHYSICAL_REPORT:
<span class="nc" id="L2914">                changePhase(IGame.Phase.PHASE_END);</span>
<span class="nc" id="L2915">                break;</span>
            case PHASE_TARGETING:
<span class="nc" id="L2917">                vPhaseReport.addElement(new Report(1035, Report.PUBLIC));</span>
<span class="nc" id="L2918">                resolveAllButWeaponAttacks();</span>
<span class="nc" id="L2919">                resolveOnlyWeaponAttacks();</span>
<span class="nc" id="L2920">                handleAttacks();</span>
                // check reports
<span class="nc bnc" id="L2922" title="All 2 branches missed.">                if (vPhaseReport.size() &gt; 1) {</span>
<span class="nc" id="L2923">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2924">                    changePhase(IGame.Phase.PHASE_TARGETING_REPORT);</span>
                } else {
                    // just the header, so we'll add the &lt;nothing&gt; label
<span class="nc" id="L2927">                    vPhaseReport.addElement(new Report(1205, Report.PUBLIC));</span>
<span class="nc" id="L2928">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2929">                    sendReport();</span>
<span class="nc" id="L2930">                    changePhase(IGame.Phase.PHASE_MOVEMENT);</span>
                }

<span class="nc" id="L2933">                sendSpecialHexDisplayPackets();</span>
<span class="nc bnc" id="L2934" title="All 2 branches missed.">                for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L2935">                    IPlayer player = i.nextElement();</span>
<span class="nc" id="L2936">                    int connId = player.getId();</span>
<span class="nc" id="L2937">                    send(connId, createArtilleryPacket(player));</span>
<span class="nc" id="L2938">                }</span>

<span class="nc" id="L2940">                break;</span>
            case PHASE_OFFBOARD:
                // write Offboard Attack Phase header
<span class="nc" id="L2943">                addReport(new Report(1100, Report.PUBLIC));</span>
<span class="nc" id="L2944">                resolveAllButWeaponAttacks(); // torso twist or flip arms</span>
                // possible
<span class="nc" id="L2946">                resolveOnlyWeaponAttacks(); // should only be TAG at this point</span>
<span class="nc" id="L2947">                handleAttacks();</span>
<span class="nc bnc" id="L2948" title="All 2 branches missed.">                for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L2949">                    IPlayer player = i.nextElement();</span>
<span class="nc" id="L2950">                    int connId = player.getId();</span>
<span class="nc" id="L2951">                    send(connId, createArtilleryPacket(player));</span>
<span class="nc" id="L2952">                }</span>
<span class="nc" id="L2953">                applyBuildingDamage();</span>
<span class="nc" id="L2954">                checkForPSRFromDamage();</span>
<span class="nc" id="L2955">                addReport(resolvePilotingRolls());</span>

<span class="nc" id="L2957">                cleanupDestroyedNarcPods();</span>
<span class="nc" id="L2958">                checkForFlawedCooling();</span>

<span class="nc" id="L2960">                sendSpecialHexDisplayPackets();</span>
<span class="nc" id="L2961">                sendTagInfoUpdates();</span>

                // check reports
<span class="nc bnc" id="L2964" title="All 2 branches missed.">                if (vPhaseReport.size() &gt; 1) {</span>
<span class="nc" id="L2965">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2966">                    changePhase(IGame.Phase.PHASE_OFFBOARD_REPORT);</span>
                } else {
                    // just the header, so we'll add the &lt;nothing&gt; label
<span class="nc" id="L2969">                    addReport(new Report(1205, Report.PUBLIC));</span>
<span class="nc" id="L2970">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2971">                    sendReport();</span>
<span class="nc" id="L2972">                    changePhase(IGame.Phase.PHASE_FIRING);</span>
                }
<span class="nc" id="L2974">                break;</span>
            case PHASE_OFFBOARD_REPORT:
<span class="nc" id="L2976">                sendSpecialHexDisplayPackets();</span>
<span class="nc" id="L2977">                changePhase(IGame.Phase.PHASE_FIRING);</span>
<span class="nc" id="L2978">                break;</span>
            case PHASE_TARGETING_REPORT:
<span class="nc" id="L2980">                changePhase(IGame.Phase.PHASE_MOVEMENT);</span>
<span class="nc" id="L2981">                break;</span>
            case PHASE_END:
                // remove any entities that died in the heat/end phase before
                // checking for victory
<span class="nc" id="L2985">                resetEntityPhase(IGame.Phase.PHASE_END);</span>
<span class="nc" id="L2986">                boolean victory = victory(); // note this may add reports</span>
                // check phase report
                // HACK: hardcoded message ID check
<span class="nc bnc" id="L2989" title="All 4 branches missed.">                if ((vPhaseReport.size() &gt; 3) || ((vPhaseReport.size() &gt; 1)</span>
<span class="nc bnc" id="L2990" title="All 2 branches missed.">                        &amp;&amp; (vPhaseReport.elementAt(1).messageId != 1205))) {</span>
<span class="nc" id="L2991">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2992">                    changePhase(IGame.Phase.PHASE_END_REPORT);</span>
                } else {
                    // just the heat and end headers, so we'll add
                    // the &lt;nothing&gt; label
<span class="nc" id="L2996">                    addReport(new Report(1205, Report.PUBLIC));</span>
<span class="nc" id="L2997">                    game.addReports(vPhaseReport);</span>
<span class="nc" id="L2998">                    sendReport();</span>
<span class="nc bnc" id="L2999" title="All 2 branches missed.">                    if (victory) {</span>
<span class="nc" id="L3000">                        changePhase(IGame.Phase.PHASE_VICTORY);</span>
                    } else {
<span class="nc" id="L3002">                        changePhase(IGame.Phase.PHASE_INITIATIVE);</span>
                    }
                }
                // Decrement the ASEWAffected counter
<span class="nc" id="L3006">                decrementASEWTurns();</span>

<span class="nc" id="L3008">                break;</span>
            case PHASE_END_REPORT:
<span class="nc bnc" id="L3010" title="All 2 branches missed.">                if (changePlayersTeam) {</span>
<span class="nc" id="L3011">                    processTeamChange();</span>
                }
<span class="nc bnc" id="L3013" title="All 2 branches missed.">                if (victory()) {</span>
<span class="nc" id="L3014">                    changePhase(IGame.Phase.PHASE_VICTORY);</span>
                } else {
<span class="nc" id="L3016">                    changePhase(IGame.Phase.PHASE_INITIATIVE);</span>
                }
<span class="nc" id="L3018">                break;</span>
            case PHASE_VICTORY:
<span class="nc" id="L3020">                GameVictoryEvent gve = new GameVictoryEvent(this, game);</span>
<span class="nc" id="L3021">                game.processGameEvent(gve);</span>
<span class="nc" id="L3022">                transmitGameVictoryEventToAll();</span>
<span class="nc" id="L3023">                resetGame();</span>
<span class="nc" id="L3024">                break;</span>
            default:
        }

        // Any hidden units that activated this phase, should clear their
        // activating phase
<span class="nc bnc" id="L3030" title="All 2 branches missed.">        for (Entity ent : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L3031" title="All 2 branches missed.">            if (ent.getHiddenActivationPhase() == game.getPhase()) {</span>
<span class="nc" id="L3032">                ent.setHiddeActivationPhase(null);</span>
            }
<span class="nc" id="L3034">        }</span>
<span class="nc" id="L3035">    }</span>

    private void sendSpecialHexDisplayPackets() {
<span class="nc bnc" id="L3038" title="All 2 branches missed.">        if (connections == null) {</span>
<span class="nc" id="L3039">            return;</span>
        }
<span class="nc bnc" id="L3041" title="All 2 branches missed.">        for (int i = 0; i &lt; connections.size(); i++) {</span>
<span class="nc bnc" id="L3042" title="All 2 branches missed.">            if (connections.get(i) != null) {</span>
<span class="nc" id="L3043">                connections.get(i).send(createSpecialHexDisplayPacket(i));</span>
            }
        }
<span class="nc" id="L3046">    }</span>

    private void sendTagInfoUpdates() {
<span class="nc bnc" id="L3049" title="All 2 branches missed.">        if (connections == null) {</span>
<span class="nc" id="L3050">            return;</span>
        }
<span class="nc bnc" id="L3052" title="All 2 branches missed.">        for (IConnection connection : connections) {</span>
<span class="nc bnc" id="L3053" title="All 2 branches missed.">            if (connection != null) {</span>
<span class="nc" id="L3054">                connection.send(createTagInfoUpdatesPacket());</span>
            }
<span class="nc" id="L3056">        }</span>
<span class="nc" id="L3057">    }</span>

    public void sendTagInfoReset() {
<span class="nc bnc" id="L3060" title="All 2 branches missed.">        if (connections == null) {</span>
<span class="nc" id="L3061">            return;</span>
        }
<span class="nc bnc" id="L3063" title="All 2 branches missed.">        for (IConnection connection : connections) {</span>
<span class="nc bnc" id="L3064" title="All 2 branches missed.">            if (connection != null) {</span>
<span class="nc" id="L3065">                connection.send(new Packet(Packet.COMMAND_RESET_TAGINFO));</span>
            }
<span class="nc" id="L3067">        }</span>
<span class="nc" id="L3068">    }</span>

    /**
     * Increment's the server's game round and send it to all the clients
     */
    private void incrementAndSendGameRound() {
<span class="nc" id="L3074">        game.incrementRoundCount();</span>
<span class="nc" id="L3075">        send(new Packet(Packet.COMMAND_ROUND_UPDATE, game.getRoundCount()));</span>
<span class="nc" id="L3076">    }</span>

    /**
     * Hand over a turn to the next player. This is only possible if you haven't
     * yet started your turn (i.e. not yet moved anything like infantry where
     * you have to move multiple units)
     *
     * @param connectionId - connection id of the player sending the packet
     */
    private void receiveForwardIni(int connectionId) {
        // this is the player sending the packet
<span class="nc" id="L3087">        IPlayer current = getPlayer(connectionId);</span>

<span class="nc bnc" id="L3089" title="All 2 branches missed.">        if (game.getTurn().getPlayerNum() != current.getId()) {</span>
            // this player is not the current player, so just ignore this
            // command!
<span class="nc" id="L3092">            return;</span>
        }
        // if individual initiative is active we cannot forward our initiative
        // ever!
<span class="nc bnc" id="L3096" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.RPG_INDIVIDUAL_INITIATIVE)) {</span>
<span class="nc" id="L3097">            return;</span>
        }
        
        // if the player isn't on a team, there is no next team by definition. Skip the rest.
<span class="nc" id="L3101">        Team currentPlayerTeam = game.getTeamForPlayer(current);</span>
<span class="nc bnc" id="L3102" title="All 2 branches missed.">        if (currentPlayerTeam == null) {</span>
<span class="nc" id="L3103">            return;</span>
        }
        
        // get the next player from the team this player is on.
<span class="nc" id="L3107">        IPlayer next = currentPlayerTeam.getNextValidPlayer(current, game);</span>
        
<span class="nc bnc" id="L3109" title="All 2 branches missed.">        while (!next.equals(current)) {</span>
            // if the chosen player is a valid player, we change the turn order and
            // inform the clients.
<span class="nc bnc" id="L3112" title="All 4 branches missed.">            if ((next != null) &amp;&amp; (game.getEntitiesOwnedBy(next) != 0)</span>
<span class="nc bnc" id="L3113" title="All 2 branches missed.">                    &amp;&amp; (game.getTurnForPlayer(next.getId()) != null)) {</span>
    
<span class="nc" id="L3115">                int currentTurnIndex = game.getTurnIndex();</span>
                // now look for the next occurrence of player next in the turn order
<span class="nc" id="L3117">                List&lt;GameTurn&gt; turns = game.getTurnVector();</span>
<span class="nc" id="L3118">                GameTurn turn = game.getTurn();</span>
                // not entirely necessary. As we will also check this for the
                // activity of the button but to be sure do it on the server too.
<span class="nc bnc" id="L3121" title="All 6 branches missed.">                boolean isGeneralMoveTurn = !(turn instanceof GameTurn.SpecificEntityTurn)</span>
                        &amp;&amp; !(turn instanceof GameTurn.UnitNumberTurn)
                        &amp;&amp; !(turn instanceof GameTurn.UnloadStrandedTurn);
<span class="nc bnc" id="L3124" title="All 2 branches missed.">                if (!isGeneralMoveTurn) {</span>
                    // if this is not a general turn the player cannot forward his turn.
<span class="nc" id="L3126">                    return;</span>
                }
    
                // if it is an EntityClassTurn we have to check make sure, that the
                // turn it is exchanged with is the same kind of turn!
                // in fact this requires an access function to the mask of an
                // EntityClassTurn.
<span class="nc" id="L3133">                boolean isEntityClassTurn = (turn instanceof GameTurn.EntityClassTurn);</span>
<span class="nc" id="L3134">                int classMask = 0;</span>
<span class="nc bnc" id="L3135" title="All 2 branches missed.">                if (isEntityClassTurn) {</span>
<span class="nc" id="L3136">                    classMask = ((GameTurn.EntityClassTurn) turn).getTurnCode();</span>
                }
    
<span class="nc" id="L3139">                boolean switched = false;</span>
<span class="nc" id="L3140">                int nextTurnId = 0;</span>
<span class="nc bnc" id="L3141" title="All 2 branches missed.">                for (int i = currentTurnIndex; i &lt; turns.size(); i++) {</span>
                    // if we find a turn for the specific player, swap the current
                    // player with the player noted there
                    // and stop
<span class="nc bnc" id="L3145" title="All 2 branches missed.">                    if (turns.get(i).isValid(next.getId(), game)) {</span>
<span class="nc" id="L3146">                        nextTurnId = i;</span>
<span class="nc bnc" id="L3147" title="All 2 branches missed.">                        if (isEntityClassTurn) {</span>
                            // if we had an EntityClassTurn
<span class="nc bnc" id="L3149" title="All 2 branches missed.">                            if ((turns.get(i) instanceof GameTurn.EntityClassTurn)) {</span>
                                // and found another EntityClassTurn
<span class="nc bnc" id="L3151" title="All 2 branches missed.">                                if (!(((GameTurn.EntityClassTurn) turns.get(i)).getTurnCode() == classMask)) {</span>
                                    // both have to refer to the SAME class(es) or
                                    // they need to be rejected.
<span class="nc" id="L3154">                                    continue;</span>
                                }
                            } else {
                                continue;
                            }
                        }
<span class="nc" id="L3160">                        switched = true;</span>
<span class="nc" id="L3161">                        break;</span>
                    }
                }
    
                // update turn order
<span class="nc bnc" id="L3166" title="All 2 branches missed.">                if (switched) {</span>
<span class="nc" id="L3167">                    game.swapTurnOrder(currentTurnIndex, nextTurnId);</span>
                    // update the turn packages for all players.
<span class="nc" id="L3169">                    send(createTurnVectorPacket());</span>
<span class="nc" id="L3170">                    send(createTurnIndexPacket(connectionId));</span>
<span class="nc" id="L3171">                    return;</span>
                }
                // if nothing changed return without doing anything
            }
            
<span class="nc" id="L3176">            next = currentPlayerTeam.getNextValidPlayer(next, game);</span>
        }
<span class="nc" id="L3178">    }</span>

    /**
     * Tries to change to the next turn. If there are no more turns, ends the
     * current phase. If the player whose turn it is next is not connected, we
     * allow the other players to skip that player.
     */
    private void changeToNextTurn(int prevPlayerId) {
<span class="nc bnc" id="L3186" title="All 2 branches missed.">        boolean minefieldPhase = game.getPhase() == IGame.Phase.PHASE_DEPLOY_MINEFIELDS;</span>
<span class="nc bnc" id="L3187" title="All 2 branches missed.">        boolean artyPhase = game.getPhase() == IGame.Phase.PHASE_SET_ARTYAUTOHITHEXES;</span>
        
<span class="nc" id="L3189">        GameTurn nextTurn = null;</span>
<span class="nc" id="L3190">        Entity nextEntity = null;</span>
<span class="nc bnc" id="L3191" title="All 4 branches missed.">        while (game.hasMoreTurns() &amp;&amp; (null == nextEntity)) {</span>
<span class="nc" id="L3192">            nextTurn = game.changeToNextTurn();</span>
<span class="nc" id="L3193">            nextEntity = game.getEntity(game.getFirstEntityNum(nextTurn));</span>
<span class="nc bnc" id="L3194" title="All 4 branches missed.">            if (minefieldPhase || artyPhase) {</span>
<span class="nc" id="L3195">                break;</span>
            }
        }
   
        // if there aren't any more valid turns, end the phase
        // note that some phases don't use entities
<span class="nc bnc" id="L3201" title="All 8 branches missed.">        if (((null == nextEntity) &amp;&amp; !minefieldPhase) || ((null == nextTurn) &amp;&amp; minefieldPhase)) {</span>
<span class="nc" id="L3202">            endCurrentPhase();</span>
<span class="nc" id="L3203">            return;</span>
        }

<span class="nc" id="L3206">        IPlayer player = getPlayer(nextTurn.getPlayerNum());</span>

<span class="nc bnc" id="L3208" title="All 4 branches missed.">        if ((player != null) &amp;&amp; (game.getEntitiesOwnedBy(player) == 0)) {</span>
<span class="nc" id="L3209">            endCurrentTurn(null);</span>
<span class="nc" id="L3210">            return;</span>
        }

<span class="nc bnc" id="L3213" title="All 2 branches missed.">        if (prevPlayerId != -1) {</span>
<span class="nc" id="L3214">            send(createTurnIndexPacket(prevPlayerId));</span>
        } else {
<span class="nc bnc" id="L3216" title="All 2 branches missed.">            send(createTurnIndexPacket(player != null ? player.getId() : IPlayer.PLAYER_NONE));</span>
        }

<span class="nc bnc" id="L3219" title="All 4 branches missed.">        if ((null != player) &amp;&amp; player.isGhost()) {</span>
<span class="nc" id="L3220">            sendGhostSkipMessage(player);</span>
<span class="nc bnc" id="L3221" title="All 8 branches missed.">        } else if ((null == game.getFirstEntity()) &amp;&amp; (null != player) &amp;&amp; !minefieldPhase &amp;&amp; !artyPhase) {</span>
<span class="nc" id="L3222">            sendTurnErrorSkipMessage(player);</span>
        }
<span class="nc" id="L3224">    }</span>

    /**
     * Sends out a notification message indicating that a ghost player may be
     * skipped.
     *
     * @param ghost - the &lt;code&gt;Player&lt;/code&gt; who is ghosted. This value must not
     *              be &lt;code&gt;null&lt;/code&gt;.
     */
    private void sendGhostSkipMessage(IPlayer ghost) {
<span class="nc" id="L3234">        String message = &quot;Player '&quot; + ghost.getName() +</span>
                &quot;' is disconnected.  You may skip his/her current turn with the /skip command.&quot;;
<span class="nc" id="L3236">        sendServerChat(message);</span>
<span class="nc" id="L3237">    }</span>

    /**
     * Sends out a notification message indicating that the current turn is an
     * error and should be skipped.
     *
     * @param skip - the &lt;code&gt;Player&lt;/code&gt; who is to be skipped. This value
     *             must not be &lt;code&gt;null&lt;/code&gt;.
     */
    private void sendTurnErrorSkipMessage(IPlayer skip) {
<span class="nc" id="L3247">        String message = &quot;Player '&quot; + skip.getName() +</span>
                &quot;' has no units to move.  You should skip his/her/your current turn with the /skip command. &quot; +
                &quot;You may want to report this error at https://github.com/MegaMek/megamek/issues&quot;;
<span class="nc" id="L3250">        sendServerChat(message);</span>
<span class="nc" id="L3251">    }</span>

    /**
     * Skips the current turn. This only makes sense in phases that have turns.
     * Operates by finding an entity to move and then doing nothing with it.
     */
    public void skipCurrentTurn() {
        // find an entity to skip...
<span class="nc" id="L3259">        Entity toSkip = game.getFirstEntity();</span>

<span class="nc bnc" id="L3261" title="All 4 branches missed.">        switch (game.getPhase()) {</span>
            case PHASE_DEPLOYMENT:
                // allow skipping during deployment,
                // we need that when someone removes a unit.
<span class="nc" id="L3265">                endCurrentTurn(null);</span>
<span class="nc" id="L3266">                break;</span>
            case PHASE_MOVEMENT:
<span class="nc bnc" id="L3268" title="All 2 branches missed.">                if (toSkip != null) {</span>
<span class="nc" id="L3269">                    processMovement(toSkip, new MovePath(game, toSkip), null);</span>
                }
<span class="nc" id="L3271">                endCurrentTurn(toSkip);</span>
<span class="nc" id="L3272">                break;</span>
            case PHASE_FIRING:
            case PHASE_PHYSICAL:
            case PHASE_TARGETING:
            case PHASE_OFFBOARD:
<span class="nc bnc" id="L3277" title="All 2 branches missed.">                if (toSkip != null) {</span>
<span class="nc" id="L3278">                    processAttack(toSkip, new Vector&lt;&gt;(0));</span>
                }
<span class="nc" id="L3280">                endCurrentTurn(toSkip);</span>
<span class="nc" id="L3281">                break;</span>
            default:
        }
<span class="nc" id="L3284">    }</span>

    /**
     * Returns true if the current turn may be skipped. Ghost players' turns are
     * skippable, and a turn should be skipped if there's nothing to move.
     */
    public boolean isTurnSkippable() {
<span class="nc" id="L3291">        GameTurn turn = game.getTurn();</span>
<span class="nc bnc" id="L3292" title="All 2 branches missed.">        if (null == turn) {</span>
<span class="nc" id="L3293">            return false;</span>
        }
<span class="nc" id="L3295">        IPlayer player = getPlayer(turn.getPlayerNum());</span>
<span class="nc bnc" id="L3296" title="All 6 branches missed.">        return (null == player) || player.isGhost() || (game.getFirstEntity() == null);</span>
    }

    /**
     * Returns true if victory conditions have been met. Victory conditions are
     * when there is only one player left with mechs or only one team. will also
     * add some reports to reporting
     */
    public boolean victory() {
<span class="nc" id="L3305">        VictoryResult vr = game.getVictory().checkForVictory(game, game.getVictoryContext());</span>
<span class="nc bnc" id="L3306" title="All 2 branches missed.">        for (Report r : vr.getReports()) {</span>
<span class="nc" id="L3307">            addReport(r);</span>
<span class="nc" id="L3308">        }</span>

<span class="nc bnc" id="L3310" title="All 2 branches missed.">        if (vr.victory()) {</span>
<span class="nc" id="L3311">            boolean draw = vr.isDraw();</span>
<span class="nc" id="L3312">            int wonPlayer = vr.getWinningPlayer();</span>
<span class="nc" id="L3313">            int wonTeam = vr.getWinningTeam();</span>

<span class="nc bnc" id="L3315" title="All 2 branches missed.">            if (wonPlayer != IPlayer.PLAYER_NONE) {</span>
<span class="nc" id="L3316">                Report r = new Report(7200, Report.PUBLIC);</span>
<span class="nc" id="L3317">                r.add(Server.getColorForPlayer(game.getPlayer(wonPlayer)));</span>
<span class="nc" id="L3318">                addReport(r);</span>
            }
<span class="nc bnc" id="L3320" title="All 2 branches missed.">            if (wonTeam != IPlayer.TEAM_NONE) {</span>
<span class="nc" id="L3321">                Report r = new Report(7200, Report.PUBLIC);</span>
<span class="nc" id="L3322">                r.add(&quot;Team &quot; + wonTeam);</span>
<span class="nc" id="L3323">                addReport(r);</span>
            }
<span class="nc bnc" id="L3325" title="All 2 branches missed.">            if (draw) {</span>
                // multiple-won draw
<span class="nc" id="L3327">                game.setVictoryPlayerId(IPlayer.PLAYER_NONE);</span>
<span class="nc" id="L3328">                game.setVictoryTeam(IPlayer.TEAM_NONE);</span>
            } else {
                // nobody-won draw or
                // single player won or
                // single team won
<span class="nc" id="L3333">                game.setVictoryPlayerId(wonPlayer);</span>
<span class="nc" id="L3334">                game.setVictoryTeam(wonTeam);</span>
            }
<span class="nc" id="L3336">        } else {</span>
<span class="nc" id="L3337">            game.setVictoryPlayerId(IPlayer.PLAYER_NONE);</span>
<span class="nc" id="L3338">            game.setVictoryTeam(IPlayer.TEAM_NONE);</span>
<span class="nc bnc" id="L3339" title="All 2 branches missed.">            if (game.isForceVictory()) {</span>
<span class="nc" id="L3340">                cancelVictory();</span>
            }
        }
<span class="nc" id="L3343">        return vr.victory();</span>
    }// end victory

    private boolean isPlayerForcedVictory() {
        // check game options
<span class="nc bnc" id="L3348" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.VICTORY_SKIP_FORCED_VICTORY)) {</span>
<span class="nc" id="L3349">            return false;</span>
        }

<span class="nc bnc" id="L3352" title="All 2 branches missed.">        if (!game.isForceVictory()) {</span>
<span class="nc" id="L3353">            return false;</span>
        }

<span class="nc bnc" id="L3356" title="All 2 branches missed.">        for (IPlayer player : game.getPlayersVector()) {</span>
<span class="nc bnc" id="L3357" title="All 4 branches missed.">            if ((player.getId() == game.getVictoryPlayerId()) || ((player.getTeam() == game.getVictoryTeam())</span>
<span class="nc bnc" id="L3358" title="All 2 branches missed.">                    &amp;&amp; (game.getVictoryTeam() != IPlayer.TEAM_NONE))) {</span>
<span class="nc" id="L3359">                continue;</span>
            }

<span class="nc bnc" id="L3362" title="All 2 branches missed.">            if (!player.admitsDefeat()) {</span>
<span class="nc" id="L3363">                return false;</span>
            }
<span class="nc" id="L3365">        }</span>

<span class="nc" id="L3367">        return true;</span>
    }

    /**
     * Applies board settings. This loads and combines all the boards that were
     * specified into one mega-board and sets that board as current.
     */
    public void applyBoardSettings() {
<span class="nc" id="L3375">        mapSettings.replaceBoardWithRandom(MapSettings.BOARD_RANDOM);</span>
<span class="nc" id="L3376">        mapSettings.replaceBoardWithRandom(MapSettings.BOARD_SURPRISE);</span>
<span class="nc" id="L3377">        IBoard[] sheetBoards = new IBoard[mapSettings.getMapWidth()</span>
<span class="nc" id="L3378">                * mapSettings.getMapHeight()];</span>
<span class="nc" id="L3379">        List&lt;Boolean&gt; rotateBoard = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L3380">        for (int i = 0; i &lt; (mapSettings.getMapWidth() * mapSettings</span>
<span class="nc bnc" id="L3381" title="All 2 branches missed.">                .getMapHeight()); i++) {</span>
<span class="nc" id="L3382">            sheetBoards[i] = new Board();</span>
<span class="nc" id="L3383">            String name = mapSettings.getBoardsSelectedVector().get(i);</span>
<span class="nc" id="L3384">            boolean isRotated = false;</span>
<span class="nc bnc" id="L3385" title="All 2 branches missed.">            if (name.startsWith(Board.BOARD_REQUEST_ROTATION)) {</span>
                // only rotate boards with an even width
<span class="nc bnc" id="L3387" title="All 2 branches missed.">                if ((mapSettings.getBoardWidth() % 2) == 0) {</span>
<span class="nc" id="L3388">                    isRotated = true;</span>
                }
<span class="nc" id="L3390">                name = name.substring(Board.BOARD_REQUEST_ROTATION.length());</span>
            }
<span class="nc bnc" id="L3392" title="All 2 branches missed.">            if (name.startsWith(MapSettings.BOARD_GENERATED)</span>
<span class="nc bnc" id="L3393" title="All 2 branches missed.">                    || (mapSettings.getMedium() == MapSettings.MEDIUM_SPACE)) {</span>
<span class="nc" id="L3394">                sheetBoards[i] = BoardUtilities.generateRandom(mapSettings);</span>
            } else {
<span class="nc" id="L3396">                sheetBoards[i].load(new MegaMekFile(Configuration.boardsDir(), name</span>
<span class="nc" id="L3397">                        + &quot;.board&quot;).getFile());</span>
<span class="nc" id="L3398">                BoardUtilities.flip(sheetBoards[i], isRotated, isRotated);</span>
            }
<span class="nc" id="L3400">            rotateBoard.add(isRotated);</span>
        }
<span class="nc" id="L3402">        IBoard newBoard = BoardUtilities.combine(mapSettings.getBoardWidth(),</span>
<span class="nc" id="L3403">                mapSettings.getBoardHeight(), mapSettings.getMapWidth(),</span>
<span class="nc" id="L3404">                mapSettings.getMapHeight(), sheetBoards, rotateBoard,</span>
<span class="nc" id="L3405">                mapSettings.getMedium());</span>
<span class="nc bnc" id="L3406" title="All 2 branches missed.">        if (game.getOptions().getOption(OptionsConstants.BASE_BRIDGECF).intValue() &gt; 0) {</span>
<span class="nc" id="L3407">            newBoard.setBridgeCF(game.getOptions().getOption(OptionsConstants.BASE_BRIDGECF).intValue());</span>
        }
<span class="nc bnc" id="L3409" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.BASE_RANDOM_BASEMENTS)) {</span>
<span class="nc" id="L3410">            newBoard.setRandomBasementsOff();</span>
        }
<span class="nc bnc" id="L3412" title="All 2 branches missed.">        if (game.getPlanetaryConditions().isTerrainAffected()) {</span>
<span class="nc" id="L3413">            BoardUtilities.addWeatherConditions(newBoard, game.getPlanetaryConditions().getWeather(),</span>
<span class="nc" id="L3414">                    game.getPlanetaryConditions().getWindStrength());</span>
        }
<span class="nc" id="L3416">        game.setBoard(newBoard);</span>
<span class="nc" id="L3417">    }</span>

    /**
     * Rolls initiative for all the players.
     */
    private void rollInitiative() {
<span class="nc bnc" id="L3423" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.RPG_INDIVIDUAL_INITIATIVE)) {</span>
<span class="nc" id="L3424">            TurnOrdered.rollInitiative(game.getEntitiesVector(), false);</span>
        } else {
            // Roll for initiative on the teams.
<span class="nc" id="L3427">            TurnOrdered.rollInitiative(game.getTeamsVector(),</span>
<span class="nc bnc" id="L3428" title="All 2 branches missed.">                    game.getOptions().booleanOption(OptionsConstants.INIT_INITIATIVE_STREAK_COMPENSATION)</span>
<span class="nc bnc" id="L3429" title="All 2 branches missed.">                    &amp;&amp; !game.shouldDeployThisRound());</span>
        }

<span class="nc" id="L3432">        transmitAllPlayerUpdates();</span>
<span class="nc" id="L3433">    }</span>

    private Vector&lt;GameTurn&gt; checkTurnOrderStranded(TurnVectors team_order) {
<span class="nc" id="L3436">        Vector&lt;GameTurn&gt; turns = new Vector&lt;&gt;(team_order.getTotalTurns()</span>
<span class="nc" id="L3437">                + team_order.getEvenTurns());</span>
        // Stranded units only during movement phases, rebuild the turns vector
<span class="nc bnc" id="L3439" title="All 2 branches missed.">        if (game.getPhase() == IGame.Phase.PHASE_MOVEMENT) {</span>
            // See if there are any loaded units stranded on immobile transports.
<span class="nc" id="L3441">            Iterator&lt;Entity&gt; strandedUnits = game.getSelectedEntities(</span>
<span class="nc" id="L3442">                    entity -&gt; game.isEntityStranded(entity));</span>
<span class="nc bnc" id="L3443" title="All 2 branches missed.">            if (strandedUnits.hasNext()) {</span>
                // Add a game turn to unload stranded units, if this
                // is the movement phase.
<span class="nc" id="L3446">                turns = new Vector&lt;&gt;(team_order.getTotalTurns()</span>
<span class="nc" id="L3447">                        + team_order.getEvenTurns() + 1);</span>
<span class="nc" id="L3448">                turns.addElement(new GameTurn.UnloadStrandedTurn(strandedUnits));</span>
            }
        }
<span class="nc" id="L3451">        return turns;</span>
    }

    /**
     * Determines the turn oder for a given phase (with individual init)
     *
     * @param phase the &lt;code&gt;int&lt;/code&gt; id of the phase
     */
    private void determineTurnOrderIUI(IGame.Phase phase) {
<span class="nc bnc" id="L3460" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; loop = game.getEntities(); loop.hasNext();) {</span>
<span class="nc" id="L3461">            final Entity entity = loop.next();</span>
<span class="nc" id="L3462">            entity.resetOtherTurns();</span>
<span class="nc bnc" id="L3463" title="All 2 branches missed.">            if (entity.isSelectableThisTurn()) {</span>
<span class="nc" id="L3464">                entity.incrementOtherTurns();</span>
            }
<span class="nc" id="L3466">        }</span>

        List&lt;Entity&gt; entities;
        // If the protos move multi option isn't on, protos move as a unit
        // Need to adjust entities vector otherwise we'll have too many turns
        // when first proto in a unit moves, new turns get added so rest of the
        // unit will move
<span class="nc" id="L3473">        boolean protosMoveMulti = game.getOptions().booleanOption(</span>
                OptionsConstants.INIT_PROTOS_MOVE_MULTI);
<span class="nc bnc" id="L3475" title="All 2 branches missed.">        if (!protosMoveMulti) {</span>
<span class="nc" id="L3476">            entities = new ArrayList&lt;&gt;(game.getEntitiesVector().size());</span>
<span class="nc" id="L3477">            Set&lt;Short&gt; movedUnits = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L3478" title="All 2 branches missed.">            for (Entity e : game.getEntitiesVector()) {</span>
                // This only effects Protos for the time being
<span class="nc bnc" id="L3480" title="All 2 branches missed.">                if (!(e instanceof Protomech)) {</span>
<span class="nc" id="L3481">                    entities.add(e);</span>
<span class="nc" id="L3482">                    continue;</span>
                }
<span class="nc" id="L3484">                short unitNumber = e.getUnitNumber();</span>
<span class="nc bnc" id="L3485" title="All 2 branches missed.">                if ((unitNumber == Entity.NONE)</span>
<span class="nc bnc" id="L3486" title="All 2 branches missed.">                        || !movedUnits.contains(unitNumber)) {</span>
<span class="nc" id="L3487">                    entities.add(e);</span>
<span class="nc bnc" id="L3488" title="All 2 branches missed.">                    if (unitNumber != Entity.NONE) {</span>
<span class="nc" id="L3489">                        movedUnits.add(unitNumber);</span>
                    }
                }
<span class="nc" id="L3492">            }</span>
<span class="nc" id="L3493">        } else {</span>
<span class="nc" id="L3494">            entities = game.getEntitiesVector();</span>
        }
        // Now, generate the global order of all teams' turns.
<span class="nc" id="L3497">        TurnVectors team_order = TurnOrdered.generateTurnOrder(entities, game);</span>

        // Now, we collect everything into a single vector.
<span class="nc" id="L3500">        Vector&lt;GameTurn&gt; turns = checkTurnOrderStranded(team_order);</span>

        // add the turns (this is easy)
<span class="nc bnc" id="L3503" title="All 2 branches missed.">        while (team_order.hasMoreElements()) {</span>
<span class="nc" id="L3504">            Entity e = (Entity) team_order.nextElement();</span>
<span class="nc bnc" id="L3505" title="All 2 branches missed.">            if (e.isSelectableThisTurn()) {</span>
<span class="nc bnc" id="L3506" title="All 6 branches missed.">                if (!protosMoveMulti &amp;&amp; (e instanceof Protomech) &amp;&amp; (e.getUnitNumber() != Entity.NONE)) {</span>
<span class="nc" id="L3507">                    turns.addElement(new GameTurn.UnitNumberTurn(e.getOwnerId(), e.getUnitNumber()));</span>
                } else {
<span class="nc" id="L3509">                    turns.addElement(new GameTurn.SpecificEntityTurn(e.getOwnerId(), e.getId()));</span>
                }
            }
<span class="nc" id="L3512">        }</span>

        // set fields in game
<span class="nc" id="L3515">        game.setTurnVector(turns);</span>
<span class="nc" id="L3516">        game.resetTurnIndex();</span>

        // send turns to all players
<span class="nc" id="L3519">        send(createTurnVectorPacket());</span>
<span class="nc" id="L3520">    }</span>

    /**
     * Determines the turn order for a given phase
     *
     * @param phase the &lt;code&gt;int&lt;/code&gt; id of the phase
     */
    private void determineTurnOrder(IGame.Phase phase) {
<span class="nc bnc" id="L3528" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.RPG_INDIVIDUAL_INITIATIVE)) {</span>
<span class="nc" id="L3529">            determineTurnOrderIUI(phase);</span>
<span class="nc" id="L3530">            return;</span>
        }
        // and/or deploy even according to game options.
<span class="nc bnc" id="L3533" title="All 2 branches missed.">        boolean infMoveEven = (game.getOptions().booleanOption(OptionsConstants.INIT_INF_MOVE_EVEN)</span>
<span class="nc bnc" id="L3534" title="All 2 branches missed.">                &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_INITIATIVE)</span>
<span class="nc bnc" id="L3535" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_MOVEMENT)))</span>
<span class="nc bnc" id="L3536" title="All 2 branches missed.">                || (game.getOptions().booleanOption(OptionsConstants.INIT_INF_DEPLOY_EVEN)</span>
<span class="nc bnc" id="L3537" title="All 2 branches missed.">                &amp;&amp; (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT));</span>
<span class="nc" id="L3538">        boolean infMoveMulti = game.getOptions()</span>
<span class="nc bnc" id="L3539" title="All 2 branches missed.">                .booleanOption(OptionsConstants.INIT_INF_MOVE_MULTI)</span>
<span class="nc bnc" id="L3540" title="All 2 branches missed.">                &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_INITIATIVE)</span>
<span class="nc bnc" id="L3541" title="All 2 branches missed.">                || ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3542" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT)));</span>
<span class="nc bnc" id="L3543" title="All 2 branches missed.">        boolean protosMoveEven = (game.getOptions().booleanOption(</span>
                OptionsConstants.INIT_PROTOS_MOVE_EVEN)
<span class="nc bnc" id="L3545" title="All 2 branches missed.">                &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_INITIATIVE)</span>
<span class="nc bnc" id="L3546" title="All 2 branches missed.">                || ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3547" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT))))</span>
<span class="nc bnc" id="L3548" title="All 2 branches missed.">                || (game.getOptions().booleanOption(OptionsConstants.INIT_PROTOS_MOVE_EVEN)</span>
<span class="nc bnc" id="L3549" title="All 2 branches missed.">                &amp;&amp; (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT));</span>
<span class="nc" id="L3550">        boolean protosMoveMulti = game.getOptions().booleanOption(</span>
                OptionsConstants.INIT_PROTOS_MOVE_MULTI);
<span class="nc bnc" id="L3552" title="All 2 branches missed.">        boolean protosMoveByPoint = !protosMoveMulti;</span>
<span class="nc bnc" id="L3553" title="All 2 branches missed.">        boolean tankMoveByLance = game.getOptions().booleanOption(</span>
                OptionsConstants.ADVGRNDMOV_VEHICLE_LANCE_MOVEMENT)
<span class="nc bnc" id="L3555" title="All 2 branches missed.">                &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_INITIATIVE)</span>
<span class="nc bnc" id="L3556" title="All 2 branches missed.">                || ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3557" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT)));</span>
<span class="nc bnc" id="L3558" title="All 2 branches missed.">        boolean mekMoveByLance = game.getOptions().booleanOption(</span>
                OptionsConstants.ADVGRNDMOV_MEK_LANCE_MOVEMENT)
<span class="nc bnc" id="L3560" title="All 2 branches missed.">                &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_INITIATIVE)</span>
<span class="nc bnc" id="L3561" title="All 2 branches missed.">                || ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3562" title="All 2 branches missed.">                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT)));</span>

<span class="nc" id="L3564">        int evenMask = 0;</span>
<span class="nc bnc" id="L3565" title="All 2 branches missed.">        if (infMoveEven) {</span>
<span class="nc" id="L3566">            evenMask += GameTurn.CLASS_INFANTRY;</span>
        }
<span class="nc bnc" id="L3568" title="All 2 branches missed.">        if (protosMoveEven) {</span>
<span class="nc" id="L3569">            evenMask += GameTurn.CLASS_PROTOMECH;</span>
        }
        // Reset all of the Players' turn category counts
<span class="nc bnc" id="L3572" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; loop = game.getPlayers(); loop.hasMoreElements(); ) {</span>
<span class="nc" id="L3573">            final IPlayer player = loop.nextElement();</span>
<span class="nc" id="L3574">            player.resetEvenTurns();</span>
<span class="nc" id="L3575">            player.resetMultiTurns();</span>
<span class="nc" id="L3576">            player.resetOtherTurns();</span>
<span class="nc" id="L3577">            player.resetSpaceStationTurns();</span>
<span class="nc" id="L3578">            player.resetJumpshipTurns();</span>
<span class="nc" id="L3579">            player.resetWarshipTurns();</span>
<span class="nc" id="L3580">            player.resetDropshipTurns();</span>
<span class="nc" id="L3581">            player.resetSmallCraftTurns();</span>
<span class="nc" id="L3582">            player.resetAeroTurns();</span>

            // Add turns for ProtoMechs weapons declaration.
<span class="nc bnc" id="L3585" title="All 2 branches missed.">            if (protosMoveByPoint) {</span>

                // How many ProtoMechs does the player have?
<span class="nc" id="L3588">                Iterator&lt;Entity&gt; playerProtos = game.getSelectedEntities(new EntitySelector() {</span>
<span class="nc" id="L3589">                            private final int ownerId = player.getId();</span>

                            public boolean accept(Entity entity) {
<span class="nc bnc" id="L3592" title="All 2 branches missed.">                                return (entity instanceof Protomech)</span>
<span class="nc bnc" id="L3593" title="All 2 branches missed.">                                        &amp;&amp; (ownerId == entity.getOwnerId())</span>
<span class="nc bnc" id="L3594" title="All 2 branches missed.">                                        &amp;&amp; entity.isSelectableThisTurn();</span>
                            }
                        });
<span class="nc" id="L3597">                HashSet&lt;Integer&gt; points = new HashSet&lt;&gt;();</span>
<span class="nc" id="L3598">                int numPlayerProtos = 0;</span>
<span class="nc bnc" id="L3599" title="All 2 branches missed.">                for (; playerProtos.hasNext(); ) {</span>
<span class="nc" id="L3600">                    Entity proto = playerProtos.next();</span>
<span class="nc" id="L3601">                    numPlayerProtos++;</span>
<span class="nc" id="L3602">                    points.add((int) proto.getUnitNumber());</span>
<span class="nc" id="L3603">                }</span>
<span class="nc" id="L3604">                int numProtoUnits = (int) Math.ceil(numPlayerProtos / 5.0);</span>
<span class="nc bnc" id="L3605" title="All 2 branches missed.">                if (!protosMoveEven) {</span>
<span class="nc" id="L3606">                    numProtoUnits = points.size();</span>
                }
<span class="nc bnc" id="L3608" title="All 2 branches missed.">                for (int unit = 0; unit &lt; numProtoUnits; unit++) {</span>
<span class="nc bnc" id="L3609" title="All 2 branches missed.">                    if (protosMoveEven) {</span>
<span class="nc" id="L3610">                        player.incrementEvenTurns();</span>
                    } else {
<span class="nc" id="L3612">                        player.incrementOtherTurns();</span>
                    }
                }

            } // End handle-proto-firing-turns

<span class="nc" id="L3618">        } // Handle the next player</span>

        // Go through all entities, and update the turn categories of the
        // entity's player. The teams get their totals from their players.
        // N.B. ProtoMechs declare weapons fire based on their point.
<span class="nc bnc" id="L3623" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; loop = game.getEntities(); loop.hasNext();) {</span>
<span class="nc" id="L3624">            final Entity entity = loop.next();</span>
<span class="nc bnc" id="L3625" title="All 2 branches missed.">            if (entity.isSelectableThisTurn()) {</span>
<span class="nc" id="L3626">                final IPlayer player = entity.getOwner();</span>
<span class="nc bnc" id="L3627" title="All 2 branches missed.">                if ((entity instanceof SpaceStation)</span>
<span class="nc bnc" id="L3628" title="All 2 branches missed.">                        &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3629" title="All 2 branches missed.">                                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT))) {</span>
<span class="nc" id="L3630">                    player.incrementSpaceStationTurns();</span>
<span class="nc bnc" id="L3631" title="All 2 branches missed.">                } else if ((entity instanceof Warship)</span>
<span class="nc bnc" id="L3632" title="All 2 branches missed.">                        &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3633" title="All 2 branches missed.">                                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT))) {</span>
<span class="nc" id="L3634">                    player.incrementWarshipTurns();</span>
<span class="nc bnc" id="L3635" title="All 2 branches missed.">                } else if ((entity instanceof Jumpship)</span>
<span class="nc bnc" id="L3636" title="All 2 branches missed.">                        &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3637" title="All 2 branches missed.">                                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT))) {</span>
<span class="nc" id="L3638">                    player.incrementJumpshipTurns();</span>
<span class="nc bnc" id="L3639" title="All 4 branches missed.">                } else if ((entity instanceof Dropship) &amp;&amp; entity.isAirborne()</span>
<span class="nc bnc" id="L3640" title="All 2 branches missed.">                        &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3641" title="All 2 branches missed.">                                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT))) {</span>
<span class="nc" id="L3642">                    player.incrementDropshipTurns();</span>
<span class="nc bnc" id="L3643" title="All 4 branches missed.">                } else if ((entity instanceof SmallCraft) &amp;&amp; entity.isAirborne()</span>
<span class="nc bnc" id="L3644" title="All 2 branches missed.">                        &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3645" title="All 2 branches missed.">                                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT))) {</span>
<span class="nc" id="L3646">                    player.incrementSmallCraftTurns();</span>
<span class="nc bnc" id="L3647" title="All 2 branches missed.">                } else if (entity.isAirborne()</span>
<span class="nc bnc" id="L3648" title="All 2 branches missed.">                        &amp;&amp; ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3649" title="All 2 branches missed.">                                || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT))) {</span>
<span class="nc" id="L3650">                    player.incrementAeroTurns();</span>
<span class="nc bnc" id="L3651" title="All 2 branches missed.">                } else if ((entity instanceof Infantry)) {</span>
<span class="nc bnc" id="L3652" title="All 2 branches missed.">                    if (infMoveEven) {</span>
<span class="nc" id="L3653">                        player.incrementEvenTurns();</span>
<span class="nc bnc" id="L3654" title="All 2 branches missed.">                    } else if (infMoveMulti) {</span>
<span class="nc" id="L3655">                        player.incrementMultiTurns(GameTurn.CLASS_INFANTRY);</span>
                    } else {
<span class="nc" id="L3657">                        player.incrementOtherTurns();</span>
                    }
<span class="nc bnc" id="L3659" title="All 2 branches missed.">                } else if (entity instanceof Protomech) {</span>
<span class="nc bnc" id="L3660" title="All 2 branches missed.">                    if (!protosMoveByPoint) {</span>
<span class="nc bnc" id="L3661" title="All 2 branches missed.">                        if (protosMoveEven) {</span>
<span class="nc" id="L3662">                            player.incrementEvenTurns();</span>
<span class="nc bnc" id="L3663" title="All 2 branches missed.">                        } else if (protosMoveMulti) {</span>
<span class="nc" id="L3664">                            player.incrementMultiTurns(GameTurn.CLASS_PROTOMECH);</span>
                        } else {
<span class="nc" id="L3666">                            player.incrementOtherTurns();</span>
                        }
                    }
<span class="nc bnc" id="L3669" title="All 4 branches missed.">                } else if ((entity instanceof Tank) &amp;&amp; tankMoveByLance) {</span>
<span class="nc" id="L3670">                    player.incrementMultiTurns(GameTurn.CLASS_TANK);</span>
<span class="nc bnc" id="L3671" title="All 4 branches missed.">                } else if ((entity instanceof Mech) &amp;&amp; mekMoveByLance) {</span>
<span class="nc" id="L3672">                    player.incrementMultiTurns(GameTurn.CLASS_MECH);</span>
                } else {
<span class="nc" id="L3674">                    player.incrementOtherTurns();</span>
                }
            }
<span class="nc" id="L3677">        }</span>

        // Generate the turn order for the Players *within*
        // each Team. Map the teams to their turn orders.
        // Count the number of teams moving this turn.
<span class="nc" id="L3682">        int nTeams = game.getNoOfTeams();</span>
<span class="nc" id="L3683">        Hashtable&lt;Team, TurnVectors&gt; allTeamTurns = new Hashtable&lt;&gt;(nTeams);</span>
<span class="nc" id="L3684">        Hashtable&lt;Team, int[]&gt; evenTrackers = new Hashtable&lt;&gt;(nTeams);</span>
<span class="nc" id="L3685">        int numTeamsMoving = 0;</span>
<span class="nc bnc" id="L3686" title="All 2 branches missed.">        for (Enumeration&lt;Team&gt; loop = game.getTeams(); loop.hasMoreElements(); ) {</span>
<span class="nc" id="L3687">            final Team team = loop.nextElement();</span>
<span class="nc" id="L3688">            allTeamTurns.put(team, team.determineTeamOrder(game));</span>

            // Track both the number of times we've checked the team for
            // &quot;leftover&quot; turns, and the number of &quot;leftover&quot; turns placed.
<span class="nc" id="L3692">            int[] evenTracker = new int[2];</span>
<span class="nc" id="L3693">            evenTrackers.put(team, evenTracker);</span>

            // Count this team if it has any &quot;normal&quot; moves.
<span class="nc bnc" id="L3696" title="All 2 branches missed.">            if (team.getNormalTurns(game) &gt; 0) {</span>
<span class="nc" id="L3697">                numTeamsMoving++;</span>
            }
<span class="nc" id="L3699">        }</span>

        // Now, generate the global order of all teams' turns.
<span class="nc" id="L3702">        TurnVectors team_order = TurnOrdered.generateTurnOrder(game.getTeamsVector(), game);</span>

        // Now, we collect everything into a single vector.
<span class="nc" id="L3705">        Vector&lt;GameTurn&gt; turns = checkTurnOrderStranded(team_order);</span>

        // Walk through the global order, assigning turns
        // for individual players to the single vector.
        // Keep track of how many turns we've added to the vector.
<span class="nc" id="L3710">        Team prevTeam = null;</span>
<span class="nc" id="L3711">        int min = team_order.getMin();</span>
<span class="nc bnc" id="L3712" title="All 2 branches missed.">        for (int numTurn = 0; team_order.hasMoreElements(); numTurn++) {</span>
<span class="nc" id="L3713">            Team team = (Team) team_order.nextElement();</span>
<span class="nc" id="L3714">            TurnVectors withinTeamTurns = allTeamTurns.get(team);</span>

<span class="nc" id="L3716">            int[] evenTracker = evenTrackers.get(team);</span>
<span class="nc" id="L3717">            float teamEvenTurns = team.getEvenTurns();</span>

            // Calculate the number of &quot;even&quot; turns to add for this team.
<span class="nc" id="L3720">            int numEven = 0;</span>
<span class="nc bnc" id="L3721" title="All 2 branches missed.">            if (1 == numTeamsMoving) {</span>
                // If there's only one team moving, we don't need to bother
                // with the evenTracker, just make sure the even turns are
                // evenly distributed
<span class="nc" id="L3725">                numEven += (int) Math.round(teamEvenTurns / min);</span>
<span class="nc bnc" id="L3726" title="All 2 branches missed.">            } else if (prevTeam == null) {</span>
                // Increment the number of times we've checked for &quot;leftovers&quot;.
<span class="nc" id="L3728">                evenTracker[0]++;</span>

                // The first team to move just adds the &quot;baseline&quot; turns.
<span class="nc" id="L3731">                numEven += Math.round(teamEvenTurns / min);</span>
<span class="nc bnc" id="L3732" title="All 2 branches missed.">            } else if (!team.equals(prevTeam)) {</span>
                // Increment the number of times we've checked for &quot;leftovers&quot;.
<span class="nc" id="L3734">                evenTracker[0]++;</span>

                // This weird equation attempts to spread the &quot;leftover&quot;
                // turns across the turn's moves in a &quot;fair&quot; manner.
                // It's based on the number of times we've checked for
                // &quot;leftovers&quot; the number of &quot;leftovers&quot; we started with,
                // the number of times we've added a turn for a &quot;leftover&quot;,
                // and the total number of times we're going to check.
<span class="nc" id="L3742">                numEven += (int) Math.ceil(((evenTracker[0] * (teamEvenTurns % min)) / min) - 0.5)</span>
                           - evenTracker[1];

                // Update the number of turns actually added for &quot;leftovers&quot;.
<span class="nc" id="L3746">                evenTracker[1] += numEven;</span>

                // Add the &quot;baseline&quot; number of turns.
<span class="nc" id="L3749">                numEven += Math.round(teamEvenTurns / min);</span>
            }

            // Record this team for the next move.
<span class="nc" id="L3753">            prevTeam = team;</span>

<span class="nc" id="L3755">            int aeroMask = GameTurn.CLASS_AERO + GameTurn.CLASS_SMALL_CRAFT</span>
                           + GameTurn.CLASS_DROPSHIP + GameTurn.CLASS_JUMPSHIP
                           + GameTurn.CLASS_WARSHIP + GameTurn.CLASS_SPACE_STATION;
            GameTurn turn;
            IPlayer player;
<span class="nc bnc" id="L3760" title="All 2 branches missed.">            if (withinTeamTurns.hasMoreNormalElements()) {</span>
                // Not a placeholder... get the player who moves next.
<span class="nc" id="L3762">                player = (IPlayer) withinTeamTurns.nextNormalElement();</span>

                // If we've added all &quot;normal&quot; turns, allocate turns
                // for the infantry and/or ProtoMechs moving even.
<span class="nc bnc" id="L3766" title="All 2 branches missed.">                if (numTurn &gt;= team_order.getTotalTurns()) {</span>
<span class="nc" id="L3767">                    turn = new GameTurn.EntityClassTurn(player.getId(), evenMask);</span>
                }
                // If either Infantry or ProtoMechs move even, only allow
                // the other classes to move during the &quot;normal&quot; turn.
<span class="nc bnc" id="L3771" title="All 4 branches missed.">                else if (infMoveEven || protosMoveEven) {</span>
<span class="nc" id="L3772">                    int newMask = evenMask;</span>
                    // if this is the movement phase, then don't allow Aeros on
                    // normal turns
<span class="nc bnc" id="L3775" title="All 2 branches missed.">                    if ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3776" title="All 2 branches missed.">                            || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT)) {</span>
<span class="nc" id="L3777">                        newMask += aeroMask;</span>
                    }
<span class="nc" id="L3779">                    turn = new GameTurn.EntityClassTurn(player.getId(), ~newMask);</span>
<span class="nc" id="L3780">                }</span>
                // Otherwise, let *anybody* move.
                else {
                    // well, almost anybody; Aero don't get normal turns during
                    // the movement phase
<span class="nc bnc" id="L3785" title="All 2 branches missed.">                    if ((game.getPhase() == IGame.Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L3786" title="All 2 branches missed.">                            || (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT)) {</span>
<span class="nc" id="L3787">                        turn = new GameTurn.EntityClassTurn(player.getId(), ~aeroMask);</span>
                    } else {
<span class="nc" id="L3789">                        turn = new GameTurn(player.getId());</span>
                    }
                }
<span class="nc" id="L3792">                turns.addElement(turn);</span>
            } // End team-has-&quot;normal&quot;-turns
<span class="nc bnc" id="L3794" title="All 2 branches missed.">            else if (withinTeamTurns.hasMoreSpaceStationElements()) {</span>
<span class="nc" id="L3795">                player = (IPlayer) withinTeamTurns.nextSpaceStationElement();</span>
<span class="nc" id="L3796">                turn = new GameTurn.EntityClassTurn(player.getId(), GameTurn.CLASS_SPACE_STATION);</span>
<span class="nc" id="L3797">                turns.addElement(turn);</span>
<span class="nc bnc" id="L3798" title="All 2 branches missed.">            } else if (withinTeamTurns.hasMoreJumpshipElements()) {</span>
<span class="nc" id="L3799">                player = (IPlayer) withinTeamTurns.nextJumpshipElement();</span>
<span class="nc" id="L3800">                turn = new GameTurn.EntityClassTurn(player.getId(), GameTurn.CLASS_JUMPSHIP);</span>
<span class="nc" id="L3801">                turns.addElement(turn);</span>
<span class="nc bnc" id="L3802" title="All 2 branches missed.">            } else if (withinTeamTurns.hasMoreWarshipElements()) {</span>
<span class="nc" id="L3803">                player = (IPlayer) withinTeamTurns.nextWarshipElement();</span>
<span class="nc" id="L3804">                turn = new GameTurn.EntityClassTurn(player.getId(), GameTurn.CLASS_WARSHIP);</span>
<span class="nc" id="L3805">                turns.addElement(turn);</span>
<span class="nc bnc" id="L3806" title="All 2 branches missed.">            } else if (withinTeamTurns.hasMoreDropshipElements()) {</span>
<span class="nc" id="L3807">                player = (IPlayer) withinTeamTurns.nextDropshipElement();</span>
<span class="nc" id="L3808">                turn = new GameTurn.EntityClassTurn(player.getId(), GameTurn.CLASS_DROPSHIP);</span>
<span class="nc" id="L3809">                turns.addElement(turn);</span>
<span class="nc bnc" id="L3810" title="All 2 branches missed.">            } else if (withinTeamTurns.hasMoreSmallCraftElements()) {</span>
<span class="nc" id="L3811">                player = (IPlayer) withinTeamTurns.nextSmallCraftElement();</span>
<span class="nc" id="L3812">                turn = new GameTurn.EntityClassTurn(player.getId(), GameTurn.CLASS_SMALL_CRAFT);</span>
<span class="nc" id="L3813">                turns.addElement(turn);</span>
<span class="nc bnc" id="L3814" title="All 2 branches missed.">            } else if (withinTeamTurns.hasMoreAeroElements()) {</span>
<span class="nc" id="L3815">                player = (IPlayer) withinTeamTurns.nextAeroElement();</span>
<span class="nc" id="L3816">                turn = new GameTurn.EntityClassTurn(player.getId(), GameTurn.CLASS_AERO);</span>
<span class="nc" id="L3817">                turns.addElement(turn);</span>
            }

            // Add the calculated number of &quot;even&quot; turns.
            // Allow the player at least one &quot;normal&quot; turn before the
            // &quot;even&quot; turns to help with loading infantry in deployment.
<span class="nc bnc" id="L3823" title="All 4 branches missed.">            while ((numEven &gt; 0) &amp;&amp; withinTeamTurns.hasMoreEvenElements()) {</span>
<span class="nc" id="L3824">                IPlayer evenPlayer = (IPlayer) withinTeamTurns.nextEvenElement();</span>
<span class="nc" id="L3825">                turns.addElement(new GameTurn.EntityClassTurn(evenPlayer.getId(), evenMask));</span>
<span class="nc" id="L3826">                numEven--;</span>
<span class="nc" id="L3827">            }</span>
        }

        // set fields in game
<span class="nc" id="L3831">        game.setTurnVector(turns);</span>
<span class="nc" id="L3832">        game.resetTurnIndex();</span>

        // send turns to all players
<span class="nc" id="L3835">        send(createTurnVectorPacket());</span>
<span class="nc" id="L3836">    }</span>

    private static String getColorForPlayer(IPlayer p) {
<span class="nc" id="L3839">        return &quot;&lt;B&gt;&lt;font color='&quot; + p.getColour().getHexString(0x00F0F0F0) + &quot;'&gt;&quot; + p.getName() + &quot;&lt;/font&gt;&lt;/B&gt;&quot;;</span>
    }

    /**
     * Write the initiative results to the report
     */
    private void writeInitiativeReport(boolean abbreviatedReport) {
        // write to report
        Report r;
<span class="nc" id="L3848">        boolean deployment = false;</span>
<span class="nc bnc" id="L3849" title="All 2 branches missed.">        if (!abbreviatedReport) {</span>
<span class="nc" id="L3850">            r = new Report(1210);</span>
<span class="nc" id="L3851">            r.type = Report.PUBLIC;</span>
<span class="nc bnc" id="L3852" title="All 4 branches missed.">            if ((game.getLastPhase() == IGame.Phase.PHASE_DEPLOYMENT) || game.isDeploymentComplete()</span>
<span class="nc bnc" id="L3853" title="All 2 branches missed.">                    || !game.shouldDeployThisRound()) {</span>
<span class="nc" id="L3854">                r.messageId = 1000;</span>
<span class="nc" id="L3855">                r.add(game.getRoundCount());</span>
            } else {
<span class="nc" id="L3857">                deployment = true;</span>
<span class="nc bnc" id="L3858" title="All 2 branches missed.">                if (game.getRoundCount() == 0) {</span>
<span class="nc" id="L3859">                    r.messageId = 1005;</span>
                } else {
<span class="nc" id="L3861">                    r.messageId = 1010;</span>
<span class="nc" id="L3862">                    r.add(game.getRoundCount());</span>
                }
            }
<span class="nc" id="L3865">            addReport(r);</span>
            // write separator
<span class="nc" id="L3867">            addReport(new Report(1200, Report.PUBLIC));</span>
        } else {
<span class="nc" id="L3869">            addReport(new Report(1210, Report.PUBLIC));</span>
        }

<span class="nc bnc" id="L3872" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.RPG_INDIVIDUAL_INITIATIVE)) {</span>
<span class="nc" id="L3873">            r = new Report(1040, Report.PUBLIC);</span>
<span class="nc" id="L3874">            addReport(r);</span>
<span class="nc bnc" id="L3875" title="All 2 branches missed.">            for (Enumeration&lt;GameTurn&gt; e = game.getTurns(); e.hasMoreElements(); ) {</span>
<span class="nc" id="L3876">                GameTurn t = e.nextElement();</span>
<span class="nc bnc" id="L3877" title="All 2 branches missed.">                if (t instanceof GameTurn.SpecificEntityTurn) {</span>
<span class="nc" id="L3878">                    Entity entity = game.getEntity(((GameTurn.SpecificEntityTurn) t).getEntityNum());</span>
<span class="nc" id="L3879">                    r = new Report(1045);</span>
<span class="nc" id="L3880">                    r.subject = entity.getId();</span>
<span class="nc" id="L3881">                    r.addDesc(entity);</span>
<span class="nc" id="L3882">                    r.add(entity.getInitiative().toString());</span>
<span class="nc" id="L3883">                    addReport(r);</span>
<span class="nc" id="L3884">                } else {</span>
<span class="nc" id="L3885">                    IPlayer player = getPlayer(t.getPlayerNum());</span>
<span class="nc bnc" id="L3886" title="All 2 branches missed.">                    if (null != player) {</span>
<span class="nc" id="L3887">                        r = new Report(1050, Report.PUBLIC);</span>
<span class="nc" id="L3888">                        r.add(Server.getColorForPlayer(player));</span>
<span class="nc" id="L3889">                        addReport(r);</span>
                    }
                }
<span class="nc" id="L3892">            }</span>
        } else {
<span class="nc bnc" id="L3894" title="All 2 branches missed.">            for (Enumeration&lt;Team&gt; i = game.getTeams(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L3895">                final Team team = i.nextElement();</span>

                // Teams with no active players can be ignored
<span class="nc bnc" id="L3898" title="All 2 branches missed.">                if (team.isObserverTeam()) {</span>
<span class="nc" id="L3899">                    continue;</span>
                }

                // If there is only one non-observer player, list
                // them as the 'team', and use the team initiative
<span class="nc bnc" id="L3904" title="All 2 branches missed.">                if (team.getNonObserverSize() == 1) {</span>
<span class="nc" id="L3905">                    final IPlayer player = team.getNonObserverPlayers().nextElement();</span>
<span class="nc" id="L3906">                    r = new Report(1015, Report.PUBLIC);</span>
<span class="nc" id="L3907">                    r.add(Server.getColorForPlayer(player));</span>
<span class="nc" id="L3908">                    r.add(team.getInitiative().toString());</span>
<span class="nc" id="L3909">                    addReport(r);</span>
<span class="nc" id="L3910">                } else {</span>
                    // Multiple players. List the team, then break it down.
<span class="nc" id="L3912">                    r = new Report(1015, Report.PUBLIC);</span>
<span class="nc" id="L3913">                    r.add(IPlayer.teamNames[team.getId()]);</span>
<span class="nc" id="L3914">                    r.add(team.getInitiative().toString());</span>
<span class="nc" id="L3915">                    addReport(r);</span>
<span class="nc bnc" id="L3916" title="All 2 branches missed.">                    for (Enumeration&lt;IPlayer&gt; j = team.getNonObserverPlayers(); j.hasMoreElements(); ) {</span>
<span class="nc" id="L3917">                        final IPlayer player = j.nextElement();</span>
<span class="nc" id="L3918">                        r = new Report(1015, Report.PUBLIC);</span>
<span class="nc" id="L3919">                        r.indent();</span>
<span class="nc" id="L3920">                        r.add(player.getName());</span>
<span class="nc" id="L3921">                        r.add(player.getInitiative().toString());</span>
<span class="nc" id="L3922">                        addReport(r);</span>
<span class="nc" id="L3923">                    }</span>
                }
<span class="nc" id="L3925">            }</span>

<span class="nc bnc" id="L3927" title="All 2 branches missed.">            if (!doBlind()) {</span>

                // The turn order is different in movement phase
                // if a player has any &quot;even&quot; moving units.
<span class="nc" id="L3931">                r = new Report(1020, Report.PUBLIC);</span>

<span class="nc" id="L3933">                boolean hasEven = false;</span>
<span class="nc bnc" id="L3934" title="All 2 branches missed.">                for (Enumeration&lt;GameTurn&gt; i = game.getTurns(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L3935">                    GameTurn turn = i.nextElement();</span>
<span class="nc" id="L3936">                    IPlayer player = getPlayer(turn.getPlayerNum());</span>
<span class="nc bnc" id="L3937" title="All 2 branches missed.">                    if (null != player) {</span>
<span class="nc" id="L3938">                        r.add(player.getName());</span>
<span class="nc bnc" id="L3939" title="All 2 branches missed.">                        if (player.getEvenTurns() &gt; 0) {</span>
<span class="nc" id="L3940">                            hasEven = true;</span>
                        }
                    }
<span class="nc" id="L3943">                }</span>
<span class="nc" id="L3944">                r.newlines = 2;</span>
<span class="nc" id="L3945">                addReport(r);</span>
<span class="nc bnc" id="L3946" title="All 2 branches missed.">                if (hasEven) {</span>
<span class="nc" id="L3947">                    r = new Report(1021, Report.PUBLIC);</span>
<span class="nc bnc" id="L3948" title="All 2 branches missed.">                    if ((game.getOptions().booleanOption(OptionsConstants.INIT_INF_DEPLOY_EVEN)</span>
<span class="nc bnc" id="L3949" title="All 2 branches missed.">                            || game.getOptions().booleanOption(OptionsConstants.INIT_PROTOS_MOVE_EVEN))</span>
<span class="nc bnc" id="L3950" title="All 2 branches missed.">                            &amp;&amp; !(game.getLastPhase() == IGame.Phase.PHASE_END_REPORT)) {</span>
<span class="nc" id="L3951">                        r.choose(true);</span>
                    } else {
<span class="nc" id="L3953">                        r.choose(false);</span>
                    }
<span class="nc" id="L3955">                    r.indent();</span>
<span class="nc" id="L3956">                    r.newlines = 2;</span>
<span class="nc" id="L3957">                    addReport(r);</span>
                }
            }

        }
<span class="nc bnc" id="L3962" title="All 2 branches missed.">        if (!abbreviatedReport) {</span>
            // we don't much care about wind direction and such in a hard vacuum
<span class="nc bnc" id="L3964" title="All 2 branches missed.">            if(!game.getBoard().inSpace()) {</span>
                // Wind direction and strength
<span class="nc" id="L3966">                Report rWindDir = new Report(1025, Report.PUBLIC);</span>
<span class="nc" id="L3967">                rWindDir.add(game.getPlanetaryConditions().getWindDirDisplayableName());</span>
<span class="nc" id="L3968">                rWindDir.newlines = 0;</span>
<span class="nc" id="L3969">                Report rWindStr = new Report(1030, Report.PUBLIC);</span>
<span class="nc" id="L3970">                rWindStr.add(game.getPlanetaryConditions().getWindDisplayableName());</span>
<span class="nc" id="L3971">                rWindStr.newlines = 0;</span>
<span class="nc" id="L3972">                Report rWeather = new Report(1031, Report.PUBLIC);</span>
<span class="nc" id="L3973">                rWeather.add(game.getPlanetaryConditions().getWeatherDisplayableName());</span>
<span class="nc" id="L3974">                rWeather.newlines = 0;</span>
<span class="nc" id="L3975">                Report rLight = new Report(1032, Report.PUBLIC);</span>
<span class="nc" id="L3976">                rLight.add(game.getPlanetaryConditions().getLightDisplayableName());</span>
<span class="nc" id="L3977">                Report rVis = new Report(1033, Report.PUBLIC);</span>
<span class="nc" id="L3978">                rVis.add(game.getPlanetaryConditions().getFogDisplayableName());</span>
<span class="nc" id="L3979">                addReport(rWindDir);</span>
<span class="nc" id="L3980">                addReport(rWindStr);</span>
<span class="nc" id="L3981">                addReport(rWeather);</span>
<span class="nc" id="L3982">                addReport(rLight);</span>
<span class="nc" id="L3983">                addReport(rVis);</span>
            }

<span class="nc bnc" id="L3986" title="All 2 branches missed.">            if (deployment) {</span>
<span class="nc" id="L3987">                addNewLines();</span>
            }
        }
<span class="nc" id="L3990">    }</span>

    private void applyDropShipLandingDamage(Coords centralPos, Entity killer) {
        // first cycle through hexes to figure out final elevation
<span class="nc" id="L3994">        IHex centralHex = game.getBoard().getHex(centralPos);</span>
<span class="nc bnc" id="L3995" title="All 2 branches missed.">        if (null == centralHex) {</span>
            // shouldn't happen
<span class="nc" id="L3997">            return;</span>
        }
<span class="nc" id="L3999">        int finalElev = centralHex.getLevel();</span>
<span class="nc bnc" id="L4000" title="All 2 branches missed.">        if (!centralHex.containsTerrain(Terrains.PAVEMENT)</span>
<span class="nc bnc" id="L4001" title="All 2 branches missed.">            &amp;&amp; !centralHex.containsTerrain(Terrains.ROAD)) {</span>
<span class="nc" id="L4002">            finalElev--;</span>
        }
<span class="nc" id="L4004">        Vector&lt;Coords&gt; positions = new Vector&lt;&gt;();</span>
<span class="nc" id="L4005">        positions.add(centralPos);</span>
<span class="nc bnc" id="L4006" title="All 2 branches missed.">        for (int i = 0; i &lt; 6; i++) {</span>
<span class="nc" id="L4007">            Coords pos = centralPos.translated(i);</span>
<span class="nc" id="L4008">            IHex hex = game.getBoard().getHex(pos);</span>
<span class="nc bnc" id="L4009" title="All 2 branches missed.">            if (null == hex) {</span>
<span class="nc" id="L4010">                continue;</span>
            }
<span class="nc bnc" id="L4012" title="All 2 branches missed.">            if (hex.getLevel() &lt; finalElev) {</span>
<span class="nc" id="L4013">                finalElev = hex.getLevel();</span>
            }
<span class="nc" id="L4015">            positions.add(pos);</span>
        }
        // ok now cycle through hexes and make all changes
<span class="nc bnc" id="L4018" title="All 2 branches missed.">        for (Coords pos : positions) {</span>
<span class="nc" id="L4019">            IHex hex = game.getBoard().getHex(pos);</span>
<span class="nc" id="L4020">            hex.setLevel(finalElev);</span>
            // get rid of woods and replace with rough
<span class="nc bnc" id="L4022" title="All 4 branches missed.">            if (hex.containsTerrain(Terrains.WOODS) || hex.containsTerrain(Terrains.JUNGLE)) {</span>
<span class="nc" id="L4023">                hex.removeTerrain(Terrains.WOODS);</span>
<span class="nc" id="L4024">                hex.removeTerrain(Terrains.JUNGLE);</span>
<span class="nc" id="L4025">                hex.removeTerrain(Terrains.FOLIAGE_ELEV);</span>
<span class="nc" id="L4026">                hex.addTerrain(Terrains.getTerrainFactory().createTerrain(Terrains.ROUGH, 1));</span>
            }
<span class="nc" id="L4028">            sendChangedHex(pos);</span>
<span class="nc" id="L4029">        }</span>

<span class="nc" id="L4031">        applyDropShipProximityDamage(centralPos, killer);</span>
<span class="nc" id="L4032">    }</span>

    private void applyDropShipProximityDamage(Coords centralPos, Entity killer) {
<span class="nc" id="L4035">        applyDropShipProximityDamage(centralPos, false, 0, killer);</span>
<span class="nc" id="L4036">    }</span>

    /**
     * apply damage to units and buildings within a certain radius of a landing
     * or lifting off DropShip
     *
     * @param centralPos - the Coords for the central position of the DropShip
     */
    private void applyDropShipProximityDamage(Coords centralPos, boolean rearArc, int facing,
                                              Entity killer) {

<span class="nc" id="L4047">        Vector&lt;Integer&gt; alreadyHit = new Vector&lt;&gt;();</span>

        // anything in the central hex or adjacent hexes is destroyed
<span class="nc" id="L4050">        Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap = game.getPositionMap();</span>
<span class="nc bnc" id="L4051" title="All 2 branches missed.">        for (Entity en : game.getEntitiesVector(centralPos)) {</span>
<span class="nc bnc" id="L4052" title="All 2 branches missed.">            if (!en.isAirborne()) {</span>
<span class="nc" id="L4053">                addReport(destroyEntity(en, &quot;DropShip proximity damage&quot;, false,</span>
                                        false));
<span class="nc" id="L4055">                alreadyHit.add(en.getId());</span>
            }
<span class="nc" id="L4057">        }</span>
<span class="nc" id="L4058">        Building bldg = game.getBoard().getBuildingAt(centralPos);</span>
<span class="nc bnc" id="L4059" title="All 2 branches missed.">        if (null != bldg) {</span>
<span class="nc" id="L4060">            collapseBuilding(bldg, positionMap, centralPos, vPhaseReport);</span>
        }
<span class="nc bnc" id="L4062" title="All 2 branches missed.">        for (int i = 0; i &lt; 6; i++) {</span>
<span class="nc" id="L4063">            Coords pos = centralPos.translated(i);</span>
<span class="nc bnc" id="L4064" title="All 2 branches missed.">            for (Entity en : game.getEntitiesVector(pos)) {</span>
<span class="nc bnc" id="L4065" title="All 2 branches missed.">                if (!en.isAirborne()) {</span>
<span class="nc" id="L4066">                    addReport(destroyEntity(en, &quot;DropShip proximity damage&quot;,</span>
                                            false, false));
                }
<span class="nc" id="L4069">                alreadyHit.add(en.getId());</span>
<span class="nc" id="L4070">            }</span>
<span class="nc" id="L4071">            bldg = game.getBoard().getBuildingAt(pos);</span>
<span class="nc bnc" id="L4072" title="All 2 branches missed.">            if (null != bldg) {</span>
<span class="nc" id="L4073">                collapseBuilding(bldg, positionMap, pos, vPhaseReport);</span>
            }
        }

        // Report r;
        // ok now I need to look at the damage rings - start at 2 and go to 7
<span class="nc bnc" id="L4079" title="All 2 branches missed.">        for (int i = 2; i &lt; 8; i++) {</span>
<span class="nc" id="L4080">            int damageDice = (8 - i) * 2;</span>
<span class="nc" id="L4081">            List&lt;Coords&gt; ring = centralPos.allAtDistance(i);</span>
<span class="nc bnc" id="L4082" title="All 2 branches missed.">            for (Coords pos : ring) {</span>
<span class="nc bnc" id="L4083" title="All 4 branches missed.">                if (rearArc &amp;&amp; !Compute.isInArc(centralPos, facing, pos, Compute.ARC_AFT)) {</span>
<span class="nc" id="L4084">                    continue;</span>
                }

<span class="nc" id="L4087">                alreadyHit = artilleryDamageHex(pos, centralPos, damageDice, null, killer.getId(),</span>
                        killer, null, false, 0, vPhaseReport, false,
                        alreadyHit, true);
<span class="nc" id="L4090">            }</span>
        }
<span class="nc" id="L4092">        destroyDoomedEntities(alreadyHit);</span>
<span class="nc" id="L4093">    }</span>

    /**
     * Marks ineligible entities as not ready for this phase
     */
    private void setIneligible(IGame.Phase phase) {
<span class="nc" id="L4099">        Vector&lt;Entity&gt; assistants = new Vector&lt;&gt;();</span>
<span class="nc" id="L4100">        boolean assistable = false;</span>

<span class="nc bnc" id="L4102" title="All 2 branches missed.">        if (isPlayerForcedVictory()) {</span>
<span class="nc" id="L4103">            assistants.addAll(game.getEntitiesVector());</span>
        } else {
<span class="nc bnc" id="L4105" title="All 2 branches missed.">            for (Entity entity : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L4106" title="All 2 branches missed.">                if (entity.isEligibleFor(phase)) {</span>
<span class="nc" id="L4107">                    assistable = true;</span>
                } else {
<span class="nc" id="L4109">                    assistants.addElement(entity);</span>
                }
<span class="nc" id="L4111">            }</span>
        }
<span class="nc bnc" id="L4113" title="All 2 branches missed.">        for (Entity assistant : assistants) {</span>
<span class="nc bnc" id="L4114" title="All 4 branches missed.">            if (!assistable || !assistant.canAssist(phase)) {</span>
<span class="nc" id="L4115">                assistant.setDone(true);</span>
            }
<span class="nc" id="L4117">        }</span>
<span class="nc" id="L4118">    }</span>

    /**
     * Have the loader load the indicated unit. The unit being loaded loses its
     * turn.
     *
     * @param loader - the &lt;code&gt;Entity&lt;/code&gt; that is loading the unit.
     * @param unit   - the &lt;code&gt;Entity&lt;/code&gt; being loaded.
     */
    private void loadUnit(Entity loader, Entity unit, int bayNumber) {
        // ProtoMechs share a single turn for a Point. When loading one we don't remove its turn
        // unless it's the last unit in the Point to act.
<span class="nc" id="L4130">        int remainingProtos = 0;</span>
<span class="nc bnc" id="L4131" title="All 2 branches missed.">        if (unit.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</span>
<span class="nc bnc" id="L4132" title="All 2 branches missed.">            remainingProtos = game.getSelectedEntityCount(en -&gt; en.hasETypeFlag(Entity.ETYPE_PROTOMECH)</span>
<span class="nc bnc" id="L4133" title="All 2 branches missed.">                    &amp;&amp; en.getId() != unit.getId()</span>
<span class="nc bnc" id="L4134" title="All 2 branches missed.">                    &amp;&amp; en.isSelectableThisTurn()</span>
<span class="nc bnc" id="L4135" title="All 2 branches missed.">                    &amp;&amp; en.getOwnerId() == unit.getOwnerId()</span>
<span class="nc bnc" id="L4136" title="All 2 branches missed.">                    &amp;&amp; en.getUnitNumber() == unit.getUnitNumber());</span>
        }

<span class="nc bnc" id="L4139" title="All 6 branches missed.">        if ((game.getPhase() != IGame.Phase.PHASE_LOUNGE) &amp;&amp; !unit.isDone()</span>
                &amp;&amp; (remainingProtos == 0)) {
            // Remove the *last* friendly turn (removing the *first* penalizes
            // the opponent too much, and re-calculating moves is too hard).
<span class="nc" id="L4143">            game.removeTurnFor(unit);</span>
<span class="nc" id="L4144">            send(createTurnVectorPacket());</span>
        }

        // When loading an Aero into a squadron in the lounge, make sure the
        // loaded aero has the same bomb loadout as the squadron
        // We want to do this before the fighter is loaded: when the fighter
        // is loaded into the squadron, the squadrons bombing attacks are
        // adjusted based on the bomb-loadout on the fighter.
<span class="nc bnc" id="L4152" title="All 4 branches missed.">        if ((game.getPhase() == Phase.PHASE_LOUNGE)</span>
            &amp;&amp; (loader instanceof FighterSquadron)) {
<span class="nc" id="L4154">            ((IBomber) unit).setBombChoices(((FighterSquadron) loader)</span>
<span class="nc" id="L4155">                                                 .getBombChoices());</span>
        }

        // Load the unit. Do not check for elevation during deployment
<span class="nc bnc" id="L4159" title="All 2 branches missed.">        boolean checkElevation = (game.getPhase() != Phase.PHASE_DEPLOYMENT)</span>
<span class="nc bnc" id="L4160" title="All 2 branches missed.">                                 &amp;&amp; (game.getPhase() != Phase.PHASE_LOUNGE);</span>
<span class="nc bnc" id="L4161" title="All 2 branches missed.">        if (bayNumber == -1) {</span>
<span class="nc" id="L4162">            loader.load(unit, checkElevation);</span>
        } else {
<span class="nc" id="L4164">            loader.load(unit, checkElevation, bayNumber);</span>
        }

        // The loaded unit is being carried by the loader.
<span class="nc" id="L4168">        unit.setTransportId(loader.getId());</span>

        // Remove the loaded unit from the screen.
<span class="nc" id="L4171">        unit.setPosition(null);</span>

        // set deployment round of the loadee to equal that of the loader
<span class="nc" id="L4174">        unit.setDeployRound(loader.getDeployRound());</span>
        
        //Update the loading unit's passenger count, if it's a large craft
<span class="nc bnc" id="L4177" title="All 4 branches missed.">        if (loader instanceof SmallCraft || loader instanceof Jumpship) {</span>
            //Don't add dropship crew to a jumpship or station's passenger list
<span class="nc bnc" id="L4179" title="All 2 branches missed.">            if (!unit.isLargeCraft()) {</span>
<span class="nc" id="L4180">                loader.setNPassenger(loader.getNPassenger() + unit.getCrew().getSize());</span>
            }
        }

        // Update the loaded unit.
<span class="nc" id="L4185">        entityUpdate(unit.getId());</span>

        // Taharqa (2/28/13): I am not sure why the loader is not getting
        // updated too - not updating it
        // is causing problem in the chat lounge loading, so I am going to do it
        // here, but if we get
        // weird results for other loading, then the reason is probably this
<span class="nc" id="L4192">        entityUpdate(loader.getId());</span>
<span class="nc" id="L4193">    }</span>

    /**
     * Have the loader tow the indicated unit. The unit being towed loses its
     * turn.
     *
     * @param loader - the &lt;code&gt;Entity&lt;/code&gt; that is towing the unit.
     * @param unit   - the &lt;code&gt;Entity&lt;/code&gt; being towed.
     */
    private void towUnit(Entity loader, Entity unit) {
<span class="nc bnc" id="L4203" title="All 4 branches missed.">        if ((game.getPhase() != IGame.Phase.PHASE_LOUNGE) &amp;&amp; !unit.isDone()) {</span>
            // Remove the *last* friendly turn (removing the *first* penalizes
            // the opponent too much, and re-calculating moves is too hard).
<span class="nc" id="L4206">            game.removeTurnFor(unit);</span>
<span class="nc" id="L4207">            send(createTurnVectorPacket());</span>
        }

<span class="nc" id="L4210">        loader.towUnit(unit.getId());</span>

        // set deployment round of the loadee to equal that of the loader
<span class="nc" id="L4213">        unit.setDeployRound(loader.getDeployRound());</span>

        // Update the loader and towed units.
<span class="nc" id="L4216">        entityUpdate(unit.getId());</span>
<span class="nc" id="L4217">        entityUpdate(loader.getId());</span>
<span class="nc" id="L4218">    }</span>

    /**
     * Have the tractor drop the indicated trailer. This will also disconnect all
     * trailers that follow the one dropped.
     *
     * @param tractor
     *            - the &lt;code&gt;Entity&lt;/code&gt; that is disconnecting the trailer.
     * @param unloaded
     *            - the &lt;code&gt;Targetable&lt;/code&gt; unit being unloaded.
     * @param pos
     *            - the &lt;code&gt;Coords&lt;/code&gt; for the unloaded unit.
     * @return &lt;code&gt;true&lt;/code&gt; if the unit was successfully unloaded,
     *         &lt;code&gt;false&lt;/code&gt; if the trailer isn't carried by tractor.
     */
    private boolean disconnectUnit(Entity tractor, Targetable unloaded, Coords pos) {

        // We can only unload Entities.
        Entity trailer;
<span class="nc bnc" id="L4237" title="All 2 branches missed.">        if (unloaded instanceof Entity) {</span>
<span class="nc" id="L4238">            trailer = (Entity) unloaded;</span>
        } else {
<span class="nc" id="L4240">            return false;</span>
        }
        // disconnectUnit() updates anything behind 'trailer' too, so copy
        // the list of trailers before we alter it so entityUpdate() can be
        // run on all of them. Also, add the entity towing Trailer to the list
<span class="nc" id="L4245">        List&lt;Integer&gt; trailerList = new ArrayList&lt;&gt;(trailer.getConnectedUnits());</span>
<span class="nc" id="L4246">        trailerList.add(trailer.getTowedBy());</span>

        // Unload the unit.
<span class="nc" id="L4249">        tractor.disconnectUnit(trailer.getId());</span>

        // Update the tractor and all affected trailers.
<span class="nc bnc" id="L4252" title="All 2 branches missed.">        for (int id : trailerList) {</span>
<span class="nc" id="L4253">            entityUpdate(id);</span>
<span class="nc" id="L4254">        }</span>
<span class="nc" id="L4255">        entityUpdate(trailer.getId());</span>
<span class="nc" id="L4256">        entityUpdate(tractor.getId());</span>

        // Unloaded successfully.
<span class="nc" id="L4259">        return true;</span>
    }

    private boolean unloadUnit(Entity unloader, Targetable unloaded,
                               Coords pos, int facing, int elevation) {
<span class="nc" id="L4264">        return unloadUnit(unloader, unloaded, pos, facing, elevation, false,</span>
                false);
    }

    /**
     * Have the unloader unload the indicated unit. The unit being unloaded may
     * or may not gain a turn
     *
     * @param unloader
     *            - the &lt;code&gt;Entity&lt;/code&gt; that is unloading the unit.
     * @param unloaded
     *            - the &lt;code&gt;Targetable&lt;/code&gt; unit being unloaded.
     * @param pos
     *            - the &lt;code&gt;Coords&lt;/code&gt; for the unloaded unit.
     * @param facing
     *            - the &lt;code&gt;int&lt;/code&gt; facing for the unloaded unit.
     * @param elevation
     *            - the &lt;code&gt;int&lt;/code&gt; elevation at which to unload, if both
     *            loader and loaded units use VTOL movement.
     * @param evacuation
     *            - a &lt;code&gt;boolean&lt;/code&gt; indicating whether this unit is being
     *            unloaded as a result of its carrying units destruction
     * @return &lt;code&gt;true&lt;/code&gt; if the unit was successfully unloaded,
     *         &lt;code&gt;false&lt;/code&gt; if the unit isn't carried in unloader.
     */
    private boolean unloadUnit(Entity unloader, Targetable unloaded,
            Coords pos, int facing, int elevation, boolean evacuation,
            boolean duringDeployment) {

        // We can only unload Entities.
        Entity unit;
<span class="nc bnc" id="L4295" title="All 2 branches missed.">        if (unloaded instanceof Entity) {</span>
<span class="nc" id="L4296">            unit = (Entity) unloaded;</span>
        } else {
<span class="nc" id="L4298">            return false;</span>
        }

        // Unload the unit.
<span class="nc bnc" id="L4302" title="All 2 branches missed.">        if (!unloader.unload(unit)) {</span>
<span class="nc" id="L4303">            return false;</span>
        }

        // The unloaded unit is no longer being carried.
<span class="nc" id="L4307">        unit.setTransportId(Entity.NONE);</span>

        // Place the unloaded unit onto the screen.
<span class="nc" id="L4310">        unit.setPosition(pos);</span>

        // Units unloaded onto the screen are deployed.
<span class="nc bnc" id="L4313" title="All 2 branches missed.">        if (pos != null) {</span>
<span class="nc" id="L4314">            unit.setDeployed(true);</span>
        }

        // Point the unloaded unit in the given direction.
<span class="nc" id="L4318">        unit.setFacing(facing);</span>
<span class="nc" id="L4319">        unit.setSecondaryFacing(facing);</span>

<span class="nc" id="L4321">        IHex hex = game.getBoard().getHex(pos);</span>
<span class="nc bnc" id="L4322" title="All 2 branches missed.">        boolean isBridge = (hex != null)</span>
<span class="nc bnc" id="L4323" title="All 2 branches missed.">                &amp;&amp; hex.containsTerrain(Terrains.PAVEMENT);</span>

<span class="nc bnc" id="L4325" title="All 2 branches missed.">        if (hex == null) {</span>
<span class="nc" id="L4326">            unit.setElevation(elevation);</span>
<span class="nc bnc" id="L4327" title="All 2 branches missed.">        } else if (unloader.getMovementMode() == EntityMovementMode.VTOL) {</span>
<span class="nc bnc" id="L4328" title="All 2 branches missed.">            if (unit.getMovementMode() == EntityMovementMode.VTOL) {</span>
                // Flying units unload to the same elevation as the flying
                // transport
<span class="nc" id="L4331">                unit.setElevation(elevation);</span>
<span class="nc bnc" id="L4332" title="All 2 branches missed.">            } else if (game.getBoard().getBuildingAt(pos) != null) {</span>
                // non-flying unit unloaded from a flying onto a building
                // -&gt; sit on the roof
<span class="nc" id="L4335">                unit.setElevation(hex.terrainLevel(Terrains.BLDG_ELEV));</span>
            } else {
<span class="nc bnc" id="L4337" title="All 2 branches missed.">                while (elevation &gt;= -hex.depth()) {</span>
<span class="nc bnc" id="L4338" title="All 2 branches missed.">                    if (unit.isElevationValid(elevation, hex)) {</span>
<span class="nc" id="L4339">                        unit.setElevation(elevation);</span>
<span class="nc" id="L4340">                        break;</span>
                    }
<span class="nc" id="L4342">                    elevation--;</span>
                    // If unit is landed, the while loop breaks before here
                    // And unit.moved will be MOVE_NONE
                    // If we can jump, use jump
<span class="nc bnc" id="L4346" title="All 2 branches missed.">                    if (unit.getJumpMP() &gt; 0) {</span>
<span class="nc" id="L4347">                        unit.moved = EntityMovementType.MOVE_JUMP;</span>
                    } else { // Otherwise, use walk trigger check for ziplines
<span class="nc" id="L4349">                        unit.moved = EntityMovementType.MOVE_WALK;</span>
                    }
                }
<span class="nc bnc" id="L4352" title="All 2 branches missed.">                if (!unit.isElevationValid(elevation, hex)) {</span>
<span class="nc" id="L4353">                    return false;</span>
                }
            }
<span class="nc bnc" id="L4356" title="All 2 branches missed.">        } else if (game.getBoard().getBuildingAt(pos) != null) {</span>
            // non flying unit unloading units into a building
            // -&gt; sit in the building at the same elevation
<span class="nc" id="L4359">            unit.setElevation(elevation);</span>
<span class="nc bnc" id="L4360" title="All 2 branches missed.">        } else if (hex.terrainLevel(Terrains.WATER) &gt; 0) {</span>
<span class="nc bnc" id="L4361" title="All 2 branches missed.">            if ((unit.getMovementMode() == EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L4362" title="All 2 branches missed.">                || (unit.getMovementMode() == EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L4363" title="All 2 branches missed.">                || (unit.getMovementMode() == EntityMovementMode.HYDROFOIL)</span>
<span class="nc bnc" id="L4364" title="All 2 branches missed.">                || (unit.getMovementMode() == EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L4365" title="All 2 branches missed.">                || (unit.getMovementMode() == EntityMovementMode.SUBMARINE)</span>
<span class="nc bnc" id="L4366" title="All 2 branches missed.">                || (unit.getMovementMode() == EntityMovementMode.INF_UMU)</span>
<span class="nc bnc" id="L4367" title="All 4 branches missed.">                || hex.containsTerrain(Terrains.ICE) || isBridge) {</span>
                // units that can float stay on the surface, or we go on the
                // bridge
                // this means elevation 0, because elevation is relative to the
                // surface
<span class="nc" id="L4372">                unit.setElevation(0);</span>
            }
        } else {
            // default to the floor of the hex.
            // unit elevation is relative to the surface
<span class="nc" id="L4377">            unit.setElevation(hex.floor() - hex.surface());</span>
        }

        // Check for zip lines PSR -- MOVE_WALK implies ziplines
<span class="nc bnc" id="L4381" title="All 2 branches missed.">        if (unit.moved == EntityMovementType.MOVE_WALK) {</span>
<span class="nc bnc" id="L4382" title="All 4 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_ZIPLINES)</span>
                    &amp;&amp; (unit instanceof Infantry)
<span class="nc bnc" id="L4384" title="All 2 branches missed.">                    &amp;&amp; !((Infantry) unit).isMechanized()) {</span>

               // Handle zip lines
<span class="nc" id="L4387">                PilotingRollData psr = getEjectModifiers(game, unit, 0, false,</span>
<span class="nc" id="L4388">                        unit.getPosition(), &quot;Anti-mek skill&quot;);</span>
                // Factor in Elevation
<span class="nc bnc" id="L4390" title="All 2 branches missed.">                if (unloader.getElevation() &gt; 0) {</span>
<span class="nc" id="L4391">                    psr.addModifier(unloader.getElevation(), &quot;elevation&quot;);</span>
                }
<span class="nc" id="L4393">                int roll = Compute.d6(2);</span>

                // Report ziplining
<span class="nc" id="L4396">                Report r = new Report(9920);</span>
<span class="nc" id="L4397">                r.subject = unit.getId();</span>
<span class="nc" id="L4398">                r.addDesc(unit);</span>
<span class="nc" id="L4399">                r.newlines = 0;</span>
<span class="nc" id="L4400">                addReport(r);</span>

                // Report TN
<span class="nc" id="L4403">                r = new Report(9921);</span>
<span class="nc" id="L4404">                r.subject = unit.getId();</span>
<span class="nc" id="L4405">                r.add(psr.getValue());</span>
<span class="nc" id="L4406">                r.add(psr.getDesc());</span>
<span class="nc" id="L4407">                r.add(roll);</span>
<span class="nc" id="L4408">                r.newlines = 0;</span>
<span class="nc" id="L4409">                addReport(r);</span>

<span class="nc bnc" id="L4411" title="All 2 branches missed.">                if (roll &lt; psr.getValue()) { // Failure!</span>
<span class="nc" id="L4412">                    r = new Report(9923);</span>
<span class="nc" id="L4413">                    r.subject = unit.getId();</span>
<span class="nc" id="L4414">                    r.add(psr.getValue());</span>
<span class="nc" id="L4415">                    r.add(roll);</span>
<span class="nc" id="L4416">                    addReport(r);</span>

<span class="nc" id="L4418">                    HitData hit = unit.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L4419">                    hit.setIgnoreInfantryDoubleDamage(true);</span>
<span class="nc" id="L4420">                    addReport(damageEntity(unit, hit, 5));</span>
<span class="nc" id="L4421">                } else { //  Report success</span>
<span class="nc" id="L4422">                    r = new Report(9922);</span>
<span class="nc" id="L4423">                    r.subject = unit.getId();</span>
<span class="nc" id="L4424">                    r.add(psr.getValue());</span>
<span class="nc" id="L4425">                    r.add(roll);</span>
<span class="nc" id="L4426">                    addReport(r);</span>
                }
<span class="nc" id="L4428">                addNewLines();</span>
<span class="nc" id="L4429">            } else {</span>
<span class="nc" id="L4430">                return false;</span>
            }
        }

<span class="nc" id="L4434">        addReport(doSetLocationsExposure(unit, hex, false, unit.getElevation()));</span>

        // unlike other unloaders, entities unloaded from droppers can still
        // move (unless infantry)
<span class="nc bnc" id="L4438" title="All 6 branches missed.">        if (!evacuation &amp;&amp; (unloader instanceof SmallCraft)</span>
            &amp;&amp; !(unit instanceof Infantry)) {
<span class="nc" id="L4440">            unit.setUnloaded(false);</span>
<span class="nc" id="L4441">            unit.setDone(false);</span>

            // unit uses half of walk mp and is treated as moving one hex
<span class="nc" id="L4444">            unit.mpUsed = unit.getOriginalWalkMP() / 2;</span>
<span class="nc" id="L4445">            unit.delta_distance = 1;</span>
        }

        // If we unloaded during deployment, allow a turn
<span class="nc bnc" id="L4449" title="All 2 branches missed.">        if (duringDeployment) {</span>
<span class="nc" id="L4450">            unit.setUnloaded(false);</span>
<span class="nc" id="L4451">            unit.setDone(false);</span>
        }
        
        //Update the transport unit's passenger count, if it's a large craft
<span class="nc bnc" id="L4455" title="All 4 branches missed.">        if (unloader instanceof SmallCraft || unloader instanceof Jumpship) {</span>
            //Don't add dropship crew to a jumpship or station's passenger list
<span class="nc bnc" id="L4457" title="All 2 branches missed.">            if (!unit.isLargeCraft()) {</span>
<span class="nc" id="L4458">                unloader.setNPassenger(Math.max(0, unloader.getNPassenger() - unit.getCrew().getSize()));</span>
            }
        }

        // Update the unloaded unit.
<span class="nc" id="L4463">        entityUpdate(unit.getId());</span>

        // Unloaded successfully.
<span class="nc" id="L4466">        return true;</span>
    }

    /**
     * Do a piloting skill check to attempt landing
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that is landing
     * @param roll   The &lt;code&gt;PilotingRollData&lt;/code&gt; to be used for this landing.
     */
    private void attemptLanding(Entity entity, PilotingRollData roll) {
<span class="nc bnc" id="L4476" title="All 2 branches missed.">        if (roll.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L4477">            return;</span>
        }

        // okay, print the info
<span class="nc" id="L4481">        Report r = new Report(9605);</span>
<span class="nc" id="L4482">        r.subject = entity.getId();</span>
<span class="nc" id="L4483">        r.addDesc(entity);</span>
<span class="nc" id="L4484">        r.add(roll.getLastPlainDesc(), true);</span>
<span class="nc" id="L4485">        addReport(r);</span>

        // roll
<span class="nc" id="L4488">        final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L4489">        r = new Report(9606);</span>
<span class="nc" id="L4490">        r.subject = entity.getId();</span>
<span class="nc" id="L4491">        r.add(roll.getValueAsString());</span>
<span class="nc" id="L4492">        r.add(roll.getDesc());</span>
<span class="nc" id="L4493">        r.add(diceRoll);</span>
        // boolean suc;
<span class="nc bnc" id="L4495" title="All 2 branches missed.">        if (diceRoll &lt; roll.getValue()) {</span>
<span class="nc" id="L4496">            r.choose(false);</span>
<span class="nc" id="L4497">            addReport(r);</span>
<span class="nc" id="L4498">            int mof = roll.getValue() - diceRoll;</span>
<span class="nc" id="L4499">            int damage = 10 * (mof);</span>
            // Report damage taken
<span class="nc" id="L4501">            r = new Report(9609);</span>
<span class="nc" id="L4502">            r.indent();</span>
<span class="nc" id="L4503">            r.addDesc(entity);</span>
<span class="nc" id="L4504">            r.add(damage);</span>
<span class="nc" id="L4505">            r.add(mof);</span>
<span class="nc" id="L4506">            addReport(r);</span>

<span class="nc" id="L4508">            int side = ToHitData.SIDE_FRONT;</span>
<span class="nc bnc" id="L4509" title="All 4 branches missed.">            if ((entity instanceof Aero) &amp;&amp; ((Aero) entity).isSpheroid()) {</span>
<span class="nc" id="L4510">                side = ToHitData.SIDE_REAR;</span>
            }
<span class="nc bnc" id="L4512" title="All 2 branches missed.">            while (damage &gt; 0) {</span>
<span class="nc" id="L4513">                HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, side);</span>
<span class="nc" id="L4514">                addReport(damageEntity(entity, hit, 10));</span>
<span class="nc" id="L4515">                damage -= 10;</span>
<span class="nc" id="L4516">            }</span>
            // suc = false;
<span class="nc" id="L4518">        } else {</span>
<span class="nc" id="L4519">            r.choose(true);</span>
<span class="nc" id="L4520">            addReport(r);</span>
            // suc = true;
        }
<span class="nc" id="L4523">    }</span>

    private boolean launchUnit(Entity unloader, Targetable unloaded,
                               Coords pos, int facing, int velocity, int altitude, int[] moveVec,
                               int bonus) {

        Entity unit;
<span class="nc bnc" id="L4530" title="All 4 branches missed.">        if (unloaded instanceof Entity &amp;&amp; unloader instanceof Aero) {</span>
<span class="nc" id="L4531">            unit = (Entity) unloaded;</span>
        } else {
<span class="nc" id="L4533">            return false;</span>
        }

        // must be an ASF, Small Craft, or DropShip
<span class="nc bnc" id="L4537" title="All 4 branches missed.">        if (!unit.isAero() || unit instanceof Jumpship) {</span>
<span class="nc" id="L4538">            return false;</span>
        }
<span class="nc" id="L4540">        IAero a = (IAero) unit;</span>

        Report r;

        // Unload the unit.
<span class="nc bnc" id="L4545" title="All 2 branches missed.">        if (!unloader.unload(unit)) {</span>
<span class="nc" id="L4546">            return false;</span>
        }

        // The unloaded unit is no longer being carried.
<span class="nc" id="L4550">        unit.setTransportId(Entity.NONE);</span>

        // pg. 86 of TW: launched fighters can move in fire in the turn they are
        // unloaded
<span class="nc" id="L4554">        unit.setUnloaded(false);</span>

        // Place the unloaded unit onto the screen.
<span class="nc" id="L4557">        unit.setPosition(pos);</span>

        // Units unloaded onto the screen are deployed.
<span class="nc bnc" id="L4560" title="All 2 branches missed.">        if (pos != null) {</span>
<span class="nc" id="L4561">            unit.setDeployed(true);</span>
        }

        // Point the unloaded unit in the given direction.
<span class="nc" id="L4565">        unit.setFacing(facing);</span>
<span class="nc" id="L4566">        unit.setSecondaryFacing(facing);</span>

        // the velocity of the unloaded unit is the same as the loader
<span class="nc" id="L4569">        a.setCurrentVelocity(velocity);</span>
<span class="nc" id="L4570">        a.setNextVelocity(velocity);</span>

        // if using advanced movement then set vectors
<span class="nc" id="L4573">        unit.setVectors(moveVec);</span>

<span class="nc" id="L4575">        unit.setAltitude(altitude);</span>

        // it seems that the done button is still being set and I can't figure
        // out where
<span class="nc" id="L4579">        unit.setDone(false);</span>

        // if the bonus was greater than zero then too many fighters were
        // launched and they
        // must all make control rolls
<span class="nc bnc" id="L4584" title="All 2 branches missed.">        if (bonus &gt; 0) {</span>
<span class="nc" id="L4585">            PilotingRollData psr = unit.getBasePilotingRoll();</span>
<span class="nc" id="L4586">            psr.addModifier(bonus, &quot;safe launch rate exceeded&quot;);</span>
<span class="nc" id="L4587">            int ctrlroll = Compute.d6(2);</span>
<span class="nc" id="L4588">            r = new Report(9375);</span>
<span class="nc" id="L4589">            r.subject = unit.getId();</span>
<span class="nc" id="L4590">            r.add(unit.getDisplayName());</span>
<span class="nc" id="L4591">            r.add(psr.getValue());</span>
<span class="nc" id="L4592">            r.add(ctrlroll);</span>
<span class="nc" id="L4593">            r.indent(1);</span>
<span class="nc bnc" id="L4594" title="All 2 branches missed.">            if (ctrlroll &lt; psr.getValue()) {</span>
<span class="nc" id="L4595">                r.choose(false);</span>
<span class="nc" id="L4596">                addReport(r);</span>
                // damage the unit
<span class="nc" id="L4598">                int damage = 10 * (psr.getValue() - ctrlroll);</span>
<span class="nc" id="L4599">                HitData hit = unit.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L4600">                Vector&lt;Report&gt; rep = damageEntity(unit, hit, damage);</span>
<span class="nc" id="L4601">                Report.indentAll(rep, 1);</span>
<span class="nc" id="L4602">                rep.lastElement().newlines++;</span>
<span class="nc" id="L4603">                addReport(rep);</span>
                // did we destroy the unit?
<span class="nc bnc" id="L4605" title="All 2 branches missed.">                if (unit.isDoomed()) {</span>
                    // Clean out the entity.
<span class="nc" id="L4607">                    unit.setDestroyed(true);</span>
<span class="nc" id="L4608">                    game.moveToGraveyard(unit.getId());</span>
<span class="nc" id="L4609">                    send(createRemoveEntityPacket(unit.getId()));</span>
                }
<span class="nc" id="L4611">            } else {</span>
                // avoided damage
<span class="nc" id="L4613">                r.choose(true);</span>
<span class="nc" id="L4614">                r.newlines++;</span>
<span class="nc" id="L4615">                addReport(r);</span>
            }
<span class="nc" id="L4617">        } else {</span>
<span class="nc" id="L4618">            r = new Report(9374);</span>
<span class="nc" id="L4619">            r.subject = unit.getId();</span>
<span class="nc" id="L4620">            r.add(unit.getDisplayName());</span>
<span class="nc" id="L4621">            r.indent(1);</span>
<span class="nc" id="L4622">            r.newlines++;</span>
<span class="nc" id="L4623">            addReport(r);</span>
        }

        // launching from an OOC vessel causes damage
        // same thing if faster than 2 velocity in atmosphere
<span class="nc bnc" id="L4628" title="All 4 branches missed.">        if ((((Aero) unloader).isOutControlTotal() &amp;&amp; !unit.isDoomed())</span>
<span class="nc bnc" id="L4629" title="All 2 branches missed.">            || ((((Aero)unloader).getCurrentVelocity() &gt; 2) &amp;&amp; !game</span>
<span class="nc bnc" id="L4630" title="All 2 branches missed.">                .getBoard().inSpace())) {</span>
<span class="nc" id="L4631">            int damageRoll = Compute.d6(2);</span>
<span class="nc" id="L4632">            int damage = damageRoll * 10;</span>
<span class="nc" id="L4633">            r = new Report(9385);</span>
<span class="nc" id="L4634">            r.subject = unit.getId();</span>
<span class="nc" id="L4635">            r.add(unit.getDisplayName());</span>
<span class="nc" id="L4636">            r.add(damage);</span>
<span class="nc" id="L4637">            addReport(r);</span>
<span class="nc" id="L4638">            HitData hit = unit.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L4639">            addReport(damageEntity(unit, hit, damage));</span>
            // did we destroy the unit?
<span class="nc bnc" id="L4641" title="All 2 branches missed.">            if (unit.isDoomed()) {</span>
                // Clean out the entity.
<span class="nc" id="L4643">                unit.setDestroyed(true);</span>
<span class="nc" id="L4644">                game.moveToGraveyard(unit.getId());</span>
<span class="nc" id="L4645">                send(createRemoveEntityPacket(unit.getId()));</span>
            }
        }

        // Update the unloaded unit.
<span class="nc" id="L4650">        entityUpdate(unit.getId());</span>

        // Set the turn mask. We need to be specific otherwise we run the risk
        // of having a unit of another class consume the turn and leave the
        // unloaded unit without a turn
        int turnMask;
<span class="nc" id="L4656">        List&lt;GameTurn&gt; turnVector = game.getTurnVector();</span>
<span class="nc bnc" id="L4657" title="All 2 branches missed.">        if (unit instanceof Dropship) {</span>
<span class="nc" id="L4658">            turnMask = GameTurn.CLASS_DROPSHIP;</span>
<span class="nc bnc" id="L4659" title="All 2 branches missed.">        } else if (unit instanceof SmallCraft) {</span>
<span class="nc" id="L4660">            turnMask = GameTurn.CLASS_SMALL_CRAFT;</span>
        } else {
<span class="nc" id="L4662">            turnMask = GameTurn.CLASS_AERO;</span>
        }
        // Add one, otherwise we consider the turn we're currently processing
<span class="nc" id="L4665">        int turnInsertIdx = game.getTurnIndex() + 1;</span>
        // We have to figure out where to insert this turn, to maintain proper
        // space turn order (JumpShips, Small Craft, DropShips, Aeros)
<span class="nc bnc" id="L4668" title="All 2 branches missed.">        for (; turnInsertIdx &lt; turnVector.size(); turnInsertIdx++) {</span>
<span class="nc" id="L4669">            GameTurn turn = turnVector.get(turnInsertIdx);</span>
<span class="nc bnc" id="L4670" title="All 2 branches missed.">            if (turn.isValidEntity(unit, game)) {</span>
<span class="nc" id="L4671">                break;</span>
            }
        }

        // ok add another turn for the unloaded entity so that it can move
<span class="nc" id="L4676">        GameTurn newTurn = new GameTurn.EntityClassTurn(unit.getOwner().getId(), turnMask);</span>
<span class="nc" id="L4677">        game.insertTurnAfter(newTurn, turnInsertIdx);</span>
        // brief everybody on the turn update
<span class="nc" id="L4679">        send(createTurnVectorPacket());</span>

<span class="nc" id="L4681">        return true;</span>
    }

    public void dropUnit(Entity drop, Entity entity, Coords curPos, int altitude) {
        // Unload the unit.
<span class="nc" id="L4686">        entity.unload(drop);</span>
        // The unloaded unit is no longer being carried.
<span class="nc" id="L4688">        drop.setTransportId(Entity.NONE);</span>

        // OK according to Welshman's pending ruling, when on the ground map
        // units should be deployed in the ring two hexes away from the DropShip
        // optimally, we should let people choose here, but that would be
        // complicated
        // so for now I am just going to distribute them. I will give each unit
        // the first
        // emptiest hex that has no water or magma in it.
        // I will start the circle based on the facing of the dropper
        // Spheroid - facing
        // Aerodyne - opposite of facing
        // http://www.classicbattletech.com/forums/index.php?topic=65600.msg1568089#new
<span class="nc bnc" id="L4701" title="All 4 branches missed.">        if (game.getBoard().onGround() &amp;&amp; (null != curPos)) {</span>
<span class="nc" id="L4702">            boolean selected = false;</span>
            int count;
<span class="nc" id="L4704">            int max = 0;</span>
<span class="nc" id="L4705">            int facing = entity.getFacing();</span>
<span class="nc bnc" id="L4706" title="All 2 branches missed.">            if (entity.getMovementMode() == EntityMovementMode.AERODYNE) {</span>
                // no real rule for this but it seems to make sense that units
                // would drop behind an
                // aerodyne rather than in front of it
<span class="nc" id="L4710">                facing = (facing + 3) % 6;</span>
            }
<span class="nc" id="L4712">            boolean checkDanger = true;</span>
<span class="nc bnc" id="L4713" title="All 2 branches missed.">            while (!selected) {</span>
                // we can get caught in an infinite loop if all available hexes
                // are dangerous, so check for this
<span class="nc" id="L4716">                boolean allDanger = true;</span>
<span class="nc bnc" id="L4717" title="All 2 branches missed.">                for (int i = 0; i &lt; 6; i++) {</span>
<span class="nc" id="L4718">                    int dir = (facing + i) % 6;</span>
<span class="nc" id="L4719">                    Coords newPos = curPos.translated(dir, 2);</span>
<span class="nc" id="L4720">                    count = 0;</span>
<span class="nc bnc" id="L4721" title="All 2 branches missed.">                    if (game.getBoard().contains(newPos)) {</span>
<span class="nc" id="L4722">                        IHex newHex = game.getBoard().getHex(newPos);</span>
<span class="nc" id="L4723">                        Building bldg = game.getBoard().getBuildingAt(newPos);</span>
<span class="nc bnc" id="L4724" title="All 2 branches missed.">                        boolean danger = newHex.containsTerrain(Terrains.WATER)</span>
<span class="nc bnc" id="L4725" title="All 4 branches missed.">                                         || newHex.containsTerrain(Terrains.MAGMA)</span>
                                         || (null != bldg);
<span class="nc bnc" id="L4727" title="All 2 branches missed.">                        for (Entity unit : game.getEntitiesVector(newPos)) {</span>
<span class="nc bnc" id="L4728" title="All 2 branches missed.">                            if ((unit.getAltitude() == altitude)</span>
<span class="nc bnc" id="L4729" title="All 2 branches missed.">                                &amp;&amp; !unit.isAero()) {</span>
<span class="nc" id="L4730">                                count++;</span>
                            }
<span class="nc" id="L4732">                        }</span>
<span class="nc bnc" id="L4733" title="All 6 branches missed.">                        if ((count &lt;= max) &amp;&amp; (!danger || !checkDanger)) {</span>
<span class="nc" id="L4734">                            selected = true;</span>
<span class="nc" id="L4735">                            curPos = newPos;</span>
<span class="nc" id="L4736">                            break;</span>
                        }
<span class="nc bnc" id="L4738" title="All 2 branches missed.">                        if (!danger) {</span>
<span class="nc" id="L4739">                            allDanger = false;</span>
                        }
                    }
<span class="nc" id="L4742">                    newPos = newPos.translated((dir + 2) % 6);</span>
<span class="nc" id="L4743">                    count = 0;</span>
<span class="nc bnc" id="L4744" title="All 2 branches missed.">                    if (game.getBoard().contains(newPos)) {</span>
<span class="nc" id="L4745">                        IHex newHex = game.getBoard().getHex(newPos);</span>
<span class="nc" id="L4746">                        Building bldg = game.getBoard().getBuildingAt(newPos);</span>
<span class="nc bnc" id="L4747" title="All 2 branches missed.">                        boolean danger = newHex.containsTerrain(Terrains.WATER)</span>
<span class="nc bnc" id="L4748" title="All 4 branches missed.">                                         || newHex.containsTerrain(Terrains.MAGMA)</span>
                                         || (null != bldg);
<span class="nc bnc" id="L4750" title="All 2 branches missed.">                        for (Entity unit : game.getEntitiesVector(newPos)) {</span>
<span class="nc bnc" id="L4751" title="All 4 branches missed.">                            if ((unit.getAltitude() == altitude) &amp;&amp; !unit.isAero()) {</span>
<span class="nc" id="L4752">                                count++;</span>
                            }
<span class="nc" id="L4754">                        }</span>
<span class="nc bnc" id="L4755" title="All 6 branches missed.">                        if ((count &lt;= max) &amp;&amp; (!danger || !checkDanger)) {</span>
<span class="nc" id="L4756">                            selected = true;</span>
<span class="nc" id="L4757">                            curPos = newPos;</span>
<span class="nc" id="L4758">                            break;</span>
                        }
<span class="nc bnc" id="L4760" title="All 2 branches missed.">                        if (!danger) {</span>
<span class="nc" id="L4761">                            allDanger = false;</span>
                        }
                    }
                }
<span class="nc bnc" id="L4765" title="All 4 branches missed.">                if (allDanger &amp;&amp; checkDanger) {</span>
<span class="nc" id="L4766">                    checkDanger = false;</span>
                } else {
<span class="nc" id="L4768">                    max++;</span>
                }
<span class="nc" id="L4770">            }</span>
        }

        // Place the unloaded unit onto the screen.
<span class="nc" id="L4774">        drop.setPosition(curPos);</span>

        // Units unloaded onto the screen are deployed.
<span class="nc bnc" id="L4777" title="All 2 branches missed.">        if (curPos != null) {</span>
<span class="nc" id="L4778">            drop.setDeployed(true);</span>
        }

        // Point the unloaded unit in the given direction.
<span class="nc" id="L4782">        drop.setFacing(entity.getFacing());</span>
<span class="nc" id="L4783">        drop.setSecondaryFacing(entity.getFacing());</span>

<span class="nc" id="L4785">        drop.setAltitude(altitude);</span>
<span class="nc" id="L4786">        entityUpdate(drop.getId());</span>
<span class="nc" id="L4787">    }</span>

    /**
     * Record that the given building has been affected by the current entity's
     * movement. At the end of the entity's movement, notify the clients about
     * the updates.
     *
     * @param bldg     - the &lt;code&gt;Building&lt;/code&gt; that has been affected.
     * @param collapse - a &lt;code&gt;boolean&lt;/code&gt; value that specifies that the
     *                 building collapsed (when &lt;code&gt;true&lt;/code&gt;).
     */
    private void addAffectedBldg(Building bldg, boolean collapse) {
        // If the building collapsed, then the clients have already
        // been notified, so remove it from the notification list.
<span class="nc bnc" id="L4801" title="All 2 branches missed.">        if (collapse) {</span>
<span class="nc" id="L4802">            affectedBldgs.remove(bldg);</span>
        } else { // Otherwise, make sure that this building is tracked.
<span class="nc" id="L4804">            affectedBldgs.put(bldg, Boolean.FALSE);</span>
        }
<span class="nc" id="L4806">    }</span>

    /**
     * Walk through the building hexes that were affected by the recent entity's
     * movement. Notify the clients about the updates to all affected entities
     * and non-collapsed buildings. The affected hexes is then cleared for the
     * next entity's movement.
     */
    private void applyAffectedBldgs() {
        // Build a list of Building updates.
<span class="nc" id="L4816">        Vector&lt;Building&gt; bldgUpdates = new Vector&lt;&gt;();</span>

        // Only send a single turn update.
<span class="nc" id="L4819">        boolean bTurnsChanged = false;</span>

        // Walk the set of buildings.
<span class="nc" id="L4822">        Enumeration&lt;Building&gt; bldgs = affectedBldgs.keys();</span>
<span class="nc bnc" id="L4823" title="All 2 branches missed.">        while (bldgs.hasMoreElements()) {</span>
<span class="nc" id="L4824">            final Building bldg = bldgs.nextElement();</span>

            // Walk through the building's coordinates.
<span class="nc" id="L4827">            Enumeration&lt;Coords&gt; bldgCoords = bldg.getCoords();</span>
<span class="nc bnc" id="L4828" title="All 2 branches missed.">            while (bldgCoords.hasMoreElements()) {</span>
<span class="nc" id="L4829">                final Coords coords = bldgCoords.nextElement();</span>
                // Walk through the entities at these coordinates.
<span class="nc bnc" id="L4831" title="All 2 branches missed.">                for (Entity entity : game.getEntitiesVector(coords)) {</span>
                    // Is the entity infantry?
<span class="nc bnc" id="L4833" title="All 2 branches missed.">                    if (entity instanceof Infantry) {</span>
                        // Is the infantry dead?
<span class="nc bnc" id="L4835" title="All 4 branches missed.">                        if (entity.isDoomed() || entity.isDestroyed()) {</span>
                            // Has the entity taken a turn?
<span class="nc bnc" id="L4837" title="All 2 branches missed.">                            if (!entity.isDone()) {</span>
                                // Dead entities don't take turns.
<span class="nc" id="L4839">                                game.removeTurnFor(entity);</span>
<span class="nc" id="L4840">                                bTurnsChanged = true;</span>
                            } // End entity-still-to-move

                            // Clean out the dead entity.
<span class="nc" id="L4844">                            entity.setDestroyed(true);</span>
<span class="nc" id="L4845">                            game.moveToGraveyard(entity.getId());</span>
<span class="nc" id="L4846">                            send(createRemoveEntityPacket(entity.getId()));</span>
                        } else { // Infantry that aren't dead are damaged.
<span class="nc" id="L4848">                            entityUpdate(entity.getId());</span>
                        }
                    } // End entity-is-infantry
<span class="nc" id="L4851">                } // Check the next entity.</span>
<span class="nc" id="L4852">            } // Handle the next hex in this building.</span>
            // Add this building to the report.
<span class="nc" id="L4854">            bldgUpdates.addElement(bldg);</span>
<span class="nc" id="L4855">        } // Handle the next affected building.</span>

        // Did we update the turns?
<span class="nc bnc" id="L4858" title="All 2 branches missed.">        if (bTurnsChanged) {</span>
<span class="nc" id="L4859">            send(createTurnVectorPacket());</span>
        }

        // Are there any building updates?
<span class="nc bnc" id="L4863" title="All 2 branches missed.">        if (!bldgUpdates.isEmpty()) {</span>
            // Send the building updates to the clients.
<span class="nc" id="L4865">            sendChangedBuildings(bldgUpdates);</span>

            // Clear the list of affected buildings.
<span class="nc" id="L4868">            affectedBldgs.clear();</span>
        }

        // And we're done.
<span class="nc" id="L4872">    } // End private void applyAffectedBldgs()</span>

    /**
     * Receives an entity movement packet, and if valid, executes it and ends
     * the current turn.
     */
    private void receiveMovement(Packet packet, int connId) {
<span class="nc" id="L4879">        Map&lt;EntityTargetPair, LosEffects&gt; losCache = new HashMap&lt;&gt;();</span>
<span class="nc" id="L4880">        Entity entity = game.getEntity(packet.getIntValue(0));</span>
<span class="nc" id="L4881">        MovePath md = (MovePath) packet.getObject(1);</span>
<span class="nc" id="L4882">        md.setGame(getGame());</span>
<span class="nc" id="L4883">        md.setEntity(entity);</span>

        // is this the right phase?
<span class="nc bnc" id="L4886" title="All 2 branches missed.">        if (game.getPhase() != IGame.Phase.PHASE_MOVEMENT) {</span>
<span class="nc" id="L4887">            MegaMek.getLogger().error(&quot;Server got movement packet in wrong phase&quot;);</span>
<span class="nc" id="L4888">            return;</span>
        }

        // can this player/entity act right now?
<span class="nc" id="L4892">        GameTurn turn = game.getTurn();</span>
<span class="nc bnc" id="L4893" title="All 2 branches missed.">        if (game.isPhaseSimultaneous()) {</span>
<span class="nc" id="L4894">            turn = game.getTurnForPlayer(connId);</span>
        }
<span class="nc bnc" id="L4896" title="All 4 branches missed.">        if ((turn == null) || !turn.isValid(connId, entity, game)) {</span>
<span class="nc" id="L4897">            String msg = &quot;error: server got invalid movement packet from &quot; + &quot;connection &quot; + connId;</span>
<span class="nc bnc" id="L4898" title="All 2 branches missed.">            if (entity != null) {</span>
<span class="nc" id="L4899">                msg += &quot;, Entity: &quot; + entity.getShortName();</span>
            } else {
<span class="nc" id="L4901">                msg += &quot;, Entity was null!&quot;;</span>
            }
<span class="nc" id="L4903">            MegaMek.getLogger().error(msg);</span>
<span class="nc" id="L4904">            return;</span>
        }

        // looks like mostly everything's okay
<span class="nc" id="L4908">        processMovement(entity, md, losCache);</span>

        // The attacker may choose to break a chain whip grapple by expending MP
<span class="nc bnc" id="L4911" title="All 2 branches missed.">        if ((entity.getGrappled() != Entity.NONE)</span>
<span class="nc bnc" id="L4912" title="All 4 branches missed.">                &amp;&amp; entity.isChainWhipGrappled() &amp;&amp; entity.isGrappleAttacker()</span>
<span class="nc bnc" id="L4913" title="All 2 branches missed.">                &amp;&amp; (md.getMpUsed() &gt; 0)) {</span>

<span class="nc" id="L4915">            Entity te = game.getEntity(entity.getGrappled());</span>
<span class="nc" id="L4916">            Report r = new Report(4316);</span>
<span class="nc" id="L4917">            r.subject = entity.getId();</span>
<span class="nc" id="L4918">            r.addDesc(entity);</span>
<span class="nc" id="L4919">            r.addDesc(te);</span>
<span class="nc" id="L4920">            addReport(r);</span>

<span class="nc" id="L4922">            entity.setGrappled(Entity.NONE, false);</span>
<span class="nc" id="L4923">            te.setGrappled(Entity.NONE, false);</span>

<span class="nc" id="L4925">            entityUpdate(entity.getId());</span>
<span class="nc" id="L4926">            entityUpdate(te.getId());</span>
        }

        // check the LOS of any telemissiles owned by this entity
<span class="nc bnc" id="L4930" title="All 2 branches missed.">        for (int missileId : entity.getTMTracker().getMissiles()) {</span>
<span class="nc" id="L4931">            Entity tm = game.getEntity(missileId);</span>
<span class="nc bnc" id="L4932" title="All 6 branches missed.">            if ((null != tm) &amp;&amp; !tm.isDestroyed()</span>
                &amp;&amp; (tm instanceof TeleMissile)) {
<span class="nc bnc" id="L4934" title="All 2 branches missed.">                if (LosEffects.calculateLos(game, entity.getId(), tm).canSee()) {</span>
<span class="nc" id="L4935">                    ((TeleMissile) tm).setOutContact(false);</span>
                } else {
<span class="nc" id="L4937">                    ((TeleMissile) tm).setOutContact(true);</span>
                }
<span class="nc" id="L4939">                entityUpdate(tm.getId());</span>
            }
<span class="nc" id="L4941">        }</span>

        // Notify the clients about any building updates.
<span class="nc" id="L4944">        applyAffectedBldgs();</span>

        // Unit movement may detect hidden units
<span class="nc" id="L4947">        detectHiddenUnits();</span>

        // Update visibility indications if using double blind.
<span class="nc bnc" id="L4950" title="All 2 branches missed.">        if (doBlind()) {</span>
<span class="nc" id="L4951">            updateVisibilityIndicator(losCache);</span>
        }

        // This entity's turn is over.
        // N.B. if the entity fell, a *new* turn has already been added.
<span class="nc" id="L4956">        endCurrentTurn(entity);</span>
<span class="nc" id="L4957">    }</span>

    /**
     * makes a unit skid or sideslip on the board
     *
     * @param entity    the unit which should skid
     * @param start     the coordinates of the hex the unit was in prior to skidding
     * @param elevation the elevation of the unit
     * @param direction the direction of the skid
     * @param distance  the number of hexes skidded
     * @param step      the MoveStep which caused the skid
     * @return true if the entity was removed from play
     */
    private boolean processSkid(Entity entity, Coords start, int elevation,
            int direction, int distance, MoveStep step,
            EntityMovementType moveType) {
<span class="nc" id="L4973">        return processSkid(entity, start, elevation, direction, distance, step, moveType, false);</span>
    }

    /**
     * makes a unit skid or sideslip on the board
     *
     * @param entity    the unit which should skid
     * @param start     the coordinates of the hex the unit was in prior to skidding
     * @param elevation the elevation of the unit
     * @param direction the direction of the skid
     * @param distance  the number of hexes skidded
     * @param step      the MoveStep which caused the skid
     * @param flip      whether the skid resulted from a failure maneuver result of major skid
     * @return true if the entity was removed from play
     */
    private boolean processSkid(Entity entity, Coords start, int elevation,
            int direction, int distance, MoveStep step,
            EntityMovementType moveType, boolean flip) {
<span class="nc" id="L4991">        Coords nextPos = start;</span>
<span class="nc" id="L4992">        Coords curPos = nextPos;</span>
<span class="nc" id="L4993">        IHex curHex = game.getBoard().getHex(start);</span>
        Report r;
<span class="nc" id="L4995">        int skidDistance = 0; // actual distance moved</span>
        // Flipping vehicles take tonnage/10 points of damage for every hex they enter.
<span class="nc" id="L4997">        int flipDamage = (int) Math.ceil(entity.getWeight() / 10.0);</span>
<span class="nc bnc" id="L4998" title="All 4 branches missed.">        while (!entity.isDoomed() &amp;&amp; (distance &gt; 0)) {</span>
<span class="nc" id="L4999">            nextPos = curPos.translated(direction);</span>
            // Is the next hex off the board?
<span class="nc bnc" id="L5001" title="All 2 branches missed.">            if (!game.getBoard().contains(nextPos)) {</span>

                // Can the entity skid off the map?
<span class="nc bnc" id="L5004" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.BASE_PUSH_OFF_BOARD)) {</span>
                    // Yup. One dead entity.
<span class="nc" id="L5006">                    game.removeEntity(entity.getId(), IEntityRemovalConditions.REMOVE_PUSHED);</span>
<span class="nc" id="L5007">                    send(createRemoveEntityPacket(entity.getId(), IEntityRemovalConditions.REMOVE_PUSHED));</span>
<span class="nc" id="L5008">                    r = new Report(2030, Report.PUBLIC);</span>
<span class="nc" id="L5009">                    r.addDesc(entity);</span>
<span class="nc" id="L5010">                    addReport(r);</span>

<span class="nc bnc" id="L5012" title="All 2 branches missed.">                    for (Entity e : entity.getLoadedUnits()) {</span>
<span class="nc" id="L5013">                        game.removeEntity(e.getId(), IEntityRemovalConditions.REMOVE_PUSHED);</span>
<span class="nc" id="L5014">                        send(createRemoveEntityPacket(e.getId(), IEntityRemovalConditions.REMOVE_PUSHED));</span>
<span class="nc" id="L5015">                    }</span>
<span class="nc" id="L5016">                    Entity swarmer = game.getEntity(entity.getSwarmAttackerId());</span>
<span class="nc bnc" id="L5017" title="All 2 branches missed.">                    if (swarmer != null) {</span>
<span class="nc bnc" id="L5018" title="All 2 branches missed.">                        if (!swarmer.isDone()) {</span>
<span class="nc" id="L5019">                            game.removeTurnFor(swarmer);</span>
<span class="nc" id="L5020">                            swarmer.setDone(true);</span>
<span class="nc" id="L5021">                            send(createTurnVectorPacket());</span>
                        }
<span class="nc" id="L5023">                        game.removeEntity(swarmer.getId(), IEntityRemovalConditions.REMOVE_PUSHED);</span>
<span class="nc" id="L5024">                        send(createRemoveEntityPacket(swarmer.getId(), IEntityRemovalConditions.REMOVE_PUSHED));</span>
                    }
                    // The entity's movement is completed.
<span class="nc" id="L5027">                    return true;</span>

                }
                // Nope. Update the report.
<span class="nc" id="L5031">                r = new Report(2035);</span>
<span class="nc" id="L5032">                r.subject = entity.getId();</span>
<span class="nc" id="L5033">                r.indent();</span>
<span class="nc" id="L5034">                addReport(r);</span>
                // Stay in the current hex and stop skidding.
<span class="nc" id="L5036">                break;</span>
            }

<span class="nc" id="L5039">            IHex nextHex = game.getBoard().getHex(nextPos);</span>
<span class="nc" id="L5040">            distance -= nextHex.movementCost(entity) + 1;</span>
            // By default, the unit is going to fall to the floor of the next
            // hex
<span class="nc" id="L5043">            int curAltitude = elevation + curHex.getLevel();</span>
<span class="nc" id="L5044">            int nextAltitude = nextHex.floor();</span>

            // but VTOL keep altitude
<span class="nc bnc" id="L5047" title="All 2 branches missed.">            if (entity.getMovementMode() == EntityMovementMode.VTOL) {</span>
<span class="nc" id="L5048">                nextAltitude = Math.max(nextAltitude, curAltitude);</span>
            } else {
                // Is there a building to &quot;catch&quot; the unit?
<span class="nc bnc" id="L5051" title="All 2 branches missed.">                if (nextHex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
                    // unit will land on the roof, if at a higher level,
                    // otherwise it will skid through the wall onto the same
                    // floor.
                    // don't change this if the building starts at an elevation
                    // higher than the unit
                    // (e.g. the building is on a hill). Otherwise, we skid into
                    // solid earth.
<span class="nc bnc" id="L5059" title="All 2 branches missed.">                    if (curAltitude &gt;= nextHex.floor()) {</span>
<span class="nc" id="L5060">                        nextAltitude = Math.min(curAltitude,</span>
<span class="nc" id="L5061">                                nextHex.getLevel() + nextHex.terrainLevel(Terrains.BLDG_ELEV));</span>
                    }
                }
                // Is there a bridge to &quot;catch&quot; the unit?
<span class="nc bnc" id="L5065" title="All 2 branches missed.">                if (nextHex.containsTerrain(Terrains.BRIDGE)) {</span>
                    // unit will land on the bridge, if at a higher level,
                    // and the bridge exits towards the current hex,
                    // otherwise the bridge has no effect
<span class="nc" id="L5069">                    int exitDir = (direction + 3) % 6;</span>
<span class="nc" id="L5070">                    exitDir = 1 &lt;&lt; exitDir;</span>
<span class="nc bnc" id="L5071" title="All 2 branches missed.">                    if ((nextHex.getTerrain(Terrains.BRIDGE).getExits() &amp; exitDir) == exitDir) {</span>
<span class="nc" id="L5072">                        nextAltitude = Math.min(curAltitude,</span>
<span class="nc" id="L5073">                                     Math.max(nextAltitude,</span>
<span class="nc" id="L5074">                                             nextHex.getLevel() + nextHex.terrainLevel(Terrains.BRIDGE_ELEV)));</span>
                    }
                }
<span class="nc bnc" id="L5077" title="All 2 branches missed.">                if ((nextAltitude &lt;= nextHex.surface())</span>
<span class="nc bnc" id="L5078" title="All 2 branches missed.">                    &amp;&amp; (curAltitude &gt;= curHex.surface())) {</span>
                    // Hovercraft and WiGEs can &quot;skid&quot; over water.
                    // all units can skid over ice.
<span class="nc bnc" id="L5081" title="All 2 branches missed.">                    if ((entity.getMovementMode().equals(EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L5082" title="All 2 branches missed.">                                || entity.getMovementMode().equals(EntityMovementMode.WIGE))</span>
<span class="nc bnc" id="L5083" title="All 2 branches missed.">                            &amp;&amp; nextHex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L5084">                        nextAltitude = nextHex.surface();</span>
                    } else {
<span class="nc bnc" id="L5086" title="All 2 branches missed.">                        if (nextHex.containsTerrain(Terrains.ICE)) {</span>
<span class="nc" id="L5087">                            nextAltitude = nextHex.surface();</span>
                        }
                    }
                }
<span class="nc bnc" id="L5091" title="All 6 branches missed.">                if (entity.getMovementMode() == EntityMovementMode.WIGE</span>
                        &amp;&amp; elevation &gt; 0 &amp;&amp; nextAltitude &lt; curAltitude) {
                    // Airborne WiGEs drop to one level above the surface
<span class="nc bnc" id="L5094" title="All 2 branches missed.">                    if (entity.climbMode()) {</span>
<span class="nc" id="L5095">                        nextAltitude = curAltitude;</span>
                    } else {
<span class="nc" id="L5097">                        nextAltitude++;</span>
                    }
                }
            }

            // The elevation the skidding unit will occupy in next hex
<span class="nc" id="L5103">            int nextElevation = nextAltitude - nextHex.surface();</span>

<span class="nc bnc" id="L5105" title="All 2 branches missed.">            boolean crashedIntoTerrain = curAltitude &lt; nextAltitude;</span>
<span class="nc bnc" id="L5106" title="All 2 branches missed.">            if (entity.getMovementMode() == EntityMovementMode.VTOL</span>
<span class="nc bnc" id="L5107" title="All 2 branches missed.">                &amp;&amp; (nextHex.containsTerrain(Terrains.WOODS)</span>
<span class="nc bnc" id="L5108" title="All 2 branches missed.">                        || nextHex.containsTerrain(Terrains.JUNGLE)) </span>
<span class="nc bnc" id="L5109" title="All 2 branches missed.">                &amp;&amp; nextElevation &lt;= nextHex.terrainLevel(Terrains.FOLIAGE_ELEV)) {</span>
<span class="nc" id="L5110">                    crashedIntoTerrain = true;</span>
                
            }

<span class="nc bnc" id="L5114" title="All 2 branches missed.">            if (nextHex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L5115">                Building bldg = game.getBoard().getBuildingAt(nextPos);</span>

<span class="nc bnc" id="L5117" title="All 2 branches missed.">                if (bldg.getType() == Building.WALL) {</span>
<span class="nc" id="L5118">                    crashedIntoTerrain = true;</span>
                }

<span class="nc bnc" id="L5121" title="All 2 branches missed.">                if (bldg.getBldgClass() == Building.GUN_EMPLACEMENT) {</span>
<span class="nc" id="L5122">                    crashedIntoTerrain = true;</span>
                }
            }

            // however WiGE can gain 1 level to avoid crashing into the terrain.
<span class="nc bnc" id="L5127" title="All 4 branches missed.">            if (entity.getMovementMode() == EntityMovementMode.WIGE &amp;&amp; (elevation &gt; 0)) {</span>
<span class="nc bnc" id="L5128" title="All 2 branches missed.">                if (curAltitude == nextHex.floor()) {</span>
<span class="nc" id="L5129">                    nextElevation = 1;</span>
<span class="nc" id="L5130">                    crashedIntoTerrain = false;</span>
<span class="nc bnc" id="L5131" title="All 4 branches missed.">                } else if ((entity instanceof LandAirMech) &amp;&amp; (curAltitude + 1 == nextHex.floor())) {</span>
                    // LAMs in AirMech mode skid across terrain that is two levels higher rather than crashing,
                    // Reset the skid distance for skid damage calculations.
<span class="nc" id="L5134">                    nextElevation = 0;</span>
<span class="nc" id="L5135">                    skidDistance = 0;</span>
<span class="nc" id="L5136">                    crashedIntoTerrain = false;</span>
<span class="nc" id="L5137">                    r = new Report(2102);</span>
<span class="nc" id="L5138">                    r.subject = entity.getId();</span>
<span class="nc" id="L5139">                    r.indent();</span>
<span class="nc" id="L5140">                    addReport(r);</span>
                }
            }

<span class="nc" id="L5144">            Entity crashDropShip = null;</span>
<span class="nc bnc" id="L5145" title="All 2 branches missed.">            for (Entity en : game.getEntitiesVector(nextPos)) {</span>
<span class="nc bnc" id="L5146" title="All 4 branches missed.">                if ((en instanceof Dropship) &amp;&amp; !en.isAirborne()</span>
<span class="nc bnc" id="L5147" title="All 2 branches missed.">                    &amp;&amp; (nextAltitude &lt;= (en.relHeight()))) {</span>
<span class="nc" id="L5148">                    crashDropShip = en;</span>
                }
<span class="nc" id="L5150">            }</span>

<span class="nc bnc" id="L5152" title="All 2 branches missed.">            if (crashedIntoTerrain) {</span>
<span class="nc bnc" id="L5153" title="All 2 branches missed.">                if (nextHex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L5154">                    Building bldg = game.getBoard().getBuildingAt(nextPos);</span>

                    // If you crash into a wall you want to stop in the hex
                    // before the wall not in the wall
                    // Like a building.
<span class="nc bnc" id="L5159" title="All 2 branches missed.">                    if (bldg.getType() == Building.WALL) {</span>
<span class="nc" id="L5160">                        r = new Report(2047);</span>
<span class="nc bnc" id="L5161" title="All 2 branches missed.">                    } else if (bldg.getBldgClass() == Building.GUN_EMPLACEMENT) {</span>
<span class="nc" id="L5162">                        r = new Report(2049);</span>
                    } else {
<span class="nc" id="L5164">                        r = new Report(2045);</span>
                    }

<span class="nc" id="L5167">                } else {</span>
<span class="nc" id="L5168">                    r = new Report(2045);</span>
                }

<span class="nc" id="L5171">                r.subject = entity.getId();</span>
<span class="nc" id="L5172">                r.indent();</span>
<span class="nc" id="L5173">                r.add(nextPos.getBoardNum(), true);</span>
<span class="nc" id="L5174">                addReport(r);</span>

<span class="nc bnc" id="L5176" title="All 2 branches missed.">                if ((entity.getMovementMode() == EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L5177" title="All 2 branches missed.">                        || (entity.getMovementMode() == EntityMovementMode.VTOL)) {</span>
<span class="nc" id="L5178">                    int hitSide = (step.getFacing() - direction) + 6;</span>
<span class="nc" id="L5179">                    hitSide %= 6;</span>
<span class="nc" id="L5180">                    int table = 0;</span>
<span class="nc bnc" id="L5181" title="All 5 branches missed.">                    switch (hitSide) {// quite hackish...I think it ought to</span>
                        // work, though.
                        case 0:// can this happen?
<span class="nc" id="L5184">                            table = ToHitData.SIDE_FRONT;</span>
<span class="nc" id="L5185">                            break;</span>
                        case 1:
                        case 2:
<span class="nc" id="L5188">                            table = ToHitData.SIDE_LEFT;</span>
<span class="nc" id="L5189">                            break;</span>
                        case 3:
<span class="nc" id="L5191">                            table = ToHitData.SIDE_REAR;</span>
<span class="nc" id="L5192">                            break;</span>
                        case 4:
                        case 5:
<span class="nc" id="L5195">                            table = ToHitData.SIDE_RIGHT;</span>
                            break;
                    }
<span class="nc" id="L5198">                    elevation = nextElevation;</span>
<span class="nc bnc" id="L5199" title="All 2 branches missed.">                    if (entity instanceof Tank) {</span>
<span class="nc" id="L5200">                        addReport(crashVTOLorWiGE((Tank) entity, false, true,</span>
                                distance, curPos, elevation, table));
                    }

<span class="nc bnc" id="L5204" title="All 2 branches missed.">                    if ((nextHex.containsTerrain(Terrains.WATER) &amp;&amp; !nextHex</span>
<span class="nc bnc" id="L5205" title="All 2 branches missed.">                            .containsTerrain(Terrains.ICE))</span>
<span class="nc bnc" id="L5206" title="All 2 branches missed.">                            || nextHex.containsTerrain(Terrains.WOODS)</span>
<span class="nc bnc" id="L5207" title="All 2 branches missed.">                            || nextHex.containsTerrain(Terrains.JUNGLE)) {</span>
<span class="nc" id="L5208">                        addReport(destroyEntity(entity, &quot;could not land in crash site&quot;));</span>
<span class="nc bnc" id="L5209" title="All 2 branches missed.">                    } else if (elevation &lt; nextHex.terrainLevel(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L5210">                        Building bldg = game.getBoard().getBuildingAt(nextPos);</span>

                        // If you crash into a wall you want to stop in the hex
                        // before the wall not in the wall
                        // Like a building.
<span class="nc bnc" id="L5215" title="All 2 branches missed.">                        if (bldg.getType() == Building.WALL) {</span>
<span class="nc" id="L5216">                            addReport(destroyEntity(entity, &quot;crashed into a wall&quot;));</span>
<span class="nc" id="L5217">                            break;</span>
                        }
<span class="nc bnc" id="L5219" title="All 2 branches missed.">                        if (bldg.getBldgClass() == Building.GUN_EMPLACEMENT) {</span>
<span class="nc" id="L5220">                            addReport(destroyEntity(entity, &quot;crashed into a gun emplacement&quot;));</span>
<span class="nc" id="L5221">                            break;</span>
                        }

<span class="nc" id="L5224">                        addReport(destroyEntity(entity, &quot;crashed into building&quot;));</span>
<span class="nc" id="L5225">                    } else {</span>
<span class="nc" id="L5226">                        entity.setPosition(nextPos);</span>
<span class="nc" id="L5227">                        entity.setElevation(0);</span>
<span class="nc" id="L5228">                        addReport(doEntityDisplacementMinefieldCheck(entity,</span>
                                curPos, nextPos, nextElevation));
                    }
<span class="nc" id="L5231">                    break;</span>

                }
                // skidding into higher terrain does weight/20
                // damage in 5pt clusters to front.
<span class="nc" id="L5236">                int damage = ((int) entity.getWeight() + 19) / 20;</span>
<span class="nc bnc" id="L5237" title="All 2 branches missed.">                while (damage &gt; 0) {</span>
<span class="nc" id="L5238">                    int table = ToHitData.HIT_NORMAL;</span>
<span class="nc" id="L5239">                    int side = entity.sideTable(nextPos);</span>
<span class="nc bnc" id="L5240" title="All 2 branches missed.">                    if (entity instanceof Protomech) {</span>
<span class="nc" id="L5241">                        table = ToHitData.HIT_SPECIAL_PROTO;</span>
                    }
<span class="nc" id="L5243">                    HitData hitData = entity.rollHitLocation(table, side);</span>
<span class="nc" id="L5244">                    hitData.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L5245">                    addReport(damageEntity(entity, hitData, Math.min(5, damage)));</span>
<span class="nc" id="L5246">                    damage -= 5;</span>
<span class="nc" id="L5247">                }</span>
                // Stay in the current hex and stop skidding.
                break;
            }

            // did we hit a DropShip. Oww!
            // Taharqa: The rules on how to handle this are completely missing, so I am assuming
            // we assign damage as per an accidental charge, but do not displace
            // the DropShip and end the skid
<span class="nc bnc" id="L5256" title="All 2 branches missed.">            else if (null != crashDropShip) {</span>
<span class="nc" id="L5257">                r = new Report(2050);</span>
<span class="nc" id="L5258">                r.subject = entity.getId();</span>
<span class="nc" id="L5259">                r.indent();</span>
<span class="nc" id="L5260">                r.add(crashDropShip.getShortName(), true);</span>
<span class="nc" id="L5261">                r.add(nextPos.getBoardNum(), true);</span>
<span class="nc" id="L5262">                addReport(r);</span>
<span class="nc" id="L5263">                ChargeAttackAction caa = new ChargeAttackAction(entity.getId(),</span>
<span class="nc" id="L5264">                        crashDropShip.getTargetType(),</span>
<span class="nc" id="L5265">                        crashDropShip.getTargetId(),</span>
<span class="nc" id="L5266">                        crashDropShip.getPosition());</span>
<span class="nc" id="L5267">                ToHitData toHit = caa.toHit(game, true);</span>
<span class="nc" id="L5268">                resolveChargeDamage(entity, crashDropShip, toHit, direction);</span>
<span class="nc bnc" id="L5269" title="All 2 branches missed.">                if ((entity.getMovementMode() == EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L5270" title="All 2 branches missed.">                        || (entity.getMovementMode() == EntityMovementMode.VTOL)) {</span>
<span class="nc" id="L5271">                    int hitSide = (step.getFacing() - direction) + 6;</span>
<span class="nc" id="L5272">                    hitSide %= 6;</span>
<span class="nc" id="L5273">                    int table = 0;</span>
<span class="nc bnc" id="L5274" title="All 5 branches missed.">                    switch (hitSide) {// quite hackish...I think it ought to work, though.</span>
                        case 0:// can this happen?
<span class="nc" id="L5276">                            table = ToHitData.SIDE_FRONT;</span>
<span class="nc" id="L5277">                            break;</span>
                        case 1:
                        case 2:
<span class="nc" id="L5280">                            table = ToHitData.SIDE_LEFT;</span>
<span class="nc" id="L5281">                            break;</span>
                        case 3:
<span class="nc" id="L5283">                            table = ToHitData.SIDE_REAR;</span>
<span class="nc" id="L5284">                            break;</span>
                        case 4:
                        case 5:
<span class="nc" id="L5287">                            table = ToHitData.SIDE_RIGHT;</span>
                            break;
                    }
<span class="nc" id="L5290">                    elevation = nextElevation;</span>
<span class="nc" id="L5291">                    addReport(crashVTOLorWiGE((VTOL) entity, false, true,</span>
                            distance, curPos, elevation, table));
<span class="nc" id="L5293">                    break;</span>
                }
<span class="nc bnc" id="L5295" title="All 4 branches missed.">                if (!crashDropShip.isDoomed() &amp;&amp; !crashDropShip.isDestroyed()</span>
<span class="nc bnc" id="L5296" title="All 2 branches missed.">                        &amp;&amp; !game.isOutOfGame(crashDropShip)) {</span>
<span class="nc" id="L5297">                    break;</span>
                }
<span class="nc" id="L5299">            }</span>

            // Have skidding units suffer falls (off a cliff).
<span class="nc bnc" id="L5302" title="All 2 branches missed.">            else if ( (curAltitude &gt; (nextAltitude + entity.getMaxElevationChange())</span>
<span class="nc bnc" id="L5303" title="All 4 branches missed.">                    || (curHex.hasCliffTopTowards(nextHex) &amp;&amp; curAltitude &gt; nextAltitude) )</span>
<span class="nc bnc" id="L5304" title="All 4 branches missed.">                    &amp;&amp; !(entity.getMovementMode() == EntityMovementMode.WIGE &amp;&amp; elevation &gt; curHex.ceiling())) {</span>
<span class="nc" id="L5305">                addReport(doEntityFallsInto(entity, entity.getElevation(), curPos, nextPos,</span>
<span class="nc" id="L5306">                        entity.getBasePilotingRoll(moveType), true));</span>
<span class="nc" id="L5307">                addReport(doEntityDisplacementMinefieldCheck(entity, curPos, nextPos, nextElevation));</span>
                // Stay in the current hex and stop skidding.
<span class="nc" id="L5309">                break;</span>
            }

            // Get any building in the hex.
<span class="nc" id="L5313">            Building bldg = null;</span>
<span class="nc bnc" id="L5314" title="All 2 branches missed.">            if (nextElevation &lt; nextHex.terrainLevel(Terrains.BLDG_ELEV)) {</span>
                // We will only run into the building if its at a higher level,
                // otherwise we skid over the roof
<span class="nc" id="L5317">                bldg = game.getBoard().getBuildingAt(nextPos);</span>
            }
<span class="nc" id="L5319">            boolean bldgSuffered = false;</span>
<span class="nc" id="L5320">            boolean stopTheSkid = false;</span>
            // Does the next hex contain an entities?
            // ASSUMPTION: hurt EVERYONE in the hex.
<span class="nc" id="L5323">            Iterator&lt;Entity&gt; targets = game.getEntities(nextPos);</span>
<span class="nc bnc" id="L5324" title="All 2 branches missed.">            if (targets.hasNext()) {</span>
<span class="nc" id="L5325">                List&lt;Entity&gt; avoidedChargeUnits = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L5326">                boolean skidChargeHit = false;</span>
<span class="nc bnc" id="L5327" title="All 2 branches missed.">                while (targets.hasNext()) {</span>
<span class="nc" id="L5328">                    Entity target = targets.next();</span>

<span class="nc bnc" id="L5330" title="All 2 branches missed.">                    if ((target.getElevation() &gt; (nextElevation + entity.getHeight()))</span>
<span class="nc bnc" id="L5331" title="All 2 branches missed.">                            || (target.relHeight() &lt; nextElevation)) {</span>
                        // target is not in the way
<span class="nc" id="L5333">                        continue;</span>
                    }

                    // Can the target avoid the skid?
<span class="nc bnc" id="L5337" title="All 2 branches missed.">                    if (!target.isDone()) {</span>
<span class="nc bnc" id="L5338" title="All 2 branches missed.">                        if (target instanceof Infantry) {</span>
<span class="nc" id="L5339">                            r = new Report(2420);</span>
<span class="nc" id="L5340">                            r.subject = target.getId();</span>
<span class="nc" id="L5341">                            r.addDesc(target);</span>
<span class="nc" id="L5342">                            addReport(r);</span>
<span class="nc" id="L5343">                            continue;</span>
<span class="nc bnc" id="L5344" title="All 2 branches missed.">                        } else if (target instanceof Protomech) {</span>
<span class="nc bnc" id="L5345" title="All 2 branches missed.">                            if (target != Compute.stackingViolation(game, entity, nextPos, null)) {</span>
<span class="nc" id="L5346">                                r = new Report(2420);</span>
<span class="nc" id="L5347">                                r.subject = target.getId();</span>
<span class="nc" id="L5348">                                r.addDesc(target);</span>
<span class="nc" id="L5349">                                addReport(r);</span>
<span class="nc" id="L5350">                                continue;</span>
                            }
                        } else {
<span class="nc" id="L5353">                            PilotingRollData psr = target.getBasePilotingRoll();</span>
<span class="nc" id="L5354">                            psr.addModifier(0, &quot;avoiding collision&quot;);</span>
<span class="nc bnc" id="L5355" title="All 2 branches missed.">                            if (psr.getValue() == TargetRoll.AUTOMATIC_FAIL</span>
<span class="nc bnc" id="L5356" title="All 2 branches missed.">                                    || psr.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L5357">                                r = new Report(2426);</span>
<span class="nc" id="L5358">                                r.subject = target.getId();</span>
<span class="nc" id="L5359">                                r.addDesc(target);</span>
<span class="nc" id="L5360">                                r.add(psr.getDesc());</span>
<span class="nc" id="L5361">                                addReport(r);</span>
                            } else {
<span class="nc" id="L5363">                                int roll = Compute.d6(2);</span>
<span class="nc" id="L5364">                                r = new Report(2425);</span>
<span class="nc" id="L5365">                                r.subject = target.getId();</span>
<span class="nc" id="L5366">                                r.addDesc(target);</span>
<span class="nc" id="L5367">                                r.add(psr.getValue());</span>
<span class="nc" id="L5368">                                r.add(psr.getDesc());</span>
<span class="nc" id="L5369">                                r.add(roll);</span>
<span class="nc" id="L5370">                                addReport(r);</span>
<span class="nc bnc" id="L5371" title="All 2 branches missed.">                                if (roll &gt;= psr.getValue()) {</span>
<span class="nc" id="L5372">                                    game.removeTurnFor(target);</span>
<span class="nc" id="L5373">                                    avoidedChargeUnits.add(target);</span>
<span class="nc" id="L5374">                                    continue;</span>
                                    // TODO : the charge should really be suspended
                                    // and resumed after the target moved.
                                }
                            }
                        }
                    }

                    // Mechs and vehicles get charged,
                    // but need to make a to-hit roll
<span class="nc bnc" id="L5384" title="All 6 branches missed.">                    if ((target instanceof Mech) || (target instanceof Tank)</span>
                            || (target instanceof Aero)) {
<span class="nc" id="L5386">                        ChargeAttackAction caa = new ChargeAttackAction(</span>
<span class="nc" id="L5387">                                entity.getId(), target.getTargetType(),</span>
<span class="nc" id="L5388">                                target.getTargetId(), target.getPosition());</span>
<span class="nc" id="L5389">                        ToHitData toHit = caa.toHit(game, true);</span>

                        // roll
<span class="nc" id="L5392">                        int roll = Compute.d6(2);</span>
                        // Update report.
<span class="nc" id="L5394">                        r = new Report(2050);</span>
<span class="nc" id="L5395">                        r.subject = entity.getId();</span>
<span class="nc" id="L5396">                        r.indent();</span>
<span class="nc" id="L5397">                        r.add(target.getShortName(), true);</span>
<span class="nc" id="L5398">                        r.add(nextPos.getBoardNum(), true);</span>
<span class="nc" id="L5399">                        r.newlines = 0;</span>
<span class="nc" id="L5400">                        addReport(r);</span>
<span class="nc bnc" id="L5401" title="All 2 branches missed.">                        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L5402">                            roll = -12;</span>
<span class="nc" id="L5403">                            r = new Report(2055);</span>
<span class="nc" id="L5404">                            r.subject = entity.getId();</span>
<span class="nc" id="L5405">                            r.add(toHit.getDesc());</span>
<span class="nc" id="L5406">                            r.newlines = 0;</span>
<span class="nc" id="L5407">                            addReport(r);</span>
<span class="nc bnc" id="L5408" title="All 2 branches missed.">                        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L5409">                            r = new Report(2060);</span>
<span class="nc" id="L5410">                            r.subject = entity.getId();</span>
<span class="nc" id="L5411">                            r.add(toHit.getDesc());</span>
<span class="nc" id="L5412">                            r.newlines = 0;</span>
<span class="nc" id="L5413">                            addReport(r);</span>
<span class="nc" id="L5414">                            roll = Integer.MAX_VALUE;</span>
                        } else {
                            // report the roll
<span class="nc" id="L5417">                            r = new Report(2065);</span>
<span class="nc" id="L5418">                            r.subject = entity.getId();</span>
<span class="nc" id="L5419">                            r.add(toHit.getValue());</span>
<span class="nc" id="L5420">                            r.add(roll);</span>
<span class="nc" id="L5421">                            r.newlines = 0;</span>
<span class="nc" id="L5422">                            addReport(r);</span>
                        }

                        // Resolve a charge against the target.
                        // ASSUMPTION: buildings block damage for
                        // *EACH* entity charged.
<span class="nc bnc" id="L5428" title="All 2 branches missed.">                        if (roll &lt; toHit.getValue()) {</span>
<span class="nc" id="L5429">                            r = new Report(2070);</span>
<span class="nc" id="L5430">                            r.subject = entity.getId();</span>
<span class="nc" id="L5431">                            addReport(r);</span>
                        } else {
                            // Resolve the charge.
<span class="nc" id="L5434">                            resolveChargeDamage(entity, target, toHit, direction);</span>
                            // HACK: set the entity's location
                            // to the original hex again, for the other targets
<span class="nc bnc" id="L5437" title="All 2 branches missed.">                            if (targets.hasNext()) {</span>
<span class="nc" id="L5438">                                entity.setPosition(curPos);</span>
                            }
<span class="nc" id="L5440">                            bldgSuffered = true;</span>
<span class="nc" id="L5441">                            skidChargeHit = true;</span>
                            // The skid ends here if the target lives.
<span class="nc bnc" id="L5443" title="All 4 branches missed.">                            if (!target.isDoomed() &amp;&amp; !target.isDestroyed()</span>
<span class="nc bnc" id="L5444" title="All 2 branches missed.">                                    &amp;&amp; !game.isOutOfGame(target)) {</span>
<span class="nc" id="L5445">                                stopTheSkid = true;</span>
                            }
                        }

                        // if we don't do this here,
                        // we can have a mech without a leg
                        // standing on the field and moving
                        // as if it still had his leg after
                        // getting skid-charged.
<span class="nc bnc" id="L5454" title="All 2 branches missed.">                        if (!target.isDone()) {</span>
<span class="nc" id="L5455">                            addReport(resolvePilotingRolls(target));</span>
<span class="nc" id="L5456">                            game.resetPSRs(target);</span>
<span class="nc" id="L5457">                            target.applyDamage();</span>
<span class="nc" id="L5458">                            addNewLines();</span>
                        }

<span class="nc" id="L5461">                    }</span>

                    // Resolve &quot;move-through&quot; damage on infantry.
                    // Infantry inside of a building don't get a
                    // move-through, but suffer &quot;bleed through&quot;
                    // from the building.
<span class="nc bnc" id="L5467" title="All 4 branches missed.">                    else if ((target instanceof Infantry) &amp;&amp; (bldg != null)) {</span>
                        // Update report.
<span class="nc" id="L5469">                        r = new Report(2075);</span>
<span class="nc" id="L5470">                        r.subject = entity.getId();</span>
<span class="nc" id="L5471">                        r.indent();</span>
<span class="nc" id="L5472">                        r.add(target.getShortName(), true);</span>
<span class="nc" id="L5473">                        r.add(nextPos.getBoardNum(), true);</span>
<span class="nc" id="L5474">                        r.newlines = 0;</span>
<span class="nc" id="L5475">                        addReport(r);</span>

                        // Infantry don't have different
                        // tables for punches and kicks
<span class="nc" id="L5479">                        HitData hit = target.rollHitLocation(ToHitData.HIT_NORMAL,</span>
<span class="nc" id="L5480">                                Compute.targetSideTable(entity, target));</span>
<span class="nc" id="L5481">                        hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
                        // Damage equals tonnage, divided by 5.
                        // ASSUMPTION: damage is applied in one hit.
<span class="nc" id="L5484">                        addReport(damageEntity(target, hit, (int) Math.round(entity.getWeight() / 5)));</span>
<span class="nc" id="L5485">                        addNewLines();</span>
                    }

                    // Has the target been destroyed?
<span class="nc bnc" id="L5489" title="All 2 branches missed.">                    if (target.isDoomed()) {</span>
                        // Has the target taken a turn?
<span class="nc bnc" id="L5491" title="All 2 branches missed.">                        if (!target.isDone()) {</span>
                            // Dead entities don't take turns.
<span class="nc" id="L5493">                            game.removeTurnFor(target);</span>
<span class="nc" id="L5494">                            send(createTurnVectorPacket());</span>
                        } // End target-still-to-move

                        // Clean out the entity.
<span class="nc" id="L5498">                        target.setDestroyed(true);</span>
<span class="nc" id="L5499">                        game.moveToGraveyard(target.getId());</span>
<span class="nc" id="L5500">                        send(createRemoveEntityPacket(target.getId()));</span>
                    }
                    // Update the target's position,
                    // unless it is off the game map.
<span class="nc bnc" id="L5504" title="All 2 branches missed.">                    if (!game.isOutOfGame(target)) {</span>
<span class="nc" id="L5505">                        entityUpdate(target.getId());</span>
                    }
<span class="nc" id="L5507">                } // Check the next entity in the hex.</span>

<span class="nc bnc" id="L5509" title="All 2 branches missed.">                if (skidChargeHit) {</span>
                    // HACK: set the entities position to that
                    // hex's coords, because we had to move the entity
                    // back earlier for the other targets
<span class="nc" id="L5513">                    entity.setPosition(nextPos);</span>
                }
<span class="nc bnc" id="L5515" title="All 2 branches missed.">                for (Entity e : avoidedChargeUnits) {</span>
<span class="nc" id="L5516">                    GameTurn newTurn = new GameTurn.SpecificEntityTurn(e.getOwner().getId(), e.getId());</span>
                    // Prevents adding extra turns for multi-turns
<span class="nc" id="L5518">                    newTurn.setMultiTurn(true);</span>
<span class="nc" id="L5519">                    game.insertNextTurn(newTurn);</span>
<span class="nc" id="L5520">                    send(createTurnVectorPacket());</span>
<span class="nc" id="L5521">                }</span>
            }

            // Handle the building in the hex.
<span class="nc bnc" id="L5525" title="All 2 branches missed.">            if (bldg != null) {</span>
                // Report that the entity has entered the bldg.
<span class="nc" id="L5527">                r = new Report(2080);</span>
<span class="nc" id="L5528">                r.subject = entity.getId();</span>
<span class="nc" id="L5529">                r.indent();</span>
<span class="nc" id="L5530">                r.add(bldg.getName());</span>
<span class="nc" id="L5531">                r.add(nextPos.getBoardNum(), true);</span>
<span class="nc" id="L5532">                addReport(r);</span>

                // If the building hasn't already suffered
                // damage, then apply charge damage to the
                // building and displace the entity inside.
                // ASSUMPTION: you don't charge the building
                // if Tanks or Mechs were charged.
<span class="nc" id="L5539">                int chargeDamage = ChargeAttackAction.getDamageFor(entity, game</span>
<span class="nc" id="L5540">                        .getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_CHARGE_DAMAGE),</span>
                        entity.delta_distance);
<span class="nc bnc" id="L5542" title="All 2 branches missed.">                if (!bldgSuffered) {</span>
<span class="nc" id="L5543">                    Vector&lt;Report&gt; reports = damageBuilding(bldg, chargeDamage, nextPos);</span>
<span class="nc bnc" id="L5544" title="All 2 branches missed.">                    for (Report report : reports) {</span>
<span class="nc" id="L5545">                        report.subject = entity.getId();</span>
<span class="nc" id="L5546">                    }</span>
<span class="nc" id="L5547">                    addReport(reports);</span>

                    // Apply damage to the attacker.
<span class="nc" id="L5550">                    int toAttacker = ChargeAttackAction.getDamageTakenBy(entity, bldg, nextPos);</span>
<span class="nc" id="L5551">                    HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, entity.sideTable(nextPos));</span>
<span class="nc" id="L5552">                    hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L5553">                    addReport(damageEntity(entity, hit, toAttacker));</span>
<span class="nc" id="L5554">                    addNewLines();</span>

<span class="nc" id="L5556">                    entity.setPosition(nextPos);</span>
<span class="nc" id="L5557">                    entity.setElevation(nextElevation);</span>
<span class="nc" id="L5558">                    addReport(doEntityDisplacementMinefieldCheck(entity, curPos, nextPos, nextElevation));</span>
<span class="nc" id="L5559">                    curPos = nextPos;</span>
                } // End buildings-suffer-too

                // Any infantry in the building take damage
                // equal to the building being charged.
                // ASSUMPTION: infantry take no damage from the
                // building absorbing damage from
                // Tanks and Mechs being charged.
<span class="nc" id="L5567">                addReport(damageInfantryIn(bldg, chargeDamage, nextPos));</span>

                // If a building still stands, then end the skid,
                // and add it to the list of affected buildings.
<span class="nc bnc" id="L5571" title="All 2 branches missed.">                if (bldg.getCurrentCF(nextPos) &gt; 0) {</span>
<span class="nc" id="L5572">                    stopTheSkid = true;</span>
<span class="nc bnc" id="L5573" title="All 2 branches missed.">                    if (bldg.rollBasement(nextPos, game.getBoard(), vPhaseReport)) {</span>
<span class="nc" id="L5574">                        sendChangedHex(nextPos);</span>
<span class="nc" id="L5575">                        Vector&lt;Building&gt; buildings = new Vector&lt;&gt;();</span>
<span class="nc" id="L5576">                        buildings.add(bldg);</span>
<span class="nc" id="L5577">                        sendChangedBuildings(buildings);</span>
                    }
<span class="nc" id="L5579">                    addAffectedBldg(bldg, checkBuildingCollapseWhileMoving(bldg, entity, nextPos));</span>
                } else {
                    // otherwise it collapses immediately on our head
<span class="nc" id="L5582">                    checkForCollapse(bldg, game.getPositionMap(), nextPos, true, vPhaseReport);</span>
                }
            } // End handle-building.

            // Do we stay in the current hex and stop skidding?
<span class="nc bnc" id="L5587" title="All 2 branches missed.">            if (stopTheSkid) {</span>
<span class="nc" id="L5588">                break;</span>
            }

            // Update entity position and elevation
<span class="nc" id="L5592">            entity.setPosition(nextPos);</span>
<span class="nc" id="L5593">            entity.setElevation(nextElevation);</span>
<span class="nc" id="L5594">            addReport(doEntityDisplacementMinefieldCheck(entity, curPos, nextPos, nextElevation));</span>
<span class="nc" id="L5595">            skidDistance++;</span>

            // Check for collapse of any building the entity might be on
<span class="nc" id="L5598">            Building roof = game.getBoard().getBuildingAt(nextPos);</span>
<span class="nc bnc" id="L5599" title="All 2 branches missed.">            if (roof != null) {</span>
<span class="nc bnc" id="L5600" title="All 2 branches missed.">                if (checkForCollapse(roof, game.getPositionMap(), nextPos, true, vPhaseReport)) {</span>
<span class="nc" id="L5601">                    break; // stop skidding if the building collapsed</span>
                }
            }

            // Can the skidding entity enter the next hex from this?
            // N.B. can skid along roads.
<span class="nc bnc" id="L5607" title="All 4 branches missed.">            if ((entity.isLocationProhibited(start) || entity.isLocationProhibited(nextPos))</span>
<span class="nc bnc" id="L5608" title="All 2 branches missed.">                    &amp;&amp; !Compute.canMoveOnPavement(game, curPos, nextPos, step)) {</span>
                // Update report.
<span class="nc" id="L5610">                r = new Report(2040);</span>
<span class="nc" id="L5611">                r.subject = entity.getId();</span>
<span class="nc" id="L5612">                r.indent();</span>
<span class="nc" id="L5613">                r.add(nextPos.getBoardNum(), true);</span>
<span class="nc" id="L5614">                addReport(r);</span>

                // If the prohibited terrain is water, entity is destroyed
<span class="nc bnc" id="L5617" title="All 4 branches missed.">                if ((nextHex.terrainLevel(Terrains.WATER) &gt; 0)</span>
                        &amp;&amp; (entity instanceof Tank)
<span class="nc bnc" id="L5619" title="All 2 branches missed.">                        &amp;&amp; (entity.getMovementMode() != EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L5620" title="All 2 branches missed.">                        &amp;&amp; (entity.getMovementMode() != EntityMovementMode.WIGE)) {</span>
<span class="nc" id="L5621">                    addReport(destroyEntity(entity,</span>
                            &quot;skidded into a watery grave&quot;, false, true));
                }

                // otherwise, damage is weight/5 in 5pt clusters
<span class="nc" id="L5626">                int damage = ((int) entity.getWeight() + 4) / 5;</span>
<span class="nc bnc" id="L5627" title="All 2 branches missed.">                while (damage &gt; 0) {</span>
<span class="nc" id="L5628">                    addReport(damageEntity(entity, entity.rollHitLocation(</span>
                            ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT),
<span class="nc" id="L5630">                            Math.min(5, damage)));</span>
<span class="nc" id="L5631">                    damage -= 5;</span>
                }
                // and unit is immobile
<span class="nc bnc" id="L5634" title="All 2 branches missed.">                if (entity instanceof Tank) {</span>
<span class="nc" id="L5635">                    ((Tank) entity).immobilize();</span>
                }

                // Stay in the current hex and stop skidding.
                break;
            }

<span class="nc bnc" id="L5642" title="All 2 branches missed.">            if ((nextHex.terrainLevel(Terrains.WATER) &gt; 0)</span>
<span class="nc bnc" id="L5643" title="All 2 branches missed.">                    &amp;&amp; (entity.getMovementMode() != EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L5644" title="All 2 branches missed.">                    &amp;&amp; (entity.getMovementMode() != EntityMovementMode.WIGE)) {</span>
                // water ends the skid
<span class="nc" id="L5646">                break;</span>
            }

            // check for breaking magma crust
            // note that this must sequentially occur before the next 'entering liquid magma' check
            // otherwise, magma crust won't have a chance to break
<span class="nc" id="L5652">            ServerHelper.checkAndApplyMagmaCrust(nextHex, nextElevation, entity, curPos, false, vPhaseReport, this);</span>

            // is the next hex a swamp?
<span class="nc" id="L5655">            PilotingRollData rollTarget = entity.checkBogDown(step, moveType, nextHex, curPos, nextPos,</span>
<span class="nc" id="L5656">                    step.getElevation(), Compute.canMoveOnPavement(game, curPos, nextPos, step));</span>

<span class="nc bnc" id="L5658" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
                // Taharqa: According to TacOps, you automatically stick if you
                // are skidding, (pg. 63)
                // if (0 &lt; doSkillCheckWhileMoving(entity, curPos, nextPos,
                // rollTarget, false)) {
<span class="nc" id="L5663">                entity.setStuck(true);</span>
<span class="nc" id="L5664">                r = new Report(2081);</span>
<span class="nc" id="L5665">                r.subject = entity.getId();</span>
<span class="nc" id="L5666">                r.add(entity.getDisplayName(), true);</span>
<span class="nc" id="L5667">                addReport(r);</span>
                // check for quicksand
<span class="nc" id="L5669">                addReport(checkQuickSand(nextPos));</span>
                // check for accidental stacking violation
<span class="nc" id="L5671">                Entity violation = Compute.stackingViolation(game, entity.getId(), curPos);</span>
<span class="nc bnc" id="L5672" title="All 2 branches missed.">                if (violation != null) {</span>
                    // target gets displaced, because of low elevation
<span class="nc" id="L5674">                    Coords targetDest = Compute.getValidDisplacement(game, entity.getId(), curPos,</span>
                            direction);
<span class="nc" id="L5676">                    addReport(doEntityDisplacement(violation, curPos, targetDest,</span>
<span class="nc" id="L5677">                            new PilotingRollData(violation.getId(), 0, &quot;domino effect&quot;)));</span>
                    // Update the violating entity's position on the client.
<span class="nc" id="L5679">                    entityUpdate(violation.getId());</span>
<span class="nc" id="L5680">                }</span>
                // stay here and stop skidding, see bug 1115608
                break;
            }

            // Update the position and keep skidding.
<span class="nc" id="L5686">            curPos = nextPos;</span>
<span class="nc" id="L5687">            curHex = nextHex;</span>
<span class="nc" id="L5688">            elevation = nextElevation;</span>
<span class="nc" id="L5689">            r = new Report(2085);</span>
<span class="nc" id="L5690">            r.subject = entity.getId();</span>
<span class="nc" id="L5691">            r.indent();</span>
<span class="nc" id="L5692">            r.add(curPos.getBoardNum(), true);</span>
<span class="nc" id="L5693">            addReport(r);</span>

<span class="nc bnc" id="L5695" title="All 4 branches missed.">            if (flip &amp;&amp; entity instanceof Tank) {</span>
<span class="nc bnc" id="L5696" title="All 2 branches missed.">                doVehicleFlipDamage((Tank)entity, flipDamage, direction &lt; 3, skidDistance - 1);</span>
            }

<span class="nc" id="L5699">        } // Handle the next skid hex.</span>

        // If the skidding entity violates stacking,
        // displace targets until it doesn't.
<span class="nc" id="L5703">        curPos = entity.getPosition();</span>
<span class="nc" id="L5704">        Entity target = Compute.stackingViolation(game, entity.getId(), curPos);</span>
<span class="nc bnc" id="L5705" title="All 2 branches missed.">        while (target != null) {</span>
<span class="nc" id="L5706">            nextPos = Compute.getValidDisplacement(game, target.getId(), target.getPosition(), direction);</span>
            // ASSUMPTION
            // There should always be *somewhere* that
            // the target can go... last skid hex if
            // nothing else is available.
<span class="nc bnc" id="L5711" title="All 2 branches missed.">            if (null == nextPos) {</span>
                // But I don't trust the assumption fully.
                // Report the error and try to continue.
<span class="nc" id="L5714">                MegaMek.getLogger().error(&quot;The skid of &quot; + entity.getShortName()</span>
<span class="nc" id="L5715">                                + &quot; should displace &quot; + target.getShortName()</span>
<span class="nc" id="L5716">                                + &quot; in hex &quot; + curPos.getBoardNum()</span>
                                + &quot; but there is nowhere to go.&quot;);
<span class="nc" id="L5718">                break;</span>
            }
            // indent displacement
<span class="nc" id="L5721">            r = new Report(1210, Report.PUBLIC);</span>
<span class="nc" id="L5722">            r.indent();</span>
<span class="nc" id="L5723">            r.newlines = 0;</span>
<span class="nc" id="L5724">            addReport(r);</span>
<span class="nc" id="L5725">            addReport(doEntityDisplacement(target, curPos, nextPos, null));</span>
<span class="nc" id="L5726">            addReport(doEntityDisplacementMinefieldCheck(entity, curPos, nextPos, entity.getElevation()));</span>
<span class="nc" id="L5727">            target = Compute.stackingViolation(game, entity.getId(), curPos);</span>
        }

        // Mechs suffer damage for every hex skidded.
        // For QuadVees in vehicle mode, apply
        // damage only if flipping.
<span class="nc bnc" id="L5733" title="All 2 branches missed.">        boolean mechDamage = ((entity instanceof Mech)</span>
<span class="nc bnc" id="L5734" title="All 4 branches missed.">                &amp;&amp; !((entity.getMovementMode() == EntityMovementMode.WIGE) &amp;&amp; (entity.getElevation() &gt; 0)));</span>
<span class="nc bnc" id="L5735" title="All 4 branches missed.">        if (entity instanceof QuadVee &amp;&amp; entity.getConversionMode() == QuadVee.CONV_MODE_VEHICLE) {</span>
<span class="nc" id="L5736">            mechDamage = flip;</span>
        }
<span class="nc bnc" id="L5738" title="All 2 branches missed.">        if (mechDamage) {</span>
            // Calculate one half falling damage times skid length.
<span class="nc" id="L5740">            int damage = skidDistance * (int) Math.ceil(Math.round(entity.getWeight() / 10.0) / 2.0);</span>

            // report skid damage
<span class="nc" id="L5743">            r = new Report(2090);</span>
<span class="nc" id="L5744">            r.subject = entity.getId();</span>
<span class="nc" id="L5745">            r.indent();</span>
<span class="nc" id="L5746">            r.addDesc(entity);</span>
<span class="nc" id="L5747">            r.add(damage);</span>
<span class="nc" id="L5748">            addReport(r);</span>

            // standard damage loop
            // All skid damage is to the front.
<span class="nc bnc" id="L5752" title="All 2 branches missed.">            while (damage &gt; 0) {</span>
<span class="nc" id="L5753">                int cluster = Math.min(5, damage);</span>
<span class="nc" id="L5754">                HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L5755">                hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L5756">                addReport(damageEntity(entity, hit, cluster));</span>
<span class="nc" id="L5757">                damage -= cluster;</span>
<span class="nc" id="L5758">            }</span>
<span class="nc" id="L5759">            addNewLines();</span>
        }

<span class="nc bnc" id="L5762" title="All 4 branches missed.">        if (flip &amp;&amp; entity instanceof Tank) {</span>
<span class="nc" id="L5763">            addReport(applyCriticalHit(entity, Entity.NONE, new CriticalSlot(0, Tank.CRIT_CREW_STUNNED),</span>
                    true, 0, false));
<span class="nc bnc" id="L5765" title="All 6 branches missed.">        } else if (flip &amp;&amp; entity instanceof QuadVee &amp;&amp; entity.getConversionMode() == QuadVee.CONV_MODE_VEHICLE) {</span>
            // QuadVees don't suffer stunned crew criticals; require PSR to avoid damage instead.
<span class="nc" id="L5767">            PilotingRollData prd = entity.getBasePilotingRoll();</span>
<span class="nc" id="L5768">            addReport(checkPilotAvoidFallDamage(entity, 1, prd));</span>
        }

        // Clean up the entity if it has been destroyed.
<span class="nc bnc" id="L5772" title="All 2 branches missed.">        if (entity.isDoomed()) {</span>
<span class="nc" id="L5773">            entity.setDestroyed(true);</span>
<span class="nc" id="L5774">            game.moveToGraveyard(entity.getId());</span>
<span class="nc" id="L5775">            send(createRemoveEntityPacket(entity.getId()));</span>

            // The entity's movement is completed.
<span class="nc" id="L5778">            return true;</span>
        }

        // Let the player know the ordeal is over.
<span class="nc" id="L5782">        r = new Report(2095);</span>
<span class="nc" id="L5783">        r.subject = entity.getId();</span>
<span class="nc" id="L5784">        r.indent();</span>
<span class="nc" id="L5785">        addReport(r);</span>

<span class="nc" id="L5787">        return false;</span>
    }

    /**
     * Roll on the failed vehicle maneuver table.
     *
     * @param entity    The vehicle that failed the maneuver.
     * @param curPos    The coordinates of the hex in which the maneuver was attempted.
     * @param turnDirection The difference between the intended final facing and the starting facing
     *                      (-1 for left turn, 1 for right turn, 0 for not turning).
     * @param prevStep  The &lt;code&gt;MoveStep&lt;/code&gt; immediately preceding the one being processed.
     *                  Cannot be null; if the check is made for the first step of the path,
     *                  use the current step.
     * @param lastStepMoveType  The &lt;code&gt;EntityMovementType&lt;/code&gt; of the last step in the path.
     * @param distance  The distance moved so far during the phase; used to calculate any potential skid.
     * @param modifier  The modifier to the maneuver failure roll.
     * @return          true if the maneuver failure result ends the unit's turn.
     */
    private boolean processFailedVehicleManeuver(Entity entity, Coords curPos, int turnDirection,
            MoveStep prevStep, boolean isBackwards, EntityMovementType lastStepMoveType, int distance,
            int modifier, int marginOfFailure) {
<span class="nc" id="L5808">        IHex curHex = game.getBoard().getHex(curPos);</span>
<span class="nc bnc" id="L5809" title="All 2 branches missed.">        if (entity.getMovementMode() == EntityMovementMode.WHEELED</span>
<span class="nc bnc" id="L5810" title="All 2 branches missed.">                &amp;&amp; !curHex.containsTerrain(Terrains.PAVEMENT)) {</span>
<span class="nc" id="L5811">            modifier += 2;</span>
        }
<span class="nc bnc" id="L5813" title="All 2 branches missed.">        if (entity.getMovementMode() == EntityMovementMode.VTOL) {</span>
<span class="nc" id="L5814">            modifier += 2;</span>
<span class="nc bnc" id="L5815" title="All 2 branches missed.">        } else if (entity.getMovementMode() == EntityMovementMode.HOVER</span>
<span class="nc bnc" id="L5816" title="All 4 branches missed.">                || (entity.getMovementMode() == EntityMovementMode.WIGE &amp;&amp; entity instanceof Tank)</span>
<span class="nc bnc" id="L5817" title="All 2 branches missed.">                || entity.getMovementMode() == EntityMovementMode.HYDROFOIL) {</span>
<span class="nc" id="L5818">            modifier += 4;</span>
        }
<span class="nc bnc" id="L5820" title="All 2 branches missed.">        if (entity.getWeightClass() &lt; EntityWeightClass.WEIGHT_MEDIUM</span>
<span class="nc bnc" id="L5821" title="All 2 branches missed.">                || entity.getWeightClass() == EntityWeightClass.WEIGHT_SMALL_SUPPORT) {</span>
<span class="nc" id="L5822">            modifier++;</span>
<span class="nc bnc" id="L5823" title="All 2 branches missed.">        } else if (entity.getWeightClass() == EntityWeightClass.WEIGHT_HEAVY</span>
<span class="nc bnc" id="L5824" title="All 2 branches missed.">                || entity.getWeightClass() == EntityWeightClass.WEIGHT_LARGE_SUPPORT) {</span>
<span class="nc" id="L5825">            modifier--;</span>
<span class="nc bnc" id="L5826" title="All 2 branches missed.">        } else if (entity.getWeightClass() == EntityWeightClass.WEIGHT_ASSAULT</span>
<span class="nc bnc" id="L5827" title="All 2 branches missed.">                || entity.getWeightClass() == EntityWeightClass.WEIGHT_SUPER_HEAVY) {</span>
<span class="nc" id="L5828">            modifier -= 2;</span>
        }
<span class="nc" id="L5830">        boolean turnEnds = false;</span>
<span class="nc" id="L5831">        boolean motiveDamage = false;</span>
<span class="nc" id="L5832">        int motiveDamageMod = 0;</span>
<span class="nc" id="L5833">        boolean skid = false;</span>
<span class="nc" id="L5834">        boolean flip = false;</span>
<span class="nc bnc" id="L5835" title="All 2 branches missed.">        boolean isGroundVehicle = ((entity instanceof Tank)</span>
<span class="nc bnc" id="L5836" title="All 2 branches missed.">                &amp;&amp; ((entity.getMovementMode() == EntityMovementMode.TRACKED)</span>
<span class="nc bnc" id="L5837" title="All 2 branches missed.">                    || (entity.getMovementMode() == EntityMovementMode.WHEELED)));</span>

<span class="nc" id="L5839">        int roll = Compute.d6(2);</span>

<span class="nc" id="L5841">        Report r = new Report(2505);</span>
<span class="nc" id="L5842">        r.subject = entity.getId();</span>
<span class="nc" id="L5843">        r.newlines = 0;</span>
<span class="nc" id="L5844">        r.indent(2);</span>
<span class="nc" id="L5845">        addReport(r);</span>
<span class="nc" id="L5846">        r = new Report(6310);</span>
<span class="nc" id="L5847">        r.subject = entity.getId();</span>
<span class="nc" id="L5848">        r.add(roll);</span>
<span class="nc" id="L5849">        r.newlines = 0;</span>
<span class="nc" id="L5850">        addReport(r);</span>
<span class="nc" id="L5851">        r = new Report(3340);</span>
<span class="nc" id="L5852">        r.add(modifier);</span>
<span class="nc" id="L5853">        r.subject = entity.getId();</span>
<span class="nc" id="L5854">        r.newlines = 0;</span>
<span class="nc" id="L5855">        addReport(r);</span>

<span class="nc" id="L5857">        r = new Report(1210);</span>
<span class="nc" id="L5858">        r.subject = entity.getId();</span>
<span class="nc" id="L5859">        roll += modifier;</span>
<span class="nc bnc" id="L5860" title="All 2 branches missed.">        if (roll &lt; 8) {</span>
<span class="nc" id="L5861">            r.messageId = 2506;</span>
            // minor fishtail, fail to turn
<span class="nc" id="L5863">            turnDirection = 0;</span>
<span class="nc bnc" id="L5864" title="All 2 branches missed.">        } else if (roll &lt; 10) {</span>
<span class="nc" id="L5865">            r.messageId = 2507;</span>
            // moderate fishtail, turn an extra hexside and roll for motive damage at -1.
<span class="nc bnc" id="L5867" title="All 2 branches missed.">            if (turnDirection == 0) {</span>
<span class="nc bnc" id="L5868" title="All 2 branches missed.">                turnDirection = Compute.d6() &lt; 4? -1 : 1;</span>
            } else {
<span class="nc" id="L5870">                turnDirection *= 2;</span>
            }
<span class="nc" id="L5872">            motiveDamage = true;</span>
<span class="nc" id="L5873">            motiveDamageMod = -1;</span>
<span class="nc bnc" id="L5874" title="All 2 branches missed.">        } else if (roll &lt; 12) {</span>
<span class="nc" id="L5875">            r.messageId = 2508;</span>
            // serious fishtail, turn an extra hexside and roll for motive damage. Turn ends.
<span class="nc bnc" id="L5877" title="All 2 branches missed.">            if (turnDirection == 0) {</span>
<span class="nc bnc" id="L5878" title="All 2 branches missed.">                turnDirection = Compute.d6() &lt; 4? -1 : 1;</span>
            } else {
<span class="nc" id="L5880">                turnDirection *= 2;</span>
            }
<span class="nc" id="L5882">            motiveDamage = true;</span>
<span class="nc" id="L5883">            turnEnds = true;</span>
        } else {
<span class="nc" id="L5885">            r.messageId = 2509;</span>
            // Turn fails and vehicle skids
            // Wheeled and naval vehicles start to flip if the roll is high enough.
<span class="nc bnc" id="L5888" title="All 2 branches missed.">            if (roll &gt; 13) {</span>
<span class="nc bnc" id="L5889" title="All 2 branches missed.">                if (entity.getMovementMode() == EntityMovementMode.WHEELED) {</span>
<span class="nc" id="L5890">                    r.messageId = 2510;</span>
<span class="nc" id="L5891">                    flip = true;</span>
<span class="nc bnc" id="L5892" title="All 2 branches missed.">                } else if (entity.getMovementMode() == EntityMovementMode.NAVAL</span>
<span class="nc bnc" id="L5893" title="All 2 branches missed.">                        || entity.getMovementMode() == EntityMovementMode.HYDROFOIL) {</span>
<span class="nc" id="L5894">                    entity.setDoomed(true);</span>
<span class="nc" id="L5895">                    r.messageId = 2511;</span>
                }
            }
<span class="nc" id="L5898">            skid = true;</span>
<span class="nc" id="L5899">            turnEnds = true;</span>
        }
<span class="nc" id="L5901">        addReport(r);</span>
<span class="nc" id="L5902">        entity.setFacing((entity.getFacing() + turnDirection + 6) % 6);</span>
<span class="nc" id="L5903">        entity.setSecondaryFacing(entity.getFacing());</span>
<span class="nc bnc" id="L5904" title="All 4 branches missed.">        if (motiveDamage &amp;&amp; isGroundVehicle) {</span>
<span class="nc" id="L5905">            addReport(vehicleMotiveDamage((Tank)entity, motiveDamageMod));</span>
        }
<span class="nc bnc" id="L5907" title="All 4 branches missed.">        if (skid &amp;&amp; !entity.isDoomed()) {</span>
<span class="nc bnc" id="L5908" title="All 4 branches missed.">            if (!flip &amp;&amp; isGroundVehicle) {</span>
<span class="nc" id="L5909">                addReport(vehicleMotiveDamage((Tank)entity, 0));</span>
            }

<span class="nc" id="L5912">            int skidDistance = (int)Math.round((double) (distance - 1) / 2);</span>
<span class="nc bnc" id="L5913" title="All 4 branches missed.">            if (flip &amp;&amp; entity.getMovementMode() == EntityMovementMode.WHEELED) {</span>
                // Wheeled vehicles that start to flip reduce the skid distance by one hex.
<span class="nc" id="L5915">                skidDistance--;</span>
<span class="nc bnc" id="L5916" title="All 2 branches missed.">            } else if (entity.getMovementMode() == EntityMovementMode.HOVER</span>
<span class="nc bnc" id="L5917" title="All 2 branches missed.">                    || entity.getMovementMode() == EntityMovementMode.VTOL</span>
<span class="nc bnc" id="L5918" title="All 2 branches missed.">                    || entity.getMovementMode() == EntityMovementMode.WIGE) {</span>
<span class="nc" id="L5919">                skidDistance = Math.min(marginOfFailure, distance);</span>
            }
<span class="nc bnc" id="L5921" title="All 2 branches missed.">            if (skidDistance &gt; 0) {</span>
<span class="nc" id="L5922">                int skidDirection = prevStep.getFacing();</span>
<span class="nc bnc" id="L5923" title="All 2 branches missed.">                if (isBackwards) {</span>
<span class="nc" id="L5924">                    skidDirection = (skidDirection + 3) % 6;</span>
                }
<span class="nc" id="L5926">                processSkid(entity, curPos, prevStep.getElevation(), skidDirection, skidDistance,</span>
                        prevStep, lastStepMoveType, flip);
            }
        }
<span class="nc" id="L5930">        return turnEnds;</span>
    }

    private void doVehicleFlipDamage(Tank entity, int damage, boolean startRight, int flipCount) {
        HitData hit;

<span class="nc" id="L5936">        int index = flipCount % 4;</span>
        // If there is no turret, we do side-side-bottom
<span class="nc bnc" id="L5938" title="All 2 branches missed.">        if (entity.hasNoTurret()) {</span>
<span class="nc" id="L5939">            index = flipCount % 3;</span>
<span class="nc bnc" id="L5940" title="All 2 branches missed.">            if (index &gt; 0) {</span>
<span class="nc" id="L5941">                index++;</span>
            }
        }
<span class="nc bnc" id="L5944" title="All 4 branches missed.">        switch (index) {</span>
            case 0:
<span class="nc bnc" id="L5946" title="All 2 branches missed.">                hit = new HitData(startRight ? Tank.LOC_RIGHT : Tank.LOC_LEFT);</span>
<span class="nc" id="L5947">                break;</span>
            case 1:
<span class="nc" id="L5949">                hit = new HitData(Tank.LOC_TURRET);</span>
<span class="nc" id="L5950">                break;</span>
            case 2:
<span class="nc bnc" id="L5952" title="All 2 branches missed.">                hit = new HitData(startRight ? Tank.LOC_LEFT : Tank.LOC_RIGHT);</span>
<span class="nc" id="L5953">                break;</span>
            default:
<span class="nc" id="L5955">                hit = null; //Motive damage instead</span>
        }
<span class="nc bnc" id="L5957" title="All 2 branches missed.">        if (hit != null) {</span>
<span class="nc" id="L5958">            hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L5959">            addReport(damageEntity(entity, hit, damage));</span>
            // If the vehicle has two turrets, they both take full damage.
<span class="nc bnc" id="L5961" title="All 4 branches missed.">            if ((hit.getLocation() == Tank.LOC_TURRET) &amp;&amp; !(entity.hasNoDualTurret())) {</span>
<span class="nc" id="L5962">                hit = new HitData(Tank.LOC_TURRET_2);</span>
<span class="nc" id="L5963">                hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L5964">                addReport(damageEntity(entity, hit, damage));</span>
            }
        } else {
<span class="nc" id="L5967">            addReport(vehicleMotiveDamage(entity, 1));</span>
        }
<span class="nc" id="L5969">    }</span>

    /**
     * processes a potential collision
     *
     * @param entity
     * @param target
     * @param src
     * @return
     */
    private boolean processCollision(Entity entity, Entity target, Coords src) {
        Report r;

<span class="nc" id="L5982">        r = new Report(9035);</span>
<span class="nc" id="L5983">        r.subject = entity.getId();</span>
<span class="nc" id="L5984">        r.add(entity.getDisplayName());</span>
<span class="nc" id="L5985">        r.add(target.getDisplayName());</span>
<span class="nc" id="L5986">        addReport(r);</span>
<span class="nc bnc" id="L5987" title="All 2 branches missed.">        boolean partial = (Compute.d6() == 6);</span>
        // if aero chance to avoid
<span class="nc bnc" id="L5989" title="All 2 branches missed.">        if ((target.isAero())</span>
<span class="nc bnc" id="L5990" title="All 2 branches missed.">            &amp;&amp; (target.mpUsed &lt; target.getRunMPwithoutMASC())</span>
<span class="nc bnc" id="L5991" title="All 4 branches missed.">            &amp;&amp; !((IAero) target).isOutControlTotal() &amp;&amp; !target.isImmobile()) {</span>
            // give them a control roll to avoid the collision
            // TODO : I should make this voluntary really
<span class="nc" id="L5994">            IAero ta = (IAero) target;</span>
<span class="nc" id="L5995">            PilotingRollData psr = target.getBasePilotingRoll();</span>
<span class="nc" id="L5996">            psr.addModifier(0, &quot;avoiding collision&quot;);</span>
<span class="nc" id="L5997">            int ctrlroll = Compute.d6(2);</span>
<span class="nc" id="L5998">            r = new Report(9045);</span>
<span class="nc" id="L5999">            r.subject = target.getId();</span>
<span class="nc" id="L6000">            r.add(target.getDisplayName());</span>
<span class="nc" id="L6001">            r.add(psr.getValue());</span>
<span class="nc" id="L6002">            r.add(ctrlroll);</span>
<span class="nc" id="L6003">            r.newlines = 0;</span>
<span class="nc" id="L6004">            r.indent(2);</span>
<span class="nc bnc" id="L6005" title="All 2 branches missed.">            if (ctrlroll &lt; psr.getValue()) {</span>
<span class="nc" id="L6006">                r.choose(false);</span>
<span class="nc" id="L6007">                addReport(r);</span>
            } else {
                // avoided collision
<span class="nc" id="L6010">                r.choose(true);</span>
<span class="nc" id="L6011">                addReport(r);</span>
                // two possibilities:
                // 1) the target already moved, but had MP left - check for
                // control roll conditions
                // 2) the target had not yet moved, move them in straight line
<span class="nc bnc" id="L6016" title="All 2 branches missed.">                if (!target.isDone()) {</span>
<span class="nc" id="L6017">                    int vel = ta.getCurrentVelocity();</span>
<span class="nc" id="L6018">                    MovePath md = new MovePath(game, target);</span>
<span class="nc bnc" id="L6019" title="All 2 branches missed.">                    while (vel &gt; 0) {</span>
<span class="nc" id="L6020">                        md.addStep(MoveStepType.FORWARDS);</span>
<span class="nc" id="L6021">                        vel--;</span>
                    }
<span class="nc" id="L6023">                    game.removeTurnFor(target);</span>
<span class="nc" id="L6024">                    send(createTurnVectorPacket());</span>
<span class="nc" id="L6025">                    processMovement(target, md, null);</span>
                    // for some reason it is not clearing out turn
<span class="nc" id="L6027">                } else {</span>
                    // what needs to get checked?
                    // this move puts them at over-thrust
<span class="nc" id="L6030">                    target.moved = EntityMovementType.MOVE_OVER_THRUST;</span>
                    // they may have exceeded SI, only add if they hadn't
                    // exceeded it before
<span class="nc bnc" id="L6033" title="All 2 branches missed.">                    if (target.mpUsed &lt;= ta.getSI()) {</span>
<span class="nc" id="L6034">                        PilotingRollData rollTarget = ta.checkThrustSITotal(</span>
<span class="nc" id="L6035">                                target.getRunMPwithoutMASC(), target.moved);</span>
<span class="nc bnc" id="L6036" title="All 2 branches missed.">                        if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L6037">                            game.addControlRoll(new PilotingRollData(</span>
<span class="nc" id="L6038">                                    target.getId(), 0,</span>
                                    &quot;Thrust spent during turn exceeds SI&quot;));
                        }
                    }
<span class="nc" id="L6042">                    target.mpUsed = target.getRunMPwithoutMASC();</span>
                }
<span class="nc" id="L6044">                return false;</span>
            }
<span class="nc" id="L6046">        } else {</span>
            // can't avoid collision - write report
<span class="nc" id="L6048">            r = new Report(9040);</span>
<span class="nc" id="L6049">            r.subject = entity.getId();</span>
<span class="nc" id="L6050">            r.add(entity.getDisplayName());</span>
<span class="nc" id="L6051">            r.indent(2);</span>
<span class="nc" id="L6052">            addReport(r);</span>
        }

        // if we are still here, then collide
<span class="nc" id="L6056">        ToHitData toHit = new ToHitData(TargetRoll.AUTOMATIC_SUCCESS, &quot;Its a collision&quot;);</span>
<span class="nc" id="L6057">        toHit.setSideTable(target.sideTable(src));</span>
<span class="nc" id="L6058">        resolveRamDamage((IAero)entity, target, toHit, partial, false);</span>

        // Has the target been destroyed?
<span class="nc bnc" id="L6061" title="All 2 branches missed.">        if (target.isDoomed()) {</span>
            // Has the target taken a turn?
<span class="nc bnc" id="L6063" title="All 2 branches missed.">            if (!target.isDone()) {</span>
                // Dead entities don't take turns.
<span class="nc" id="L6065">                game.removeTurnFor(target);</span>
<span class="nc" id="L6066">                send(createTurnVectorPacket());</span>
            } // End target-still-to-move
            // Clean out the entity.
<span class="nc" id="L6069">            target.setDestroyed(true);</span>
<span class="nc" id="L6070">            game.moveToGraveyard(target.getId());</span>
<span class="nc" id="L6071">            send(createRemoveEntityPacket(target.getId()));</span>
        }
        // Update the target's position,
        // unless it is off the game map.
<span class="nc bnc" id="L6075" title="All 2 branches missed.">        if (!game.isOutOfGame(target)) {</span>
<span class="nc" id="L6076">            entityUpdate(target.getId());</span>
        }

<span class="nc" id="L6079">        return true;</span>
    }

    private boolean checkCrash(Entity entity, Coords pos, int altitude) {
        // only Aeros can crash
<span class="nc bnc" id="L6084" title="All 2 branches missed.">        if (!entity.isAero()) {</span>
<span class="nc" id="L6085">            return false;</span>
        }
        // no crashing in space
<span class="nc bnc" id="L6088" title="All 2 branches missed.">        if (game.getBoard().inSpace()) {</span>
<span class="nc" id="L6089">            return false;</span>
        }
        // if aero on the ground map, then only crash if elevation is zero
<span class="nc bnc" id="L6092" title="All 2 branches missed.">        else if (game.getBoard().onGround()) {</span>
<span class="nc bnc" id="L6093" title="All 2 branches missed.">            return altitude &lt;= 0;</span>
        }
        // we must be in atmosphere
        // if we're off the map, assume hex ceiling 0
        // Hexes with elevations &lt; 0 are treated as 0 altitude
<span class="nc" id="L6098">        int ceiling = 0;</span>
<span class="nc bnc" id="L6099" title="All 2 branches missed.">        if (game.getBoard().getHex(pos) != null) {</span>
<span class="nc" id="L6100">            ceiling = Math.max(0, game.getBoard().getHex(pos).ceiling(true));</span>
        }
<span class="nc bnc" id="L6102" title="All 2 branches missed.">        return ceiling &gt;= altitude;</span>
    }

    private Vector&lt;Report&gt; processCrash(Entity entity, int vel, Coords c) {
<span class="nc" id="L6106">        Vector&lt;Report&gt; vReport = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc bnc" id="L6108" title="All 2 branches missed.">        if (c == null) {</span>
<span class="nc" id="L6109">            r = new Report(9701);</span>
<span class="nc" id="L6110">            r.subject = entity.getId();</span>
<span class="nc" id="L6111">            vReport.add(r);</span>
<span class="nc" id="L6112">            vReport.addAll(destroyEntity(entity, &quot;crashed off the map&quot;, true, true));</span>
<span class="nc" id="L6113">            return vReport;</span>
        }

<span class="nc bnc" id="L6116" title="All 2 branches missed.">        if (game.getBoard().inAtmosphere()) {</span>
<span class="nc" id="L6117">            r = new Report(9393, Report.PUBLIC);</span>
<span class="nc" id="L6118">            r.indent();</span>
<span class="nc" id="L6119">            r.addDesc(entity);</span>
<span class="nc" id="L6120">            vReport.add(r);</span>
<span class="nc" id="L6121">            entity.setDoomed(true);</span>
        } else {
<span class="nc" id="L6123">            ((IAero) entity).land();</span>
        }

        // we might hit multiple hexes, if we're a DropShip, so we do some
        // checks for all of them
<span class="nc" id="L6128">        List&lt;Coords&gt; coords = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L6129">        coords.add(c);</span>
<span class="nc" id="L6130">        IHex h = game.getBoard().getHex(c);</span>
        int crateredElevation;
<span class="nc" id="L6132">        boolean containsWater = false;</span>
<span class="nc bnc" id="L6133" title="All 2 branches missed.">        if (h.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L6134">            crateredElevation = Math.min(2, h.depth() + 1);</span>
<span class="nc" id="L6135">            containsWater = true;</span>
        } else {
<span class="nc" id="L6137">            crateredElevation = h.getLevel() - 2;</span>
        }
<span class="nc bnc" id="L6139" title="All 2 branches missed.">        if (entity instanceof Dropship) {</span>
<span class="nc bnc" id="L6140" title="All 2 branches missed.">            for (int i = 0; i &lt; 6; i++) {</span>
<span class="nc" id="L6141">                Coords adjCoords = c.translated(i);</span>
<span class="nc bnc" id="L6142" title="All 2 branches missed.">                if (!game.getBoard().contains(adjCoords)) {</span>
<span class="nc" id="L6143">                    continue;</span>
                }
<span class="nc" id="L6145">                IHex adjHex = game.getBoard().getHex(adjCoords);</span>
<span class="nc" id="L6146">                coords.add(adjCoords);</span>
<span class="nc bnc" id="L6147" title="All 2 branches missed.">                if (adjHex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc bnc" id="L6148" title="All 2 branches missed.">                    if (containsWater) {</span>
<span class="nc" id="L6149">                        int newDepth = Math.min(2, adjHex.depth() + 1);</span>
<span class="nc bnc" id="L6150" title="All 2 branches missed.">                        if (newDepth &gt; crateredElevation) {</span>
<span class="nc" id="L6151">                            crateredElevation = newDepth;</span>
                        }
<span class="nc" id="L6153">                    } else {</span>
<span class="nc" id="L6154">                        crateredElevation = Math.min(2, adjHex.depth() + 1);</span>
<span class="nc" id="L6155">                        containsWater = true;</span>
                    }
<span class="nc bnc" id="L6157" title="All 4 branches missed.">                } else if (!containsWater &amp;&amp; (adjHex.getLevel() &lt; crateredElevation)) {</span>
<span class="nc" id="L6158">                    crateredElevation = adjHex.getLevel();</span>
                }
            }
        }
        // Units with velocity zero are treated like that had velocity two
<span class="nc bnc" id="L6163" title="All 2 branches missed.">        if (vel &lt; 1) {</span>
<span class="nc" id="L6164">            vel = 2;</span>
        }

        // deal crash damage only once
<span class="nc" id="L6168">        boolean damageDealt = false;</span>
<span class="nc bnc" id="L6169" title="All 2 branches missed.">        for (Coords hitCoords : coords) {</span>
<span class="nc" id="L6170">            int orig_crash_damage = Compute.d6(2) * 10 * vel;</span>
<span class="nc" id="L6171">            int crash_damage = orig_crash_damage;</span>
<span class="nc" id="L6172">            int direction = entity.getFacing();</span>
            // first check for buildings
<span class="nc" id="L6174">            Building bldg = game.getBoard().getBuildingAt(hitCoords);</span>
<span class="nc bnc" id="L6175" title="All 4 branches missed.">            if ((null != bldg) &amp;&amp; (bldg.getType() == Building.HARDENED)) {</span>
<span class="nc" id="L6176">                crash_damage *= 2;</span>
            }
<span class="nc bnc" id="L6178" title="All 2 branches missed.">            if (null != bldg) {</span>
<span class="nc" id="L6179">                collapseBuilding(bldg, game.getPositionMap(), hitCoords, true, vReport);</span>
            }
<span class="nc bnc" id="L6181" title="All 2 branches missed.">            if (!damageDealt) {</span>
<span class="nc" id="L6182">                r = new Report(9700, Report.PUBLIC);</span>
<span class="nc" id="L6183">                r.indent();</span>
<span class="nc" id="L6184">                r.addDesc(entity);</span>
<span class="nc" id="L6185">                r.add(crash_damage);</span>
<span class="nc" id="L6186">                vReport.add(r);</span>
<span class="nc bnc" id="L6187" title="All 2 branches missed.">                while (crash_damage &gt; 0) {</span>
                    HitData hit;
<span class="nc bnc" id="L6189" title="All 4 branches missed.">                    if ((entity instanceof SmallCraft) &amp;&amp; ((SmallCraft) entity).isSpheroid()) {</span>
<span class="nc" id="L6190">                        hit = entity.rollHitLocation(ToHitData.HIT_SPHEROID_CRASH, ToHitData.SIDE_REAR);</span>
                    } else {
<span class="nc" id="L6192">                        hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
                    }

<span class="nc bnc" id="L6195" title="All 2 branches missed.">                    if (crash_damage &gt; 10) {</span>
<span class="nc" id="L6196">                        vReport.addAll(damageEntity(entity, hit, 10));</span>
                    } else {
<span class="nc" id="L6198">                        vReport.addAll(damageEntity(entity, hit, crash_damage));</span>
                    }
<span class="nc" id="L6200">                    crash_damage -= 10;</span>
<span class="nc" id="L6201">                }</span>
<span class="nc" id="L6202">                damageDealt = true;</span>
            }

            // ok, now lets cycle through the entities in this spot and
            // potentially
            // damage them
<span class="nc bnc" id="L6208" title="All 2 branches missed.">            for (Entity victim : game.getEntitiesVector(hitCoords)) {</span>
<span class="nc bnc" id="L6209" title="All 2 branches missed.">                if (victim.getId() == entity.getId()) {</span>
<span class="nc" id="L6210">                    continue;</span>
                }
<span class="nc bnc" id="L6212" title="All 2 branches missed.">                if (((victim.getElevation() &gt; 0) &amp;&amp; victim</span>
<span class="nc bnc" id="L6213" title="All 4 branches missed.">                        .isAirborneVTOLorWIGE()) || (victim.getAltitude() &gt; 0)) {</span>
<span class="nc" id="L6214">                    continue;</span>
                }
                // if the crasher is a DropShip and the victim is not a mech,
                // then it is automatically destroyed
<span class="nc bnc" id="L6218" title="All 4 branches missed.">                if ((entity instanceof Dropship) &amp;&amp; !(victim instanceof Mech)) {</span>
<span class="nc" id="L6219">                    vReport.addAll(destroyEntity(victim, &quot;hit by crashing DropShip&quot;));</span>
                } else {
<span class="nc" id="L6221">                    crash_damage = orig_crash_damage / 2;</span>
                    // roll dice to see if they got hit
<span class="nc" id="L6223">                    int target = 2;</span>
<span class="nc bnc" id="L6224" title="All 2 branches missed.">                    if (victim instanceof Infantry) {</span>
<span class="nc" id="L6225">                        target = 3;</span>
                    }
<span class="nc" id="L6227">                    int roll = Compute.d6();</span>
<span class="nc" id="L6228">                    r = new Report(9705, Report.PUBLIC);</span>
<span class="nc" id="L6229">                    r.indent();</span>
<span class="nc" id="L6230">                    r.addDesc(victim);</span>
<span class="nc" id="L6231">                    r.add(target);</span>
<span class="nc" id="L6232">                    r.add(crash_damage);</span>
<span class="nc" id="L6233">                    r.add(roll);</span>
<span class="nc bnc" id="L6234" title="All 2 branches missed.">                    if (roll &gt; target) {</span>
<span class="nc" id="L6235">                        r.choose(true);</span>
<span class="nc" id="L6236">                        vReport.add(r);</span>
                        // apply half the crash damage in 5 point clusters
                        // (check
                        // hit tables)
<span class="nc bnc" id="L6240" title="All 2 branches missed.">                        while (crash_damage &gt; 0) {</span>
<span class="nc" id="L6241">                            HitData hit = victim.rollHitLocation(</span>
                                    ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);
<span class="nc bnc" id="L6243" title="All 2 branches missed.">                            if (victim instanceof Mech) {</span>
<span class="nc" id="L6244">                                hit = victim.rollHitLocation(</span>
                                        ToHitData.HIT_PUNCH, ToHitData.SIDE_FRONT);
                            }
<span class="nc bnc" id="L6247" title="All 2 branches missed.">                            if (victim instanceof Protomech) {</span>
<span class="nc" id="L6248">                                hit = victim.rollHitLocation(</span>
                                        ToHitData.HIT_SPECIAL_PROTO, ToHitData.SIDE_FRONT);
                            }
<span class="nc bnc" id="L6251" title="All 2 branches missed.">                            if (crash_damage &gt; 5) {</span>
<span class="nc" id="L6252">                                vReport.addAll(damageEntity(victim, hit, 5));</span>
                            } else {
<span class="nc" id="L6254">                                vReport.addAll(damageEntity(victim, hit, crash_damage));</span>
                            }
<span class="nc" id="L6256">                            crash_damage -= 5;</span>
<span class="nc" id="L6257">                        }</span>

                    } else {
<span class="nc" id="L6260">                        r.choose(false);</span>
<span class="nc" id="L6261">                        vReport.add(r);</span>
                    }
                }

<span class="nc bnc" id="L6265" title="All 4 branches missed.">                if (!victim.isDoomed() &amp;&amp; !victim.isDestroyed()) {</span>
                    // entity displacement
<span class="nc" id="L6267">                    Coords dest = Compute.getValidDisplacement(game,</span>
<span class="nc" id="L6268">                                                               victim.getId(), hitCoords, direction);</span>
<span class="nc bnc" id="L6269" title="All 2 branches missed.">                    if (null != dest) {</span>
<span class="nc" id="L6270">                        doEntityDisplacement(</span>
                                victim,
                                hitCoords,
                                dest,
<span class="nc" id="L6274">                                new PilotingRollData(victim.getId(), 0, &quot;crash&quot;));</span>
<span class="nc bnc" id="L6275" title="All 2 branches missed.">                    } else if (!(victim instanceof Dropship)) {</span>
                        // destroy entity - but not dropships which are
                        // immovable
<span class="nc" id="L6278">                        addReport(destroyEntity(victim,</span>
                                                &quot;impossible displacement&quot;,
                                                victim instanceof Mech, victim instanceof Mech));
                    }
                }

<span class="nc" id="L6284">            }</span>

            // reduce woods
<span class="nc" id="L6287">            h = game.getBoard().getHex(hitCoords);</span>
<span class="nc bnc" id="L6288" title="All 2 branches missed.">            if (h.containsTerrain(Terrains.WOODS)) {</span>
<span class="nc bnc" id="L6289" title="All 2 branches missed.">                if (entity instanceof Dropship) {</span>
<span class="nc" id="L6290">                    h.removeTerrain(Terrains.WOODS);</span>
<span class="nc" id="L6291">                    h.removeTerrain(Terrains.FOLIAGE_ELEV);</span>
<span class="nc" id="L6292">                    h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                            Terrains.ROUGH, 1));
                } else {
<span class="nc" id="L6295">                    int level = h.terrainLevel(Terrains.WOODS) - 1;</span>
<span class="nc" id="L6296">                    int folEl = h.terrainLevel(Terrains.FOLIAGE_ELEV);</span>
<span class="nc" id="L6297">                    h.removeTerrain(Terrains.WOODS);</span>
<span class="nc bnc" id="L6298" title="All 2 branches missed.">                    if (level &gt; 0) {</span>
<span class="nc" id="L6299">                        h.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L6300">                                .createTerrain(Terrains.WOODS, level));</span>
<span class="nc" id="L6301">                        h.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc bnc" id="L6302" title="All 2 branches missed.">                                .createTerrain(Terrains.FOLIAGE_ELEV, folEl == 1 ? 1 : 2));</span>
                    } else {
<span class="nc" id="L6304">                        h.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L6305">                                             .createTerrain(Terrains.ROUGH, 1));</span>
<span class="nc" id="L6306">                        h.removeTerrain(Terrains.FOLIAGE_ELEV);</span>
                    }
                }
            }
            // do the same for jungles
<span class="nc bnc" id="L6311" title="All 2 branches missed.">            if (h.containsTerrain(Terrains.JUNGLE)) {</span>
<span class="nc bnc" id="L6312" title="All 2 branches missed.">                if (entity instanceof Dropship) {</span>
<span class="nc" id="L6313">                    h.removeTerrain(Terrains.JUNGLE);</span>
<span class="nc" id="L6314">                    h.removeTerrain(Terrains.FOLIAGE_ELEV);</span>
<span class="nc" id="L6315">                    h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                            Terrains.ROUGH, 1));
                } else {
<span class="nc" id="L6318">                    int level = h.terrainLevel(Terrains.JUNGLE) - 1;</span>
<span class="nc" id="L6319">                    int folEl = h.terrainLevel(Terrains.FOLIAGE_ELEV);</span>
<span class="nc" id="L6320">                    h.removeTerrain(Terrains.JUNGLE);</span>
<span class="nc bnc" id="L6321" title="All 2 branches missed.">                    if (level &gt; 0) {</span>
<span class="nc" id="L6322">                        h.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L6323">                                .createTerrain(Terrains.JUNGLE, level));</span>
<span class="nc" id="L6324">                        h.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc bnc" id="L6325" title="All 2 branches missed.">                                .createTerrain(Terrains.FOLIAGE_ELEV, folEl == 1 ? 1 : 2));</span>
                    } else {
<span class="nc" id="L6327">                        h.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L6328">                                             .createTerrain(Terrains.ROUGH, 1));</span>
<span class="nc" id="L6329">                        h.removeTerrain(Terrains.FOLIAGE_ELEV);</span>
                    }
                }
            }
<span class="nc bnc" id="L6333" title="All 2 branches missed.">            if (entity instanceof Dropship) {</span>
<span class="nc bnc" id="L6334" title="All 2 branches missed.">                if (!containsWater) {</span>
<span class="nc" id="L6335">                    h.setLevel(crateredElevation);</span>
                } else {
<span class="nc bnc" id="L6337" title="All 2 branches missed.">                    if (!h.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L6338">                        h.removeAllTerrains();</span>
                    }
<span class="nc" id="L6340">                    h.addTerrain(new Terrain(Terrains.WATER, crateredElevation,</span>
                                             false, 0));
                }
            }
<span class="nc" id="L6344">            sendChangedHex(hitCoords);</span>
<span class="nc" id="L6345">        }</span>

        // check for a stacking violation - which should only happen in the
        // case of grounded dropships, because they are not movable
<span class="nc bnc" id="L6349" title="All 2 branches missed.">        if (null != Compute.stackingViolation(game, entity.getId(), c)) {</span>
<span class="nc" id="L6350">            Coords dest = Compute.getValidDisplacement(game, entity.getId(), c,</span>
<span class="nc" id="L6351">                                                       Compute.d6() - 1);</span>
<span class="nc bnc" id="L6352" title="All 2 branches missed.">            if (null != dest) {</span>
<span class="nc" id="L6353">                doEntityDisplacement(entity, c, dest, null);</span>
            } else {
                // ack! automatic death! Tanks
                // suffer an ammo/power plant hit.
                // TODO : a Mech suffers a Head Blown Off crit.
<span class="nc" id="L6358">                vPhaseReport.addAll(destroyEntity(entity,</span>
                                                  &quot;impossible displacement&quot;, entity instanceof Mech,
                                                  entity instanceof Mech));
            }
        }

        // Check for watery death
<span class="nc" id="L6365">        h = game.getBoard().getHex(c);</span>
<span class="nc bnc" id="L6366" title="All 4 branches missed.">        if (h.containsTerrain(Terrains.WATER) &amp;&amp; !entity.isDestroyed()</span>
<span class="nc bnc" id="L6367" title="All 2 branches missed.">            &amp;&amp; !entity.isDoomed()) {</span>
            int lethalDepth;
<span class="nc bnc" id="L6369" title="All 2 branches missed.">            if (entity instanceof Dropship) {</span>
<span class="nc" id="L6370">                lethalDepth = 2;</span>
            } else {
<span class="nc" id="L6372">                lethalDepth = 1;</span>
            }

<span class="nc bnc" id="L6375" title="All 2 branches missed.">            if (h.depth() &gt;= lethalDepth) {</span>
                // Oh snap... we is dead
<span class="nc" id="L6377">                vReport.addAll(destroyEntity(entity,</span>
                                             &quot;crashing into deep water&quot;, true, true));
            }
        }

<span class="nc" id="L6382">        return vReport;</span>
    }

    /**
     * Process any flee movement actions, including flying off the map
     *
     * @param movePath   The move path which resulted in an entity leaving the map.
     * @param flewOff    whether this fleeing is a result of accidentally flying off the
     *                   map
     * @param returnable the number of rounds until the unit can return to the map (-1
     *                   if it can't return)
     * @return Vector of turn reports.
     */
    private Vector&lt;Report&gt; processLeaveMap(MovePath movePath, boolean flewOff, int returnable) {
<span class="nc" id="L6396">        Entity entity = movePath.getEntity();</span>
<span class="nc" id="L6397">        Vector&lt;Report&gt; vReport = new Vector&lt;&gt;();</span>
        Report r;
        // Unit has fled the battlefield.
<span class="nc" id="L6400">        r = new Report(2005, Report.PUBLIC);</span>
<span class="nc bnc" id="L6401" title="All 2 branches missed.">        if (flewOff) {</span>
<span class="nc" id="L6402">            r = new Report(9370, Report.PUBLIC);</span>
        }
<span class="nc" id="L6404">        r.addDesc(entity);</span>
<span class="nc" id="L6405">        addReport(r);</span>
        OffBoardDirection fleeDirection;
<span class="nc bnc" id="L6407" title="All 2 branches missed.">        if (movePath.getFinalCoords().getY() &lt;= 0) {</span>
<span class="nc" id="L6408">            fleeDirection = OffBoardDirection.NORTH;</span>
<span class="nc bnc" id="L6409" title="All 2 branches missed.">        } else if (movePath.getFinalCoords().getY() &gt;= (getGame().getBoard().getHeight() - 1)) {</span>
<span class="nc" id="L6410">            fleeDirection = OffBoardDirection.SOUTH;</span>
<span class="nc bnc" id="L6411" title="All 2 branches missed.">        } else if (movePath.getFinalCoords().getX() &lt;= 0) {</span>
<span class="nc" id="L6412">            fleeDirection = OffBoardDirection.WEST;</span>
        } else {
<span class="nc" id="L6414">            fleeDirection = OffBoardDirection.EAST;</span>
        }

<span class="nc bnc" id="L6417" title="All 2 branches missed.">        if (returnable &gt; -1) {</span>

<span class="nc" id="L6419">            entity.setDeployed(false);</span>
<span class="nc" id="L6420">            entity.setDeployRound(1 + game.getRoundCount() + returnable);</span>
<span class="nc" id="L6421">            entity.setPosition(null);</span>
<span class="nc" id="L6422">            entity.setDone(true);</span>
<span class="nc bnc" id="L6423" title="All 2 branches missed.">            if (entity.isAero()) {</span>
                // If we're flying off because we're OOC, when we come back we
                // should no longer be OOC
                // If we don't, this causes a major problem as aeros tend to
                // return, re-deploy then
                // fly off again instantly.
<span class="nc" id="L6429">                ((IAero) entity).setOutControl(false);</span>
            }
<span class="nc bnc" id="L6431" title="All 5 branches missed.">            switch (fleeDirection) {</span>
                case WEST:
<span class="nc" id="L6433">                    entity.setStartingPos(Board.START_W);</span>
<span class="nc" id="L6434">                    break;</span>
                case NORTH:
<span class="nc" id="L6436">                    entity.setStartingPos(Board.START_N);</span>
<span class="nc" id="L6437">                    break;</span>
                case EAST:
<span class="nc" id="L6439">                    entity.setStartingPos(Board.START_E);</span>
<span class="nc" id="L6440">                    break;</span>
                case SOUTH:
<span class="nc" id="L6442">                    entity.setStartingPos(Board.START_S);</span>
<span class="nc" id="L6443">                    break;</span>
                default:
<span class="nc" id="L6445">                    entity.setStartingPos(Board.START_EDGE);</span>
            }
<span class="nc" id="L6447">            entityUpdate(entity.getId());</span>
<span class="nc" id="L6448">            return vReport;</span>
        }

        // Is the unit carrying passengers or trailers?
<span class="nc" id="L6452">        final List&lt;Entity&gt; passengers = new ArrayList&lt;&gt;(entity.getLoadedUnits());</span>
<span class="nc bnc" id="L6453" title="All 2 branches missed.">        if (!entity.getAllTowedUnits().isEmpty()) {</span>
<span class="nc bnc" id="L6454" title="All 2 branches missed.">            for (int id : entity.getAllTowedUnits()) {</span>
<span class="nc" id="L6455">                Entity towed = game.getEntity(id);</span>
<span class="nc" id="L6456">                passengers.add(towed);</span>
<span class="nc" id="L6457">            }</span>
        }
<span class="nc bnc" id="L6459" title="All 2 branches missed.">        if (!passengers.isEmpty()) {</span>
<span class="nc bnc" id="L6460" title="All 2 branches missed.">            for (Entity passenger : passengers) {</span>
                // Unit has fled the battlefield.
<span class="nc" id="L6462">                r = new Report(2010, Report.PUBLIC);</span>
<span class="nc" id="L6463">                r.indent();</span>
<span class="nc" id="L6464">                r.addDesc(passenger);</span>
<span class="nc" id="L6465">                addReport(r);</span>
<span class="nc" id="L6466">                passenger.setRetreatedDirection(fleeDirection);</span>
<span class="nc" id="L6467">                game.removeEntity(passenger.getId(),</span>
                                  IEntityRemovalConditions.REMOVE_IN_RETREAT);
<span class="nc" id="L6469">                send(createRemoveEntityPacket(passenger.getId(),</span>
                                              IEntityRemovalConditions.REMOVE_IN_RETREAT));
<span class="nc" id="L6471">            }</span>
        }

        // Handle any picked up MechWarriors
<span class="nc bnc" id="L6475" title="All 2 branches missed.">        for (Integer mechWarriorId : entity.getPickedUpMechWarriors()) {</span>
<span class="nc" id="L6476">            Entity mw = game.getEntity(mechWarriorId);</span>
            
<span class="nc bnc" id="L6478" title="All 2 branches missed.">            if(mw == null) {</span>
<span class="nc" id="L6479">                continue;</span>
            }

            // Is the MechWarrior an enemy?
<span class="nc" id="L6483">            int condition = IEntityRemovalConditions.REMOVE_IN_RETREAT;</span>
<span class="nc" id="L6484">            r = new Report(2010);</span>
<span class="nc bnc" id="L6485" title="All 2 branches missed.">            if (mw.isCaptured()) {</span>
<span class="nc" id="L6486">                r = new Report(2015);</span>
<span class="nc" id="L6487">                condition = IEntityRemovalConditions.REMOVE_CAPTURED;</span>
            } else {
<span class="nc" id="L6489">                mw.setRetreatedDirection(fleeDirection);</span>
            }
<span class="nc" id="L6491">            game.removeEntity(mw.getId(), condition);</span>
<span class="nc" id="L6492">            send(createRemoveEntityPacket(mw.getId(), condition));</span>
<span class="nc" id="L6493">            r.addDesc(mw);</span>
<span class="nc" id="L6494">            r.indent();</span>
<span class="nc" id="L6495">            addReport(r);</span>
<span class="nc" id="L6496">        }</span>
        // Is the unit being swarmed?
<span class="nc" id="L6498">        final int swarmerId = entity.getSwarmAttackerId();</span>
<span class="nc bnc" id="L6499" title="All 2 branches missed.">        if (Entity.NONE != swarmerId) {</span>
<span class="nc" id="L6500">            final Entity swarmer = game.getEntity(swarmerId);</span>

            // Has the swarmer taken a turn?
<span class="nc bnc" id="L6503" title="All 2 branches missed.">            if (!swarmer.isDone()) {</span>
                // Dead entities don't take turns.
<span class="nc" id="L6505">                game.removeTurnFor(swarmer);</span>
<span class="nc" id="L6506">                send(createTurnVectorPacket());</span>

            } // End swarmer-still-to-move

            // Unit has fled the battlefield.
<span class="nc" id="L6511">            swarmer.setSwarmTargetId(Entity.NONE);</span>
<span class="nc" id="L6512">            entity.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L6513">            r = new Report(2015, Report.PUBLIC);</span>
<span class="nc" id="L6514">            r.indent();</span>
<span class="nc" id="L6515">            r.addDesc(swarmer);</span>
<span class="nc" id="L6516">            addReport(r);</span>
<span class="nc" id="L6517">            game.removeEntity(swarmerId, IEntityRemovalConditions.REMOVE_CAPTURED);</span>
<span class="nc" id="L6518">            send(createRemoveEntityPacket(swarmerId, IEntityRemovalConditions.REMOVE_CAPTURED));</span>
        }
<span class="nc" id="L6520">        entity.setRetreatedDirection(fleeDirection);</span>
<span class="nc" id="L6521">        game.removeEntity(entity.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT);</span>
<span class="nc" id="L6522">        send(createRemoveEntityPacket(entity.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT));</span>
<span class="nc" id="L6523">        return vReport;</span>
    }

    /**
     * Steps through an entity movement packet, executing it.
     *
     * @param entity   The Entity that is moving
     * @param md       The MovePath that defines how the Entity moves
     * @param losCache A cache that stores Los between various Entities and
     *                 targets.  In double blind games, we may need to compute a
     *                 lot of LosEffects, so caching them can really speed
     *                 things up.
     */
    private void processMovement(Entity entity, MovePath md, Map&lt;EntityTargetPair,
            LosEffects&gt; losCache) {
        // Make sure the cache isn't null
<span class="nc bnc" id="L6539" title="All 2 branches missed.">        if (losCache == null) {</span>
<span class="nc" id="L6540">            losCache = new HashMap&lt;&gt;();</span>
        }
        Report r;
<span class="nc" id="L6543">        boolean sideslipped = false; // for VTOL side slipping</span>
        PilotingRollData rollTarget;

        // check for fleeing
<span class="nc bnc" id="L6547" title="All 2 branches missed.">        if (md.contains(MoveStepType.FLEE)) {</span>
<span class="nc" id="L6548">            addReport(processLeaveMap(md, false, -1));</span>
<span class="nc" id="L6549">            return;</span>
        }

<span class="nc bnc" id="L6552" title="All 2 branches missed.">        if (md.contains(MoveStepType.EJECT)) {</span>
<span class="nc bnc" id="L6553" title="All 4 branches missed.">            if (entity.isLargeCraft() &amp;&amp; !entity.isCarcass()) {</span>
<span class="nc" id="L6554">                r = new Report(2026);</span>
<span class="nc" id="L6555">                r.subject = entity.getId();</span>
<span class="nc" id="L6556">                r.addDesc(entity);</span>
<span class="nc" id="L6557">                addReport(r);</span>
<span class="nc" id="L6558">                Aero ship = (Aero) entity;</span>
<span class="nc" id="L6559">                ship.setEjecting(true);</span>
<span class="nc" id="L6560">                entityUpdate(ship.getId());</span>
<span class="nc" id="L6561">                Coords legalPos = entity.getPosition();</span>
                //Get the step so we can pass it in and get the abandon coords from it
<span class="nc" id="L6563">                for (final Enumeration&lt;MoveStep&gt; i = md.getSteps(); i</span>
<span class="nc bnc" id="L6564" title="All 2 branches missed.">                        .hasMoreElements();) {</span>
<span class="nc" id="L6565">                    final MoveStep step = i.nextElement();</span>
<span class="nc bnc" id="L6566" title="All 2 branches missed.">                    if (step.getType() == MoveStepType.EJECT) {</span>
<span class="nc" id="L6567">                        legalPos = step.getTargetPosition();</span>
                    }
<span class="nc" id="L6569">                }</span>
<span class="nc bnc" id="L6570" title="All 4 branches missed.">                addReport(ejectSpacecraft(ship, ship.isSpaceborne(), (ship.isAirborne() &amp;&amp; !ship.isSpaceborne()),legalPos));</span>
                //If we're grounded or destroyed by crew loss, end movement
<span class="nc bnc" id="L6572" title="All 6 branches missed.">                if (entity.isDoomed() || (!entity.isSpaceborne() &amp;&amp; !entity.isAirborne())) {</span>
<span class="nc" id="L6573">                    return;</span>
                }
<span class="nc bnc" id="L6575" title="All 4 branches missed.">            } else if ((entity instanceof Mech) || (entity instanceof Aero)) {</span>
<span class="nc" id="L6576">                r = new Report(2020);</span>
<span class="nc" id="L6577">                r.subject = entity.getId();</span>
<span class="nc" id="L6578">                r.add(entity.getCrew().getName());</span>
<span class="nc" id="L6579">                r.addDesc(entity);</span>
<span class="nc" id="L6580">                addReport(r);</span>
<span class="nc" id="L6581">                addReport(ejectEntity(entity, false));</span>
<span class="nc" id="L6582">                return;</span>
<span class="nc bnc" id="L6583" title="All 4 branches missed.">            } else if ((entity instanceof Tank) &amp;&amp; !entity.isCarcass()) {</span>
<span class="nc" id="L6584">                r = new Report(2025);</span>
<span class="nc" id="L6585">                r.subject = entity.getId();</span>
<span class="nc" id="L6586">                r.addDesc(entity);</span>
<span class="nc" id="L6587">                addReport(r);</span>
<span class="nc" id="L6588">                addReport(ejectEntity(entity, false));</span>
<span class="nc" id="L6589">                return;</span>
            }
        }

<span class="nc bnc" id="L6593" title="All 2 branches missed.">        if (md.contains(MoveStepType.CAREFUL_STAND)) {</span>
<span class="nc" id="L6594">            entity.setCarefulStand(true);</span>
        }
<span class="nc bnc" id="L6596" title="All 2 branches missed.">        if (md.contains(MoveStepType.BACKWARDS)) {</span>
<span class="nc" id="L6597">            entity.setMovedBackwards(true);</span>
<span class="nc bnc" id="L6598" title="All 2 branches missed.">            if (md.getMpUsed() &gt; entity.getWalkMP()) {</span>
<span class="nc" id="L6599">                entity.setPowerReverse(true);</span>
            }
        }

<span class="nc bnc" id="L6603" title="All 4 branches missed.">        if (md.contains(MoveStepType.TAKEOFF) &amp;&amp; entity.isAero()) {</span>
<span class="nc" id="L6604">            IAero a = (IAero) entity;</span>
<span class="nc" id="L6605">            a.setCurrentVelocity(1);</span>
<span class="nc" id="L6606">            a.liftOff(1);</span>
<span class="nc bnc" id="L6607" title="All 2 branches missed.">            if (entity instanceof Dropship) {</span>
<span class="nc" id="L6608">                applyDropShipProximityDamage(md.getFinalCoords(), true, md.getFinalFacing(), entity);</span>
            }
<span class="nc" id="L6610">            checkForTakeoffDamage(a);</span>
<span class="nc" id="L6611">            entity.setPosition(entity.getPosition().translated(entity.getFacing(), a.getTakeOffLength()));</span>
<span class="nc" id="L6612">            entity.setDone(true);</span>
<span class="nc" id="L6613">            entityUpdate(entity.getId());</span>
<span class="nc" id="L6614">            return;</span>
        }

<span class="nc bnc" id="L6617" title="All 4 branches missed.">        if (md.contains(MoveStepType.VTAKEOFF) &amp;&amp; entity.isAero()) {</span>
<span class="nc" id="L6618">            IAero a = (IAero) entity;</span>
<span class="nc" id="L6619">            rollTarget = a.checkVerticalTakeOff();</span>
<span class="nc bnc" id="L6620" title="All 2 branches missed.">            if (doVerticalTakeOffCheck(entity, rollTarget)) {</span>
<span class="nc" id="L6621">                a.setCurrentVelocity(0);</span>
<span class="nc" id="L6622">                a.liftOff(1);</span>
<span class="nc bnc" id="L6623" title="All 2 branches missed.">                if (entity instanceof Dropship) {</span>
<span class="nc" id="L6624">                    applyDropShipProximityDamage(md.getFinalCoords(), (Dropship)a);</span>
                }
<span class="nc" id="L6626">                checkForTakeoffDamage(a);</span>
            }
<span class="nc" id="L6628">            entity.setDone(true);</span>
<span class="nc" id="L6629">            entityUpdate(entity.getId());</span>
<span class="nc" id="L6630">            return;</span>
        }

<span class="nc bnc" id="L6633" title="All 4 branches missed.">        if (md.contains(MoveStepType.LAND) &amp;&amp; entity.isAero()) {</span>
<span class="nc" id="L6634">            IAero a = (IAero) entity;</span>
<span class="nc" id="L6635">            rollTarget = a.checkLanding(md.getLastStepMovementType(), md.getFinalVelocity(),</span>
<span class="nc" id="L6636">                    md.getFinalCoords(), md.getFinalFacing(), false);</span>
<span class="nc" id="L6637">            attemptLanding(entity, rollTarget);</span>
<span class="nc" id="L6638">            a.land();</span>
<span class="nc" id="L6639">            entity.setPosition(md.getFinalCoords().translated(md.getFinalFacing(),</span>
<span class="nc" id="L6640">                    a.getLandingLength()));</span>
<span class="nc" id="L6641">            entity.setDone(true);</span>
<span class="nc" id="L6642">            entityUpdate(entity.getId());</span>
<span class="nc" id="L6643">            return;</span>
        }

<span class="nc bnc" id="L6646" title="All 4 branches missed.">        if (md.contains(MoveStepType.VLAND) &amp;&amp; entity.isAero()) {</span>
<span class="nc" id="L6647">            IAero a = (IAero) entity;</span>
<span class="nc" id="L6648">            rollTarget = a.checkLanding(md.getLastStepMovementType(),</span>
<span class="nc" id="L6649">                    md.getFinalVelocity(), md.getFinalCoords(),</span>
<span class="nc" id="L6650">                    md.getFinalFacing(), true);</span>
<span class="nc" id="L6651">            attemptLanding(entity, rollTarget);</span>
<span class="nc bnc" id="L6652" title="All 2 branches missed.">            if (entity instanceof Dropship) {</span>
<span class="nc" id="L6653">                applyDropShipLandingDamage(md.getFinalCoords(), (Dropship)a);</span>
            }
<span class="nc" id="L6655">            a.land();</span>
<span class="nc" id="L6656">            entity.setPosition(md.getFinalCoords());</span>
<span class="nc" id="L6657">            entity.setDone(true);</span>
<span class="nc" id="L6658">            entityUpdate(entity.getId());</span>
<span class="nc" id="L6659">            return;</span>
        }

        // okay, proceed with movement calculations
<span class="nc" id="L6663">        Coords lastPos = entity.getPosition();</span>
<span class="nc" id="L6664">        Coords curPos = entity.getPosition();</span>
<span class="nc" id="L6665">        int curFacing = entity.getFacing();</span>
<span class="nc" id="L6666">        int curVTOLElevation = entity.getElevation();</span>
        int curElevation;
<span class="nc" id="L6668">        int lastElevation = entity.getElevation();</span>
<span class="nc" id="L6669">        int curAltitude = entity.getAltitude();</span>
<span class="nc" id="L6670">        boolean curClimbMode = entity.climbMode();</span>
        // if the entity already used some MPs,
        // it previously tried to get up and fell,
        // and then got another turn. set moveType
        // and overallMoveType accordingly
        // (these are all cleared by Entity.newRound)
<span class="nc" id="L6676">        int distance = entity.delta_distance;</span>
<span class="nc" id="L6677">        int mpUsed = entity.mpUsed;</span>
<span class="nc" id="L6678">        EntityMovementType moveType = entity.moved;</span>
        EntityMovementType overallMoveType;
        boolean firstStep;
<span class="nc" id="L6681">        boolean wasProne = entity.isProne();</span>
<span class="nc" id="L6682">        boolean fellDuringMovement = false;</span>
<span class="nc" id="L6683">        boolean crashedDuringMovement = false;</span>
<span class="nc" id="L6684">        boolean dropshipStillUnloading = false;</span>
        boolean turnOver;
<span class="nc" id="L6686">        int prevFacing = curFacing;</span>
<span class="nc" id="L6687">        IHex prevHex = game.getBoard().getHex(curPos);</span>
<span class="nc" id="L6688">        final boolean isInfantry = entity instanceof Infantry;</span>
<span class="nc" id="L6689">        AttackAction charge = null;</span>
<span class="nc" id="L6690">        RamAttackAction ram = null;</span>
        // cache this here, otherwise changing MP in the turn causes
        // erroneous gravity PSRs
<span class="nc" id="L6693">        int cachedGravityLimit = -1;</span>
<span class="nc" id="L6694">        int thrustUsed = 0;</span>
<span class="nc" id="L6695">        int j = 0;</span>
        boolean didMove;
<span class="nc" id="L6697">        boolean recovered = false;</span>
<span class="nc" id="L6698">        Entity loader = null;</span>
<span class="nc" id="L6699">        boolean continueTurnFromPBS = false;</span>
<span class="nc" id="L6700">        boolean continueTurnFromFishtail = false;</span>
<span class="nc" id="L6701">        boolean continueTurnFromLevelDrop = false;</span>
<span class="nc" id="L6702">        boolean continueTurnFromCliffAscent = false;</span>

        // get a list of coordinates that the unit passed through this turn
        // so that I can later recover potential bombing targets
        // it may already have some values
<span class="nc" id="L6707">        Vector&lt;Coords&gt; passedThrough = entity.getPassedThrough();</span>
<span class="nc" id="L6708">        passedThrough.add(curPos);</span>
<span class="nc" id="L6709">        List&lt;Integer&gt; passedThroughFacing = entity.getPassedThroughFacing();</span>
<span class="nc" id="L6710">        passedThroughFacing.add(curFacing);</span>

        // Compile the move - don't clip
        // Clipping could affect hidden units; illegal steps aren't processed
<span class="nc" id="L6714">        md.compile(game, entity, false);</span>

        // if advanced movement is being used then set the new vectors based on
        // move path
<span class="nc" id="L6718">        entity.setVectors(md.getFinalVectors());</span>

<span class="nc" id="L6720">        overallMoveType = md.getLastStepMovementType();</span>

        // check for starting in liquid magma
<span class="nc" id="L6723">        if ((game.getBoard().getHex(entity.getPosition())</span>
<span class="nc bnc" id="L6724" title="All 2 branches missed.">                .terrainLevel(Terrains.MAGMA) == 2)</span>
<span class="nc bnc" id="L6725" title="All 2 branches missed.">                &amp;&amp; (entity.getElevation() == 0)) {</span>
<span class="nc" id="L6726">            doMagmaDamage(entity, false);</span>
        }

        // set acceleration used to default
<span class="nc bnc" id="L6730" title="All 2 branches missed.">        if (entity.isAero()) {</span>
<span class="nc" id="L6731">            ((IAero)entity).setAccLast(false);</span>
        }

        // check for dropping troops and drop them
<span class="nc bnc" id="L6735" title="All 4 branches missed.">        if (entity.isDropping() &amp;&amp; !md.contains(MoveStepType.HOVER)) {</span>
<span class="nc" id="L6736">            entity.setAltitude(entity.getAltitude() - game.getPlanetaryConditions().getDropRate());</span>
            // they may have changed their facing
<span class="nc bnc" id="L6738" title="All 2 branches missed.">            if (md.length() &gt; 0) {</span>
<span class="nc" id="L6739">                entity.setFacing(md.getFinalFacing());</span>
            }
<span class="nc" id="L6741">            passedThrough.add(entity.getPosition());</span>
<span class="nc" id="L6742">            entity.setPassedThrough(passedThrough);</span>
<span class="nc" id="L6743">            passedThroughFacing.add(entity.getFacing());</span>
<span class="nc" id="L6744">            entity.setPassedThroughFacing(passedThroughFacing);</span>
            // We may still need to process any conversions for dropping LAMs
<span class="nc bnc" id="L6746" title="All 4 branches missed.">            if (entity instanceof LandAirMech &amp;&amp; md.contains(MoveStepType.CONVERT_MODE)) {</span>
<span class="nc" id="L6747">                entity.setMovementMode(md.getFinalConversionMode());</span>
<span class="nc" id="L6748">                entity.setConvertingNow(true);</span>
<span class="nc" id="L6749">                r = new Report(1210);</span>
<span class="nc" id="L6750">                r.subject = entity.getId();</span>
<span class="nc" id="L6751">                r.addDesc(entity);</span>
<span class="nc bnc" id="L6752" title="All 2 branches missed.">                if (entity.getMovementMode() == EntityMovementMode.WIGE) {</span>
<span class="nc" id="L6753">                    r.messageId = 2452;</span>
<span class="nc bnc" id="L6754" title="All 2 branches missed.">                } else if (entity.getMovementMode() == EntityMovementMode.AERODYNE) {</span>
<span class="nc" id="L6755">                    r.messageId = 2453;</span>
                } else {
<span class="nc" id="L6757">                    r.messageId = 2450;</span>
                }
<span class="nc" id="L6759">                addReport(r);</span>
            }
<span class="nc" id="L6761">            entity.setDone(true);</span>
<span class="nc" id="L6762">            entityUpdate(entity.getId());</span>
<span class="nc" id="L6763">            return;</span>
        }
        
        // iterate through steps
<span class="nc" id="L6767">        firstStep = true;</span>
<span class="nc" id="L6768">        turnOver = false;</span>
        /* Bug 754610: Revert fix for bug 702735. */
<span class="nc" id="L6770">        MoveStep prevStep = null;</span>

<span class="nc" id="L6772">        List&lt;Entity&gt; hiddenEnemies = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L6773" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_HIDDEN_UNITS)) {</span>
<span class="nc bnc" id="L6774" title="All 2 branches missed.">            for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L6775" title="All 6 branches missed.">                if (e.isHidden() &amp;&amp; e.isEnemyOf(entity) &amp;&amp; (e.getPosition() != null)) {</span>
<span class="nc" id="L6776">                    hiddenEnemies.add(e);</span>
                }
<span class="nc" id="L6778">            }</span>
        }

<span class="nc" id="L6781">        Vector&lt;UnitLocation&gt; movePath = new Vector&lt;&gt;();</span>
<span class="nc" id="L6782">        EntityMovementType lastStepMoveType = md.getLastStepMovementType();</span>
<span class="nc bnc" id="L6783" title="All 2 branches missed.">        for (final Enumeration&lt;MoveStep&gt; i = md.getSteps(); i.hasMoreElements();) {</span>
<span class="nc" id="L6784">            final MoveStep step = i.nextElement();</span>
<span class="nc" id="L6785">            EntityMovementType stepMoveType = step.getMovementType(md.isEndStep(step));</span>
<span class="nc" id="L6786">            wasProne = entity.isProne();</span>
<span class="nc" id="L6787">            boolean isPavementStep = step.isPavementStep();</span>
<span class="nc" id="L6788">            entity.inReverse = step.isThisStepBackwards();</span>
<span class="nc" id="L6789">            boolean entityFellWhileAttemptingToStand = false;</span>
<span class="nc bnc" id="L6790" title="All 2 branches missed.">            boolean isOnGround = !i.hasMoreElements();</span>
<span class="nc bnc" id="L6791" title="All 2 branches missed.">            isOnGround |= stepMoveType != EntityMovementType.MOVE_JUMP;</span>
<span class="nc bnc" id="L6792" title="All 2 branches missed.">            isOnGround &amp;= step.getElevation() &lt; 1;</span>

            // Check for hidden units point blank shots
<span class="nc bnc" id="L6795" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_HIDDEN_UNITS)) {</span>
<span class="nc bnc" id="L6796" title="All 2 branches missed.">                for (Entity e : hiddenEnemies) {</span>
<span class="nc" id="L6797">                    int dist = e.getPosition().distance(step.getPosition());</span>
                    // Checking for same hex and stacking violation
<span class="nc bnc" id="L6799" title="All 4 branches missed.">                    if ((dist == 0) &amp;&amp; !continueTurnFromPBS</span>
<span class="nc bnc" id="L6800" title="All 2 branches missed.">                            &amp;&amp; (Compute.stackingViolation(game, entity.getId(),</span>
<span class="nc" id="L6801">                                    step.getPosition()) != null)) {</span>
                        // Moving into hex of a hidden unit detects the unit
<span class="nc" id="L6803">                        e.setHidden(false);</span>
<span class="nc" id="L6804">                        entityUpdate(e.getId());</span>
<span class="nc" id="L6805">                        r = new Report(9960);</span>
<span class="nc" id="L6806">                        r.addDesc(entity);</span>
<span class="nc" id="L6807">                        r.subject = entity.getId();</span>
<span class="nc" id="L6808">                        r.add(e.getPosition().getBoardNum());</span>
<span class="nc" id="L6809">                        vPhaseReport.addElement(r);</span>
                        // Report the block
<span class="nc bnc" id="L6811" title="All 2 branches missed.">                        if (doBlind()) {</span>
<span class="nc" id="L6812">                            r = new Report(9961);</span>
<span class="nc" id="L6813">                            r.subject = e.getId();</span>
<span class="nc" id="L6814">                            r.addDesc(e);</span>
<span class="nc" id="L6815">                            r.addDesc(entity);</span>
<span class="nc" id="L6816">                            r.add(step.getPosition().getBoardNum());</span>
<span class="nc" id="L6817">                            addReport(r);</span>
                        }
                        // Report halted movement
<span class="nc" id="L6820">                        r = new Report(9962);</span>
<span class="nc" id="L6821">                        r.subject = entity.getId();</span>
<span class="nc" id="L6822">                        r.addDesc(entity);</span>
<span class="nc" id="L6823">                        r.add(step.getPosition().getBoardNum());</span>
<span class="nc" id="L6824">                        addReport(r);</span>
<span class="nc" id="L6825">                        addNewLines();</span>
<span class="nc" id="L6826">                        Report.addNewline(vPhaseReport);</span>
                        // If we aren't at the end, send a special report
<span class="nc bnc" id="L6828" title="All 2 branches missed.">                        if ((game.getTurnIndex() + 1) &lt; game.getTurnVector().size()) {</span>
<span class="nc" id="L6829">                            send(e.getOwner().getId(), createSpecialReportPacket());</span>
<span class="nc" id="L6830">                            send(entity.getOwner().getId(), createSpecialReportPacket());</span>
                        }
<span class="nc" id="L6832">                        entity.setDone(true);</span>
<span class="nc" id="L6833">                        entityUpdate(entity.getId(), movePath, true, losCache);</span>
<span class="nc" id="L6834">                        return;</span>
                        // Potential point-blank shot
<span class="nc bnc" id="L6836" title="All 4 branches missed.">                    } else if ((dist == 1) &amp;&amp; !e.madePointblankShot()) {</span>
<span class="nc" id="L6837">                        entity.setPosition(step.getPosition());</span>
<span class="nc" id="L6838">                        entity.setFacing(step.getFacing());</span>
                        // If not set, BV icons could have wrong facing
<span class="nc" id="L6840">                        entity.setSecondaryFacing(step.getFacing());</span>
                        // Update entity position on client
<span class="nc" id="L6842">                        send(e.getOwnerId(), createEntityPacket(entity.getId(), null));</span>
<span class="nc" id="L6843">                        boolean tookPBS = processPointblankShotCFR(e, entity);</span>
                        // Movement should be interrupted
<span class="nc bnc" id="L6845" title="All 2 branches missed.">                        if (tookPBS) {</span>
                            // Attacking reveals hidden unit
<span class="nc" id="L6847">                            e.setHidden(false);</span>
<span class="nc" id="L6848">                            entityUpdate(e.getId());</span>
<span class="nc" id="L6849">                            r = new Report(9960);</span>
<span class="nc" id="L6850">                            r.addDesc(entity);</span>
<span class="nc" id="L6851">                            r.subject = entity.getId();</span>
<span class="nc" id="L6852">                            r.add(e.getPosition().getBoardNum());</span>
<span class="nc" id="L6853">                            vPhaseReport.addElement(r);</span>
<span class="nc" id="L6854">                            continueTurnFromPBS = true;</span>

<span class="nc" id="L6856">                            curFacing = entity.getFacing();</span>
<span class="nc" id="L6857">                            curPos = entity.getPosition();</span>
<span class="nc" id="L6858">                            mpUsed = step.getMpUsed();</span>
<span class="nc" id="L6859">                            break;</span>
                        }
                    }
<span class="nc" id="L6862">                }</span>
            }

            // stop for illegal movement
<span class="nc bnc" id="L6866" title="All 2 branches missed.">            if (stepMoveType == EntityMovementType.MOVE_ILLEGAL) {</span>
<span class="nc" id="L6867">                break;</span>
            }

            // stop if the entity already killed itself
<span class="nc bnc" id="L6871" title="All 4 branches missed.">            if (entity.isDestroyed() || entity.isDoomed()) {</span>
<span class="nc" id="L6872">                break;</span>
            }

<span class="nc bnc" id="L6875" title="All 2 branches missed.">            if (entity.getMovementMode() == EntityMovementMode.WIGE) {</span>
<span class="nc bnc" id="L6876" title="All 4 branches missed.">                if (step.getType() == MoveStepType.UP &amp;&amp; !entity.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L6877">                    entity.setWigeLiftoffHover(true);</span>
<span class="nc bnc" id="L6878" title="All 2 branches missed.">                } else if (step.getType() == MoveStepType.HOVER) {</span>
<span class="nc" id="L6879">                    entity.setWigeLiftoffHover(true);</span>
<span class="nc" id="L6880">                    entity.setAssaultDropInProgress(false);</span>
<span class="nc bnc" id="L6881" title="All 4 branches missed.">                } else if (step.getType() == MoveStepType.DOWN &amp;&amp; step.getClearance() == 0) {</span>
                    // If this is the first step, use the Entity's starting elevation
<span class="nc bnc" id="L6883" title="All 2 branches missed.">                    int elevation = (prevStep == null) ? entity.getElevation() : prevStep.getElevation();</span>
<span class="nc bnc" id="L6884" title="All 2 branches missed.">                    if (entity instanceof LandAirMech) {</span>
<span class="nc" id="L6885">                        addReport(landAirMech((LandAirMech) entity, step.getPosition(), elevation,</span>
                                distance));
<span class="nc bnc" id="L6887" title="All 2 branches missed.">                    } else if (entity instanceof Protomech) {</span>
<span class="nc" id="L6888">                        addReport(landGliderPM((Protomech) entity, step.getPosition(), elevation,</span>
                                distance));
                    }
                    // landing always ends movement whether successful or not
                }
            }

            // check for MASC failure on first step
            // also check Tanks because they can have superchargers that act
            // like MASc
<span class="nc bnc" id="L6898" title="All 6 branches missed.">            if (firstStep &amp;&amp; ((entity instanceof Mech) || (entity instanceof Tank))) {</span>
                // Not necessarily a fall, but we need to give them a new turn to plot movement with
                // likely reduced MP.
<span class="nc" id="L6901">                fellDuringMovement = checkMASCFailure(entity, md);</span>
            }

<span class="nc bnc" id="L6904" title="All 2 branches missed.">            if (firstStep) {</span>
<span class="nc" id="L6905">                rollTarget = entity.checkGunningIt(overallMoveType);</span>
<span class="nc bnc" id="L6906" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L6907">                    int mof = doSkillCheckWhileMoving(entity, lastElevation, lastPos,</span>
                            curPos, rollTarget, false);
<span class="nc bnc" id="L6909" title="All 2 branches missed.">                    if (mof &gt; 0) {</span>
                        // Since this is the first step, we don't have a previous step so we'll pass
                        // this one in case it's needed to process a skid.
<span class="nc bnc" id="L6912" title="All 2 branches missed.">                        if (processFailedVehicleManeuver(entity, curPos, 0, step,</span>
<span class="nc" id="L6913">                                step.isThisStepBackwards(), lastStepMoveType, distance, 2, mof)) {</span>
<span class="nc bnc" id="L6914" title="All 2 branches missed.">                            if (md.hasActiveMASC()) {</span>
<span class="nc" id="L6915">                                mpUsed = entity.getRunMP();</span>
                            } else {
<span class="nc" id="L6917">                                mpUsed = entity.getRunMPwithoutMASC();</span>
                            }

<span class="nc" id="L6920">                            turnOver = true;</span>
<span class="nc" id="L6921">                            distance = entity.delta_distance;</span>
<span class="nc" id="L6922">                            curFacing = entity.getFacing();</span>
<span class="nc" id="L6923">                            entity.setSecondaryFacing(curFacing);</span>
<span class="nc" id="L6924">                            break;</span>
<span class="nc bnc" id="L6925" title="All 2 branches missed.">                        } else if (entity.getFacing() != curFacing) {</span>
                            // If the facing doesn't change we had a minor fishtail that doesn't require
                            // stopping movement.
<span class="nc" id="L6928">                            continueTurnFromFishtail = true;</span>
<span class="nc" id="L6929">                            curFacing = entity.getFacing();</span>
<span class="nc" id="L6930">                            entity.setSecondaryFacing(curFacing);</span>
<span class="nc" id="L6931">                            break;</span>
                        }
                    }
                }
            }

            // Check for failed maneuver for overdrive on first step. The rules for overdrive do not
            // state this explicitly, but since combining overdrive with gunning it requires two rolls
            // and gunning does state explicitly that the roll is made before movement, this
            // implies the same for overdrive.
<span class="nc bnc" id="L6941" title="All 6 branches missed.">            if (firstStep &amp;&amp; (overallMoveType == EntityMovementType.MOVE_SPRINT</span>
                    || overallMoveType == EntityMovementType.MOVE_VTOL_SPRINT)) {
<span class="nc" id="L6943">                rollTarget = entity.checkUsingOverdrive(EntityMovementType.MOVE_SPRINT);</span>
<span class="nc bnc" id="L6944" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L6945">                    int mof = doSkillCheckWhileMoving(entity, lastElevation, lastPos,</span>
                            curPos, rollTarget, false);
<span class="nc bnc" id="L6947" title="All 2 branches missed.">                    if (mof &gt; 0) {</span>
<span class="nc bnc" id="L6948" title="All 2 branches missed.">                        if (processFailedVehicleManeuver(entity, curPos, 0, step, step.isThisStepBackwards(),</span>
                                lastStepMoveType, distance, 2, mof)) {
<span class="nc bnc" id="L6950" title="All 2 branches missed.">                            if (md.hasActiveMASC()) {</span>
<span class="nc" id="L6951">                                mpUsed = entity.getRunMP();</span>
                            } else {
<span class="nc" id="L6953">                                mpUsed = entity.getRunMPwithoutMASC();</span>
                            }

<span class="nc" id="L6956">                            turnOver = true;</span>
<span class="nc" id="L6957">                            distance = entity.delta_distance;</span>
<span class="nc" id="L6958">                            curFacing = entity.getFacing();</span>
<span class="nc" id="L6959">                            entity.setSecondaryFacing(curFacing);</span>
<span class="nc" id="L6960">                            break;</span>
<span class="nc bnc" id="L6961" title="All 2 branches missed.">                        } else if (entity.getFacing() != curFacing) {</span>
                            // If the facing doesn't change we had a minor fishtail that doesn't require
                            // stopping movement.
<span class="nc" id="L6964">                            continueTurnFromFishtail = true;</span>
<span class="nc" id="L6965">                            curFacing = entity.getFacing();</span>
<span class="nc" id="L6966">                            entity.setSecondaryFacing(curFacing);</span>
<span class="nc" id="L6967">                            break;</span>
                        }
                    }
                }
            }

<span class="nc bnc" id="L6973" title="All 2 branches missed.">            if (step.getType() == MoveStepType.CONVERT_MODE) {</span>
<span class="nc" id="L6974">                entity.setConvertingNow(true);</span>

                // Non-omni QuadVees converting to vehicle mode dump any riding BA in the
                // starting hex if they fail to make an anti-mech check.
                // http://bg.battletech.com/forums/index.php?topic=55263.msg1271423#msg1271423
<span class="nc bnc" id="L6979" title="All 4 branches missed.">                if (entity instanceof QuadVee &amp;&amp; entity.getConversionMode() == QuadVee.CONV_MODE_MECH</span>
<span class="nc bnc" id="L6980" title="All 2 branches missed.">                        &amp;&amp; !entity.isOmni()) {</span>
<span class="nc bnc" id="L6981" title="All 2 branches missed.">                    for (Entity rider : entity.getExternalUnits()) {</span>
<span class="nc" id="L6982">                        addReport(checkDropBAFromConverting(entity, rider, curPos, curFacing,</span>
                                false, false, false));
<span class="nc" id="L6984">                    }</span>
<span class="nc bnc" id="L6985" title="All 2 branches missed.">                } else if ((entity.getEntityType() &amp; Entity.ETYPE_LAND_AIR_MECH) != 0) {</span>
                    //External units on LAMs, including swarmers, fall automatically and take damage,
                    //and the LAM itself may take one or more criticals.
<span class="nc bnc" id="L6988" title="All 2 branches missed.">                    for (Entity rider : entity.getExternalUnits()) {</span>
<span class="nc" id="L6989">                        addReport(checkDropBAFromConverting(entity, rider, curPos, curFacing, true, true, true));</span>
<span class="nc" id="L6990">                    }</span>
<span class="nc" id="L6991">                    final int swarmerId = entity.getSwarmAttackerId();</span>
<span class="nc bnc" id="L6992" title="All 2 branches missed.">                    if (Entity.NONE != swarmerId) {</span>
<span class="nc" id="L6993">                        addReport(checkDropBAFromConverting(entity, game.getEntity(swarmerId),</span>
                                curPos, curFacing, true, true, true));
                    }
<span class="nc" id="L6996">                }</span>

                continue;
            }

            // did the entity move?
<span class="nc bnc" id="L7002" title="All 2 branches missed.">            didMove = step.getDistance() &gt; distance;</span>

            // check for aero stuff
<span class="nc bnc" id="L7005" title="All 4 branches missed.">            if (entity.isAirborne() &amp;&amp; entity.isAero()) {</span>
<span class="nc" id="L7006">                IAero a = (IAero) entity;</span>
<span class="nc" id="L7007">                j++;</span>

                // increment straight moves (can't do it at end, because not all
                // steps may be processed)
<span class="nc" id="L7011">                a.setStraightMoves(step.getNStraight());</span>

                // TODO : change the way this check is made
<span class="nc bnc" id="L7014" title="All 4 branches missed.">                if (!didMove &amp;&amp; (md.length() != j)) {</span>
<span class="nc" id="L7015">                    thrustUsed += step.getMp();</span>
                } else {
                    // if this was the last move and distance was zero, then add
                    // thrust
<span class="nc bnc" id="L7019" title="All 4 branches missed.">                    if (!didMove &amp;&amp; (md.length() == j)) {</span>
<span class="nc" id="L7020">                        thrustUsed += step.getMp();</span>
                    }
                    // then we moved to a new hex or the last step so check
                    // conditions
                    // structural damage
<span class="nc" id="L7025">                    rollTarget = a.checkThrustSI(thrustUsed, overallMoveType);</span>
<span class="nc bnc" id="L7026" title="All 4 branches missed.">                    if ((rollTarget.getValue() != TargetRoll.CHECK_FALSE)</span>
<span class="nc bnc" id="L7027" title="All 2 branches missed.">                            &amp;&amp; !(entity instanceof FighterSquadron) &amp;&amp; !game.useVectorMove()) {</span>
<span class="nc bnc" id="L7028" title="All 2 branches missed.">                        if (!doSkillCheckInSpace(entity, rollTarget)) {</span>
<span class="nc" id="L7029">                            a.setSI(a.getSI() - 1);</span>
<span class="nc bnc" id="L7030" title="All 2 branches missed.">                            if (entity instanceof LandAirMech) {</span>
<span class="nc" id="L7031">                                addReport(criticalEntity(entity, Mech.LOC_CT, false, 0, 1));</span>
                            }
                            // check for destruction
<span class="nc bnc" id="L7034" title="All 2 branches missed.">                            if (a.getSI() == 0) {</span>
                                // Lets auto-eject if we can!
<span class="nc bnc" id="L7036" title="All 2 branches missed.">                                if (a instanceof LandAirMech) {</span>
                                    // LAMs eject if the CT destroyed switch is on
<span class="nc" id="L7038">                                    LandAirMech lam = (LandAirMech) a;</span>
<span class="nc bnc" id="L7039" title="All 2 branches missed.">                                    if (lam.isAutoEject()</span>
<span class="nc bnc" id="L7040" title="All 2 branches missed.">                                        &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L7041" title="All 2 branches missed.">                                                || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L7042" title="All 2 branches missed.">                                                        &amp;&amp; lam.isCondEjectCTDest()))) {</span>
<span class="nc" id="L7043">                                        addReport(ejectEntity(entity, true, false));</span>
                                    }
<span class="nc" id="L7045">                                } else {</span>
                                    // Aeros eject if the SI Destroyed switch is on
<span class="nc" id="L7047">                                    Aero aero = (Aero) a;</span>
<span class="nc bnc" id="L7048" title="All 2 branches missed.">                                    if (aero.isAutoEject()</span>
<span class="nc bnc" id="L7049" title="All 2 branches missed.">                                        &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L7050" title="All 2 branches missed.">                                                || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L7051" title="All 2 branches missed.">                                                        &amp;&amp; aero.isCondEjectSIDest()))) {</span>
<span class="nc" id="L7052">                                        addReport(ejectEntity(entity, true, false));</span>
                                    }
                                }
<span class="nc" id="L7055">                                addReport(destroyEntity(entity, &quot;Structural Integrity Collapse&quot;,</span>
                                        false));
                            }
                        }
                    }

                    // check for pilot damage
<span class="nc" id="L7062">                    int hits = entity.getCrew().getHits();</span>
<span class="nc" id="L7063">                    int health = 6 - hits;</span>

<span class="nc bnc" id="L7065" title="All 6 branches missed.">                    if ((thrustUsed &gt; (2 * health)) &amp;&amp; !game.useVectorMove()</span>
                            &amp;&amp; !(entity instanceof TeleMissile)) {
<span class="nc" id="L7067">                        int targetRoll = 2 + (thrustUsed - (2 * health))</span>
                                + (2 * hits);
<span class="nc" id="L7069">                        resistGForce(entity, targetRoll);</span>
                    }

<span class="nc" id="L7072">                    thrustUsed = 0;</span>
                }

<span class="nc bnc" id="L7075" title="All 2 branches missed.">                if (step.getType() == MoveStepType.RETURN) {</span>
<span class="nc" id="L7076">                    a.setCurrentVelocity(md.getFinalVelocity());</span>
<span class="nc" id="L7077">                    entity.setAltitude(curAltitude);</span>
<span class="nc" id="L7078">                    processLeaveMap(md, true, Compute.roundsUntilReturn(game, entity));</span>
<span class="nc" id="L7079">                    return;</span>
                }

<span class="nc bnc" id="L7082" title="All 2 branches missed.">                if (step.getType() == MoveStepType.OFF) {</span>
<span class="nc" id="L7083">                    a.setCurrentVelocity(md.getFinalVelocity());</span>
<span class="nc" id="L7084">                    entity.setAltitude(curAltitude);</span>
<span class="nc" id="L7085">                    processLeaveMap(md, true, -1);</span>
<span class="nc" id="L7086">                    return;</span>
                }

<span class="nc" id="L7089">                rollTarget = a.checkRolls(step, overallMoveType);</span>
<span class="nc bnc" id="L7090" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L7091">                    game.addControlRoll(new PilotingRollData(entity.getId(), 0, &quot;excess roll&quot;));</span>
                }

<span class="nc" id="L7094">                rollTarget = a.checkManeuver(step, overallMoveType);</span>
<span class="nc bnc" id="L7095" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc bnc" id="L7096" title="All 2 branches missed.">                    if (!doSkillCheckManeuver(entity, rollTarget)) {</span>
<span class="nc" id="L7097">                        a.setFailedManeuver(true);</span>
<span class="nc" id="L7098">                        int forward = Math.max(step.getVelocityLeft() / 2, 1);</span>
<span class="nc bnc" id="L7099" title="All 2 branches missed.">                        if (forward &lt; step.getVelocityLeft()) {</span>
<span class="nc" id="L7100">                            fellDuringMovement = true;</span>
                        }
                        // multiply forward by 16 when on ground hexes
<span class="nc bnc" id="L7103" title="All 2 branches missed.">                        if (game.getBoard().onGround()) {</span>
<span class="nc" id="L7104">                            forward *= 16;</span>
                        }
<span class="nc bnc" id="L7106" title="All 2 branches missed.">                        while (forward &gt; 0) {</span>
<span class="nc" id="L7107">                            curPos = curPos.translated(step.getFacing());</span>
<span class="nc" id="L7108">                            forward--;</span>
<span class="nc" id="L7109">                            distance++;</span>
<span class="nc" id="L7110">                            a.setStraightMoves(a.getStraightMoves() + 1);</span>
                            // make sure it didn't fly off the map
<span class="nc bnc" id="L7112" title="All 2 branches missed.">                            if (!game.getBoard().contains(curPos)) {</span>
<span class="nc" id="L7113">                                a.setCurrentVelocity(md.getFinalVelocity());</span>
<span class="nc" id="L7114">                                processLeaveMap(md, true, Compute.roundsUntilReturn(game, entity));</span>
<span class="nc" id="L7115">                                return;</span>
                                // make sure it didn't crash
<span class="nc bnc" id="L7117" title="All 2 branches missed.">                            } else if (checkCrash(entity, curPos, step.getAltitude())) {</span>
<span class="nc" id="L7118">                                addReport(processCrash(entity, step.getVelocity(), curPos));</span>
<span class="nc" id="L7119">                                forward = 0;</span>
<span class="nc" id="L7120">                                fellDuringMovement = false;</span>
<span class="nc" id="L7121">                                crashedDuringMovement = true;</span>
                            }
                        }
                        break;
                    }
                }

                // if out of control, check for possible collision
<span class="nc bnc" id="L7129" title="All 4 branches missed.">                if (didMove &amp;&amp; a.isOutControlTotal()) {</span>
<span class="nc" id="L7130">                    Iterator&lt;Entity&gt; targets = game.getEntities(step.getPosition());</span>
<span class="nc bnc" id="L7131" title="All 2 branches missed.">                    if (targets.hasNext()) {</span>
                        // Somebody here so check to see if there is a collision
<span class="nc" id="L7133">                        int checkRoll = Compute.d6(2);</span>
                        // TODO : change this to 11 for Large Craft
<span class="nc" id="L7135">                        int targetRoll = 11;</span>
<span class="nc bnc" id="L7136" title="All 4 branches missed.">                        if ((a instanceof Dropship) || (entity instanceof Jumpship)) {</span>
<span class="nc" id="L7137">                            targetRoll = 10;</span>
                        }
<span class="nc bnc" id="L7139" title="All 2 branches missed.">                        if (checkRoll &gt;= targetRoll) {</span>
                            // this gets complicated, I need to check for each
                            // unit type
                            // by order of movement sub-phase
<span class="nc" id="L7143">                            Vector&lt;Integer&gt; potentialSpaceStation = new Vector&lt;&gt;();</span>
<span class="nc" id="L7144">                            Vector&lt;Integer&gt; potentialWarShip = new Vector&lt;&gt;();</span>
<span class="nc" id="L7145">                            Vector&lt;Integer&gt; potentialJumpShip = new Vector&lt;&gt;();</span>
<span class="nc" id="L7146">                            Vector&lt;Integer&gt; potentialDropShip = new Vector&lt;&gt;();</span>
<span class="nc" id="L7147">                            Vector&lt;Integer&gt; potentialSmallCraft = new Vector&lt;&gt;();</span>
<span class="nc" id="L7148">                            Vector&lt;Integer&gt; potentialASF = new Vector&lt;&gt;();</span>

<span class="nc bnc" id="L7150" title="All 2 branches missed.">                            while (targets.hasNext()) {</span>
<span class="nc" id="L7151">                                int id = targets.next().getId();</span>
<span class="nc" id="L7152">                                Entity ce = game.getEntity(id);</span>
                                // if we are in atmosphere and not the same altitude
                                // then skip
<span class="nc bnc" id="L7155" title="All 4 branches missed.">                                if (!game.getBoard().inSpace() &amp;&amp; (ce.getAltitude() != curAltitude)) {</span>
<span class="nc" id="L7156">                                    continue;</span>
                                }
                                // you can't collide with yourself
<span class="nc bnc" id="L7159" title="All 2 branches missed.">                                if (ce.equals(a)) {</span>
<span class="nc" id="L7160">                                    continue;</span>
                                }
<span class="nc bnc" id="L7162" title="All 2 branches missed.">                                if (ce instanceof SpaceStation) {</span>
<span class="nc" id="L7163">                                    potentialSpaceStation.addElement(id);</span>
<span class="nc bnc" id="L7164" title="All 2 branches missed.">                                } else if (ce instanceof Warship) {</span>
<span class="nc" id="L7165">                                    potentialWarShip.addElement(id);</span>
<span class="nc bnc" id="L7166" title="All 2 branches missed.">                                } else if (ce instanceof Jumpship) {</span>
<span class="nc" id="L7167">                                    potentialJumpShip.addElement(id);</span>
<span class="nc bnc" id="L7168" title="All 2 branches missed.">                                } else if (ce instanceof Dropship) {</span>
<span class="nc" id="L7169">                                    potentialDropShip.addElement(id);</span>
<span class="nc bnc" id="L7170" title="All 2 branches missed.">                                } else if (ce instanceof SmallCraft) {</span>
<span class="nc" id="L7171">                                    potentialSmallCraft.addElement(id);</span>
                                } else {
                                    // ASF can actually include anything,
                                    // because we might
                                    // have combat dropping troops
<span class="nc" id="L7176">                                    potentialASF.addElement(id);</span>
                                }
<span class="nc" id="L7178">                            }</span>

                            // ok now go through and see if these have anybody in them
                            int chosen;
                            Entity target;
                            Coords destination;

<span class="nc bnc" id="L7185" title="All 2 branches missed.">                            if (potentialSpaceStation.size() &gt; 0) {</span>
<span class="nc" id="L7186">                                chosen = Compute.randomInt(potentialSpaceStation.size());</span>
<span class="nc" id="L7187">                                target = game.getEntity(potentialSpaceStation.elementAt(chosen));</span>
<span class="nc" id="L7188">                                destination = target.getPosition();</span>
<span class="nc bnc" id="L7189" title="All 2 branches missed.">                                if (processCollision(entity, target, lastPos)) {</span>
<span class="nc" id="L7190">                                    curPos = destination;</span>
<span class="nc" id="L7191">                                    break;</span>
                                }
<span class="nc bnc" id="L7193" title="All 2 branches missed.">                            } else if (potentialWarShip.size() &gt; 0) {</span>
<span class="nc" id="L7194">                                chosen = Compute.randomInt(potentialWarShip.size());</span>
<span class="nc" id="L7195">                                target = game.getEntity(potentialWarShip.elementAt(chosen));</span>
<span class="nc" id="L7196">                                destination = target.getPosition();</span>
<span class="nc bnc" id="L7197" title="All 2 branches missed.">                                if (processCollision(entity, target, lastPos)) {</span>
<span class="nc" id="L7198">                                    curPos = destination;</span>
<span class="nc" id="L7199">                                    break;</span>
                                }
<span class="nc bnc" id="L7201" title="All 2 branches missed.">                            } else if (potentialJumpShip.size() &gt; 0) {</span>
<span class="nc" id="L7202">                                chosen = Compute.randomInt(potentialJumpShip.size());</span>
<span class="nc" id="L7203">                                target = game.getEntity(potentialJumpShip.elementAt(chosen));</span>
<span class="nc" id="L7204">                                destination = target.getPosition();</span>
<span class="nc bnc" id="L7205" title="All 2 branches missed.">                                if (processCollision(entity, target, lastPos)) {</span>
<span class="nc" id="L7206">                                    curPos = destination;</span>
<span class="nc" id="L7207">                                    break;</span>
                                }
<span class="nc bnc" id="L7209" title="All 2 branches missed.">                            } else if (potentialDropShip.size() &gt; 0) {</span>
<span class="nc" id="L7210">                                chosen = Compute.randomInt(potentialDropShip.size());</span>
<span class="nc" id="L7211">                                target = game.getEntity(potentialDropShip.elementAt(chosen));</span>
<span class="nc" id="L7212">                                destination = target.getPosition();</span>
<span class="nc bnc" id="L7213" title="All 2 branches missed.">                                if (processCollision(entity, target, lastPos)) {</span>
<span class="nc" id="L7214">                                    curPos = destination;</span>
<span class="nc" id="L7215">                                    break;</span>
                                }
<span class="nc bnc" id="L7217" title="All 2 branches missed.">                            } else if (potentialSmallCraft.size() &gt; 0) {</span>
<span class="nc" id="L7218">                                chosen = Compute.randomInt(potentialSmallCraft.size());</span>
<span class="nc" id="L7219">                                target = game.getEntity(potentialSmallCraft.elementAt(chosen));</span>
<span class="nc" id="L7220">                                destination = target.getPosition();</span>
<span class="nc bnc" id="L7221" title="All 2 branches missed.">                                if (processCollision(entity, target, lastPos)) {</span>
<span class="nc" id="L7222">                                    curPos = destination;</span>
<span class="nc" id="L7223">                                    break;</span>
                                }
<span class="nc bnc" id="L7225" title="All 2 branches missed.">                            } else if (potentialASF.size() &gt; 0) {</span>
<span class="nc" id="L7226">                                chosen = Compute.randomInt(potentialASF.size());</span>
<span class="nc" id="L7227">                                target = game.getEntity(potentialASF.elementAt(chosen));</span>
<span class="nc" id="L7228">                                destination = target.getPosition();</span>
<span class="nc bnc" id="L7229" title="All 2 branches missed.">                                if (processCollision(entity, target, lastPos)) {</span>
<span class="nc" id="L7230">                                    curPos = destination;</span>
<span class="nc" id="L7231">                                    break;</span>
                                }
                            }

                        }
                    }
                }

                // if in the atmosphere, check for a potential crash

<span class="nc bnc" id="L7241" title="All 2 branches missed.">                if (checkCrash(entity, step.getPosition(), step.getAltitude())) {</span>
<span class="nc" id="L7242">                    addReport(processCrash(entity, md.getFinalVelocity(), curPos));</span>
<span class="nc" id="L7243">                    crashedDuringMovement = true;</span>
                    // don't do the rest
<span class="nc" id="L7245">                    break;</span>
                }

                // handle fighter launching
<span class="nc bnc" id="L7249" title="All 2 branches missed.">                if (step.getType() == MoveStepType.LAUNCH) {</span>
<span class="nc" id="L7250">                    TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; launched = step.getLaunched();</span>
<span class="nc" id="L7251">                    Set&lt;Integer&gt; bays = launched.keySet();</span>
<span class="nc" id="L7252">                    Iterator&lt;Integer&gt; bayIter = bays.iterator();</span>
                    Bay currentBay;
<span class="nc bnc" id="L7254" title="All 2 branches missed.">                    while (bayIter.hasNext()) {</span>
<span class="nc" id="L7255">                        int bayId = bayIter.next();</span>
<span class="nc" id="L7256">                        currentBay = entity.getFighterBays().elementAt(bayId);</span>
<span class="nc" id="L7257">                        Vector&lt;Integer&gt; launches = launched.get(bayId);</span>
<span class="nc" id="L7258">                        int nLaunched = launches.size();</span>
                        // need to make some decisions about how to handle the
                        // distribution
                        // of fighters to doors beyond the launch rate. The most
                        // sensible thing
                        // is probably to distribute them evenly.
<span class="nc" id="L7264">                        int doors = currentBay.getCurrentDoors();</span>
<span class="nc" id="L7265">                        int[] distribution = new int[doors];</span>
<span class="nc bnc" id="L7266" title="All 2 branches missed.">                        for (int l = 0; l &lt; nLaunched; l++) {</span>
<span class="nc" id="L7267">                            distribution[l % doors] = distribution[l % doors] + 1;</span>
                        }
                        // ok, now lets launch them
<span class="nc" id="L7270">                        r = new Report(9380);</span>
<span class="nc" id="L7271">                        r.add(entity.getDisplayName());</span>
<span class="nc" id="L7272">                        r.subject = entity.getId();</span>
<span class="nc" id="L7273">                        r.add(nLaunched);</span>
<span class="nc" id="L7274">                        r.add(&quot;bay &quot; + currentBay.getBayNumber() + &quot; (&quot; + doors + &quot; doors)&quot;);</span>
<span class="nc" id="L7275">                        addReport(r);</span>
<span class="nc" id="L7276">                        int currentDoor = 0;</span>
<span class="nc" id="L7277">                        int fighterCount = 0;</span>
<span class="nc" id="L7278">                        boolean doorDamage = false;</span>
<span class="nc bnc" id="L7279" title="All 2 branches missed.">                        for (int fighterId : launches) {</span>
                            // check to see if we are in the same door
<span class="nc" id="L7281">                            fighterCount++;</span>

                            // check for door damage
<span class="nc" id="L7284">                            Report doorReport = null;</span>
<span class="nc bnc" id="L7285" title="All 6 branches missed.">                            if (!doorDamage &amp;&amp; (distribution[currentDoor] &gt; 2) &amp;&amp; (fighterCount &gt; 2)) {</span>
<span class="nc" id="L7286">                                doorReport = new Report(9378);</span>
<span class="nc" id="L7287">                                doorReport.subject = entity.getId();</span>
<span class="nc" id="L7288">                                doorReport.indent(2);</span>
<span class="nc" id="L7289">                                int roll = Compute.d6(2);</span>
<span class="nc" id="L7290">                                doorReport.add(roll);</span>
<span class="nc bnc" id="L7291" title="All 2 branches missed.">                                if (roll == 2) {</span>
<span class="nc" id="L7292">                                    doorDamage = true;</span>
<span class="nc" id="L7293">                                    doorReport.choose(true);</span>
<span class="nc" id="L7294">                                    currentBay.destroyDoorNext();</span>
                                } else {
<span class="nc" id="L7296">                                    doorReport.choose(false);</span>
                                }
<span class="nc" id="L7298">                                doorReport.newlines++;</span>
                            }

<span class="nc bnc" id="L7301" title="All 2 branches missed.">                            if (fighterCount &gt; distribution[currentDoor]) {</span>
                                // move to a new door
<span class="nc" id="L7303">                                currentDoor++;</span>
<span class="nc" id="L7304">                                fighterCount = 0;</span>
<span class="nc" id="L7305">                                doorDamage = false;</span>
                            }
<span class="nc" id="L7307">                            int bonus = Math.max(0,</span>
                                    distribution[currentDoor] - 2);

<span class="nc" id="L7310">                            Entity fighter = game.getEntity(fighterId);</span>
<span class="nc bnc" id="L7311" title="All 2 branches missed.">                            if (!launchUnit(entity, fighter, curPos, curFacing, step.getVelocity(),</span>
<span class="nc" id="L7312">                                    step.getAltitude(), step.getVectors(), bonus)) {</span>
<span class="nc" id="L7313">                                MegaMek.getLogger().error(&quot;Server was told to unload &quot;</span>
<span class="nc" id="L7314">                                        + fighter.getDisplayName() + &quot; from &quot; + entity.getDisplayName()</span>
<span class="nc" id="L7315">                                        + &quot; into &quot; + curPos.getBoardNum());</span>
                            }
<span class="nc bnc" id="L7317" title="All 2 branches missed.">                            if (doorReport != null) {</span>
<span class="nc" id="L7318">                                addReport(doorReport);</span>
                            }
<span class="nc" id="L7320">                        }</span>
<span class="nc" id="L7321">                    }</span>
                    // now apply any damage to bay doors
<span class="nc" id="L7323">                    entity.resetBayDoors();</span>
                }

                // handle DropShip undocking
<span class="nc bnc" id="L7327" title="All 2 branches missed.">                if (step.getType() == MoveStepType.UNDOCK) {</span>
<span class="nc" id="L7328">                    TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; launched = step.getLaunched();</span>
<span class="nc" id="L7329">                    Set&lt;Integer&gt; collars = launched.keySet();</span>
<span class="nc" id="L7330">                    Iterator&lt;Integer&gt; collarIter = collars.iterator();</span>
<span class="nc bnc" id="L7331" title="All 2 branches missed.">                    while (collarIter.hasNext()) {</span>
<span class="nc" id="L7332">                        int collarId = collarIter.next();</span>
<span class="nc" id="L7333">                        Vector&lt;Integer&gt; launches = launched.get(collarId);</span>
<span class="nc" id="L7334">                        int nLaunched = launches.size();</span>
                        // ok, now lets launch them
<span class="nc" id="L7336">                        r = new Report(9380);</span>
<span class="nc" id="L7337">                        r.add(entity.getDisplayName());</span>
<span class="nc" id="L7338">                        r.subject = entity.getId();</span>
<span class="nc" id="L7339">                        r.add(nLaunched);</span>
<span class="nc" id="L7340">                        r.add(&quot;collar &quot; + collarId);</span>
<span class="nc" id="L7341">                        addReport(r);</span>
<span class="nc bnc" id="L7342" title="All 2 branches missed.">                        for (int dropShipId : launches) {</span>
                            // check to see if we are in the same door
<span class="nc" id="L7344">                            Entity ds = game.getEntity(dropShipId);</span>
<span class="nc bnc" id="L7345" title="All 2 branches missed.">                            if (!launchUnit(entity, ds, curPos, curFacing,</span>
<span class="nc" id="L7346">                                    step.getVelocity(), step.getAltitude(),</span>
<span class="nc" id="L7347">                                    step.getVectors(), 0)) {</span>
<span class="nc" id="L7348">                                MegaMek.getLogger().error(&quot;Error! Server was told to unload &quot;</span>
<span class="nc" id="L7349">                                                + ds.getDisplayName() + &quot; from &quot;</span>
<span class="nc" id="L7350">                                                + entity.getDisplayName() + &quot; into &quot;</span>
<span class="nc" id="L7351">                                                + curPos.getBoardNum());</span>
                            }
<span class="nc" id="L7353">                        }</span>
<span class="nc" id="L7354">                    }</span>
                }

                // handle combat drops
<span class="nc bnc" id="L7358" title="All 2 branches missed.">                if (step.getType() == MoveStepType.DROP) {</span>
<span class="nc" id="L7359">                    TreeMap&lt;Integer, Vector&lt;Integer&gt;&gt; dropped = step.getLaunched();</span>
<span class="nc" id="L7360">                    Set&lt;Integer&gt; bays = dropped.keySet();</span>
<span class="nc" id="L7361">                    Iterator&lt;Integer&gt; bayIter = bays.iterator();</span>
                    Bay currentBay;
<span class="nc bnc" id="L7363" title="All 2 branches missed.">                    while (bayIter.hasNext()) {</span>
<span class="nc" id="L7364">                        int bayId = bayIter.next();</span>
<span class="nc" id="L7365">                        currentBay = entity.getTransportBays().elementAt(bayId);</span>
<span class="nc" id="L7366">                        Vector&lt;Integer&gt; drops = dropped.get(bayId);</span>
<span class="nc" id="L7367">                        int nDropped = drops.size();</span>
                        // ok, now lets drop them
<span class="nc" id="L7369">                        r = new Report(9386);</span>
<span class="nc" id="L7370">                        r.add(entity.getDisplayName());</span>
<span class="nc" id="L7371">                        r.subject = entity.getId();</span>
<span class="nc" id="L7372">                        r.add(nDropped);</span>
<span class="nc" id="L7373">                        addReport(r);</span>
<span class="nc bnc" id="L7374" title="All 2 branches missed.">                        for (int unitId : drops) {</span>
<span class="nc bnc" id="L7375" title="All 2 branches missed.">                            if (Compute.d6(2) == 2) {</span>
<span class="nc" id="L7376">                                r = new Report(9390);</span>
<span class="nc" id="L7377">                                r.subject = entity.getId();</span>
<span class="nc" id="L7378">                                r.indent(1);</span>
<span class="nc" id="L7379">                                r.add(currentBay.getType());</span>
<span class="nc" id="L7380">                                addReport(r);</span>
<span class="nc" id="L7381">                                currentBay.destroyDoorNext();</span>
                            }
<span class="nc" id="L7383">                            Entity drop = game.getEntity(unitId);</span>
<span class="nc" id="L7384">                            dropUnit(drop, entity, curPos, step.getAltitude());</span>
<span class="nc" id="L7385">                        }</span>
<span class="nc" id="L7386">                    }</span>
                    // now apply any damage to bay doors
<span class="nc" id="L7388">                    entity.resetBayDoors();</span>
                }
            }

            // check piloting skill for getting up
<span class="nc" id="L7393">            rollTarget = entity.checkGetUp(step, overallMoveType);</span>

<span class="nc bnc" id="L7395" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
                // Unless we're an ICE- or fuel cell-powered IndustrialMech,
                // standing up builds heat.
<span class="nc bnc" id="L7398" title="All 6 branches missed.">                if ((entity instanceof Mech) &amp;&amp; entity.hasEngine() &amp;&amp; !(((Mech) entity).isIndustrial()</span>
<span class="nc bnc" id="L7399" title="All 2 branches missed.">                        &amp;&amp; ((entity.getEngine().getEngineType() == Engine.COMBUSTION_ENGINE)</span>
<span class="nc bnc" id="L7400" title="All 2 branches missed.">                                || (entity.getEngine().getEngineType() == Engine.FUEL_CELL)))) {</span>
<span class="nc" id="L7401">                    entity.heatBuildup += 1;</span>
                }
<span class="nc" id="L7403">                entity.setProne(false);</span>
                // entity.setHullDown(false);
<span class="nc" id="L7405">                wasProne = false;</span>
<span class="nc" id="L7406">                game.resetPSRs(entity);</span>
<span class="nc bnc" id="L7407" title="All 2 branches missed.">                entityFellWhileAttemptingToStand = !doSkillCheckInPlace(entity, rollTarget);</span>
            }
            // did the entity just fall?
<span class="nc bnc" id="L7410" title="All 2 branches missed.">            if (entityFellWhileAttemptingToStand) {</span>
<span class="nc" id="L7411">                moveType = stepMoveType;</span>
<span class="nc" id="L7412">                curFacing = entity.getFacing();</span>
<span class="nc" id="L7413">                curPos = entity.getPosition();</span>
<span class="nc" id="L7414">                mpUsed = step.getMpUsed();</span>
<span class="nc" id="L7415">                fellDuringMovement = true;</span>
<span class="nc bnc" id="L7416" title="All 2 branches missed.">                if (!entity.isCarefulStand()) {</span>
<span class="nc" id="L7417">                    break;</span>
                }
<span class="nc bnc" id="L7419" title="All 2 branches missed.">            } else if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L7420">                entity.setHullDown(false);</span>
            }

<span class="nc bnc" id="L7423" title="All 2 branches missed.">            if (step.getType() == MoveStepType.UNJAM_RAC) {</span>
<span class="nc" id="L7424">                entity.setUnjammingRAC(true);</span>
<span class="nc" id="L7425">                game.addAction(new UnjamAction(entity.getId()));</span>

                // for Aeros this will end movement prematurely
                // if we break
<span class="nc bnc" id="L7429" title="All 2 branches missed.">                if (!(entity.isAirborne())) {</span>
<span class="nc" id="L7430">                    break;</span>
                }
            }

<span class="nc bnc" id="L7434" title="All 2 branches missed.">            if (step.getType() == MoveStepType.LAY_MINE) {</span>
<span class="nc" id="L7435">                layMine(entity, step.getMineToLay(), step.getPosition());</span>
<span class="nc" id="L7436">                continue;</span>
            }

<span class="nc bnc" id="L7439" title="All 2 branches missed.">            if (step.getType() == MoveStepType.CLEAR_MINEFIELD) {</span>
<span class="nc" id="L7440">                ClearMinefieldAction cma = new ClearMinefieldAction(entity.getId(), step.getMinefield());</span>
<span class="nc" id="L7441">                entity.setClearingMinefield(true);</span>
<span class="nc" id="L7442">                game.addAction(cma);</span>
<span class="nc" id="L7443">                break;</span>
            }

<span class="nc bnc" id="L7446" title="All 2 branches missed.">            if ((step.getType() == MoveStepType.SEARCHLIGHT)</span>
<span class="nc bnc" id="L7447" title="All 2 branches missed.">                    &amp;&amp; entity.hasSpotlight()) {</span>
<span class="nc bnc" id="L7448" title="All 2 branches missed.">                final boolean SearchOn = !entity.isUsingSpotlight();</span>
<span class="nc" id="L7449">                entity.setSpotlightState(SearchOn);</span>
<span class="nc bnc" id="L7450" title="All 2 branches missed.">                if (doBlind()) { // if double blind, we may need to filter the</span>
                    // players that receive this message
<span class="nc" id="L7452">                    Vector&lt;IPlayer&gt; playersVector = game.getPlayersVector();</span>
<span class="nc" id="L7453">                    Vector&lt;IPlayer&gt; vCanSee = whoCanSee(entity);</span>
<span class="nc bnc" id="L7454" title="All 2 branches missed.">                    for (IPlayer p : playersVector) {</span>
<span class="nc bnc" id="L7455" title="All 2 branches missed.">                        if (vCanSee.contains(p)) { // Player sees the unit</span>
<span class="nc" id="L7456">                            sendServerChat(p.getId(),</span>
<span class="nc" id="L7457">                                    entity.getDisplayName()</span>
                                            + &quot; switched searchlight &quot;
<span class="nc bnc" id="L7459" title="All 2 branches missed.">                                            + (SearchOn ? &quot;on&quot; : &quot;off&quot;) + '.');</span>
                        } else {
<span class="nc" id="L7461">                            sendServerChat(p.getId(),</span>
                                    &quot;An unseen unit&quot; + &quot; switched searchlight &quot;
<span class="nc bnc" id="L7463" title="All 2 branches missed.">                                            + (SearchOn ? &quot;on&quot; : &quot;off&quot;) + '.');</span>
                        }
<span class="nc" id="L7465">                    }</span>
<span class="nc" id="L7466">                } else { // No double blind, everyone can see this</span>
<span class="nc" id="L7467">                    sendServerChat(</span>
<span class="nc" id="L7468">                            entity.getDisplayName() + &quot; switched searchlight &quot;</span>
<span class="nc bnc" id="L7469" title="All 2 branches missed.">                                    + (SearchOn ? &quot;on&quot; : &quot;off&quot;) + '.');</span>
                }
            }

            // set most step parameters
<span class="nc" id="L7474">            moveType = stepMoveType;</span>
<span class="nc" id="L7475">            distance = step.getDistance();</span>
<span class="nc" id="L7476">            mpUsed = step.getMpUsed();</span>

<span class="nc bnc" id="L7478" title="All 2 branches missed.">            if (cachedGravityLimit &lt; 0) {</span>
<span class="nc bnc" id="L7479" title="All 2 branches missed.">                cachedGravityLimit = EntityMovementType.MOVE_JUMP == moveType</span>
<span class="nc" id="L7480">                        ? entity.getJumpMP(false)</span>
<span class="nc" id="L7481">                        : entity.getRunningGravityLimit();</span>
            }
            // check for charge
<span class="nc bnc" id="L7484" title="All 2 branches missed.">            if (step.getType() == MoveStepType.CHARGE) {</span>
<span class="nc bnc" id="L7485" title="All 2 branches missed.">                if (entity.canCharge()) {</span>
<span class="nc" id="L7486">                    checkExtremeGravityMovement(entity, step, lastStepMoveType,</span>
                            curPos, cachedGravityLimit);
<span class="nc" id="L7488">                    Targetable target = step.getTarget(game);</span>
<span class="nc bnc" id="L7489" title="All 2 branches missed.">                    if (target != null) {</span>
<span class="nc" id="L7490">                        ChargeAttackAction caa = new ChargeAttackAction(</span>
<span class="nc" id="L7491">                                entity.getId(), target.getTargetType(),</span>
<span class="nc" id="L7492">                                target.getTargetId(), target.getPosition());</span>
<span class="nc" id="L7493">                        entity.setDisplacementAttack(caa);</span>
<span class="nc" id="L7494">                        game.addCharge(caa);</span>
<span class="nc" id="L7495">                        charge = caa;</span>
<span class="nc" id="L7496">                    } else {</span>
<span class="nc" id="L7497">                        String message = &quot;Illegal charge!! &quot; + entity.getDisplayName() +</span>
                                &quot; is attempting to charge a null target!&quot;;
<span class="nc" id="L7499">                        MegaMek.getLogger().info(message);</span>
<span class="nc" id="L7500">                        sendServerChat(message);</span>
<span class="nc" id="L7501">                        return;</span>
                    }
<span class="nc bnc" id="L7503" title="All 4 branches missed.">                } else if (entity.isAirborneVTOLorWIGE() &amp;&amp; entity.canRam()) {</span>
<span class="nc" id="L7504">                    checkExtremeGravityMovement(entity, step, lastStepMoveType,</span>
                            curPos, cachedGravityLimit);
<span class="nc" id="L7506">                    Targetable target = step.getTarget(game);</span>
<span class="nc bnc" id="L7507" title="All 2 branches missed.">                    if (target != null) {</span>
<span class="nc" id="L7508">                        AirmechRamAttackAction raa = new AirmechRamAttackAction(</span>
<span class="nc" id="L7509">                                entity.getId(), target.getTargetType(),</span>
<span class="nc" id="L7510">                                target.getTargetId(), target.getPosition());</span>
<span class="nc" id="L7511">                        entity.setDisplacementAttack(raa);</span>
<span class="nc" id="L7512">                        entity.setRamming(true);</span>
<span class="nc" id="L7513">                        game.addCharge(raa);</span>
<span class="nc" id="L7514">                        charge = raa;</span>
<span class="nc" id="L7515">                    } else {</span>
<span class="nc" id="L7516">                        String message = &quot;Illegal charge!! &quot; + entity.getDisplayName() + &quot; is attempting to charge a null target!&quot;;</span>
<span class="nc" id="L7517">                        MegaMek.getLogger().info(message);</span>
<span class="nc" id="L7518">                        sendServerChat(message);</span>
<span class="nc" id="L7519">                        return;</span>
                    }
<span class="nc" id="L7521">                } else {</span>
<span class="nc" id="L7522">                    sendServerChat(&quot;Illegal charge!! I don't think &quot;</span>
<span class="nc" id="L7523">                            + entity.getDisplayName()</span>
                            + &quot; should be allowed to charge,&quot;
                            + &quot; but the client of &quot;
<span class="nc" id="L7526">                            + entity.getOwner().getName() + &quot; disagrees.&quot;);</span>
<span class="nc" id="L7527">                    sendServerChat(&quot;Please make sure &quot;</span>
<span class="nc" id="L7528">                            + entity.getOwner().getName()</span>
                            + &quot; is running MegaMek &quot; + MegaMek.VERSION
                            + &quot;, or if that is already the case, submit a bug report at https://github.com/MegaMek/megamek/issues&quot;);
<span class="nc" id="L7531">                    return;</span>
                }
                break;
            }

            // check for dfa
<span class="nc bnc" id="L7537" title="All 2 branches missed.">            if (step.getType() == MoveStepType.DFA) {</span>
<span class="nc bnc" id="L7538" title="All 2 branches missed.">                if (entity.canDFA()) {</span>
<span class="nc" id="L7539">                    checkExtremeGravityMovement(entity, step, lastStepMoveType, curPos, cachedGravityLimit);</span>
<span class="nc" id="L7540">                    Targetable target = step.getTarget(game);</span>
                    
                    int targetType;
                    int targetID;
                    
                    // if it's a valid target, then simply pass along the type and ID
<span class="nc bnc" id="L7546" title="All 2 branches missed.">                    if (target != null) {    </span>
<span class="nc" id="L7547">                        targetID = target.getTargetId();</span>
<span class="nc" id="L7548">                        targetType = target.getTargetType();</span>
                    // if the target has become invalid somehow, or was incorrectly declared in the first place
                    // log the error, then put some defaults in for the DFA and proceed as if the target had been moved/destroyed
                    } else {
<span class="nc" id="L7552">                        String errorMessage = &quot;Illegal DFA by &quot; + entity.getDisplayName() + &quot; against non-existent entity at &quot; + step.getTargetPosition(); </span>
<span class="nc" id="L7553">                        sendServerChat(errorMessage);</span>
<span class="nc" id="L7554">                        MegaMek.getLogger().error(errorMessage);</span>
<span class="nc" id="L7555">                        targetID = Entity.NONE; </span>
                        // doesn't really matter, DFA processing will cut out early if target resolves as null
<span class="nc" id="L7557">                        targetType = Targetable.TYPE_ENTITY; </span>
                    }
                    
<span class="nc" id="L7560">                    DfaAttackAction daa = new DfaAttackAction(entity.getId(),</span>
                            targetType, targetID,
<span class="nc" id="L7562">                            step.getPosition());</span>
<span class="nc" id="L7563">                    entity.setDisplacementAttack(daa);</span>
<span class="nc" id="L7564">                    entity.setElevation(step.getElevation());</span>
<span class="nc" id="L7565">                    game.addCharge(daa);</span>
<span class="nc" id="L7566">                    charge = daa;</span>
                    
<span class="nc" id="L7568">                } else {</span>
<span class="nc" id="L7569">                    sendServerChat(&quot;Illegal DFA!! I don't think &quot;</span>
<span class="nc" id="L7570">                            + entity.getDisplayName()</span>
                            + &quot; should be allowed to DFA,&quot;
                            + &quot; but the client of &quot;
<span class="nc" id="L7573">                            + entity.getOwner().getName() + &quot; disagrees.&quot;);</span>
<span class="nc" id="L7574">                    sendServerChat(&quot;Please make sure &quot;</span>
<span class="nc" id="L7575">                            + entity.getOwner().getName()</span>
                            + &quot; is running MegaMek &quot; + MegaMek.VERSION
                            + &quot;, or if that is already the case, submit a bug report at https://github.com/MegaMek/megamek/issues&quot;);
<span class="nc" id="L7578">                    return;</span>
                }
                
                break;
            }

            // check for ram
<span class="nc bnc" id="L7585" title="All 2 branches missed.">            if (step.getType() == MoveStepType.RAM) {</span>
<span class="nc bnc" id="L7586" title="All 2 branches missed.">                if (entity.canRam()) {</span>
<span class="nc" id="L7587">                    Targetable target = step.getTarget(game);</span>
<span class="nc" id="L7588">                    RamAttackAction raa = new RamAttackAction(entity.getId(),</span>
<span class="nc" id="L7589">                            target.getTargetType(), target.getTargetId(),</span>
<span class="nc" id="L7590">                            target.getPosition());</span>
<span class="nc" id="L7591">                    entity.setRamming(true);</span>
<span class="nc" id="L7592">                    game.addRam(raa);</span>
<span class="nc" id="L7593">                    ram = raa;</span>
<span class="nc" id="L7594">                } else {</span>
<span class="nc" id="L7595">                    sendServerChat(&quot;Illegal ram!! I don't think &quot;</span>
<span class="nc" id="L7596">                            + entity.getDisplayName()</span>
                            + &quot; should be allowed to charge,&quot;
                            + &quot; but the client of &quot;
<span class="nc" id="L7599">                            + entity.getOwner().getName() + &quot; disagrees.&quot;);</span>
<span class="nc" id="L7600">                    sendServerChat(&quot;Please make sure &quot;</span>
<span class="nc" id="L7601">                            + entity.getOwner().getName()</span>
                            + &quot; is running MegaMek &quot; + MegaMek.VERSION
                            + &quot;, or if that is already the case, submit a bug report at https://github.com/MegaMek/megamek/issues&quot;);
<span class="nc" id="L7604">                    return;</span>
                }
                break;
            }

<span class="nc bnc" id="L7609" title="All 2 branches missed.">            if (step.isVTOLBombingStep()) {</span>
<span class="nc" id="L7610">                ((IBomber) entity).setVTOLBombTarget(step.getTarget(game));</span>
<span class="nc bnc" id="L7611" title="All 4 branches missed.">            } else if (step.isStrafingStep() &amp;&amp; (entity instanceof VTOL)) {</span>
<span class="nc" id="L7612">                ((VTOL) entity).getStrafingCoords().add(step.getPosition());</span>
            }

<span class="nc bnc" id="L7615" title="All 4 branches missed.">            if ((step.getType() == MoveStepType.ACC) || (step.getType() == MoveStepType.ACCN)) {</span>
<span class="nc bnc" id="L7616" title="All 2 branches missed.">                if (entity.isAero()) {</span>
<span class="nc" id="L7617">                    IAero a = (IAero) entity;</span>
<span class="nc bnc" id="L7618" title="All 2 branches missed.">                    if (step.getType() == MoveStepType.ACCN) {</span>
<span class="nc" id="L7619">                        a.setAccLast(true);</span>
                    } else {
<span class="nc" id="L7621">                        a.setAccDecNow(true);</span>
<span class="nc" id="L7622">                        a.setCurrentVelocity(a.getCurrentVelocity() + 1);</span>
                    }
<span class="nc" id="L7624">                    a.setNextVelocity(a.getNextVelocity() + 1);</span>
                }
            }

<span class="nc bnc" id="L7628" title="All 4 branches missed.">            if ((step.getType() == MoveStepType.DEC) || (step.getType() == MoveStepType.DECN)) {</span>
<span class="nc bnc" id="L7629" title="All 2 branches missed.">                if (entity.isAero()) {</span>
<span class="nc" id="L7630">                    IAero a = (IAero) entity;</span>
<span class="nc bnc" id="L7631" title="All 2 branches missed.">                    if (step.getType() == MoveStepType.DECN) {</span>
<span class="nc" id="L7632">                        a.setAccLast(true);</span>
                    } else {
<span class="nc" id="L7634">                        a.setAccDecNow(true);</span>
<span class="nc" id="L7635">                        a.setCurrentVelocity(a.getCurrentVelocity() - 1);</span>
                    }
<span class="nc" id="L7637">                    a.setNextVelocity(a.getNextVelocity() - 1);</span>
                }
            }

<span class="nc bnc" id="L7641" title="All 2 branches missed.">            if (step.getType() == MoveStepType.EVADE) {</span>
<span class="nc" id="L7642">                entity.setEvading(true);</span>
            }

<span class="nc bnc" id="L7645" title="All 2 branches missed.">            if (step.getType() == MoveStepType.SHUTDOWN) {</span>
<span class="nc" id="L7646">                entity.performManualShutdown();</span>
<span class="nc" id="L7647">                sendServerChat(entity.getDisplayName() + &quot; has shutdown.&quot;);</span>
            }

<span class="nc bnc" id="L7650" title="All 2 branches missed.">            if (step.getType() == MoveStepType.STARTUP) {</span>
<span class="nc" id="L7651">                entity.performManualStartup();</span>
<span class="nc" id="L7652">                sendServerChat(entity.getDisplayName() + &quot; has started up.&quot;);</span>
            }

<span class="nc bnc" id="L7655" title="All 2 branches missed.">            if (step.getType() == MoveStepType.SELF_DESTRUCT) {</span>
<span class="nc" id="L7656">                entity.setSelfDestructing(true);</span>
            }

<span class="nc bnc" id="L7659" title="All 2 branches missed.">            if (step.getType() == MoveStepType.ROLL) {</span>
<span class="nc bnc" id="L7660" title="All 2 branches missed.">                if (entity.isAero()) {</span>
<span class="nc" id="L7661">                    IAero a = (IAero) entity;</span>
<span class="nc bnc" id="L7662" title="All 2 branches missed.">                    a.setRolled(!a.isRolled());</span>
                }
            }

            // check for dig in or fortify
<span class="nc bnc" id="L7667" title="All 2 branches missed.">            if (entity instanceof Infantry) {</span>
<span class="nc" id="L7668">                Infantry inf = (Infantry) entity;</span>
<span class="nc bnc" id="L7669" title="All 2 branches missed.">                if (step.getType() == MoveStepType.DIG_IN) {</span>
<span class="nc" id="L7670">                    inf.setDugIn(Infantry.DUG_IN_WORKING);</span>
<span class="nc" id="L7671">                    continue;</span>
<span class="nc bnc" id="L7672" title="All 2 branches missed.">                } else if (step.getType() == MoveStepType.FORTIFY) {</span>
<span class="nc bnc" id="L7673" title="All 2 branches missed.">                    if (!entity.hasWorkingMisc(MiscType.F_TOOLS,</span>
                            MiscType.S_VIBROSHOVEL)) {
<span class="nc" id="L7675">                        sendServerChat(entity.getDisplayName()</span>
                                + &quot; failed to fortify because it is missing suitable equipment&quot;);
                    }
<span class="nc" id="L7678">                    inf.setDugIn(Infantry.DUG_IN_FORTIFYING1);</span>
<span class="nc" id="L7679">                    continue;</span>
<span class="nc bnc" id="L7680" title="All 2 branches missed.">                } else if ((step.getType() != MoveStepType.TURN_LEFT)</span>
<span class="nc bnc" id="L7681" title="All 2 branches missed.">                        &amp;&amp; (step.getType() != MoveStepType.TURN_RIGHT)) {</span>
                    // other movement clears dug in status
<span class="nc" id="L7683">                    inf.setDugIn(Infantry.DUG_IN_NONE);</span>
                }

<span class="nc bnc" id="L7686" title="All 2 branches missed.">                if (step.getType() == MoveStepType.TAKE_COVER) {</span>
<span class="nc bnc" id="L7687" title="All 2 branches missed.">                    if (Infantry.hasValidCover(game, step.getPosition(),</span>
<span class="nc" id="L7688">                            step.getElevation())) {</span>
<span class="nc" id="L7689">                        inf.setTakingCover(true);</span>
                    } else {
<span class="nc" id="L7691">                        sendServerChat(entity.getDisplayName()</span>
                                + &quot; failed to take cover: &quot;
                                + &quot;no valid unit found in &quot;
<span class="nc" id="L7694">                                + step.getPosition());</span>
                    }
                }
            }

            // If we have turned, check whether we have fulfilled any turn mode requirements.
<span class="nc bnc" id="L7700" title="All 4 branches missed.">            if ((step.getType() == MoveStepType.TURN_LEFT || step.getType() == MoveStepType.TURN_RIGHT)</span>
<span class="nc bnc" id="L7701" title="All 2 branches missed.">                    &amp;&amp; entity.usesTurnMode()) {</span>
<span class="nc" id="L7702">                int straight = 0;</span>
<span class="nc bnc" id="L7703" title="All 2 branches missed.">                if (prevStep != null) {</span>
<span class="nc" id="L7704">                    straight = prevStep.getNStraight();</span>
                }
<span class="nc" id="L7706">                rollTarget = entity.checkTurnModeFailure(overallMoveType, straight,</span>
<span class="nc" id="L7707">                        md.getMpUsed(), step.getPosition());</span>
<span class="nc bnc" id="L7708" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L7709">                    int mof = doSkillCheckWhileMoving(entity, lastElevation, lastPos,</span>
                            curPos, rollTarget, false);
<span class="nc bnc" id="L7711" title="All 2 branches missed.">                    if (mof &gt; 0) {</span>
<span class="nc bnc" id="L7712" title="All 2 branches missed.">                        if (processFailedVehicleManeuver(entity, curPos,</span>
<span class="nc" id="L7713">                                step.getFacing() - curFacing,</span>
<span class="nc bnc" id="L7714" title="All 2 branches missed.">                                (null == prevStep)?step : prevStep,</span>
<span class="nc" id="L7715">                                        step.isThisStepBackwards(),</span>
                                        lastStepMoveType, distance, mof, mof)) {
<span class="nc bnc" id="L7717" title="All 2 branches missed.">                            if (md.hasActiveMASC()) {</span>
<span class="nc" id="L7718">                                mpUsed = entity.getRunMP();</span>
                            } else {
<span class="nc" id="L7720">                                mpUsed = entity.getRunMPwithoutMASC();</span>
                            }

<span class="nc" id="L7723">                            turnOver = true;</span>
<span class="nc" id="L7724">                            distance = entity.delta_distance;</span>
                        } else {
<span class="nc" id="L7726">                            continueTurnFromFishtail = true;</span>
                        }
<span class="nc" id="L7728">                        curFacing = entity.getFacing();</span>
<span class="nc" id="L7729">                        curPos = entity.getPosition();</span>
<span class="nc" id="L7730">                        entity.setSecondaryFacing(curFacing);</span>
<span class="nc" id="L7731">                        break;</span>
                    }
                }
            }

<span class="nc bnc" id="L7736" title="All 2 branches missed.">            if (step.getType() == MoveStepType.BOOTLEGGER) {</span>
<span class="nc" id="L7737">                rollTarget = entity.getBasePilotingRoll();</span>
<span class="nc" id="L7738">                entity.addPilotingModifierForTerrain(rollTarget);</span>
<span class="nc" id="L7739">                rollTarget.addModifier(0, &quot;bootlegger maneuver&quot;);</span>
<span class="nc" id="L7740">                int mof = doSkillCheckWhileMoving(entity, lastElevation,</span>
                        curPos, curPos, rollTarget, false);
<span class="nc bnc" id="L7742" title="All 2 branches missed.">                if (mof &gt; 0) {</span>
                    // If the bootlegger maneuver fails, we treat it as a turn in a random direction.
<span class="nc bnc" id="L7744" title="All 2 branches missed.">                    processFailedVehicleManeuver(entity, curPos, Compute.d6() &lt; 4 ? -1 : 1,</span>
<span class="nc bnc" id="L7745" title="All 2 branches missed.">                            (null == prevStep)? step : prevStep,</span>
<span class="nc" id="L7746">                            step.isThisStepBackwards(), lastStepMoveType, distance, 2, mof);</span>
<span class="nc" id="L7747">                    curFacing = entity.getFacing();</span>
<span class="nc" id="L7748">                    curPos = entity.getPosition();</span>
<span class="nc" id="L7749">                    break;</span>
                }
            }

            // set last step parameters
<span class="nc" id="L7754">            curPos = step.getPosition();</span>
<span class="nc bnc" id="L7755" title="All 4 branches missed.">            if (!((entity.getJumpType() == Mech.JUMP_BOOSTER) &amp;&amp; step.isJumping())) {</span>
<span class="nc" id="L7756">                curFacing = step.getFacing();</span>
            }
            // check if a building PSR will be needed later, before setting the
            // new elevation
<span class="nc" id="L7760">            int buildingMove = entity.checkMovementInBuilding(step, prevStep, curPos, lastPos);</span>
<span class="nc" id="L7761">            curVTOLElevation = step.getElevation();</span>
<span class="nc" id="L7762">            curAltitude = step.getAltitude();</span>
<span class="nc" id="L7763">            curElevation = step.getElevation();</span>
<span class="nc" id="L7764">            curClimbMode = step.climbMode();</span>
            // set elevation in case of collapses
<span class="nc" id="L7766">            entity.setElevation(step.getElevation());</span>
            // set climb mode in case of skid
<span class="nc" id="L7768">            entity.setClimbMode(curClimbMode);</span>

<span class="nc" id="L7770">            IHex curHex = game.getBoard().getHex(curPos);</span>

            // when first entering a building, we need to roll what type
            // of basement it has
<span class="nc bnc" id="L7774" title="All 4 branches missed.">            if (isOnGround &amp;&amp; curHex.containsTerrain(Terrains.BUILDING)) {</span>
<span class="nc" id="L7775">                Building bldg = game.getBoard().getBuildingAt(curPos);</span>
<span class="nc bnc" id="L7776" title="All 2 branches missed.">                if (bldg.rollBasement(curPos, game.getBoard(), vPhaseReport)) {</span>
<span class="nc" id="L7777">                    sendChangedHex(curPos);</span>
<span class="nc" id="L7778">                    Vector&lt;Building&gt; buildings = new Vector&lt;&gt;();</span>
<span class="nc" id="L7779">                    buildings.add(bldg);</span>
<span class="nc" id="L7780">                    sendChangedBuildings(buildings);</span>
                }
            }

            // check for automatic unstick
<span class="nc bnc" id="L7785" title="All 6 branches missed.">            if (entity.canUnstickByJumping() &amp;&amp; entity.isStuck()</span>
                    &amp;&amp; (moveType == EntityMovementType.MOVE_JUMP)) {
<span class="nc" id="L7787">                entity.setStuck(false);</span>
<span class="nc" id="L7788">                entity.setCanUnstickByJumping(false);</span>
            }

            // check for leap
<span class="nc bnc" id="L7792" title="All 6 branches missed.">            if (!lastPos.equals(curPos)</span>
                    &amp;&amp; (stepMoveType != EntityMovementType.MOVE_JUMP) &amp;&amp; (entity instanceof Mech)
<span class="nc bnc" id="L7794" title="All 4 branches missed.">                    &amp;&amp; !entity.isAirborne() &amp;&amp; (step.getClearance() &lt;= 0)  // Don't check airborne LAMs</span>
<span class="nc bnc" id="L7795" title="All 2 branches missed.">                    &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_LEAPING)) {</span>
<span class="nc" id="L7796">                int leapDistance = (lastElevation</span>
<span class="nc" id="L7797">                        + game.getBoard().getHex(lastPos).getLevel())</span>
<span class="nc" id="L7798">                        - (curElevation + curHex.getLevel());</span>
<span class="nc bnc" id="L7799" title="All 2 branches missed.">                if (leapDistance &gt; 2) {</span>
                    // skill check for leg damage
<span class="nc" id="L7801">                    rollTarget = entity.getBasePilotingRoll(stepMoveType);</span>
<span class="nc" id="L7802">                    entity.addPilotingModifierForTerrain(rollTarget, curPos);</span>
<span class="nc" id="L7803">                    rollTarget.append(new PilotingRollData(entity.getId(),</span>
                            2 * leapDistance, &quot;leaping (leg damage)&quot;));
<span class="nc bnc" id="L7805" title="All 2 branches missed.">                    if (0 &lt; doSkillCheckWhileMoving(entity, lastElevation,</span>
                            lastPos, curPos, rollTarget, false)) {
                        // do leg damage
<span class="nc" id="L7808">                        addReport(damageEntity(entity, new HitData(Mech.LOC_LLEG), leapDistance));</span>
<span class="nc" id="L7809">                        addReport(damageEntity(entity, new HitData(Mech.LOC_RLEG), leapDistance));</span>
<span class="nc" id="L7810">                        addNewLines();</span>
<span class="nc" id="L7811">                        addReport(criticalEntity(entity, Mech.LOC_LLEG, false, 0, 0));</span>
<span class="nc" id="L7812">                        addNewLines();</span>
<span class="nc" id="L7813">                        addReport(criticalEntity(entity, Mech.LOC_RLEG, false, 0, 0));</span>
<span class="nc bnc" id="L7814" title="All 2 branches missed.">                        if (entity instanceof QuadMech) {</span>
<span class="nc" id="L7815">                            addReport(damageEntity(entity, new HitData(Mech.LOC_LARM), leapDistance));</span>
<span class="nc" id="L7816">                            addReport(damageEntity(entity, new HitData(Mech.LOC_RARM), leapDistance));</span>
<span class="nc" id="L7817">                            addNewLines();</span>
<span class="nc" id="L7818">                            addReport(criticalEntity(entity, Mech.LOC_LARM, false, 0, 0));</span>
<span class="nc" id="L7819">                            addNewLines();</span>
<span class="nc" id="L7820">                            addReport(criticalEntity(entity, Mech.LOC_RARM, false, 0, 0));</span>
                        }
                    }
                    // skill check for fall
<span class="nc" id="L7824">                    rollTarget = entity.getBasePilotingRoll(stepMoveType);</span>
<span class="nc" id="L7825">                    entity.addPilotingModifierForTerrain(rollTarget, curPos);</span>
<span class="nc" id="L7826">                    rollTarget.append(new PilotingRollData(entity.getId(),</span>
                            leapDistance, &quot;leaping (fall)&quot;));
<span class="nc bnc" id="L7828" title="All 2 branches missed.">                    if (0 &lt; doSkillCheckWhileMoving(entity, lastElevation,</span>
                            lastPos, curPos, rollTarget, false)) {
<span class="nc" id="L7830">                        entity.setElevation(lastElevation);</span>
<span class="nc" id="L7831">                        addReport(doEntityFallsInto(entity, lastElevation,</span>
                                lastPos, curPos,
<span class="nc" id="L7833">                                entity.getBasePilotingRoll(overallMoveType), false));</span>
                    }
                }
            }
            
            // Check for skid.
<span class="nc" id="L7839">            rollTarget = entity.checkSkid(moveType, prevHex, overallMoveType,</span>
                    prevStep, step, prevFacing, curFacing, lastPos, curPos,
                    isInfantry, distance - 1);
<span class="nc bnc" id="L7842" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
                // Have an entity-meaningful PSR message.
                boolean psrFailed;
<span class="nc" id="L7845">                int startingFacing = entity.getFacing();</span>
<span class="nc bnc" id="L7846" title="All 2 branches missed.">                if (entity instanceof Mech) {</span>
                    // We need to ensure that falls will happen from the proper
                    // facing
<span class="nc" id="L7849">                    entity.setFacing(curFacing);</span>
<span class="nc bnc" id="L7850" title="All 2 branches missed.">                    psrFailed = (0 &lt; doSkillCheckWhileMoving(entity,</span>
                            lastElevation, lastPos, lastPos, rollTarget, true));
                } else {
<span class="nc bnc" id="L7853" title="All 2 branches missed.">                    psrFailed = (0 &lt; doSkillCheckWhileMoving(entity,</span>
                            lastElevation, lastPos, lastPos, rollTarget, false));
                }

                // Does the entity skid?
<span class="nc bnc" id="L7858" title="All 2 branches missed.">                if (psrFailed) {</span>

<span class="nc bnc" id="L7860" title="All 2 branches missed.">                    if (entity instanceof Tank) {</span>
<span class="nc" id="L7861">                        addReport(vehicleMotiveDamage((Tank)entity, 0));</span>
                    }

<span class="nc" id="L7864">                    curPos = lastPos;</span>
<span class="nc" id="L7865">                    int skidDistance = (int) Math.round((double) (distance - 1) / 2);</span>
<span class="nc" id="L7866">                    int skidDirection = prevFacing;</span>

                    // All charge damage is based upon
                    // the pre-skid move distance.
<span class="nc" id="L7870">                    entity.delta_distance = distance - 1;</span>

                    // Attacks against a skidding target have additional +2.
<span class="nc" id="L7873">                    moveType = EntityMovementType.MOVE_SKID;</span>

                    // What is the first hex in the skid?
<span class="nc bnc" id="L7876" title="All 2 branches missed.">                    if (step.isThisStepBackwards()) {</span>
<span class="nc" id="L7877">                        skidDirection = (skidDirection + 3) % 6;</span>
                    }

<span class="nc bnc" id="L7880" title="All 2 branches missed.">                    if (processSkid(entity, curPos, prevStep.getElevation(),</span>
                            skidDirection, skidDistance, prevStep,
                            lastStepMoveType)) {
<span class="nc" id="L7883">                        return;</span>
                    }

                    // set entity parameters
<span class="nc" id="L7887">                    curFacing = entity.getFacing();</span>
<span class="nc" id="L7888">                    curPos = entity.getPosition();</span>
<span class="nc" id="L7889">                    entity.setSecondaryFacing(curFacing);</span>

                    // skid consumes all movement
<span class="nc bnc" id="L7892" title="All 2 branches missed.">                    if (md.hasActiveMASC()) {</span>
<span class="nc" id="L7893">                        mpUsed = entity.getRunMP();</span>
                    } else {
<span class="nc" id="L7895">                        mpUsed = entity.getRunMPwithoutMASC();</span>
                    }

<span class="nc" id="L7898">                    entity.moved = moveType;</span>
<span class="nc" id="L7899">                    fellDuringMovement = true;</span>
<span class="nc" id="L7900">                    turnOver = true;</span>
<span class="nc" id="L7901">                    distance = entity.delta_distance;</span>
<span class="nc" id="L7902">                    break;</span>

                } else { // End failed-skid-psr
                    // If the check succeeded, restore the facing we had before
                    // if it failed, the fall will have changed facing
<span class="nc" id="L7907">                    entity.setFacing(startingFacing);</span>
                }

            } // End need-skid-psr

            // check sideslip
<span class="nc bnc" id="L7913" title="All 2 branches missed.">            if ((entity instanceof VTOL)</span>
<span class="nc bnc" id="L7914" title="All 2 branches missed.">                    || (entity.getMovementMode() == EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L7915" title="All 2 branches missed.">                    || (entity.getMovementMode() == EntityMovementMode.WIGE</span>
<span class="nc bnc" id="L7916" title="All 2 branches missed.">                            &amp;&amp; step.getClearance() &gt; 0)) {</span>
<span class="nc" id="L7917">                rollTarget = entity.checkSideSlip(moveType, prevHex,</span>
                        overallMoveType, prevStep, prevFacing, curFacing,
                        lastPos, curPos, distance);
<span class="nc bnc" id="L7920" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L7921">                    int moF = doSkillCheckWhileMoving(entity, lastElevation,</span>
                            lastPos, curPos, rollTarget, false);
<span class="nc bnc" id="L7923" title="All 2 branches missed.">                    if (moF &gt; 0) {</span>
                        int elev;
                        int sideslipDistance;
                        int skidDirection;
                        Coords start;
<span class="nc bnc" id="L7928" title="All 2 branches missed.">                        if (step.getType() == MoveStepType.LATERAL_LEFT</span>
<span class="nc bnc" id="L7929" title="All 2 branches missed.">                                || step.getType() == MoveStepType.LATERAL_RIGHT</span>
<span class="nc bnc" id="L7930" title="All 2 branches missed.">                                || step.getType() == MoveStepType.LATERAL_LEFT_BACKWARDS</span>
<span class="nc bnc" id="L7931" title="All 2 branches missed.">                                || step.getType() == MoveStepType.LATERAL_RIGHT_BACKWARDS) {</span>
                            // A failed controlled sideslip always results in moving one additional hex
                            // in the direction of the intentional sideslip.
<span class="nc" id="L7934">                            elev = step.getElevation();</span>
<span class="nc" id="L7935">                            sideslipDistance = 1;</span>
<span class="nc" id="L7936">                            skidDirection = lastPos.direction(curPos);</span>
<span class="nc" id="L7937">                            start = curPos;</span>
                        } else {
<span class="nc bnc" id="L7939" title="All 2 branches missed.">                            elev = (null == prevStep)? curElevation : prevStep.getElevation();</span>
                            // maximum distance is hexes moved / 2
<span class="nc" id="L7941">                            sideslipDistance = Math.min(moF, distance / 2);</span>
<span class="nc" id="L7942">                            skidDirection = prevFacing;</span>
<span class="nc" id="L7943">                            start = lastPos;</span>
                        }
<span class="nc bnc" id="L7945" title="All 2 branches missed.">                        if (sideslipDistance &gt; 0) {</span>
<span class="nc" id="L7946">                            sideslipped = true;</span>
<span class="nc" id="L7947">                            r = new Report(2100);</span>
<span class="nc" id="L7948">                            r.subject = entity.getId();</span>
<span class="nc" id="L7949">                            r.addDesc(entity);</span>
<span class="nc" id="L7950">                            r.add(sideslipDistance);</span>
<span class="nc" id="L7951">                            addReport(r);</span>

<span class="nc bnc" id="L7953" title="All 2 branches missed.">                            if (processSkid(entity, start, elev, skidDirection,</span>
<span class="nc bnc" id="L7954" title="All 2 branches missed.">                                    sideslipDistance, (null == prevStep)? step : prevStep,</span>
                                    lastStepMoveType)) {
<span class="nc" id="L7956">                                return;</span>
                            }

<span class="nc bnc" id="L7959" title="All 4 branches missed.">                            if (!entity.isDestroyed() &amp;&amp; !entity.isDoomed()</span>
<span class="nc bnc" id="L7960" title="All 2 branches missed.">                                    &amp;&amp; (mpUsed &lt; entity.getRunMP())) {</span>
<span class="nc" id="L7961">                                fellDuringMovement = true; // No, but it should</span>
                                // work...
                            }

<span class="nc bnc" id="L7965" title="All 2 branches missed.">                            if ((entity.getElevation() == 0)</span>
<span class="nc bnc" id="L7966" title="All 2 branches missed.">                                    &amp;&amp; ((entity.getMovementMode() == EntityMovementMode.VTOL)</span>
<span class="nc bnc" id="L7967" title="All 2 branches missed.">                                        || (entity.getMovementMode() == EntityMovementMode.WIGE))) {</span>
<span class="nc" id="L7968">                                turnOver = true;</span>
                            }
                            // set entity parameters
<span class="nc" id="L7971">                            curFacing = step.getFacing();</span>
<span class="nc" id="L7972">                            curPos = entity.getPosition();</span>
<span class="nc" id="L7973">                            entity.setSecondaryFacing(curFacing);</span>
<span class="nc" id="L7974">                            break;</span>
                        }
                    }
                }
            }

            // check if we've moved into rubble
<span class="nc" id="L7981">            boolean isLastStep = step.equals(md.getLastStep());</span>
<span class="nc" id="L7982">            rollTarget = entity.checkRubbleMove(step, overallMoveType, curHex,</span>
                    lastPos, curPos, isLastStep, isPavementStep);
<span class="nc bnc" id="L7984" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L7985">                doSkillCheckWhileMoving(entity, lastElevation, lastPos, curPos,</span>
                        rollTarget, true);
            }

            // check if we are using reckless movement
<span class="nc" id="L7990">            rollTarget = entity.checkRecklessMove(step, overallMoveType, curHex,</span>
                    lastPos, curPos, prevHex);
<span class="nc bnc" id="L7992" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc bnc" id="L7993" title="All 2 branches missed.">                if (entity instanceof Mech) {</span>
<span class="nc" id="L7994">                    doSkillCheckWhileMoving(entity, lastElevation, lastPos,</span>
                            curPos, rollTarget, true);
<span class="nc bnc" id="L7996" title="All 2 branches missed.">                } else if (entity instanceof Tank) {</span>
<span class="nc bnc" id="L7997" title="All 2 branches missed.">                    if (0 &lt; doSkillCheckWhileMoving(entity, lastElevation,</span>
                            lastPos, curPos, rollTarget, false)) {
                        // assume VTOLs in flight are always in clear terrain
<span class="nc bnc" id="L8000" title="All 2 branches missed.">                        if ((0 == curHex.terrainsPresent())</span>
<span class="nc bnc" id="L8001" title="All 2 branches missed.">                                || (step.getClearance() &gt; 0)) {</span>
<span class="nc bnc" id="L8002" title="All 2 branches missed.">                            if (entity instanceof VTOL) {</span>
<span class="nc" id="L8003">                                r = new Report(2208);</span>
                            } else {
<span class="nc" id="L8005">                                r = new Report(2206);</span>
                            }
<span class="nc" id="L8007">                            r.addDesc(entity);</span>
<span class="nc" id="L8008">                            r.subject = entity.getId();</span>
<span class="nc" id="L8009">                            addReport(r);</span>
<span class="nc" id="L8010">                            mpUsed = step.getMpUsed() + 1;</span>
<span class="nc" id="L8011">                            fellDuringMovement = true;</span>
<span class="nc" id="L8012">                            break;</span>
                        }
<span class="nc" id="L8014">                        r = new Report(2207);</span>
<span class="nc" id="L8015">                        r.addDesc(entity);</span>
<span class="nc" id="L8016">                        r.subject = entity.getId();</span>
<span class="nc" id="L8017">                        addReport(r);</span>
                        // until we get a rules clarification assume that the
                        // entity is both giver and taker
                        // for charge damage
<span class="nc" id="L8021">                        HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L8022">                        addReport(damageEntity(entity, hit, ChargeAttackAction</span>
<span class="nc" id="L8023">                                .getDamageTakenBy(entity, entity)));</span>
<span class="nc" id="L8024">                        turnOver = true;</span>
<span class="nc" id="L8025">                        break;</span>
                    }
                }
            }

            // check for breaking magma crust unless we are jumping over the hex
<span class="nc bnc" id="L8031" title="All 2 branches missed.">            if (stepMoveType != EntityMovementType.MOVE_JUMP) {</span>
<span class="nc" id="L8032">                ServerHelper.checkAndApplyMagmaCrust(curHex, step.getElevation(), entity, curPos, false, vPhaseReport, this);</span>
            }

            // check if we've moved into a swamp
<span class="nc" id="L8036">            rollTarget = entity.checkBogDown(step, lastStepMoveType, curHex,</span>
                    lastPos, curPos, lastElevation, isPavementStep);
<span class="nc bnc" id="L8038" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc bnc" id="L8039" title="All 2 branches missed.">                if (0 &lt; doSkillCheckWhileMoving(entity, lastElevation, lastPos,</span>
                        curPos, rollTarget, false)) {
<span class="nc" id="L8041">                    entity.setStuck(true);</span>
<span class="nc" id="L8042">                    entity.setCanUnstickByJumping(true);</span>
<span class="nc" id="L8043">                    r = new Report(2081);</span>
<span class="nc" id="L8044">                    r.add(entity.getDisplayName());</span>
<span class="nc" id="L8045">                    r.subject = entity.getId();</span>
<span class="nc" id="L8046">                    addReport(r);</span>
                    // check for quicksand
<span class="nc" id="L8048">                    addReport(checkQuickSand(curPos));</span>
                    // check for accidental stacking violation
<span class="nc" id="L8050">                    Entity violation = Compute.stackingViolation(game,</span>
<span class="nc" id="L8051">                            entity.getId(), curPos);</span>
<span class="nc bnc" id="L8052" title="All 2 branches missed.">                    if (violation != null) {</span>
                        // target gets displaced, because of low elevation
<span class="nc" id="L8054">                        int direction = lastPos.direction(curPos);</span>
<span class="nc" id="L8055">                        Coords targetDest = Compute.getValidDisplacement(game,</span>
<span class="nc" id="L8056">                                entity.getId(), curPos, direction);</span>
<span class="nc" id="L8057">                        addReport(doEntityDisplacement(violation, curPos,</span>
                                targetDest,
<span class="nc" id="L8059">                                new PilotingRollData(violation.getId(), 0,</span>
                                        &quot;domino effect&quot;)));
                        // Update the violating entity's position on the client.
<span class="nc" id="L8062">                        entityUpdate(violation.getId());</span>
<span class="nc" id="L8063">                    }</span>
                    break;
                }
            }

            // check to see if we are a mech and we've moved OUT of fire
<span class="nc" id="L8069">            IHex lastHex = game.getBoard().getHex(lastPos);</span>
<span class="nc bnc" id="L8070" title="All 2 branches missed.">            if (entity instanceof Mech) {</span>
<span class="nc bnc" id="L8071" title="All 4 branches missed.">                if (!lastPos.equals(curPos) &amp;&amp; (prevStep != null)</span>
<span class="nc bnc" id="L8072" title="All 2 branches missed.">                        &amp;&amp; ((lastHex.containsTerrain(Terrains.FIRE)</span>
<span class="nc bnc" id="L8073" title="All 2 branches missed.">                                &amp;&amp; (prevStep.getElevation() &lt;= 1))</span>
<span class="nc bnc" id="L8074" title="All 2 branches missed.">                                || (lastHex.containsTerrain(Terrains.MAGMA)</span>
<span class="nc bnc" id="L8075" title="All 4 branches missed.">                                        &amp;&amp; (prevStep.getElevation() == 0)))</span>
                        &amp;&amp; ((stepMoveType != EntityMovementType.MOVE_JUMP)
                                // Bug #828741 -- jumping bypasses fire, but not
                                // on the
                                // first step
                                // getMpUsed -- total MP used to this step
                                // getMp -- MP used in this step
                                // the difference will always be 0 on the &quot;first
                                // step&quot;
                                // of a jump,
                                // and &gt;0 on a step in the midst of a jump
<span class="nc bnc" id="L8086" title="All 2 branches missed.">                                || (0 == (step.getMpUsed() - step.getMp())))) {</span>
<span class="nc" id="L8087">                    int heat = 0;</span>
<span class="nc bnc" id="L8088" title="All 2 branches missed.">                    if (lastHex.containsTerrain(Terrains.FIRE)) {</span>
<span class="nc" id="L8089">                        heat += 2;</span>
                    }
<span class="nc bnc" id="L8091" title="All 2 branches missed.">                    if (lastHex.terrainLevel(Terrains.MAGMA) == 1) {</span>
<span class="nc" id="L8092">                        heat += 2;</span>
<span class="nc bnc" id="L8093" title="All 2 branches missed.">                    } else if (lastHex.terrainLevel(Terrains.MAGMA) == 2) {</span>
<span class="nc" id="L8094">                        heat += 5;</span>
                    }
<span class="nc bnc" id="L8096" title="All 2 branches missed.">                    if (((Mech) entity).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L8097">                        heat /= 2;</span>
                    }
<span class="nc" id="L8099">                    entity.heatFromExternal += heat;</span>
<span class="nc" id="L8100">                    r = new Report(2115);</span>
<span class="nc" id="L8101">                    r.subject = entity.getId();</span>
<span class="nc" id="L8102">                    r.addDesc(entity);</span>
<span class="nc" id="L8103">                    r.add(heat);</span>
<span class="nc" id="L8104">                    addReport(r);</span>
<span class="nc bnc" id="L8105" title="All 2 branches missed.">                    if (((Mech) entity).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L8106">                        r = new Report(5550);</span>
<span class="nc" id="L8107">                        addReport(r);</span>
                    }
                }
            }

            // check to see if we are not a mech and we've moved INTO fire
<span class="nc bnc" id="L8113" title="All 2 branches missed.">            if (!(entity instanceof Mech)) {</span>
<span class="nc" id="L8114">                boolean underwater = game.getBoard().getHex(curPos)</span>
<span class="nc bnc" id="L8115" title="All 2 branches missed.">                        .containsTerrain(Terrains.WATER)</span>
<span class="nc bnc" id="L8116" title="All 2 branches missed.">                        &amp;&amp; (game.getBoard().getHex(curPos).depth() &gt; 0)</span>
<span class="nc bnc" id="L8117" title="All 2 branches missed.">                        &amp;&amp; (step.getElevation() &lt; game.getBoard().getHex(curPos).surface());</span>
<span class="nc bnc" id="L8118" title="All 2 branches missed.">                if (game.getBoard().getHex(curPos).containsTerrain(</span>
<span class="nc bnc" id="L8119" title="All 4 branches missed.">                        Terrains.FIRE) &amp;&amp; !lastPos.equals(curPos)</span>
                        &amp;&amp; (stepMoveType != EntityMovementType.MOVE_JUMP)
<span class="nc bnc" id="L8121" title="All 4 branches missed.">                        &amp;&amp; (step.getElevation() &lt;= 1) &amp;&amp; !underwater) {</span>
<span class="nc" id="L8122">                    doFlamingDamage(entity);</span>
                }
            }
            // check for extreme gravity movement
<span class="nc bnc" id="L8126" title="All 4 branches missed.">            if (!i.hasMoreElements() &amp;&amp; !firstStep) {</span>
<span class="nc" id="L8127">                checkExtremeGravityMovement(entity, step, lastStepMoveType, curPos, cachedGravityLimit);</span>
            }
            // check for minefields. have to check both new hex and new
            // elevation
            // VTOLs may land and submarines may rise or lower into a minefield
<span class="nc bnc" id="L8132" title="All 4 branches missed.">            if (!lastPos.equals(curPos) || (lastElevation != curElevation)) {</span>
<span class="nc" id="L8133">                boolean boom = false;</span>
<span class="nc bnc" id="L8134" title="All 2 branches missed.">                if (isOnGround) {</span>
<span class="nc" id="L8135">                    boom = checkVibrabombs(entity, curPos, false, lastPos, curPos, vPhaseReport);</span>
                }
<span class="nc bnc" id="L8137" title="All 2 branches missed.">                if (game.containsMinefield(curPos)) {</span>
                    // set the new position temporarily, because
                    // infantry otherwise would get double damage
                    // when moving from clear into mined woods
<span class="nc" id="L8141">                    entity.setPosition(curPos);</span>
<span class="nc bnc" id="L8142" title="All 2 branches missed.">                    if (enterMinefield(entity, curPos, step.getElevation(),</span>
                            isOnGround, vPhaseReport)) {
                        // resolve any piloting rolls from damage unless unit
                        // was jumping
<span class="nc bnc" id="L8146" title="All 2 branches missed.">                        if (stepMoveType != EntityMovementType.MOVE_JUMP) {</span>
<span class="nc" id="L8147">                            addReport(resolvePilotingRolls(entity));</span>
<span class="nc" id="L8148">                            game.resetPSRs(entity);</span>
                        }
<span class="nc" id="L8150">                        boom = true;</span>
                    }
<span class="nc bnc" id="L8152" title="All 4 branches missed.">                    if (wasProne || !entity.isProne()) {</span>
<span class="nc" id="L8153">                        entity.setPosition(lastPos);</span>
                    }
                }
                // did anything go boom?
<span class="nc bnc" id="L8157" title="All 2 branches missed.">                if (boom) {</span>
                    // set fell during movement so that entity will get another
                    // chance to move with any motive damage
                    // taken account of (functions the same as MASC failure)
                    // only do this if they had more steps (and they were not
                    // jumping
<span class="nc bnc" id="L8163" title="All 4 branches missed.">                    if (i.hasMoreElements() &amp;&amp; (stepMoveType != EntityMovementType.MOVE_JUMP)) {</span>
<span class="nc" id="L8164">                        md.clear();</span>
<span class="nc" id="L8165">                        fellDuringMovement = true;</span>
                    }
                    // reset mines if anything detonated
<span class="nc" id="L8168">                    resetMines();</span>
                }
            }

            // infantry discovers minefields if they end their move
            // in a minefield.
<span class="nc bnc" id="L8174" title="All 6 branches missed.">            if (!lastPos.equals(curPos) &amp;&amp; !i.hasMoreElements() &amp;&amp; isInfantry) {</span>
<span class="nc bnc" id="L8175" title="All 2 branches missed.">                if (game.containsMinefield(curPos)) {</span>
<span class="nc" id="L8176">                    IPlayer owner = entity.getOwner();</span>
<span class="nc bnc" id="L8177" title="All 2 branches missed.">                    for (Minefield mf : game.getMinefields(curPos)) {</span>
<span class="nc bnc" id="L8178" title="All 2 branches missed.">                        if (!owner.containsMinefield(mf)) {</span>
<span class="nc" id="L8179">                            r = new Report(2120);</span>
<span class="nc" id="L8180">                            r.subject = entity.getId();</span>
<span class="nc" id="L8181">                            r.add(entity.getShortName(), true);</span>
<span class="nc" id="L8182">                            addReport(r);</span>
<span class="nc" id="L8183">                            revealMinefield(game.getTeamForPlayer(owner), mf);</span>
                        }
<span class="nc" id="L8185">                    }</span>
                }
            }

            // check if we've moved into water
<span class="nc" id="L8190">            rollTarget = entity.checkWaterMove(step, lastStepMoveType, curHex,</span>
                    lastPos, curPos, isPavementStep);
<span class="nc bnc" id="L8192" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
                // Swarmers need special handling.
<span class="nc" id="L8194">                final int swarmerId = entity.getSwarmAttackerId();</span>
<span class="nc" id="L8195">                boolean swarmerDone = true;</span>
<span class="nc" id="L8196">                Entity swarmer = null;</span>
<span class="nc bnc" id="L8197" title="All 2 branches missed.">                if (Entity.NONE != swarmerId) {</span>
<span class="nc" id="L8198">                    swarmer = game.getEntity(swarmerId);</span>
<span class="nc" id="L8199">                    swarmerDone = swarmer.isDone();</span>
                }

                // Now do the skill check.
<span class="nc" id="L8203">                entity.setFacing(curFacing);</span>
<span class="nc" id="L8204">                doSkillCheckWhileMoving(entity, lastElevation, lastPos, curPos, rollTarget, true);</span>

                // Swarming infantry platoons may drown.
<span class="nc bnc" id="L8207" title="All 2 branches missed.">                if (curHex.terrainLevel(Terrains.WATER) &gt; 1) {</span>
<span class="nc" id="L8208">                    drownSwarmer(entity, curPos);</span>
                }

                // Do we need to remove a game turn for the swarmer
<span class="nc bnc" id="L8212" title="All 4 branches missed.">                if (!swarmerDone &amp;&amp; (swarmer != null)</span>
<span class="nc bnc" id="L8213" title="All 4 branches missed.">                        &amp;&amp; (swarmer.isDoomed() || swarmer.isDestroyed())) {</span>
                    // We have to diddle with the swarmer's
                    // status to get its turn removed.
<span class="nc" id="L8216">                    swarmer.setDone(false);</span>
<span class="nc" id="L8217">                    swarmer.setUnloaded(false);</span>

                    // Dead entities don't take turns.
<span class="nc" id="L8220">                    game.removeTurnFor(swarmer);</span>
<span class="nc" id="L8221">                    send(createTurnVectorPacket());</span>

                    // Return the original status.
<span class="nc" id="L8224">                    swarmer.setDone(true);</span>
<span class="nc" id="L8225">                    swarmer.setUnloaded(true);</span>
                }

                // check for inferno wash-off
<span class="nc" id="L8229">                checkForWashedInfernos(entity, curPos);</span>
            }

            // In water, may or may not be a new hex, necessary to
            // check during movement, for breach damage, and always
            // set dry if appropriate
            // TODO : possibly make the locations local and set later
<span class="nc bnc" id="L8236" title="All 2 branches missed.">            addReport(doSetLocationsExposure(entity, curHex,</span>
                    stepMoveType == EntityMovementType.MOVE_JUMP,
<span class="nc" id="L8238">                    step.getElevation()));</span>

            // check for breaking ice by breaking through from below
<span class="nc bnc" id="L8241" title="All 4 branches missed.">            if ((lastElevation &lt; 0) &amp;&amp; (step.getElevation() == 0)</span>
<span class="nc bnc" id="L8242" title="All 2 branches missed.">                    &amp;&amp; lastHex.containsTerrain(Terrains.ICE)</span>
<span class="nc bnc" id="L8243" title="All 4 branches missed.">                    &amp;&amp; lastHex.containsTerrain(Terrains.WATER)</span>
                    &amp;&amp; (stepMoveType != EntityMovementType.MOVE_JUMP)
<span class="nc bnc" id="L8245" title="All 2 branches missed.">                    &amp;&amp; !lastPos.equals(curPos)) {</span>
                // need to temporarily reset entity's position so it doesn't
                // fall in the ice
<span class="nc" id="L8248">                entity.setPosition(curPos);</span>
<span class="nc" id="L8249">                r = new Report(2410);</span>
<span class="nc" id="L8250">                r.addDesc(entity);</span>
<span class="nc" id="L8251">                addReport(r);</span>
<span class="nc" id="L8252">                addReport(resolveIceBroken(lastPos));</span>
                // ok now set back
<span class="nc" id="L8254">                entity.setPosition(lastPos);</span>
            }
            // check for breaking ice by stepping on it
<span class="nc bnc" id="L8257" title="All 2 branches missed.">            if (curHex.containsTerrain(Terrains.ICE)</span>
<span class="nc bnc" id="L8258" title="All 4 branches missed.">                    &amp;&amp; curHex.containsTerrain(Terrains.WATER)</span>
                    &amp;&amp; (stepMoveType != EntityMovementType.MOVE_JUMP)
<span class="nc bnc" id="L8260" title="All 6 branches missed.">                    &amp;&amp; !lastPos.equals(curPos) &amp;&amp; !(entity instanceof Infantry)</span>
<span class="nc bnc" id="L8261" title="All 2 branches missed.">                    &amp;&amp; !(isPavementStep &amp;&amp; curHex.containsTerrain(Terrains.BRIDGE))) {</span>
<span class="nc bnc" id="L8262" title="All 2 branches missed.">                if (step.getElevation() == 0) {</span>
<span class="nc" id="L8263">                    int roll = Compute.d6(1);</span>
<span class="nc" id="L8264">                    r = new Report(2118);</span>
<span class="nc" id="L8265">                    r.addDesc(entity);</span>
<span class="nc" id="L8266">                    r.add(roll);</span>
<span class="nc" id="L8267">                    r.subject = entity.getId();</span>
<span class="nc" id="L8268">                    addReport(r);</span>
<span class="nc bnc" id="L8269" title="All 2 branches missed.">                    if (roll == 6) {</span>
<span class="nc" id="L8270">                        entity.setPosition(curPos);</span>
<span class="nc" id="L8271">                        addReport(resolveIceBroken(curPos));</span>
<span class="nc" id="L8272">                        curPos = entity.getPosition();</span>
                    }
<span class="nc" id="L8274">                }</span>
                // or intersecting it
<span class="nc bnc" id="L8276" title="All 2 branches missed.">                else if ((step.getElevation() + entity.height()) == 0) {</span>
<span class="nc" id="L8277">                    r = new Report(2410);</span>
<span class="nc" id="L8278">                    r.addDesc(entity);</span>
<span class="nc" id="L8279">                    addReport(r);</span>
<span class="nc" id="L8280">                    addReport(resolveIceBroken(curPos));</span>
                }
            }

            // Handle loading units.
<span class="nc bnc" id="L8285" title="All 2 branches missed.">            if (step.getType() == MoveStepType.LOAD) {</span>

                // Find the unit being loaded.
<span class="nc" id="L8288">                Entity loaded = null;</span>
<span class="nc" id="L8289">                Iterator&lt;Entity&gt; entities = game.getEntities(curPos);</span>
<span class="nc bnc" id="L8290" title="All 2 branches missed.">                while (entities.hasNext()) {</span>

                    // Is the other unit friendly and not the current entity?
<span class="nc" id="L8293">                    loaded = entities.next();</span>

                    // This should never ever happen, but just in case...
<span class="nc bnc" id="L8296" title="All 2 branches missed.">                    if (loaded.equals(null)) {</span>
<span class="nc" id="L8297">                        continue;</span>
                    }

<span class="nc bnc" id="L8300" title="All 4 branches missed.">                    if (!entity.isEnemyOf(loaded) &amp;&amp; !entity.equals(loaded)) {</span>
                        // The moving unit should be able to load the other
                        // unit and the other should be able to have a turn.
<span class="nc bnc" id="L8303" title="All 4 branches missed.">                        if (!entity.canLoad(loaded) || !loaded.isLoadableThisTurn()) {</span>
                            // Something is fishy in Denmark.
<span class="nc" id="L8305">                            MegaMek.getLogger().error(entity.getShortName() + &quot; can not load &quot; + loaded.getShortName());</span>
<span class="nc" id="L8306">                            loaded = null;</span>
                        } else {
                            // Have the deployed unit load the indicated unit.
<span class="nc" id="L8309">                            loadUnit(entity, loaded, loaded.getTargetBay());</span>

                            // Stop looking.
<span class="nc" id="L8312">                            break;</span>
                        }

                    } else {
                        // Nope. Discard it.
<span class="nc" id="L8317">                        loaded = null;</span>
                    }

                } // Handle the next entity in this hex.

                // We were supposed to find someone to load.
<span class="nc bnc" id="L8323" title="All 2 branches missed.">                if (loaded == null) {</span>
<span class="nc" id="L8324">                    MegaMek.getLogger().error(&quot;Could not find unit for &quot; + entity.getShortName() + &quot; to load in &quot; + curPos);</span>
                }

            } // End STEP_LOAD

         // Handle towing units.
<span class="nc bnc" id="L8330" title="All 2 branches missed.">            if (step.getType() == MoveStepType.TOW) {</span>

                // Find the unit being loaded.
                Entity loaded;
<span class="nc" id="L8334">                loaded = game.getEntity(entity.getTowing());</span>

                // This should never ever happen, but just in case...
<span class="nc bnc" id="L8337" title="All 2 branches missed.">                if (loaded == null) {</span>
<span class="nc" id="L8338">                    MegaMek.getLogger().error(&quot;Could not find unit for &quot; + entity.getShortName() + &quot; to tow.&quot;);</span>
<span class="nc" id="L8339">                    continue;</span>
                }

                // The moving unit should be able to tow the other
                // unit and the other should be able to have a turn.
                //FIXME: I know this check duplicates functions already performed when enabling the Tow button.
                //This code made more sense as borrowed from &quot;Load&quot; where we actually rechecked the hex for the target unit.
                //Do we need it here for safety, client/server sync or can this be further streamlined?
<span class="nc bnc" id="L8347" title="All 2 branches missed.">                if (!entity.canTow(loaded.getId())) {</span>
                    // Something is fishy in Denmark.
<span class="nc" id="L8349">                    MegaMek.getLogger().error(entity.getShortName() + &quot; can not tow &quot; + loaded.getShortName());</span>
                } else {
                    // Have the deployed unit load the indicated unit.
<span class="nc" id="L8352">                    towUnit(entity, loaded);</span>
                }
            } // End STEP_TOW

            // Handle mounting units to small craft/DropShip
<span class="nc bnc" id="L8357" title="All 2 branches missed.">            if (step.getType() == MoveStepType.MOUNT) {</span>
<span class="nc" id="L8358">                Targetable mountee = step.getTarget(game);</span>
<span class="nc bnc" id="L8359" title="All 2 branches missed.">                if (mountee instanceof Entity) {</span>
<span class="nc" id="L8360">                    Entity dropShip = (Entity) mountee;</span>
<span class="nc bnc" id="L8361" title="All 2 branches missed.">                    if (!dropShip.canLoad(entity)) {</span>
                        // Something is fishy in Denmark.
<span class="nc" id="L8363">                        MegaMek.getLogger().error(dropShip.getShortName() + &quot; can not load &quot; + entity.getShortName());</span>
                    } else {
                        // Have the indicated unit load this unit.
<span class="nc" id="L8366">                        entity.setDone(true);</span>
<span class="nc" id="L8367">                        loadUnit(dropShip, entity, entity.getTargetBay());</span>
<span class="nc" id="L8368">                        Bay currentBay = dropShip.getBay(entity);</span>
<span class="nc bnc" id="L8369" title="All 4 branches missed.">                        if ((null != currentBay) &amp;&amp; (Compute.d6(2) == 2)) {</span>
<span class="nc" id="L8370">                            r = new Report(9390);</span>
<span class="nc" id="L8371">                            r.subject = entity.getId();</span>
<span class="nc" id="L8372">                            r.indent(1);</span>
<span class="nc" id="L8373">                            r.add(currentBay.getType());</span>
<span class="nc" id="L8374">                            addReport(r);</span>
<span class="nc" id="L8375">                            currentBay.destroyDoorNext();</span>
                        }
                        // Stop looking.
<span class="nc" id="L8378">                        entityUpdate(dropShip.getId());</span>
<span class="nc" id="L8379">                        return;</span>
                    }
                }
            } // End STEP_MOUNT

            // handle fighter recovery, and also DropShip docking with another large craft
<span class="nc bnc" id="L8385" title="All 2 branches missed.">            if (step.getType() == MoveStepType.RECOVER) {</span>

<span class="nc" id="L8387">                loader = game.getEntity(step.getRecoveryUnit());</span>
<span class="nc" id="L8388">                boolean isDS = (entity instanceof Dropship);</span>

<span class="nc" id="L8390">                rollTarget = entity.getBasePilotingRoll(overallMoveType);</span>
<span class="nc bnc" id="L8391" title="All 2 branches missed.">                if (loader.mpUsed &gt; 0) {</span>
<span class="nc" id="L8392">                    rollTarget.addModifier(5, &quot;carrier used thrust&quot;);</span>
                }
<span class="nc bnc" id="L8394" title="All 2 branches missed.">                if (entity.getPartialRepairs().booleanOption(&quot;aero_collar_crit&quot;)) {</span>
<span class="nc" id="L8395">                    rollTarget.addModifier(2, &quot;misrepaired docking collar&quot;);</span>
                }
<span class="nc bnc" id="L8397" title="All 4 branches missed.">                if (isDS &amp;&amp; (((Dropship)entity).getCollarType() == Dropship.COLLAR_PROTOTYPE)) {</span>
<span class="nc" id="L8398">                    rollTarget.addModifier(2, &quot;prototype kf-boom&quot;);</span>
                }
<span class="nc" id="L8400">                int ctrlroll = Compute.d6(2);</span>
<span class="nc bnc" id="L8401" title="All 2 branches missed.">                if (isDS) {</span>
<span class="nc" id="L8402">                    r = new Report(9388);</span>
                } else {
<span class="nc" id="L8404">                    r = new Report(9381);</span>
                }
                //TODO : This doesn't currently break out the modifiers and should...
<span class="nc" id="L8407">                r.subject = entity.getId();</span>
<span class="nc" id="L8408">                r.add(entity.getDisplayName());</span>
<span class="nc" id="L8409">                r.add(loader.getDisplayName());</span>
<span class="nc" id="L8410">                r.add(rollTarget.getValue());</span>
<span class="nc" id="L8411">                r.add(ctrlroll);</span>
<span class="nc" id="L8412">                r.newlines = 0;</span>
<span class="nc" id="L8413">                r.indent(1);</span>
<span class="nc bnc" id="L8414" title="All 2 branches missed.">                if (ctrlroll &lt; rollTarget.getValue()) {</span>
<span class="nc" id="L8415">                    r.choose(false);</span>
<span class="nc" id="L8416">                    addReport(r);</span>
                    // damage unit
<span class="nc" id="L8418">                    HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L8419">                    addReport(damageEntity(entity, hit, 2 * (rollTarget.getValue() - ctrlroll)));</span>
<span class="nc" id="L8420">                } else {</span>
<span class="nc" id="L8421">                    r.choose(true);</span>
<span class="nc" id="L8422">                    addReport(r);</span>
<span class="nc" id="L8423">                    recovered = true;</span>
                }
                // check for door damage
<span class="nc bnc" id="L8426" title="All 2 branches missed.">                if (ctrlroll == 2) {</span>
<span class="nc" id="L8427">                    loader.damageDoorRecovery(entity);</span>
<span class="nc" id="L8428">                    r = new Report(9384);</span>
<span class="nc" id="L8429">                    r.subject = entity.getId();</span>
<span class="nc" id="L8430">                    r.indent(0);</span>
<span class="nc" id="L8431">                    r.add(loader.getDisplayName());</span>
<span class="nc" id="L8432">                    addReport(r);</span>
                }
            }

            // handle fighter squadron joining
<span class="nc bnc" id="L8437" title="All 2 branches missed.">            if (step.getType() == MoveStepType.JOIN) {</span>
<span class="nc" id="L8438">                loader = game.getEntity(step.getRecoveryUnit());</span>
<span class="nc" id="L8439">                recovered = true;</span>
            }

            // Handle unloading units.
<span class="nc bnc" id="L8443" title="All 2 branches missed.">            if (step.getType() == MoveStepType.UNLOAD) {</span>
<span class="nc" id="L8444">                Targetable unloaded = step.getTarget(game);</span>
<span class="nc" id="L8445">                Coords unloadPos = curPos;</span>
<span class="nc" id="L8446">                int unloadFacing = curFacing;</span>
<span class="nc bnc" id="L8447" title="All 2 branches missed.">                if (null != step.getTargetPosition()) {</span>
<span class="nc" id="L8448">                    unloadPos = step.getTargetPosition();</span>
<span class="nc" id="L8449">                    unloadFacing = curPos.direction(unloadPos);</span>
                }
<span class="nc bnc" id="L8451" title="All 2 branches missed.">                if (!unloadUnit(entity, unloaded, unloadPos, unloadFacing,</span>
<span class="nc" id="L8452">                        step.getElevation())) {</span>
<span class="nc" id="L8453">                    MegaMek.getLogger().error(&quot;Server was told to unload &quot;</span>
<span class="nc" id="L8454">                                    + unloaded.getDisplayName() + &quot; from &quot;</span>
<span class="nc" id="L8455">                                    + entity.getDisplayName() + &quot; into &quot;</span>
<span class="nc" id="L8456">                                    + curPos.getBoardNum());</span>
                }
                // some additional stuff to take care of for small
                // craft/DropShip unloading
<span class="nc bnc" id="L8460" title="All 4 branches missed.">                if ((entity instanceof SmallCraft) &amp;&amp; (unloaded instanceof Entity)) {</span>
<span class="nc" id="L8461">                    Bay currentBay = entity.getBay((Entity) unloaded);</span>
<span class="nc bnc" id="L8462" title="All 4 branches missed.">                    if ((null != currentBay) &amp;&amp; (Compute.d6(2) == 2)) {</span>
<span class="nc" id="L8463">                        r = new Report(9390);</span>
<span class="nc" id="L8464">                        r.subject = entity.getId();</span>
<span class="nc" id="L8465">                        r.indent(1);</span>
<span class="nc" id="L8466">                        r.add(currentBay.getType());</span>
<span class="nc" id="L8467">                        addReport(r);</span>
<span class="nc" id="L8468">                        currentBay.destroyDoorNext();</span>
                    }
                    // now apply any damage to bay doors
<span class="nc" id="L8471">                    entity.resetBayDoors();</span>
<span class="nc" id="L8472">                    entityUpdate(entity.getId());</span>
                    // ok now add another turn for the transport so it can
                    // continue to unload units
<span class="nc bnc" id="L8475" title="All 2 branches missed.">                    if (entity.getUnitsUnloadableFromBays().size() &gt; 0) {</span>
<span class="nc" id="L8476">                        dropshipStillUnloading = true;</span>
<span class="nc" id="L8477">                        GameTurn newTurn = new GameTurn.SpecificEntityTurn(</span>
<span class="nc" id="L8478">                                entity.getOwner().getId(), entity.getId());</span>
                        // Need to set the new turn's multiTurn state
<span class="nc" id="L8480">                        newTurn.setMultiTurn(true);</span>
<span class="nc" id="L8481">                        game.insertNextTurn(newTurn);</span>
                    }
                    // ok add another turn for the unloaded entity so that it
                    // can move
<span class="nc bnc" id="L8485" title="All 2 branches missed.">                    if (!(unloaded instanceof Infantry)) {</span>
<span class="nc" id="L8486">                        GameTurn newTurn = new GameTurn.SpecificEntityTurn(</span>
<span class="nc" id="L8487">                                ((Entity) unloaded).getOwner().getId(),</span>
<span class="nc" id="L8488">                                ((Entity) unloaded).getId());</span>
                        // Need to set the new turn's multiTurn state
<span class="nc" id="L8490">                        newTurn.setMultiTurn(true);</span>
<span class="nc" id="L8491">                        game.insertNextTurn(newTurn);</span>
                    }
                    // brief everybody on the turn update
<span class="nc" id="L8494">                    send(createTurnVectorPacket());</span>
                }
            }

            // Handle disconnecting trailers.
<span class="nc bnc" id="L8499" title="All 2 branches missed.">            if (step.getType() == MoveStepType.DISCONNECT) {</span>
<span class="nc" id="L8500">                Targetable unloaded = step.getTarget(game);</span>
<span class="nc" id="L8501">                Coords unloadPos = curPos;</span>
<span class="nc bnc" id="L8502" title="All 2 branches missed.">                if (null != step.getTargetPosition()) {</span>
<span class="nc" id="L8503">                    unloadPos = step.getTargetPosition();</span>
                }
<span class="nc bnc" id="L8505" title="All 2 branches missed.">                if (!disconnectUnit(entity, unloaded, unloadPos)) {</span>
<span class="nc" id="L8506">                    MegaMek.getLogger().error(&quot;Server was told to disconnect &quot;</span>
<span class="nc" id="L8507">                                    + unloaded.getDisplayName() + &quot; from &quot;</span>
<span class="nc" id="L8508">                                    + entity.getDisplayName() + &quot; into &quot;</span>
<span class="nc" id="L8509">                                    + curPos.getBoardNum());</span>
                }
            }

            // moving backwards over elevation change
<span class="nc bnc" id="L8514" title="All 2 branches missed.">            if (((step.getType() == MoveStepType.BACKWARDS)</span>
<span class="nc bnc" id="L8515" title="All 2 branches missed.">                    || (step.getType() == MoveStepType.LATERAL_LEFT_BACKWARDS)</span>
<span class="nc bnc" id="L8516" title="All 2 branches missed.">                    || (step.getType() == MoveStepType.LATERAL_RIGHT_BACKWARDS))</span>
<span class="nc bnc" id="L8517" title="All 2 branches missed.">                    &amp;&amp; !(md.isJumping()</span>
<span class="nc bnc" id="L8518" title="All 2 branches missed.">                            &amp;&amp; (entity.getJumpType() == Mech.JUMP_BOOSTER))</span>
<span class="nc bnc" id="L8519" title="All 6 branches missed.">                    &amp;&amp; (lastHex.getLevel() + lastElevation != curHex.getLevel() + step.getElevation())</span>
                    &amp;&amp; !(entity instanceof VTOL)
                    &amp;&amp; !(curClimbMode
<span class="nc bnc" id="L8522" title="All 2 branches missed.">                            &amp;&amp; curHex.containsTerrain(Terrains.BRIDGE)</span>
<span class="nc" id="L8523">                            &amp;&amp; ((curHex.terrainLevel(Terrains.BRIDGE_ELEV)</span>
<span class="nc" id="L8524">                                    + curHex.getLevel()) == (prevHex.getLevel()</span>
<span class="nc bnc" id="L8525" title="All 2 branches missed.">                                            + (prevHex.containsTerrain(</span>
                                                    Terrains.BRIDGE)
                                                            ? prevHex
<span class="nc" id="L8528">                                                                    .terrainLevel(</span>
                                                                            Terrains.BRIDGE_ELEV)
<span class="nc bnc" id="L8530" title="All 2 branches missed.">                                                            : 0))))) {</span>

                // per TacOps, if the mech is walking backwards over an elevation change and falls
                // it falls into the lower hex. The caveat is if it already fell from some other PSR in this 
                // invocation of processMovement, then it can't fall again. 
<span class="nc bnc" id="L8535" title="All 2 branches missed.">                if ((entity instanceof Mech) &amp;&amp; (curHex.getLevel() &lt; game</span>
<span class="nc bnc" id="L8536" title="All 4 branches missed.">                        .getBoard().getHex(lastPos).getLevel()) &amp;&amp; !entity.hasFallen()) {</span>
<span class="nc" id="L8537">                    rollTarget = entity.getBasePilotingRoll(overallMoveType);</span>
<span class="nc" id="L8538">                    rollTarget.addModifier(0,</span>
                            &quot;moving backwards over an elevation change&quot;);
<span class="nc" id="L8540">                    doSkillCheckWhileMoving(entity, entity.getElevation(),</span>
                            curPos, curPos, rollTarget, true);
<span class="nc bnc" id="L8542" title="All 4 branches missed.">                } else if ((entity instanceof Mech) &amp;&amp; !entity.hasFallen()) {</span>
<span class="nc" id="L8543">                    rollTarget = entity.getBasePilotingRoll(overallMoveType);</span>
<span class="nc" id="L8544">                    rollTarget.addModifier(0,</span>
                            &quot;moving backwards over an elevation change&quot;);
<span class="nc" id="L8546">                    doSkillCheckWhileMoving(entity, lastElevation, lastPos,</span>
                            lastPos, rollTarget, true);
<span class="nc bnc" id="L8548" title="All 2 branches missed.">                } else if (entity instanceof Tank) {</span>
<span class="nc" id="L8549">                    rollTarget = entity.getBasePilotingRoll(overallMoveType);</span>
<span class="nc" id="L8550">                    rollTarget.addModifier(0,</span>
                            &quot;moving backwards over an elevation change&quot;);
<span class="nc bnc" id="L8552" title="All 2 branches missed.">                    if (doSkillCheckWhileMoving(entity, entity.getElevation(),</span>
                            curPos, lastPos, rollTarget, false) &lt; 0) {
<span class="nc" id="L8554">                        curPos = lastPos;</span>
                    }
                }

            }

            // Handle non-infantry moving into a building.
<span class="nc bnc" id="L8561" title="All 2 branches missed.">            if (buildingMove &gt; 0) {</span>

                // Get the building being exited.
<span class="nc" id="L8564">                Building bldgExited = null;</span>
<span class="nc bnc" id="L8565" title="All 2 branches missed.">                if ((buildingMove &amp; 1) == 1) {</span>
<span class="nc" id="L8566">                    bldgExited = game.getBoard().getBuildingAt(lastPos);</span>
                }

                // Get the building being entered.
<span class="nc" id="L8570">                Building bldgEntered = null;</span>
<span class="nc bnc" id="L8571" title="All 2 branches missed.">                if ((buildingMove &amp; 2) == 2) {</span>
<span class="nc" id="L8572">                    bldgEntered = game.getBoard().getBuildingAt(curPos);</span>
                }

                // ProtoMechs changing levels within a building cause damage
<span class="nc bnc" id="L8576" title="All 4 branches missed.">                if (((buildingMove &amp; 8) == 8) &amp;&amp; (entity instanceof Protomech)) {</span>
<span class="nc" id="L8577">                    Building bldg = game.getBoard().getBuildingAt(curPos);</span>
<span class="nc" id="L8578">                    Vector&lt;Report&gt; vBuildingReport = damageBuilding(bldg, 1, curPos);</span>
<span class="nc bnc" id="L8579" title="All 2 branches missed.">                    for (Report report : vBuildingReport) {</span>
<span class="nc" id="L8580">                        report.subject = entity.getId();</span>
<span class="nc" id="L8581">                    }</span>
<span class="nc" id="L8582">                    addReport(vBuildingReport);</span>
                }

<span class="nc" id="L8585">                boolean collapsed = false;</span>
<span class="nc bnc" id="L8586" title="All 2 branches missed.">                if ((bldgEntered != null)) {</span>
                    // If we're not leaving a building, just handle the
                    // &quot;entered&quot;.
                    String reason;
<span class="nc bnc" id="L8590" title="All 2 branches missed.">                    if (bldgExited == null) {</span>
<span class="nc" id="L8591">                        reason = &quot;entering&quot;;</span>
                    }
                    // If we're moving within the same building, just handle
                    // the &quot;within&quot;.
<span class="nc bnc" id="L8595" title="All 6 branches missed.">                    else if (bldgExited.equals(bldgEntered)</span>
                            &amp;&amp; !(entity instanceof Protomech)
                            &amp;&amp; !(entity instanceof Infantry)) {
<span class="nc" id="L8598">                        reason = &quot;moving in&quot;;</span>
                    }
                    // If we have different buildings, roll for each.
                    else {
<span class="nc" id="L8602">                        reason = &quot;entering&quot;;</span>
                    }
<span class="nc" id="L8604">                    passBuildingWall(entity, bldgEntered, lastPos, curPos,</span>
<span class="nc" id="L8605">                            distance, reason, step.isThisStepBackwards(),</span>
                            lastStepMoveType, true);
<span class="nc" id="L8607">                    addAffectedBldg(bldgEntered, collapsed);</span>
                }

                // Clean up the entity if it has been destroyed.
<span class="nc bnc" id="L8611" title="All 2 branches missed.">                if (entity.isDoomed()) {</span>
<span class="nc" id="L8612">                    entity.setDestroyed(true);</span>
<span class="nc" id="L8613">                    game.moveToGraveyard(entity.getId());</span>
<span class="nc" id="L8614">                    send(createRemoveEntityPacket(entity.getId()));</span>

                    // The entity's movement is completed.
<span class="nc" id="L8617">                    return;</span>
                }

                // TODO : what if a building collapses into rubble?
            }

<span class="nc bnc" id="L8623" title="All 2 branches missed.">            if (stepMoveType != EntityMovementType.MOVE_JUMP</span>
<span class="nc bnc" id="L8624" title="All 2 branches missed.">                    &amp;&amp; (step.getClearance() == 0</span>
<span class="nc bnc" id="L8625" title="All 4 branches missed.">                        || (entity.getMovementMode() == EntityMovementMode.WIGE &amp;&amp; step.getClearance() == 1)</span>
<span class="nc bnc" id="L8626" title="All 2 branches missed.">                        || curElevation == curHex.terrainLevel(Terrains.BLDG_ELEV)</span>
<span class="nc bnc" id="L8627" title="All 2 branches missed.">                        || curElevation == curHex.terrainLevel(Terrains.BRIDGE_ELEV))) {</span>
<span class="nc" id="L8628">                Building bldg = game.getBoard().getBuildingAt(curPos);</span>
<span class="nc bnc" id="L8629" title="All 4 branches missed.">                if ((bldg != null) &amp;&amp; (entity.getElevation() &gt;= 0)) {</span>
<span class="nc bnc" id="L8630" title="All 2 branches missed.">                    boolean wigeFlyingOver = entity.getMovementMode() == EntityMovementMode.WIGE</span>
<span class="nc bnc" id="L8631" title="All 2 branches missed.">                            &amp;&amp; ((curHex.containsTerrain(Terrains.BLDG_ELEV)</span>
<span class="nc bnc" id="L8632" title="All 2 branches missed.">                                    &amp;&amp; curElevation &gt; curHex.terrainLevel(Terrains.BLDG_ELEV)) ||</span>
<span class="nc bnc" id="L8633" title="All 2 branches missed.">                            (curHex.containsTerrain(Terrains.BRIDGE_ELEV)</span>
<span class="nc bnc" id="L8634" title="All 2 branches missed.">                                    &amp;&amp; curElevation &gt; curHex.terrainLevel(Terrains.BRIDGE_ELEV)));</span>
<span class="nc" id="L8635">                    boolean collapse = checkBuildingCollapseWhileMoving(bldg, entity, curPos);</span>
<span class="nc" id="L8636">                    addAffectedBldg(bldg, collapse);</span>
                    // If the building is collapsed by a WiGE flying over it, the WiGE drops one level of elevation.
                    // This could invalidate the remainder of the movement path, so we will send it back to the client.
<span class="nc bnc" id="L8639" title="All 4 branches missed.">                    if (collapse &amp;&amp; wigeFlyingOver) {</span>
<span class="nc" id="L8640">                        curElevation--;</span>
<span class="nc" id="L8641">                        r = new Report(2378);</span>
<span class="nc" id="L8642">                        r.subject = entity.getId();</span>
<span class="nc" id="L8643">                        r.addDesc(entity);</span>
<span class="nc" id="L8644">                        addReport(r);</span>
<span class="nc" id="L8645">                        continueTurnFromLevelDrop = true;</span>
<span class="nc" id="L8646">                        entity.setPosition(curPos);</span>
<span class="nc" id="L8647">                        entity.setFacing(curFacing);</span>
<span class="nc" id="L8648">                        entity.setSecondaryFacing(curFacing);</span>
<span class="nc" id="L8649">                        entity.setElevation(curElevation);</span>
<span class="nc" id="L8650">                        break;</span>
                    }
                }
            }
            
            // Sheer Cliffs, TO p.39
<span class="nc bnc" id="L8656" title="All 2 branches missed.">            boolean vehicleAffectedByCliff = entity instanceof Tank </span>
<span class="nc bnc" id="L8657" title="All 2 branches missed.">                    &amp;&amp; !entity.isAirborneVTOLorWIGE();</span>
<span class="nc bnc" id="L8658" title="All 2 branches missed.">            boolean quadveeVehMode = entity instanceof QuadVee</span>
<span class="nc bnc" id="L8659" title="All 2 branches missed.">                    &amp;&amp; ((QuadVee)entity).getConversionMode() == QuadVee.CONV_MODE_VEHICLE;</span>
<span class="nc bnc" id="L8660" title="All 6 branches missed.">            boolean mechAffectedByCliff = (entity instanceof Mech || entity instanceof Protomech)</span>
                    &amp;&amp; moveType != EntityMovementType.MOVE_JUMP
<span class="nc bnc" id="L8662" title="All 2 branches missed.">                    &amp;&amp; !entity.isAero();</span>
            // Cliffs should only exist towards 1 or 2 level drops, check just to make sure
            // Everything that does not have a 1 or 2 level drop shouldn't be handled as a cliff
<span class="nc" id="L8665">            int stepHeight = curElevation + curHex.getLevel() </span>
<span class="nc" id="L8666">                    - (lastElevation + prevHex.getLevel());</span>
<span class="nc bnc" id="L8667" title="All 2 branches missed.">            boolean isUpCliff = !lastPos.equals(curPos) </span>
<span class="nc bnc" id="L8668" title="All 6 branches missed.">                    &amp;&amp; curHex.hasCliffTopTowards(prevHex)</span>
                    &amp;&amp; (stepHeight == 1 || stepHeight == 2);
<span class="nc bnc" id="L8670" title="All 2 branches missed.">            boolean isDownCliff = !lastPos.equals(curPos) </span>
<span class="nc bnc" id="L8671" title="All 6 branches missed.">                    &amp;&amp; prevHex.hasCliffTopTowards(curHex)</span>
                    &amp;&amp; (stepHeight == -1 || stepHeight == -2);

            // Vehicles (exc. WIGE/VTOL) moving down a cliff
<span class="nc bnc" id="L8675" title="All 6 branches missed.">            if (vehicleAffectedByCliff &amp;&amp; isDownCliff &amp;&amp; !isPavementStep) {</span>
<span class="nc" id="L8676">                rollTarget = entity.getBasePilotingRoll(stepMoveType);</span>
<span class="nc" id="L8677">                rollTarget.append(new PilotingRollData(entity.getId(), 0, &quot;moving down a sheer cliff&quot;));</span>
<span class="nc bnc" id="L8678" title="All 2 branches missed.">                if (doSkillCheckWhileMoving(entity, lastElevation,</span>
                        lastPos, curPos, rollTarget, false) &gt; 0) {
<span class="nc" id="L8680">                    addReport(vehicleMotiveDamage((Tank)entity, 0));</span>
<span class="nc" id="L8681">                    addNewLines();</span>
<span class="nc" id="L8682">                    turnOver = true;</span>
<span class="nc" id="L8683">                    break;</span>
                }
            }

            // Mechs and Protomechs moving down a cliff
            // Quadvees in vee mode ignore PSRs to avoid falls, IO p.133
<span class="nc bnc" id="L8689" title="All 8 branches missed.">            if (mechAffectedByCliff &amp;&amp; !quadveeVehMode &amp;&amp; isDownCliff &amp;&amp; !isPavementStep) {</span>
<span class="nc" id="L8690">                rollTarget = entity.getBasePilotingRoll(moveType);</span>
<span class="nc" id="L8691">                rollTarget.append(new PilotingRollData(entity.getId(), -stepHeight - 1, &quot;moving down a sheer cliff&quot;));</span>
<span class="nc bnc" id="L8692" title="All 2 branches missed.">                if (doSkillCheckWhileMoving(entity, lastElevation,</span>
                        lastPos, curPos, rollTarget, true) &gt; 0) {
<span class="nc" id="L8694">                    addNewLines();</span>
<span class="nc" id="L8695">                    turnOver = true;</span>
<span class="nc" id="L8696">                    break;</span>
                }
            }

            // Mechs moving up a cliff
<span class="nc bnc" id="L8701" title="All 8 branches missed.">            if (mechAffectedByCliff &amp;&amp; !quadveeVehMode &amp;&amp; isUpCliff &amp;&amp; !isPavementStep) {</span>
<span class="nc" id="L8702">                rollTarget = entity.getBasePilotingRoll(moveType);</span>
<span class="nc" id="L8703">                rollTarget.append(new PilotingRollData(entity.getId(), stepHeight, &quot;moving up a sheer cliff&quot;));</span>
<span class="nc bnc" id="L8704" title="All 2 branches missed.">                if (doSkillCheckWhileMoving(entity, lastElevation,</span>
                        lastPos, lastPos, rollTarget, false) &gt; 0) {
<span class="nc" id="L8706">                    r = new Report(2209);</span>
<span class="nc" id="L8707">                    r.addDesc(entity);</span>
<span class="nc" id="L8708">                    r.subject = entity.getId();</span>
<span class="nc" id="L8709">                    addReport(r);</span>
<span class="nc" id="L8710">                    addNewLines();</span>
<span class="nc" id="L8711">                    curPos = entity.getPosition();</span>
<span class="nc" id="L8712">                    mpUsed = step.getMpUsed();</span>
<span class="nc" id="L8713">                    continueTurnFromCliffAscent = true;</span>
<span class="nc" id="L8714">                    break;</span>
                }
            }

            // did the entity just fall?
<span class="nc bnc" id="L8719" title="All 4 branches missed.">            if (!wasProne &amp;&amp; entity.isProne()) {</span>
<span class="nc" id="L8720">                curFacing = entity.getFacing();</span>
<span class="nc" id="L8721">                curPos = entity.getPosition();</span>
<span class="nc" id="L8722">                mpUsed = step.getMpUsed();</span>
<span class="nc" id="L8723">                fellDuringMovement = true;</span>
<span class="nc" id="L8724">                break;</span>
            }

            // dropping prone intentionally?
<span class="nc bnc" id="L8728" title="All 2 branches missed.">            if (step.getType() == MoveStepType.GO_PRONE) {</span>
<span class="nc" id="L8729">                mpUsed = step.getMpUsed();</span>
<span class="nc" id="L8730">                rollTarget = entity.checkDislodgeSwarmers(step, overallMoveType);</span>
<span class="nc bnc" id="L8731" title="All 2 branches missed.">                if (rollTarget.getValue() == TargetRoll.CHECK_FALSE) {</span>
                    // Not being swarmed
<span class="nc" id="L8733">                    entity.setProne(true);</span>
                    // check to see if we washed off infernos
<span class="nc" id="L8735">                    checkForWashedInfernos(entity, curPos);</span>
                } else {
                    // Being swarmed
<span class="nc" id="L8738">                    entity.setPosition(curPos);</span>
<span class="nc bnc" id="L8739" title="All 2 branches missed.">                    if (doDislodgeSwarmerSkillCheck(entity, rollTarget, curPos)) {</span>
                        // Entity falls
<span class="nc" id="L8741">                        curFacing = entity.getFacing();</span>
<span class="nc" id="L8742">                        curPos = entity.getPosition();</span>
<span class="nc" id="L8743">                        fellDuringMovement = true;</span>
<span class="nc" id="L8744">                        break;</span>
                    }
                    // roll failed, go prone but don't dislodge swarmers
<span class="nc" id="L8747">                    entity.setProne(true);</span>
                    // check to see if we washed off infernos
<span class="nc" id="L8749">                    checkForWashedInfernos(entity, curPos);</span>
<span class="nc" id="L8750">                    break;</span>
                }
            }

            // going hull down
<span class="nc bnc" id="L8755" title="All 2 branches missed.">            if (step.getType() == MoveStepType.HULL_DOWN) {</span>
<span class="nc" id="L8756">                mpUsed = step.getMpUsed();</span>
<span class="nc" id="L8757">                entity.setHullDown(true);</span>
            }

            // Check for crushing buildings by Dropships/Mobile Structures
<span class="nc bnc" id="L8761" title="All 2 branches missed.">            for (Coords pos : step.getCrushedBuildingLocs()) {</span>
<span class="nc" id="L8762">                Building bldg = game.getBoard().getBuildingAt(pos);</span>
<span class="nc" id="L8763">                IHex hex = game.getBoard().getHex(pos);</span>

<span class="nc" id="L8765">                r = new Report(3443);</span>
<span class="nc" id="L8766">                r.subject = entity.getId();</span>
<span class="nc" id="L8767">                r.addDesc(entity);</span>
<span class="nc" id="L8768">                r.add(bldg.getName());</span>
<span class="nc" id="L8769">                vPhaseReport.add(r);</span>

<span class="nc" id="L8771">                final int cf = bldg.getCurrentCF(pos);</span>
<span class="nc" id="L8772">                final int numFloors = Math.max(0, hex.terrainLevel(Terrains.BLDG_ELEV));</span>
<span class="nc" id="L8773">                vPhaseReport.addAll(damageBuilding(bldg, 150, &quot; is crushed for &quot;, pos));</span>
<span class="nc" id="L8774">                int damage = (int) Math.round((cf / 10.0) * numFloors);</span>
<span class="nc" id="L8775">                HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L8776">                vPhaseReport.addAll(damageEntity(entity, hit, damage));</span>
<span class="nc" id="L8777">            }</span>

            // Track this step's location.
<span class="nc" id="L8780">            movePath.addElement(new UnitLocation(entity.getId(), curPos,</span>
<span class="nc" id="L8781">                    curFacing, step.getElevation()));</span>

            // if the lastpos is not the same as the current position
            // then add the current position to the list of places passed
            // through
<span class="nc bnc" id="L8786" title="All 2 branches missed.">            if (!curPos.equals(lastPos)) {</span>
<span class="nc" id="L8787">                passedThrough.add(curPos);</span>
<span class="nc" id="L8788">                passedThroughFacing.add(curFacing);</span>
            }

            // update lastPos, prevStep, prevFacing &amp; prevHex
<span class="nc bnc" id="L8792" title="All 2 branches missed.">            if (!curPos.equals(lastPos)) {</span>
<span class="nc" id="L8793">                prevFacing = curFacing;</span>
            }
<span class="nc" id="L8795">            lastPos = curPos;</span>
<span class="nc" id="L8796">            lastElevation = curElevation;</span>
<span class="nc" id="L8797">            prevStep = step;</span>
<span class="nc" id="L8798">            prevHex = curHex;</span>

<span class="nc" id="L8800">            firstStep = false;</span>
<span class="nc" id="L8801">        }</span>

        // set entity parameters
<span class="nc" id="L8804">        entity.setPosition(curPos);</span>
<span class="nc" id="L8805">        entity.setFacing(curFacing);</span>
<span class="nc" id="L8806">        entity.setSecondaryFacing(curFacing);</span>
<span class="nc" id="L8807">        entity.delta_distance = distance;</span>
<span class="nc" id="L8808">        entity.moved = moveType;</span>
<span class="nc" id="L8809">        entity.mpUsed = mpUsed;</span>
<span class="nc" id="L8810">        entity.setClimbMode(curClimbMode);</span>
<span class="nc bnc" id="L8811" title="All 6 branches missed.">        if (!sideslipped &amp;&amp; !fellDuringMovement &amp;&amp; !crashedDuringMovement</span>
<span class="nc bnc" id="L8812" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() == EntityMovementMode.VTOL)) {</span>
<span class="nc" id="L8813">            entity.setElevation(curVTOLElevation);</span>
        }
<span class="nc" id="L8815">        entity.setAltitude(curAltitude);</span>
<span class="nc" id="L8816">        entity.setClimbMode(curClimbMode);</span>

        // add a list of places passed through
<span class="nc" id="L8819">        entity.setPassedThrough(passedThrough);</span>
<span class="nc" id="L8820">        entity.setPassedThroughFacing(passedThroughFacing);</span>

        // if we ran with destroyed hip or gyro, we need a psr
<span class="nc" id="L8823">        rollTarget = entity.checkRunningWithDamage(overallMoveType);</span>
<span class="nc bnc" id="L8824" title="All 4 branches missed.">        if (rollTarget.getValue() != TargetRoll.CHECK_FALSE &amp;&amp; entity.canFall()) {</span>
<span class="nc" id="L8825">            doSkillCheckInPlace(entity, rollTarget);</span>
        }

        // if we sprinted with MASC or a supercharger, then we need a PSR
<span class="nc" id="L8829">        rollTarget = entity.checkSprintingWithMASC(overallMoveType,</span>
                entity.mpUsed);
<span class="nc bnc" id="L8831" title="All 4 branches missed.">        if (rollTarget.getValue() != TargetRoll.CHECK_FALSE &amp;&amp; entity.canFall()) {</span>
<span class="nc" id="L8832">            doSkillCheckInPlace(entity, rollTarget);</span>
        }

        // if we used ProtoMech myomer booster, roll 2d6
        // pilot damage on a 2
<span class="nc bnc" id="L8837" title="All 4 branches missed.">        if ((entity instanceof Protomech) &amp;&amp; ((Protomech) entity).hasMyomerBooster()</span>
<span class="nc" id="L8838">                &amp;&amp; (md.getMpUsed() &gt; ((Protomech) entity)</span>
<span class="nc bnc" id="L8839" title="All 2 branches missed.">                        .getRunMPwithoutMyomerBooster(true, false, false))) {</span>
<span class="nc" id="L8840">            r = new Report(2373);</span>
<span class="nc" id="L8841">            r.addDesc(entity);</span>
<span class="nc" id="L8842">            r.subject = entity.getId();</span>
<span class="nc" id="L8843">            int roll = Compute.d6(2);</span>
<span class="nc" id="L8844">            r.add(roll);</span>
<span class="nc bnc" id="L8845" title="All 2 branches missed.">            if (roll &gt; 2) {</span>
<span class="nc" id="L8846">                r.choose(true);</span>
<span class="nc" id="L8847">                addReport(r);</span>
            } else {
<span class="nc" id="L8849">                r.choose(false);</span>
<span class="nc" id="L8850">                addReport(r);</span>
<span class="nc" id="L8851">                addReport(damageCrew(entity, 1));</span>
            }
        }

<span class="nc" id="L8855">        rollTarget = entity.checkSprintingWithSupercharger(overallMoveType, entity.mpUsed);</span>
<span class="nc bnc" id="L8856" title="All 2 branches missed.">        if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L8857">            doSkillCheckInPlace(entity, rollTarget);</span>
        }
<span class="nc bnc" id="L8859" title="All 2 branches missed.">        if ((md.getLastStepMovementType() == EntityMovementType.MOVE_SPRINT)</span>
<span class="nc bnc" id="L8860" title="All 4 branches missed.">                &amp;&amp; md.hasActiveMASC() &amp;&amp; entity.canFall()) {</span>
<span class="nc" id="L8861">            doSkillCheckInPlace(entity, entity.getBasePilotingRoll(EntityMovementType.MOVE_SPRINT));</span>
        }

<span class="nc bnc" id="L8864" title="All 4 branches missed.">        if (entity.isAirborne() &amp;&amp; entity.isAero()) {</span>

<span class="nc" id="L8866">            IAero a = (IAero) entity;</span>
<span class="nc" id="L8867">            int thrust = md.getMpUsed();</span>

            // consume fuel
<span class="nc bnc" id="L8870" title="All 2 branches missed.">            if (((entity.isAero())</span>
<span class="nc bnc" id="L8871" title="All 4 branches missed.">                    &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_FUEL_CONSUMPTION))</span>
                    || (entity instanceof TeleMissile)) {
<span class="nc" id="L8873">                int fuelUsed = ((IAero) entity).getFuelUsed(thrust);</span>
<span class="nc" id="L8874">                a.useFuel(fuelUsed);</span>
            }

            // JumpShips and space stations need to reduce accumulated thrust if
            // they spend some
<span class="nc bnc" id="L8879" title="All 2 branches missed.">            if (entity instanceof Jumpship) {</span>
<span class="nc" id="L8880">                Jumpship js = (Jumpship) entity;</span>
<span class="nc" id="L8881">                double penalty = 0.0;</span>
                // JumpShips do not accumulate thrust when they make a turn or
                // change velocity
<span class="nc bnc" id="L8884" title="All 4 branches missed.">                if (md.contains(MoveStepType.TURN_LEFT) || md.contains(MoveStepType.TURN_RIGHT)) {</span>
                    // I need to subtract the station keeping thrust from their
                    // accumulated thrust
                    // because they did not actually use it
<span class="nc" id="L8888">                    penalty = js.getStationKeepingThrust();</span>
                }
<span class="nc bnc" id="L8890" title="All 2 branches missed.">                if (thrust &gt; 0) {</span>
<span class="nc" id="L8891">                    penalty = thrust;</span>
                }
<span class="nc bnc" id="L8893" title="All 2 branches missed.">                if (penalty &gt; 0.0) {</span>
<span class="nc" id="L8894">                    js.setAccumulatedThrust(Math.max(0, js.getAccumulatedThrust() - penalty));</span>
                }
            }

            // check to see if thrust exceeded SI

<span class="nc" id="L8900">            rollTarget = a.checkThrustSITotal(thrust, overallMoveType);</span>
<span class="nc bnc" id="L8901" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L8902">                game.addControlRoll(new PilotingRollData(entity.getId(), 0,</span>
                        &quot;Thrust spent during turn exceeds SI&quot;));
            }

<span class="nc bnc" id="L8906" title="All 2 branches missed.">            if (!game.getBoard().inSpace()) {</span>
<span class="nc" id="L8907">                rollTarget = a.checkVelocityDouble(md.getFinalVelocity(),</span>
                        overallMoveType);
<span class="nc bnc" id="L8909" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L8910">                    game.addControlRoll(new PilotingRollData(entity.getId(), 0,</span>
                            &quot;Velocity greater than 2x safe thrust&quot;));
                }

<span class="nc" id="L8914">                rollTarget = a.checkDown(md.getFinalNDown(), overallMoveType);</span>
<span class="nc bnc" id="L8915" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L8916">                    game.addControlRoll(</span>
<span class="nc" id="L8917">                            new PilotingRollData(entity.getId(), md.getFinalNDown(),</span>
                                    &quot;descended more than two altitudes&quot;));
                }

                // check for hovering
<span class="nc" id="L8922">                rollTarget = a.checkHover(md);</span>
<span class="nc bnc" id="L8923" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L8924">                    game.addControlRoll(</span>
<span class="nc" id="L8925">                            new PilotingRollData(entity.getId(), 0, &quot;hovering&quot;));</span>
                }

                // check for aero stall
<span class="nc" id="L8929">                rollTarget = a.checkStall(md);</span>
<span class="nc bnc" id="L8930" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L8931">                    r = new Report(9391);</span>
<span class="nc" id="L8932">                    r.subject = entity.getId();</span>
<span class="nc" id="L8933">                    r.addDesc(entity);</span>
<span class="nc" id="L8934">                    addReport(r);</span>
<span class="nc" id="L8935">                    game.addControlRoll(new PilotingRollData(entity.getId(), 0,</span>
                            &quot;stalled out&quot;));
<span class="nc" id="L8937">                    entity.setAltitude(entity.getAltitude() - 1);</span>
                    // check for crash
<span class="nc bnc" id="L8939" title="All 2 branches missed.">                    if (checkCrash(entity, entity.getPosition(), entity.getAltitude())) {</span>
<span class="nc" id="L8940">                        addReport(processCrash(entity, 0, entity.getPosition()));</span>
                    }
                }

                // check to see if spheroids should lose one altitude
<span class="nc bnc" id="L8945" title="All 4 branches missed.">                if (a.isSpheroid() &amp;&amp; !a.isSpaceborne()</span>
<span class="nc bnc" id="L8946" title="All 6 branches missed.">                        &amp;&amp; a.isAirborne() &amp;&amp; (md.getFinalNDown() == 0) &amp;&amp; (md.getMpUsed() == 0)) {</span>
<span class="nc" id="L8947">                    r = new Report(9392);</span>
<span class="nc" id="L8948">                    r.subject = entity.getId();</span>
<span class="nc" id="L8949">                    r.addDesc(entity);</span>
<span class="nc" id="L8950">                    addReport(r);</span>
<span class="nc" id="L8951">                    entity.setAltitude(entity.getAltitude() - 1);</span>
                    // check for crash
<span class="nc bnc" id="L8953" title="All 2 branches missed.">                    if (checkCrash(entity, entity.getPosition(), entity.getAltitude())) {</span>
<span class="nc" id="L8954">                        addReport(processCrash(entity, 0, entity.getPosition()));</span>
                    }
<span class="nc bnc" id="L8956" title="All 6 branches missed.">                } else if (entity instanceof EscapePods &amp;&amp; entity.isAirborne() &amp;&amp; md.getFinalVelocity() &lt; 2) {</span>
                    //Atmospheric Escape Pods that drop below velocity 2 lose altitude as dropping units
<span class="nc" id="L8958">                    entity.setAltitude(entity.getAltitude()</span>
<span class="nc" id="L8959">                            - game.getPlanetaryConditions().getDropRate());</span>
<span class="nc" id="L8960">                    r = new Report(6676);</span>
<span class="nc" id="L8961">                    r.subject = entity.getId();</span>
<span class="nc" id="L8962">                    r.addDesc(entity);</span>
<span class="nc" id="L8963">                    r.add(game.getPlanetaryConditions().getDropRate());</span>
<span class="nc" id="L8964">                    addReport(r);</span>
                }
            }
        }

        // We need to check for the removal of hull-down for tanks.
        // Tanks can just drive out of hull-down: if the tank was hull-down
        // and doesn't end hull-down we can remove the hull-down status
<span class="nc bnc" id="L8972" title="All 8 branches missed.">        if (entity.isHullDown() &amp;&amp; !md.getFinalHullDown()</span>
                &amp;&amp; (entity instanceof Tank
<span class="nc bnc" id="L8974" title="All 2 branches missed.">                || (entity instanceof QuadVee &amp;&amp; entity.getConversionMode() == QuadVee.CONV_MODE_VEHICLE))) {</span>
<span class="nc" id="L8975">            entity.setHullDown(false);</span>
        }

        // If the entity is being swarmed, erratic movement may dislodge the
        // fleas.
<span class="nc" id="L8980">        final int swarmerId = entity.getSwarmAttackerId();</span>
<span class="nc bnc" id="L8981" title="All 4 branches missed.">        if ((Entity.NONE != swarmerId) &amp;&amp; md.contains(MoveStepType.SHAKE_OFF_SWARMERS)) {</span>
<span class="nc" id="L8982">            final Entity swarmer = game.getEntity(swarmerId);</span>
<span class="nc" id="L8983">            rollTarget = entity.getBasePilotingRoll(overallMoveType);</span>

<span class="nc" id="L8985">            entity.addPilotingModifierForTerrain(rollTarget);</span>

            // Add a +4 modifier.
<span class="nc bnc" id="L8988" title="All 2 branches missed.">            if (md.getLastStepMovementType() == EntityMovementType.MOVE_VTOL_RUN) {</span>
<span class="nc" id="L8989">                rollTarget.addModifier(2,</span>
                        &quot;dislodge swarming infantry with VTOL movement&quot;);
            } else {
<span class="nc" id="L8992">                rollTarget.addModifier(4, &quot;dislodge swarming infantry&quot;);</span>
            }

            // If the swarmer has Assault claws, give a 1 modifier.
            // We can stop looking when we find our first match.
<span class="nc bnc" id="L8997" title="All 2 branches missed.">            for (Mounted mount : swarmer.getMisc()) {</span>
<span class="nc" id="L8998">                EquipmentType equip = mount.getType();</span>
<span class="nc bnc" id="L8999" title="All 2 branches missed.">                if (equip.hasFlag(MiscType.F_MAGNET_CLAW)) {</span>
<span class="nc" id="L9000">                    rollTarget.addModifier(1, &quot;swarmer has magnetic claws&quot;);</span>
<span class="nc" id="L9001">                    break;</span>
                }
<span class="nc" id="L9003">            }</span>

            // okay, print the info
<span class="nc" id="L9006">            r = new Report(2125);</span>
<span class="nc" id="L9007">            r.subject = entity.getId();</span>
<span class="nc" id="L9008">            r.addDesc(entity);</span>
<span class="nc" id="L9009">            addReport(r);</span>

            // roll
<span class="nc" id="L9012">            final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L9013">            r = new Report(2130);</span>
<span class="nc" id="L9014">            r.subject = entity.getId();</span>
<span class="nc" id="L9015">            r.add(rollTarget.getValueAsString());</span>
<span class="nc" id="L9016">            r.add(rollTarget.getDesc());</span>
<span class="nc" id="L9017">            r.add(diceRoll);</span>
<span class="nc bnc" id="L9018" title="All 2 branches missed.">            if (diceRoll &lt; rollTarget.getValue()) {</span>
<span class="nc" id="L9019">                r.choose(false);</span>
<span class="nc" id="L9020">                addReport(r);</span>
            } else {
                // Dislodged swarmers don't get turns.
<span class="nc" id="L9023">                game.removeTurnFor(swarmer);</span>
<span class="nc" id="L9024">                send(createTurnVectorPacket());</span>

                // Update the report and the swarmer's status.
<span class="nc" id="L9027">                r.choose(true);</span>
<span class="nc" id="L9028">                addReport(r);</span>
<span class="nc" id="L9029">                entity.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L9030">                swarmer.setSwarmTargetId(Entity.NONE);</span>

<span class="nc" id="L9032">                IHex curHex = game.getBoard().getHex(curPos);</span>

                // Did the infantry fall into water?
<span class="nc bnc" id="L9035" title="All 2 branches missed.">                if (curHex.terrainLevel(Terrains.WATER) &gt; 0) {</span>
                    // Swarming infantry die.
<span class="nc" id="L9037">                    swarmer.setPosition(curPos);</span>
<span class="nc" id="L9038">                    r = new Report(2135);</span>
<span class="nc" id="L9039">                    r.subject = entity.getId();</span>
<span class="nc" id="L9040">                    r.indent();</span>
<span class="nc" id="L9041">                    r.addDesc(swarmer);</span>
<span class="nc" id="L9042">                    addReport(r);</span>
<span class="nc" id="L9043">                    addReport(destroyEntity(swarmer, &quot;a watery grave&quot;, false));</span>
                } else {
                    // Swarming infantry take a 3d6 point hit.
                    // ASSUMPTION : damage should not be doubled.
<span class="nc" id="L9047">                    r = new Report(2140);</span>
<span class="nc" id="L9048">                    r.subject = entity.getId();</span>
<span class="nc" id="L9049">                    r.indent();</span>
<span class="nc" id="L9050">                    r.addDesc(swarmer);</span>
<span class="nc" id="L9051">                    r.add(&quot;3d6&quot;);</span>
<span class="nc" id="L9052">                    addReport(r);</span>
<span class="nc" id="L9053">                    addReport(damageEntity(swarmer,</span>
<span class="nc" id="L9054">                            swarmer.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT),</span>
<span class="nc" id="L9055">                            Compute.d6(3)));</span>
<span class="nc" id="L9056">                    addNewLines();</span>
<span class="nc" id="L9057">                    swarmer.setPosition(curPos);</span>
                }
<span class="nc" id="L9059">                entityUpdate(swarmerId);</span>
            } // End successful-PSR

        } // End try-to-dislodge-swarmers

        // but the danger isn't over yet! landing from a jump can be risky!
<span class="nc bnc" id="L9065" title="All 4 branches missed.">        if ((overallMoveType == EntityMovementType.MOVE_JUMP) &amp;&amp; !entity.isMakingDfa()) {</span>
<span class="nc" id="L9066">            final IHex curHex = game.getBoard().getHex(curPos);</span>
            // check for damaged criticals
<span class="nc" id="L9068">            rollTarget = entity.checkLandingWithDamage(overallMoveType);</span>
<span class="nc bnc" id="L9069" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L9070">                doSkillCheckInPlace(entity, rollTarget);</span>
            }
            // check for prototype JJs
<span class="nc" id="L9073">            rollTarget = entity.checkLandingWithPrototypeJJ(overallMoveType);</span>
<span class="nc bnc" id="L9074" title="All 2 branches missed.">            if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L9075">                doSkillCheckInPlace(entity, rollTarget);</span>
            }
            // check for jumping into heavy woods
<span class="nc bnc" id="L9078" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_PSR_JUMP_HEAVY_WOODS)) {</span>
<span class="nc" id="L9079">                rollTarget = entity.checkLandingInHeavyWoods(overallMoveType, curHex);</span>
<span class="nc bnc" id="L9080" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L9081">                    doSkillCheckInPlace(entity, rollTarget);</span>
                }
            }
            // Mechanical jump boosters fall damage
<span class="nc bnc" id="L9085" title="All 2 branches missed.">            if (md.shouldMechanicalJumpCauseFallDamage()) {</span>
<span class="nc" id="L9086">                vPhaseReport.addAll(doEntityFallsInto(entity,</span>
<span class="nc" id="L9087">                        entity.getElevation(), md.getJumpPathHighestPoint(),</span>
<span class="nc" id="L9088">                        curPos, entity.getBasePilotingRoll(overallMoveType),</span>
<span class="nc" id="L9089">                        false, entity.getJumpMP()));</span>
            }
            // jumped into water?
<span class="nc" id="L9092">            int waterLevel = curHex.terrainLevel(Terrains.WATER);</span>
<span class="nc bnc" id="L9093" title="All 4 branches missed.">            if (curHex.containsTerrain(Terrains.ICE) &amp;&amp; (waterLevel &gt; 0)) {</span>
<span class="nc bnc" id="L9094" title="All 2 branches missed.">                if (!(entity instanceof Infantry)) {</span>
                    // check for breaking ice
<span class="nc" id="L9096">                    int roll = Compute.d6(1);</span>
<span class="nc" id="L9097">                    r = new Report(2122);</span>
<span class="nc" id="L9098">                    r.add(entity.getDisplayName(), true);</span>
<span class="nc" id="L9099">                    r.add(roll);</span>
<span class="nc" id="L9100">                    r.subject = entity.getId();</span>
<span class="nc" id="L9101">                    addReport(r);</span>
<span class="nc bnc" id="L9102" title="All 2 branches missed.">                    if (roll &gt;= 4) {</span>
                        // oops!
<span class="nc" id="L9104">                        entity.setPosition(curPos);</span>
<span class="nc" id="L9105">                        addReport(resolveIceBroken(curPos));</span>
<span class="nc" id="L9106">                        curPos = entity.getPosition();</span>
                    } else {
                        // TacOps: immediate PSR with +4 for terrain. If you
                        // fall then may break the ice after all
<span class="nc" id="L9110">                        rollTarget = entity.checkLandingOnIce(overallMoveType, curHex);</span>
<span class="nc bnc" id="L9111" title="All 2 branches missed.">                        if (!doSkillCheckInPlace(entity, rollTarget)) {</span>
                            // apply damage now, or it will show up as a
                            // possible breach, if ice is broken
<span class="nc" id="L9114">                            entity.applyDamage();</span>
<span class="nc" id="L9115">                            roll = Compute.d6(1);</span>
<span class="nc" id="L9116">                            r = new Report(2118);</span>
<span class="nc" id="L9117">                            r.addDesc(entity);</span>
<span class="nc" id="L9118">                            r.add(roll);</span>
<span class="nc" id="L9119">                            r.subject = entity.getId();</span>
<span class="nc" id="L9120">                            addReport(r);</span>
<span class="nc bnc" id="L9121" title="All 2 branches missed.">                            if (roll == 6) {</span>
<span class="nc" id="L9122">                                entity.setPosition(curPos);</span>
<span class="nc" id="L9123">                                addReport(resolveIceBroken(curPos));</span>
<span class="nc" id="L9124">                                curPos = entity.getPosition();</span>
                            }
                        }
                    }
<span class="nc" id="L9128">                }</span>
<span class="nc bnc" id="L9129" title="All 4 branches missed.">            } else if (!(prevStep.climbMode() &amp;&amp; curHex.containsTerrain(Terrains.BRIDGE))</span>
<span class="nc bnc" id="L9130" title="All 2 branches missed.">                    &amp;&amp; !(entity.getMovementMode() == EntityMovementMode.HOVER)) {</span>
<span class="nc" id="L9131">                rollTarget = entity.checkWaterMove(waterLevel, overallMoveType);</span>
<span class="nc bnc" id="L9132" title="All 2 branches missed.">                if (rollTarget.getValue() != TargetRoll.CHECK_FALSE) {</span>
                    // For falling elevation, Entity must not on hex surface
<span class="nc" id="L9134">                    int currElevation = entity.getElevation();</span>
<span class="nc" id="L9135">                    entity.setElevation(0);</span>
<span class="nc" id="L9136">                    boolean success = doSkillCheckInPlace(entity, rollTarget);</span>
<span class="nc bnc" id="L9137" title="All 2 branches missed.">                    if (success) {</span>
<span class="nc" id="L9138">                        entity.setElevation(currElevation);</span>
                    }
                }
<span class="nc bnc" id="L9141" title="All 2 branches missed.">                if (waterLevel &gt; 1) {</span>
                    // Any swarming infantry will be destroyed.
<span class="nc" id="L9143">                    drownSwarmer(entity, curPos);</span>
                }
            }

            // check for building collapse
<span class="nc" id="L9148">            Building bldg = game.getBoard().getBuildingAt(curPos);</span>
<span class="nc bnc" id="L9149" title="All 2 branches missed.">            if (bldg != null) {</span>
<span class="nc" id="L9150">                checkForCollapse(bldg, game.getPositionMap(), curPos, true,</span>
                        vPhaseReport);
            }

            // Don't interact with terrain when jumping onto a building or a bridge
<span class="nc bnc" id="L9155" title="All 2 branches missed.">            if (entity.getElevation() == 0) {</span>
<span class="nc" id="L9156">                ServerHelper.checkAndApplyMagmaCrust(curHex, entity.getElevation(), entity, curPos, true, vPhaseReport, this);</span>

                // jumped into swamp? maybe stuck!
<span class="nc bnc" id="L9159" title="All 2 branches missed.">                if (curHex.getBogDownModifier(entity.getMovementMode(),</span>
                        entity instanceof LargeSupportTank) != TargetRoll.AUTOMATIC_SUCCESS) {
<span class="nc bnc" id="L9161" title="All 2 branches missed.">                    if (entity instanceof Mech) {</span>
<span class="nc" id="L9162">                        entity.setStuck(true);</span>
<span class="nc" id="L9163">                        r = new Report(2121);</span>
<span class="nc" id="L9164">                        r.add(entity.getDisplayName(), true);</span>
<span class="nc" id="L9165">                        r.subject = entity.getId();</span>
<span class="nc" id="L9166">                        addReport(r);</span>
                        // check for quicksand
<span class="nc" id="L9168">                        addReport(checkQuickSand(curPos));</span>
<span class="nc bnc" id="L9169" title="All 2 branches missed.">                    } else if (!entity.hasETypeFlag(Entity.ETYPE_INFANTRY)) {</span>
<span class="nc" id="L9170">                        rollTarget = new PilotingRollData(entity.getId(),</span>
                                5, &quot;entering boggy terrain&quot;);
<span class="nc" id="L9172">                        rollTarget.append(new PilotingRollData(entity.getId(),</span>
<span class="nc" id="L9173">                                curHex.getBogDownModifier(entity.getMovementMode(),</span>
                                        entity instanceof LargeSupportTank),
                                &quot;avoid bogging down&quot;));
<span class="nc bnc" id="L9176" title="All 2 branches missed.">                        if (0 &lt; doSkillCheckWhileMoving(entity, entity.getElevation(), curPos, curPos,</span>
                                rollTarget, false)) {
<span class="nc" id="L9178">                            entity.setStuck(true);</span>
<span class="nc" id="L9179">                            r = new Report(2081);</span>
<span class="nc" id="L9180">                            r.add(entity.getDisplayName());</span>
<span class="nc" id="L9181">                            r.subject = entity.getId();</span>
<span class="nc" id="L9182">                            addReport(r);</span>
                            // check for quicksand
<span class="nc" id="L9184">                            addReport(checkQuickSand(curPos));</span>
                        }
                    }
                }
            }
            // If the entity is being swarmed, jumping may dislodge the fleas.
<span class="nc bnc" id="L9190" title="All 2 branches missed.">            if (Entity.NONE != swarmerId) {</span>
<span class="nc" id="L9191">                final Entity swarmer = game.getEntity(swarmerId);</span>
<span class="nc" id="L9192">                rollTarget = entity.getBasePilotingRoll(overallMoveType);</span>

<span class="nc" id="L9194">                entity.addPilotingModifierForTerrain(rollTarget);</span>

                // Add a +4 modifier.
<span class="nc" id="L9197">                rollTarget.addModifier(4, &quot;dislodge swarming infantry&quot;);</span>

                // If the swarmer has Assault claws, give a 1 modifier.
                // We can stop looking when we find our first match.
<span class="nc bnc" id="L9201" title="All 2 branches missed.">                if (swarmer.hasWorkingMisc(MiscType.F_MAGNET_CLAW, -1)) {</span>
<span class="nc" id="L9202">                    rollTarget.addModifier(1, &quot;swarmer has magnetic claws&quot;);</span>
                }

                // okay, print the info
<span class="nc" id="L9206">                r = new Report(2125);</span>
<span class="nc" id="L9207">                r.subject = entity.getId();</span>
<span class="nc" id="L9208">                r.addDesc(entity);</span>
<span class="nc" id="L9209">                addReport(r);</span>

                // roll
<span class="nc" id="L9212">                final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L9213">                r = new Report(2130);</span>
<span class="nc" id="L9214">                r.subject = entity.getId();</span>
<span class="nc" id="L9215">                r.add(rollTarget.getValueAsString());</span>
<span class="nc" id="L9216">                r.add(rollTarget.getDesc());</span>
<span class="nc" id="L9217">                r.add(diceRoll);</span>
<span class="nc bnc" id="L9218" title="All 2 branches missed.">                if (diceRoll &lt; rollTarget.getValue()) {</span>
<span class="nc" id="L9219">                    r.choose(false);</span>
<span class="nc" id="L9220">                    addReport(r);</span>
                } else {
                    // Dislodged swarmers don't get turns.
<span class="nc" id="L9223">                    game.removeTurnFor(swarmer);</span>
<span class="nc" id="L9224">                    send(createTurnVectorPacket());</span>

                    // Update the report and the swarmer's status.
<span class="nc" id="L9227">                    r.choose(true);</span>
<span class="nc" id="L9228">                    addReport(r);</span>
<span class="nc" id="L9229">                    entity.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L9230">                    swarmer.setSwarmTargetId(Entity.NONE);</span>

                    // Did the infantry fall into water?
<span class="nc bnc" id="L9233" title="All 2 branches missed.">                    if (curHex.terrainLevel(Terrains.WATER) &gt; 0) {</span>
                        // Swarming infantry die.
<span class="nc" id="L9235">                        swarmer.setPosition(curPos);</span>
<span class="nc" id="L9236">                        r = new Report(2135);</span>
<span class="nc" id="L9237">                        r.subject = entity.getId();</span>
<span class="nc" id="L9238">                        r.indent();</span>
<span class="nc" id="L9239">                        r.addDesc(swarmer);</span>
<span class="nc" id="L9240">                        addReport(r);</span>
<span class="nc" id="L9241">                        addReport(destroyEntity(swarmer, &quot;a watery grave&quot;, false));</span>
                    } else {
                        // Swarming infantry take a 3d6 point hit.
                        // ASSUMPTION : damage should not be doubled.
<span class="nc" id="L9245">                        r = new Report(2140);</span>
<span class="nc" id="L9246">                        r.subject = entity.getId();</span>
<span class="nc" id="L9247">                        r.indent();</span>
<span class="nc" id="L9248">                        r.addDesc(swarmer);</span>
<span class="nc" id="L9249">                        r.add(&quot;3d6&quot;);</span>
<span class="nc" id="L9250">                        addReport(r);</span>
<span class="nc" id="L9251">                        addReport(damageEntity(swarmer,</span>
<span class="nc" id="L9252">                                swarmer.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT),</span>
<span class="nc" id="L9253">                                Compute.d6(3)));</span>
<span class="nc" id="L9254">                        addNewLines();</span>
<span class="nc" id="L9255">                        swarmer.setPosition(curPos);</span>
                    }
<span class="nc" id="L9257">                    entityUpdate(swarmerId);</span>
                } // End successful-PSR

            } // End try-to-dislodge-swarmers

            // one more check for inferno wash-off
<span class="nc" id="L9263">            checkForWashedInfernos(entity, curPos);</span>

            // a jumping tank needs to roll for movement damage
<span class="nc bnc" id="L9266" title="All 2 branches missed.">            if (entity instanceof Tank) {</span>
<span class="nc" id="L9267">                int modifier = 0;</span>
<span class="nc bnc" id="L9268" title="All 2 branches missed.">                if (curHex.containsTerrain(Terrains.ROUGH)</span>
<span class="nc bnc" id="L9269" title="All 2 branches missed.">                        || curHex.containsTerrain(Terrains.WOODS)</span>
<span class="nc bnc" id="L9270" title="All 2 branches missed.">                        || curHex.containsTerrain(Terrains.JUNGLE)) {</span>
<span class="nc" id="L9271">                    modifier = 1;</span>
                }
<span class="nc" id="L9273">                r = new Report(2126);</span>
<span class="nc" id="L9274">                r.subject = entity.getId();</span>
<span class="nc" id="L9275">                r.addDesc(entity);</span>
<span class="nc" id="L9276">                vPhaseReport.add(r);</span>
<span class="nc" id="L9277">                vPhaseReport.addAll(vehicleMotiveDamage((Tank)entity, modifier,</span>
                        false, -1, true));
<span class="nc" id="L9279">                Report.addNewline(vPhaseReport);</span>
            }

        } // End entity-is-jumping

        //If converting to another mode, set the final movement mode and report it
<span class="nc bnc" id="L9285" title="All 2 branches missed.">        if (entity.isConvertingNow()) {</span>
<span class="nc" id="L9286">            r = new Report(1210);</span>
<span class="nc" id="L9287">            r.subject = entity.getId();</span>
<span class="nc" id="L9288">            r.addDesc(entity);</span>
<span class="nc bnc" id="L9289" title="All 4 branches missed.">            if (entity instanceof QuadVee &amp;&amp; entity.isProne()</span>
<span class="nc bnc" id="L9290" title="All 2 branches missed.">                    &amp;&amp; entity.getConversionMode() == QuadVee.CONV_MODE_MECH) {</span>
                //Fall while converting to vehicle mode cancels conversion.
<span class="nc" id="L9292">                entity.setConvertingNow(false);</span>
<span class="nc" id="L9293">                r.messageId = 2454;</span>
            } else {
                // LAMs converting from fighter mode need to have the elevation set properly.
<span class="nc bnc" id="L9296" title="All 2 branches missed.">                if (entity.isAero()) {</span>
<span class="nc bnc" id="L9297" title="All 2 branches missed.">                    if (md.getFinalConversionMode() == EntityMovementMode.WIGE</span>
<span class="nc bnc" id="L9298" title="All 4 branches missed.">                            &amp;&amp; entity.getAltitude() &gt; 0 &amp;&amp; entity.getAltitude() &lt;= 3) {</span>
<span class="nc" id="L9299">                        entity.setElevation(entity.getAltitude() * 10);</span>
<span class="nc" id="L9300">                        entity.setAltitude(0);</span>
                    } else {
<span class="nc" id="L9302">                        IHex hex = game.getBoard().getHex(entity.getPosition());</span>
<span class="nc bnc" id="L9303" title="All 2 branches missed.">                        if (hex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L9304">                            entity.setElevation(hex.terrainLevel(Terrains.BLDG_ELEV));</span>
                        } else {
<span class="nc" id="L9306">                            entity.setElevation(0);</span>
                        }
                    }
                }
<span class="nc" id="L9310">                entity.setMovementMode(md.getFinalConversionMode());</span>
<span class="nc bnc" id="L9311" title="All 4 branches missed.">                if (entity instanceof Mech &amp;&amp; ((Mech)entity).hasTracks()) {</span>
<span class="nc" id="L9312">                    r.messageId = 2455;</span>
<span class="nc bnc" id="L9313" title="All 2 branches missed.">                    r.choose(entity.getMovementMode() == EntityMovementMode.TRACKED);</span>
<span class="nc bnc" id="L9314" title="All 2 branches missed.">                } else if (entity.getMovementMode() == EntityMovementMode.TRACKED</span>
<span class="nc bnc" id="L9315" title="All 2 branches missed.">                        || entity.getMovementMode() == EntityMovementMode.WHEELED) {</span>
<span class="nc" id="L9316">                    r.messageId = 2451;</span>
<span class="nc bnc" id="L9317" title="All 2 branches missed.">                } else if (entity.getMovementMode() == EntityMovementMode.WIGE) {</span>
<span class="nc" id="L9318">                    r.messageId = 2452;</span>
<span class="nc bnc" id="L9319" title="All 2 branches missed.">                } else if (entity.getMovementMode() == EntityMovementMode.AERODYNE) {</span>
<span class="nc" id="L9320">                    r.messageId = 2453;</span>
                } else {
<span class="nc" id="L9322">                    r.messageId = 2450;</span>
                }
<span class="nc bnc" id="L9324" title="All 2 branches missed.">                if (entity.isAero()) {</span>
<span class="nc" id="L9325">                    int altitude = entity.getAltitude();</span>
<span class="nc bnc" id="L9326" title="All 4 branches missed.">                    if (altitude == 0 &amp;&amp; md.getFinalElevation() &gt;= 8) {</span>
<span class="nc" id="L9327">                        altitude = 1;</span>
                    }
<span class="nc bnc" id="L9329" title="All 2 branches missed.">                    if (altitude == 0) {</span>
<span class="nc" id="L9330">                        ((IAero)entity).land();</span>
                    } else {
<span class="nc" id="L9332">                        ((IAero)entity).liftOff(altitude);</span>
                    }
                }
            }
<span class="nc" id="L9336">            addReport(r);</span>
        }

          // update entity's locations' exposure
<span class="nc" id="L9340">        vPhaseReport.addAll(doSetLocationsExposure(entity,</span>
<span class="nc" id="L9341">                game.getBoard().getHex(curPos), false, entity.getElevation()));</span>

        // Check the falls_end_movement option to see if it should be able to
        // move on.
        // Need to check here if the 'Mech actually went from non-prone to prone
        // here because 'fellDuringMovement' is sometimes abused just to force
        // another turn and so doesn't reliably tell us.
<span class="nc bnc" id="L9348" title="All 6 branches missed.">        boolean continueTurnFromFall = !(game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_FALLS_END_MOVEMENT)</span>
<span class="nc bnc" id="L9349" title="All 4 branches missed.">                    &amp;&amp; (entity instanceof Mech) &amp;&amp; !wasProne &amp;&amp; entity.isProne())</span>
<span class="nc bnc" id="L9350" title="All 4 branches missed.">                &amp;&amp; (fellDuringMovement &amp;&amp; !entity.isCarefulStand()) // Careful standing takes up the whole turn</span>
<span class="nc bnc" id="L9351" title="All 4 branches missed.">                &amp;&amp; !turnOver &amp;&amp; (entity.mpUsed &lt; entity.getRunMP())</span>
                &amp;&amp; (overallMoveType != EntityMovementType.MOVE_JUMP);
<span class="nc bnc" id="L9353" title="All 10 branches missed.">        if ((continueTurnFromFall || continueTurnFromPBS || continueTurnFromFishtail || continueTurnFromLevelDrop || continueTurnFromCliffAscent)</span>
<span class="nc bnc" id="L9354" title="All 4 branches missed.">                &amp;&amp; entity.isSelectableThisTurn() &amp;&amp; !entity.isDoomed()) {</span>
<span class="nc" id="L9355">            entity.applyDamage();</span>
<span class="nc" id="L9356">            entity.setDone(false);</span>
<span class="nc" id="L9357">            GameTurn newTurn = new GameTurn.SpecificEntityTurn(entity.getOwner().getId(), entity.getId());</span>
            // Need to set the new turn's multiTurn state
<span class="nc" id="L9359">            newTurn.setMultiTurn(true);</span>
<span class="nc" id="L9360">            game.insertNextTurn(newTurn);</span>
            // brief everybody on the turn update
<span class="nc" id="L9362">            send(createTurnVectorPacket());</span>
            // let everyone know about what just happened
<span class="nc bnc" id="L9364" title="All 2 branches missed.">            if (vPhaseReport.size() &gt; 1) {</span>
<span class="nc" id="L9365">                send(entity.getOwner().getId(), createSpecialReportPacket());</span>
            }
<span class="nc" id="L9367">        } else {</span>
<span class="nc bnc" id="L9368" title="All 2 branches missed.">            if (entity.getMovementMode() == EntityMovementMode.WIGE) {</span>
<span class="nc" id="L9369">                IHex hex = game.getBoard().getHex(curPos);</span>
<span class="nc bnc" id="L9370" title="All 2 branches missed.">                if (md.automaticWiGELanding(false)) {</span>
                    // try to land safely; LAMs require a psr when landing with gyro or leg actuator
                    // damage and ProtoMechs always require a roll
<span class="nc bnc" id="L9373" title="All 2 branches missed.">                    int elevation = (null == prevStep)? entity.getElevation() : prevStep.getElevation();</span>
<span class="nc bnc" id="L9374" title="All 2 branches missed.">                    if (entity.hasETypeFlag(Entity.ETYPE_LAND_AIR_MECH)) {</span>
<span class="nc" id="L9375">                        addReport(landAirMech((LandAirMech) entity, entity.getPosition(), elevation,</span>
                                entity.delta_distance));
<span class="nc bnc" id="L9377" title="All 2 branches missed.">                    } else if (entity.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</span>
<span class="nc" id="L9378">                        vPhaseReport.addAll(landGliderPM((Protomech) entity, entity.getPosition(),</span>
                                elevation, entity.delta_distance));
                    } else {
<span class="nc" id="L9381">                        r = new Report(2123);</span>
<span class="nc" id="L9382">                        r.addDesc(entity);</span>
<span class="nc" id="L9383">                        r.subject = entity.getId();</span>
<span class="nc" id="L9384">                        vPhaseReport.add(r);</span>
                    }

<span class="nc bnc" id="L9387" title="All 2 branches missed.">                    if (hex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L9388">                        Building bldg = game.getBoard().getBuildingAt(entity.getPosition());</span>
<span class="nc" id="L9389">                        entity.setElevation(hex.terrainLevel(Terrains.BLDG_ELEV));</span>
<span class="nc" id="L9390">                        addAffectedBldg(bldg, checkBuildingCollapseWhileMoving(bldg,</span>
<span class="nc" id="L9391">                                entity, entity.getPosition()));</span>
<span class="nc bnc" id="L9392" title="All 2 branches missed.">                    } else if (entity.isLocationProhibited(entity.getPosition(), 0)</span>
<span class="nc bnc" id="L9393" title="All 2 branches missed.">                            &amp;&amp; !hex.hasPavement()){</span>
                        // crash
<span class="nc" id="L9395">                        r = new Report(2124);</span>
<span class="nc" id="L9396">                        r.addDesc(entity);</span>
<span class="nc" id="L9397">                        r.subject = entity.getId();</span>
<span class="nc" id="L9398">                        vPhaseReport.add(r);</span>
<span class="nc" id="L9399">                        vPhaseReport.addAll(crashVTOLorWiGE((Tank) entity));</span>
                    } else {
<span class="nc" id="L9401">                        entity.setElevation(0);</span>
                    }

                    // Check for stacking violations in the target hex
<span class="nc" id="L9405">                    Entity violation = Compute.stackingViolation(game,</span>
<span class="nc" id="L9406">                            entity.getId(), entity.getPosition());</span>
<span class="nc bnc" id="L9407" title="All 2 branches missed.">                    if (violation != null) {</span>
<span class="nc" id="L9408">                        PilotingRollData prd = new PilotingRollData(</span>
<span class="nc" id="L9409">                                violation.getId(), 2, &quot;fallen on&quot;);</span>
<span class="nc bnc" id="L9410" title="All 2 branches missed.">                        if (violation instanceof Dropship) {</span>
<span class="nc" id="L9411">                            violation = entity;</span>
<span class="nc" id="L9412">                            prd = null;</span>
                        }
<span class="nc" id="L9414">                        Coords targetDest = Compute.getValidDisplacement(game,</span>
<span class="nc" id="L9415">                                violation.getId(), entity.getPosition(), 0);</span>
<span class="nc bnc" id="L9416" title="All 2 branches missed.">                        if (targetDest != null) {</span>
<span class="nc" id="L9417">                            vPhaseReport.addAll(doEntityDisplacement(violation,</span>
<span class="nc" id="L9418">                                    entity.getPosition(), targetDest, prd));</span>
                            // Update the violating entity's position on the
                            // client.
<span class="nc" id="L9421">                            entityUpdate(violation.getId());</span>
                        } else {
                            // ack! automatic death! Tanks
                            // suffer an ammo/power plant hit.
                            // TODO : a Mech suffers a Head Blown Off crit.
<span class="nc" id="L9426">                            vPhaseReport.addAll(destroyEntity(violation,</span>
                                    &quot;impossible displacement&quot;,
                                    violation instanceof Mech,
                                    violation instanceof Mech));
                        }
                    }
<span class="nc bnc" id="L9432" title="All 2 branches missed.">                } else if (!entity.hasETypeFlag(Entity.ETYPE_LAND_AIR_MECH)</span>
<span class="nc bnc" id="L9433" title="All 2 branches missed.">                        &amp;&amp; !entity.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</span>

                    // we didn't land, so we go to elevation 1 above the terrain
                    // features
                    // it might have been higher than one due to the extra MPs
                    // it can spend to stay higher during movement, but should
                    // end up at one

<span class="nc" id="L9441">                    entity.setElevation(Math.min(entity.getElevation(),</span>
<span class="nc" id="L9442">                            1 + hex.maxTerrainFeatureElevation(</span>
<span class="nc" id="L9443">                            game.getBoard().inAtmosphere())));</span>
                }
            }

            // If we've somehow gotten here as an airborne LAM with a destroyed side torso
            // (such as conversion while dropping), crash now.
<span class="nc bnc" id="L9449" title="All 2 branches missed.">            if (entity instanceof LandAirMech</span>
<span class="nc bnc" id="L9450" title="All 4 branches missed.">                    &amp;&amp; (entity.isLocationBad(Mech.LOC_RT) || entity.isLocationBad(Mech.LOC_LT))) {</span>
<span class="nc" id="L9451">                r = new Report(9710);</span>
<span class="nc" id="L9452">                r.subject = entity.getId();</span>
<span class="nc" id="L9453">                r.addDesc(entity);</span>
<span class="nc bnc" id="L9454" title="All 2 branches missed.">                if (entity.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L9455">                    addReport(r);</span>
<span class="nc" id="L9456">                    crashAirMech(entity, new PilotingRollData(entity.getId(), TargetRoll.AUTOMATIC_FAIL,</span>
                            &quot;side torso destroyed&quot;), vPhaseReport);
<span class="nc bnc" id="L9458" title="All 4 branches missed.">                } else if (entity.isAirborne() &amp;&amp; entity.isAero()) {</span>
<span class="nc" id="L9459">                    addReport(r);</span>
<span class="nc" id="L9460">                    addReport(processCrash(entity, ((IAero)entity).getCurrentVelocity(), entity.getPosition()));</span>
                }
            }

<span class="nc" id="L9464">            entity.setDone(true);</span>
        }

<span class="nc bnc" id="L9467" title="All 2 branches missed.">        if (dropshipStillUnloading) {</span>
            // turns should have already been inserted but we need to set the
            // entity as not done
<span class="nc" id="L9470">            entity.setDone(false);</span>
        }

        // If the entity is being swarmed, update the attacker's position.
<span class="nc bnc" id="L9474" title="All 2 branches missed.">        if (Entity.NONE != swarmerId) {</span>
<span class="nc" id="L9475">            final Entity swarmer = game.getEntity(swarmerId);</span>
<span class="nc" id="L9476">            swarmer.setPosition(curPos);</span>
            // If the hex is on fire, and the swarming infantry is
            // *not* Battle Armor, it drops off.
<span class="nc bnc" id="L9479" title="All 2 branches missed.">            if (!(swarmer instanceof BattleArmor) &amp;&amp; game.getBoard()</span>
<span class="nc bnc" id="L9480" title="All 2 branches missed.">                    .getHex(curPos).containsTerrain(Terrains.FIRE)) {</span>
<span class="nc" id="L9481">                swarmer.setSwarmTargetId(Entity.NONE);</span>
<span class="nc" id="L9482">                entity.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L9483">                r = new Report(2145);</span>
<span class="nc" id="L9484">                r.subject = entity.getId();</span>
<span class="nc" id="L9485">                r.indent();</span>
<span class="nc" id="L9486">                r.add(swarmer.getShortName(), true);</span>
<span class="nc" id="L9487">                addReport(r);</span>
            }
<span class="nc" id="L9489">            entityUpdate(swarmerId);</span>
        }

        // Update the entity's position,
        // unless it is off the game map.
<span class="nc bnc" id="L9494" title="All 2 branches missed.">        if (!game.isOutOfGame(entity)) {</span>
<span class="nc" id="L9495">            entityUpdate(entity.getId(), movePath, true, losCache);</span>
<span class="nc bnc" id="L9496" title="All 2 branches missed.">            if (entity.isDoomed()) {</span>
<span class="nc" id="L9497">                send(createRemoveEntityPacket(entity.getId(),</span>
<span class="nc" id="L9498">                        entity.getRemovalCondition()));</span>
            }
        }

        //If the entity is towing trailers, update the position of those trailers
<span class="nc bnc" id="L9503" title="All 2 branches missed.">        if (!entity.getAllTowedUnits().isEmpty()) {</span>
<span class="nc" id="L9504">            List&lt;Integer&gt; reversedTrailers = new ArrayList&lt;&gt;(entity.getAllTowedUnits()); // initialize with a copy (no need to initialize to an empty list first)</span>
<span class="nc" id="L9505">            Collections.reverse(reversedTrailers); // reverse in-place</span>
<span class="nc" id="L9506">            List&lt;Coords&gt; trailerPath = initializeTrailerCoordinates(entity, reversedTrailers); // no need to initialize to an empty list first</span>
<span class="nc" id="L9507">            processTrailerMovement(entity, trailerPath);</span>
         }

        // recovered units should now be recovered and dealt with
<span class="nc bnc" id="L9511" title="All 6 branches missed.">        if (entity.isAero() &amp;&amp; recovered &amp;&amp; (loader != null)) {</span>

<span class="nc bnc" id="L9513" title="All 2 branches missed.">            if (loader.isCapitalFighter()) {</span>
<span class="nc bnc" id="L9514" title="All 2 branches missed.">                if (!(loader instanceof FighterSquadron)) {</span>
                    // this is a solo capital fighter so we need to add a new
                    // squadron and load both the loader and loadee
<span class="nc" id="L9517">                    FighterSquadron fs = new FighterSquadron();</span>
<span class="nc" id="L9518">                    fs.setDeployed(true);</span>
<span class="nc" id="L9519">                    fs.setId(getFreeEntityId());</span>
<span class="nc" id="L9520">                    fs.setCurrentVelocity(((Aero) loader).getCurrentVelocity());</span>
<span class="nc" id="L9521">                    fs.setNextVelocity(((Aero) loader).getNextVelocity());</span>
<span class="nc" id="L9522">                    fs.setVectors(loader.getVectors());</span>
<span class="nc" id="L9523">                    fs.setFacing(loader.getFacing());</span>
<span class="nc" id="L9524">                    fs.setOwner(entity.getOwner());</span>
                    // set velocity and heading the same as parent entity
<span class="nc" id="L9526">                    game.addEntity(fs);</span>
<span class="nc" id="L9527">                    send(createAddEntityPacket(fs.getId()));</span>
                    // make him not get a move this turn
<span class="nc" id="L9529">                    fs.setDone(true);</span>
                    // place on board
<span class="nc" id="L9531">                    fs.setPosition(loader.getPosition());</span>
<span class="nc" id="L9532">                    loadUnit(fs, loader, -1);</span>
<span class="nc" id="L9533">                    loader = fs;</span>
<span class="nc" id="L9534">                    entityUpdate(fs.getId());</span>
                }
<span class="nc" id="L9536">                loader.load(entity);</span>
            } else {
<span class="nc" id="L9538">                loader.recover(entity);</span>
<span class="nc" id="L9539">                entity.setRecoveryTurn(5);</span>
            }

            // The loaded unit is being carried by the loader.
<span class="nc" id="L9543">            entity.setTransportId(loader.getId());</span>

            // Remove the loaded unit from the screen.
<span class="nc" id="L9546">            entity.setPosition(null);</span>

            // Update the loaded unit.
<span class="nc" id="L9549">            entityUpdate(entity.getId());</span>
        }

        // even if load was unsuccessful, I may need to update the loader
<span class="nc bnc" id="L9553" title="All 2 branches missed.">        if (null != loader) {</span>
<span class="nc" id="L9554">            entityUpdate(loader.getId());</span>
        }

        // if using double blind, update the player on new units he might see
<span class="nc bnc" id="L9558" title="All 2 branches missed.">        if (doBlind()) {</span>
<span class="nc" id="L9559">            send(entity.getOwner().getId(),</span>
<span class="nc" id="L9560">                    createFilteredEntitiesPacket(entity.getOwner(), losCache));</span>
        }

        // if we generated a charge attack, report it now
<span class="nc bnc" id="L9564" title="All 2 branches missed.">        if (charge != null) {</span>
<span class="nc" id="L9565">            send(createAttackPacket(charge, 1));</span>
        }

        // if we generated a ram attack, report it now
<span class="nc bnc" id="L9569" title="All 2 branches missed.">        if (ram != null) {</span>
<span class="nc" id="L9570">            send(createAttackPacket(ram, 1));</span>
        }
<span class="nc bnc" id="L9572" title="All 6 branches missed.">        if ((entity instanceof Mech) &amp;&amp; entity.hasEngine() &amp;&amp; ((Mech) entity).isIndustrial()</span>
<span class="nc bnc" id="L9573" title="All 2 branches missed.">                &amp;&amp; !entity.hasEnvironmentalSealing()</span>
<span class="nc bnc" id="L9574" title="All 2 branches missed.">                &amp;&amp; (entity.getEngine().getEngineType() == Engine.COMBUSTION_ENGINE)) {</span>
<span class="nc bnc" id="L9575" title="All 2 branches missed.">            if ((!entity.isProne()</span>
<span class="nc" id="L9576">                    &amp;&amp; (game.getBoard().getHex(entity.getPosition())</span>
<span class="nc bnc" id="L9577" title="All 2 branches missed.">                            .terrainLevel(Terrains.WATER) &gt;= 2))</span>
<span class="nc bnc" id="L9578" title="All 2 branches missed.">                    || (entity.isProne()</span>
<span class="nc" id="L9579">                            &amp;&amp; (game.getBoard().getHex(entity.getPosition())</span>
<span class="nc bnc" id="L9580" title="All 2 branches missed.">                                    .terrainLevel(Terrains.WATER) == 1))) {</span>
<span class="nc" id="L9581">                ((Mech) entity).setJustMovedIntoIndustrialKillingWater(true);</span>

            } else {
<span class="nc" id="L9584">                ((Mech) entity).setJustMovedIntoIndustrialKillingWater(false);</span>
            }
        }
<span class="nc" id="L9587">    }</span>

    /**
     * Updates the position of any towed trailers.
     *
     * @param tractor    The Entity that is moving
     * @param trainPath  The path all trailers are following?
     */
    private void processTrailerMovement(Entity tractor, List&lt;Coords&gt; trainPath) {
<span class="nc bnc" id="L9596" title="All 2 branches missed.">        for (int eId : tractor.getAllTowedUnits()) {</span>
<span class="nc" id="L9597">            Entity trailer = game.getEntity(eId);</span>
            // if the Tractor didn't move anywhere, stay where we are
<span class="nc bnc" id="L9599" title="All 2 branches missed.">            if (tractor.delta_distance == 0) {</span>
<span class="nc" id="L9600">                trailer.delta_distance = tractor.delta_distance;</span>
<span class="nc" id="L9601">                trailer.moved = tractor.moved;</span>
<span class="nc" id="L9602">                trailer.setSecondaryFacing(trailer.getFacing());</span>
<span class="nc" id="L9603">                trailer.setDone(true);</span>
<span class="nc" id="L9604">                entityUpdate(eId);</span>
<span class="nc" id="L9605">                continue;</span>
            }
            int stepNumber; // The Coords in trainPath that this trailer should move to
            Coords trailerPos;
<span class="nc" id="L9609">            int trailerNumber = tractor.getAllTowedUnits().indexOf(eId);</span>
<span class="nc" id="L9610">            double trailerPositionOffset = (trailerNumber + 1); //Offset so we get the right position index</span>
            // Unless the tractor is superheavy, put the first trailer in its hex.
            // Technically this would be true for a superheavy trailer too, but only a superheavy tractor can tow one.
<span class="nc bnc" id="L9613" title="All 4 branches missed.">            if (trailerNumber == 0 &amp;&amp; !tractor.isSuperHeavy()) {</span>
<span class="nc" id="L9614">                trailer.setPosition(tractor.getPosition());</span>
<span class="nc" id="L9615">                trailer.setFacing(tractor.getFacing());</span>
            } else {
                // If the trailer is superheavy, place it in a hex by itself
<span class="nc bnc" id="L9618" title="All 2 branches missed.">                if (trailer.isSuperHeavy()) {</span>
<span class="nc" id="L9619">                    trailerPositionOffset ++;</span>
<span class="nc" id="L9620">                    stepNumber = (trainPath.size() - (int) trailerPositionOffset);</span>
<span class="nc" id="L9621">                    trailerPos = trainPath.get(stepNumber);</span>
<span class="nc" id="L9622">                    trailer.setPosition(trailerPos);</span>
<span class="nc bnc" id="L9623" title="All 2 branches missed.">                    if ((tractor.getPassedThroughFacing().size() - trailerPositionOffset) &gt;= 0) {</span>
<span class="nc" id="L9624">                        trailer.setFacing(tractor.getPassedThroughFacing().get(tractor.getPassedThroughFacing().size() - (int) trailerPositionOffset));</span>
                    }
<span class="nc bnc" id="L9626" title="All 2 branches missed.">                } else if (tractor.isSuperHeavy()) {</span>
                    // If the tractor is superheavy, we can put two trailers in each hex
                    // starting trailer 0 in the hex behind the tractor
<span class="nc" id="L9629">                    trailerPositionOffset = (Math.ceil((trailerPositionOffset / 2.0)) + 1);</span>
<span class="nc" id="L9630">                    stepNumber = (trainPath.size() - (int) trailerPositionOffset);</span>
<span class="nc" id="L9631">                    trailerPos = trainPath.get(stepNumber);</span>
<span class="nc" id="L9632">                    trailer.setPosition(trailerPos);</span>
<span class="nc bnc" id="L9633" title="All 2 branches missed.">                    if ((tractor.getPassedThroughFacing().size() - trailerPositionOffset) &gt;= 0) {</span>
<span class="nc" id="L9634">                        trailer.setFacing(tractor.getPassedThroughFacing().get(tractor.getPassedThroughFacing().size() - (int) trailerPositionOffset));</span>
                    }
                } else {
                    // Otherwise, we can put two trailers in each hex
                    // starting trailer 1 in the hex behind the tractor
<span class="nc" id="L9639">                    trailerPositionOffset ++;</span>
<span class="nc" id="L9640">                    trailerPositionOffset = Math.ceil((trailerPositionOffset / 2.0));</span>
<span class="nc" id="L9641">                    stepNumber = (trainPath.size() - (int) trailerPositionOffset);</span>
<span class="nc" id="L9642">                    trailerPos = trainPath.get(stepNumber);</span>
<span class="nc" id="L9643">                    trailer.setPosition(trailerPos);</span>
<span class="nc bnc" id="L9644" title="All 2 branches missed.">                    if ((tractor.getPassedThroughFacing().size() - trailerPositionOffset) &gt;= 0) {</span>
<span class="nc" id="L9645">                        trailer.setFacing(tractor.getPassedThroughFacing().get(tractor.getPassedThroughFacing().size() - (int) trailerPositionOffset));</span>
                    }
                }
            }
            // trailers are immobile by default. Match the tractor's movement here
<span class="nc" id="L9650">            trailer.delta_distance = tractor.delta_distance;</span>
<span class="nc" id="L9651">            trailer.moved = tractor.moved;</span>
<span class="nc" id="L9652">            trailer.setSecondaryFacing(trailer.getFacing());</span>
<span class="nc" id="L9653">            trailer.setDone(true);</span>
<span class="nc" id="L9654">            entityUpdate(eId);</span>
<span class="nc" id="L9655">        }</span>
<span class="nc" id="L9656">    }</span>

    /**
     * Flips the order of a tractor's towed trailers list by index and
     * adds their starting coordinates to a list of hexes the tractor passed through
     *
     * @return  Returns the properly sorted list of all train coordinates
     */
    public List&lt;Coords&gt; initializeTrailerCoordinates(Entity tractor, List&lt;Integer&gt; allTowedTrailers) {
<span class="nc" id="L9665">        List&lt;Coords&gt; trainCoords = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L9666" title="All 2 branches missed.">        for (int trId : allTowedTrailers) {</span>
<span class="nc" id="L9667">            Entity trailer = game.getEntity(trId);</span>
<span class="nc" id="L9668">            Coords position = trailer.getPosition();</span>
            //Duplicates foul up the works...
<span class="nc bnc" id="L9670" title="All 2 branches missed.">            if (!trainCoords.contains(position)) {</span>
<span class="nc" id="L9671">                trainCoords.add(position);</span>
            }
<span class="nc" id="L9673">        }</span>
<span class="nc bnc" id="L9674" title="All 2 branches missed.">        for (Coords c : tractor.getPassedThrough() ) {</span>
<span class="nc bnc" id="L9675" title="All 2 branches missed.">            if (!trainCoords.contains(c)) {</span>
<span class="nc" id="L9676">                trainCoords.add(c);</span>
            }
<span class="nc" id="L9678">        }</span>
<span class="nc" id="L9679">        return trainCoords;</span>
    }

    /**
     * Checks whether the entity used MASC or a supercharger during movement, and if so checks for
     * and resolves any failures.
     *
     * @param entity  The unit using MASC/supercharger
     * @param md      The current &lt;code&gt;MovePath&lt;/code&gt;
     * @return        Whether the unit failed the check
     */
    private boolean checkMASCFailure(Entity entity, MovePath md) {
<span class="nc" id="L9691">        HashMap&lt;Integer, List&lt;CriticalSlot&gt;&gt; crits = new HashMap&lt;&gt;();</span>
<span class="nc" id="L9692">        Vector&lt;Report&gt; vReport = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L9693" title="All 2 branches missed.">        if (entity.checkForMASCFailure(md, vReport, crits)) {</span>
<span class="nc" id="L9694">            boolean mascFailure = true;</span>
            // Check to see if the pilot can reroll due to Edge
<span class="nc bnc" id="L9696" title="All 2 branches missed.">            if (entity.getCrew().hasEdgeRemaining()</span>
<span class="nc" id="L9697">                    &amp;&amp; entity.getCrew().getOptions()</span>
<span class="nc bnc" id="L9698" title="All 2 branches missed.">                            .booleanOption(OptionsConstants.EDGE_WHEN_MASC_FAILS)) {</span>
<span class="nc" id="L9699">                entity.getCrew().decreaseEdge();</span>
                // Need to reset the MASCUsed flag
<span class="nc" id="L9701">                entity.setMASCUsed(false);</span>
                // Report to notify user that masc check was rerolled
<span class="nc" id="L9703">                Report masc_report = new Report(6501);</span>
<span class="nc" id="L9704">                masc_report.subject = entity.getId();</span>
<span class="nc" id="L9705">                masc_report.indent(2);</span>
<span class="nc" id="L9706">                masc_report.addDesc(entity);</span>
<span class="nc" id="L9707">                vReport.add(masc_report);</span>
                // Report to notify user how much edge pilot has left
<span class="nc" id="L9709">                masc_report = new Report(6510);</span>
<span class="nc" id="L9710">                masc_report.subject = entity.getId();</span>
<span class="nc" id="L9711">                masc_report.indent(2);</span>
<span class="nc" id="L9712">                masc_report.addDesc(entity);</span>
<span class="nc" id="L9713">                masc_report.add(entity.getCrew().getOptions()</span>
<span class="nc" id="L9714">                        .intOption(OptionsConstants.EDGE));</span>
<span class="nc" id="L9715">                vReport.addElement(masc_report);</span>
                // Recheck MASC failure
<span class="nc bnc" id="L9717" title="All 2 branches missed.">                if (!entity.checkForMASCFailure(md, vReport, crits)) {</span>
                    // The reroll passed, don't process the failure
<span class="nc" id="L9719">                    mascFailure = false;</span>
<span class="nc" id="L9720">                    addReport(vReport);</span>
                }
            }
            // Check for failure and process it
<span class="nc bnc" id="L9724" title="All 2 branches missed.">            if (mascFailure) {</span>
<span class="nc" id="L9725">                addReport(vReport);</span>
                // If this is supercharger failure we need to damage the supercharger as well as
                // the additional criticals. For mechs this requires the additional step of finding
                // the slot and marking it as hit so it can't absorb future damage.
<span class="nc" id="L9729">                Mounted supercharger = entity.getSuperCharger();</span>
<span class="nc bnc" id="L9730" title="All 4 branches missed.">                if ((null != supercharger) &amp;&amp; supercharger.curMode().equals(&quot;Armed&quot;)) {</span>
<span class="nc bnc" id="L9731" title="All 2 branches missed.">                    if (entity.hasETypeFlag(Entity.ETYPE_MECH)) {</span>
<span class="nc" id="L9732">                        final int loc = supercharger.getLocation();</span>
<span class="nc bnc" id="L9733" title="All 2 branches missed.">                        for (int slot = 0; slot &lt; entity.getNumberOfCriticals(loc); slot++) {</span>
<span class="nc" id="L9734">                            final CriticalSlot crit = entity.getCritical(loc, slot);</span>
<span class="nc bnc" id="L9735" title="All 4 branches missed.">                            if ((null != crit) &amp;&amp; (crit.getType() == CriticalSlot.TYPE_EQUIPMENT)</span>
<span class="nc bnc" id="L9736" title="All 2 branches missed.">                                    &amp;&amp; (crit.getMount().getType().equals(supercharger.getType()))) {</span>
<span class="nc" id="L9737">                                addReport(applyCriticalHit(entity, loc, crit,</span>
                                        true, 0, false));
<span class="nc" id="L9739">                                break;</span>
                            }
                        }
<span class="nc" id="L9742">                    } else {</span>
<span class="nc" id="L9743">                        supercharger.setHit(true);</span>
                    }
<span class="nc" id="L9745">                    supercharger.setMode(&quot;Off&quot;);</span>
                }
<span class="nc bnc" id="L9747" title="All 2 branches missed.">                for (Integer loc : crits.keySet()) {</span>
<span class="nc" id="L9748">                    List&lt;CriticalSlot&gt; lcs = crits.get(loc);</span>
<span class="nc bnc" id="L9749" title="All 2 branches missed.">                    for (CriticalSlot cs : lcs) {</span>
                        // HACK: if loc is -1, we need to deal motive damage to
                        // the tank, the severity of which is stored in the critslot index
<span class="nc bnc" id="L9752" title="All 2 branches missed.">                        if (loc == -1) {</span>
<span class="nc" id="L9753">                            addReport(vehicleMotiveDamage((Tank) entity,</span>
<span class="nc" id="L9754">                                    0, true, cs.getIndex()));</span>
                        } else {
<span class="nc" id="L9756">                            addReport(applyCriticalHit(entity, loc, cs,</span>
                                    true, 0, false));
                        }
<span class="nc" id="L9759">                    }</span>
<span class="nc" id="L9760">                }</span>
                // do any PSR immediately
<span class="nc" id="L9762">                addReport(resolvePilotingRolls(entity));</span>
<span class="nc" id="L9763">                game.resetPSRs(entity);</span>
                // let the player replot their move as MP might be changed
<span class="nc" id="L9765">                md.clear();</span>
<span class="nc" id="L9766">                return true;</span>
            }
<span class="nc" id="L9768">        } else {</span>
<span class="nc" id="L9769">            addReport(vReport);</span>
        }
<span class="nc" id="L9771">        return false;</span>
    }

    /**
     * LAMs or QuadVees converting from leg mode may force any carried infantry (including swarming)
     * to fall into the current hex. A LAM may suffer damage.
     *
     * @param carrier       The &lt;code&gt;Entity&lt;/code&gt; making the conversion.
     * @param rider         The &lt;code&gt;Entity&lt;/code&gt; possibly being forced off.
     * @param curPos        The coordinates of the hex where the conversion starts.
     * @param curFacing     The carrier's facing when conversion starts.
     * @param automatic     Whether the infantry falls automatically. If false, an anti-mech roll is made
     *                      to see whether it stays mounted.
     * @param infDamage     If true, the infantry takes falling damage, +1D6 for conventional.
     * @param carrierDamage If true, the carrier takes damage from converting while carrying infantry.
     */
    private Vector&lt;Report&gt; checkDropBAFromConverting(Entity carrier, Entity rider, Coords curPos, int curFacing,
            boolean automatic, boolean infDamage, boolean carrierDamage) {
<span class="nc" id="L9789">        Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L9791">        PilotingRollData prd = rider.getBasePilotingRoll(EntityMovementType.MOVE_NONE);</span>
<span class="nc" id="L9792">        boolean falls = automatic;</span>
<span class="nc bnc" id="L9793" title="All 2 branches missed.">        if (automatic) {</span>
<span class="nc" id="L9794">            r = new Report(2465);</span>
<span class="nc" id="L9795">            r.subject = rider.getId();</span>
<span class="nc" id="L9796">            r.addDesc(rider);</span>
<span class="nc" id="L9797">            r.addDesc(carrier);</span>
        } else {
<span class="nc" id="L9799">            r = new Report(2460);</span>
<span class="nc" id="L9800">            r.subject = rider.getId();</span>
<span class="nc" id="L9801">            r.addDesc(rider);</span>
<span class="nc" id="L9802">            r.add(prd.getValueAsString());</span>
<span class="nc" id="L9803">            r.addDesc(carrier);</span>
<span class="nc" id="L9804">            final int diceRoll = carrier.getCrew().rollPilotingSkill();</span>
<span class="nc" id="L9805">            r.add(diceRoll);</span>
<span class="nc bnc" id="L9806" title="All 2 branches missed.">            if (diceRoll &lt; prd.getValue()) {</span>
<span class="nc" id="L9807">                r.choose(false);</span>
<span class="nc" id="L9808">                falls = true;</span>
            } else {
<span class="nc" id="L9810">                r.choose(true);</span>
            }
        }
<span class="nc" id="L9813">        reports.add(r);</span>
<span class="nc bnc" id="L9814" title="All 2 branches missed.">        if (falls) {</span>
<span class="nc bnc" id="L9815" title="All 2 branches missed.">            if (carrier.getSwarmAttackerId() == rider.getId()) {</span>
<span class="nc" id="L9816">                rider.setDone(true);</span>
<span class="nc" id="L9817">                carrier.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L9818">                rider.setSwarmTargetId(Entity.NONE);</span>
<span class="nc bnc" id="L9819" title="All 2 branches missed.">            } else if (!unloadUnit(carrier, rider, curPos, curFacing, 0)) {</span>
<span class="nc" id="L9820">                MegaMek.getLogger().error(&quot;Server was told to unload &quot;</span>
<span class="nc" id="L9821">                                + rider.getDisplayName() + &quot; from &quot;</span>
<span class="nc" id="L9822">                                + carrier.getDisplayName() + &quot; into &quot;</span>
<span class="nc" id="L9823">                                + curPos.getBoardNum());</span>
<span class="nc" id="L9824">                return reports;</span>
            }
<span class="nc bnc" id="L9826" title="All 2 branches missed.">            if (infDamage) {</span>
<span class="nc" id="L9827">                reports.addAll(doEntityFall(rider, curPos, 2, prd));</span>
<span class="nc bnc" id="L9828" title="All 2 branches missed.">                if (rider.getEntityType() == Entity.ETYPE_INFANTRY) {</span>
<span class="nc" id="L9829">                    int extra = Compute.d6();</span>
<span class="nc" id="L9830">                    reports.addAll(damageEntity(rider, new HitData(Infantry.LOC_INFANTRY), extra));</span>
                }
            }
<span class="nc bnc" id="L9833" title="All 2 branches missed.">            if (carrierDamage) {</span>
                //Report the possibility of a critical hit.
<span class="nc" id="L9835">                r = new Report(2470);</span>
<span class="nc" id="L9836">                r.subject = carrier.getId();</span>
<span class="nc" id="L9837">                r.addDesc(carrier);</span>
<span class="nc" id="L9838">                reports.addElement(r);</span>
<span class="nc" id="L9839">                int mod = 0;</span>
<span class="nc bnc" id="L9840" title="All 2 branches missed.">                if (rider.getEntityType() == Entity.ETYPE_INFANTRY) {</span>
<span class="nc" id="L9841">                    mod = -2;</span>
                }
<span class="nc" id="L9843">                HitData hit = carrier.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L9844">                reports.addAll(criticalEntity(carrier, hit.getLocation(), false, mod, 0));</span>
            }
        }
<span class="nc" id="L9847">        return reports;</span>
    }

    /**
     * Handles a pointblank shot for hidden units, which must request feedback
     * from the client of the player who owns the hidden unit.
     * @return Returns true if a point-blank shot was taken, otherwise false
     */
    private boolean processPointblankShotCFR(Entity hidden, Entity target) {
<span class="nc" id="L9856">        sendPointBlankShotCFR(hidden, target);</span>
<span class="nc" id="L9857">        boolean firstPacket = true;</span>
        // Keep processing until we get a response
        while (true) {
<span class="nc" id="L9860">            synchronized (cfrPacketQueue) {</span>
                try {
<span class="nc bnc" id="L9862" title="All 2 branches missed.">                    while (cfrPacketQueue.isEmpty()) {</span>
<span class="nc" id="L9863">                        cfrPacketQueue.wait();</span>
                    }
<span class="nc" id="L9865">                } catch (InterruptedException e) {</span>
<span class="nc" id="L9866">                    return false;</span>
<span class="nc" id="L9867">                }</span>
                // Get the packet, if there's something to get
                ReceivedPacket rp;
<span class="nc bnc" id="L9870" title="All 2 branches missed.">                if (cfrPacketQueue.size() &gt; 0) {</span>
<span class="nc" id="L9871">                    rp = cfrPacketQueue.poll();</span>
<span class="nc" id="L9872">                    int cfrType = rp.packet.getIntValue(0);</span>
                    // Make sure we got the right type of response
<span class="nc bnc" id="L9874" title="All 2 branches missed.">                    if (cfrType != Packet.COMMAND_CFR_HIDDEN_PBS) {</span>
<span class="nc" id="L9875">                        MegaMek.getLogger().error(&quot;Expected a &quot; + &quot;COMMAND_CFR_HIDDEN_PBS CFR packet, &quot; </span>
                                + &quot;received: &quot; + cfrType);
<span class="nc" id="L9877">                        continue;</span>
                    }
                    // Check packet came from right ID
<span class="nc bnc" id="L9880" title="All 2 branches missed.">                    if (rp.connId != hidden.getOwnerId()) {</span>
<span class="nc" id="L9881">                        MegaMek.getLogger().error(&quot;Expected a &quot; + &quot;COMMAND_CFR_HIDDEN_PBS CFR packet &quot; </span>
<span class="nc" id="L9882">                                + &quot;from player  &quot; + hidden.getOwnerId()</span>
                                + &quot; but instead it came from player &quot; + rp.connId);
<span class="nc" id="L9884">                        continue;</span>
                    }
<span class="nc" id="L9886">                } else { // If no packets, wait again</span>
<span class="nc" id="L9887">                    continue;</span>
                }
                // First packet indicates whether the PBS is taken or declined
<span class="nc bnc" id="L9890" title="All 2 branches missed.">                if (firstPacket) {</span>
                    // Check to see if the client declined the PBS
<span class="nc bnc" id="L9892" title="All 2 branches missed.">                    if (rp.packet.getObject(1) == null) {</span>
<span class="nc" id="L9893">                        return false;</span>
                    } else {
<span class="nc" id="L9895">                        firstPacket = false;</span>
                        // Notify other clients, so they can display a message
<span class="nc bnc" id="L9897" title="All 2 branches missed.">                        for (IPlayer p : game.getPlayersVector()) {</span>
<span class="nc bnc" id="L9898" title="All 2 branches missed.">                            if (p.getId() == hidden.getOwnerId()) {</span>
<span class="nc" id="L9899">                                continue;</span>
                            }
<span class="nc" id="L9901">                            send(p.getId(), new Packet(</span>
                                    Packet.COMMAND_CLIENT_FEEDBACK_REQUEST,
                                    new Object[] {
<span class="nc" id="L9904">                                            Packet.COMMAND_CFR_HIDDEN_PBS,</span>
<span class="nc" id="L9905">                                            Entity.NONE, Entity.NONE }));</span>
<span class="nc" id="L9906">                        }</span>
                        // Update all clients with the position of the PBS
<span class="nc" id="L9908">                        entityUpdate(target.getId());</span>
<span class="nc" id="L9909">                        continue;</span>
                    }
                }
                // The second packet contains the attacks to process
                @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L9914">                Vector&lt;EntityAction&gt; attacks = (Vector&lt;EntityAction&gt;) rp.packet.getObject(1);</span>
                // Mark the hidden unit as having taken a PBS
<span class="nc" id="L9916">                hidden.setMadePointblankShot(true);</span>
                // Process the Actions
<span class="nc bnc" id="L9918" title="All 2 branches missed.">                for (EntityAction ea : attacks) {</span>
<span class="nc" id="L9919">                    Entity entity = game.getEntity(ea.getEntityId());</span>
<span class="nc bnc" id="L9920" title="All 2 branches missed.">                    if (ea instanceof TorsoTwistAction) {</span>
<span class="nc" id="L9921">                        TorsoTwistAction tta = (TorsoTwistAction) ea;</span>
<span class="nc bnc" id="L9922" title="All 2 branches missed.">                        if (entity.canChangeSecondaryFacing()) {</span>
<span class="nc" id="L9923">                            entity.setSecondaryFacing(tta.getFacing());</span>
                        }
<span class="nc bnc" id="L9925" title="All 2 branches missed.">                    } else if (ea instanceof FlipArmsAction) {</span>
<span class="nc" id="L9926">                        FlipArmsAction faa = (FlipArmsAction) ea;</span>
<span class="nc" id="L9927">                        entity.setArmsFlipped(faa.getIsFlipped());</span>
<span class="nc bnc" id="L9928" title="All 2 branches missed.">                    } else if (ea instanceof SearchlightAttackAction) {</span>
<span class="nc" id="L9929">                        boolean hexesAdded = ((SearchlightAttackAction) ea).setHexesIlluminated(game);</span>
                        // If we added new hexes, send them to all players.
                        // These are spotlights at night, you know they're
                        // there.
<span class="nc bnc" id="L9933" title="All 2 branches missed.">                        if (hexesAdded) {</span>
<span class="nc" id="L9934">                            send(createIlluminatedHexesPacket());</span>
                        }
<span class="nc" id="L9936">                        SearchlightAttackAction saa = (SearchlightAttackAction) ea;</span>
<span class="nc" id="L9937">                        addReport(saa.resolveAction(game));</span>
<span class="nc bnc" id="L9938" title="All 2 branches missed.">                    } else if (ea instanceof WeaponAttackAction) {</span>
<span class="nc" id="L9939">                        WeaponAttackAction waa = (WeaponAttackAction) ea;</span>
<span class="nc" id="L9940">                        Entity ae = game.getEntity(waa.getEntityId());</span>
<span class="nc" id="L9941">                        Mounted m = ae.getEquipment(waa.getWeaponId());</span>
<span class="nc" id="L9942">                        Weapon w = (Weapon) m.getType();</span>
                        // Track attacks original target, for things like swarm LRMs
<span class="nc" id="L9944">                        waa.setOriginalTargetId(waa.getTargetId());</span>
<span class="nc" id="L9945">                        waa.setOriginalTargetType(waa.getTargetType());</span>
<span class="nc" id="L9946">                        AttackHandler ah = w.fire(waa, game, this);</span>
<span class="nc bnc" id="L9947" title="All 2 branches missed.">                        if (ah != null) {</span>
<span class="nc" id="L9948">                            ah.setStrafing(waa.isStrafing());</span>
<span class="nc" id="L9949">                            ah.setStrafingFirstShot(waa.isStrafingFirstShot());</span>
<span class="nc" id="L9950">                            game.addAttack(ah);</span>
                        }
                    }
<span class="nc" id="L9953">                }</span>
                // Now handle the attacks
                // Set to the firing phase, so the attacks handle
<span class="nc" id="L9956">                IGame.Phase currentPhase = game.getPhase();</span>
<span class="nc" id="L9957">                game.setPhase(IGame.Phase.PHASE_FIRING);</span>
                // Handle attacks
<span class="nc" id="L9959">                handleAttacks(true);</span>
                // Restore Phase
<span class="nc" id="L9961">                game.setPhase(currentPhase);</span>
<span class="nc" id="L9962">                return true;</span>
            }
        }
    }

    public int processTeleguidedMissileCFR(int playerId, List&lt;Integer&gt; targetIds, List&lt;Integer&gt; toHitValues) {
<span class="nc" id="L9968">        sendTeleguidedMissileCFR(playerId, targetIds, toHitValues);</span>
        while (true) {
<span class="nc" id="L9970">            synchronized (cfrPacketQueue) {</span>
                try {
<span class="nc bnc" id="L9972" title="All 2 branches missed.">                    while (cfrPacketQueue.isEmpty()) {</span>
<span class="nc" id="L9973">                        cfrPacketQueue.wait();</span>
                    }
<span class="nc" id="L9975">                } catch (InterruptedException e) {</span>
<span class="nc" id="L9976">                    return 0;</span>
<span class="nc" id="L9977">                }</span>
                // Get the packet, if there's something to get
                ReceivedPacket rp;
<span class="nc bnc" id="L9980" title="All 2 branches missed.">                if (cfrPacketQueue.size() &gt; 0) {</span>
<span class="nc" id="L9981">                    rp = cfrPacketQueue.poll();</span>
<span class="nc" id="L9982">                    int cfrType = rp.packet.getIntValue(0);</span>
                    // Make sure we got the right type of response
<span class="nc bnc" id="L9984" title="All 2 branches missed.">                    if (cfrType != Packet.COMMAND_CFR_TELEGUIDED_TARGET) {</span>
<span class="nc" id="L9985">                        MegaMek.getLogger().error(&quot;Expected a &quot; </span>
                                + &quot;COMMAND_CFR_TELEGUIDED_TARGET CFR packet, &quot; + &quot;received: &quot; + cfrType);
<span class="nc" id="L9987">                        continue;</span>
                    }
                    // Check packet came from right ID
<span class="nc bnc" id="L9990" title="All 2 branches missed.">                    if (rp.connId != playerId) {</span>
<span class="nc" id="L9991">                        MegaMek.getLogger().error(&quot;Expected a &quot; </span>
                                + &quot;COMMAND_CFR_TELEGUIDED_TARGET CFR packet &quot; + &quot;from player  &quot; + playerId
                                + &quot; but instead it came from player &quot; + rp.connId);
<span class="nc" id="L9994">                        continue;</span>
                    }
<span class="nc" id="L9996">                    return (int)rp.packet.getData()[1];</span>
                } // If no packets, wait again
<span class="nc" id="L9998">            }</span>
        }
    }
    
    public int processTAGTargetCFR(int playerId, List&lt;Integer&gt; targetIds, List&lt;Integer&gt; targetTypes) {
<span class="nc" id="L10003">        sendTAGTargetCFR(playerId, targetIds, targetTypes);</span>
        while (true) {
<span class="nc" id="L10005">            synchronized (cfrPacketQueue) {</span>
                try {
<span class="nc bnc" id="L10007" title="All 2 branches missed.">                    while (cfrPacketQueue.isEmpty()) {</span>
<span class="nc" id="L10008">                        cfrPacketQueue.wait();</span>
                    }
<span class="nc" id="L10010">                } catch (InterruptedException e) {</span>
<span class="nc" id="L10011">                    return 0;</span>
<span class="nc" id="L10012">                }</span>
                // Get the packet, if there's something to get
                ReceivedPacket rp;
<span class="nc bnc" id="L10015" title="All 2 branches missed.">                if (cfrPacketQueue.size() &gt; 0) {</span>
<span class="nc" id="L10016">                    rp = cfrPacketQueue.poll();</span>
<span class="nc" id="L10017">                    int cfrType = rp.packet.getIntValue(0);</span>
                    // Make sure we got the right type of response
<span class="nc bnc" id="L10019" title="All 2 branches missed.">                    if (cfrType != Packet.COMMAND_CFR_TAG_TARGET) {</span>
<span class="nc" id="L10020">                        MegaMek.getLogger().error(&quot;Expected a &quot; + &quot;COMMAND_CFR_TAG_TARGET CFR packet, &quot;</span>
                                        + &quot;received: &quot; + cfrType);
<span class="nc" id="L10022">                        continue;</span>
                    }
                    // Check packet came from right ID
<span class="nc bnc" id="L10025" title="All 2 branches missed.">                    if (rp.connId != playerId) {</span>
<span class="nc" id="L10026">                        MegaMek.getLogger().error(&quot;Expected a &quot; + &quot;COMMAND_CFR_TAG_TARGET CFR packet &quot;</span>
                                        + &quot;from player  &quot; + playerId
                                        + &quot; but instead it came from player &quot; + rp.connId);
<span class="nc" id="L10029">                        continue;</span>
                    }
<span class="nc" id="L10031">                    return (int) rp.packet.getData()[1];</span>
                }
<span class="nc" id="L10033">            }</span>
        }
    }

    /**
     * If an aero unit takes off in the same turn that other units loaded, then
     * it risks damage to itself and those units
     *
     * @param a - The &lt;code&gt;Aero&lt;/code&gt; taking off
     */
    private void checkForTakeoffDamage(IAero a) {
<span class="nc" id="L10044">        boolean unsecured = false;</span>
<span class="nc bnc" id="L10045" title="All 2 branches missed.">        for (Entity loaded : ((Entity)a).getLoadedUnits()) {</span>
<span class="nc bnc" id="L10046" title="All 4 branches missed.">            if (loaded.wasLoadedThisTurn() &amp;&amp; !(loaded instanceof Infantry)) {</span>
<span class="nc" id="L10047">                unsecured = true;</span>
                // uh-oh, you forgot your seat belt
<span class="nc" id="L10049">                Report r = new Report(6800);</span>
<span class="nc" id="L10050">                r.subject = loaded.getId();</span>
<span class="nc" id="L10051">                r.addDesc(loaded);</span>
<span class="nc" id="L10052">                addReport(r);</span>
<span class="nc" id="L10053">                int damage = 25;</span>
<span class="nc" id="L10054">                ToHitData toHit = new ToHitData();</span>
<span class="nc bnc" id="L10055" title="All 2 branches missed.">                while (damage &gt; 0) {</span>
<span class="nc" id="L10056">                    HitData hit = loaded.rollHitLocation(toHit.getHitTable(), ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L10057">                    addReport(damageEntity(loaded, hit, 5, false,</span>
                            DamageType.NONE, false, true, false));
<span class="nc" id="L10059">                    damage -= 5;</span>
<span class="nc" id="L10060">                }</span>
            }
<span class="nc" id="L10062">        }</span>
<span class="nc bnc" id="L10063" title="All 2 branches missed.">        if (unsecured) {</span>
            // roll hit location to get a new critical
<span class="nc" id="L10065">            HitData hit = ((Entity)a).rollHitLocation(ToHitData.HIT_ABOVE, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L10066">            addReport(applyCriticalHit((Entity)a, hit.getLocation(), new CriticalSlot(</span>
<span class="nc" id="L10067">                    0, ((Aero)a).getPotCrit()), true, 1, false));</span>
        }

<span class="nc" id="L10070">    }</span>

    /**
     * Delivers a thunder-aug shot to the targeted hex area. Thunder-Augs are 7
     * hexes, though, so...
     *
     * @param damage
     *            The per-hex density of the incoming minefield; that is, the
     *            final value with any modifiers (such as halving and rounding
     *            just for &lt;em&gt;being&lt;/em&gt; T-Aug) already applied.
     */
    public void deliverThunderAugMinefield(Coords coords, int playerId, int damage, int entityId) {
        Coords mfCoord;
<span class="nc bnc" id="L10083" title="All 2 branches missed.">        for (int dir = 0; dir &lt; 7; dir++) {</span>
            // May need to reset here for each new hex.
<span class="nc" id="L10085">            int hexDamage = damage;</span>
<span class="nc bnc" id="L10086" title="All 2 branches missed.">            if (dir == 6) {// The targeted hex.</span>
<span class="nc" id="L10087">                mfCoord = coords;</span>
            } else {// The hex in the dir direction from the targeted hex.
<span class="nc" id="L10089">                mfCoord = coords.translated(dir);</span>
            }

            // Only if this is on the board...
<span class="nc bnc" id="L10093" title="All 2 branches missed.">            if (game.getBoard().contains(mfCoord)) {</span>
<span class="nc" id="L10094">                Minefield minefield = null;</span>
<span class="nc" id="L10095">                Enumeration&lt;Minefield&gt; minefields = game.getMinefields(mfCoord).elements();</span>
                // Check if there already are Thunder minefields in the hex.
<span class="nc bnc" id="L10097" title="All 2 branches missed.">                while (minefields.hasMoreElements()) {</span>
<span class="nc" id="L10098">                    Minefield mf = minefields.nextElement();</span>
<span class="nc bnc" id="L10099" title="All 2 branches missed.">                    if (mf.getType() == Minefield.TYPE_CONVENTIONAL) {</span>
<span class="nc" id="L10100">                        minefield = mf;</span>
<span class="nc" id="L10101">                        break;</span>
                    }
<span class="nc" id="L10103">                }</span>

                // Did we find a Thunder minefield in the hex?
                // N.B. damage Thunder minefields equals the number of
                // missiles, divided by two, rounded up.
<span class="nc bnc" id="L10108" title="All 2 branches missed.">                if (minefield == null) {</span>
                    // Nope. Create a new Thunder minefield
<span class="nc" id="L10110">                    minefield = Minefield.createMinefield(mfCoord, playerId,</span>
                            Minefield.TYPE_CONVENTIONAL, hexDamage);
<span class="nc" id="L10112">                    game.addMinefield(minefield);</span>
<span class="nc" id="L10113">                    checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
<span class="nc bnc" id="L10114" title="All 2 branches missed.">                } else if (minefield.getDensity() &lt; Minefield.MAX_DAMAGE) {</span>
                    // Yup. Replace the old one.
<span class="nc" id="L10116">                    removeMinefield(minefield);</span>
<span class="nc" id="L10117">                    hexDamage += minefield.getDensity();</span>

                    // Damage from Thunder minefields are capped.
<span class="nc bnc" id="L10120" title="All 2 branches missed.">                    if (hexDamage &gt; Minefield.MAX_DAMAGE) {</span>
<span class="nc" id="L10121">                        hexDamage = Minefield.MAX_DAMAGE;</span>
                    }
<span class="nc" id="L10123">                    minefield.setDensity(hexDamage);</span>
<span class="nc" id="L10124">                    game.addMinefield(minefield);</span>
<span class="nc" id="L10125">                    checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
                }
            } // End coords-on-board
        } // Handle the next coords
<span class="nc" id="L10129">    }</span>

    /**
     * Adds a Thunder minefield to the hex.
     *
     * @param coords   the minefield's coordinates
     * @param playerId the deploying player's id
     * @param damage   the amount of damage the minefield does
     * @param entityId an entity that might spot the minefield
     */
    public void deliverThunderMinefield(Coords coords, int playerId, int damage, int entityId) {
<span class="nc" id="L10140">        Minefield minefield = null;</span>
<span class="nc" id="L10141">        Enumeration&lt;Minefield&gt; minefields = game.getMinefields(coords).elements();</span>
        // Check if there already are Thunder minefields in the hex.
<span class="nc bnc" id="L10143" title="All 2 branches missed.">        while (minefields.hasMoreElements()) {</span>
<span class="nc" id="L10144">            Minefield mf = minefields.nextElement();</span>
<span class="nc bnc" id="L10145" title="All 2 branches missed.">            if (mf.getType() == Minefield.TYPE_CONVENTIONAL) {</span>
<span class="nc" id="L10146">                minefield = mf;</span>
<span class="nc" id="L10147">                break;</span>
            }
<span class="nc" id="L10149">        }</span>

        // Create a new Thunder minefield
<span class="nc bnc" id="L10152" title="All 2 branches missed.">        if (minefield == null) {</span>
<span class="nc" id="L10153">            minefield = Minefield.createMinefield(coords, playerId, Minefield.TYPE_CONVENTIONAL, damage);</span>
<span class="nc" id="L10154">            game.addMinefield(minefield);</span>
<span class="nc" id="L10155">            checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
<span class="nc bnc" id="L10156" title="All 2 branches missed.">        } else if (minefield.getDensity() &lt; Minefield.MAX_DAMAGE) {</span>
            // Add to the old one
<span class="nc" id="L10158">            removeMinefield(minefield);</span>
<span class="nc" id="L10159">            int oldDamage = minefield.getDensity();</span>
<span class="nc" id="L10160">            damage += oldDamage;</span>
<span class="nc" id="L10161">            damage = Math.min(damage, Minefield.MAX_DAMAGE);</span>
<span class="nc" id="L10162">            minefield.setDensity(damage);</span>
<span class="nc" id="L10163">            game.addMinefield(minefield);</span>
<span class="nc" id="L10164">            checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
        }
<span class="nc" id="L10166">    }</span>

    /**
     * Adds a Thunder Inferno minefield to the hex.
     *
     * @param coords   the minefield's coordinates
     * @param playerId the deploying player's id
     * @param damage   the amount of damage the minefield does
     * @param entityId an entity that might spot the minefield
     */
    public void deliverThunderInfernoMinefield(Coords coords, int playerId, int damage, int entityId) {
<span class="nc" id="L10177">        Minefield minefield = null;</span>
<span class="nc" id="L10178">        Enumeration&lt;Minefield&gt; minefields = game.getMinefields(coords).elements();</span>
        // Check if there already are Thunder minefields in the hex.
<span class="nc bnc" id="L10180" title="All 2 branches missed.">        while (minefields.hasMoreElements()) {</span>
<span class="nc" id="L10181">            Minefield mf = minefields.nextElement();</span>
<span class="nc bnc" id="L10182" title="All 2 branches missed.">            if (mf.getType() == Minefield.TYPE_INFERNO) {</span>
<span class="nc" id="L10183">                minefield = mf;</span>
<span class="nc" id="L10184">                break;</span>
            }
<span class="nc" id="L10186">        }</span>

        // Create a new Thunder Inferno minefield
<span class="nc bnc" id="L10189" title="All 2 branches missed.">        if (minefield == null) {</span>
<span class="nc" id="L10190">            minefield = Minefield.createMinefield(coords, playerId, Minefield.TYPE_INFERNO, damage);</span>
<span class="nc" id="L10191">            game.addMinefield(minefield);</span>
<span class="nc" id="L10192">            checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
<span class="nc bnc" id="L10193" title="All 2 branches missed.">        } else if (minefield.getDensity() &lt; Minefield.MAX_DAMAGE) {</span>
            // Add to the old one
<span class="nc" id="L10195">            removeMinefield(minefield);</span>
<span class="nc" id="L10196">            int oldDamage = minefield.getDensity();</span>
<span class="nc" id="L10197">            damage += oldDamage;</span>
<span class="nc" id="L10198">            damage = Math.min(damage, Minefield.MAX_DAMAGE);</span>
<span class="nc" id="L10199">            minefield.setDensity(damage);</span>
<span class="nc" id="L10200">            game.addMinefield(minefield);</span>
<span class="nc" id="L10201">            checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
        }
<span class="nc" id="L10203">    }</span>

    /**
     * Delivers an artillery FASCAM shot to the targeted hex area.
     */
    public void deliverFASCAMMinefield(Coords coords, int playerId, int damage, int entityId) {
        // Only if this is on the board...
<span class="nc bnc" id="L10210" title="All 2 branches missed.">        if (game.getBoard().contains(coords)) {</span>
<span class="nc" id="L10211">            Minefield minefield = null;</span>
<span class="nc" id="L10212">            Enumeration&lt;Minefield&gt; minefields = game.getMinefields(coords).elements();</span>
            // Check if there already are Thunder minefields in the hex.
<span class="nc bnc" id="L10214" title="All 2 branches missed.">            while (minefields.hasMoreElements()) {</span>
<span class="nc" id="L10215">                Minefield mf = minefields.nextElement();</span>
<span class="nc bnc" id="L10216" title="All 2 branches missed.">                if (mf.getType() == Minefield.TYPE_CONVENTIONAL) {</span>
<span class="nc" id="L10217">                    minefield = mf;</span>
<span class="nc" id="L10218">                    break;</span>
                }
<span class="nc" id="L10220">            }</span>
            // Did we find a Thunder minefield in the hex?
<span class="nc bnc" id="L10222" title="All 2 branches missed.">            if (minefield == null) {</span>
<span class="nc" id="L10223">                minefield = Minefield.createMinefield(coords, playerId,</span>
                        Minefield.TYPE_CONVENTIONAL, damage);
<span class="nc" id="L10225">                game.addMinefield(minefield);</span>
<span class="nc" id="L10226">                checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
<span class="nc bnc" id="L10227" title="All 2 branches missed.">            } else if (minefield.getDensity() &lt; Minefield.MAX_DAMAGE) {</span>
                // Add to the old one.
<span class="nc" id="L10229">                removeMinefield(minefield);</span>
<span class="nc" id="L10230">                int oldDamage = minefield.getDensity();</span>
<span class="nc" id="L10231">                damage += oldDamage;</span>
<span class="nc" id="L10232">                damage = Math.min(damage, Minefield.MAX_DAMAGE);</span>
<span class="nc" id="L10233">                minefield.setDensity(damage);</span>
<span class="nc" id="L10234">                game.addMinefield(minefield);</span>
<span class="nc" id="L10235">                checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
            }
        } // End coords-on-board
<span class="nc" id="L10238">    }</span>

    /**
     * Adds a Thunder-Active minefield to the hex.
     * @param coords   the minefield's coordinates
     * @param playerId the deploying player's id
     * @param damage   the amount of damage the minefield does
     * @param entityId an entity that might spot the minefield
     */
    public void deliverThunderActiveMinefield(Coords coords, int playerId, int damage, int entityId) {
<span class="nc" id="L10248">        Minefield minefield = null;</span>
<span class="nc" id="L10249">        Enumeration&lt;Minefield&gt; minefields = game.getMinefields(coords).elements();</span>
        // Check if there already are Thunder minefields in the hex.
<span class="nc bnc" id="L10251" title="All 2 branches missed.">        while (minefields.hasMoreElements()) {</span>
<span class="nc" id="L10252">            Minefield mf = minefields.nextElement();</span>
<span class="nc bnc" id="L10253" title="All 2 branches missed.">            if (mf.getType() == Minefield.TYPE_ACTIVE) {</span>
<span class="nc" id="L10254">                minefield = mf;</span>
<span class="nc" id="L10255">                break;</span>
            }
<span class="nc" id="L10257">        }</span>

        // Create a new Thunder-Active minefield
<span class="nc bnc" id="L10260" title="All 2 branches missed.">        if (minefield == null) {</span>
<span class="nc" id="L10261">            minefield = Minefield.createMinefield(coords, playerId, Minefield.TYPE_ACTIVE, damage);</span>
<span class="nc" id="L10262">            game.addMinefield(minefield);</span>
<span class="nc" id="L10263">            checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
<span class="nc bnc" id="L10264" title="All 2 branches missed.">        } else if (minefield.getDensity() &lt; Minefield.MAX_DAMAGE) {</span>
            // Add to the old one
<span class="nc" id="L10266">            removeMinefield(minefield);</span>
<span class="nc" id="L10267">            int oldDamage = minefield.getDensity();</span>
<span class="nc" id="L10268">            damage += oldDamage;</span>
<span class="nc" id="L10269">            damage = Math.min(damage, Minefield.MAX_DAMAGE);</span>
<span class="nc" id="L10270">            minefield.setDensity(damage);</span>
<span class="nc" id="L10271">            game.addMinefield(minefield);</span>
<span class="nc" id="L10272">            checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
        }
<span class="nc" id="L10274">    }</span>

    /**
     * Adds a Thunder-Vibrabomb minefield to the hex.
     */
    public void deliverThunderVibraMinefield(Coords coords, int playerId,
            int damage, int sensitivity, int entityId) {
<span class="nc" id="L10281">        Minefield minefield = null;</span>
<span class="nc" id="L10282">        Enumeration&lt;Minefield&gt; minefields = game.getMinefields(coords).elements();</span>
        // Check if there already are Thunder minefields in the hex.
<span class="nc bnc" id="L10284" title="All 2 branches missed.">        while (minefields.hasMoreElements()) {</span>
<span class="nc" id="L10285">            Minefield mf = minefields.nextElement();</span>
<span class="nc bnc" id="L10286" title="All 2 branches missed.">            if (mf.getType() == Minefield.TYPE_VIBRABOMB) {</span>
<span class="nc" id="L10287">                minefield = mf;</span>
<span class="nc" id="L10288">                break;</span>
            }
<span class="nc" id="L10290">        }</span>

        // Create a new Thunder-Vibra minefield
<span class="nc bnc" id="L10293" title="All 2 branches missed.">        if (minefield == null) {</span>
<span class="nc" id="L10294">            minefield = Minefield.createMinefield(coords, playerId,</span>
                    Minefield.TYPE_VIBRABOMB, damage, sensitivity);
<span class="nc" id="L10296">            game.addMinefield(minefield);</span>
<span class="nc" id="L10297">            game.addVibrabomb(minefield);</span>
<span class="nc" id="L10298">            checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
<span class="nc bnc" id="L10299" title="All 2 branches missed.">        } else if (minefield.getDensity() &lt; Minefield.MAX_DAMAGE) {</span>
            // Add to the old one
<span class="nc" id="L10301">            removeMinefield(minefield);</span>
<span class="nc" id="L10302">            int oldDamage = minefield.getDensity();</span>
<span class="nc" id="L10303">            damage += oldDamage;</span>
<span class="nc" id="L10304">            damage = Math.min(damage, Minefield.MAX_DAMAGE);</span>
<span class="nc" id="L10305">            minefield.setDensity(damage);</span>
<span class="nc" id="L10306">            game.addMinefield(minefield);</span>
<span class="nc" id="L10307">            game.addVibrabomb(minefield);</span>
<span class="nc" id="L10308">            checkForRevealMinefield(minefield, game.getEntity(entityId));</span>
        }
<span class="nc" id="L10310">    }</span>

    /**
     * Creates an artillery flare of the given radius above the target
     */
    public void deliverArtilleryFlare(Coords coords, int radius) {
<span class="nc" id="L10316">        Flare flare = new Flare(coords, 5, radius, Flare.F_DRIFTING);</span>
<span class="nc" id="L10317">        game.addFlare(flare);</span>
<span class="nc" id="L10318">    }</span>

    public void deliverMortarFlare(Coords coords, int duration) {
<span class="nc" id="L10321">        Flare flare = new Flare(coords, duration, 1, Flare.F_IGNITED);</span>
<span class="nc" id="L10322">        game.addFlare(flare);</span>
<span class="nc" id="L10323">    }</span>

    /**
     * deliver missile smoke
     *
     * @param coords the &lt;code&gt;Coords&lt;/code&gt; where to deliver
     */

    public void deliverMissileSmoke(Coords coords, int smokeType, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L10332">        Report r = new Report(5183, Report.PUBLIC);</span>
<span class="nc" id="L10333">        r.indent(2);</span>
        //Report either light or heavy smoke, as appropriate
<span class="nc bnc" id="L10335" title="All 2 branches missed.">        r.choose(smokeType == SmokeCloud.SMOKE_LIGHT);</span>
<span class="nc" id="L10336">        r.add(coords.getBoardNum());</span>
<span class="nc" id="L10337">        vPhaseReport.add(r);</span>
<span class="nc" id="L10338">        createSmoke(coords, smokeType, 3);</span>
<span class="nc" id="L10339">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L10340">        hex.addTerrain(Terrains.getTerrainFactory().createTerrain(Terrains.SMOKE, smokeType));</span>
<span class="nc" id="L10341">        sendChangedHex(coords);</span>
<span class="nc" id="L10342">    }</span>

    public void deliverSmokeGrenade(Coords coords, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L10345">        Report r = new Report(5200, Report.PUBLIC);</span>
<span class="nc" id="L10346">        r.indent(2);</span>
<span class="nc" id="L10347">        r.add(coords.getBoardNum());</span>
<span class="nc" id="L10348">        vPhaseReport.add(r);</span>
<span class="nc" id="L10349">        createSmoke(coords, SmokeCloud.SMOKE_LIGHT, 3);</span>
<span class="nc" id="L10350">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L10351">        hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                Terrains.SMOKE, SmokeCloud.SMOKE_LIGHT));
<span class="nc" id="L10353">        sendChangedHex(coords);</span>
<span class="nc" id="L10354">    }</span>

    public void deliverSmokeMortar(Coords coords, Vector&lt;Report&gt; vPhaseReport, int duration) {
<span class="nc" id="L10357">        Report r = new Report(5185, Report.PUBLIC);</span>
<span class="nc" id="L10358">        r.indent(2);</span>
<span class="nc" id="L10359">        r.add(coords.getBoardNum());</span>
<span class="nc" id="L10360">        vPhaseReport.add(r);</span>
<span class="nc" id="L10361">        createSmoke(coords, SmokeCloud.SMOKE_HEAVY, duration);</span>
<span class="nc" id="L10362">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L10363">        hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                Terrains.SMOKE, SmokeCloud.SMOKE_HEAVY));
<span class="nc" id="L10365">        sendChangedHex(coords);</span>
<span class="nc" id="L10366">    }</span>

    public void deliverChaffGrenade(Coords coords, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L10369">        Report r = new Report(5187, Report.PUBLIC);</span>
<span class="nc" id="L10370">        r.indent(2);</span>
<span class="nc" id="L10371">        r.add(coords.getBoardNum());</span>
<span class="nc" id="L10372">        vPhaseReport.add(r);</span>
<span class="nc" id="L10373">        createSmoke(coords, SmokeCloud.SMOKE_CHAFF_LIGHT, 1);</span>
<span class="nc" id="L10374">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L10375">        hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                Terrains.SMOKE, SmokeCloud.SMOKE_CHAFF_LIGHT));
<span class="nc" id="L10377">        sendChangedHex(coords);</span>
<span class="nc" id="L10378">    }</span>

    /**
     * deliver artillery smoke
     *
     * @param coords the &lt;code&gt;Coords&lt;/code&gt; where to deliver
     */
    public void deliverArtillerySmoke(Coords coords, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L10386">        Report r = new Report(5185, Report.PUBLIC);</span>
<span class="nc" id="L10387">        r.indent(2);</span>
<span class="nc" id="L10388">        r.add(coords.getBoardNum());</span>
<span class="nc" id="L10389">        vPhaseReport.add(r);</span>
<span class="nc" id="L10390">        createSmoke(coords, SmokeCloud.SMOKE_HEAVY, 3);</span>
<span class="nc" id="L10391">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L10392">        hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                Terrains.SMOKE, SmokeCloud.SMOKE_HEAVY));
<span class="nc" id="L10394">        sendChangedHex(coords);</span>
<span class="nc bnc" id="L10395" title="All 2 branches missed.">        for (int dir = 0; dir &lt;= 5; dir++) {</span>
<span class="nc" id="L10396">            Coords tempcoords = coords.translated(dir);</span>
<span class="nc bnc" id="L10397" title="All 2 branches missed.">            if (!game.getBoard().contains(tempcoords)) {</span>
<span class="nc" id="L10398">                continue;</span>
            }
<span class="nc bnc" id="L10400" title="All 2 branches missed.">            if (coords.equals(tempcoords)) {</span>
<span class="nc" id="L10401">                continue;</span>
            }
<span class="nc" id="L10403">            r = new Report(5185, Report.PUBLIC);</span>
<span class="nc" id="L10404">            r.indent(2);</span>
<span class="nc" id="L10405">            r.add(tempcoords.getBoardNum());</span>
<span class="nc" id="L10406">            vPhaseReport.add(r);</span>
<span class="nc" id="L10407">            createSmoke(tempcoords, SmokeCloud.SMOKE_HEAVY, 3);</span>
<span class="nc" id="L10408">            hex = game.getBoard().getHex(tempcoords);</span>
<span class="nc" id="L10409">            hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                    Terrains.SMOKE, SmokeCloud.SMOKE_HEAVY));
<span class="nc" id="L10411">            sendChangedHex(tempcoords);</span>
        }
<span class="nc" id="L10413">    }</span>

    /**
     * deliver LASER inhibiting smoke
     *
     * @param coords the &lt;code&gt;Coords&lt;/code&gt; where to deliver
     */
    public void deliverLIsmoke(Coords coords, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L10421">        Report r = new Report(5186, Report.PUBLIC);</span>
<span class="nc" id="L10422">        r.indent(2);</span>
<span class="nc" id="L10423">        r.add(coords.getBoardNum());</span>
<span class="nc" id="L10424">        vPhaseReport.add(r);</span>
<span class="nc" id="L10425">        createSmoke(coords, SmokeCloud.SMOKE_LI_HEAVY, 2);</span>
<span class="nc" id="L10426">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L10427">        hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                Terrains.SMOKE, SmokeCloud.SMOKE_LI_HEAVY));
<span class="nc" id="L10429">        sendChangedHex(coords);</span>
<span class="nc bnc" id="L10430" title="All 2 branches missed.">        for (int dir = 0; dir &lt;= 5; dir++) {</span>
<span class="nc" id="L10431">            Coords tempcoords = coords.translated(dir);</span>
<span class="nc bnc" id="L10432" title="All 2 branches missed.">            if (!game.getBoard().contains(tempcoords)) {</span>
<span class="nc" id="L10433">                continue;</span>
            }
<span class="nc bnc" id="L10435" title="All 2 branches missed.">            if (coords.equals(tempcoords)) {</span>
<span class="nc" id="L10436">                continue;</span>
            }
<span class="nc" id="L10438">            r = new Report(5186, Report.PUBLIC);</span>
<span class="nc" id="L10439">            r.indent(2);</span>
<span class="nc" id="L10440">            r.add(tempcoords.getBoardNum());</span>
<span class="nc" id="L10441">            vPhaseReport.add(r);</span>
<span class="nc" id="L10442">            createSmoke(tempcoords, SmokeCloud.SMOKE_LI_HEAVY, 2);</span>
<span class="nc" id="L10443">            hex = game.getBoard().getHex(tempcoords);</span>
<span class="nc" id="L10444">            hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                    Terrains.SMOKE, SmokeCloud.SMOKE_LI_HEAVY));
<span class="nc" id="L10446">            sendChangedHex(tempcoords);</span>
        }
<span class="nc" id="L10448">    }</span>

    /**
     * deliver artillery inferno
     *
     * @param coords    the &lt;code&gt;Coords&lt;/code&gt; where to deliver
     * @param ae        the attacking &lt;code&gt;entity&lt;code&gt;
     * @param subjectId the &lt;code&gt;int&lt;/code&gt; id of the target
     */
    public void deliverArtilleryInferno(Coords coords, Entity ae,
            int subjectId, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L10459">        IHex h = game.getBoard().getHex(coords);</span>
        Report r;
        // Unless there is a fire in the hex already, start one.
<span class="nc bnc" id="L10462" title="All 2 branches missed.">        if (h.terrainLevel(Terrains.FIRE) &lt; Terrains.FIRE_LVL_INFERNO_IV) {</span>
<span class="nc" id="L10463">            ignite(coords, Terrains.FIRE_LVL_INFERNO_IV, vPhaseReport);</span>
        }
        // possibly melt ice and snow
<span class="nc bnc" id="L10466" title="All 4 branches missed.">        if (h.containsTerrain(Terrains.ICE) || h.containsTerrain(Terrains.SNOW)) {</span>
<span class="nc" id="L10467">            vPhaseReport.addAll(meltIceAndSnow(coords, subjectId));</span>
        }
<span class="nc bnc" id="L10469" title="All 2 branches missed.">        for (Entity entity : game.getEntitiesVector(coords)) {</span>
            // TacOps, p. 356 - treat as if hit by 5 inferno missiles
<span class="nc" id="L10471">            r = new Report(6695);</span>
<span class="nc" id="L10472">            r.indent(3);</span>
<span class="nc" id="L10473">            r.add(entity.getDisplayName());</span>
<span class="nc" id="L10474">            r.subject = entity.getId();</span>
<span class="nc" id="L10475">            r.newlines = 0;</span>
<span class="nc" id="L10476">            vPhaseReport.add(r);</span>
<span class="nc bnc" id="L10477" title="All 2 branches missed.">            if (entity instanceof Tank) {</span>
<span class="nc" id="L10478">                Report.addNewline(vPhaseReport);</span>
            }
<span class="nc" id="L10480">            Vector&lt;Report&gt; vDamageReport = deliverInfernoMissiles(ae, entity, 5, true);</span>
<span class="nc" id="L10481">            Report.indentAll(vDamageReport, 2);</span>
<span class="nc" id="L10482">            vPhaseReport.addAll(vDamageReport);</span>
<span class="nc" id="L10483">        }</span>
<span class="nc bnc" id="L10484" title="All 2 branches missed.">        for (int dir = 0; dir &lt;= 5; dir++) {</span>
<span class="nc" id="L10485">            Coords tempcoords = coords.translated(dir);</span>
<span class="nc bnc" id="L10486" title="All 2 branches missed.">            if (!game.getBoard().contains(tempcoords)) {</span>
<span class="nc" id="L10487">                continue;</span>
            }
<span class="nc bnc" id="L10489" title="All 2 branches missed.">            if (coords.equals(tempcoords)) {</span>
<span class="nc" id="L10490">                continue;</span>
            }
<span class="nc" id="L10492">            h = game.getBoard().getHex(tempcoords);</span>
            // Unless there is a fire in the hex already, start one.
<span class="nc bnc" id="L10494" title="All 2 branches missed.">            if (h.terrainLevel(Terrains.FIRE) &lt; Terrains.FIRE_LVL_INFERNO_IV) {</span>
<span class="nc" id="L10495">                ignite(tempcoords, Terrains.FIRE_LVL_INFERNO_IV, vPhaseReport);</span>
            }
            // possibly melt ice and snow
<span class="nc bnc" id="L10498" title="All 4 branches missed.">            if (h.containsTerrain(Terrains.ICE) || h.containsTerrain(Terrains.SNOW)) {</span>
<span class="nc" id="L10499">                vPhaseReport.addAll(meltIceAndSnow(tempcoords, subjectId));</span>
            }
<span class="nc bnc" id="L10501" title="All 2 branches missed.">            for (Entity entity : game.getEntitiesVector(tempcoords)) {</span>
<span class="nc" id="L10502">                r = new Report(6695);</span>
<span class="nc" id="L10503">                r.indent(3);</span>
<span class="nc" id="L10504">                r.add(entity.getDisplayName());</span>
<span class="nc" id="L10505">                r.newlines = 0;</span>
<span class="nc" id="L10506">                r.subject = entity.getId();</span>
<span class="nc" id="L10507">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L10508" title="All 2 branches missed.">                if (entity instanceof Tank) {</span>
<span class="nc" id="L10509">                    Report.addNewline(vPhaseReport);</span>
                }
<span class="nc" id="L10511">                Vector&lt;Report&gt; vDamageReport = deliverInfernoMissiles(ae,</span>
                        entity, 5, true);
<span class="nc" id="L10513">                Report.indentAll(vDamageReport, 2);</span>
<span class="nc" id="L10514">                vPhaseReport.addAll(vDamageReport);</span>
<span class="nc" id="L10515">            }</span>
        }
<span class="nc" id="L10517">    }</span>

    public void deliverScreen(Coords coords, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L10520">        IHex h = game.getBoard().getHex(coords);</span>
        Report r;
<span class="nc" id="L10522">        Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L10523">        r = new Report(9070, Report.PUBLIC);</span>
<span class="nc" id="L10524">        r.indent(2);</span>
<span class="nc" id="L10525">        r.add(coords.getBoardNum());</span>
<span class="nc" id="L10526">        vPhaseReport.add(r);</span>
        // use level to count the number of screens (since level does not matter
        // in space)
<span class="nc" id="L10529">        int nscreens = h.terrainLevel(Terrains.SCREEN);</span>
<span class="nc bnc" id="L10530" title="All 2 branches missed.">        if (nscreens &gt; 0) {</span>
<span class="nc" id="L10531">            h.removeTerrain(Terrains.SCREEN);</span>
<span class="nc" id="L10532">            h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                    Terrains.SCREEN, nscreens + 1));
        } else {
<span class="nc" id="L10535">            h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                    Terrains.SCREEN, 1));
        }
<span class="nc" id="L10538">        sendChangedHex(coords);</span>
<span class="nc" id="L10539">    }</span>

    /**
     * deploys a new telemissile entity onto the map
     */
    public void deployTeleMissile(Entity ae, WeaponType wtype, AmmoType atype, int wId,
            int capMisMod, int damage, int armor, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L10546">        Report r = new Report(9080);</span>
<span class="nc" id="L10547">        r.subject = ae.getId();</span>
<span class="nc" id="L10548">        r.addDesc(ae);</span>
<span class="nc" id="L10549">        r.indent(2);</span>
<span class="nc" id="L10550">        r.newlines = 0;</span>
<span class="nc" id="L10551">        r.add(wtype.getName());</span>
<span class="nc" id="L10552">        vPhaseReport.add(r);</span>
<span class="nc" id="L10553">        TeleMissile tele = new TeleMissile(ae, damage, armor,</span>
<span class="nc" id="L10554">                atype.getTonnage(ae), atype.getAmmoType(), capMisMod);</span>
<span class="nc" id="L10555">        tele.setDeployed(true);</span>
<span class="nc" id="L10556">        tele.setId(getFreeEntityId());</span>
<span class="nc bnc" id="L10557" title="All 2 branches missed.">        if (ae instanceof Aero) {</span>
<span class="nc" id="L10558">            Aero a = (Aero) ae;</span>
<span class="nc" id="L10559">            tele.setCurrentVelocity(a.getCurrentVelocity());</span>
<span class="nc" id="L10560">            tele.setNextVelocity(a.getNextVelocity());</span>
<span class="nc" id="L10561">            tele.setVectors(a.getVectors());</span>
<span class="nc" id="L10562">            tele.setFacing(a.getFacing());</span>
        }
        // set velocity and heading the same as parent entity
<span class="nc" id="L10565">        game.addEntity(tele);</span>
<span class="nc" id="L10566">        send(createAddEntityPacket(tele.getId()));</span>
        // make him not get a move this turn
<span class="nc" id="L10568">        tele.setDone(true);</span>
        // place on board
<span class="nc" id="L10570">        tele.setPosition(ae.getPosition());</span>
        // Update the entity
<span class="nc" id="L10572">        entityUpdate(tele.getId());</span>
        // check to see if the launching of this missile removes control of any
        // prior missiles
<span class="nc bnc" id="L10575" title="All 2 branches missed.">        if (ae.getTMTracker().containsLauncher(wId)) {</span>
<span class="nc" id="L10576">            Entity priorMissile = game.getEntity(ae.getTMTracker().getMissile(</span>
                    wId));
<span class="nc bnc" id="L10578" title="All 2 branches missed.">            if (priorMissile instanceof TeleMissile) {</span>
<span class="nc" id="L10579">                ((TeleMissile) priorMissile).setOutContact(true);</span>
                // remove this from the tracker for good measure
<span class="nc" id="L10581">                ae.getTMTracker().removeMissile(wId);</span>
            }
        }
        // track this missile on the entity
<span class="nc" id="L10585">        ae.getTMTracker().addMissile(wId, tele.getId());</span>
<span class="nc" id="L10586">    }</span>

    /**
     * deliver inferno missiles
     *
     * @param ae       the &lt;code&gt;Entity&lt;/code&gt; that fired the missiles
     * @param t        the &lt;code&gt;Targetable&lt;/code&gt; that is the target
     * @param missiles the &lt;code&gt;int&lt;/code&gt; amount of missiles
     */
    public Vector&lt;Report&gt; deliverInfernoMissiles(Entity ae, Targetable t, int missiles) {
<span class="nc" id="L10596">        return deliverInfernoMissiles(ae, t, missiles, CalledShot.CALLED_NONE);</span>
    }

    /**
     * deliver inferno missiles
     *
     * @param ae       the &lt;code&gt;Entity&lt;/code&gt; that fired the missiles
     * @param t        the &lt;code&gt;Targetable&lt;/code&gt; that is the target
     * @param missiles the &lt;code&gt;int&lt;/code&gt; amount of missiles
     * @param areaEffect a &lt;code&gt;boolean&lt;/code&gt; indicating whether the attack is from an
     *                   area effect weapon such as Arrow IV inferno, and partial cover should
     *                   be ignored.
     */
    public Vector&lt;Report&gt; deliverInfernoMissiles(Entity ae, Targetable t, int missiles,
                                                 boolean areaEffect) {
<span class="nc" id="L10611">        return deliverInfernoMissiles(ae, t, missiles, CalledShot.CALLED_NONE, areaEffect);</span>
    }

    /**
     * deliver inferno missiles
     *
     * @param ae       the &lt;code&gt;Entity&lt;/code&gt; that fired the missiles
     * @param t        the &lt;code&gt;Targetable&lt;/code&gt; that is the target
     * @param missiles the &lt;code&gt;int&lt;/code&gt; amount of missiles
     * @param called   an &lt;code&gt;int&lt;/code&gt; indicated the aiming mode used to fire the
     *                 inferno missiles (for called shots)
     */
    public Vector&lt;Report&gt; deliverInfernoMissiles(Entity ae, Targetable t,
            int missiles, int called) {
<span class="nc" id="L10625">        return deliverInfernoMissiles(ae, t, missiles, called, false);</span>
    }

    /**
     * deliver inferno missiles
     *
     * @param ae         the &lt;code&gt;Entity&lt;/code&gt; that fired the missiles
     * @param t          the &lt;code&gt;Targetable&lt;/code&gt; that is the target
     * @param missiles   the &lt;code&gt;int&lt;/code&gt; amount of missiles
     * @param called     an &lt;code&gt;int&lt;/code&gt; indicated the aiming mode used to fire the
     *                   inferno missiles (for called shots)
     * @param areaEffect a &lt;code&gt;boolean&lt;/code&gt; indicating whether the attack is from an
     *                   area effect weapon such as Arrow IV inferno, and partial cover should
     *                   be ignored.
     */
    public Vector&lt;Report&gt; deliverInfernoMissiles(Entity ae, Targetable t,
                int missiles, int called, boolean areaEffect) {
<span class="nc" id="L10642">        IHex hex = game.getBoard().getHex(t.getPosition());</span>
        Report r;
<span class="nc" id="L10644">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L10645">        int attId = Entity.NONE;</span>
<span class="nc bnc" id="L10646" title="All 2 branches missed.">        if (null != ae) {</span>
<span class="nc" id="L10647">            attId = ae.getId();</span>
        }
<span class="nc bnc" id="L10649" title="All 5 branches missed.">        switch (t.getTargetType()) {</span>
            case Targetable.TYPE_HEX_ARTILLERY:
                // used for BA inferno explosion
<span class="nc bnc" id="L10652" title="All 2 branches missed.">                for (Entity e : game.getEntitiesVector(t.getPosition())) {</span>
<span class="nc bnc" id="L10653" title="All 2 branches missed.">                    if (e.getElevation() &gt; hex.terrainLevel(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L10654">                        r = new Report(6685);</span>
<span class="nc" id="L10655">                        r.subject = e.getId();</span>
<span class="nc" id="L10656">                        r.addDesc(e);</span>
<span class="nc" id="L10657">                        vPhaseReport.add(r);</span>
<span class="nc" id="L10658">                        vPhaseReport.addAll(deliverInfernoMissiles(ae, e, missiles, called));</span>
                    } else {
<span class="nc" id="L10660">                        int roll = Compute.d6();</span>
<span class="nc" id="L10661">                        r = new Report(3570);</span>
<span class="nc" id="L10662">                        r.subject = e.getId();</span>
<span class="nc" id="L10663">                        r.addDesc(e);</span>
<span class="nc" id="L10664">                        r.add(roll);</span>
<span class="nc" id="L10665">                        vPhaseReport.add(r);</span>
<span class="nc bnc" id="L10666" title="All 2 branches missed.">                        if (roll &gt;= 5) {</span>
<span class="nc" id="L10667">                            vPhaseReport.addAll(deliverInfernoMissiles(ae, e, missiles, called));</span>
                        }
                    }
<span class="nc" id="L10670">                }</span>
<span class="nc bnc" id="L10671" title="All 2 branches missed.">                if (game.getBoard().getBuildingAt(t.getPosition()) != null) {</span>
<span class="nc" id="L10672">                    Vector&lt;Report&gt; vBuildingReport = damageBuilding(game.getBoard().getBuildingAt(t.getPosition()),</span>
<span class="nc" id="L10673">                            2 * missiles, t.getPosition());</span>
<span class="nc bnc" id="L10674" title="All 2 branches missed.">                    for (Report report : vBuildingReport) {</span>
<span class="nc" id="L10675">                        report.subject = attId;</span>
<span class="nc" id="L10676">                    }</span>
<span class="nc" id="L10677">                    vPhaseReport.addAll(vBuildingReport);</span>
                }
                // fall through
            case Targetable.TYPE_HEX_CLEAR:
            case Targetable.TYPE_HEX_IGNITE:
                // Report that damage applied to terrain, if there's TF to damage
<span class="nc" id="L10683">                IHex h = game.getBoard().getHex(t.getPosition());</span>
<span class="nc bnc" id="L10684" title="All 4 branches missed.">                if ((h != null) &amp;&amp; h.hasTerrainfactor()) {</span>
<span class="nc" id="L10685">                    r = new Report(3384);</span>
<span class="nc" id="L10686">                    r.indent(2);</span>
<span class="nc" id="L10687">                    r.subject = attId;</span>
<span class="nc" id="L10688">                    r.add(t.getPosition().getBoardNum());</span>
<span class="nc" id="L10689">                    r.add(missiles * 4);</span>
<span class="nc" id="L10690">                    vPhaseReport.addElement(r);</span>
                }
<span class="nc" id="L10692">                vPhaseReport.addAll(tryClearHex(t.getPosition(), missiles * 4, attId));</span>
<span class="nc" id="L10693">                tryIgniteHex(t.getPosition(), attId, false, true,</span>
                             new TargetRoll(0, &quot;inferno&quot;), -1, vPhaseReport);
<span class="nc" id="L10695">                break;</span>
            case Targetable.TYPE_BLDG_IGNITE:
            case Targetable.TYPE_BUILDING:
<span class="nc" id="L10698">                Vector&lt;Report&gt; vBuildingReport = damageBuilding(game.getBoard().getBuildingAt(t.getPosition()),</span>
<span class="nc" id="L10699">                        2 * missiles, t.getPosition());</span>
<span class="nc bnc" id="L10700" title="All 2 branches missed.">                for (Report report : vBuildingReport) {</span>
<span class="nc" id="L10701">                    report.subject = attId;</span>
<span class="nc" id="L10702">                }</span>
<span class="nc" id="L10703">                vPhaseReport.addAll(vBuildingReport);</span>

                // For each missile, check to see if it hits a unit in this hex
<span class="nc bnc" id="L10706" title="All 2 branches missed.">                for (Entity e : game.getEntitiesVector(t.getPosition())) {</span>
<span class="nc bnc" id="L10707" title="All 2 branches missed.">                    if (e.getElevation() &gt; hex.terrainLevel(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L10708">                        continue;</span>
                    }
<span class="nc bnc" id="L10710" title="All 2 branches missed.">                    for (int m = 0; m &lt; missiles; m++) {</span>
<span class="nc" id="L10711">                        int roll = Compute.d6();</span>
<span class="nc" id="L10712">                        r = new Report(3570);</span>
<span class="nc" id="L10713">                        r.subject = e.getId();</span>
<span class="nc" id="L10714">                        r.indent(3);</span>
<span class="nc" id="L10715">                        r.addDesc(e);</span>
<span class="nc" id="L10716">                        r.add(roll);</span>
<span class="nc" id="L10717">                        vPhaseReport.add(r);</span>
<span class="nc bnc" id="L10718" title="All 2 branches missed.">                        if (roll &gt;= 5) {</span>
<span class="nc" id="L10719">                            Vector&lt;Report&gt; dmgReports = deliverInfernoMissiles(ae, e, 1, called);</span>
<span class="nc bnc" id="L10720" title="All 2 branches missed.">                            for (Report rep : dmgReports) {</span>
<span class="nc" id="L10721">                                rep.indent(4);</span>
<span class="nc" id="L10722">                            }</span>
<span class="nc" id="L10723">                            vPhaseReport.addAll(dmgReports);</span>
                        }
                    }
<span class="nc" id="L10726">                }</span>

<span class="nc" id="L10728">                break;</span>
            case Targetable.TYPE_ENTITY:
<span class="nc" id="L10730">                Entity te = (Entity) t;</span>
<span class="nc bnc" id="L10731" title="All 4 branches missed.">                if ((te instanceof Mech) &amp;&amp; (!areaEffect)) {</span>
                    // Bug #1585497: Check for partial cover
<span class="nc" id="L10733">                    int m = missiles;</span>
<span class="nc" id="L10734">                    LosEffects le = LosEffects.calculateLos(game, attId, t);</span>
<span class="nc" id="L10735">                    int cover = le.getTargetCover();</span>
<span class="nc" id="L10736">                    Vector&lt;Report&gt; coverDamageReports = new Vector&lt;&gt;();</span>
<span class="nc" id="L10737">                    int heatDamage = 0;</span>
<span class="nc" id="L10738">                    boolean heatReduced = false;</span>
<span class="nc" id="L10739">                    String reductionCause = &quot;&quot;;</span>
<span class="nc bnc" id="L10740" title="All 2 branches missed.">                    for (int i = 0; i &lt; m; i++) {</span>
<span class="nc" id="L10741">                        int side = Compute.targetSideTable(ae, t, called);</span>
<span class="nc" id="L10742">                        HitData hit = te.rollHitLocation(ToHitData.HIT_NORMAL, side);</span>
<span class="nc bnc" id="L10743" title="All 2 branches missed.">                        if (te.removePartialCoverHits(hit.getLocation(), cover, side)) {</span>
<span class="nc" id="L10744">                            missiles--;</span>
                            // Determine if damageable cover is hit
                            int damageableCoverType;
                            Entity coverDropship;
                            Coords coverLoc;

                            // Determine if there is primary and secondary
                            // cover,
                            // and then determine which one gets hit
<span class="nc bnc" id="L10753" title="All 6 branches missed.">                            if (((cover == LosEffects.COVER_75RIGHT) || (cover == LosEffects.COVER_75LEFT))</span>
                                    // 75% cover has a primary and secondary
                                    || ((cover == LosEffects.COVER_HORIZONTAL)
<span class="nc bnc" id="L10756" title="All 2 branches missed.">                                    &amp;&amp; (le.getDamagableCoverTypeSecondary() != LosEffects.DAMAGABLE_COVER_NONE))) {</span>
                                // Horizontal cover provided by two 25%'s,
                                // so primary and secondary
<span class="nc" id="L10759">                                int hitLoc = hit.getLocation();</span>
                                // Primary stores the left side, from the
                                // perspective of the attacker
<span class="nc bnc" id="L10762" title="All 6 branches missed.">                                if ((hitLoc == Mech.LOC_RLEG) || (hitLoc == Mech.LOC_RT)</span>
                                        || (hitLoc == Mech.LOC_RARM)) {
                                    // Left side is primary
<span class="nc" id="L10765">                                    damageableCoverType = le.getDamagableCoverTypePrimary();</span>
<span class="nc" id="L10766">                                    coverDropship = le.getCoverDropshipPrimary();</span>
<span class="nc" id="L10767">                                    coverLoc = le.getCoverLocPrimary();</span>
                                } else {
                                    // If not left side, then right side,
                                    // which is secondary
<span class="nc" id="L10771">                                    damageableCoverType = le.getDamagableCoverTypeSecondary();</span>
<span class="nc" id="L10772">                                    coverDropship = le.getCoverDropshipSecondary();</span>
<span class="nc" id="L10773">                                    coverLoc = le.getCoverLocSecondary();</span>
                                }
<span class="nc" id="L10775">                            } else { // Only primary cover exists</span>
<span class="nc" id="L10776">                                damageableCoverType = le.getDamagableCoverTypePrimary();</span>
<span class="nc" id="L10777">                                coverDropship = le.getCoverDropshipPrimary();</span>
<span class="nc" id="L10778">                                coverLoc = le.getCoverLocPrimary();</span>
                            }

                            // Check if we need to damage the cover that
                            // absorbed
                            // the hit.
<span class="nc" id="L10784">                            Vector&lt;Report&gt; coverDamageReport = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L10785" title="All 2 branches missed.">                            if (damageableCoverType == LosEffects.DAMAGABLE_COVER_DROPSHIP) {</span>
<span class="nc" id="L10786">                                r = new Report(3465);</span>
<span class="nc" id="L10787">                                r.addDesc(coverDropship);</span>
<span class="nc" id="L10788">                                r.indent(1);</span>
<span class="nc" id="L10789">                                coverDamageReport = deliverInfernoMissiles(ae,</span>
                                        coverDropship, 1, CalledShot.CALLED_NONE);
<span class="nc" id="L10791">                                coverDamageReport.insertElementAt(r, 0);</span>
<span class="nc bnc" id="L10792" title="All 2 branches missed.">                                for (Report report : coverDamageReport) {</span>
<span class="nc" id="L10793">                                    report.indent(1);</span>
<span class="nc" id="L10794">                                }</span>
<span class="nc bnc" id="L10795" title="All 2 branches missed.">                            } else if (damageableCoverType == LosEffects.DAMAGABLE_COVER_BUILDING) {</span>
<span class="nc" id="L10796">                                BuildingTarget bldgTrgt = new BuildingTarget(coverLoc,</span>
<span class="nc" id="L10797">                                        game.getBoard(), false);</span>
<span class="nc" id="L10798">                                coverDamageReport = deliverInfernoMissiles(ae, bldgTrgt, 1,</span>
                                        CalledShot.CALLED_NONE);
                            }
<span class="nc bnc" id="L10801" title="All 2 branches missed.">                            for (Report report : coverDamageReport) {</span>
<span class="nc" id="L10802">                                report.indent(1);</span>
<span class="nc" id="L10803">                            }</span>
<span class="nc" id="L10804">                            coverDamageReports.addAll(coverDamageReport);</span>
<span class="nc" id="L10805">                        } else { // No partial cover, missile hits</span>
<span class="nc bnc" id="L10806" title="All 2 branches missed.">                            if ((te.getArmor(hit) &gt; 0)</span>
<span class="nc bnc" id="L10807" title="All 2 branches missed.">                                &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_HEAT_DISSIPATING)) {</span>
<span class="nc" id="L10808">                                heatDamage += 1;</span>
<span class="nc" id="L10809">                                heatReduced = true;</span>
<span class="nc" id="L10810">                                reductionCause = EquipmentType.armorNames[te</span>
<span class="nc" id="L10811">                                        .getArmorType(hit.getLocation())];</span>
                            } else {
<span class="nc" id="L10813">                                heatDamage += 2;</span>
                            }
                        }
                    }
<span class="nc bnc" id="L10817" title="All 2 branches missed.">                    if (heatReduced) {</span>
<span class="nc" id="L10818">                        r = new Report(3406);</span>
<span class="nc" id="L10819">                        r.add(heatDamage);</span>
<span class="nc" id="L10820">                        r.subject = te.getId();</span>
<span class="nc" id="L10821">                        r.indent(2);</span>
<span class="nc" id="L10822">                        r.choose(true);</span>
<span class="nc" id="L10823">                        r.add(missiles * 2);</span>
<span class="nc" id="L10824">                        r.add(reductionCause);</span>
                    } else {
<span class="nc" id="L10826">                        r = new Report(3400);</span>
<span class="nc" id="L10827">                        r.add(heatDamage);</span>
<span class="nc" id="L10828">                        r.subject = te.getId();</span>
<span class="nc" id="L10829">                        r.indent(2);</span>
<span class="nc" id="L10830">                        r.choose(true);</span>
                    }
<span class="nc" id="L10832">                    vPhaseReport.add(r);</span>
<span class="nc" id="L10833">                    Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L10834">                    te.heatFromExternal += heatDamage;</span>

<span class="nc bnc" id="L10836" title="All 2 branches missed.">                    if (missiles != m) {</span>
<span class="nc" id="L10837">                        r = new Report(3403);</span>
<span class="nc" id="L10838">                        r.add(m - missiles);</span>
<span class="nc" id="L10839">                        r.indent(2);</span>
<span class="nc" id="L10840">                        r.subject = te.getId();</span>
<span class="nc" id="L10841">                        vPhaseReport.add(r);</span>
                    }
<span class="nc" id="L10843">                    vPhaseReport.addAll(coverDamageReports);</span>
<span class="nc" id="L10844">                    Report.addNewline(vPhaseReport);</span>
<span class="nc bnc" id="L10845" title="All 2 branches missed.">                } else if (te.tracksHeat()) {</span>
                    // ASFs and small craft
<span class="nc" id="L10847">                    r = new Report(3400);</span>
<span class="nc" id="L10848">                    r.add(2 * missiles);</span>
<span class="nc" id="L10849">                    r.subject = te.getId();</span>
<span class="nc" id="L10850">                    r.indent(2);</span>
<span class="nc" id="L10851">                    r.choose(true);</span>
<span class="nc" id="L10852">                    vPhaseReport.add(r);</span>
<span class="nc" id="L10853">                    te.heatFromExternal += 2 * missiles;</span>
<span class="nc" id="L10854">                    Report.addNewline(vPhaseReport);</span>
<span class="nc bnc" id="L10855" title="All 2 branches missed.">                } else if (te instanceof GunEmplacement){</span>
<span class="nc" id="L10856">                    int direction = Compute.targetSideTable(ae, te, called);</span>
<span class="nc bnc" id="L10857" title="All 2 branches missed.">                    while (missiles-- &gt; 0) {</span>
<span class="nc" id="L10858">                        HitData hit = te.rollHitLocation(ToHitData.HIT_NORMAL, direction);</span>
<span class="nc" id="L10859">                        vPhaseReport.addAll(damageEntity(te, hit, 2));</span>
<span class="nc" id="L10860">                    }</span>
<span class="nc bnc" id="L10861" title="All 4 branches missed.">                } else if ((te instanceof Tank) || te.isSupportVehicle()) {</span>
<span class="nc" id="L10862">                    int direction = Compute.targetSideTable(ae, te, called);</span>
<span class="nc bnc" id="L10863" title="All 2 branches missed.">                    while (missiles-- &gt; 0) {</span>
<span class="nc" id="L10864">                        HitData hit = te.rollHitLocation(ToHitData.HIT_NORMAL, direction);</span>
<span class="nc" id="L10865">                        int critRollMod = 0;</span>
<span class="nc bnc" id="L10866" title="All 4 branches missed.">                        if (!te.isSupportVehicle() || (te.hasArmoredChassis()</span>
<span class="nc bnc" id="L10867" title="All 2 branches missed.">                                &amp;&amp; (te.getBARRating(hit.getLocation()) &gt; 9))) {</span>
<span class="nc" id="L10868">                            critRollMod -= 2;</span>
                        }
<span class="nc bnc" id="L10870" title="All 2 branches missed.">                        if ((te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_HARDENED)</span>
<span class="nc bnc" id="L10871" title="All 2 branches missed.">                                &amp;&amp; (te.getArmor(hit.getLocation()) &gt; 0)) {</span>
<span class="nc" id="L10872">                            critRollMod -= 2;</span>
                        }
<span class="nc" id="L10874">                        vPhaseReport.addAll(criticalEntity(te, hit.getLocation(), hit.isRear(),</span>
                                critRollMod, 0, true));
<span class="nc" id="L10876">                    }</span>
<span class="nc bnc" id="L10877" title="All 2 branches missed.">                } else if (te instanceof ConvFighter) {</span>
                    // CFs take a point SI damage for every three missiles that hit.
                    // Use the heatFromExternal field to carry the remainder in case of multiple inferno hits.
<span class="nc" id="L10880">                    te.heatFromExternal += missiles;</span>
<span class="nc bnc" id="L10881" title="All 2 branches missed.">                    if (te.heatFromExternal &gt;= 3) {</span>
<span class="nc" id="L10882">                        int siDamage = te.heatFromExternal / 3;</span>
<span class="nc" id="L10883">                        te.heatFromExternal %= 3;</span>
<span class="nc" id="L10884">                        final ConvFighter ftr = (ConvFighter) te;</span>
<span class="nc" id="L10885">                        int remaining = Math.max(0,  ftr.getSI() - siDamage);</span>
<span class="nc" id="L10886">                        r = new Report(9146);</span>
<span class="nc" id="L10887">                        r.subject = te.getId();</span>
<span class="nc" id="L10888">                        r.indent(2);</span>
<span class="nc" id="L10889">                        r.add(siDamage);</span>
<span class="nc" id="L10890">                        r.add(remaining);</span>
<span class="nc" id="L10891">                        vPhaseReport.add(r);</span>
<span class="nc" id="L10892">                        ftr.setSI(remaining);</span>
<span class="nc" id="L10893">                        te.damageThisPhase += siDamage;</span>
<span class="nc bnc" id="L10894" title="All 2 branches missed.">                        if (remaining &lt;= 0) {</span>
                            // Lets auto-eject if we can!
<span class="nc bnc" id="L10896" title="All 2 branches missed.">                            if (ftr.isAutoEject()</span>
<span class="nc bnc" id="L10897" title="All 2 branches missed.">                                    &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION)</span>
<span class="nc bnc" id="L10898" title="All 2 branches missed.">                                        || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L10899" title="All 2 branches missed.">                                                &amp;&amp; ftr.isCondEjectSIDest()))) {</span>
<span class="nc" id="L10900">                                vPhaseReport.addAll(ejectEntity(te, true, false));</span>
                            }
<span class="nc" id="L10902">                            vPhaseReport.addAll(destroyEntity(te,&quot;Structural Integrity Collapse&quot;));</span>
<span class="nc" id="L10903">                            ftr.setSI(0);</span>
<span class="nc bnc" id="L10904" title="All 2 branches missed.">                            if (null != ae) {</span>
<span class="nc" id="L10905">                                creditKill(te, ae);</span>
                            }
                        }
<span class="nc" id="L10908">                    }</span>
<span class="nc bnc" id="L10909" title="All 2 branches missed.">                } else if (te.isLargeCraft()) {</span>
                    // Large craft ignore infernos
<span class="nc" id="L10911">                    r = new Report(1242);</span>
<span class="nc" id="L10912">                    r.subject = te.getId();</span>
<span class="nc" id="L10913">                    r.indent(2);</span>
<span class="nc" id="L10914">                    vPhaseReport.add(r);</span>
<span class="nc bnc" id="L10915" title="All 2 branches missed.">                } else if (te instanceof Protomech) {</span>
<span class="nc" id="L10916">                    te.heatFromExternal += missiles;</span>
<span class="nc bnc" id="L10917" title="All 2 branches missed.">                    while (te.heatFromExternal &gt;= 3) {</span>
<span class="nc" id="L10918">                        te.heatFromExternal -= 3;</span>
<span class="nc" id="L10919">                        HitData hit = te.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc bnc" id="L10920" title="All 2 branches missed.">                        if (hit.getLocation() == Protomech.LOC_NMISS) {</span>
<span class="nc" id="L10921">                            Protomech proto = (Protomech) te;</span>
<span class="nc" id="L10922">                            r = new Report(6035);</span>
<span class="nc" id="L10923">                            r.subject = te.getId();</span>
<span class="nc" id="L10924">                            r.indent(2);</span>
<span class="nc bnc" id="L10925" title="All 2 branches missed.">                            if (proto.isGlider()) {</span>
<span class="nc" id="L10926">                                r.messageId = 6036;</span>
<span class="nc" id="L10927">                                proto.setWingHits(proto.getWingHits() + 1);</span>
                            }
<span class="nc" id="L10929">                            vPhaseReport.add(r);</span>
<span class="nc" id="L10930">                        } else {</span>
<span class="nc" id="L10931">                            r = new Report(6690);</span>
<span class="nc" id="L10932">                            r.subject = te.getId();</span>
<span class="nc" id="L10933">                            r.indent(2);</span>
<span class="nc" id="L10934">                            r.add(te.getLocationName(hit));</span>
<span class="nc" id="L10935">                            vPhaseReport.add(r);</span>
<span class="nc" id="L10936">                            te.destroyLocation(hit.getLocation());</span>
                            // Handle ProtoMech pilot damage
                            // due to location destruction
<span class="nc" id="L10939">                            int hits = Protomech.POSSIBLE_PILOT_DAMAGE[hit.getLocation()]</span>
<span class="nc" id="L10940">                                       - ((Protomech) te).getPilotDamageTaken(hit.getLocation());</span>
<span class="nc bnc" id="L10941" title="All 2 branches missed.">                            if (hits &gt; 0) {</span>
<span class="nc" id="L10942">                                vPhaseReport.addAll(damageCrew(te, hits));</span>
<span class="nc" id="L10943">                                ((Protomech) te).setPilotDamageTaken(hit.getLocation(),</span>
<span class="nc" id="L10944">                                        Protomech.POSSIBLE_PILOT_DAMAGE[hit.getLocation()]);</span>
                            }
<span class="nc bnc" id="L10946" title="All 2 branches missed.">                            if (te.getTransferLocation(hit).getLocation() == Entity.LOC_DESTROYED) {</span>
<span class="nc" id="L10947">                                vPhaseReport.addAll(destroyEntity(te,</span>
                                        &quot;flaming inferno death&quot;, false, true));
<span class="nc" id="L10949">                                Report.addNewline(vPhaseReport);</span>
                            }
                        }
<span class="nc" id="L10952">                    }</span>
<span class="nc bnc" id="L10953" title="All 2 branches missed.">                } else if (te instanceof BattleArmor) {</span>
<span class="nc bnc" id="L10954" title="All 2 branches missed.">                    if (((BattleArmor) te).isFireResistant()) {</span>
<span class="nc" id="L10955">                        r = new Report(3395);</span>
<span class="nc" id="L10956">                        r.indent(2);</span>
<span class="nc" id="L10957">                        r.subject = te.getId();</span>
<span class="nc" id="L10958">                        r.addDesc(te);</span>
<span class="nc" id="L10959">                        vPhaseReport.add(r);</span>
<span class="nc" id="L10960">                        return vPhaseReport;</span>
                    }
<span class="nc" id="L10962">                    te.heatFromExternal += missiles;</span>
<span class="nc bnc" id="L10963" title="All 2 branches missed.">                    while (te.heatFromExternal &gt;= 3) {</span>
<span class="nc" id="L10964">                        te.heatFromExternal -= 3;</span>
<span class="nc" id="L10965">                        HitData hit = te.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L10966">                        hit.setEffect(HitData.EFFECT_CRITICAL);</span>
<span class="nc" id="L10967">                        vPhaseReport.addAll(damageEntity(te, hit, 1));</span>
<span class="nc" id="L10968">                        Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L10969">                    }</span>
<span class="nc bnc" id="L10970" title="All 2 branches missed.">                } else if (te instanceof Infantry) {</span>
<span class="nc" id="L10971">                    HitData hit = new HitData(Infantry.LOC_INFANTRY);</span>
<span class="nc bnc" id="L10972" title="All 2 branches missed.">                    if (te.getInternal(hit) &gt; (3 * missiles)) {</span>
                        // internal structure absorbs all damage
<span class="nc" id="L10974">                        te.setInternal(te.getInternal(hit) - (3 * missiles), hit);</span>
<span class="nc" id="L10975">                        r = new Report(6065);</span>
<span class="nc" id="L10976">                        r.addDesc(te);</span>
<span class="nc" id="L10977">                        r.add(3 * missiles);</span>
<span class="nc" id="L10978">                        r.indent(2);</span>
<span class="nc" id="L10979">                        r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L10980">                        r.newlines = 0;</span>
<span class="nc" id="L10981">                        r.subject = te.getId();</span>
<span class="nc" id="L10982">                        vPhaseReport.add(r);</span>
<span class="nc" id="L10983">                        Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L10984">                        r = new Report(6095);</span>
<span class="nc" id="L10985">                        r.add(te.getInternal(hit));</span>
<span class="nc" id="L10986">                        r.subject = te.getId();</span>
<span class="nc" id="L10987">                        r.indent(3);</span>
<span class="nc" id="L10988">                        vPhaseReport.add(r);</span>
                    } else {
<span class="nc" id="L10990">                        vPhaseReport.addAll(destroyEntity(te, &quot;damage&quot;, false));</span>
<span class="nc" id="L10991">                        creditKill(te, ae);</span>
<span class="nc" id="L10992">                        Report.addNewline(vPhaseReport);</span>
                    }
                }
        }
<span class="nc" id="L10996">        return vPhaseReport;</span>
    }

    /**
     * Check for any detonations when an entity enters a minefield, except a
     * vibrabomb.
     *
     * @param entity
     *            - the &lt;code&gt;entity&lt;/code&gt; who entered the minefield
     * @param c
     *            - the &lt;code&gt;Coords&lt;/code&gt; of the minefield
     * @param curElev
     *            - an &lt;code&gt;int&lt;/code&gt; for the elevation of the entity entering
     *            the minefield (used for underwater sea mines)
     * @param isOnGround
     *            - &lt;code&gt;true&lt;/code&gt; if the entity is not in the middle of a
     *            jump
     * @param vMineReport
     *            - the report vector that reports will be added to
     * @return - &lt;code&gt;true&lt;/code&gt; if the entity set off any mines
     */
    private boolean enterMinefield(Entity entity, Coords c, int curElev, boolean isOnGround,
                                   Vector&lt;Report&gt; vMineReport) {
<span class="nc" id="L11019">        return enterMinefield(entity, c, curElev, isOnGround, vMineReport, -1);</span>
    }

    /**
     * Check for any detonations when an entity enters a minefield, except a
     * vibrabomb.
     *
     * @param entity
     *            - the &lt;code&gt;entity&lt;/code&gt; who entered the minefield
     * @param c
     *            - the &lt;code&gt;Coords&lt;/code&gt; of the minefield
     * @param curElev
     *            - an &lt;code&gt;int&lt;/code&gt; for the elevation of the entity entering
     *            the minefield (used for underwater sea mines)
     * @param isOnGround
     *            - &lt;code&gt;true&lt;/code&gt; if the entity is not in the middle of a
     *            jump
     * @param vMineReport
     *            - the report vector that reports will be added to
     * @param target
     *            - the &lt;code&gt;int&lt;/code&gt; target number for detonation. If this
     *            will be determined by density, it should be -1
     * @return - &lt;code&gt;true&lt;/code&gt; if the entity set off any mines
     */
    private boolean enterMinefield(Entity entity, Coords c, int curElev, boolean isOnGround,
                                   Vector&lt;Report&gt; vMineReport, int target) {
        Report r;
<span class="nc" id="L11046">        boolean trippedMine = false;</span>
        // flying units cannot trip a mine
<span class="nc bnc" id="L11048" title="All 2 branches missed.">        if (curElev &gt; 0) {</span>
<span class="nc" id="L11049">            return false;</span>
        }

        // Check for Mine sweepers
<span class="nc" id="L11053">        Mounted minesweeper = null;</span>
<span class="nc bnc" id="L11054" title="All 2 branches missed.">        for (Mounted m : entity.getMisc()) {</span>
<span class="nc bnc" id="L11055" title="All 4 branches missed.">            if (m.getType().hasFlag(MiscType.F_MINESWEEPER) &amp;&amp; m.isReady()</span>
<span class="nc bnc" id="L11056" title="All 2 branches missed.">                    &amp;&amp; (m.getArmorValue() &gt; 0)) {</span>
<span class="nc" id="L11057">                minesweeper = m;</span>
<span class="nc" id="L11058">                break; // Can only have one minesweeper</span>
            }
<span class="nc" id="L11060">        }</span>

<span class="nc" id="L11062">        Vector&lt;Minefield&gt; fieldsToRemove = new Vector&lt;&gt;();</span>
        // loop through mines in this hex
<span class="nc bnc" id="L11064" title="All 2 branches missed.">        for (Minefield mf : game.getMinefields(c)) {</span>

            // vibrabombs are handled differently
<span class="nc bnc" id="L11067" title="All 2 branches missed.">            if (mf.getType() == Minefield.TYPE_VIBRABOMB) {</span>
<span class="nc" id="L11068">                continue;</span>
            }

            // if we are in the water, then the sea mine will only blow up if at
            // the right depth
<span class="nc" id="L11073">            if (game.getBoard().getHex(mf.getCoords())</span>
<span class="nc bnc" id="L11074" title="All 2 branches missed.">                    .containsTerrain(Terrains.WATER)) {</span>
<span class="nc bnc" id="L11075" title="All 2 branches missed.">                if ((Math.abs(curElev) != mf.getDepth())</span>
<span class="nc" id="L11076">                    &amp;&amp; (Math.abs(curElev + entity.getHeight()) != mf</span>
<span class="nc bnc" id="L11077" title="All 2 branches missed.">                        .getDepth())) {</span>
<span class="nc" id="L11078">                    continue;</span>
                }
            }

            // Check for mine-sweeping.  Vibramines handled elsewhere
<span class="nc bnc" id="L11083" title="All 2 branches missed.">            if ((minesweeper != null)</span>
<span class="nc bnc" id="L11084" title="All 2 branches missed.">                    &amp;&amp; ((mf.getType() == Minefield.TYPE_CONVENTIONAL)</span>
<span class="nc bnc" id="L11085" title="All 2 branches missed.">                            || (mf.getType() == Minefield.TYPE_ACTIVE)</span>
<span class="nc bnc" id="L11086" title="All 2 branches missed.">                            || (mf.getType() == Minefield.TYPE_INFERNO))) {</span>
                // Check to see if the minesweeper clears
<span class="nc" id="L11088">                int roll = Compute.d6(2);</span>

                // Report minefield roll
<span class="nc bnc" id="L11091" title="All 2 branches missed.">                if (doBlind()) { // only report if DB, otherwise all players see</span>
<span class="nc" id="L11092">                r = new Report(2152);</span>
<span class="nc" id="L11093">                r.player = mf.getPlayerId();</span>
<span class="nc" id="L11094">                r.add(Minefield.getDisplayableName(mf.getType()));</span>
<span class="nc" id="L11095">                r.add(mf.getCoords().getBoardNum());</span>
<span class="nc" id="L11096">                r.add(roll);</span>
<span class="nc" id="L11097">                r.newlines = 0;</span>
<span class="nc" id="L11098">                vMineReport.add(r);</span>
                }

<span class="nc bnc" id="L11101" title="All 2 branches missed.">                if (roll &gt;= 6) {</span>
                    // Report hit
<span class="nc bnc" id="L11103" title="All 2 branches missed.">                    if (doBlind()) {</span>
<span class="nc" id="L11104">                        r = new Report(5543);</span>
<span class="nc" id="L11105">                        r.player = mf.getPlayerId();</span>
<span class="nc" id="L11106">                        vMineReport.add(r);</span>
                    }

                    // Clear the minefield
<span class="nc" id="L11110">                    r = new Report(2158);</span>
<span class="nc" id="L11111">                    r.subject = entity.getId();</span>
<span class="nc" id="L11112">                    r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11113">                    r.add(Minefield.getDisplayableName(mf.getType()), true);</span>
<span class="nc" id="L11114">                    r.add(mf.getCoords().getBoardNum(), true);</span>
<span class="nc" id="L11115">                    r.indent();</span>
<span class="nc" id="L11116">                    vMineReport.add(r);</span>
<span class="nc" id="L11117">                    fieldsToRemove.add(mf);</span>

                    // Handle armor value damage
<span class="nc" id="L11120">                    int remainingAV = minesweeper.getArmorValue() - 6;</span>
<span class="nc" id="L11121">                    minesweeper.setArmorValue(Math.max(remainingAV, 0));</span>

<span class="nc" id="L11123">                    r = new Report(2161);</span>
<span class="nc" id="L11124">                    r.indent(2);</span>
<span class="nc" id="L11125">                    r.subject = entity.getId();</span>
<span class="nc" id="L11126">                    r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11127">                    r.add(6);</span>
<span class="nc" id="L11128">                    r.add(Math.max(remainingAV, 0));</span>
<span class="nc" id="L11129">                    vMineReport.add(r);</span>

<span class="nc bnc" id="L11131" title="All 2 branches missed.">                    if (remainingAV &lt;= 0) {</span>
<span class="nc" id="L11132">                        minesweeper.setDestroyed(true);</span>
                    }
                    // Check for damage transfer
<span class="nc bnc" id="L11135" title="All 2 branches missed.">                    if (remainingAV &lt; 0) {</span>
<span class="nc" id="L11136">                        int damage = Math.abs(remainingAV);</span>
<span class="nc" id="L11137">                        r = new Report(2162);</span>
<span class="nc" id="L11138">                        r.indent(2);</span>
<span class="nc" id="L11139">                        r.subject = entity.getId();</span>
<span class="nc" id="L11140">                        r.add(damage, true);</span>
<span class="nc" id="L11141">                        vMineReport.add(r);</span>

                        // Damage is dealt to the location of minesweeper
<span class="nc" id="L11144">                        HitData hit = new HitData(minesweeper.getLocation());</span>
<span class="nc" id="L11145">                        Vector&lt;Report&gt; damageReports = damageEntity(entity, hit, damage);</span>
<span class="nc bnc" id="L11146" title="All 2 branches missed.">                        for (Report r1 : damageReports) {</span>
<span class="nc" id="L11147">                            r1.indent(1);</span>
<span class="nc" id="L11148">                        }</span>
<span class="nc" id="L11149">                        vMineReport.addAll(damageReports);</span>
                    }
<span class="nc" id="L11151">                    Report.addNewline(vMineReport);</span>
                    // If the minefield is cleared, we're done processing it
<span class="nc" id="L11153">                    continue;</span>
                } else {
                    // Report miss
<span class="nc bnc" id="L11156" title="All 2 branches missed.">                    if (doBlind()) {</span>
<span class="nc" id="L11157">                        r = new Report(5542);</span>
<span class="nc" id="L11158">                        r.player = mf.getPlayerId();</span>
<span class="nc" id="L11159">                        vMineReport.add(r);</span>
                    }
                }
            }

            // check whether we have an active mine
<span class="nc bnc" id="L11165" title="All 4 branches missed.">            if ((mf.getType() == Minefield.TYPE_ACTIVE) &amp;&amp; isOnGround) {</span>
<span class="nc" id="L11166">                continue;</span>
            }
<span class="nc bnc" id="L11168" title="All 4 branches missed.">            if ((mf.getType() != Minefield.TYPE_ACTIVE) &amp;&amp; !isOnGround) {</span>
<span class="nc" id="L11169">                continue;</span>
            }

            // set the target number
<span class="nc bnc" id="L11173" title="All 2 branches missed.">            if (target == -1) {</span>
<span class="nc" id="L11174">                target = mf.getTrigger();</span>
<span class="nc bnc" id="L11175" title="All 2 branches missed.">                if (mf.getType() == Minefield.TYPE_ACTIVE) {</span>
<span class="nc" id="L11176">                    target = 9;</span>
                }
<span class="nc bnc" id="L11178" title="All 2 branches missed.">                if (entity instanceof Infantry) {</span>
<span class="nc" id="L11179">                    target += 1;</span>
                }
<span class="nc bnc" id="L11181" title="All 2 branches missed.">                if (entity.hasAbility(OptionsConstants.MISC_EAGLE_EYES)) {</span>
<span class="nc" id="L11182">                    target += 2;</span>
                }
<span class="nc bnc" id="L11184" title="All 2 branches missed.">                if ((entity.getMovementMode() == EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L11185" title="All 2 branches missed.">                        || (entity.getMovementMode() == EntityMovementMode.WIGE)) {</span>
<span class="nc" id="L11186">                    target = 12;</span>
                }
            }

<span class="nc" id="L11190">            int roll = Compute.d6(2);</span>

            // Report minefield roll
<span class="nc bnc" id="L11193" title="All 2 branches missed.">            if (doBlind()) { // Only do if DB, otherwise all players will see</span>
<span class="nc" id="L11194">                r = new Report(2151);</span>
<span class="nc" id="L11195">                r.player = mf.getPlayerId();</span>
<span class="nc" id="L11196">                r.add(Minefield.getDisplayableName(mf.getType()));</span>
<span class="nc" id="L11197">                r.add(mf.getCoords().getBoardNum());</span>
<span class="nc" id="L11198">                r.add(target);</span>
<span class="nc" id="L11199">                r.add(roll);</span>
<span class="nc" id="L11200">                r.newlines = 0;</span>
<span class="nc" id="L11201">                vMineReport.add(r);</span>
            }

<span class="nc bnc" id="L11204" title="All 2 branches missed.">            if (roll &lt; target) {</span>
                // Report miss
<span class="nc bnc" id="L11206" title="All 2 branches missed.">                if (doBlind()) {</span>
<span class="nc" id="L11207">                    r = new Report(2217);</span>
<span class="nc" id="L11208">                    r.player = mf.getPlayerId();</span>
<span class="nc" id="L11209">                    vMineReport.add(r);</span>
                }
                continue;
            }

            // Report hit
<span class="nc bnc" id="L11215" title="All 2 branches missed.">            if (doBlind()) {</span>
<span class="nc" id="L11216">                r = new Report(2270);</span>
<span class="nc" id="L11217">                r.player = mf.getPlayerId();</span>
<span class="nc" id="L11218">                vMineReport.add(r);</span>
            }

            // apply damage
<span class="nc" id="L11222">            trippedMine = true;</span>
            // explodedMines.add(mf);
<span class="nc" id="L11224">            mf.setDetonated(true);</span>
<span class="nc bnc" id="L11225" title="All 2 branches missed.">            if (mf.getType() == Minefield.TYPE_INFERNO) {</span>
                // report hitting an inferno mine
<span class="nc" id="L11227">                r = new Report(2155);</span>
<span class="nc" id="L11228">                r.subject = entity.getId();</span>
<span class="nc" id="L11229">                r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11230">                r.add(mf.getCoords().getBoardNum(), true);</span>
<span class="nc" id="L11231">                r.indent();</span>
<span class="nc" id="L11232">                vMineReport.add(r);</span>
<span class="nc" id="L11233">                vMineReport.addAll(deliverInfernoMissiles(entity, entity, mf.getDensity() / 2));</span>
            } else {
<span class="nc" id="L11235">                r = new Report(2150);</span>
<span class="nc" id="L11236">                r.subject = entity.getId();</span>
<span class="nc" id="L11237">                r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11238">                r.add(mf.getCoords().getBoardNum(), true);</span>
<span class="nc" id="L11239">                r.indent();</span>
<span class="nc" id="L11240">                vMineReport.add(r);</span>
<span class="nc" id="L11241">                int damage = mf.getDensity();</span>
<span class="nc bnc" id="L11242" title="All 2 branches missed.">                while (damage &gt; 0) {</span>
<span class="nc" id="L11243">                    int cur_damage = Math.min(5, damage);</span>
<span class="nc" id="L11244">                    damage = damage - cur_damage;</span>
                    HitData hit;
<span class="nc bnc" id="L11246" title="All 2 branches missed.">                    if (minesweeper == null) {</span>
<span class="nc" id="L11247">                        hit = entity.rollHitLocation(Minefield.TO_HIT_TABLE,</span>
                                Minefield.TO_HIT_SIDE);
                    } else { // Minesweepers cause mines to hit minesweeper loc
<span class="nc" id="L11250">                        hit = new HitData(minesweeper.getLocation());</span>
                    }
<span class="nc" id="L11252">                    vMineReport.addAll(damageEntity(entity, hit, cur_damage));</span>
<span class="nc" id="L11253">                }</span>
<span class="nc bnc" id="L11254" title="All 2 branches missed.">                if (entity instanceof Tank) {</span>
                    // Tanks check for motive system damage from minefields as
                    // from a side hit even though the damage proper hits the
                    // front above; exact side doesn't matter, though.
<span class="nc" id="L11258">                    vMineReport.addAll(vehicleMotiveDamage((Tank)entity,</span>
<span class="nc" id="L11259">                            entity.getMotiveSideMod(ToHitData.SIDE_LEFT)));</span>
                }
<span class="nc" id="L11261">                Report.addNewline(vMineReport);</span>
            }

            // check the direct reduction
<span class="nc" id="L11265">            mf.checkReduction(0, true);</span>
<span class="nc" id="L11266">            revealMinefield(mf);</span>
<span class="nc" id="L11267">        }</span>

<span class="nc bnc" id="L11269" title="All 2 branches missed.">        for (Minefield mf : fieldsToRemove) {</span>
<span class="nc" id="L11270">            removeMinefield(mf);</span>
<span class="nc" id="L11271">        }</span>

<span class="nc" id="L11273">        return trippedMine;</span>
    }

    /**
     * cycle through all mines on the board, check to see whether they should do
     * collateral damage to other mines due to detonation, resets detonation to
     * false, and removes any mines whose density has been reduced to zero.
     */
    private void resetMines() {
<span class="nc" id="L11282">        Enumeration&lt;Coords&gt; mineLoc = game.getMinedCoords();</span>
<span class="nc bnc" id="L11283" title="All 2 branches missed.">        while (mineLoc.hasMoreElements()) {</span>
<span class="nc" id="L11284">            Coords c = mineLoc.nextElement();</span>
<span class="nc" id="L11285">            Enumeration&lt;Minefield&gt; minefields = game.getMinefields(c).elements();</span>
<span class="nc bnc" id="L11286" title="All 2 branches missed.">            while (minefields.hasMoreElements()) {</span>
<span class="nc" id="L11287">                Minefield minefield = minefields.nextElement();</span>
<span class="nc bnc" id="L11288" title="All 2 branches missed.">                if (minefield.hasDetonated()) {</span>
<span class="nc" id="L11289">                    minefield.setDetonated(false);</span>
<span class="nc" id="L11290">                    Enumeration&lt;Minefield&gt; otherMines = game.getMinefields(c).elements();</span>
<span class="nc bnc" id="L11291" title="All 2 branches missed.">                    while (otherMines.hasMoreElements()) {</span>
<span class="nc" id="L11292">                        Minefield otherMine = otherMines.nextElement();</span>
<span class="nc bnc" id="L11293" title="All 2 branches missed.">                        if (otherMine.equals(minefield)) {</span>
<span class="nc" id="L11294">                            continue;</span>
                        }
<span class="nc" id="L11296">                        int bonus = 0;</span>
<span class="nc bnc" id="L11297" title="All 2 branches missed.">                        if (otherMine.getDensity() &gt; minefield.getDensity()) {</span>
<span class="nc" id="L11298">                            bonus = 1;</span>
                        }
<span class="nc bnc" id="L11300" title="All 2 branches missed.">                        if (otherMine.getDensity() &lt; minefield.getDensity()) {</span>
<span class="nc" id="L11301">                            bonus = -1;</span>
                        }
<span class="nc" id="L11303">                        otherMine.checkReduction(bonus, false);</span>
<span class="nc" id="L11304">                    }</span>
                }
<span class="nc" id="L11306">            }</span>
            // cycle through a second time to see if any mines at these coords
            // need to be removed
<span class="nc" id="L11309">            List&lt;Minefield&gt; mfRemoved = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L11310">            Enumeration&lt;Minefield&gt; mines = game.getMinefields(c).elements();</span>
<span class="nc bnc" id="L11311" title="All 2 branches missed.">            while (mines.hasMoreElements()) {</span>
<span class="nc" id="L11312">                Minefield mine = mines.nextElement();</span>
<span class="nc bnc" id="L11313" title="All 2 branches missed.">                if (mine.getDensity() &lt; 5) {</span>
<span class="nc" id="L11314">                    mfRemoved.add(mine);</span>
                }
<span class="nc" id="L11316">            }</span>
            // we have to do it this way to avoid a concurrent error problem
<span class="nc bnc" id="L11318" title="All 2 branches missed.">            for (Minefield mf : mfRemoved) {</span>
<span class="nc" id="L11319">                removeMinefield(mf);</span>
<span class="nc" id="L11320">            }</span>
            // update the mines at these coords
<span class="nc" id="L11322">            sendChangedMines(c);</span>
<span class="nc" id="L11323">        }</span>
<span class="nc" id="L11324">    }</span>

    /**
     * attempt to clear a minefield
     *
     * @param mf     - a &lt;code&gt;Minefield&lt;/code&gt; to clear
     * @param en     - &lt;code&gt;entity&lt;/code&gt; doing the clearing
     * @param target - &lt;code&gt;int&lt;/code&gt; needed to roll for a successful clearance
     * @return &lt;code&gt;true&lt;/code&gt; if clearance successful
     */
    public boolean clearMinefield(Minefield mf, Entity en, int target,
                                  Vector&lt;Report&gt; vClearReport) {
<span class="nc" id="L11336">        return clearMinefield(mf, en, target, -1, vClearReport, 2);</span>
    }

    public boolean clearMinefield(Minefield mf, Entity en, int target,
                                  int botch, Vector&lt;Report&gt; vClearReport) {
<span class="nc" id="L11341">        return clearMinefield(mf, en, target, botch, vClearReport, 1);</span>
    }

    /**
     * attempt to clear a minefield We don't actually remove the minefield here,
     * because if this is called up from within a loop, that will cause problems
     *
     * @param mf
     *            - a &lt;code&gt;Minefield&lt;/code&gt; to clear
     * @param en
     *            - &lt;code&gt;entity&lt;/code&gt; doing the clearing
     * @param target
     *            - &lt;code&gt;int&lt;/code&gt; needed to roll for a successful clearance
     * @param botch
     *            - &lt;code&gt;int&lt;/code&gt; that indicates an accidental detonation
     * @param vClearReport
     *            - The report collection to report to
     * @param indent
     *            - The number of indents for the report
     * @return &lt;code&gt;true&lt;/code&gt; if clearance successful
     */
    public boolean clearMinefield(Minefield mf, Entity en, int target,
            int botch, Vector&lt;Report&gt; vClearReport, int indent) {
        Report r;
<span class="nc" id="L11365">        int roll = Compute.d6(2);</span>
<span class="nc bnc" id="L11366" title="All 2 branches missed.">        if (roll &gt;= target) {</span>
<span class="nc" id="L11367">            r = new Report(2250);</span>
<span class="nc" id="L11368">            r.subject = en.getId();</span>
<span class="nc" id="L11369">            r.add(Minefield.getDisplayableName(mf.getType()));</span>
<span class="nc" id="L11370">            r.add(target);</span>
<span class="nc" id="L11371">            r.add(roll);</span>
<span class="nc" id="L11372">            r.indent(indent);</span>
<span class="nc" id="L11373">            vClearReport.add(r);</span>
<span class="nc" id="L11374">            return true;</span>
<span class="nc bnc" id="L11375" title="All 2 branches missed.">        } else if (roll &lt;= botch) {</span>
            // TODO : detonate the minefield
<span class="nc" id="L11377">            r = new Report(2255);</span>
<span class="nc" id="L11378">            r.subject = en.getId();</span>
<span class="nc" id="L11379">            r.indent(indent);</span>
<span class="nc" id="L11380">            r.add(Minefield.getDisplayableName(mf.getType()));</span>
<span class="nc" id="L11381">            r.add(target);</span>
<span class="nc" id="L11382">            r.add(roll);</span>
<span class="nc" id="L11383">            vClearReport.add(r);</span>
            // The detonation damages any units that were also attempting to
            // clear mines in the same hex
<span class="nc bnc" id="L11386" title="All 2 branches missed.">            for (Entity victim : game.getEntitiesVector(mf.getCoords())) {</span>
                Report rVictim;
<span class="nc bnc" id="L11388" title="All 2 branches missed.">                if (victim.isClearingMinefield()) {</span>
<span class="nc" id="L11389">                    rVictim = new Report(2265);</span>
<span class="nc" id="L11390">                    rVictim.subject = victim.getId();</span>
<span class="nc" id="L11391">                    rVictim.add(victim.getShortName(), true);</span>
<span class="nc" id="L11392">                    rVictim.indent(indent + 1);</span>
<span class="nc" id="L11393">                    vClearReport.add(rVictim);</span>
<span class="nc" id="L11394">                    int damage = mf.getDensity();</span>
<span class="nc bnc" id="L11395" title="All 2 branches missed.">                    while (damage &gt; 0) {</span>
<span class="nc" id="L11396">                        int cur_damage = Math.min(5, damage);</span>
<span class="nc" id="L11397">                        damage = damage - cur_damage;</span>
<span class="nc" id="L11398">                        HitData hit = victim.rollHitLocation(</span>
                                Minefield.TO_HIT_TABLE, Minefield.TO_HIT_SIDE);
<span class="nc" id="L11400">                        vClearReport.addAll(damageEntity(victim, hit, cur_damage));</span>
<span class="nc" id="L11401">                    }</span>
                }
<span class="nc" id="L11403">            }</span>
            // reduction works differently here
<span class="nc bnc" id="L11405" title="All 2 branches missed.">            if (mf.getType() == Minefield.TYPE_CONVENTIONAL) {</span>
<span class="nc" id="L11406">                mf.setDensity(Math.max(5, mf.getDensity() - 5));</span>
            } else {
                // congratulations, you cleared the mine by blowing yourself up
<span class="nc" id="L11409">                return true;</span>
            }
        } else {
            // failure
<span class="nc" id="L11413">            r = new Report(2260);</span>
<span class="nc" id="L11414">            r.subject = en.getId();</span>
<span class="nc" id="L11415">            r.indent(indent);</span>
<span class="nc" id="L11416">            r.add(Minefield.getDisplayableName(mf.getType()));</span>
<span class="nc" id="L11417">            r.add(target);</span>
<span class="nc" id="L11418">            r.add(roll);</span>
<span class="nc" id="L11419">            vClearReport.add(r);</span>
        }
<span class="nc" id="L11421">        return false;</span>
    }

    /**
     * Clear any detonated mines at these coords
     */
    private void clearDetonatedMines(Coords c, int target) {
<span class="nc" id="L11428">        Enumeration&lt;Minefield&gt; minefields = game.getMinefields(c).elements();</span>
<span class="nc" id="L11429">        List&lt;Minefield&gt; mfRemoved = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L11430" title="All 2 branches missed.">        while (minefields.hasMoreElements()) {</span>
<span class="nc" id="L11431">            Minefield minefield = minefields.nextElement();</span>
<span class="nc bnc" id="L11432" title="All 4 branches missed.">            if (minefield.hasDetonated() &amp;&amp; (Compute.d6(2) &gt;= target)) {</span>
<span class="nc" id="L11433">                mfRemoved.add(minefield);</span>
            }
<span class="nc" id="L11435">        }</span>
        // we have to do it this way to avoid a concurrent error problem
<span class="nc bnc" id="L11437" title="All 2 branches missed.">        for (Minefield mf : mfRemoved) {</span>
<span class="nc" id="L11438">            removeMinefield(mf);</span>
<span class="nc" id="L11439">        }</span>
<span class="nc" id="L11440">    }</span>

    /**
     * Checks to see if an entity sets off any vibrabombs.
     */
    private boolean checkVibrabombs(Entity entity, Coords coords, boolean displaced,
                                    Vector&lt;Report&gt; vMineReport) {
<span class="nc" id="L11447">        return checkVibrabombs(entity, coords, displaced, null, null, vMineReport);</span>
    }

    /**
     * Checks to see if an entity sets off any vibrabombs.
     */
    private boolean checkVibrabombs(Entity entity, Coords coords, boolean displaced, Coords lastPos,
                                    Coords curPos, Vector&lt;Report&gt; vMineReport) {
<span class="nc" id="L11455">        int mass = (int) entity.getWeight();</span>

        // Check for Mine sweepers
<span class="nc" id="L11458">        Mounted minesweeper = null;</span>
<span class="nc bnc" id="L11459" title="All 2 branches missed.">        for (Mounted m : entity.getMisc()) {</span>
<span class="nc bnc" id="L11460" title="All 6 branches missed.">            if (m.getType().hasFlag(MiscType.F_MINESWEEPER) &amp;&amp; m.isReady() &amp;&amp; (m.getArmorValue() &gt; 0)) {</span>
<span class="nc" id="L11461">                minesweeper = m;</span>
<span class="nc" id="L11462">                break; // Can only have one minesweeper</span>
            }
<span class="nc" id="L11464">        }</span>

        // Check for minesweepers sweeping VB minefields
<span class="nc bnc" id="L11467" title="All 2 branches missed.">        if (minesweeper != null) {</span>
<span class="nc" id="L11468">            Vector&lt;Minefield&gt; fieldsToRemove = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L11469" title="All 2 branches missed.">            for (Minefield mf : game.getVibrabombs()) {</span>
                // Ignore mines if they aren't in this position
<span class="nc bnc" id="L11471" title="All 2 branches missed.">                if (!mf.getCoords().equals(coords)) {</span>
<span class="nc" id="L11472">                    continue;</span>
                }

                // Minesweepers on units within 9 tons of the vibrafield setting
                // automatically clear the minefield
<span class="nc bnc" id="L11477" title="All 2 branches missed.">                if (Math.abs(mass - mf.getSetting()) &lt; 10) {</span>
                    // Clear the minefield
                    Report r;
<span class="nc" id="L11480">                    r = new Report(2158);</span>
<span class="nc" id="L11481">                    r.subject = entity.getId();</span>
<span class="nc" id="L11482">                    r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11483">                    r.add(Minefield.getDisplayableName(mf.getType()), true);</span>
<span class="nc" id="L11484">                    r.add(mf.getCoords().getBoardNum(), true);</span>
<span class="nc" id="L11485">                    r.indent();</span>
<span class="nc" id="L11486">                    vMineReport.add(r);</span>
<span class="nc" id="L11487">                    fieldsToRemove.add(mf);</span>

                    // Handle armor value damage
<span class="nc" id="L11490">                    int remainingAV = minesweeper.getArmorValue() - 10;</span>
<span class="nc" id="L11491">                    minesweeper.setArmorValue(Math.max(remainingAV, 0));</span>

<span class="nc" id="L11493">                    r = new Report(2161);</span>
<span class="nc" id="L11494">                    r.indent(2);</span>
<span class="nc" id="L11495">                    r.subject = entity.getId();</span>
<span class="nc" id="L11496">                    r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11497">                    r.add(10);</span>
<span class="nc" id="L11498">                    r.add(Math.max(remainingAV, 0));</span>
<span class="nc" id="L11499">                    vMineReport.add(r);</span>

<span class="nc bnc" id="L11501" title="All 2 branches missed.">                    if (remainingAV &lt;= 0) {</span>
<span class="nc" id="L11502">                        minesweeper.setDestroyed(true);</span>
                    }
                    // Check for damage transfer
<span class="nc bnc" id="L11505" title="All 2 branches missed.">                    if (remainingAV &lt; 0) {</span>
<span class="nc" id="L11506">                        int damage = Math.abs(remainingAV);</span>
<span class="nc" id="L11507">                        r = new Report(2162);</span>
<span class="nc" id="L11508">                        r.indent(2);</span>
<span class="nc" id="L11509">                        r.subject = entity.getId();</span>
<span class="nc" id="L11510">                        r.add(damage, true);</span>
<span class="nc" id="L11511">                        vMineReport.add(r);</span>

                        // Damage is dealt to the location of minesweeper
<span class="nc" id="L11514">                        HitData hit = new HitData(minesweeper.getLocation());</span>
<span class="nc" id="L11515">                        Vector&lt;Report&gt; damageReports = damageEntity(entity, hit, damage);</span>
<span class="nc bnc" id="L11516" title="All 2 branches missed.">                        for (Report r1 : damageReports) {</span>
<span class="nc" id="L11517">                            r1.indent(1);</span>
<span class="nc" id="L11518">                        }</span>
<span class="nc" id="L11519">                        vMineReport.addAll(damageReports);</span>
<span class="nc" id="L11520">                        entity.applyDamage();</span>
                    }
<span class="nc" id="L11522">                    Report.addNewline(vMineReport);</span>
                }
<span class="nc" id="L11524">            }</span>
<span class="nc bnc" id="L11525" title="All 2 branches missed.">            for (Minefield mf : fieldsToRemove) {</span>
<span class="nc" id="L11526">                removeMinefield(mf);</span>
<span class="nc" id="L11527">            }</span>
        }


<span class="nc" id="L11531">        boolean boom = false;</span>
        // Only mechs can set off vibrabombs. QuadVees should only be able to set off a
        // vibrabomb in Mech mode. Those that are converting to or from Mech mode should
        // are using leg movement and should be able to set them off.
<span class="nc bnc" id="L11535" title="All 4 branches missed.">        if (!(entity instanceof Mech) || (entity instanceof QuadVee</span>
<span class="nc bnc" id="L11536" title="All 2 branches missed.">                &amp;&amp; (entity.getConversionMode() == QuadVee.CONV_MODE_VEHICLE)</span>
<span class="nc bnc" id="L11537" title="All 2 branches missed.">                &amp;&amp; !entity.isConvertingNow())) {</span>
<span class="nc" id="L11538">            return false;</span>
        }

<span class="nc" id="L11541">        Enumeration&lt;Minefield&gt; e = game.getVibrabombs().elements();</span>

<span class="nc bnc" id="L11543" title="All 2 branches missed.">        while (e.hasMoreElements()) {</span>
<span class="nc" id="L11544">            Minefield mf = e.nextElement();</span>

            // Bug 954272: Mines shouldn't work underwater, and BMRr says
            // Vibrabombs are mines
<span class="nc bnc" id="L11548" title="All 2 branches missed.">            if (game.getBoard().getHex(mf.getCoords()).containsTerrain(Terrains.WATER)</span>
<span class="nc bnc" id="L11549" title="All 2 branches missed.">                    &amp;&amp; !game.getBoard().getHex(mf.getCoords()).containsTerrain(Terrains.PAVEMENT)</span>
<span class="nc bnc" id="L11550" title="All 2 branches missed.">                    &amp;&amp; !game.getBoard().getHex(mf.getCoords()).containsTerrain(Terrains.ICE)) {</span>
<span class="nc" id="L11551">                continue;</span>
            }

            // Mech weighing 10 tons or less can't set off the bomb
<span class="nc bnc" id="L11555" title="All 2 branches missed.">            if (mass &lt;= (mf.getSetting() - 10)) {</span>
<span class="nc" id="L11556">                continue;</span>
            }

<span class="nc" id="L11559">            int effectiveDistance = (mass - mf.getSetting()) / 10;</span>
<span class="nc" id="L11560">            int actualDistance = coords.distance(mf.getCoords());</span>

<span class="nc bnc" id="L11562" title="All 2 branches missed.">            if (actualDistance &lt;= effectiveDistance) {</span>
<span class="nc" id="L11563">                Report r = new Report(2156);</span>
<span class="nc" id="L11564">                r.subject = entity.getId();</span>
<span class="nc" id="L11565">                r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11566">                r.add(mf.getCoords().getBoardNum(), true);</span>
<span class="nc" id="L11567">                vMineReport.add(r);</span>
                
                // if the moving entity is not actually moving into the vibrabomb
                // hex, it won't get damaged
<span class="nc" id="L11571">                Integer excludeEntityID = null;</span>
<span class="nc bnc" id="L11572" title="All 2 branches missed.">                if (!coords.equals(mf.getCoords())) {</span>
<span class="nc" id="L11573">                    excludeEntityID = entity.getId();</span>
                }
                    
<span class="nc" id="L11576">                explodeVibrabomb(mf, vMineReport, false, excludeEntityID);</span>
            }

            // Hack; when moving, the Mech isn't in the hex during
            // the movement.
<span class="nc bnc" id="L11581" title="All 4 branches missed.">            if (!displaced &amp;&amp; (actualDistance == 0)) {</span>
                // report getting hit by vibrabomb
<span class="nc" id="L11583">                Report r = new Report(2160);</span>
<span class="nc" id="L11584">                r.subject = entity.getId();</span>
<span class="nc" id="L11585">                r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11586">                vMineReport.add(r);</span>
<span class="nc" id="L11587">                int damage = mf.getDensity();</span>
<span class="nc bnc" id="L11588" title="All 2 branches missed.">                while (damage &gt; 0) {</span>
<span class="nc" id="L11589">                    int cur_damage = Math.min(5, damage);</span>
<span class="nc" id="L11590">                    damage = damage - cur_damage;</span>
<span class="nc" id="L11591">                    HitData hit = entity.rollHitLocation(Minefield.TO_HIT_TABLE, Minefield.TO_HIT_SIDE);</span>
<span class="nc" id="L11592">                    vMineReport.addAll(damageEntity(entity, hit, cur_damage));</span>
<span class="nc" id="L11593">                }</span>
<span class="nc" id="L11594">                vMineReport.addAll(resolvePilotingRolls(entity, true, lastPos, curPos));</span>
                // we need to apply Damage now, in case the entity lost a leg,
                // otherwise it won't get a leg missing mod if it hasn't yet
                // moved and lost a leg, see bug 1071434 for an example
<span class="nc" id="L11598">                entity.applyDamage();</span>
            }

            // don't check for reduction until the end or units in the same hex
            // through
            // movement will get the reduced damage
<span class="nc bnc" id="L11604" title="All 2 branches missed.">            if (mf.hasDetonated()) {</span>
<span class="nc" id="L11605">                boom = true;</span>
<span class="nc" id="L11606">                mf.checkReduction(0, true);</span>
            }

<span class="nc" id="L11609">        }</span>
<span class="nc" id="L11610">        return boom;</span>
    }

    /**
     * Removes the minefield from the game.
     *
     * @param mf The &lt;code&gt;Minefield&lt;/code&gt; to remove
     */
    public void removeMinefield(Minefield mf) {
<span class="nc bnc" id="L11619" title="All 2 branches missed.">        if (game.containsVibrabomb(mf)) {</span>
<span class="nc" id="L11620">            game.removeVibrabomb(mf);</span>
        }
<span class="nc" id="L11622">        game.removeMinefield(mf);</span>

<span class="nc" id="L11624">        Enumeration&lt;IPlayer&gt; players = game.getPlayers();</span>
<span class="nc bnc" id="L11625" title="All 2 branches missed.">        while (players.hasMoreElements()) {</span>
<span class="nc" id="L11626">            IPlayer player = players.nextElement();</span>
<span class="nc" id="L11627">            removeMinefield(player, mf);</span>
<span class="nc" id="L11628">        }</span>
<span class="nc" id="L11629">    }</span>

    /**
     * Removes the minefield from a player.
     *
     * @param player The &lt;code&gt;Player&lt;/code&gt; whose minefield should be removed
     * @param mf     The &lt;code&gt;Minefield&lt;/code&gt; to be removed
     */
    private void removeMinefield(IPlayer player, Minefield mf) {
<span class="nc bnc" id="L11638" title="All 2 branches missed.">        if (player.containsMinefield(mf)) {</span>
<span class="nc" id="L11639">            player.removeMinefield(mf);</span>
<span class="nc" id="L11640">            send(player.getId(), new Packet(Packet.COMMAND_REMOVE_MINEFIELD, mf));</span>
        }
<span class="nc" id="L11642">    }</span>

    /**
     * Reveals a minefield for all players.
     *
     * @param mf The &lt;code&gt;Minefield&lt;/code&gt; to be revealed
     */
    private void revealMinefield(Minefield mf) {
<span class="nc" id="L11650">        Enumeration&lt;Team&gt; teams = game.getTeams();</span>
<span class="nc bnc" id="L11651" title="All 2 branches missed.">        while (teams.hasMoreElements()) {</span>
<span class="nc" id="L11652">            Team team = teams.nextElement();</span>
<span class="nc" id="L11653">            revealMinefield(team, mf);</span>
<span class="nc" id="L11654">        }</span>
<span class="nc" id="L11655">    }</span>

    /**
     * Reveals a minefield for all players on a team.
     *
     * @param team The &lt;code&gt;team&lt;/code&gt; whose minefield should be revealed
     * @param mf   The &lt;code&gt;Minefield&lt;/code&gt; to be revealed
     */
    private void revealMinefield(Team team, Minefield mf) {
<span class="nc" id="L11664">        Enumeration&lt;IPlayer&gt; players = team.getPlayers();</span>
<span class="nc bnc" id="L11665" title="All 2 branches missed.">        while (players.hasMoreElements()) {</span>
<span class="nc" id="L11666">            IPlayer player = players.nextElement();</span>
<span class="nc bnc" id="L11667" title="All 2 branches missed.">            if (!player.containsMinefield(mf)) {</span>
<span class="nc" id="L11668">                player.addMinefield(mf);</span>
<span class="nc" id="L11669">                send(player.getId(), new Packet(Packet.COMMAND_REVEAL_MINEFIELD, mf));</span>
            }
<span class="nc" id="L11671">        }</span>
<span class="nc" id="L11672">    }</span>

    /**
     * checks whether a newly set mine should be revealed to players based on
     * LOS. If so, then it reveals the mine
     */
    private void checkForRevealMinefield(Minefield mf, Entity layer) {
<span class="nc" id="L11679">        Enumeration&lt;Team&gt; teams = game.getTeams();</span>
        // loop through each team and determine if they can see the mine, then
        // loop through players on team
        // and reveal the mine
<span class="nc bnc" id="L11683" title="All 2 branches missed.">        while (teams.hasMoreElements()) {</span>
<span class="nc" id="L11684">            Team team = teams.nextElement();</span>
<span class="nc" id="L11685">            boolean canSee = false;</span>

            // the players own team can always see the mine
<span class="nc bnc" id="L11688" title="All 2 branches missed.">            if (team.equals(game.getTeamForPlayer(game.getPlayer(mf.getPlayerId())))) {</span>
<span class="nc" id="L11689">                canSee = true;</span>
            } else {
                // need to loop through all entities on this team and find the
                // one with the best shot of seeing
                // the mine placement
<span class="nc" id="L11694">                int target = Integer.MAX_VALUE;</span>
<span class="nc" id="L11695">                Iterator&lt;Entity&gt; entities = game.getEntities();</span>
<span class="nc bnc" id="L11696" title="All 2 branches missed.">                while (entities.hasNext()) {</span>
<span class="nc" id="L11697">                    Entity en = entities.next();</span>
                    // are we on the right team?
<span class="nc bnc" id="L11699" title="All 2 branches missed.">                    if (!team.equals(game.getTeamForPlayer(en.getOwner()))) {</span>
<span class="nc" id="L11700">                        continue;</span>
                    }
<span class="nc" id="L11702">                    if (LosEffects.calculateLos(game, en.getId(),</span>
<span class="nc" id="L11703">                            new HexTarget(mf.getCoords(), game.getBoard(),</span>
<span class="nc bnc" id="L11704" title="All 2 branches missed.">                                    Targetable.TYPE_HEX_CLEAR)).canSee()) {</span>
<span class="nc" id="L11705">                        target = 0;</span>
<span class="nc" id="L11706">                        break;</span>
                    }
<span class="nc" id="L11708">                    LosEffects los = LosEffects.calculateLos(game, en.getId(), layer);</span>
<span class="nc bnc" id="L11709" title="All 2 branches missed.">                    if (los.canSee()) {</span>
                        // TODO : need to add mods
<span class="nc" id="L11711">                        ToHitData current = new ToHitData(4, &quot;base&quot;);</span>
<span class="nc" id="L11712">                        current.append(Compute.getAttackerMovementModifier(game, en.getId()));</span>
<span class="nc" id="L11713">                        current.append(Compute.getTargetMovementModifier(game, layer.getId()));</span>
<span class="nc" id="L11714">                        current.append(los.losModifiers(game));</span>
<span class="nc bnc" id="L11715" title="All 2 branches missed.">                        if (current.getValue() &lt; target) {</span>
<span class="nc" id="L11716">                            target = current.getValue();</span>
                        }
                    }
<span class="nc" id="L11719">                }</span>

<span class="nc bnc" id="L11721" title="All 2 branches missed.">                if (Compute.d6(2) &gt;= target) {</span>
<span class="nc" id="L11722">                    canSee = true;</span>
                }
            }
<span class="nc bnc" id="L11725" title="All 2 branches missed.">            if (canSee) {</span>
<span class="nc" id="L11726">                revealMinefield(team, mf);</span>
            }
<span class="nc" id="L11728">        }</span>
<span class="nc" id="L11729">    }</span>

    /**
     * Explodes a vibrabomb.
     *
     * @param mf The &lt;code&gt;Minefield&lt;/code&gt; to explode
     */
    private void explodeVibrabomb(Minefield mf, Vector&lt;Report&gt; vBoomReport, boolean reduce, Integer entityToExclude) {
<span class="nc" id="L11737">        Iterator&lt;Entity&gt; targets = game.getEntities(mf.getCoords());</span>
        Report r;

<span class="nc bnc" id="L11740" title="All 2 branches missed.">        while (targets.hasNext()) {</span>
<span class="nc" id="L11741">            Entity entity = targets.next();</span>

            // Airborne entities wont get hit by the mines...
<span class="nc bnc" id="L11744" title="All 2 branches missed.">            if (entity.isAirborne()) {</span>
<span class="nc" id="L11745">                continue;</span>
            }

            // check for the OptionsConstants.ADVGRNDMOV_NO_PREMOVE_VIBRA option
            // If it's set, and the target has not yet moved,
            // it doesn't get damaged.
<span class="nc bnc" id="L11751" title="All 2 branches missed.">            if (!entity.isDone()</span>
<span class="nc bnc" id="L11752" title="All 2 branches missed.">                &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_NO_PREMOVE_VIBRA)) {</span>
<span class="nc" id="L11753">                r = new Report(2157);</span>
<span class="nc" id="L11754">                r.subject = entity.getId();</span>
<span class="nc" id="L11755">                r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11756">                vBoomReport.add(r);</span>
<span class="nc" id="L11757">                continue;</span>
            }
            
            // the &quot;currently moving entity&quot; may not be in the same hex, so it needs to be excluded
<span class="nc bnc" id="L11761" title="All 4 branches missed.">            if ((entityToExclude != null) &amp;&amp; (entity.getId() == entityToExclude)) {</span>
                // report not hitting vibrabomb
<span class="nc" id="L11763">                r = new Report(2157);</span>
<span class="nc" id="L11764">                r.subject = entity.getId();</span>
<span class="nc" id="L11765">                r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11766">                vBoomReport.add(r);</span>
<span class="nc" id="L11767">                continue;</span>
            } else {
                // report hitting vibrabomb
<span class="nc" id="L11770">                r = new Report(2160);</span>
<span class="nc" id="L11771">                r.subject = entity.getId();</span>
<span class="nc" id="L11772">                r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11773">                vBoomReport.add(r);</span>
            }
            
<span class="nc" id="L11776">            int damage = mf.getDensity();</span>
<span class="nc bnc" id="L11777" title="All 2 branches missed.">            while (damage &gt; 0) {</span>
<span class="nc" id="L11778">                int cur_damage = Math.min(5, damage);</span>
<span class="nc" id="L11779">                damage = damage - cur_damage;</span>
<span class="nc" id="L11780">                HitData hit = entity.rollHitLocation(Minefield.TO_HIT_TABLE, Minefield.TO_HIT_SIDE);</span>
<span class="nc" id="L11781">                vBoomReport.addAll(damageEntity(entity, hit, cur_damage));</span>
<span class="nc" id="L11782">            }</span>
<span class="nc" id="L11783">            Report.addNewline(vBoomReport);</span>

<span class="nc bnc" id="L11785" title="All 2 branches missed.">            if (entity instanceof Tank) {</span>
<span class="nc" id="L11786">                vBoomReport.addAll(vehicleMotiveDamage((Tank)entity,</span>
<span class="nc" id="L11787">                        entity.getMotiveSideMod(ToHitData.SIDE_LEFT)));</span>
            }
<span class="nc" id="L11789">            vBoomReport.addAll(resolvePilotingRolls(entity, true, entity.getPosition(),</span>
<span class="nc" id="L11790">                    entity.getPosition()));</span>
            // we need to apply Damage now, in case the entity lost a leg,
            // otherwise it won't get a leg missing mod if it hasn't yet
            // moved and lost a leg, see bug 1071434 for an example
<span class="nc" id="L11794">            game.resetPSRs(entity);</span>
<span class="nc" id="L11795">            entity.applyDamage();</span>
<span class="nc" id="L11796">            Report.addNewline(vBoomReport);</span>
<span class="nc" id="L11797">            entityUpdate(entity.getId());</span>
<span class="nc" id="L11798">        }</span>

        // check the direct reduction of mine
<span class="nc bnc" id="L11801" title="All 2 branches missed.">        if (reduce) {</span>
<span class="nc" id="L11802">            mf.checkReduction(0, true);</span>
        }
<span class="nc" id="L11804">        mf.setDetonated(true);</span>
<span class="nc" id="L11805">    }</span>

    /**
     * drowns any units swarming the entity
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that is being swarmed
     * @param pos    The &lt;code&gt;Coords&lt;/code&gt; the entity is at
     */
    private void drownSwarmer(Entity entity, Coords pos) {
        // Any swarming infantry will be destroyed.
<span class="nc" id="L11815">        final int swarmerId = entity.getSwarmAttackerId();</span>
<span class="nc bnc" id="L11816" title="All 2 branches missed.">        if (Entity.NONE != swarmerId) {</span>
<span class="nc" id="L11817">            final Entity swarmer = game.getEntity(swarmerId);</span>
            // Only *platoons* drown while swarming.
<span class="nc bnc" id="L11819" title="All 2 branches missed.">            if (!(swarmer instanceof BattleArmor)) {</span>
<span class="nc" id="L11820">                swarmer.setSwarmTargetId(Entity.NONE);</span>
<span class="nc" id="L11821">                entity.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L11822">                swarmer.setPosition(pos);</span>
<span class="nc" id="L11823">                Report r = new Report(2165);</span>
<span class="nc" id="L11824">                r.subject = entity.getId();</span>
<span class="nc" id="L11825">                r.indent();</span>
<span class="nc" id="L11826">                r.add(entity.getShortName(), true);</span>
<span class="nc" id="L11827">                addReport(r);</span>
<span class="nc" id="L11828">                addReport(destroyEntity(swarmer, &quot;a watery grave&quot;, false));</span>
<span class="nc" id="L11829">                entityUpdate(swarmerId);</span>
            }
        }
<span class="nc" id="L11832">    }</span>

    /**
     * Checks to see if we may have just washed off infernos. Call after a step
     * which may have done this.
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that is being checked
     * @param coords The &lt;code&gt;Coords&lt;/code&gt; the entity is at
     */
    void checkForWashedInfernos(Entity entity, Coords coords) {
<span class="nc" id="L11842">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L11843">        int waterLevel = hex.terrainLevel(Terrains.WATER);</span>
        // Mech on fire with infernos can wash them off.
<span class="nc bnc" id="L11845" title="All 4 branches missed.">        if (!(entity instanceof Mech) || !entity.infernos.isStillBurning()) {</span>
<span class="nc" id="L11846">            return;</span>
        }
        // Check if entering depth 2 water or prone in depth 1.
<span class="nc bnc" id="L11849" title="All 4 branches missed.">        if ((waterLevel &gt; 0) &amp;&amp; (entity.relHeight() &lt; 0)) {</span>
<span class="nc" id="L11850">            washInferno(entity, coords);</span>
        }
<span class="nc" id="L11852">    }</span>

    /**
     * Washes off an inferno from a mech and adds it to the (water) hex.
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that is taking a bath
     * @param coords The &lt;code&gt;Coords&lt;/code&gt; the entity is at
     */
    void washInferno(Entity entity, Coords coords) {
<span class="nc" id="L11861">        game.getBoard().addInfernoTo(coords, InfernoTracker.STANDARD_ROUND, 1);</span>
<span class="nc" id="L11862">        entity.infernos.clear();</span>

        // Start a fire in the hex?
<span class="nc" id="L11865">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L11866">        Report r = new Report(2170);</span>
<span class="nc" id="L11867">        r.subject = entity.getId();</span>
<span class="nc" id="L11868">        r.addDesc(entity);</span>
<span class="nc bnc" id="L11869" title="All 2 branches missed.">        if (!hex.containsTerrain(Terrains.FIRE)) {</span>
<span class="nc" id="L11870">            r.messageId = 2175;</span>
<span class="nc" id="L11871">            ignite(coords, Terrains.FIRE_LVL_INFERNO, null);</span>
        }
<span class="nc" id="L11873">        addReport(r);</span>
<span class="nc" id="L11874">    }</span>

    /**
     * Add heat from the movement phase
     */
    public void addMovementHeat() {
<span class="nc bnc" id="L11880" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L11881">            Entity entity = i.next();</span>

<span class="nc bnc" id="L11883" title="All 2 branches missed.">            if (entity.hasDamagedRHS()) {</span>
<span class="nc" id="L11884">                entity.heatBuildup += 1;</span>
            }

<span class="nc bnc" id="L11887" title="All 2 branches missed.">            if ((entity.getMovementMode() == EntityMovementMode.BIPED_SWIM)</span>
<span class="nc bnc" id="L11888" title="All 2 branches missed.">                || (entity.getMovementMode() == EntityMovementMode.QUAD_SWIM)) {</span>
                // UMU heat
<span class="nc" id="L11890">                entity.heatBuildup += 1;</span>
<span class="nc" id="L11891">                continue;</span>
            }

            // build up heat from movement
<span class="nc bnc" id="L11895" title="All 4 branches missed.">            if (entity.isEvading() &amp;&amp; !entity.isAero()) {</span>
<span class="nc" id="L11896">                entity.heatBuildup += entity.getRunHeat() + 2;</span>
<span class="nc bnc" id="L11897" title="All 2 branches missed.">            } else if (entity.moved == EntityMovementType.MOVE_NONE) {</span>
<span class="nc" id="L11898">                entity.heatBuildup += entity.getStandingHeat();</span>
<span class="nc bnc" id="L11899" title="All 6 branches missed.">            } else if ((entity.moved == EntityMovementType.MOVE_WALK)</span>
                       || (entity.moved == EntityMovementType.MOVE_VTOL_WALK)
                       || (entity.moved == EntityMovementType.MOVE_CAREFUL_STAND)) {
<span class="nc" id="L11902">                entity.heatBuildup += entity.getWalkHeat();</span>
<span class="nc bnc" id="L11903" title="All 6 branches missed.">            } else if ((entity.moved == EntityMovementType.MOVE_RUN)</span>
                       || (entity.moved == EntityMovementType.MOVE_VTOL_RUN)
                       || (entity.moved == EntityMovementType.MOVE_SKID)) {
<span class="nc" id="L11906">                entity.heatBuildup += entity.getRunHeat();</span>
<span class="nc bnc" id="L11907" title="All 2 branches missed.">            } else if (entity.moved == EntityMovementType.MOVE_JUMP) {</span>
<span class="nc" id="L11908">                entity.heatBuildup += entity.getJumpHeat(entity.delta_distance);</span>
<span class="nc bnc" id="L11909" title="All 4 branches missed.">            } else if (entity.moved == EntityMovementType.MOVE_SPRINT</span>
                    || entity.moved == EntityMovementType.MOVE_VTOL_SPRINT) {
<span class="nc" id="L11911">                entity.heatBuildup += entity.getSprintHeat();</span>
            }
<span class="nc" id="L11913">        }</span>
<span class="nc" id="L11914">    }</span>

    /**
     * Set the LocationsExposure of an entity
     *
     * @param entity
     *            The &lt;code&gt;Entity&lt;/code&gt; who's exposure is being set
     * @param hex
     *            The &lt;code&gt;IHex&lt;/code&gt; the entity is in
     * @param isJump
     *            a &lt;code&gt;boolean&lt;/code&gt; value whether the entity is jumping
     * @param elevation
     *            the elevation the entity should be at.
     */
    public Vector&lt;Report&gt; doSetLocationsExposure(Entity entity, IHex hex,
            boolean isJump, int elevation) {
<span class="nc" id="L11930">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L11931" title="All 2 branches missed.">        if (hex == null) {</span>
<span class="nc" id="L11932">            return vPhaseReport;</span>
        }
<span class="nc bnc" id="L11934" title="All 6 branches missed.">        if ((hex.terrainLevel(Terrains.WATER) &gt; 0) &amp;&amp; !isJump</span>
            &amp;&amp; (elevation &lt; 0)) {
<span class="nc" id="L11936">            int partialWaterLevel = 1;</span>
<span class="nc bnc" id="L11937" title="All 4 branches missed.">            if ((entity instanceof Mech) &amp;&amp; entity.isSuperHeavy()) {</span>
<span class="nc" id="L11938">                partialWaterLevel = 2;</span>
            }
<span class="nc bnc" id="L11940" title="All 4 branches missed.">            if ((entity instanceof Mech) &amp;&amp; !entity.isProne()</span>
<span class="nc bnc" id="L11941" title="All 2 branches missed.">                &amp;&amp; (hex.terrainLevel(Terrains.WATER) &lt;= partialWaterLevel)) {</span>
<span class="nc bnc" id="L11942" title="All 2 branches missed.">                for (int loop = 0; loop &lt; entity.locations(); loop++) {</span>
<span class="nc bnc" id="L11943" title="All 2 branches missed.">                    if (game.getPlanetaryConditions().isVacuum()</span>
<span class="nc bnc" id="L11944" title="All 4 branches missed.">                            || ((entity.getEntityType() &amp; Entity.ETYPE_AERO) == 0 &amp;&amp; entity.isSpaceborne())) {</span>
<span class="nc" id="L11945">                        entity.setLocationStatus(loop, ILocationExposureStatus.VACUUM);</span>
                    } else {
<span class="nc" id="L11947">                        entity.setLocationStatus(loop, ILocationExposureStatus.NORMAL);</span>
                    }
                }
<span class="nc" id="L11950">                entity.setLocationStatus(Mech.LOC_RLEG, ILocationExposureStatus.WET);</span>
<span class="nc" id="L11951">                entity.setLocationStatus(Mech.LOC_LLEG, ILocationExposureStatus.WET);</span>
<span class="nc" id="L11952">                vPhaseReport.addAll(breachCheck(entity, Mech.LOC_RLEG, hex));</span>
<span class="nc" id="L11953">                vPhaseReport.addAll(breachCheck(entity, Mech.LOC_LLEG, hex));</span>
<span class="nc bnc" id="L11954" title="All 2 branches missed.">                if (entity instanceof QuadMech) {</span>
<span class="nc" id="L11955">                    entity.setLocationStatus(Mech.LOC_RARM, ILocationExposureStatus.WET);</span>
<span class="nc" id="L11956">                    entity.setLocationStatus(Mech.LOC_LARM, ILocationExposureStatus.WET);</span>
<span class="nc" id="L11957">                    vPhaseReport.addAll(breachCheck(entity, Mech.LOC_RARM, hex));</span>
<span class="nc" id="L11958">                    vPhaseReport.addAll(breachCheck(entity, Mech.LOC_LARM, hex));</span>
                }
<span class="nc bnc" id="L11960" title="All 2 branches missed.">                if (entity instanceof TripodMech) {</span>
<span class="nc" id="L11961">                    entity.setLocationStatus(Mech.LOC_CLEG, ILocationExposureStatus.WET);</span>
<span class="nc" id="L11962">                    vPhaseReport.addAll(breachCheck(entity, Mech.LOC_CLEG, hex));</span>
                }
            } else {
<span class="nc bnc" id="L11965" title="All 2 branches missed.">                for (int loop = 0; loop &lt; entity.locations(); loop++) {</span>
<span class="nc" id="L11966">                    entity.setLocationStatus(loop, ILocationExposureStatus.WET);</span>
<span class="nc" id="L11967">                    vPhaseReport.addAll(breachCheck(entity, loop, hex));</span>
                }
            }
<span class="nc" id="L11970">        } else {</span>
<span class="nc bnc" id="L11971" title="All 2 branches missed.">            for (int loop = 0; loop &lt; entity.locations(); loop++) {</span>
<span class="nc bnc" id="L11972" title="All 2 branches missed.">                if (game.getPlanetaryConditions().isVacuum()</span>
<span class="nc bnc" id="L11973" title="All 4 branches missed.">                        || ((entity.getEntityType() &amp; Entity.ETYPE_AERO) == 0 &amp;&amp; entity.isSpaceborne())) {</span>
<span class="nc" id="L11974">                    entity.setLocationStatus(loop, ILocationExposureStatus.VACUUM);</span>
                } else {
<span class="nc" id="L11976">                    entity.setLocationStatus(loop, ILocationExposureStatus.NORMAL);</span>
                }
            }
        }
<span class="nc" id="L11980">        return vPhaseReport;</span>
    }

    /**
     * Do a roll to avoid pilot damage from g-forces
     *
     * @param entity       The &lt;code&gt;Entity&lt;/code&gt; that should make the PSR
     * @param targetNumber The &lt;code&gt;int&lt;/code&gt; to be used for this PSR.
     */
    private void resistGForce(Entity entity, int targetNumber) {
        // okay, print the info
<span class="nc" id="L11991">        Report r = new Report(9330);</span>
<span class="nc" id="L11992">        r.subject = entity.getId();</span>
<span class="nc" id="L11993">        r.addDesc(entity);</span>
<span class="nc" id="L11994">        addReport(r);</span>

        // roll
<span class="nc" id="L11997">        final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L11998">        r = new Report(9335);</span>
<span class="nc" id="L11999">        r.subject = entity.getId();</span>
<span class="nc" id="L12000">        r.add(Integer.toString(targetNumber));</span>
<span class="nc" id="L12001">        r.add(diceRoll);</span>
<span class="nc bnc" id="L12002" title="All 2 branches missed.">        if (diceRoll &lt; targetNumber) {</span>
<span class="nc" id="L12003">            r.choose(false);</span>
<span class="nc" id="L12004">            addReport(r);</span>
<span class="nc" id="L12005">            addReport(damageCrew(entity, 1));</span>
        } else {
<span class="nc" id="L12007">            r.choose(true);</span>
<span class="nc" id="L12008">            addReport(r);</span>
        }
<span class="nc" id="L12010">    }</span>

    /**
     * Do a piloting skill check in space to avoid structural damage
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that should make the PSR
     * @param roll   The &lt;code&gt;PilotingRollData&lt;/code&gt; to be used for this PSR.
     * @return true if check succeeds, false otherwise.
     */
    private boolean doSkillCheckInSpace(Entity entity, PilotingRollData roll) {
<span class="nc bnc" id="L12020" title="All 2 branches missed.">        if (roll.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L12021">            return true;</span>
        }

        // okay, print the info
<span class="nc" id="L12025">        Report r = new Report(9320);</span>
<span class="nc" id="L12026">        r.subject = entity.getId();</span>
<span class="nc" id="L12027">        r.addDesc(entity);</span>
<span class="nc" id="L12028">        r.add(roll.getLastPlainDesc(), true);</span>
<span class="nc" id="L12029">        addReport(r);</span>

        // roll
<span class="nc" id="L12032">        final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L12033">        r = new Report(9325);</span>
<span class="nc" id="L12034">        r.subject = entity.getId();</span>
<span class="nc" id="L12035">        r.add(roll.getValueAsString());</span>
<span class="nc" id="L12036">        r.add(roll.getDesc());</span>
<span class="nc" id="L12037">        r.add(diceRoll);</span>
        boolean suc;
<span class="nc bnc" id="L12039" title="All 2 branches missed.">        if (diceRoll &lt; roll.getValue()) {</span>
<span class="nc" id="L12040">            r.choose(false);</span>
<span class="nc" id="L12041">            addReport(r);</span>
<span class="nc" id="L12042">            suc = false;</span>
        } else {
<span class="nc" id="L12044">            r.choose(true);</span>
<span class="nc" id="L12045">            addReport(r);</span>
<span class="nc" id="L12046">            suc = true;</span>
        }

<span class="nc" id="L12049">        return suc;</span>
    }

    /**
     * Do a piloting skill check to take off vertically
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that should make the PSR
     * @param roll   The &lt;code&gt;PilotingRollData&lt;/code&gt; to be used for this PSR.
     * @return true if check succeeds, false otherwise.
     */
    private boolean doVerticalTakeOffCheck(Entity entity, PilotingRollData roll) {

<span class="nc bnc" id="L12061" title="All 2 branches missed.">        if (!entity.isAero()) {</span>
<span class="nc" id="L12062">            return false;</span>
        }

<span class="nc" id="L12065">        IAero a = (IAero) entity;</span>

<span class="nc bnc" id="L12067" title="All 2 branches missed.">        if (roll.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L12068">            return true;</span>
        }

        // okay, print the info
<span class="nc" id="L12072">        Report r = new Report(9320);</span>
<span class="nc" id="L12073">        r.subject = entity.getId();</span>
<span class="nc" id="L12074">        r.addDesc(entity);</span>
<span class="nc" id="L12075">        r.add(roll.getLastPlainDesc(), true);</span>
<span class="nc" id="L12076">        addReport(r);</span>

        // roll
<span class="nc" id="L12079">        final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L12080">        r = new Report(9321);</span>
<span class="nc" id="L12081">        r.subject = entity.getId();</span>
<span class="nc" id="L12082">        r.add(roll.getValueAsString());</span>
<span class="nc" id="L12083">        r.add(roll.getDesc());</span>
<span class="nc" id="L12084">        r.add(diceRoll);</span>
<span class="nc" id="L12085">        r.newlines = 0;</span>
<span class="nc" id="L12086">        addReport(r);</span>
<span class="nc" id="L12087">        boolean suc = false;</span>
<span class="nc bnc" id="L12088" title="All 2 branches missed.">        if (diceRoll &lt; roll.getValue()) {</span>
<span class="nc" id="L12089">            int mof = roll.getValue() - diceRoll;</span>
<span class="nc bnc" id="L12090" title="All 2 branches missed.">            if (mof &lt; 3) {</span>
<span class="nc" id="L12091">                r = new Report(9322);</span>
<span class="nc" id="L12092">                r.subject = entity.getId();</span>
<span class="nc" id="L12093">                addReport(r);</span>
<span class="nc" id="L12094">                suc = true;</span>
<span class="nc bnc" id="L12095" title="All 2 branches missed.">            } else if (mof &lt; 5) {</span>
<span class="nc" id="L12096">                PilotingRollData newRoll = entity.getBasePilotingRoll();</span>
<span class="nc bnc" id="L12097" title="All 2 branches missed.">                if (Compute.d6(2) &gt;= newRoll.getValue()) {</span>
<span class="nc" id="L12098">                    r = new Report(9322);</span>
<span class="nc" id="L12099">                    r.subject = entity.getId();</span>
<span class="nc" id="L12100">                    addReport(r);</span>
<span class="nc" id="L12101">                    suc = true;</span>
                } else {
<span class="nc" id="L12103">                    r = new Report(9323);</span>
<span class="nc" id="L12104">                    r.subject = entity.getId();</span>
<span class="nc" id="L12105">                    addReport(r);</span>
<span class="nc" id="L12106">                    int damage = 20;</span>
<span class="nc bnc" id="L12107" title="All 2 branches missed.">                    while (damage &gt; 0) {</span>
<span class="nc" id="L12108">                        addReport(damageEntity(entity, entity.rollHitLocation(ToHitData.HIT_NORMAL,</span>
<span class="nc" id="L12109">                                ToHitData.SIDE_REAR), Math.min(5, damage)));</span>
<span class="nc" id="L12110">                        damage -= 5;</span>
                    }
                }
<span class="nc bnc" id="L12113" title="All 2 branches missed.">            } else if (mof &lt; 6) {</span>
<span class="nc" id="L12114">                r = new Report(9323);</span>
<span class="nc" id="L12115">                r.subject = entity.getId();</span>
<span class="nc" id="L12116">                addReport(r);</span>
<span class="nc" id="L12117">                int damage = 50;</span>
<span class="nc bnc" id="L12118" title="All 2 branches missed.">                while (damage &gt; 0) {</span>
<span class="nc" id="L12119">                    addReport(damageEntity(entity, entity.rollHitLocation(ToHitData.HIT_NORMAL,</span>
<span class="nc" id="L12120">                            ToHitData.SIDE_REAR), Math.min(5, damage)));</span>
<span class="nc" id="L12121">                    damage -= 5;</span>
                }
<span class="nc" id="L12123">            } else {</span>
<span class="nc" id="L12124">                r = new Report(9323);</span>
<span class="nc" id="L12125">                r.subject = entity.getId();</span>
<span class="nc" id="L12126">                addReport(r);</span>
<span class="nc" id="L12127">                int damage = 100;</span>
<span class="nc bnc" id="L12128" title="All 2 branches missed.">                while (damage &gt; 0) {</span>
<span class="nc" id="L12129">                    addReport(damageEntity(entity, entity.rollHitLocation(ToHitData.HIT_NORMAL,</span>
<span class="nc" id="L12130">                            ToHitData.SIDE_REAR), Math.min(5, damage)));</span>
<span class="nc" id="L12131">                    damage -= 5;</span>
                }
            }
<span class="nc" id="L12134">            a.setGearHit(true);</span>
<span class="nc" id="L12135">            r = new Report(9125);</span>
<span class="nc" id="L12136">            r.subject = entity.getId();</span>
<span class="nc" id="L12137">            addReport(r);</span>
<span class="nc" id="L12138">        } else {</span>
<span class="nc" id="L12139">            r = new Report(9322);</span>
<span class="nc" id="L12140">            r.subject = entity.getId();</span>
<span class="nc" id="L12141">            addReport(r);</span>
<span class="nc" id="L12142">            suc = true;</span>
        }

<span class="nc" id="L12145">        return suc;</span>
    }

    /**
     * Do a piloting skill check in space to do a successful maneuver Failure
     * means moving forward half velocity
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that should make the PSR
     * @param roll   The &lt;code&gt;PilotingRollData&lt;/code&gt; to be used for this PSR.
     * @return true if check succeeds, false otherwise.
     */
    private boolean doSkillCheckManeuver(Entity entity, PilotingRollData roll) {
<span class="nc bnc" id="L12157" title="All 2 branches missed.">        if (roll.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L12158">            return true;</span>
        }

        // okay, print the info
<span class="nc" id="L12162">        Report r = new Report(9600);</span>
<span class="nc" id="L12163">        r.subject = entity.getId();</span>
<span class="nc" id="L12164">        r.addDesc(entity);</span>
<span class="nc" id="L12165">        r.add(roll.getLastPlainDesc(), true);</span>
<span class="nc" id="L12166">        addReport(r);</span>

        // roll
<span class="nc" id="L12169">        final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L12170">        r = new Report(9601);</span>
<span class="nc" id="L12171">        r.subject = entity.getId();</span>
<span class="nc" id="L12172">        r.add(roll.getValueAsString());</span>
<span class="nc" id="L12173">        r.add(roll.getDesc());</span>
<span class="nc" id="L12174">        r.add(diceRoll);</span>
        boolean suc;
<span class="nc bnc" id="L12176" title="All 2 branches missed.">        if (diceRoll &lt; roll.getValue()) {</span>
<span class="nc" id="L12177">            r.choose(false);</span>
<span class="nc" id="L12178">            addReport(r);</span>
<span class="nc" id="L12179">            suc = false;</span>
        } else {
<span class="nc" id="L12181">            r.choose(true);</span>
<span class="nc" id="L12182">            addReport(r);</span>
<span class="nc" id="L12183">            suc = true;</span>
        }

<span class="nc" id="L12186">        return suc;</span>
    }

    /**
     * Do a piloting skill check while standing still (during the movement
     * phase).
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that should make the PSR
     * @param roll   The &lt;code&gt;PilotingRollData&lt;/code&gt; to be used for this PSR.
     * @return true if check succeeds, false otherwise.
     */
    private boolean doSkillCheckInPlace(Entity entity, PilotingRollData roll) {
<span class="nc bnc" id="L12198" title="All 2 branches missed.">        if (roll.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L12199">            return true;</span>
        }

<span class="nc bnc" id="L12202" title="All 2 branches missed.">        if (entity.isProne()) {</span>
<span class="nc" id="L12203">            return true;</span>
        }

        // okay, print the info
<span class="nc" id="L12207">        Report r = new Report(2180);</span>
<span class="nc" id="L12208">        r.subject = entity.getId();</span>
<span class="nc" id="L12209">        r.addDesc(entity);</span>
<span class="nc" id="L12210">        r.add(roll.getLastPlainDesc(), true);</span>
<span class="nc" id="L12211">        addReport(r);</span>

        // roll
<span class="nc" id="L12214">        final int diceRoll = entity.getCrew().rollPilotingSkill();</span>
<span class="nc" id="L12215">        r = new Report(2185);</span>
<span class="nc" id="L12216">        r.subject = entity.getId();</span>
<span class="nc" id="L12217">        r.add(roll.getValueAsString());</span>
<span class="nc" id="L12218">        r.add(roll.getDesc());</span>
<span class="nc" id="L12219">        r.add(diceRoll);</span>
        boolean suc;
<span class="nc bnc" id="L12221" title="All 2 branches missed.">        if (diceRoll &lt; roll.getValue()) {</span>
<span class="nc" id="L12222">            r.choose(false);</span>
<span class="nc" id="L12223">            addReport(r);</span>
<span class="nc bnc" id="L12224" title="All 2 branches missed.">            if ((entity instanceof Mech)</span>
<span class="nc bnc" id="L12225" title="All 2 branches missed.">                &amp;&amp; game.getOptions().booleanOption(</span>
                    OptionsConstants.ADVGRNDMOV_TACOPS_FALLING_EXPANDED)
<span class="nc bnc" id="L12227" title="All 2 branches missed.">                &amp;&amp; (entity.getCrew().getPiloting() &lt; 6)</span>
<span class="nc bnc" id="L12228" title="All 4 branches missed.">                &amp;&amp; !entity.isHullDown() &amp;&amp; entity.canGoHullDown()) {</span>
<span class="nc bnc" id="L12229" title="All 4 branches missed.">                if ((entity.getCrew().getPiloting() &gt; 1) &amp;&amp; ((roll.getValue() - diceRoll) &lt; 2)) {</span>
<span class="nc" id="L12230">                    entity.setHullDown(true);</span>
<span class="nc bnc" id="L12231" title="All 2 branches missed.">                } else if ((entity.getCrew().getPiloting() &lt;= 1)</span>
<span class="nc bnc" id="L12232" title="All 2 branches missed.">                        &amp;&amp; ((roll.getValue() - diceRoll) &lt; 3)) {</span>
<span class="nc" id="L12233">                    entity.setHullDown(true);</span>
                }
            }
<span class="nc bnc" id="L12236" title="All 2 branches missed.">            if (!entity.isHullDown()</span>
<span class="nc bnc" id="L12237" title="All 4 branches missed.">                || (entity.isHullDown() &amp;&amp; !entity.canGoHullDown())) {</span>
<span class="nc" id="L12238">                addReport(doEntityFall(entity, roll));</span>
            } else {
<span class="nc" id="L12240">                ServerHelper.sinkToBottom(entity);</span>
                
<span class="nc" id="L12242">                r = new Report(2317);</span>
<span class="nc" id="L12243">                r.subject = entity.getId();</span>
<span class="nc" id="L12244">                r.add(entity.getDisplayName());</span>
<span class="nc" id="L12245">                addReport(r);</span>
            }

<span class="nc" id="L12248">            suc = false;</span>
            // failed a PSR, possibly check for engine stalling
<span class="nc" id="L12250">            entity.doCheckEngineStallRoll(vPhaseReport);</span>
        } else {
<span class="nc" id="L12252">            r.choose(true);</span>
<span class="nc" id="L12253">            addReport(r);</span>
<span class="nc" id="L12254">            suc = true;</span>
        }

<span class="nc" id="L12257">        return suc;</span>
    }

    /**
     * Do a Piloting Skill check to dislodge swarming infantry.
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that is doing the dislodging.
     * @param roll   The &lt;code&gt;PilotingRollData&lt;/code&gt; for this PSR.
     * @param curPos The &lt;code&gt;Coords&lt;/code&gt; the entity is at.
     * @return &lt;code&gt;true&lt;/code&gt; if the dislodging is successful.
     */
    private boolean doDislodgeSwarmerSkillCheck(Entity entity, PilotingRollData roll, Coords curPos) {
        // okay, print the info
<span class="nc" id="L12270">        Report r = new Report(2180);</span>
<span class="nc" id="L12271">        r.subject = entity.getId();</span>
<span class="nc" id="L12272">        r.addDesc(entity);</span>
<span class="nc" id="L12273">        r.add(roll.getLastPlainDesc(), true);</span>
<span class="nc" id="L12274">        addReport(r);</span>

        // roll
<span class="nc" id="L12277">        final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L12278">        r = new Report(2190);</span>
<span class="nc" id="L12279">        r.subject = entity.getId();</span>
<span class="nc" id="L12280">        r.add(roll.getValueAsString());</span>
<span class="nc" id="L12281">        r.add(roll.getDesc());</span>
<span class="nc" id="L12282">        r.add(diceRoll);</span>
<span class="nc bnc" id="L12283" title="All 2 branches missed.">        if (diceRoll &lt; roll.getValue()) {</span>
<span class="nc" id="L12284">            r.choose(false);</span>
<span class="nc" id="L12285">            addReport(r);</span>
            // failed a PSR, possibly check for engine stalling
<span class="nc" id="L12287">            entity.doCheckEngineStallRoll(vPhaseReport);</span>
<span class="nc" id="L12288">            return false;</span>
        }
        // Dislodged swarmers don't get turns.
<span class="nc" id="L12291">        int swarmerId = entity.getSwarmAttackerId();</span>
<span class="nc" id="L12292">        final Entity swarmer = game.getEntity(swarmerId);</span>
<span class="nc bnc" id="L12293" title="All 2 branches missed.">        if (!swarmer.isDone()) {</span>
<span class="nc" id="L12294">            game.removeTurnFor(swarmer);</span>
<span class="nc" id="L12295">            swarmer.setDone(true);</span>
<span class="nc" id="L12296">            send(createTurnVectorPacket());</span>
        }

        // Update the report and cause a fall.
<span class="nc" id="L12300">        r.choose(true);</span>
<span class="nc" id="L12301">        addReport(r);</span>
<span class="nc" id="L12302">        entity.setPosition(curPos);</span>
<span class="nc" id="L12303">        addReport(doEntityFallsInto(entity, curPos, roll, false));</span>
<span class="nc" id="L12304">        return true;</span>
    }

    /**
     * Do a piloting skill check while moving.
     *
     * @param entity          - the &lt;code&gt;Entity&lt;/code&gt; that must roll.
     * @param entityElevation The elevation of the supplied Entity above the surface of the
     *                        src hex. This is necessary as the state of the Entity may
     *                        represent the elevation of the entity about the surface of the
     *                        destination hex.
     * @param src             - the &lt;code&gt;Coords&lt;/code&gt; the entity is moving from.
     * @param dest            - the &lt;code&gt;Coords&lt;/code&gt; the entity is moving to. This value
     *                        can be the same as src for in-place checks.
     * @param roll            - the &lt;code&gt;PilotingRollData&lt;/code&gt; that is causing this
     *                        check.
     * @param isFallRoll      - a &lt;code&gt;boolean&lt;/code&gt; flag that indicates that failure will
     *                        result in a fall or not. Falls will be processed.
     * @return Margin of Failure if the pilot fails the skill check, 0 if they
     * pass.
     */
    private int doSkillCheckWhileMoving(Entity entity, int entityElevation,
            Coords src, Coords dest, PilotingRollData roll, boolean isFallRoll) {
        boolean fallsInPlace;

        // Start the info for this roll.
<span class="nc" id="L12330">        Report r = new Report(1210);</span>
<span class="nc" id="L12331">        r.subject = entity.getId();</span>
<span class="nc" id="L12332">        r.addDesc(entity);</span>

        // Will the entity fall in the source or destination hex?
<span class="nc bnc" id="L12335" title="All 2 branches missed.">        if (src.equals(dest)) {</span>
<span class="nc" id="L12336">            fallsInPlace = true;</span>
<span class="nc" id="L12337">            r.messageId = 2195;</span>
<span class="nc" id="L12338">            r.add(src.getBoardNum(), true);</span>
        } else {
<span class="nc" id="L12340">            fallsInPlace = false;</span>
<span class="nc" id="L12341">            r.messageId = 2200;</span>
<span class="nc" id="L12342">            r.add(src.getBoardNum(), true);</span>
<span class="nc" id="L12343">            r.add(dest.getBoardNum(), true);</span>
        }

        // Finish the info.
<span class="nc" id="L12347">        r.add(roll.getLastPlainDesc(), true);</span>
<span class="nc" id="L12348">        addReport(r);</span>

        // roll
<span class="nc" id="L12351">        final int diceRoll = entity.getCrew().rollPilotingSkill();</span>
<span class="nc" id="L12352">        r = new Report(2185);</span>
<span class="nc" id="L12353">        r.subject = entity.getId();</span>
<span class="nc" id="L12354">        r.add(roll.getValueAsString());</span>
<span class="nc" id="L12355">        r.add(roll.getDesc());</span>
<span class="nc" id="L12356">        r.add(diceRoll);</span>
<span class="nc bnc" id="L12357" title="All 2 branches missed.">        if (diceRoll &lt; roll.getValue()) {</span>
            // Does failing the PSR result in a fall.
<span class="nc bnc" id="L12359" title="All 4 branches missed.">            if (isFallRoll &amp;&amp; entity.canFall()) {</span>
<span class="nc" id="L12360">                r.choose(false);</span>
<span class="nc" id="L12361">                addReport(r);</span>
<span class="nc" id="L12362">                addReport(doEntityFallsInto(entity, entityElevation,</span>
<span class="nc bnc" id="L12363" title="All 4 branches missed.">                                            fallsInPlace ? dest : src, fallsInPlace ? src : dest,</span>
                                            roll, true));
            } else {
<span class="nc" id="L12366">                r.messageId = 2190;</span>
<span class="nc" id="L12367">                r.choose(false);</span>
<span class="nc" id="L12368">                addReport(r);</span>
<span class="nc bnc" id="L12369" title="All 2 branches missed.">                entity.setPosition(fallsInPlace ? src : dest);</span>
            }
            // failed a PSR, possibly check for engine stalling
<span class="nc" id="L12372">            entity.doCheckEngineStallRoll(vPhaseReport);</span>
<span class="nc" id="L12373">            return roll.getValue() - diceRoll;</span>
        }
<span class="nc" id="L12375">        r.choose(true);</span>
<span class="nc" id="L12376">        r.newlines = 2;</span>
<span class="nc" id="L12377">        addReport(r);</span>
<span class="nc" id="L12378">        return 0;</span>
    }

    /**
     * Process a fall when the source and destination hexes are the same.
     * Depending on the elevations of the hexes, the Entity could land in the
     * source or destination hexes. Check for any conflicts and resolve them.
     * Deal damage to faller. Note: the elevation of the entity is used to
     * determine fall distance, so it is important to ensure the Entity's
     * elevation is correct.
     *
     * @param entity    The &lt;code&gt;Entity&lt;/code&gt; that is falling.
     * @param src       The &lt;code&gt;Coords&lt;/code&gt; of the source hex.
     * @param roll      The &lt;code&gt;PilotingRollData&lt;/code&gt; to be used for PSRs induced
     *                  by the falling.
     * @param causeAffa The &lt;code&gt;boolean&lt;/code&gt; value whether this fall should be able
     *                  to cause an accidental fall from above
     */
    private Vector&lt;Report&gt; doEntityFallsInto(Entity entity, Coords src,
                                             PilotingRollData roll, boolean causeAffa) {
<span class="nc" id="L12398">        return doEntityFallsInto(entity, entity.getElevation(), src, src, roll,</span>
                                 causeAffa);
    }

    /**
     * Process a fall when moving from the source hex to the destination hex.
     * Depending on the elevations of the hexes, the Entity could land in the
     * source or destination hexes. Check for any conflicts and resolve them.
     * Deal damage to faller. Note: the elevation of the entity is used to
     * determine fall distance, so it is important to ensure the Entity's
     * elevation is correct.
     *
     * @param entity             The &lt;code&gt;Entity&lt;/code&gt; that is falling.
     * @param entitySrcElevation The elevation of the supplied Entity above the surface of the
     *                           src hex. This is necessary as the state of the Entity may
     *                           represent the elevation of the entity about the surface of the
     *                           destination hex.
     * @param src                The &lt;code&gt;Coords&lt;/code&gt; of the source hex.
     * @param dest               The &lt;code&gt;Coords&lt;/code&gt; of the destination hex.
     * @param roll               The &lt;code&gt;PilotingRollData&lt;/code&gt; to be used for PSRs induced
     *                           by the falling.
     * @param causeAffa          The &lt;code&gt;boolean&lt;/code&gt; value whether this fall should be able
     *                           to cause an accidental fall from above
     */
    private Vector&lt;Report&gt; doEntityFallsInto(Entity entity,
                                             int entitySrcElevation, Coords src, Coords dest,
                                             PilotingRollData roll, boolean causeAffa) {
<span class="nc" id="L12425">        return doEntityFallsInto(entity, entitySrcElevation, src, dest, roll,</span>
                                 causeAffa, 0);
    }

    /**
     * Process a fall when moving from the source hex to the destination hex.
     * Depending on the elevations of the hexes, the Entity could land in the
     * source or destination hexes. Check for any conflicts and resolve them.
     * Deal damage to faller.
     *
     * @param entity             The &lt;code&gt;Entity&lt;/code&gt; that is falling.
     * @param entitySrcElevation The elevation of the supplied Entity above the surface of the
     *                           src hex. This is necessary as the state of the Entity may
     *                           represent the elevation of the entity about the surface of the
     *                           destination hex.
     * @param origSrc            The &lt;code&gt;Coords&lt;/code&gt; of the original source hex.
     * @param origDest           The &lt;code&gt;Coords&lt;/code&gt; of the original destination hex.
     * @param roll               The &lt;code&gt;PilotingRollData&lt;/code&gt; to be used for PSRs induced
     *                           by the falling.
     * @param causeAffa          The &lt;code&gt;boolean&lt;/code&gt; value whether this fall should be able
     *                           to cause an accidental fall from above
     * @param fallReduction      An integer value to reduce the fall distance by
     */
    private Vector&lt;Report&gt; doEntityFallsInto(Entity entity,
                                             int entitySrcElevation, Coords origSrc, Coords origDest,
                                             PilotingRollData roll, boolean causeAffa, int fallReduction) {
<span class="nc" id="L12451">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L12452">        IHex srcHex = game.getBoard().getHex(origSrc);</span>
<span class="nc" id="L12453">        IHex destHex = game.getBoard().getHex(origDest);</span>
        Coords src, dest;
        // We need to fall into the lower of the two hexes, TW pg 68
<span class="nc bnc" id="L12456" title="All 2 branches missed.">        if (srcHex.getLevel() &lt; destHex.getLevel()) {</span>
<span class="nc" id="L12457">            IHex swapHex = destHex;</span>
<span class="nc" id="L12458">            destHex = srcHex;</span>
<span class="nc" id="L12459">            srcHex = swapHex;</span>
<span class="nc" id="L12460">            src = origDest;</span>
<span class="nc" id="L12461">            dest = origSrc;</span>
<span class="nc" id="L12462">        } else {</span>
<span class="nc" id="L12463">            src = origSrc;</span>
<span class="nc" id="L12464">            dest = origDest;</span>
        }
<span class="nc" id="L12466">        final int srcHeightAboveFloor = entitySrcElevation + srcHex.depth(false);</span>
<span class="nc" id="L12467">        int fallElevation = Math.abs((srcHex.floor() + srcHeightAboveFloor)</span>
<span class="nc bnc" id="L12468" title="All 2 branches missed.">                - (destHex.containsTerrain(Terrains.ICE) ? destHex.surface() : destHex.floor()))</span>
                - fallReduction;
<span class="nc bnc" id="L12470" title="All 2 branches missed.">        if (destHex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L12471">            fallElevation -= destHex.terrainLevel(Terrains.BLDG_ELEV);</span>
        }
<span class="nc bnc" id="L12473" title="All 2 branches missed.">        if (destHex.containsTerrain(Terrains.BLDG_BASEMENT_TYPE)) {</span>
<span class="nc bnc" id="L12474" title="All 2 branches missed.">            if (entity.getElevation() == 0) { // floor 0 falling into basement</span>
<span class="nc" id="L12475">                fallElevation = destHex.depth(true);</span>
            }
        }

        int direction;
<span class="nc bnc" id="L12480" title="All 2 branches missed.">        if (src.equals(dest)) {</span>
<span class="nc" id="L12481">            direction = Compute.d6() - 1;</span>
        } else {
<span class="nc" id="L12483">            direction = src.direction(dest);</span>
        }
        Report r;
        // check entity in target hex
<span class="nc" id="L12487">        Entity affaTarget = game.getAffaTarget(dest, entity);</span>
        // falling mech falls
<span class="nc" id="L12489">        r = new Report(2205);</span>
<span class="nc" id="L12490">        r.subject = entity.getId();</span>
<span class="nc" id="L12491">        r.addDesc(entity);</span>
<span class="nc" id="L12492">        r.add(fallElevation);</span>
<span class="nc" id="L12493">        r.add(dest.getBoardNum(), true);</span>
<span class="nc" id="L12494">        r.newlines = 0;</span>

        // if hex was empty, deal damage and we're done
<span class="nc bnc" id="L12497" title="All 2 branches missed.">        if (affaTarget == null) {</span>
<span class="nc" id="L12498">            r.newlines = 1;</span>
<span class="nc" id="L12499">            vPhaseReport.add(r);</span>
            // If we rolled for the direction, we want to use that for the fall
<span class="nc bnc" id="L12501" title="All 2 branches missed.">            if (src.equals(dest)) {</span>
<span class="nc" id="L12502">                vPhaseReport.addAll(doEntityFall(entity, dest, fallElevation,</span>
<span class="nc" id="L12503">                                                 direction, roll, false, srcHex.hasCliffTopTowards(destHex)));</span>
            } else {
                // Otherwise, we'll roll for the direction after the fall
<span class="nc" id="L12506">                vPhaseReport.addAll(doEntityFall(entity, dest, fallElevation, roll));</span>
            }

<span class="nc" id="L12509">            return vPhaseReport;</span>
        }
<span class="nc" id="L12511">        vPhaseReport.add(r);</span>

        // hmmm... somebody there... problems.
<span class="nc bnc" id="L12514" title="All 4 branches missed.">        if ((fallElevation &gt;= 2) &amp;&amp; causeAffa) {</span>
            // accidental fall from above: havoc!
<span class="nc" id="L12516">            r = new Report(2210);</span>
<span class="nc" id="L12517">            r.subject = entity.getId();</span>
<span class="nc" id="L12518">            r.addDesc(affaTarget);</span>
<span class="nc" id="L12519">            vPhaseReport.add(r);</span>

            // determine to-hit number
<span class="nc" id="L12522">            ToHitData toHit = new ToHitData(7, &quot;base&quot;);</span>
<span class="nc bnc" id="L12523" title="All 4 branches missed.">            if ((affaTarget instanceof Tank) || (affaTarget instanceof Dropship)) {</span>
<span class="nc" id="L12524">                toHit = new ToHitData(TargetRoll.AUTOMATIC_SUCCESS, &quot;Target is a Tank&quot;);</span>
            } else {
<span class="nc" id="L12526">                toHit.append(Compute.getTargetMovementModifier(game, affaTarget.getId()));</span>
<span class="nc" id="L12527">                toHit.append(Compute.getTargetTerrainModifier(game, affaTarget));</span>
            }

<span class="nc bnc" id="L12530" title="All 2 branches missed.">            if (toHit.getValue() != TargetRoll.AUTOMATIC_FAIL) {</span>
                // collision roll
<span class="nc" id="L12532">                final int diceRoll = Compute.d6(2);</span>
<span class="nc bnc" id="L12533" title="All 2 branches missed.">                if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L12534">                    r = new Report(2212);</span>
<span class="nc" id="L12535">                    r.add(toHit.getValue());</span>
                } else {
<span class="nc" id="L12537">                    r = new Report(2215);</span>
<span class="nc" id="L12538">                    r.subject = entity.getId();</span>
<span class="nc" id="L12539">                    r.add(toHit.getValue());</span>
<span class="nc" id="L12540">                    r.add(diceRoll);</span>
<span class="nc" id="L12541">                    r.newlines = 0;</span>
                }
<span class="nc" id="L12543">                r.indent();</span>
<span class="nc" id="L12544">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L12545" title="All 2 branches missed.">                if (diceRoll &gt;= toHit.getValue()) {</span>
                    // deal damage to target
<span class="nc" id="L12547">                    int damage = Compute.getAffaDamageFor(entity);</span>
<span class="nc" id="L12548">                    r = new Report(2220);</span>
<span class="nc" id="L12549">                    r.subject = affaTarget.getId();</span>
<span class="nc" id="L12550">                    r.addDesc(affaTarget);</span>
<span class="nc" id="L12551">                    r.add(damage);</span>
<span class="nc" id="L12552">                    vPhaseReport.add(r);</span>
<span class="nc bnc" id="L12553" title="All 2 branches missed.">                    while (damage &gt; 0) {</span>
<span class="nc" id="L12554">                        int cluster = Math.min(5, damage);</span>
<span class="nc" id="L12555">                        HitData hit = affaTarget.rollHitLocation(ToHitData.HIT_PUNCH, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L12556">                        hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L12557">                        vPhaseReport.addAll(damageEntity(affaTarget, hit, cluster));</span>
<span class="nc" id="L12558">                        damage -= cluster;</span>
<span class="nc" id="L12559">                    }</span>

                    // attacker falls as normal, on his back
                    // only given a modifier, so flesh out into a full piloting
                    // roll
<span class="nc" id="L12564">                    PilotingRollData pilotRoll = entity.getBasePilotingRoll();</span>
<span class="nc" id="L12565">                    pilotRoll.append(roll);</span>
<span class="nc" id="L12566">                    vPhaseReport.addAll(doEntityFall(entity, dest,</span>
                            fallElevation, 3, pilotRoll, false, false));
<span class="nc" id="L12568">                    vPhaseReport.addAll(doEntityDisplacementMinefieldCheck(</span>
<span class="nc" id="L12569">                            entity, src, dest, entity.getElevation()));</span>

                    // defender pushed away, or destroyed, if there is a
                    // stacking violation
<span class="nc" id="L12573">                    Entity violation = Compute.stackingViolation(game, entity.getId(), dest);</span>
<span class="nc bnc" id="L12574" title="All 2 branches missed.">                    if (violation != null) {</span>
<span class="nc" id="L12575">                        PilotingRollData prd = new PilotingRollData(violation.getId(), 2,</span>
                                &quot;fallen on&quot;);
<span class="nc bnc" id="L12577" title="All 2 branches missed.">                        if (violation instanceof Dropship) {</span>
<span class="nc" id="L12578">                            violation = entity;</span>
<span class="nc" id="L12579">                            prd = null;</span>
                        }
<span class="nc" id="L12581">                        Coords targetDest = Compute.getValidDisplacement(game, violation.getId(),</span>
                                dest, direction);
<span class="nc bnc" id="L12583" title="All 2 branches missed.">                        if (targetDest != null) {</span>
<span class="nc" id="L12584">                            vPhaseReport.addAll(doEntityDisplacement(violation, dest, targetDest, prd));</span>
                            // Update the violating entity's position on the
                            // client.
<span class="nc" id="L12587">                            entityUpdate(violation.getId());</span>
                        } else {
                            // ack! automatic death! Tanks
                            // suffer an ammo/power plant hit.
                            // TODO : a Mech suffers a Head Blown Off crit.
<span class="nc" id="L12592">                            vPhaseReport.addAll(destroyEntity(violation, &quot;impossible displacement&quot;,</span>
                                    violation instanceof Mech, violation instanceof Mech));
                        }
                    }
<span class="nc" id="L12596">                    return vPhaseReport;</span>
                }
<span class="nc" id="L12598">            } else {</span>
                // automatic miss
<span class="nc" id="L12600">                r = new Report(2213);</span>
<span class="nc" id="L12601">                r.add(toHit.getDesc());</span>
<span class="nc" id="L12602">                vPhaseReport.add(r);</span>
            }
            // ok, we missed, let's fall into a valid other hex and not cause an
            // AFFA while doing so
<span class="nc" id="L12606">            Coords targetDest = Compute.getValidDisplacement(game, entity.getId(), dest, direction);</span>
<span class="nc bnc" id="L12607" title="All 2 branches missed.">            if (targetDest != null) {</span>
<span class="nc" id="L12608">                vPhaseReport.addAll(doEntityFallsInto(entity, entitySrcElevation, src, targetDest,</span>
<span class="nc" id="L12609">                        new PilotingRollData(entity.getId(),</span>
                                TargetRoll.IMPOSSIBLE,
                                &quot;pushed off a cliff&quot;),
                        false));
                // Update the entity's position on the client.
<span class="nc" id="L12614">                entityUpdate(entity.getId());</span>
            } else {
                // ack! automatic death! Tanks
                // suffer an ammo/power plant hit.
                // TODO : a Mech suffers a Head Blown Off crit.
<span class="nc" id="L12619">                vPhaseReport.addAll(destroyEntity(entity,</span>
                        &quot;impossible displacement&quot;, entity instanceof Mech, entity instanceof Mech));
            }
<span class="nc" id="L12622">        } else {</span>
            // damage as normal
<span class="nc" id="L12624">            vPhaseReport.addAll(doEntityFall(entity, dest, fallElevation, roll));</span>
<span class="nc" id="L12625">            Entity violation = Compute.stackingViolation(game, entity.getId(), dest);</span>
<span class="nc bnc" id="L12626" title="All 2 branches missed.">            if (violation != null) {</span>
<span class="nc" id="L12627">                PilotingRollData prd = new PilotingRollData(violation.getId(), 0, &quot;domino effect&quot;);</span>
<span class="nc bnc" id="L12628" title="All 2 branches missed.">                if (violation instanceof Dropship) {</span>
<span class="nc" id="L12629">                    violation = entity;</span>
<span class="nc" id="L12630">                    prd = null;</span>
                }
                // target gets displaced, because of low elevation
<span class="nc" id="L12633">                Coords targetDest = Compute.getValidDisplacement(game, violation.getId(), dest, direction);</span>
<span class="nc" id="L12634">                vPhaseReport.addAll(doEntityDisplacement(violation, dest, targetDest, prd));</span>
                // Update the violating entity's position on the client.
<span class="nc bnc" id="L12636" title="All 2 branches missed.">                if (!game.getOutOfGameEntitiesVector().contains(violation)) {</span>
<span class="nc" id="L12637">                    entityUpdate(violation.getId());</span>
                }
            }
        }
<span class="nc" id="L12641">        return vPhaseReport;</span>
    }

    /**
     * Displace a unit in the direction specified. The unit moves in that
     * direction, and the piloting skill roll is used to determine if it falls.
     * The roll may be unnecessary as certain situations indicate an automatic
     * fall. Rolls are added to the piloting roll list.
     */
    private Vector&lt;Report&gt; doEntityDisplacement(Entity entity, Coords src,
            Coords dest, PilotingRollData roll) {
<span class="nc" id="L12652">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc bnc" id="L12654" title="All 2 branches missed.">        if (!game.getBoard().contains(dest)) {</span>
            // set position anyway, for pushes moving through, stuff like that
<span class="nc" id="L12656">            entity.setPosition(dest);</span>
<span class="nc bnc" id="L12657" title="All 2 branches missed.">            if (!entity.isDoomed()) {</span>
                // Make sure there aren't any specific entity turns for entity
<span class="nc" id="L12659">                int turnsRemoved = game.removeSpecificEntityTurnsFor(entity);</span>
                // May need to remove a turn for this Entity
<span class="nc bnc" id="L12661" title="All 2 branches missed.">                if ((game.getPhase() == Phase.PHASE_MOVEMENT)</span>
<span class="nc bnc" id="L12662" title="All 4 branches missed.">                        &amp;&amp; !entity.isDone() &amp;&amp; (turnsRemoved == 0)) {</span>
<span class="nc" id="L12663">                    game.removeTurnFor(entity);</span>
<span class="nc" id="L12664">                    send(createTurnVectorPacket());</span>
<span class="nc bnc" id="L12665" title="All 2 branches missed.">                } else if (turnsRemoved &gt; 0) {</span>
<span class="nc" id="L12666">                    send(createTurnVectorPacket());</span>
                }
<span class="nc" id="L12668">                game.removeEntity(entity.getId(), IEntityRemovalConditions.REMOVE_PUSHED);</span>
<span class="nc" id="L12669">                send(createRemoveEntityPacket(entity.getId(), IEntityRemovalConditions.REMOVE_PUSHED));</span>
                // entity forced from the field
<span class="nc" id="L12671">                r = new Report(2230);</span>
<span class="nc" id="L12672">                r.subject = entity.getId();</span>
<span class="nc" id="L12673">                r.addDesc(entity);</span>
<span class="nc" id="L12674">                vPhaseReport.add(r);</span>
                // TODO : remove passengers and swarmers.
            }
<span class="nc" id="L12677">            return vPhaseReport;</span>
        }
<span class="nc" id="L12679">        final IHex srcHex = game.getBoard().getHex(src);</span>
<span class="nc" id="L12680">        final IHex destHex = game.getBoard().getHex(dest);</span>
<span class="nc" id="L12681">        final int direction = src.direction(dest);</span>

        // Handle null hexes.
<span class="nc bnc" id="L12684" title="All 4 branches missed.">        if ((srcHex == null) || (destHex == null)) {</span>
<span class="nc" id="L12685">            MegaMek.getLogger().error(&quot;Can not displace &quot; + entity.getShortName()</span>
                    + &quot; from &quot; + src + &quot; to &quot; + dest + &quot;.&quot;);
<span class="nc" id="L12687">            return vPhaseReport;</span>
        }
<span class="nc bnc" id="L12689" title="All 2 branches missed.">        int bldgElev = destHex.containsTerrain(Terrains.BLDG_ELEV)</span>
<span class="nc" id="L12690">            ? destHex.terrainLevel(Terrains.BLDG_ELEV) : 0;</span>
<span class="nc" id="L12691">        int fallElevation = srcHex.surface() + entity.getElevation()</span>
<span class="nc" id="L12692">                - (destHex.surface() + bldgElev);</span>
<span class="nc bnc" id="L12693" title="All 2 branches missed.">        if (fallElevation &gt; 1) {</span>
<span class="nc bnc" id="L12694" title="All 2 branches missed.">            if (roll == null) {</span>
<span class="nc" id="L12695">                roll = entity.getBasePilotingRoll();</span>
            }
<span class="nc bnc" id="L12697" title="All 2 branches missed.">            if (!(entity.isAirborneVTOLorWIGE())) {</span>
<span class="nc" id="L12698">                vPhaseReport.addAll(doEntityFallsInto(entity, entity.getElevation(), src, dest,</span>
                        roll, true));
            } else {
<span class="nc" id="L12701">                entity.setPosition(dest);</span>
            }
<span class="nc" id="L12703">            return vPhaseReport;</span>
        }
        // unstick the entity if it was stuck in swamp
<span class="nc" id="L12706">        boolean wasStuck = entity.isStuck();</span>
<span class="nc" id="L12707">        entity.setStuck(false);</span>
<span class="nc" id="L12708">        int oldElev = entity.getElevation();</span>
        // move the entity into the new location gently
<span class="nc" id="L12710">        entity.setPosition(dest);</span>
<span class="nc" id="L12711">        entity.setElevation(entity.calcElevation(srcHex, destHex));</span>
<span class="nc" id="L12712">        Building bldg = game.getBoard().getBuildingAt(dest);</span>
<span class="nc bnc" id="L12713" title="All 2 branches missed.">        if (bldg != null) {</span>
<span class="nc bnc" id="L12714" title="All 2 branches missed.">            if (destHex.terrainLevel(Terrains.BLDG_ELEV) &gt; oldElev) {</span>
                // whoops, into the building we go
<span class="nc" id="L12716">                passBuildingWall(entity, game.getBoard().getBuildingAt(dest), src, dest, 1,</span>
                        &quot;displaced into&quot;,
<span class="nc bnc" id="L12718" title="All 2 branches missed.">                        Math.abs(entity.getFacing() - src.direction(dest)) == 3,</span>
                        entity.moved, true);
            }
<span class="nc" id="L12721">            checkBuildingCollapseWhileMoving(bldg, entity, dest);</span>
        }
        
<span class="nc" id="L12724">        ServerHelper.checkAndApplyMagmaCrust(destHex, entity.getElevation(), entity, dest, false, vPhaseReport, this);</span>
        
<span class="nc" id="L12726">        Entity violation = Compute.stackingViolation(game, entity.getId(), dest);</span>
<span class="nc bnc" id="L12727" title="All 2 branches missed.">        if (violation == null) {</span>
            // move and roll normally
<span class="nc" id="L12729">            r = new Report(2235);</span>
<span class="nc" id="L12730">            r.indent();</span>
<span class="nc" id="L12731">            r.subject = entity.getId();</span>
<span class="nc" id="L12732">            r.addDesc(entity);</span>
<span class="nc" id="L12733">            r.add(dest.getBoardNum(), true);</span>
        } else {
            // domino effect: move &amp; displace target
<span class="nc" id="L12736">            r = new Report(2240);</span>
<span class="nc" id="L12737">            r.indent();</span>
<span class="nc" id="L12738">            r.subject = entity.getId();</span>
<span class="nc" id="L12739">            r.addDesc(entity);</span>
<span class="nc" id="L12740">            r.add(dest.getBoardNum(), true);</span>
<span class="nc" id="L12741">            r.addDesc(violation);</span>
        }
<span class="nc" id="L12743">        vPhaseReport.add(r);</span>
        // trigger any special things for moving to the new hex
<span class="nc" id="L12745">        vPhaseReport.addAll(doEntityDisplacementMinefieldCheck(entity, src, dest, entity.getElevation()));</span>
<span class="nc" id="L12746">        vPhaseReport.addAll(doSetLocationsExposure(entity, destHex, false, entity.getElevation()));</span>
<span class="nc bnc" id="L12747" title="All 2 branches missed.">        if (destHex.containsTerrain(Terrains.BLDG_ELEV)</span>
<span class="nc bnc" id="L12748" title="All 2 branches missed.">            &amp;&amp; (entity.getElevation() == 0)) {</span>
<span class="nc" id="L12749">            bldg = game.getBoard().getBuildingAt(dest);</span>
<span class="nc bnc" id="L12750" title="All 2 branches missed.">            if (bldg.rollBasement(dest, game.getBoard(), vPhaseReport)) {</span>
<span class="nc" id="L12751">                sendChangedHex(dest);</span>
<span class="nc" id="L12752">                Vector&lt;Building&gt; buildings = new Vector&lt;&gt;();</span>
<span class="nc" id="L12753">                buildings.add(bldg);</span>
<span class="nc" id="L12754">                sendChangedBuildings(buildings);</span>
            }
        }

        // mechs that were stuck will automatically fall in their new hex
<span class="nc bnc" id="L12759" title="All 4 branches missed.">        if (wasStuck &amp;&amp; entity.canFall()) {</span>
<span class="nc bnc" id="L12760" title="All 2 branches missed.">            if (roll == null) {</span>
<span class="nc" id="L12761">                roll = entity.getBasePilotingRoll();</span>
            }
<span class="nc" id="L12763">            vPhaseReport.addAll(doEntityFall(entity, dest, 0, roll));</span>
        }
        // check bog-down conditions
<span class="nc" id="L12766">        vPhaseReport.addAll(doEntityDisplacementBogDownCheck(entity, dest, entity.getElevation()));</span>

<span class="nc bnc" id="L12768" title="All 2 branches missed.">        if (roll != null) {</span>
<span class="nc bnc" id="L12769" title="All 2 branches missed.">            if (entity.canFall()) {</span>
<span class="nc" id="L12770">                game.addPSR(roll);</span>
<span class="nc bnc" id="L12771" title="All 4 branches missed.">            } else if ((entity instanceof LandAirMech) &amp;&amp; entity.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L12772">                game.addControlRoll(roll);</span>
            }
        }

<span class="nc" id="L12776">        int waterDepth = destHex.terrainLevel(Terrains.WATER);</span>

<span class="nc bnc" id="L12778" title="All 4 branches missed.">        if (destHex.containsTerrain(Terrains.ICE) &amp;&amp; destHex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc bnc" id="L12779" title="All 2 branches missed.">            if (!(entity instanceof Infantry)) {</span>
<span class="nc" id="L12780">                int d6 = Compute.d6(1);</span>
<span class="nc" id="L12781">                r = new Report(2118);</span>
<span class="nc" id="L12782">                r.addDesc(entity);</span>
<span class="nc" id="L12783">                r.add(d6);</span>
<span class="nc" id="L12784">                r.subject = entity.getId();</span>
<span class="nc" id="L12785">                vPhaseReport.add(r);</span>

<span class="nc bnc" id="L12787" title="All 2 branches missed.">                if (d6 == 6) {</span>
<span class="nc" id="L12788">                    vPhaseReport.addAll(resolveIceBroken(dest));</span>
                }
<span class="nc" id="L12790">            }</span>
        }
        // Falling into water instantly destroys most non-mechs
<span class="nc bnc" id="L12793" title="All 6 branches missed.">        else if ((waterDepth &gt; 0)</span>
                &amp;&amp; !(entity instanceof Mech)
                &amp;&amp; !(entity instanceof Protomech)
<span class="nc bnc" id="L12796" title="All 4 branches missed.">                &amp;&amp; !((entity.getRunMP() &gt; 0) &amp;&amp; (entity.getMovementMode() == EntityMovementMode.HOVER))</span>
<span class="nc bnc" id="L12797" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() != EntityMovementMode.HYDROFOIL)</span>
<span class="nc bnc" id="L12798" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() != EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L12799" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() != EntityMovementMode.SUBMARINE)</span>
<span class="nc bnc" id="L12800" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() != EntityMovementMode.INF_UMU)) {</span>
<span class="nc" id="L12801">            vPhaseReport.addAll(destroyEntity(entity, &quot;a watery grave&quot;, false));</span>
<span class="nc bnc" id="L12802" title="All 2 branches missed.">        } else if ((waterDepth &gt; 0)</span>
<span class="nc bnc" id="L12803" title="All 2 branches missed.">                &amp;&amp; !(entity.getMovementMode() == EntityMovementMode.HOVER)) {</span>
<span class="nc" id="L12804">            PilotingRollData waterRoll = entity.checkWaterMove(waterDepth, entity.moved);</span>
<span class="nc bnc" id="L12805" title="All 2 branches missed.">            if (waterRoll.getValue() != TargetRoll.CHECK_FALSE) {</span>
<span class="nc" id="L12806">                doSkillCheckInPlace(entity, waterRoll);</span>
            }
        }
        // Update the entity's position on the client.
<span class="nc" id="L12810">        entityUpdate(entity.getId());</span>

<span class="nc bnc" id="L12812" title="All 2 branches missed.">        if (violation != null) {</span>
            // Can the violating unit move out of the way?
            // if the direction comes from a side, Entity didn't jump, and it
            // has MP left to use, it can try to move.
<span class="nc" id="L12816">            MovePath stepForward = new MovePath(game, violation);</span>
<span class="nc" id="L12817">            MovePath stepBackwards = new MovePath(game, violation);</span>
<span class="nc" id="L12818">            stepForward.addStep(MoveStepType.FORWARDS);</span>
<span class="nc" id="L12819">            stepBackwards.addStep(MoveStepType.BACKWARDS);</span>
<span class="nc" id="L12820">            stepForward.compile(getGame(), violation, false);</span>
<span class="nc" id="L12821">            stepBackwards.compile(getGame(), violation, false);</span>
<span class="nc bnc" id="L12822" title="All 2 branches missed.">            if ((direction != violation.getFacing())</span>
<span class="nc bnc" id="L12823" title="All 2 branches missed.">                    &amp;&amp; (direction != ((violation.getFacing() + 3) % 6))</span>
<span class="nc bnc" id="L12824" title="All 2 branches missed.">                    &amp;&amp; !entity.getIsJumpingNow()</span>
<span class="nc bnc" id="L12825" title="All 4 branches missed.">                    &amp;&amp; (stepForward.isMoveLegal() || stepBackwards.isMoveLegal())) {</span>
                // First, we need to make a PSR to see if we can step out
<span class="nc" id="L12827">                int result = Compute.d6(2);</span>
<span class="nc" id="L12828">                roll = entity.getBasePilotingRoll();</span>

<span class="nc" id="L12830">                r = new Report(2351);</span>
<span class="nc" id="L12831">                r.indent(2);</span>
<span class="nc" id="L12832">                r.subject = violation.getId();</span>
<span class="nc" id="L12833">                r.addDesc(violation);</span>
<span class="nc" id="L12834">                r.add(roll.getValue());</span>
<span class="nc" id="L12835">                r.add(result);</span>
<span class="nc" id="L12836">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L12837" title="All 2 branches missed.">                if (result &lt; roll.getValue()) {</span>
<span class="nc" id="L12838">                    r.choose(false);</span>
<span class="nc" id="L12839">                    Vector&lt;Report&gt; newReports = doEntityDisplacement(violation,</span>
<span class="nc" id="L12840">                            dest, dest.translated(direction),</span>
<span class="nc" id="L12841">                            new PilotingRollData(violation.getId(),</span>
                                    TargetRoll.AUTOMATIC_FAIL,
                                    &quot;failed to step out of a domino effect&quot;));
<span class="nc bnc" id="L12844" title="All 2 branches missed.">                    for (Report newReport : newReports) {</span>
<span class="nc" id="L12845">                        newReport.indent(3);</span>
<span class="nc" id="L12846">                    }</span>
<span class="nc" id="L12847">                    vPhaseReport.addAll(newReports);</span>
<span class="nc" id="L12848">                } else {</span>
<span class="nc" id="L12849">                    r.choose(true);</span>
<span class="nc" id="L12850">                    sendDominoEffectCFR(violation);</span>
<span class="nc" id="L12851">                    synchronized (cfrPacketQueue) {</span>
                        try {
<span class="nc" id="L12853">                            cfrPacketQueue.wait();</span>
<span class="nc" id="L12854">                        } catch (InterruptedException ignored) {</span>
                            // Do nothing
<span class="nc" id="L12856">                        }</span>
<span class="nc bnc" id="L12857" title="All 2 branches missed.">                        if (cfrPacketQueue.size() &gt; 0) {</span>
<span class="nc" id="L12858">                            ReceivedPacket rp = cfrPacketQueue.poll();</span>
<span class="nc" id="L12859">                            int cfrType = (int) rp.packet.getData()[0];</span>
                            // Make sure we got the right type of response
<span class="nc bnc" id="L12861" title="All 2 branches missed.">                            if (cfrType != Packet.COMMAND_CFR_DOMINO_EFFECT) {</span>
<span class="nc" id="L12862">                                MegaMek.getLogger().error(&quot;Excepted a COMMAND_CFR_DOMINO_EFFECT CFR packet, &quot;</span>
                                                + &quot;received: &quot; + cfrType);
<span class="nc" id="L12864">                                throw new IllegalStateException();</span>
                            }
<span class="nc" id="L12866">                            MovePath mp = (MovePath) rp.packet.getData()[1];</span>
                            // Move based on the feedback
<span class="nc bnc" id="L12868" title="All 2 branches missed.">                            if (mp != null) {</span>
<span class="nc" id="L12869">                                mp.setGame(getGame());</span>
<span class="nc" id="L12870">                                mp.setEntity(violation);</span>
                                // Report
<span class="nc" id="L12872">                                r = new Report(2352);</span>
<span class="nc" id="L12873">                                r.indent(3);</span>
<span class="nc" id="L12874">                                r.subject = violation.getId();</span>
<span class="nc" id="L12875">                                r.addDesc(violation);</span>
<span class="nc bnc" id="L12876" title="All 2 branches missed.">                                if (mp.getLastStep().getType() == MoveStepType.FORWARDS) {</span>
<span class="nc" id="L12877">                                    r.choose(false);</span>
                                } else {
<span class="nc" id="L12879">                                    r.choose(true);</span>
                                }
<span class="nc" id="L12881">                                r.add(mp.getLastStep().getPosition().getBoardNum());</span>
<span class="nc" id="L12882">                                vPhaseReport.add(r);</span>
                                // Move unit
<span class="nc" id="L12884">                                violation.setPosition(mp.getFinalCoords());</span>
<span class="nc" id="L12885">                                violation.mpUsed += mp.getMpUsed();</span>
<span class="nc" id="L12886">                                violation.moved = mp.getLastStepMovementType();</span>
                            } else { // User decided to do nothing
<span class="nc" id="L12888">                                r = new Report(2358);</span>
<span class="nc" id="L12889">                                r.indent(3);</span>
<span class="nc" id="L12890">                                r.subject = violation.getId();</span>
<span class="nc" id="L12891">                                r.addDesc(violation);</span>
<span class="nc" id="L12892">                                vPhaseReport.add(r);</span>
<span class="nc" id="L12893">                                vPhaseReport.addAll(doEntityDisplacement(violation, dest,</span>
<span class="nc" id="L12894">                                        dest.translated(direction), null));</span>
                            }
<span class="nc" id="L12896">                        } else { // If no responses, treat as no action</span>
<span class="nc" id="L12897">                            vPhaseReport.addAll(doEntityDisplacement(violation,</span>
<span class="nc" id="L12898">                                    dest, dest.translated(direction),</span>
<span class="nc" id="L12899">                                    new PilotingRollData(violation.getId(), 0,</span>
                                            &quot;domino effect&quot;)));
                        }
<span class="nc" id="L12902">                    }</span>
                }
<span class="nc" id="L12904">            } else { // Nope</span>
<span class="nc" id="L12905">                r = new Report(2359);</span>
<span class="nc" id="L12906">                r.indent(2);</span>
<span class="nc" id="L12907">                r.subject = violation.getId();</span>
<span class="nc" id="L12908">                r.addDesc(violation);</span>
<span class="nc" id="L12909">                vPhaseReport.add(r);</span>
<span class="nc" id="L12910">                vPhaseReport.addAll(doEntityDisplacement(violation, dest, dest.translated(direction),</span>
<span class="nc" id="L12911">                        new PilotingRollData(violation.getId(), 0, &quot;domino effect&quot;)));</span>

            }
            // Update the violating entity's position on the client,
            // if it didn't get displaced off the board.
<span class="nc bnc" id="L12916" title="All 2 branches missed.">            if (!game.isOutOfGame(violation)) {</span>
<span class="nc" id="L12917">                entityUpdate(violation.getId());</span>
            }
        }
<span class="nc" id="L12920">        return vPhaseReport;</span>
    }

    private void sendDominoEffectCFR(Entity e) {
<span class="nc" id="L12924">        send(e.getOwnerId(), new Packet(Packet.COMMAND_CLIENT_FEEDBACK_REQUEST,</span>
<span class="nc" id="L12925">                new Object[] { Packet.COMMAND_CFR_DOMINO_EFFECT, e.getId() }));</span>
<span class="nc" id="L12926">    }</span>

    private void sendAMSAssignCFR(Entity e, Mounted ams, List&lt;WeaponAttackAction&gt; waas) {
<span class="nc" id="L12929">        send(e.getOwnerId(),</span>
                new Packet(Packet.COMMAND_CLIENT_FEEDBACK_REQUEST,
<span class="nc" id="L12931">                        new Object[] { Packet.COMMAND_CFR_AMS_ASSIGN,</span>
<span class="nc" id="L12932">                                e.getId(), e.getEquipmentNum(ams), waas }));</span>
<span class="nc" id="L12933">    }</span>

    private void sendAPDSAssignCFR(Entity e, List&lt;Integer&gt; apdsDists,
            List&lt;WeaponAttackAction&gt; waas) {
<span class="nc" id="L12937">        send(e.getOwnerId(), new Packet(Packet.COMMAND_CLIENT_FEEDBACK_REQUEST,</span>
<span class="nc" id="L12938">                new Object[] { Packet.COMMAND_CFR_APDS_ASSIGN, e.getId(),</span>
                apdsDists, waas }));
<span class="nc" id="L12940">    }</span>

    private void sendPointBlankShotCFR(Entity hidden, Entity target) {
        // Send attacker/target IDs to PBS Client
<span class="nc" id="L12944">        send(hidden.getOwnerId(),</span>
                new Packet(Packet.COMMAND_CLIENT_FEEDBACK_REQUEST,
<span class="nc" id="L12946">                        new Object[] { Packet.COMMAND_CFR_HIDDEN_PBS,</span>
<span class="nc" id="L12947">                                hidden.getId(), target.getId() }));</span>
<span class="nc" id="L12948">    }</span>

    private void sendTeleguidedMissileCFR(int playerId, List&lt;Integer&gt; targetIds, List&lt;Integer&gt; toHitValues) {
        // Send target id numbers and to-hit values to Client
<span class="nc" id="L12952">        send(playerId, new Packet(Packet.COMMAND_CLIENT_FEEDBACK_REQUEST,</span>
<span class="nc" id="L12953">                new Object[] { Packet.COMMAND_CFR_TELEGUIDED_TARGET, targetIds, toHitValues}));</span>
<span class="nc" id="L12954">    }</span>
    
    private void sendTAGTargetCFR(int playerId, List&lt;Integer&gt; targetIds, List&lt;Integer&gt; targetTypes) {
        // Send target id numbers and type identifiers to Client
<span class="nc" id="L12958">        send(playerId, new Packet(Packet.COMMAND_CLIENT_FEEDBACK_REQUEST,</span>
<span class="nc" id="L12959">                new Object[] { Packet.COMMAND_CFR_TAG_TARGET, targetIds, targetTypes}));</span>
<span class="nc" id="L12960">    }</span>

    private Vector&lt;Report&gt; doEntityDisplacementMinefieldCheck(Entity entity, Coords src, Coords dest, int elev) {
<span class="nc" id="L12963">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L12964">        boolean boom = checkVibrabombs(entity, dest, true, vPhaseReport);</span>
<span class="nc bnc" id="L12965" title="All 2 branches missed.">        if (game.containsMinefield(dest)) {</span>
<span class="nc bnc" id="L12966" title="All 4 branches missed.">            boom = enterMinefield(entity, dest, elev, true, vPhaseReport) || boom;</span>
        }
<span class="nc bnc" id="L12968" title="All 2 branches missed.">        if (boom) {</span>
<span class="nc" id="L12969">            resetMines();</span>
        }

<span class="nc" id="L12972">        return vPhaseReport;</span>
    }

    private Vector&lt;Report&gt; doEntityDisplacementBogDownCheck(Entity entity, Coords c, int elev) {
<span class="nc" id="L12976">        Vector&lt;Report&gt; vReport = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L12978">        IHex destHex = game.getBoard().getHex(c);</span>
<span class="nc" id="L12979">        int bgMod = destHex.getBogDownModifier(entity.getMovementMode(),</span>
                entity instanceof LargeSupportTank);
<span class="nc bnc" id="L12981" title="All 2 branches missed.">        if ((bgMod != TargetRoll.AUTOMATIC_SUCCESS)</span>
<span class="nc bnc" id="L12982" title="All 2 branches missed.">                &amp;&amp; (entity.getMovementMode() != EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L12983" title="All 4 branches missed.">                &amp;&amp; (entity.getMovementMode() != EntityMovementMode.WIGE)</span>
                &amp;&amp; (elev == 0)) {
<span class="nc" id="L12985">            PilotingRollData roll = entity.getBasePilotingRoll();</span>
<span class="nc" id="L12986">            roll.append(new PilotingRollData(entity.getId(), bgMod, &quot;avoid bogging down&quot;));</span>
<span class="nc" id="L12987">            int stuckroll = Compute.d6(2);</span>
            // A DFA-ing mech is &quot;displaced&quot; into the target hex. Since it
            // must be jumping, it will automatically be bogged down
<span class="nc bnc" id="L12990" title="All 4 branches missed.">            if (stuckroll &lt; roll.getValue() || entity.isMakingDfa()) {</span>
<span class="nc" id="L12991">                entity.setStuck(true);</span>
<span class="nc" id="L12992">                r = new Report(2081);</span>
<span class="nc" id="L12993">                r.subject = entity.getId();</span>
<span class="nc" id="L12994">                r.add(entity.getDisplayName(), true);</span>
<span class="nc" id="L12995">                vReport.add(r);</span>
                // check for quicksand
<span class="nc" id="L12997">                vReport.addAll(checkQuickSand(c));</span>
            }

        }
<span class="nc" id="L13001">        return vReport;</span>
    }

    /**
     * Receive a deployment packet. If valid, execute it and end the current
     * turn.
     */
    private void receiveDeployment(Packet packet, int connId) {
<span class="nc" id="L13009">        Entity entity = game.getEntity(packet.getIntValue(0));</span>
<span class="nc" id="L13010">        Coords coords = (Coords) packet.getObject(1);</span>
<span class="nc" id="L13011">        int nFacing = packet.getIntValue(2);</span>
<span class="nc" id="L13012">        int elevation = packet.getIntValue(3);</span>

        // Handle units that deploy loaded with other units.
<span class="nc" id="L13015">        int loadedCount = packet.getIntValue(4);</span>
<span class="nc" id="L13016">        Vector&lt;Entity&gt; loadVector = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L13017" title="All 2 branches missed.">        for (int i = 0; i &lt; loadedCount; i++) {</span>
<span class="nc" id="L13018">            int loadedId = packet.getIntValue(6 + i);</span>
<span class="nc" id="L13019">            loadVector.addElement(game.getEntity(loadedId));</span>
        }

        // is this the right phase?
<span class="nc bnc" id="L13023" title="All 2 branches missed.">        if (game.getPhase() != IGame.Phase.PHASE_DEPLOYMENT) {</span>
<span class="nc" id="L13024">            MegaMek.getLogger().error(&quot;Server got deployment packet in wrong phase&quot;);</span>
<span class="nc" id="L13025">            return;</span>
        }

        // can this player/entity act right now?
<span class="nc" id="L13029">        final boolean assaultDrop = packet.getBooleanValue(5);</span>
        // can this player/entity act right now?
<span class="nc" id="L13031">        GameTurn turn = game.getTurn();</span>
<span class="nc bnc" id="L13032" title="All 2 branches missed.">        if (game.isPhaseSimultaneous()) {</span>
<span class="nc" id="L13033">            turn = game.getTurnForPlayer(connId);</span>
        }
<span class="nc bnc" id="L13035" title="All 4 branches missed.">        if ((turn == null) || !turn.isValid(connId, entity, game)</span>
<span class="nc bnc" id="L13036" title="All 4 branches missed.">                || !(game.getBoard().isLegalDeployment(coords, entity.getStartingPos())</span>
<span class="nc bnc" id="L13037" title="All 2 branches missed.">                || (assaultDrop &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVANCED_ASSAULT_DROP)</span>
<span class="nc bnc" id="L13038" title="All 2 branches missed.">                    &amp;&amp; entity.canAssaultDrop()))) {</span>
<span class="nc" id="L13039">            String msg = &quot;server got invalid deployment packet from &quot;</span>
                         + &quot;connection &quot; + connId;
<span class="nc bnc" id="L13041" title="All 2 branches missed.">            if (entity != null) {</span>
<span class="nc" id="L13042">                msg += &quot;, Entity: &quot; + entity.getShortName();</span>
            } else {
<span class="nc" id="L13044">                msg += &quot;, Entity was null!&quot;;</span>
            }
<span class="nc" id="L13046">            MegaMek.getLogger().error(msg);</span>
<span class="nc" id="L13047">            send(connId, createTurnVectorPacket());</span>
<span class="nc" id="L13048">            send(connId, createTurnIndexPacket(turn.getPlayerNum()));</span>
<span class="nc" id="L13049">            return;</span>
        }

        // looks like mostly everything's okay
<span class="nc" id="L13053">        processDeployment(entity, coords, nFacing, elevation, loadVector, assaultDrop);</span>

        //Update Aero sensors for a space or atmospheric game
<span class="nc bnc" id="L13056" title="All 2 branches missed.">        if (entity.isAero()) {</span>
<span class="nc" id="L13057">            IAero a = (IAero) entity;</span>
<span class="nc" id="L13058">            a.updateSensorOptions();</span>
        }

        // Update visibility indications if using double blind.
<span class="nc bnc" id="L13062" title="All 2 branches missed.">        if (doBlind()) {</span>
<span class="nc" id="L13063">            updateVisibilityIndicator(null);</span>
        }

<span class="nc" id="L13066">        endCurrentTurn(entity);</span>
<span class="nc" id="L13067">    }</span>

    /**
     * Used when an Entity that was loaded in another Entity in the Lounge is
     * unloaded during deployment.
     * @param packet the packet to be processed
     * @param connId the id for connection that received the packet.
     */
    private void receiveDeploymentUnload(Packet packet, int connId) {
<span class="nc" id="L13076">        Entity loader = game.getEntity(packet.getIntValue(0));</span>
<span class="nc" id="L13077">        Entity loaded = game.getEntity(packet.getIntValue(1));</span>

<span class="nc bnc" id="L13079" title="All 2 branches missed.">        if (game.getPhase() != Phase.PHASE_DEPLOYMENT) {</span>
<span class="nc" id="L13080">            String msg = &quot;server received deployment unload packet &quot;</span>
                    + &quot;outside of deployment phase from connection &quot; + connId;
<span class="nc bnc" id="L13082" title="All 2 branches missed.">            if (loader != null) {</span>
<span class="nc" id="L13083">                msg += &quot;, Entity: &quot; + loader.getShortName();</span>
            } else {
<span class="nc" id="L13085">                msg += &quot;, Entity was null!&quot;;</span>
            }
<span class="nc" id="L13087">            MegaMek.getLogger().error(msg);</span>
<span class="nc" id="L13088">            return;</span>
        }

        // can this player/entity act right now?
<span class="nc" id="L13092">        GameTurn turn = game.getTurn();</span>
<span class="nc bnc" id="L13093" title="All 2 branches missed.">        if (game.isPhaseSimultaneous()) {</span>
<span class="nc" id="L13094">            turn = game.getTurnForPlayer(connId);</span>
        }

<span class="nc bnc" id="L13097" title="All 4 branches missed.">        if ((turn == null) || !turn.isValid(connId, loader, game)) {</span>
<span class="nc" id="L13098">            String msg = &quot;server got invalid deployment unload packet from connection &quot; + connId;</span>
<span class="nc bnc" id="L13099" title="All 2 branches missed.">            if (loader != null) {</span>
<span class="nc" id="L13100">                msg += &quot;, Entity: &quot; + loader.getShortName();</span>
            } else {
<span class="nc" id="L13102">                msg += &quot;, Entity was null!&quot;;</span>
            }
<span class="nc" id="L13104">            MegaMek.getLogger().error(msg);</span>
<span class="nc" id="L13105">            send(connId, createTurnVectorPacket());</span>
<span class="nc" id="L13106">            send(connId, createTurnIndexPacket(connId));</span>
<span class="nc" id="L13107">            return;</span>
        }

        // Unload and call entityUpdate
<span class="nc" id="L13111">        unloadUnit(loader, loaded, null, 0, 0, false, true);</span>

        // Need to update the loader
<span class="nc" id="L13114">        entityUpdate(loader.getId());</span>

        // Now need to add a turn for the unloaded unit, to be taken immediately
        // Turn forced to be immediate to avoid messy turn ordering issues
        // (aka, how do we add the turn with individual initiative?)
<span class="nc" id="L13119">        game.insertTurnAfter(new GameTurn.SpecificEntityTurn(</span>
<span class="nc" id="L13120">                loaded.getOwnerId(), loaded.getId()), game.getTurnIndex() - 1);</span>
        //game.insertNextTurn(new GameTurn.SpecificEntityTurn(
        //        loaded.getOwnerId(), loaded.getId()));
<span class="nc" id="L13123">        send(createTurnVectorPacket());</span>
<span class="nc" id="L13124">    }</span>


    /**
     * Process a deployment packet by... deploying the entity! We load any other
     * specified entities inside of it too. Also, check that the deployment is
     * valid.
     */
    private void processDeployment(Entity entity, Coords coords, int nFacing, int elevation, Vector&lt;Entity&gt; loadVector,
            boolean assaultDrop) {
<span class="nc bnc" id="L13134" title="All 2 branches missed.">        for (Entity loaded : loadVector) {</span>
<span class="nc bnc" id="L13135" title="All 2 branches missed.">            if (loaded.getTransportId() != Entity.NONE) {</span>
                // we probably already loaded this unit in the chat lounge
<span class="nc" id="L13137">                continue;</span>
            }
<span class="nc bnc" id="L13139" title="All 2 branches missed.">            if (loaded.getPosition() != null) {</span>
                // Something is fishy in Denmark.
<span class="nc" id="L13141">                MegaMek.getLogger().error(entity + &quot; can not load entity #&quot; + loaded);</span>
<span class="nc" id="L13142">                break;</span>
            }
            // Have the deployed unit load the indicated unit.
<span class="nc" id="L13145">            loadUnit(entity, loaded, loaded.getTargetBay());</span>
<span class="nc" id="L13146">        }</span>

        /*
         * deal with starting velocity for advanced movement. Probably not the
         * best place to do it, but what are you going to do
         */
<span class="nc bnc" id="L13152" title="All 4 branches missed.">        if (entity.isAero() &amp;&amp; game.useVectorMove()) {</span>
<span class="nc" id="L13153">            IAero a = (IAero) entity;</span>
<span class="nc" id="L13154">            int[] v = {0, 0, 0, 0, 0, 0};</span>

            // if this is the entity's first time deploying, we want to respect the &quot;velocity&quot; setting from the lobby
<span class="nc bnc" id="L13157" title="All 2 branches missed.">            if(entity.wasNeverDeployed()) {</span>
<span class="nc bnc" id="L13158" title="All 2 branches missed.">                if (a.getCurrentVelocityActual() &gt; 0) {</span>
<span class="nc" id="L13159">                    v[nFacing] = a.getCurrentVelocityActual();</span>
<span class="nc" id="L13160">                    entity.setVectors(v);</span>
                }
            // this means the entity is coming back from off board, so we'll rotate the velocity vector by 180
            // and set it to 1/2 the magnitude
            } else {
<span class="nc bnc" id="L13165" title="All 2 branches missed.">                for(int x = 0; x &lt; 6; x++) {</span>
<span class="nc" id="L13166">                    v[(x + 3) % 6] = entity.getVector(x) / 2;</span>
                }

<span class="nc" id="L13169">                entity.setVectors(v);</span>
            }
        }

<span class="nc" id="L13173">        entity.setPosition(coords);</span>
<span class="nc" id="L13174">        entity.setFacing(nFacing);</span>
<span class="nc" id="L13175">        entity.setSecondaryFacing(nFacing);</span>
<span class="nc" id="L13176">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc bnc" id="L13177" title="All 2 branches missed.">        if (assaultDrop) {</span>
<span class="nc" id="L13178">            entity.setAltitude(1);</span>
            // from the sky!
<span class="nc" id="L13180">            entity.setAssaultDropInProgress(true);</span>
<span class="nc bnc" id="L13181" title="All 4 branches missed.">        } else if ((entity instanceof VTOL) &amp;&amp; (entity.getExternalUnits().size() &lt;= 0)) {</span>
            // We should let players pick, but this simplifies a lot.
            // Only do it for VTOLs, though; assume everything else is on the
            // ground.
<span class="nc" id="L13185">            entity.setElevation((hex.ceiling() - hex.surface()) + 1);</span>
<span class="nc bnc" id="L13186" title="All 2 branches missed.">            while ((Compute.stackingViolation(game, entity, coords, null) != null)</span>
<span class="nc bnc" id="L13187" title="All 2 branches missed.">                   &amp;&amp; (entity.getElevation() &lt;= 50)) {</span>
<span class="nc" id="L13188">                entity.setElevation(entity.getElevation() + 1);</span>
            }
<span class="nc bnc" id="L13190" title="All 2 branches missed.">            if (entity.getElevation() &gt; 50) {</span>
<span class="nc" id="L13191">                throw new IllegalStateException(&quot;Entity #&quot; + entity.getId()</span>
                        + &quot; appears to be in an infinite loop trying to get a legal elevation.&quot;);
            }
<span class="nc bnc" id="L13194" title="All 2 branches missed.">        } else if (entity.isAero()) {</span>
            // if the entity is airborne, then we don't want to set its
            // elevation below, because that will
            // default to 999
<span class="nc bnc" id="L13198" title="All 2 branches missed.">            if (entity.isAirborne()) {</span>
<span class="nc" id="L13199">                entity.setElevation(0);</span>
<span class="nc" id="L13200">                elevation = 0;</span>
            }
<span class="nc bnc" id="L13202" title="All 2 branches missed.">            if (!game.getBoard().inSpace()) {</span>
                // all spheroid craft should have velocity of zero in atmosphere
                // regardless of what was entered
<span class="nc" id="L13205">                IAero a = (IAero) entity;</span>
<span class="nc bnc" id="L13206" title="All 4 branches missed.">                if (a.isSpheroid() || game.getPlanetaryConditions().isVacuum()) {</span>
<span class="nc" id="L13207">                    a.setCurrentVelocity(0);</span>
<span class="nc" id="L13208">                    a.setNextVelocity(0);</span>
                }
                // make sure that entity is above the level of the hex if in
                // atmosphere
<span class="nc bnc" id="L13212" title="All 2 branches missed.">                if (game.getBoard().inAtmosphere()</span>
<span class="nc bnc" id="L13213" title="All 2 branches missed.">                    &amp;&amp; (entity.getAltitude() &lt;= hex.ceiling(true))) {</span>
                    // you can't be grounded on low atmosphere map
<span class="nc" id="L13215">                    entity.setAltitude(hex.ceiling(true) + 1);</span>
                }
<span class="nc" id="L13217">            }</span>
<span class="nc bnc" id="L13218" title="All 2 branches missed.">        } else if (entity.getMovementMode() == EntityMovementMode.SUBMARINE) {</span>
            // TODO : Submarines should have a selectable height.
            // TODO : For now, pretend they're regular naval.
<span class="nc" id="L13221">            entity.setElevation(0);</span>
<span class="nc bnc" id="L13222" title="All 2 branches missed.">        } else if ((entity.getMovementMode() == EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L13223" title="All 2 branches missed.">                || (entity.getMovementMode() == EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L13224" title="All 2 branches missed.">                || (entity.getMovementMode() == EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L13225" title="All 2 branches missed.">                || (entity.getMovementMode() == EntityMovementMode.HYDROFOIL)) {</span>
            // For now, assume they're on the surface.
            // entity elevation is relative to hex surface
<span class="nc" id="L13228">            entity.setElevation(0);</span>
<span class="nc bnc" id="L13229" title="All 2 branches missed.">        } else if (hex.containsTerrain(Terrains.ICE)) {</span>
<span class="nc" id="L13230">            entity.setElevation(0);</span>
        } else {
<span class="nc" id="L13232">            Building bld = game.getBoard().getBuildingAt(entity.getPosition());</span>
<span class="nc bnc" id="L13233" title="All 4 branches missed.">            if ((bld != null) &amp;&amp; (bld.getType() == Building.WALL)) {</span>
<span class="nc" id="L13234">                entity.setElevation(hex.terrainLevel(Terrains.BLDG_ELEV));</span>
            }

        }
        // add the elevation that was passed into this method
        // TODO : currently only used for building placement, we should do this
        // TODO : more systematically with up/down buttons in the deployment display
<span class="nc" id="L13241">        entity.setElevation(entity.getElevation() + elevation);</span>
<span class="nc bnc" id="L13242" title="All 2 branches missed.">        boolean wigeFlyover = entity.getMovementMode() == EntityMovementMode.WIGE</span>
<span class="nc bnc" id="L13243" title="All 2 branches missed.">                &amp;&amp; hex.containsTerrain(Terrains.BLDG_ELEV)</span>
<span class="nc bnc" id="L13244" title="All 2 branches missed.">                &amp;&amp; entity.getElevation() &gt; hex.terrainLevel(Terrains.BLDG_ELEV);</span>


        // when first entering a building, we need to roll what type
        // of basement it has
<span class="nc" id="L13249">        Building bldg = game.getBoard().getBuildingAt(entity.getPosition());</span>
<span class="nc bnc" id="L13250" title="All 2 branches missed.">        if ((bldg != null)) {</span>
<span class="nc bnc" id="L13251" title="All 2 branches missed.">            if (bldg.rollBasement(entity.getPosition(), game.getBoard(), vPhaseReport)) {</span>
<span class="nc" id="L13252">                sendChangedHex(entity.getPosition());</span>
<span class="nc" id="L13253">                Vector&lt;Building&gt; buildings = new Vector&lt;&gt;();</span>
<span class="nc" id="L13254">                buildings.add(bldg);</span>
<span class="nc" id="L13255">                sendChangedBuildings(buildings);</span>
            }
<span class="nc" id="L13257">            boolean collapse = checkBuildingCollapseWhileMoving(bldg, entity, entity.getPosition());</span>
<span class="nc bnc" id="L13258" title="All 2 branches missed.">            if (collapse) {</span>
<span class="nc" id="L13259">                addAffectedBldg(bldg, true);</span>
<span class="nc bnc" id="L13260" title="All 2 branches missed.">                if (wigeFlyover) {</span>
                // If the building is collapsed by a WiGE flying over it, the WiGE drops one level of elevation.
<span class="nc" id="L13262">                    entity.setElevation(entity.getElevation() - 1);</span>
                }
            }
        }

<span class="nc" id="L13267">        entity.setDone(true);</span>
<span class="nc" id="L13268">        entity.setDeployed(true);</span>
<span class="nc" id="L13269">        entityUpdate(entity.getId());</span>
<span class="nc" id="L13270">        addReport(doSetLocationsExposure(entity, hex, false, entity.getElevation()));</span>
<span class="nc" id="L13271">    }</span>

    /**
     * receive a packet that contains hexes that are automatically hit by
     * artillery
     *
     * @param packet the packet to be processed
     * @param connId the id for connection that received the packet.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    private void receiveArtyAutoHitHexes(Packet packet, int connId) {
<span class="nc" id="L13282">        PlayerIDandList&lt;Coords&gt; artyAutoHitHexes = (PlayerIDandList&lt;Coords&gt;) packet</span>
<span class="nc" id="L13283">                .getObject(0);</span>

<span class="nc" id="L13285">        int playerId = artyAutoHitHexes.getPlayerID();</span>

        // is this the right phase?
<span class="nc bnc" id="L13288" title="All 2 branches missed.">        if (game.getPhase() != IGame.Phase.PHASE_SET_ARTYAUTOHITHEXES) {</span>
<span class="nc" id="L13289">            MegaMek.getLogger().error(&quot;Server got set artyautohithexespacket in wrong phase&quot;);</span>
<span class="nc" id="L13290">            return;</span>
        }
<span class="nc" id="L13292">        game.getPlayer(playerId).setArtyAutoHitHexes(artyAutoHitHexes);</span>

<span class="nc bnc" id="L13294" title="All 2 branches missed.">        for (Coords coord : artyAutoHitHexes) {</span>
<span class="nc" id="L13295">            game.getBoard().addSpecialHexDisplay(coord,</span>
                    new SpecialHexDisplay(
                            SpecialHexDisplay.Type.ARTILLERY_AUTOHIT,
<span class="nc" id="L13298">                            SpecialHexDisplay.NO_ROUND, getPlayer(playerId),</span>
                            &quot;Artillery auto hit hex, for &quot;
<span class="nc" id="L13300">                            + getPlayer(playerId).getName(),</span>
                            SpecialHexDisplay.SHD_OBSCURED_TEAM));
<span class="nc" id="L13302">        }</span>
<span class="nc" id="L13303">        endCurrentTurn(null);</span>
<span class="nc" id="L13304">    }</span>

    /**
     * receive a packet that contains minefields
     *
     * @param packet the packet to be processed
     * @param connId the id for connection that received the packet.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    private void receiveDeployMinefields(Packet packet, int connId) {
<span class="nc" id="L13314">        Vector&lt;Minefield&gt; minefields = (Vector&lt;Minefield&gt;) packet.getObject(0);</span>

        // is this the right phase?
<span class="nc bnc" id="L13317" title="All 2 branches missed.">        if (game.getPhase() != IGame.Phase.PHASE_DEPLOY_MINEFIELDS) {</span>
<span class="nc" id="L13318">            MegaMek.getLogger().error(&quot;Server got deploy minefields packet in wrong phase&quot;);</span>
<span class="nc" id="L13319">            return;</span>
        }

        // looks like mostly everything's okay
<span class="nc" id="L13323">        processDeployMinefields(minefields);</span>
<span class="nc" id="L13324">        endCurrentTurn(null);</span>
<span class="nc" id="L13325">    }</span>

    /**
     * process deployment of minefields
     *
     * @param minefields
     */
    private void processDeployMinefields(Vector&lt;Minefield&gt; minefields) {
<span class="nc" id="L13333">        int playerId = IPlayer.PLAYER_NONE;</span>
<span class="nc bnc" id="L13334" title="All 2 branches missed.">        for (int i = 0; i &lt; minefields.size(); i++) {</span>
<span class="nc" id="L13335">            Minefield mf = minefields.elementAt(i);</span>
<span class="nc" id="L13336">            playerId = mf.getPlayerId();</span>

<span class="nc" id="L13338">            game.addMinefield(mf);</span>
<span class="nc bnc" id="L13339" title="All 2 branches missed.">            if (mf.getType() == Minefield.TYPE_VIBRABOMB) {</span>
<span class="nc" id="L13340">                game.addVibrabomb(mf);</span>
            }
        }

<span class="nc" id="L13344">        IPlayer player = game.getPlayer(playerId);</span>
<span class="nc bnc" id="L13345" title="All 2 branches missed.">        if (null != player) {</span>
<span class="nc" id="L13346">            int teamId = player.getTeam();</span>

<span class="nc bnc" id="L13348" title="All 2 branches missed.">            if (teamId != IPlayer.TEAM_NONE) {</span>
<span class="nc" id="L13349">                Enumeration&lt;Team&gt; teams = game.getTeams();</span>
<span class="nc bnc" id="L13350" title="All 2 branches missed.">                while (teams.hasMoreElements()) {</span>
<span class="nc" id="L13351">                    Team team = teams.nextElement();</span>
<span class="nc bnc" id="L13352" title="All 2 branches missed.">                    if (team.getId() == teamId) {</span>
<span class="nc" id="L13353">                        Enumeration&lt;IPlayer&gt; players = team.getPlayers();</span>
<span class="nc bnc" id="L13354" title="All 2 branches missed.">                        while (players.hasMoreElements()) {</span>
<span class="nc" id="L13355">                            IPlayer teamPlayer = players.nextElement();</span>
<span class="nc bnc" id="L13356" title="All 2 branches missed.">                            if (teamPlayer.getId() != player.getId()) {</span>
<span class="nc" id="L13357">                                send(teamPlayer.getId(), new Packet(Packet.COMMAND_DEPLOY_MINEFIELDS,</span>
                                        minefields));
                            }
<span class="nc" id="L13360">                            teamPlayer.addMinefields(minefields);</span>
<span class="nc" id="L13361">                        }</span>
                        break;
                    }
<span class="nc" id="L13364">                }</span>
<span class="nc" id="L13365">            } else {</span>
<span class="nc" id="L13366">                player.addMinefields(minefields);</span>
            }
        }
<span class="nc" id="L13369">    }</span>

    /**
     * Client has sent an update indicating that a ground unit is firing at
     * an airborne unit and is overriding the default select for the position
     * in the flight path.
     * @param packet the packet to be processed
     * @param connId the id for connection that received the packet.
     */
    private void receiveGroundToAirHexSelectPacket(Packet packet, int connId) {
<span class="nc" id="L13379">        Integer targetId = (Integer)packet.getObject(0);</span>
<span class="nc" id="L13380">        Integer attackerId = (Integer)packet.getObject(1);</span>
<span class="nc" id="L13381">        Coords pos = (Coords)packet.getObject(2);</span>
<span class="nc" id="L13382">        game.getEntity(targetId).setPlayerPickedPassThrough(attackerId, pos);</span>
<span class="nc" id="L13383">    }</span>

    /**
     * Gets a bunch of entity attacks from the packet. If valid, processes them
     * and ends the current turn.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    private void receiveAttack(Packet packet, int connId) {
<span class="nc" id="L13391">        Entity entity = game.getEntity(packet.getIntValue(0));</span>
<span class="nc" id="L13392">        Vector&lt;EntityAction&gt; vector = (Vector&lt;EntityAction&gt;) packet.getObject(1);</span>

        // is this the right phase?
<span class="nc bnc" id="L13395" title="All 2 branches missed.">        if ((game.getPhase() != IGame.Phase.PHASE_FIRING)</span>
<span class="nc bnc" id="L13396" title="All 2 branches missed.">                &amp;&amp; (game.getPhase() != IGame.Phase.PHASE_PHYSICAL)</span>
<span class="nc bnc" id="L13397" title="All 2 branches missed.">                &amp;&amp; (game.getPhase() != IGame.Phase.PHASE_TARGETING)</span>
<span class="nc bnc" id="L13398" title="All 2 branches missed.">                &amp;&amp; (game.getPhase() != IGame.Phase.PHASE_OFFBOARD)) {</span>
<span class="nc" id="L13399">            MegaMek.getLogger().error(&quot;Server got attack packet in wrong phase&quot;);</span>
<span class="nc" id="L13400">            return;</span>
        }

        // can this player/entity act right now?
<span class="nc" id="L13404">        GameTurn turn = game.getTurn();</span>
<span class="nc bnc" id="L13405" title="All 2 branches missed.">        if (game.isPhaseSimultaneous()) {</span>
<span class="nc" id="L13406">            turn = game.getTurnForPlayer(connId);</span>
        }
<span class="nc bnc" id="L13408" title="All 4 branches missed.">        if ((turn == null) || !turn.isValid(connId, entity, game)) {</span>
<span class="nc" id="L13409">            String msg = &quot;error: server got invalid attack packet from connection &quot; + connId;</span>
<span class="nc bnc" id="L13410" title="All 2 branches missed.">            if (entity != null) {</span>
<span class="nc" id="L13411">                msg += &quot;, Entity: &quot; + entity.getShortName();</span>
            } else {
<span class="nc" id="L13413">                msg += &quot;, Entity was null!&quot;;</span>
            }
<span class="nc" id="L13415">            MegaMek.getLogger().error(msg);</span>
<span class="nc" id="L13416">            send(connId, createTurnVectorPacket());</span>
<span class="nc" id="L13417">            send(connId, createTurnIndexPacket(turn.getPlayerNum()));</span>
<span class="nc" id="L13418">            return;</span>
        }

        // looks like mostly everything's okay
<span class="nc" id="L13422">        processAttack(entity, vector);</span>

        // Update visibility indications if using double blind.
<span class="nc bnc" id="L13425" title="All 2 branches missed.">        if (doBlind()) {</span>
<span class="nc" id="L13426">            updateVisibilityIndicator(null);</span>
        }

<span class="nc" id="L13429">        endCurrentTurn(entity);</span>
<span class="nc" id="L13430">    }</span>

    /**
     * Process a batch of entity attack (or twist) actions by adding them to the
     * proper list to be processed later.
     */
    private void processAttack(Entity entity, Vector&lt;EntityAction&gt; vector) {
        // Convert any null vectors to empty vectors to avoid NPEs.
<span class="nc bnc" id="L13438" title="All 2 branches missed.">        if (vector == null) {</span>
<span class="nc" id="L13439">            vector = new Vector&lt;&gt;(0);</span>
        }

        // Not **all** actions take up the entity's turn.
<span class="nc bnc" id="L13443" title="All 2 branches missed.">        boolean setDone = !((game.getTurn() instanceof GameTurn.TriggerAPPodTurn)</span>
<span class="nc bnc" id="L13444" title="All 2 branches missed.">                || (game.getTurn() instanceof GameTurn.TriggerBPodTurn));</span>
<span class="nc bnc" id="L13445" title="All 2 branches missed.">        for (EntityAction ea : vector) {</span>
            // is this the right entity?
<span class="nc bnc" id="L13447" title="All 2 branches missed.">            if (ea.getEntityId() != entity.getId()) {</span>
<span class="nc" id="L13448">                MegaMek.getLogger().error(&quot;Attack packet has wrong attacker&quot;);</span>
<span class="nc" id="L13449">                continue;</span>
            }
<span class="nc bnc" id="L13451" title="All 2 branches missed.">            if (ea instanceof PushAttackAction) {</span>
                // push attacks go the end of the displacement attacks
<span class="nc" id="L13453">                PushAttackAction paa = (PushAttackAction) ea;</span>
<span class="nc" id="L13454">                entity.setDisplacementAttack(paa);</span>
<span class="nc" id="L13455">                game.addCharge(paa);</span>
<span class="nc bnc" id="L13456" title="All 2 branches missed.">            } else if (ea instanceof DodgeAction) {</span>
<span class="nc" id="L13457">                entity.dodging = true;</span>
<span class="nc bnc" id="L13458" title="All 2 branches missed.">            } else if (ea instanceof SpotAction) {</span>
<span class="nc" id="L13459">                entity.setSpotting(true);</span>
<span class="nc" id="L13460">                entity.setSpotTargetId(((SpotAction) ea).getTargetId());</span>
            } else {
                // add to the normal attack list.
<span class="nc" id="L13463">                game.addAction(ea);</span>
            }

            // Anti-mech and pointblank attacks from
            // hiding may allow the target to respond.
<span class="nc bnc" id="L13468" title="All 2 branches missed.">            if (ea instanceof WeaponAttackAction) {</span>
<span class="nc" id="L13469">                final WeaponAttackAction waa = (WeaponAttackAction) ea;</span>
<span class="nc" id="L13470">                final String weaponName = entity.getEquipment(waa.getWeaponId()).getType()</span>
<span class="nc" id="L13471">                        .getInternalName();</span>

<span class="nc bnc" id="L13473" title="All 4 branches missed.">                if (Infantry.SWARM_MEK.equals(weaponName) || Infantry.LEG_ATTACK.equals(weaponName)) {</span>

                    // Does the target have any AP Pods available?
<span class="nc" id="L13476">                    final Entity target = game.getEntity(waa.getTargetId());</span>
<span class="nc bnc" id="L13477" title="All 2 branches missed.">                    for (Mounted equip : target.getMisc()) {</span>
<span class="nc bnc" id="L13478" title="All 4 branches missed.">                        if (equip.getType().hasFlag(MiscType.F_AP_POD) &amp;&amp; equip.canFire()) {</span>

                            // Yup. Insert a game turn to handle AP pods.
                            // ASSUMPTION : AP pod declarations come
                            // immediately after the attack declaration.
<span class="nc" id="L13483">                            game.insertNextTurn(new GameTurn.TriggerAPPodTurn(target.getOwnerId(),</span>
<span class="nc" id="L13484">                                    target.getId()));</span>
<span class="nc" id="L13485">                            send(createTurnVectorPacket());</span>

                            // We can stop looking.
<span class="nc" id="L13488">                            break;</span>

                        } // end found-available-ap-pod

<span class="nc" id="L13492">                    } // Check the next piece of equipment on the target.</span>

<span class="nc bnc" id="L13494" title="All 2 branches missed.">                    for (Mounted weapon : target.getWeaponList()) {</span>
<span class="nc bnc" id="L13495" title="All 4 branches missed.">                        if (weapon.getType().hasFlag(WeaponType.F_B_POD) &amp;&amp; weapon.canFire()) {</span>

                            // Yup. Insert a game turn to handle B pods.
                            // ASSUMPTION : B pod declarations come
                            // immediately after the attack declaration.
<span class="nc" id="L13500">                            game.insertNextTurn(new GameTurn.TriggerBPodTurn(target.getOwnerId(),</span>
<span class="nc" id="L13501">                                    target.getId(), weaponName));</span>
<span class="nc" id="L13502">                            send(createTurnVectorPacket());</span>

                            // We can stop looking.
<span class="nc" id="L13505">                            break;</span>

                        } // end found-available-b-pod
<span class="nc" id="L13508">                    } // Check the next piece of equipment on the target.</span>
                } // End check-for-available-ap-pod

                // Keep track of altitude loss for weapon attacks
<span class="nc bnc" id="L13512" title="All 2 branches missed.">                if (entity.isAero()) {</span>
<span class="nc" id="L13513">                    IAero aero = (IAero) entity;</span>
<span class="nc bnc" id="L13514" title="All 2 branches missed.">                    if (waa.getAltitudeLoss(game) &gt; aero.getAltLoss()) {</span>
<span class="nc" id="L13515">                        aero.setAltLoss(waa.getAltitudeLoss(game));</span>
                    }
                }
            }

            // If attacker breaks grapple, defender may counter
<span class="nc bnc" id="L13521" title="All 2 branches missed.">            if (ea instanceof BreakGrappleAttackAction) {</span>
<span class="nc" id="L13522">                final BreakGrappleAttackAction bgaa = (BreakGrappleAttackAction) ea;</span>
<span class="nc" id="L13523">                final Entity att = (game.getEntity(bgaa.getEntityId()));</span>
<span class="nc bnc" id="L13524" title="All 2 branches missed.">                if (att.isGrappleAttacker()) {</span>
<span class="nc" id="L13525">                    final Entity def = (game.getEntity(bgaa.getTargetId()));</span>
                    // Remove existing break grapple by defender (if exists)
<span class="nc bnc" id="L13527" title="All 2 branches missed.">                    if (def.isDone()) {</span>
<span class="nc" id="L13528">                        game.removeActionsFor(def.getId());</span>
                    } else {
<span class="nc" id="L13530">                        game.removeTurnFor(def);</span>
<span class="nc" id="L13531">                        def.setDone(true);</span>
                    }
                    // If defender is able, add a turn to declare counterattack
<span class="nc bnc" id="L13534" title="All 2 branches missed.">                    if (!def.isImmobile()) {</span>
<span class="nc" id="L13535">                        game.insertNextTurn(new GameTurn.CounterGrappleTurn(def.getOwnerId(), def.getId()));</span>
<span class="nc" id="L13536">                        send(createTurnVectorPacket());</span>
                    }
                }
            }
<span class="nc bnc" id="L13540" title="All 2 branches missed.">            if (ea instanceof ArtilleryAttackAction) {</span>
<span class="nc" id="L13541">                boolean firingAtNewHex = false;</span>
<span class="nc" id="L13542">                final ArtilleryAttackAction aaa = (ArtilleryAttackAction) ea;</span>
<span class="nc" id="L13543">                final Entity firingEntity = game.getEntity(aaa.getEntityId());</span>
<span class="nc" id="L13544">                for (Enumeration&lt;AttackHandler&gt; j = game.getAttacks(); !firingAtNewHex</span>
<span class="nc bnc" id="L13545" title="All 4 branches missed.">                        &amp;&amp; j.hasMoreElements(); ) {</span>
<span class="nc" id="L13546">                    WeaponHandler wh = (WeaponHandler) j.nextElement();</span>
<span class="nc bnc" id="L13547" title="All 2 branches missed.">                    if (wh.waa instanceof ArtilleryAttackAction) {</span>
<span class="nc" id="L13548">                        ArtilleryAttackAction oaaa = (ArtilleryAttackAction) wh.waa;</span>
<span class="nc bnc" id="L13549" title="All 2 branches missed.">                        if ((oaaa.getEntityId() == aaa.getEntityId())</span>
<span class="nc" id="L13550">                            &amp;&amp; !oaaa.getTarget(game).getPosition()</span>
<span class="nc bnc" id="L13551" title="All 2 branches missed.">                                .equals(aaa.getTarget(game).getPosition())) {</span>
<span class="nc" id="L13552">                            firingAtNewHex = true;</span>
                        }
                    }
<span class="nc" id="L13555">                }</span>
<span class="nc bnc" id="L13556" title="All 2 branches missed.">                if (firingAtNewHex) {</span>
<span class="nc" id="L13557">                    clearArtillerySpotters(firingEntity.getId(), aaa.getWeaponId());</span>
                }
<span class="nc" id="L13559">                Iterator&lt;Entity&gt; spotters = game.getSelectedEntities(new EntitySelector() {</span>
<span class="nc" id="L13560">                            public int player = firingEntity.getOwnerId();</span>
<span class="nc" id="L13561">                            public Targetable target = aaa.getTarget(game);</span>

                            public boolean accept(Entity entity) {
<span class="nc" id="L13564">                                LosEffects los = LosEffects.calculateLos(game, entity.getId(), target);</span>
<span class="nc bnc" id="L13565" title="All 4 branches missed.">                                return ((player == entity.getOwnerId()) &amp;&amp; !(los.isBlocked())</span>
<span class="nc bnc" id="L13566" title="All 2 branches missed.">                                        &amp;&amp; entity.isActive());</span>
                            }
                        });
<span class="nc" id="L13569">                Vector&lt;Integer&gt; spotterIds = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L13570" title="All 2 branches missed.">                while (spotters.hasNext()) {</span>
<span class="nc" id="L13571">                    Integer id = spotters.next().getId();</span>
<span class="nc" id="L13572">                    spotterIds.addElement(id);</span>
<span class="nc" id="L13573">                }</span>
<span class="nc" id="L13574">                aaa.setSpotterIds(spotterIds);</span>
            }

            // The equipment type of a club needs to be restored.
<span class="nc bnc" id="L13578" title="All 2 branches missed.">            if (ea instanceof ClubAttackAction) {</span>
<span class="nc" id="L13579">                ClubAttackAction caa = (ClubAttackAction) ea;</span>
<span class="nc" id="L13580">                Mounted club = caa.getClub();</span>
<span class="nc" id="L13581">                club.restore();</span>
            }

            // Mark any AP Pod as used in this turn.
<span class="nc bnc" id="L13585" title="All 2 branches missed.">            if (ea instanceof TriggerAPPodAction) {</span>
<span class="nc" id="L13586">                TriggerAPPodAction tapa = (TriggerAPPodAction) ea;</span>
<span class="nc" id="L13587">                Mounted pod = entity.getEquipment(tapa.getPodId());</span>
<span class="nc" id="L13588">                pod.setUsedThisRound(true);</span>
            }
            // Mark any B Pod as used in this turn.
<span class="nc bnc" id="L13591" title="All 2 branches missed.">            if (ea instanceof TriggerBPodAction) {</span>
<span class="nc" id="L13592">                TriggerBPodAction tba = (TriggerBPodAction) ea;</span>
<span class="nc" id="L13593">                Mounted pod = entity.getEquipment(tba.getPodId());</span>
<span class="nc" id="L13594">                pod.setUsedThisRound(true);</span>
            }

            // Mark illuminated hexes, so they can be displayed
<span class="nc bnc" id="L13598" title="All 2 branches missed.">            if (ea instanceof SearchlightAttackAction) {</span>
<span class="nc" id="L13599">                boolean hexesAdded =</span>
<span class="nc" id="L13600">                        ((SearchlightAttackAction) ea).setHexesIlluminated(game);</span>
                // If we added new hexes, send them to all players.
                // These are spotlights at night, you know they're there.
<span class="nc bnc" id="L13603" title="All 2 branches missed.">                if (hexesAdded) {</span>
<span class="nc" id="L13604">                    send(createIlluminatedHexesPacket());</span>
                }
            }
<span class="nc" id="L13607">        }</span>

        // Apply altitude loss
<span class="nc bnc" id="L13610" title="All 2 branches missed.">        if (entity.isAero()) {</span>
<span class="nc" id="L13611">            IAero aero = (IAero) entity;</span>
<span class="nc bnc" id="L13612" title="All 2 branches missed.">            if (aero.getAltLoss() &gt; 0) {</span>
<span class="nc" id="L13613">                Report r = new Report(9095);</span>
<span class="nc" id="L13614">                r.subject = entity.getId();</span>
<span class="nc" id="L13615">                r.addDesc(entity);</span>
<span class="nc" id="L13616">                r.add(aero.getAltLoss());</span>
<span class="nc" id="L13617">                addReport(r);</span>
<span class="nc" id="L13618">                entity.setAltitude(entity.getAltitude() - aero.getAltLoss());</span>
<span class="nc" id="L13619">                aero.setAltLossThisRound(aero.getAltLoss());</span>
<span class="nc" id="L13620">                aero.resetAltLoss();</span>
<span class="nc" id="L13621">                entityUpdate(entity.getId());</span>
            }
        }

        // Unless otherwise stated,
        // this entity is done for the round.
<span class="nc bnc" id="L13627" title="All 2 branches missed.">        if (setDone) {</span>
<span class="nc" id="L13628">            entity.setDone(true);</span>
        }
<span class="nc" id="L13630">        entityUpdate(entity.getId());</span>

<span class="nc" id="L13632">        Packet p = createAttackPacket(vector, 0);</span>
<span class="nc bnc" id="L13633" title="All 2 branches missed.">        if (game.isPhaseSimultaneous()) {</span>
            // Update attack only to player who declared it &amp; observers
<span class="nc bnc" id="L13635" title="All 2 branches missed.">            for (IPlayer player : game.getPlayersVector()) {</span>
<span class="nc bnc" id="L13636" title="All 4 branches missed.">                if (player.canSeeAll() || player.isObserver()</span>
<span class="nc bnc" id="L13637" title="All 2 branches missed.">                    || (entity.getOwnerId() == player.getId())) {</span>
<span class="nc" id="L13638">                    send(player.getId(), p);</span>
                }
<span class="nc" id="L13640">            }</span>
        } else {
            // update all players on the attacks. Don't worry about pushes being
            // a &quot;charge&quot; attack. It doesn't matter to the client.
<span class="nc" id="L13644">            send(p);</span>
        }
<span class="nc" id="L13646">    }</span>

    /**
     * Determine which telemissile attack actions could be affected by AMS, and
     * assign AMS to those attacks.
     */
    public void assignTeleMissileAMS(TeleMissileAttackAction taa) {
        // Map target to a list of telemissile attacks directed at entities
<span class="nc" id="L13654">        Hashtable&lt;Entity, Vector&lt;AttackAction&gt;&gt; htTMAttacks = new Hashtable&lt;&gt;();</span>

        //This should be impossible but just in case...
<span class="nc bnc" id="L13657" title="All 2 branches missed.">        if (taa == null) {</span>
<span class="nc" id="L13658">            MegaMek.getLogger().error(&quot;Null TeleMissileAttackAction!&quot;);</span>
        }

<span class="nc bnc" id="L13661" title="All 2 branches missed.">        Entity target = (taa.getTargetType() == Targetable.TYPE_ENTITY)</span>
<span class="nc" id="L13662">                ? (Entity) taa.getTarget(game) : null;</span>

        //If a telemissile is still on the board and its original target is not....
<span class="nc bnc" id="L13665" title="All 2 branches missed.">        if (target == null) {</span>
<span class="nc" id="L13666">            MegaMek.getLogger().info(&quot;Telemissile has no target. AMS not assigned.&quot;);</span>
<span class="nc" id="L13667">            return;</span>
        }

<span class="nc" id="L13670">        Vector&lt;AttackAction&gt; v = htTMAttacks.computeIfAbsent(target, k -&gt; new Vector&lt;&gt;());</span>
<span class="nc" id="L13671">        v.addElement(taa);</span>
        // Let each target assign its AMS
<span class="nc bnc" id="L13673" title="All 2 branches missed.">        for (Entity e : htTMAttacks.keySet()) {</span>
<span class="nc" id="L13674">            Vector&lt;AttackAction&gt; vTMAttacks = htTMAttacks.get(e);</span>
            // Allow MM to automatically assign AMS targets
            // AMS bays can fire multiple times, so manual target assignment is kind of pointless
<span class="nc" id="L13677">            e.assignTMAMS(vTMAttacks);</span>
<span class="nc" id="L13678">        }</span>
<span class="nc" id="L13679">    }</span>

    /**
     * Determine which missile attack actions could be affected by AMS, and
     * assign AMS (and APDS) to those attacks.
     */
    public void assignAMS() {
        // Get all of the coords that would be protected by APDS
<span class="nc" id="L13687">        Hashtable&lt;Coords, List&lt;Mounted&gt;&gt; apdsCoords = getAPDSProtectedCoords();</span>
        // Map target to a list of missile attacks directed at it
<span class="nc" id="L13689">        Hashtable&lt;Entity, Vector&lt;WeaponHandler&gt;&gt; htAttacks = new Hashtable&lt;&gt;();</span>
        // Keep track of each APDS, and which attacks it could affect
<span class="nc" id="L13691">        Hashtable&lt;Mounted, Vector&lt;WeaponHandler&gt;&gt; apdsTargets = new Hashtable&lt;&gt;();</span>

<span class="nc bnc" id="L13693" title="All 2 branches missed.">        for (AttackHandler ah : game.getAttacksVector()) {</span>
<span class="nc" id="L13694">            WeaponHandler wh = (WeaponHandler) ah;</span>
<span class="nc" id="L13695">            WeaponAttackAction waa = wh.waa;</span>

            // for artillery attacks, the attacking entity
            // might no longer be in the game.
            //TODO : Yeah, I know there's an exploit here, but better able to shoot some ArrowIVs than none, right?
<span class="nc bnc" id="L13700" title="All 2 branches missed.">            if (game.getEntity(waa.getEntityId()) == null) {</span>
<span class="nc" id="L13701">                MegaMek.getLogger().info(&quot;Can't Assign AMS: Artillery firer is null!&quot;);</span>
<span class="nc" id="L13702">                continue;</span>
            }

<span class="nc" id="L13705">            Mounted weapon = game.getEntity(waa.getEntityId()).getEquipment(waa.getWeaponId());</span>

            // Only entities can have AMS. Arrow IV doesn't target an entity until later, so we have to ignore them
<span class="nc bnc" id="L13708" title="All 4 branches missed.">            if (!(waa instanceof ArtilleryAttackAction) &amp;&amp; (Targetable.TYPE_ENTITY != waa.getTargetType())) {</span>
<span class="nc" id="L13709">                continue;</span>
            }

            // AMS is only used against attacks that hit (TW p129)
<span class="nc bnc" id="L13713" title="All 2 branches missed.">            if (wh.roll &lt; wh.toHit.getValue()) {</span>
<span class="nc" id="L13714">                continue;</span>
            }
            
            // Can only use AMS versus missiles. Artillery Bays might be firing Arrow IV homing missiles,
            // but lack the flag
<span class="nc" id="L13719">            boolean isHomingMissile = false;</span>
<span class="nc bnc" id="L13720" title="All 4 branches missed.">            if (wh instanceof ArtilleryWeaponIndirectHomingHandler</span>
                    || wh instanceof ArtilleryBayWeaponIndirectHomingHandler) {
<span class="nc" id="L13722">                Mounted ammoUsed = game.getEntity(waa.getEntityId()).getEquipment(waa.getAmmoId());</span>
<span class="nc bnc" id="L13723" title="All 2 branches missed.">                AmmoType atype = ammoUsed == null ? null : (AmmoType) ammoUsed.getType();</span>
<span class="nc bnc" id="L13724" title="All 2 branches missed.">                if (atype != null </span>
<span class="nc bnc" id="L13725" title="All 4 branches missed.">                        &amp;&amp; (atype.getAmmoType() == AmmoType.T_ARROW_IV || atype.getAmmoType() == BombType.B_HOMING)) {</span>
<span class="nc" id="L13726">                    isHomingMissile = true;</span>
                }
            }
<span class="nc bnc" id="L13729" title="All 4 branches missed.">            if (!weapon.getType().hasFlag(WeaponType.F_MISSILE) &amp;&amp; !isHomingMissile) {</span>
<span class="nc" id="L13730">                continue;</span>
            }

            // For Bearings-only Capital Missiles, don't assign during the offboard phase
<span class="nc bnc" id="L13734" title="All 2 branches missed.">            if (wh instanceof CapitalMissileBearingsOnlyHandler) {</span>
<span class="nc" id="L13735">                ArtilleryAttackAction aaa = (ArtilleryAttackAction) waa;</span>
<span class="nc bnc" id="L13736" title="All 4 branches missed.">                if (aaa.getTurnsTilHit() &gt; 0 || game.getPhase() != IGame.Phase.PHASE_FIRING) {</span>
<span class="nc" id="L13737">                    continue;</span>
                }
            }

            // For Arrow IV homing artillery
            Entity target;
<span class="nc bnc" id="L13743" title="All 2 branches missed.">            if (waa instanceof ArtilleryAttackAction) {</span>
<span class="nc bnc" id="L13744" title="All 2 branches missed.">                target = (waa.getTargetType() == Targetable.TYPE_ENTITY) ? (Entity) waa</span>
<span class="nc" id="L13745">                    .getTarget(game) : null;</span>

                // In case our target really is null.
<span class="nc bnc" id="L13748" title="All 2 branches missed.">                if (target == null) {</span>
<span class="nc" id="L13749">                    continue;</span>
                }
            } else {
<span class="nc" id="L13752">                target = game.getEntity(waa.getTargetId());</span>
            }
<span class="nc" id="L13754">            Vector&lt;WeaponHandler&gt; v = htAttacks.computeIfAbsent(target, k -&gt; new Vector&lt;&gt;());</span>
<span class="nc" id="L13755">            v.addElement(wh);</span>
            // Keep track of what weapon attacks could be affected by APDS
<span class="nc bnc" id="L13757" title="All 2 branches missed.">            if (apdsCoords.containsKey(target.getPosition())) {</span>
<span class="nc bnc" id="L13758" title="All 2 branches missed.">                for (Mounted apds : apdsCoords.get(target.getPosition())) {</span>
                    // APDS only affects attacks against friendly units
<span class="nc bnc" id="L13760" title="All 2 branches missed.">                    if (target.isEnemyOf(apds.getEntity())) {</span>
<span class="nc" id="L13761">                        continue;</span>
                    }
<span class="nc" id="L13763">                    Vector&lt;WeaponHandler&gt; handlerList = apdsTargets.computeIfAbsent(apds, k -&gt; new Vector&lt;&gt;());</span>
<span class="nc" id="L13764">                    handlerList.add(wh);</span>
<span class="nc" id="L13765">                }</span>
            }
<span class="nc" id="L13767">        }</span>
        
        // Let each target assign its AMS
<span class="nc bnc" id="L13770" title="All 2 branches missed.">        for (Entity e : htAttacks.keySet()) {</span>
<span class="nc" id="L13771">            Vector&lt;WeaponHandler&gt; vAttacks = htAttacks.get(e);</span>
            // Allow MM to automatically assign AMS targets
<span class="nc bnc" id="L13773" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.BASE_AUTO_AMS)) {</span>
<span class="nc" id="L13774">                e.assignAMS(vAttacks);</span>
            } else { // Allow user to manually assign targets
<span class="nc" id="L13776">                manuallyAssignAMSTarget(e, vAttacks);</span>
            }
<span class="nc" id="L13778">        }</span>

        // Let each APDS assign itself to an attack
<span class="nc" id="L13781">        Set&lt;WeaponAttackAction&gt; targetedAttacks = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L13782" title="All 2 branches missed.">        for (Mounted apds : apdsTargets.keySet()) {</span>
<span class="nc" id="L13783">            List&lt;WeaponHandler&gt; potentialTargets = apdsTargets.get(apds);</span>
            // Ensure we only target each attack once
<span class="nc" id="L13785">            List&lt;WeaponHandler&gt; targetsToRemove = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L13786" title="All 2 branches missed.">            for (WeaponHandler wh : potentialTargets) {</span>
<span class="nc bnc" id="L13787" title="All 2 branches missed.">                if (targetedAttacks.contains(wh.getWaa())) {</span>
<span class="nc" id="L13788">                    targetsToRemove.add(wh);</span>
                }
<span class="nc" id="L13790">            }</span>
<span class="nc" id="L13791">            potentialTargets.removeAll(targetsToRemove);</span>
            WeaponAttackAction targetedWAA;
            // Assign APDS to an attack
<span class="nc bnc" id="L13794" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.BASE_AUTO_AMS)) {</span>
<span class="nc" id="L13795">                targetedWAA = apds.assignAPDS(potentialTargets);</span>
            } else { // Allow user to manually assign targets
<span class="nc" id="L13797">                targetedWAA = manuallyAssignAPDSTarget(apds, potentialTargets);</span>
            }
<span class="nc bnc" id="L13799" title="All 2 branches missed.">            if (targetedWAA != null) {</span>
<span class="nc" id="L13800">                targetedAttacks.add(targetedWAA);</span>
            }
<span class="nc" id="L13802">        }</span>

<span class="nc" id="L13804">    }</span>

    /**
     * Convenience method for determining which missile attack will be targeted
     * with AMS on the supplied Entity
     *
     * @param apds
     *            The Entity with AMS
     * @param vAttacks
     *            List of missile attacks directed at e
     */
    private WeaponAttackAction manuallyAssignAPDSTarget(Mounted apds,
            List&lt;WeaponHandler&gt; vAttacks) {
<span class="nc" id="L13817">        Entity e = apds.getEntity();</span>
<span class="nc bnc" id="L13818" title="All 2 branches missed.">        if (e == null) {</span>
<span class="nc" id="L13819">            return null;</span>
        }

        // Create a list of valid assignments for this APDS
<span class="nc" id="L13823">        List&lt;WeaponAttackAction&gt; vAttacksInArc = new ArrayList&lt;&gt;(vAttacks.size());</span>
<span class="nc bnc" id="L13824" title="All 2 branches missed.">        for (WeaponHandler wr : vAttacks) {</span>
<span class="nc" id="L13825">            boolean isInArc = Compute.isInArc(e.getGame(), e.getId(),</span>
<span class="nc" id="L13826">                    e.getEquipmentNum(apds),</span>
<span class="nc" id="L13827">                    game.getEntity(wr.waa.getEntityId()));</span>
<span class="nc bnc" id="L13828" title="All 2 branches missed.">            boolean isInRange = e.getPosition().distance(</span>
<span class="nc" id="L13829">                    wr.getWaa().getTarget(game).getPosition()) &lt;= 3;</span>
<span class="nc bnc" id="L13830" title="All 4 branches missed.">            if (isInArc &amp;&amp; isInRange) {</span>
<span class="nc" id="L13831">                vAttacksInArc.add(wr.waa);</span>
            }
<span class="nc" id="L13833">        }</span>

        // If there are no valid attacks left, don't bother
<span class="nc bnc" id="L13836" title="All 2 branches missed.">        if (vAttacksInArc.size() &lt; 1) {</span>
<span class="nc" id="L13837">            return null;</span>
        }

<span class="nc" id="L13840">        WeaponAttackAction targetedWAA = null;</span>

<span class="nc bnc" id="L13842" title="All 2 branches missed.">        if (apds.curMode().equals(&quot;Automatic&quot;)) {</span>
<span class="nc" id="L13843">            targetedWAA = Compute.getHighestExpectedDamage(game,</span>
                    vAttacksInArc, true);
        } else {
            // Send a client feedback request
<span class="nc" id="L13847">            List&lt;Integer&gt; apdsDists = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L13848" title="All 2 branches missed.">            for (WeaponAttackAction waa : vAttacksInArc) {</span>
<span class="nc" id="L13849">                apdsDists.add(waa.getTarget(game).getPosition()</span>
<span class="nc" id="L13850">                        .distance(e.getPosition()));</span>
<span class="nc" id="L13851">            }</span>
<span class="nc" id="L13852">            sendAPDSAssignCFR(e, apdsDists, vAttacksInArc);</span>
<span class="nc" id="L13853">            synchronized (cfrPacketQueue) {</span>
                try {
<span class="nc" id="L13855">                    cfrPacketQueue.wait();</span>
<span class="nc" id="L13856">                } catch (InterruptedException ex) {</span>
                    // Do nothing
<span class="nc" id="L13858">                }</span>
<span class="nc bnc" id="L13859" title="All 2 branches missed.">                if (cfrPacketQueue.size() &gt; 0) {</span>
<span class="nc" id="L13860">                    ReceivedPacket rp = cfrPacketQueue.poll();</span>
<span class="nc" id="L13861">                    int cfrType = (int) rp.packet.getData()[0];</span>
                    // Make sure we got the right type of response
<span class="nc bnc" id="L13863" title="All 2 branches missed.">                    if (cfrType != Packet.COMMAND_CFR_APDS_ASSIGN) {</span>
<span class="nc" id="L13864">                        MegaMek.getLogger().error(&quot;Expected a COMMAND_CFR_AMS_ASSIGN CFR packet, received: &quot; + cfrType);</span>
<span class="nc" id="L13865">                        throw new IllegalStateException();</span>
                    }
<span class="nc" id="L13867">                    Integer waaIndex =</span>
<span class="nc" id="L13868">                            (Integer)rp.packet.getData()[1];</span>
<span class="nc bnc" id="L13869" title="All 2 branches missed.">                    if (waaIndex != null) {</span>
<span class="nc" id="L13870">                        targetedWAA = vAttacksInArc.get(waaIndex);</span>
                    }
                }
<span class="nc" id="L13873">            }</span>
        }

<span class="nc bnc" id="L13876" title="All 2 branches missed.">        if (targetedWAA != null) {</span>
<span class="nc" id="L13877">            targetedWAA.addCounterEquipment(apds);</span>
<span class="nc" id="L13878">            return targetedWAA;</span>
        } else {
<span class="nc" id="L13880">            return null;</span>
        }
    }

    /**
     * Convenience method for determining which missile attack will be targeted
     * with AMS on the supplied Entity
     *
     * @param e
     *            The Entity with AMS
     * @param vAttacks
     *            List of missile attacks directed at e
     */
    private void manuallyAssignAMSTarget(Entity e,
            Vector&lt;WeaponHandler&gt; vAttacks) {
        //Fix for bug #1051 - don't send the targeting nag for a shutdown unit
<span class="nc bnc" id="L13896" title="All 2 branches missed.">        if (e.isShutDown()) {</span>
<span class="nc" id="L13897">            return;</span>
        }
        // Current AMS targets: each attack can only be targeted once
<span class="nc" id="L13900">        HashSet&lt;WeaponAttackAction&gt; amsTargets = new HashSet&lt;&gt;();</span>
        // Pick assignment for each active AMS
<span class="nc bnc" id="L13902" title="All 2 branches missed.">        for (Mounted ams : e.getActiveAMS()) {</span>
            // Skip APDS
<span class="nc bnc" id="L13904" title="All 2 branches missed.">            if (ams.isAPDS()) {</span>
<span class="nc" id="L13905">                continue;</span>
            }
            // Create a list of valid assignments for this AMS
<span class="nc" id="L13908">            List&lt;WeaponAttackAction&gt; vAttacksInArc = new ArrayList&lt;&gt;(vAttacks.size());</span>
<span class="nc bnc" id="L13909" title="All 2 branches missed.">            for (WeaponHandler wr : vAttacks) {</span>
<span class="nc bnc" id="L13910" title="All 2 branches missed.">                if (!amsTargets.contains(wr.waa)</span>
<span class="nc bnc" id="L13911" title="All 2 branches missed.">                        &amp;&amp; Compute.isInArc(game, e.getId(),</span>
<span class="nc" id="L13912">                                e.getEquipmentNum(ams),</span>
<span class="nc" id="L13913">                                game.getEntity(wr.waa.getEntityId()))) {</span>
<span class="nc" id="L13914">                    vAttacksInArc.add(wr.waa);</span>
                }
<span class="nc" id="L13916">            }</span>

            // If there are no valid attacks left, don't bother
<span class="nc bnc" id="L13919" title="All 2 branches missed.">            if (vAttacksInArc.size() &lt; 1) {</span>
<span class="nc" id="L13920">                continue;</span>
            }

<span class="nc" id="L13923">            WeaponAttackAction targetedWAA = null;</span>

<span class="nc bnc" id="L13925" title="All 2 branches missed.">            if (ams.curMode().equals(&quot;Automatic&quot;)) {</span>
<span class="nc" id="L13926">                targetedWAA = Compute.getHighestExpectedDamage(game,</span>
                        vAttacksInArc, true);
            } else {
                // Send a client feedback request
<span class="nc" id="L13930">                sendAMSAssignCFR(e, ams, vAttacksInArc);</span>
<span class="nc" id="L13931">                synchronized (cfrPacketQueue) {</span>
                    try {
<span class="nc" id="L13933">                        cfrPacketQueue.wait();</span>
<span class="nc" id="L13934">                    } catch (InterruptedException ex) {</span>
                        // Do nothing
<span class="nc" id="L13936">                    }</span>
<span class="nc bnc" id="L13937" title="All 2 branches missed.">                    if (cfrPacketQueue.size() &gt; 0) {</span>
<span class="nc" id="L13938">                        ReceivedPacket rp = cfrPacketQueue.poll();</span>
<span class="nc" id="L13939">                        int cfrType = (int) rp.packet.getData()[0];</span>
                        // Make sure we got the right type of response
<span class="nc bnc" id="L13941" title="All 2 branches missed.">                        if (cfrType != Packet.COMMAND_CFR_AMS_ASSIGN) {</span>
<span class="nc" id="L13942">                            MegaMek.getLogger().error(&quot;Expected a COMMAND_CFR_AMS_ASSIGN CFR packet, received: &quot; + cfrType);</span>
<span class="nc" id="L13943">                            throw new IllegalStateException();</span>
                        }
<span class="nc" id="L13945">                        Integer waaIndex =</span>
<span class="nc" id="L13946">                                (Integer)rp.packet.getData()[1];</span>
<span class="nc bnc" id="L13947" title="All 2 branches missed.">                        if (waaIndex != null) {</span>
<span class="nc" id="L13948">                            targetedWAA = vAttacksInArc.get(waaIndex);</span>
                        }
                    }
<span class="nc" id="L13951">                }</span>
            }

<span class="nc bnc" id="L13954" title="All 2 branches missed.">            if (targetedWAA != null) {</span>
<span class="nc" id="L13955">                targetedWAA.addCounterEquipment(ams);</span>
<span class="nc" id="L13956">                amsTargets.add(targetedWAA);</span>
            }
<span class="nc" id="L13958">        }</span>
<span class="nc" id="L13959">    }</span>

    /**
     * Convenience method for computing a mapping of which Coords are
     * &quot;protected&quot; by an APDS. Protection implies that the coords is within the
     * range/arc of an active APDS.
     *
     * @return
     */
    private Hashtable&lt;Coords, List&lt;Mounted&gt;&gt; getAPDSProtectedCoords() {
        // Get all of the coords that would be protected by APDS
<span class="nc" id="L13970">        Hashtable&lt;Coords, List&lt;Mounted&gt;&gt; apdsCoords = new Hashtable&lt;&gt;();</span>
<span class="nc bnc" id="L13971" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
            // Ignore Entitys without positions
<span class="nc bnc" id="L13973" title="All 2 branches missed.">            if (e.getPosition() == null) {</span>
<span class="nc" id="L13974">                continue;</span>
            }
<span class="nc" id="L13976">            Coords origPos = e.getPosition();</span>
<span class="nc bnc" id="L13977" title="All 2 branches missed.">            for (Mounted ams : e.getActiveAMS()) {</span>
                // Ignore non-APDS AMS
<span class="nc bnc" id="L13979" title="All 2 branches missed.">                if (!ams.isAPDS()) {</span>
<span class="nc" id="L13980">                    continue;</span>
                }
                // Add the current hex as a defended location
<span class="nc" id="L13983">                List&lt;Mounted&gt; apdsList = apdsCoords.computeIfAbsent(origPos, k -&gt; new ArrayList&lt;&gt;());</span>
<span class="nc" id="L13984">                apdsList.add(ams);</span>
                // Add each coords that is within arc/range as protected
<span class="nc" id="L13986">                int maxDist = 3;</span>
<span class="nc bnc" id="L13987" title="All 2 branches missed.">                if (e instanceof BattleArmor) {</span>
<span class="nc" id="L13988">                    int numTroopers = ((BattleArmor) e)</span>
<span class="nc" id="L13989">                            .getNumberActiverTroopers();</span>
<span class="nc bnc" id="L13990" title="All 3 branches missed.">                    switch (numTroopers) {</span>
                        case 1:
<span class="nc" id="L13992">                            maxDist = 1;</span>
<span class="nc" id="L13993">                            break;</span>
                        case 2:
                        case 3:
<span class="nc" id="L13996">                            maxDist = 2;</span>
                            break;
                    // Anything above is the same as the default
                    }
                }
<span class="nc bnc" id="L14001" title="All 2 branches missed.">                for (int dist = 1; dist &lt;= maxDist; dist++) {</span>
<span class="nc" id="L14002">                    List&lt;Coords&gt; coords = e.getPosition().allAtDistance(dist);</span>
<span class="nc bnc" id="L14003" title="All 2 branches missed.">                    for (Coords pos : coords) {</span>
                        // Check that we're in the right arc
<span class="nc bnc" id="L14005" title="All 2 branches missed.">                        if (Compute.isInArc(game, e.getId(), e.getEquipmentNum(ams),</span>
<span class="nc" id="L14006">                                new HexTarget(pos, game.getBoard(), HexTarget.TYPE_HEX_CLEAR))) {</span>
<span class="nc" id="L14007">                            apdsList = apdsCoords.computeIfAbsent(pos, k -&gt; new ArrayList&lt;&gt;());</span>
<span class="nc" id="L14008">                            apdsList.add(ams);</span>
                        }
<span class="nc" id="L14010">                    }</span>
                }

<span class="nc" id="L14013">            }</span>
<span class="nc" id="L14014">        }</span>
<span class="nc" id="L14015">        return apdsCoords;</span>
    }

    /**
     * Called at the start and end of movement. Determines if an entity
     * has been detected and/or had a firing solution calculated
     */
    private void detectSpacecraft() {
        // Don't bother if we're not in space or if the game option isn't on
<span class="nc bnc" id="L14024" title="All 2 branches missed.">        if (!game.getBoard().inSpace()</span>
<span class="nc bnc" id="L14025" title="All 2 branches missed.">                || !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ADVANCED_SENSORS)) {</span>
<span class="nc" id="L14026">            return;</span>
        }

        //Now, run the detection rolls
<span class="nc bnc" id="L14030" title="All 2 branches missed.">        for (Entity detector : game.getEntitiesVector()) {</span>
            //Don't process for invalid units
            //in the case of squadrons and transports, we want the 'host'
            //unit, not the component entities
<span class="nc bnc" id="L14034" title="All 2 branches missed.">            if (detector.getPosition() == null</span>
<span class="nc bnc" id="L14035" title="All 2 branches missed.">                    || detector.isDestroyed()</span>
<span class="nc bnc" id="L14036" title="All 2 branches missed.">                    || detector.isDoomed()</span>
<span class="nc bnc" id="L14037" title="All 2 branches missed.">                    || detector.isOffBoard()</span>
<span class="nc bnc" id="L14038" title="All 2 branches missed.">                    || detector.isPartOfFighterSquadron()</span>
<span class="nc bnc" id="L14039" title="All 2 branches missed.">                    || detector.getTransportId() != Entity.NONE) {</span>
<span class="nc" id="L14040">                continue;</span>
            }
<span class="nc bnc" id="L14042" title="All 2 branches missed.">            for (Entity target : game.getEntitiesVector()) {</span>
                //Once a target is detected, we don't need to detect it again
<span class="nc bnc" id="L14044" title="All 2 branches missed.">                if (detector.hasSensorContactFor(target.getId())) {</span>
<span class="nc" id="L14045">                    continue;</span>
                }
                //Don't process for invalid units
                //in the case of squadrons and transports, we want the 'host'
                //unit, not the component entities
<span class="nc bnc" id="L14050" title="All 2 branches missed.">                if (target.getPosition() == null</span>
<span class="nc bnc" id="L14051" title="All 2 branches missed.">                        || target.isDestroyed()</span>
<span class="nc bnc" id="L14052" title="All 2 branches missed.">                        || target.isDoomed()</span>
<span class="nc bnc" id="L14053" title="All 2 branches missed.">                        || target.isOffBoard()</span>
<span class="nc bnc" id="L14054" title="All 2 branches missed.">                        || target.isPartOfFighterSquadron()</span>
<span class="nc bnc" id="L14055" title="All 2 branches missed.">                        || target.getTransportId() != Entity.NONE) {</span>
<span class="nc" id="L14056">                    continue;</span>
                }
                // Only process for enemy units
<span class="nc bnc" id="L14059" title="All 2 branches missed.">                if (!detector.isEnemyOf(target)) {</span>
<span class="nc" id="L14060">                    continue;</span>
                }
                //If we successfully detect the enemy, add it to the appropriate detector's sensor contacts list
<span class="nc bnc" id="L14063" title="All 2 branches missed.">                if (Compute.calcSensorContact(game, detector, target)) {</span>
<span class="nc" id="L14064">                    game.getEntity(detector.getId()).addSensorContact(target.getId());</span>
                    //If detector is part of a C3 network, share the contact
<span class="nc bnc" id="L14066" title="All 2 branches missed.">                    if (detector.hasNavalC3()) {</span>
<span class="nc bnc" id="L14067" title="All 2 branches missed.">                        for (Entity c3NetMate : game.getC3NetworkMembers(detector)) {</span>
<span class="nc" id="L14068">                            game.getEntity(c3NetMate.getId()).addSensorContact(target.getId());</span>
<span class="nc" id="L14069">                        }</span>
                    }
                }
<span class="nc" id="L14072">            }</span>
<span class="nc" id="L14073">        }</span>
        //Now, run the firing solution calculations
<span class="nc bnc" id="L14075" title="All 2 branches missed.">        for (Entity detector : game.getEntitiesVector()) {</span>
            //Don't process for invalid units
            //in the case of squadrons and transports, we want the 'host'
            //unit, not the component entities
<span class="nc bnc" id="L14079" title="All 2 branches missed.">            if (detector.getPosition() == null</span>
<span class="nc bnc" id="L14080" title="All 2 branches missed.">                    || detector.isDestroyed()</span>
<span class="nc bnc" id="L14081" title="All 2 branches missed.">                    || detector.isDoomed()</span>
<span class="nc bnc" id="L14082" title="All 2 branches missed.">                    || detector.isOffBoard()</span>
<span class="nc bnc" id="L14083" title="All 2 branches missed.">                    || detector.isPartOfFighterSquadron()</span>
<span class="nc bnc" id="L14084" title="All 2 branches missed.">                    || detector.getTransportId() != Entity.NONE) {</span>
<span class="nc" id="L14085">                continue;</span>
            }
<span class="nc bnc" id="L14087" title="All 2 branches missed.">            for (int targetId : detector.getSensorContacts()) {</span>
<span class="nc" id="L14088">                Entity target = game.getEntity(targetId);</span>
                //if we already have a firing solution, no need to process a new one
<span class="nc bnc" id="L14090" title="All 2 branches missed.">                if (detector.hasFiringSolutionFor(targetId)) {</span>
<span class="nc" id="L14091">                    continue;</span>
                }
                //Don't process for invalid units
                //in the case of squadrons and transports, we want the 'host'
                //unit, not the component entities
<span class="nc bnc" id="L14096" title="All 2 branches missed.">                if (target == null</span>
<span class="nc bnc" id="L14097" title="All 2 branches missed.">                        || target.getPosition() == null</span>
<span class="nc bnc" id="L14098" title="All 2 branches missed.">                        || target.isDestroyed()</span>
<span class="nc bnc" id="L14099" title="All 2 branches missed.">                        || target.isDoomed()</span>
<span class="nc bnc" id="L14100" title="All 2 branches missed.">                        || target.isOffBoard()</span>
<span class="nc bnc" id="L14101" title="All 2 branches missed.">                        || target.isPartOfFighterSquadron()</span>
<span class="nc bnc" id="L14102" title="All 2 branches missed.">                        || target.getTransportId() != Entity.NONE) {</span>
<span class="nc" id="L14103">                    continue;</span>
                }
                // Only process for enemy units
<span class="nc bnc" id="L14106" title="All 2 branches missed.">                if (!detector.isEnemyOf(target)) {</span>
<span class="nc" id="L14107">                    continue;</span>
                }
                //If we successfully lock up the enemy, add it to the appropriate detector's firing solutions list
<span class="nc bnc" id="L14110" title="All 2 branches missed.">                if (Compute.calcFiringSolution(game, detector, target)) {</span>
<span class="nc" id="L14111">                    game.getEntity(detector.getId()).addFiringSolution(targetId);</span>
                }
<span class="nc" id="L14113">            }</span>
<span class="nc" id="L14114">        }</span>
<span class="nc" id="L14115">    }</span>

    /**
     * Called at the end of movement. Determines if an entity
     * has moved beyond sensor range
     */
    private void updateSpacecraftDetection() {
        // Don't bother if we're not in space or if the game option isn't on
<span class="nc bnc" id="L14123" title="All 2 branches missed.">        if (!game.getBoard().inSpace()</span>
<span class="nc bnc" id="L14124" title="All 2 branches missed.">                || !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ADVANCED_SENSORS)) {</span>
<span class="nc" id="L14125">            return;</span>
        }
        //Run through our list of units and remove any entities from the plotting board that have moved out of range
<span class="nc bnc" id="L14128" title="All 2 branches missed.">        for (Entity detector : game.getEntitiesVector()) {</span>
<span class="nc" id="L14129">            Compute.updateFiringSolutions(game, detector);</span>
<span class="nc" id="L14130">            Compute.updateSensorContacts(game, detector);</span>
<span class="nc" id="L14131">        }</span>
<span class="nc" id="L14132">    }</span>

    /**
     * Checks to see if any units can detected hidden units.
     */
    private void detectHiddenUnits() {
        // If hidden units aren't on, nothing to do
<span class="nc bnc" id="L14139" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.ADVANCED_HIDDEN_UNITS)) {</span>
<span class="nc" id="L14140">            return;</span>
        }
        // Get all hidden units
<span class="nc" id="L14143">        List&lt;Entity&gt; hiddenUnits = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L14144" title="All 2 branches missed.">        for (Entity ent : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L14145" title="All 2 branches missed.">            if (ent.isHidden()) {</span>
<span class="nc" id="L14146">                hiddenUnits.add(ent);</span>
            }
<span class="nc" id="L14148">        }</span>

        // If no one is hidden, there's nothing to do
<span class="nc bnc" id="L14151" title="All 2 branches missed.">        if (hiddenUnits.size() &lt; 1) {</span>
<span class="nc" id="L14152">            return;</span>
        }

<span class="nc" id="L14155">        Set&lt;Integer&gt; reportPlayers = new HashSet&lt;&gt;();</span>
        // See if any unit with a probe, detects any hidden units
<span class="nc bnc" id="L14157" title="All 2 branches missed.">        for (Entity detector : game.getEntitiesVector()) {</span>
<span class="nc" id="L14158">            int probeRange = detector.getBAPRange();</span>

            // Units without a position won't be able to detect
<span class="nc bnc" id="L14161" title="All 2 branches missed.">            if (detector.getPosition() == null) {</span>
<span class="nc" id="L14162">                continue;</span>
            }

<span class="nc bnc" id="L14165" title="All 2 branches missed.">            for (Entity detected : hiddenUnits) {</span>
                // Only detected enemy units
<span class="nc bnc" id="L14167" title="All 2 branches missed.">                if (!detector.isEnemyOf(detected)) {</span>
<span class="nc" id="L14168">                    continue;</span>
                }
                // Can't detect units without a position
<span class="nc bnc" id="L14171" title="All 2 branches missed.">                if (detected.getPosition() == null) {</span>
<span class="nc" id="L14172">                    continue;</span>
                }
                // Can only detect units within the probes range
<span class="nc" id="L14175">                int dist = detector.getPosition().distance(</span>
<span class="nc" id="L14176">                        detected.getPosition());</span>

                // An adjacent enemy unit will detect hidden units, TW pg 259
<span class="nc bnc" id="L14179" title="All 4 branches missed.">                if (dist &gt; 1 &amp;&amp; dist &gt; probeRange) {</span>
<span class="nc" id="L14180">                    continue;</span>
                }

                // Check for Void/Null Sig - only detected by Bloodhound probes
<span class="nc bnc" id="L14184" title="All 4 branches missed.">                if (dist &gt; 1 &amp;&amp; (detected instanceof Mech)) {</span>
<span class="nc" id="L14185">                    Mech m = (Mech)detected;</span>
<span class="nc bnc" id="L14186" title="All 4 branches missed.">                    if ((m.isVoidSigActive() || m.isNullSigActive())</span>
<span class="nc bnc" id="L14187" title="All 2 branches missed.">                            &amp;&amp; !detector.hasWorkingMisc(MiscType.F_BLOODHOUND)) {</span>
<span class="nc" id="L14188">                        continue;</span>
                    }
                }

                // Check for Infantry stealth armor
<span class="nc bnc" id="L14193" title="All 4 branches missed.">                if (dist &gt; 1 &amp;&amp; (detected instanceof BattleArmor)) {</span>
<span class="nc" id="L14194">                    BattleArmor ba = (BattleArmor) detected;</span>
                    // Need Bloodhound to detect BA stealth armor
<span class="nc bnc" id="L14196" title="All 2 branches missed.">                    if (ba.isStealthy()</span>
<span class="nc bnc" id="L14197" title="All 2 branches missed.">                            &amp;&amp; !detector.hasWorkingMisc(MiscType.F_BLOODHOUND)) {</span>
<span class="nc" id="L14198">                        continue;</span>
                    }
<span class="nc bnc" id="L14200" title="All 4 branches missed.">                } else if (dist &gt; 1 &amp;&amp; (detected instanceof Infantry)) {</span>
<span class="nc" id="L14201">                    Infantry inf = (Infantry) detected;</span>
                    // Can't detect sneaky infantry
<span class="nc bnc" id="L14203" title="All 2 branches missed.">                    if (inf.isStealthy()) {</span>
<span class="nc" id="L14204">                        continue;</span>
                    }
                    // Need bloodhound to detect non-sneaky inf
<span class="nc bnc" id="L14207" title="All 2 branches missed.">                    if (!detector.hasWorkingMisc(MiscType.F_BLOODHOUND)) {</span>
<span class="nc" id="L14208">                        continue;</span>
                    }
                }

<span class="nc" id="L14212">                LosEffects los = LosEffects.calculateLos(game,</span>
<span class="nc" id="L14213">                        detector.getId(), detected);</span>
<span class="nc bnc" id="L14214" title="All 4 branches missed.">                if (los.canSee() || dist &lt;= 1) {</span>
<span class="nc" id="L14215">                    detected.setHidden(false);</span>
<span class="nc" id="L14216">                    entityUpdate(detected.getId());</span>
<span class="nc" id="L14217">                    Report r = new Report(9960);</span>
<span class="nc" id="L14218">                    r.addDesc(detector);</span>
<span class="nc" id="L14219">                    r.subject = detector.getId();</span>
<span class="nc" id="L14220">                    r.add(detected.getPosition().getBoardNum());</span>
<span class="nc" id="L14221">                    vPhaseReport.addElement(r);</span>
<span class="nc" id="L14222">                    Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L14223">                    reportPlayers.add(detector.getOwnerId());</span>
<span class="nc" id="L14224">                    reportPlayers.add(detected.getOwnerId());</span>
                }
<span class="nc" id="L14226">            }</span>
<span class="nc" id="L14227">        }</span>

<span class="nc bnc" id="L14229" title="All 4 branches missed.">        if (vPhaseReport.size() &gt; 0 &amp;&amp; game.getPhase() == Phase.PHASE_MOVEMENT</span>
<span class="nc bnc" id="L14230" title="All 2 branches missed.">                &amp;&amp; (game.getTurnIndex() + 1) &lt; game.getTurnVector().size()) {</span>
<span class="nc bnc" id="L14231" title="All 2 branches missed.">            for (Integer playerId : reportPlayers) {</span>
<span class="nc" id="L14232">                send(playerId, createSpecialReportPacket());</span>
<span class="nc" id="L14233">            }</span>
        }
<span class="nc" id="L14235">    }</span>

    /**
     * Called to what players can see what units. This is used to determine who
     * can see what in double blind reports.
     */
    private void resolveWhatPlayersCanSeeWhatUnits() {
<span class="nc" id="L14242">        List&lt;ECMInfo&gt; allECMInfo = null;</span>
<span class="nc bnc" id="L14243" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_SENSORS)) {</span>
<span class="nc" id="L14244">            allECMInfo = ComputeECM.computeAllEntitiesECMInfo(game</span>
<span class="nc" id="L14245">                    .getEntitiesVector());</span>
        }
<span class="nc" id="L14247">        Map&lt;EntityTargetPair, LosEffects&gt; losCache = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L14248" title="All 2 branches missed.">        for (Entity entity : game.getEntitiesVector()) {</span>
            // We are hidden once again!
<span class="nc" id="L14250">            entity.clearSeenBy();</span>
<span class="nc" id="L14251">            entity.clearDetectedBy();</span>
            // Handle visual spotting
<span class="nc bnc" id="L14253" title="All 2 branches missed.">            for (IPlayer p : whoCanSee(entity, false, losCache)) {</span>
<span class="nc" id="L14254">                entity.addBeenSeenBy(p);</span>
<span class="nc" id="L14255">            }</span>
            // Handle detection by sensors
<span class="nc bnc" id="L14257" title="All 2 branches missed.">            for (IPlayer p : whoCanDetect(entity, allECMInfo, losCache)) {</span>
<span class="nc" id="L14258">                    entity.addBeenDetectedBy(p);</span>
<span class="nc" id="L14259">            }</span>
<span class="nc" id="L14260">        }</span>
<span class="nc" id="L14261">    }</span>

    /**
     * Called during the weapons fire phase. Resolves anything other than
     * weapons fire that happens. Torso twists, for example.
     */
    private void resolveAllButWeaponAttacks() {
<span class="nc" id="L14268">        Vector&lt;EntityAction&gt; triggerPodActions = new Vector&lt;&gt;();</span>
        // loop through actions and handle everything we expect except attacks
<span class="nc" id="L14270">        for (Enumeration&lt;EntityAction&gt; i = game.getActions(); i</span>
<span class="nc bnc" id="L14271" title="All 2 branches missed.">                .hasMoreElements(); ) {</span>
<span class="nc" id="L14272">            EntityAction ea = i.nextElement();</span>
<span class="nc" id="L14273">            Entity entity = game.getEntity(ea.getEntityId());</span>
<span class="nc bnc" id="L14274" title="All 2 branches missed.">            if (ea instanceof TorsoTwistAction) {</span>
<span class="nc" id="L14275">                TorsoTwistAction tta = (TorsoTwistAction) ea;</span>
<span class="nc bnc" id="L14276" title="All 2 branches missed.">                if (entity.canChangeSecondaryFacing()) {</span>
<span class="nc" id="L14277">                    entity.setSecondaryFacing(tta.getFacing());</span>
<span class="nc" id="L14278">                    entity.postProcessFacingChange();</span>
                }
<span class="nc bnc" id="L14280" title="All 2 branches missed.">            } else if (ea instanceof FlipArmsAction) {</span>
<span class="nc" id="L14281">                FlipArmsAction faa = (FlipArmsAction) ea;</span>
<span class="nc" id="L14282">                entity.setArmsFlipped(faa.getIsFlipped());</span>
<span class="nc bnc" id="L14283" title="All 2 branches missed.">            } else if (ea instanceof FindClubAction) {</span>
<span class="nc" id="L14284">                resolveFindClub(entity);</span>
<span class="nc bnc" id="L14285" title="All 2 branches missed.">            } else if (ea instanceof UnjamAction) {</span>
<span class="nc" id="L14286">                resolveUnjam(entity);</span>
<span class="nc bnc" id="L14287" title="All 2 branches missed.">            } else if (ea instanceof ClearMinefieldAction) {</span>
<span class="nc" id="L14288">                resolveClearMinefield(entity,</span>
<span class="nc" id="L14289">                                      ((ClearMinefieldAction) ea).getMinefield());</span>
<span class="nc bnc" id="L14290" title="All 2 branches missed.">            } else if (ea instanceof TriggerAPPodAction) {</span>
<span class="nc" id="L14291">                TriggerAPPodAction tapa = (TriggerAPPodAction) ea;</span>

                // Don't trigger the same pod twice.
<span class="nc bnc" id="L14294" title="All 2 branches missed.">                if (!triggerPodActions.contains(tapa)) {</span>
<span class="nc" id="L14295">                    triggerAPPod(entity, tapa.getPodId());</span>
<span class="nc" id="L14296">                    triggerPodActions.addElement(tapa);</span>
                } else {
<span class="nc" id="L14298">                    MegaMek.getLogger().error(&quot;AP Pod #&quot; + tapa.getPodId() + &quot; on &quot; + entity.getDisplayName()</span>
                                    + &quot; was already triggered this round!!&quot;);
                }
<span class="nc bnc" id="L14301" title="All 2 branches missed.">            } else if (ea instanceof TriggerBPodAction) {</span>
<span class="nc" id="L14302">                TriggerBPodAction tba = (TriggerBPodAction) ea;</span>

                // Don't trigger the same pod twice.
<span class="nc bnc" id="L14305" title="All 2 branches missed.">                if (!triggerPodActions.contains(tba)) {</span>
<span class="nc" id="L14306">                    triggerBPod(entity, tba.getPodId(),</span>
<span class="nc" id="L14307">                                game.getEntity(tba.getTargetId()));</span>
<span class="nc" id="L14308">                    triggerPodActions.addElement(tba);</span>
                } else {
<span class="nc" id="L14310">                    MegaMek.getLogger().error(&quot;B Pod #&quot; + tba.getPodId() + &quot; on &quot; + entity.getDisplayName()</span>
                                    + &quot; was already triggered this round!!&quot;);
                }
<span class="nc bnc" id="L14313" title="All 2 branches missed.">            } else if (ea instanceof SearchlightAttackAction) {</span>
<span class="nc" id="L14314">                SearchlightAttackAction saa = (SearchlightAttackAction) ea;</span>
<span class="nc" id="L14315">                addReport(saa.resolveAction(game));</span>
<span class="nc bnc" id="L14316" title="All 2 branches missed.">            } else if (ea instanceof UnjamTurretAction) {</span>
<span class="nc bnc" id="L14317" title="All 2 branches missed.">                if (entity instanceof Tank) {</span>
<span class="nc" id="L14318">                    ((Tank) entity).unjamTurret(((Tank) entity).getLocTurret());</span>
<span class="nc" id="L14319">                    ((Tank) entity)</span>
<span class="nc" id="L14320">                            .unjamTurret(((Tank) entity).getLocTurret2());</span>
<span class="nc" id="L14321">                    Report r = new Report(3033);</span>
<span class="nc" id="L14322">                    r.addDesc(entity);</span>
<span class="nc" id="L14323">                    addReport(r);</span>
<span class="nc" id="L14324">                } else {</span>
<span class="nc" id="L14325">                    MegaMek.getLogger().error(&quot;Non-Tank tried to unjam turret&quot;);</span>
                }
<span class="nc bnc" id="L14327" title="All 2 branches missed.">            } else if (ea instanceof RepairWeaponMalfunctionAction) {</span>
<span class="nc bnc" id="L14328" title="All 2 branches missed.">                if (entity instanceof Tank) {</span>
<span class="nc" id="L14329">                    Mounted m = entity</span>
<span class="nc" id="L14330">                            .getEquipment(((RepairWeaponMalfunctionAction) ea)</span>
<span class="nc" id="L14331">                                                  .getWeaponId());</span>
<span class="nc" id="L14332">                    m.setJammed(false);</span>
<span class="nc" id="L14333">                    ((Tank) entity).getJammedWeapons().remove(m);</span>
<span class="nc" id="L14334">                    Report r = new Report(3034);</span>
<span class="nc" id="L14335">                    r.subject = entity.getId();</span>
<span class="nc" id="L14336">                    r.addDesc(entity);</span>
<span class="nc" id="L14337">                    r.add(m.getName());</span>
<span class="nc" id="L14338">                    addReport(r);</span>
<span class="nc" id="L14339">                } else {</span>
<span class="nc" id="L14340">                    MegaMek.getLogger().error(&quot;Non-Tank tried to repair weapon malfunction&quot;);</span>
                }
            }
<span class="nc" id="L14343">        }</span>
<span class="nc" id="L14344">    }</span>

    /*
     * Called during the weapons firing phase to initiate self destruction.
     */
    private void resolveSelfDestructions() {
<span class="nc" id="L14350">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc bnc" id="L14352" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L14353" title="All 4 branches missed.">            if (e.getSelfDestructInitiated() &amp;&amp; e.hasEngine()) {</span>
<span class="nc" id="L14354">                r = new Report(6166, Report.PUBLIC);</span>
<span class="nc" id="L14355">                int target = e.getCrew().getPiloting();</span>
<span class="nc" id="L14356">                int roll = e.getCrew().rollPilotingSkill();</span>
<span class="nc" id="L14357">                r.subject = e.getId();</span>
<span class="nc" id="L14358">                r.addDesc(e);</span>
<span class="nc" id="L14359">                r.indent();</span>
<span class="nc" id="L14360">                r.add(target);</span>
<span class="nc" id="L14361">                r.add(roll);</span>
<span class="nc bnc" id="L14362" title="All 2 branches missed.">                if (roll &gt;= target) {</span>
<span class="nc" id="L14363">                    r.choose(true);</span>
                } else {
<span class="nc" id="L14365">                    r.choose(false);</span>
                }
<span class="nc" id="L14367">                vDesc.add(r);</span>

                // Blow it up...
<span class="nc bnc" id="L14370" title="All 2 branches missed.">                if (roll &gt;= target) {</span>
<span class="nc" id="L14371">                    int engineRating = e.getEngine().getRating();</span>
<span class="nc" id="L14372">                    r = new Report(5400, Report.PUBLIC);</span>
<span class="nc" id="L14373">                    r.subject = e.getId();</span>
<span class="nc" id="L14374">                    r.indent(2);</span>
<span class="nc" id="L14375">                    vDesc.add(r);</span>

<span class="nc bnc" id="L14377" title="All 2 branches missed.">                    if (e instanceof Mech) {</span>
<span class="nc" id="L14378">                        Mech mech = (Mech) e;</span>
<span class="nc bnc" id="L14379" title="All 2 branches missed.">                        if (mech.isAutoEject()</span>
<span class="nc bnc" id="L14380" title="All 2 branches missed.">                                &amp;&amp; (!game.getOptions().booleanOption(</span>
                                        OptionsConstants.RPG_CONDITIONAL_EJECTION) || (game
<span class="nc bnc" id="L14382" title="All 2 branches missed.">                                        .getOptions().booleanOption(</span>
                                                OptionsConstants.RPG_CONDITIONAL_EJECTION) &amp;&amp; mech
<span class="nc bnc" id="L14384" title="All 2 branches missed.">                                        .isCondEjectEngine()))) {</span>
<span class="nc" id="L14385">                            vDesc.addAll(ejectEntity(e, true));</span>
                        }
                    }
<span class="nc" id="L14388">                    e.setSelfDestructedThisTurn(true);</span>
<span class="nc" id="L14389">                    doFusionEngineExplosion(engineRating, e.getPosition(),</span>
                            vDesc, null);
<span class="nc" id="L14391">                    Report.addNewline(vDesc);</span>
<span class="nc" id="L14392">                    r = new Report(5410, Report.PUBLIC);</span>
<span class="nc" id="L14393">                    r.subject = e.getId();</span>
<span class="nc" id="L14394">                    r.indent(2);</span>
<span class="nc" id="L14395">                    Report.addNewline(vDesc);</span>
<span class="nc" id="L14396">                    vDesc.add(r);</span>
                }
<span class="nc" id="L14398">                e.setSelfDestructInitiated(false);</span>
            }
<span class="nc" id="L14400">        }</span>
<span class="nc" id="L14401">        addReport(vDesc);</span>
<span class="nc" id="L14402">    }</span>

    private void reportGhostTargetRolls() {
        // run through an enumeration of deployed game entities. If they have
        // ghost targets, then check the roll
        // and report it
        Report r;
<span class="nc bnc" id="L14409" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext(); ) {</span>
<span class="nc" id="L14410">            Entity ent = e.next();</span>
<span class="nc bnc" id="L14411" title="All 4 branches missed.">            if (ent.isDeployed() &amp;&amp; ent.hasGhostTargets(false)) {</span>
<span class="nc" id="L14412">                r = new Report(3630);</span>
<span class="nc" id="L14413">                r.subject = ent.getId();</span>
<span class="nc" id="L14414">                r.addDesc(ent);</span>
                // Ghost target mod is +3 per errata
<span class="nc" id="L14416">                int target = ent.getCrew().getPiloting() + 3;</span>
<span class="nc bnc" id="L14417" title="All 2 branches missed.">                if (ent.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</span>
<span class="nc" id="L14418">                    target = ent.getCrew().getGunnery() + 3;</span>
                }
<span class="nc" id="L14420">                int roll = ent.getGhostTargetRoll();</span>
<span class="nc" id="L14421">                r.add(target);</span>
<span class="nc" id="L14422">                r.add(roll);</span>
<span class="nc bnc" id="L14423" title="All 2 branches missed.">                if (roll &gt;= target) {</span>
<span class="nc" id="L14424">                    r.choose(true);</span>
                } else {
<span class="nc" id="L14426">                    r.choose(false);</span>
                }
<span class="nc" id="L14428">                addReport(r);</span>
            }
<span class="nc" id="L14430">        }</span>
<span class="nc" id="L14431">        addNewLines();</span>
<span class="nc" id="L14432">    }</span>

    private void reportLargeCraftECCMRolls() {
        // run through an enumeration of deployed game entities. If they are
        // large craft in space, then check the roll
        // and report it
<span class="nc bnc" id="L14438" title="All 2 branches missed.">        if (!game.getBoard().inSpace()</span>
<span class="nc bnc" id="L14439" title="All 2 branches missed.">            || !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ECM)) {</span>
<span class="nc" id="L14440">            return;</span>
        }
        Report r;
<span class="nc bnc" id="L14443" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext(); ) {</span>
<span class="nc" id="L14444">            Entity ent = e.next();</span>
<span class="nc bnc" id="L14445" title="All 4 branches missed.">            if (ent.isDeployed() &amp;&amp; ent.isLargeCraft()) {</span>
<span class="nc" id="L14446">                r = new Report(3635);</span>
<span class="nc" id="L14447">                r.subject = ent.getId();</span>
<span class="nc" id="L14448">                r.addDesc(ent);</span>
<span class="nc" id="L14449">                int target = ((Aero) ent).getECCMTarget();</span>
<span class="nc" id="L14450">                int roll = ((Aero) ent).getECCMRoll();</span>
<span class="nc" id="L14451">                r.add(roll);</span>
<span class="nc" id="L14452">                r.add(target);</span>
<span class="nc" id="L14453">                int mod = ((Aero) ent).getECCMBonus();</span>
<span class="nc" id="L14454">                r.add(mod);</span>
<span class="nc" id="L14455">                addReport(r);</span>
            }
<span class="nc" id="L14457">        }</span>
<span class="nc" id="L14458">    }</span>

    private void resolveClearMinefield(Entity ent, Minefield mf) {

<span class="nc bnc" id="L14462" title="All 6 branches missed.">        if ((null == mf) || (null == ent) || ent.isDoomed()</span>
<span class="nc bnc" id="L14463" title="All 2 branches missed.">            || ent.isDestroyed()) {</span>
<span class="nc" id="L14464">            return;</span>
        }

<span class="nc" id="L14467">        Coords pos = mf.getCoords();</span>
<span class="nc" id="L14468">        int clear = Minefield.CLEAR_NUMBER_INFANTRY;</span>
<span class="nc" id="L14469">        int boom = Minefield.CLEAR_NUMBER_INFANTRY_ACCIDENT;</span>

<span class="nc" id="L14471">        Report r = new Report(2245);</span>
        // Does the entity has a minesweeper?
<span class="nc bnc" id="L14473" title="All 2 branches missed.">        if ((ent instanceof BattleArmor)) {</span>
<span class="nc" id="L14474">            BattleArmor ba = (BattleArmor)ent;</span>
<span class="nc" id="L14475">            String mcmName = BattleArmor.MANIPULATOR_TYPE_STRINGS</span>
                    [BattleArmor.MANIPULATOR_BASIC_MINE_CLEARANCE];
<span class="nc bnc" id="L14477" title="All 2 branches missed.">            if (ba.getLeftManipulatorName().equals(mcmName)) {</span>
<span class="nc" id="L14478">                clear = Minefield.CLEAR_NUMBER_BA_SWEEPER;</span>
<span class="nc" id="L14479">                boom = Minefield.CLEAR_NUMBER_BA_SWEEPER_ACCIDENT;</span>
<span class="nc" id="L14480">                r = new Report(2246);</span>
            }
<span class="nc bnc" id="L14482" title="All 2 branches missed.">        } else if (ent instanceof Infantry) { // Check Minesweeping Engineers</span>
<span class="nc" id="L14483">            Infantry inf = (Infantry) ent;</span>
<span class="nc bnc" id="L14484" title="All 2 branches missed.">            if (inf.hasSpecialization(Infantry.MINE_ENGINEERS)) {</span>
<span class="nc" id="L14485">                clear = Minefield.CLEAR_NUMBER_INF_ENG;</span>
<span class="nc" id="L14486">                boom = Minefield.CLEAR_NUMBER_INF_ENG_ACCIDENT;</span>
<span class="nc" id="L14487">                r = new Report(2247);</span>
            }
        }
        // mine clearing roll
<span class="nc" id="L14491">        r.subject = ent.getId();</span>
<span class="nc" id="L14492">        r.add(ent.getShortName(), true);</span>
<span class="nc" id="L14493">        r.add(Minefield.getDisplayableName(mf.getType()));</span>
<span class="nc" id="L14494">        r.add(pos.getBoardNum(), true);</span>
<span class="nc" id="L14495">        addReport(r);</span>

<span class="nc bnc" id="L14497" title="All 2 branches missed.">        if (clearMinefield(mf, ent, clear, boom, vPhaseReport)) {</span>
<span class="nc" id="L14498">            removeMinefield(mf);</span>
        }
        // some mines might have blown up
<span class="nc" id="L14501">        resetMines();</span>

<span class="nc" id="L14503">        addNewLines();</span>
<span class="nc" id="L14504">    }</span>

    /**
     * Called during the fire phase to resolve all (and only) weapon attacks
     */
    private void resolveOnlyWeaponAttacks() {
        // loop through received attack actions, getting attack handlers
<span class="nc" id="L14511">        for (Enumeration&lt;EntityAction&gt; i = game.getActions(); i</span>
<span class="nc bnc" id="L14512" title="All 2 branches missed.">                .hasMoreElements(); ) {</span>
<span class="nc" id="L14513">            EntityAction ea = i.nextElement();</span>
<span class="nc bnc" id="L14514" title="All 2 branches missed.">            if (ea instanceof WeaponAttackAction) {</span>
<span class="nc" id="L14515">                WeaponAttackAction waa = (WeaponAttackAction) ea;</span>
<span class="nc" id="L14516">                Entity ae = game.getEntity(waa.getEntityId());</span>
<span class="nc" id="L14517">                Mounted m = ae.getEquipment(waa.getWeaponId());</span>
<span class="nc" id="L14518">                Weapon w = (Weapon) m.getType();</span>
                // Track attacks original target, for things like swarm LRMs
<span class="nc" id="L14520">                waa.setOriginalTargetId(waa.getTargetId());</span>
<span class="nc" id="L14521">                waa.setOriginalTargetType(waa.getTargetType());</span>
<span class="nc" id="L14522">                AttackHandler ah = w.fire(waa, game, this);</span>
<span class="nc bnc" id="L14523" title="All 2 branches missed.">                if (ah != null) {</span>
<span class="nc" id="L14524">                    ah.setStrafing(waa.isStrafing());</span>
<span class="nc" id="L14525">                    ah.setStrafingFirstShot(waa.isStrafingFirstShot());</span>
<span class="nc" id="L14526">                    game.addAttack(ah);</span>
                }
            }
<span class="nc" id="L14529">        }</span>
        // and clear the attacks Vector
<span class="nc" id="L14531">        game.resetActions();</span>
<span class="nc" id="L14532">    }</span>

    /**
     * Trigger the indicated AP Pod of the entity.
     *
     * @param entity the &lt;code&gt;Entity&lt;/code&gt; triggering the AP Pod.
     * @param podId  the &lt;code&gt;int&lt;/code&gt; ID of the AP Pod.
     */
    private void triggerAPPod(Entity entity, int podId) {
        // Get the mount for this pod.
<span class="nc" id="L14542">        Mounted mount = entity.getEquipment(podId);</span>

        // Confirm that this is, indeed, an AP Pod.
<span class="nc bnc" id="L14545" title="All 2 branches missed.">        if (null == mount) {</span>
<span class="nc" id="L14546">            MegaMek.getLogger().error(&quot;Expecting to find an AP Pod at &quot; + podId + &quot; on the unit, &quot; + entity.getDisplayName()</span>
                            + &quot; but found NO equipment at all!!!&quot;);
<span class="nc" id="L14548">            return;</span>
        }
<span class="nc" id="L14550">        EquipmentType equip = mount.getType();</span>
<span class="nc bnc" id="L14551" title="All 4 branches missed.">        if (!(equip instanceof MiscType) || !equip.hasFlag(MiscType.F_AP_POD)) {</span>
<span class="nc" id="L14552">            MegaMek.getLogger().error(&quot;Expecting to find an AP Pod at &quot; + podId + &quot; on the unit, &quot;+ entity.getDisplayName()</span>
<span class="nc" id="L14553">                            + &quot; but found &quot; + equip.getName() + &quot; instead!!!&quot;);</span>
<span class="nc" id="L14554">            return;</span>
        }

        // Now confirm that the entity can trigger the pod.
        // Ignore the &quot;used this round&quot; flag.
<span class="nc" id="L14559">        boolean oldFired = mount.isUsedThisRound();</span>
<span class="nc" id="L14560">        mount.setUsedThisRound(false);</span>
<span class="nc" id="L14561">        boolean canFire = mount.canFire();</span>
<span class="nc" id="L14562">        mount.setUsedThisRound(oldFired);</span>
<span class="nc bnc" id="L14563" title="All 2 branches missed.">        if (!canFire) {</span>
<span class="nc" id="L14564">            MegaMek.getLogger().error(&quot;Can not trigger the AP Pod at &quot; + podId + &quot; on the unit, &quot;</span>
<span class="nc" id="L14565">                    + entity.getDisplayName() + &quot;!!!&quot;);</span>
<span class="nc" id="L14566">            return;</span>
        }

        Report r;

        // Mark the pod as fired and log the action.
<span class="nc" id="L14572">        mount.setFired(true);</span>
<span class="nc" id="L14573">        r = new Report(3010);</span>
<span class="nc" id="L14574">        r.newlines = 0;</span>
<span class="nc" id="L14575">        r.subject = entity.getId();</span>
<span class="nc" id="L14576">        r.addDesc(entity);</span>
<span class="nc" id="L14577">        addReport(r);</span>

        // Walk through ALL entities in the triggering entity's hex.
<span class="nc bnc" id="L14580" title="All 2 branches missed.">        for (Entity target : game.getEntitiesVector(entity.getPosition())) {</span>

            // Is this an unarmored infantry platoon?
<span class="nc bnc" id="L14583" title="All 4 branches missed.">            if ((target instanceof Infantry)</span>
                &amp;&amp; !(target instanceof BattleArmor)) {

                // Roll d6-1 for damage.
<span class="nc" id="L14587">                final int damage = Math.max(1, Compute.d6() - 1);</span>

                // Damage the platoon.
<span class="nc" id="L14590">                addReport(damageEntity(target, new HitData(</span>
                        Infantry.LOC_INFANTRY), damage));

                // Damage from AP Pods is applied immediately.
<span class="nc" id="L14594">                target.applyDamage();</span>

<span class="nc" id="L14596">            } // End target-is-unarmored</span>

            // Nope, the target is immune.
            // Don't make a log entry for the triggering entity.
<span class="nc bnc" id="L14600" title="All 2 branches missed.">            else if (!entity.equals(target)) {</span>
<span class="nc" id="L14601">                r = new Report(3020);</span>
<span class="nc" id="L14602">                r.indent(2);</span>
<span class="nc" id="L14603">                r.subject = target.getId();</span>
<span class="nc" id="L14604">                r.addDesc(target);</span>
<span class="nc" id="L14605">                addReport(r);</span>
            }

<span class="nc" id="L14608">        } // Check the next entity in the triggering entity's hex.</span>
<span class="nc" id="L14609">    }</span>

    /**
     * Trigger the indicated B Pod of the entity.
     *
     * @param entity the &lt;code&gt;Entity&lt;/code&gt; triggering the B Pod.
     * @param podId  the &lt;code&gt;int&lt;/code&gt; ID of the B Pod.
     */
    private void triggerBPod(Entity entity, int podId, Entity target) {
        // Get the mount for this pod.
<span class="nc" id="L14619">        Mounted mount = entity.getEquipment(podId);</span>

        // Confirm that this is, indeed, an Anti-BA Pod.
<span class="nc bnc" id="L14622" title="All 2 branches missed.">        if (null == mount) {</span>
<span class="nc" id="L14623">            MegaMek.getLogger().error(&quot;Expecting to find an B Pod at &quot; + podId + &quot; on the unit, &quot;</span>
<span class="nc" id="L14624">                    + entity.getDisplayName() + &quot; but found NO equipment at all!!!&quot;);</span>
<span class="nc" id="L14625">            return;</span>
        }
<span class="nc" id="L14627">        EquipmentType equip = mount.getType();</span>
<span class="nc bnc" id="L14628" title="All 2 branches missed.">        if (!(equip instanceof WeaponType)</span>
<span class="nc bnc" id="L14629" title="All 2 branches missed.">            || !equip.hasFlag(WeaponType.F_B_POD)) {</span>
<span class="nc" id="L14630">            MegaMek.getLogger().error(&quot;Expecting to find an B Pod at &quot; + podId + &quot; on the unit, &quot;</span>
<span class="nc" id="L14631">                    + entity.getDisplayName() + &quot; but found &quot; + equip.getName() + &quot; instead!!!&quot;);</span>
<span class="nc" id="L14632">            return;</span>
        }

        // Now confirm that the entity can trigger the pod.
        // Ignore the &quot;used this round&quot; flag.
<span class="nc" id="L14637">        boolean oldFired = mount.isUsedThisRound();</span>
<span class="nc" id="L14638">        mount.setUsedThisRound(false);</span>
<span class="nc" id="L14639">        boolean canFire = mount.canFire();</span>
<span class="nc" id="L14640">        mount.setUsedThisRound(oldFired);</span>
<span class="nc bnc" id="L14641" title="All 2 branches missed.">        if (!canFire) {</span>
<span class="nc" id="L14642">            MegaMek.getLogger().error(&quot;Can not trigger the B Pod at &quot; + podId + &quot; on the unit, &quot;</span>
<span class="nc" id="L14643">                    + entity.getDisplayName() + &quot;!!!&quot;);</span>
<span class="nc" id="L14644">            return;</span>
        }

        Report r;

        // Mark the pod as fired and log the action.
<span class="nc" id="L14650">        mount.setFired(true);</span>
<span class="nc" id="L14651">        r = new Report(3011);</span>
<span class="nc" id="L14652">        r.newlines = 0;</span>
<span class="nc" id="L14653">        r.subject = entity.getId();</span>
<span class="nc" id="L14654">        r.addDesc(entity);</span>
<span class="nc" id="L14655">        addReport(r);</span>

        // Is this an unarmored infantry platoon?
<span class="nc bnc" id="L14658" title="All 4 branches missed.">        if ((target instanceof Infantry) &amp;&amp; !(target instanceof BattleArmor)) {</span>

            // Roll d6 for damage.
<span class="nc" id="L14661">            final int damage = Compute.d6();</span>

            // Damage the platoon.
<span class="nc" id="L14664">            addReport(damageEntity(target, new HitData(Infantry.LOC_INFANTRY),</span>
                                   damage));

            // Damage from AP Pods is applied immediately.
<span class="nc" id="L14668">            target.applyDamage();</span>

            // End target-is-unarmored
<span class="nc bnc" id="L14671" title="All 2 branches missed.">        } else if (target instanceof BattleArmor) {</span>
            // 20 damage in 5 point clusters
<span class="nc" id="L14673">            final int damage = 5;</span>

            // Damage the squad.
<span class="nc" id="L14676">            addReport(damageEntity(target, target.rollHitLocation(0, 0), damage));</span>
<span class="nc" id="L14677">            addReport(damageEntity(target, target.rollHitLocation(0, 0), damage));</span>
<span class="nc" id="L14678">            addReport(damageEntity(target, target.rollHitLocation(0, 0), damage));</span>
<span class="nc" id="L14679">            addReport(damageEntity(target, target.rollHitLocation(0, 0), damage));</span>

            // Damage from B Pods is applied immediately.
<span class="nc" id="L14682">            target.applyDamage();</span>
<span class="nc" id="L14683">        }</span>

        // Nope, the target is immune.
        // Don't make a log entry for the triggering entity.
<span class="nc bnc" id="L14687" title="All 2 branches missed.">        else if (!entity.equals(target)) {</span>
<span class="nc" id="L14688">            r = new Report(3020);</span>
<span class="nc" id="L14689">            r.indent(2);</span>
<span class="nc" id="L14690">            r.subject = target.getId();</span>
<span class="nc" id="L14691">            r.addDesc(target);</span>
<span class="nc" id="L14692">            addReport(r);</span>
        }
<span class="nc" id="L14694">    }</span>

    /**
     * Resolve an Unjam Action object
     */
    private void resolveUnjam(Entity entity) {
        Report r;
<span class="nc" id="L14701">        final int TN = entity.getCrew().getGunnery() + 3;</span>
<span class="nc bnc" id="L14702" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_UNJAM_UAC)) {</span>
<span class="nc" id="L14703">            r = new Report(3026);</span>
        } else {
<span class="nc" id="L14705">            r = new Report(3025);</span>
        }
<span class="nc" id="L14707">        r.subject = entity.getId();</span>
<span class="nc" id="L14708">        r.addDesc(entity);</span>
<span class="nc" id="L14709">        addReport(r);</span>
<span class="nc bnc" id="L14710" title="All 2 branches missed.">        for (Mounted mounted : entity.getTotalWeaponList()) {</span>
<span class="nc bnc" id="L14711" title="All 4 branches missed.">            if (mounted.isJammed() &amp;&amp; !mounted.isDestroyed()) {</span>
<span class="nc" id="L14712">                WeaponType wtype = (WeaponType) mounted.getType();</span>
<span class="nc bnc" id="L14713" title="All 2 branches missed.">                if (wtype.getAmmoType() == AmmoType.T_AC_ROTARY) {</span>
<span class="nc" id="L14714">                    int roll = Compute.d6(2);</span>
<span class="nc" id="L14715">                    r = new Report(3030);</span>
<span class="nc" id="L14716">                    r.indent();</span>
<span class="nc" id="L14717">                    r.subject = entity.getId();</span>
<span class="nc" id="L14718">                    r.add(wtype.getName());</span>
<span class="nc" id="L14719">                    r.add(TN);</span>
<span class="nc" id="L14720">                    r.add(roll);</span>
<span class="nc bnc" id="L14721" title="All 2 branches missed.">                    if (roll &gt;= TN) {</span>
<span class="nc" id="L14722">                        r.choose(true);</span>
<span class="nc" id="L14723">                        mounted.setJammed(false);</span>
                    } else {
<span class="nc" id="L14725">                        r.choose(false);</span>
                    }
<span class="nc" id="L14727">                    addReport(r);</span>
                }
                // Unofficial option to unjam UACs, ACs, and LACs like Rotary
                // Autocannons
<span class="nc bnc" id="L14731" title="All 2 branches missed.">                if (((wtype.getAmmoType() == AmmoType.T_AC_ULTRA)</span>
<span class="nc bnc" id="L14732" title="All 2 branches missed.">                        || (wtype.getAmmoType() == AmmoType.T_AC_ULTRA_THB)</span>
<span class="nc bnc" id="L14733" title="All 2 branches missed.">                        || (wtype.getAmmoType() == AmmoType.T_AC)</span>
<span class="nc bnc" id="L14734" title="All 2 branches missed.">                        || (wtype.getAmmoType() == AmmoType.T_AC_IMP)</span>
<span class="nc bnc" id="L14735" title="All 2 branches missed.">                        || (wtype.getAmmoType() == AmmoType.T_PAC)</span>
<span class="nc bnc" id="L14736" title="All 2 branches missed.">                        || (wtype.getAmmoType() == AmmoType.T_LAC))</span>
<span class="nc bnc" id="L14737" title="All 2 branches missed.">                        &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_UNJAM_UAC)) {</span>
<span class="nc" id="L14738">                    int roll = Compute.d6(2);</span>
<span class="nc" id="L14739">                    r = new Report(3030);</span>
<span class="nc" id="L14740">                    r.indent();</span>
<span class="nc" id="L14741">                    r.subject = entity.getId();</span>
<span class="nc" id="L14742">                    r.add(wtype.getName());</span>
<span class="nc" id="L14743">                    r.add(TN);</span>
<span class="nc" id="L14744">                    r.add(roll);</span>
<span class="nc bnc" id="L14745" title="All 2 branches missed.">                    if (roll &gt;= TN) {</span>
<span class="nc" id="L14746">                        r.choose(true);</span>
<span class="nc" id="L14747">                        mounted.setJammed(false);</span>
                    } else {
<span class="nc" id="L14749">                        r.choose(false);</span>
                    }
<span class="nc" id="L14751">                    addReport(r);</span>
                }
            }
<span class="nc" id="L14754">        }</span>
<span class="nc" id="L14755">    }</span>

    private void resolveFindClub(Entity entity) {
<span class="nc" id="L14758">        EquipmentType clubType = null;</span>

<span class="nc" id="L14760">        entity.setFindingClub(true);</span>

        // Get the entity's current hex.
<span class="nc" id="L14763">        Coords coords = entity.getPosition();</span>
<span class="nc" id="L14764">        IHex curHex = game.getBoard().getHex(coords);</span>

        Report r;

        // Is there a blown off arm in the hex?
<span class="nc bnc" id="L14769" title="All 2 branches missed.">        if (curHex.terrainLevel(Terrains.ARMS) &gt; 0) {</span>
<span class="nc" id="L14770">            clubType = EquipmentType.get(EquipmentTypeLookup.LIMB_CLUB);</span>
<span class="nc" id="L14771">            curHex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
<span class="nc" id="L14772">                    Terrains.ARMS, curHex.terrainLevel(Terrains.ARMS) - 1));</span>
<span class="nc" id="L14773">            sendChangedHex(entity.getPosition());</span>
<span class="nc" id="L14774">            r = new Report(3035);</span>
<span class="nc" id="L14775">            r.subject = entity.getId();</span>
<span class="nc" id="L14776">            r.addDesc(entity);</span>
<span class="nc" id="L14777">            addReport(r);</span>
        }
        // Is there a blown off leg in the hex?
<span class="nc bnc" id="L14780" title="All 2 branches missed.">        else if (curHex.terrainLevel(Terrains.LEGS) &gt; 0) {</span>
<span class="nc" id="L14781">            clubType = EquipmentType.get(EquipmentTypeLookup.LIMB_CLUB);</span>
<span class="nc" id="L14782">            curHex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
<span class="nc" id="L14783">                    Terrains.LEGS, curHex.terrainLevel(Terrains.LEGS) - 1));</span>
<span class="nc" id="L14784">            sendChangedHex(entity.getPosition());</span>
<span class="nc" id="L14785">            r = new Report(3040);</span>
<span class="nc" id="L14786">            r.subject = entity.getId();</span>
<span class="nc" id="L14787">            r.addDesc(entity);</span>
<span class="nc" id="L14788">            addReport(r);</span>
        }

        // Is there the rubble of a medium, heavy,
        // or hardened building in the hex?
<span class="nc bnc" id="L14793" title="All 2 branches missed.">        else if (Building.LIGHT &lt; curHex.terrainLevel(Terrains.RUBBLE)) {</span>

            // Finding a club is not guaranteed. The chances are
            // based on the type of building that produced the
            // rubble.
<span class="nc" id="L14798">            boolean found = false;</span>
<span class="nc" id="L14799">            int roll = Compute.d6(2);</span>
<span class="nc bnc" id="L14800" title="All 5 branches missed.">            switch (curHex.terrainLevel(Terrains.RUBBLE)) {</span>
                case Building.MEDIUM:
<span class="nc bnc" id="L14802" title="All 2 branches missed.">                    if (roll &gt;= 7) {</span>
<span class="nc" id="L14803">                        found = true;</span>
                    }
                    break;
                case Building.HEAVY:
<span class="nc bnc" id="L14807" title="All 2 branches missed.">                    if (roll &gt;= 6) {</span>
<span class="nc" id="L14808">                        found = true;</span>
                    }
                    break;
                case Building.HARDENED:
<span class="nc bnc" id="L14812" title="All 2 branches missed.">                    if (roll &gt;= 5) {</span>
<span class="nc" id="L14813">                        found = true;</span>
                    }
                    break;
                case Building.WALL:
<span class="nc bnc" id="L14817" title="All 2 branches missed.">                    if (roll &gt;= 13) {</span>
<span class="nc" id="L14818">                        found = true;</span>
                    }
                    break;
                default:
                    // we must be in ultra
<span class="nc bnc" id="L14823" title="All 2 branches missed.">                    if (roll &gt;= 4) {</span>
<span class="nc" id="L14824">                        found = true;</span>
                    }
            }

            // Let the player know if they found a club.
<span class="nc bnc" id="L14829" title="All 2 branches missed.">            if (found) {</span>
<span class="nc" id="L14830">                clubType = EquipmentType.get(EquipmentTypeLookup.GIRDER_CLUB);</span>
<span class="nc" id="L14831">                r = new Report(3045);</span>
<span class="nc" id="L14832">                r.subject = entity.getId();</span>
<span class="nc" id="L14833">                r.addDesc(entity);</span>
<span class="nc" id="L14834">                addReport(r);</span>
            } else {
                // Sorry, no club for you.
<span class="nc" id="L14837">                r = new Report(3050);</span>
<span class="nc" id="L14838">                r.subject = entity.getId();</span>
<span class="nc" id="L14839">                r.addDesc(entity);</span>
<span class="nc" id="L14840">                addReport(r);</span>
            }
<span class="nc" id="L14842">        }</span>

        // Are there woods in the hex?
<span class="nc bnc" id="L14845" title="All 2 branches missed.">        else if (curHex.containsTerrain(Terrains.WOODS)</span>
<span class="nc bnc" id="L14846" title="All 2 branches missed.">                 || curHex.containsTerrain(Terrains.JUNGLE)) {</span>
<span class="nc" id="L14847">            clubType = EquipmentType.get(EquipmentTypeLookup.TREE_CLUB);</span>
<span class="nc" id="L14848">            r = new Report(3055);</span>
<span class="nc" id="L14849">            r.subject = entity.getId();</span>
<span class="nc" id="L14850">            r.addDesc(entity);</span>
<span class="nc" id="L14851">            addReport(r);</span>
        }

        // add the club
        try {
<span class="nc bnc" id="L14856" title="All 2 branches missed.">            if (clubType != null) {</span>
<span class="nc" id="L14857">                entity.addEquipment(clubType, Entity.LOC_NONE);</span>
            }
<span class="nc" id="L14859">        } catch (LocationFullException ex) {</span>
            // unlikely...
<span class="nc" id="L14861">            r = new Report(3060);</span>
<span class="nc" id="L14862">            r.subject = entity.getId();</span>
<span class="nc" id="L14863">            r.addDesc(entity);</span>
<span class="nc" id="L14864">            addReport(r);</span>
<span class="nc" id="L14865">        }</span>
<span class="nc" id="L14866">    }</span>

    /**
     * Try to ignite the hex, taking into account existing fires and the
     * effects of Inferno rounds.
     *
     * @param c
     *            - the &lt;code&gt;Coords&lt;/code&gt; of the hex being lit.
     * @param entityId
     *            - the &lt;code&gt;int&lt;/code&gt; id of the entity involved.
     * @param bInferno
     *            - &lt;code&gt;true&lt;/code&gt; if the weapon igniting the hex is an
     *            Inferno round. If some other weapon or ammo is causing the
     *            roll, this should be &lt;code&gt;false&lt;/code&gt;.
     * @param bHotGun
     *            - &lt;code&gt;true&lt;/code&gt; if the weapon is plasma/flamer/incendiary
     *            LRM/etc
     * @param nTargetRoll
     *            - the &lt;code&gt;TargetRoll&lt;/code&gt; for the ignition roll.
     * @param bReportAttempt
     *            - &lt;code&gt;true&lt;/code&gt; if the attempt roll should be added to the
     *            report.
     * @param accidentTarget
     *            - &lt;code&gt;int&lt;/code&gt; the target number below which a roll has to
     *            be made in order to try igniting a hex accidentally. -1 for
     *            intentional
     */
    public boolean tryIgniteHex(Coords c, int entityId, boolean bHotGun,
            boolean bInferno, TargetRoll nTargetRoll, boolean bReportAttempt,
            int accidentTarget, Vector&lt;Report&gt; vPhaseReport) {

<span class="nc" id="L14897">        IHex hex = game.getBoard().getHex(c);</span>
        Report r;

        // Ignore bad coordinates.
<span class="nc bnc" id="L14901" title="All 2 branches missed.">        if (hex == null) {</span>
<span class="nc" id="L14902">            return false;</span>
        }

        // Ignore if fire is not enabled as a game option
<span class="nc bnc" id="L14906" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_START_FIRE)) {</span>
<span class="nc" id="L14907">            return false;</span>
        }

        // is the hex ignitable (how are infernos handled?)
<span class="nc bnc" id="L14911" title="All 2 branches missed.">        if (!hex.isIgnitable()) {</span>
<span class="nc" id="L14912">            return false;</span>
        }

        // first for accidental ignitions, make the necessary roll
<span class="nc bnc" id="L14916" title="All 2 branches missed.">        if (accidentTarget &gt; -1) {</span>
            // if this hex is in snow, then accidental ignitions are not
            // possible
<span class="nc bnc" id="L14919" title="All 2 branches missed.">            if (hex.containsTerrain(Terrains.SNOW)) {</span>
<span class="nc" id="L14920">                return false;</span>
            }
<span class="nc" id="L14922">            nTargetRoll.addModifier(2, &quot;accidental&quot;);</span>
<span class="nc" id="L14923">            int accidentRoll = Compute.d6(2);</span>
<span class="nc" id="L14924">            r = new Report(3066);</span>
<span class="nc" id="L14925">            r.subject = entityId;</span>
<span class="nc" id="L14926">            r.add(accidentTarget);</span>
<span class="nc" id="L14927">            r.add(accidentRoll);</span>
<span class="nc" id="L14928">            r.indent(2);</span>
<span class="nc bnc" id="L14929" title="All 2 branches missed.">            if (accidentRoll &gt; accidentTarget) {</span>
<span class="nc" id="L14930">                r.choose(false);</span>
<span class="nc" id="L14931">                vPhaseReport.add(r);</span>
<span class="nc" id="L14932">                return false;</span>
            }
<span class="nc" id="L14934">            r.choose(true);</span>
<span class="nc" id="L14935">            vPhaseReport.add(r);</span>
        }

<span class="nc" id="L14938">        int terrainMod = hex.getIgnitionModifier();</span>
<span class="nc bnc" id="L14939" title="All 2 branches missed.">        if (terrainMod != 0) {</span>
<span class="nc" id="L14940">            nTargetRoll.addModifier(terrainMod, &quot;terrain&quot;);</span>
        }

        // building modifiers
<span class="nc" id="L14944">        Building bldg = game.getBoard().getBuildingAt(c);</span>
<span class="nc bnc" id="L14945" title="All 2 branches missed.">        if (null != bldg) {</span>
<span class="nc" id="L14946">            nTargetRoll.addModifier(bldg.getType() - 3, &quot;building&quot;);</span>
        }

        // add in any modifiers for planetary conditions
<span class="nc" id="L14950">        int weatherMod = game.getPlanetaryConditions().getIgniteModifiers();</span>
<span class="nc bnc" id="L14951" title="All 2 branches missed.">        if (weatherMod != 0) {</span>
<span class="nc" id="L14952">            nTargetRoll.addModifier(weatherMod, &quot;conditions&quot;);</span>
        }

        // if there is snow on the ground and this a hotgun or inferno, it may
        // melt the snow instead
<span class="nc bnc" id="L14957" title="All 2 branches missed.">        if ((hex.containsTerrain(Terrains.SNOW) || hex</span>
<span class="nc bnc" id="L14958" title="All 6 branches missed.">                .containsTerrain(Terrains.ICE)) &amp;&amp; (bHotGun || bInferno)) {</span>
<span class="nc" id="L14959">            boolean melted = false;</span>
<span class="nc" id="L14960">            int meltCheck = Compute.d6(2);</span>
<span class="nc bnc" id="L14961" title="All 4 branches missed.">            if ((hex.terrainLevel(Terrains.SNOW) &gt; 1) &amp;&amp; (meltCheck == 12)) {</span>
<span class="nc" id="L14962">                melted = true;</span>
<span class="nc bnc" id="L14963" title="All 4 branches missed.">            } else if (hex.containsTerrain(Terrains.ICE) &amp;&amp; (meltCheck &gt; 9)) {</span>
<span class="nc" id="L14964">                melted = true;</span>
<span class="nc bnc" id="L14965" title="All 4 branches missed.">            } else if (hex.containsTerrain(Terrains.SNOW) &amp;&amp; (meltCheck &gt; 7)) {</span>
<span class="nc" id="L14966">                melted = true;</span>
            }
<span class="nc bnc" id="L14968" title="All 2 branches missed.">            if (bInferno) {</span>
<span class="nc" id="L14969">                melted = true;</span>
            }
<span class="nc bnc" id="L14971" title="All 2 branches missed.">            if (melted) {</span>
<span class="nc" id="L14972">                vPhaseReport.addAll(meltIceAndSnow(c, entityId));</span>
<span class="nc" id="L14973">                return false;</span>
            }

        }

        // inferno always ignites
        // ERRATA not if targeting clear hexes for ignition is disabled.
<span class="nc bnc" id="L14980" title="All 4 branches missed.">        if (bInferno &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVANCED_NO_IGNITE_CLEAR)) {</span>
<span class="nc" id="L14981">            nTargetRoll = new TargetRoll(0, &quot;inferno&quot;);</span>
        }

        // no lighting fires in tornadoes
<span class="nc bnc" id="L14985" title="All 2 branches missed.">        if (game.getPlanetaryConditions().getWindStrength() &gt; PlanetaryConditions.WI_STORM) {</span>
<span class="nc" id="L14986">            nTargetRoll = new TargetRoll(TargetRoll.AUTOMATIC_FAIL, &quot;tornado&quot;);</span>
        }

        // The hex may already be on fire.
<span class="nc bnc" id="L14990" title="All 2 branches missed.">        if (hex.containsTerrain(Terrains.FIRE)) {</span>
<span class="nc bnc" id="L14991" title="All 2 branches missed.">            if (bReportAttempt) {</span>
<span class="nc" id="L14992">                r = new Report(3065);</span>
<span class="nc" id="L14993">                r.indent(2);</span>
<span class="nc" id="L14994">                r.subject = entityId;</span>
<span class="nc" id="L14995">                vPhaseReport.add(r);</span>
            }
<span class="nc bnc" id="L14997" title="All 2 branches missed.">        } else if (checkIgnition(c, nTargetRoll, bInferno, entityId,</span>
                vPhaseReport)) {
<span class="nc" id="L14999">            return true;</span>
        }
<span class="nc" id="L15001">        return false;</span>
    }

    /**
     * Try to ignite the hex, taking into account existing fires and the
     * effects of Inferno rounds. This version of the method will not report the
     * attempt roll.
     *
     * @param c
     *            - the &lt;code&gt;Coords&lt;/code&gt; of the hex being lit.
     * @param entityId
     *            - the &lt;code&gt;int&lt;/code&gt; id of the entity involved.
     * @param bInferno
     *            - &lt;code&gt;true&lt;/code&gt; if the weapon igniting the hex is an
     *            Inferno round. If some other weapon or ammo is causing the
     *            roll, this should be &lt;code&gt;false&lt;/code&gt;.
     * @param nTargetRoll
     *            - the &lt;code&gt;int&lt;/code&gt; roll target for the attempt.
     */
    public boolean tryIgniteHex(Coords c, int entityId, boolean bHotGun, boolean bInferno,
                                TargetRoll nTargetRoll, int accidentTarget,
                                Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L15023">        return tryIgniteHex(c, entityId, bHotGun, bInferno, nTargetRoll, false,</span>
                accidentTarget, vPhaseReport);
    }

    public Vector&lt;Report&gt; tryClearHex(Coords c, int nDamage, int entityId) {
<span class="nc" id="L15028">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L15029">        IHex h = game.getBoard().getHex(c);</span>
<span class="nc bnc" id="L15030" title="All 2 branches missed.">        if (h == null) {</span>
<span class="nc" id="L15031">            return vPhaseReport;</span>
        }
<span class="nc" id="L15033">        ITerrain woods = h.getTerrain(Terrains.WOODS);</span>
<span class="nc" id="L15034">        ITerrain jungle = h.getTerrain(Terrains.JUNGLE);</span>
<span class="nc" id="L15035">        ITerrain ice = h.getTerrain(Terrains.ICE);</span>
<span class="nc" id="L15036">        ITerrain magma = h.getTerrain(Terrains.MAGMA);</span>
        Report r;
<span class="nc" id="L15038">        int reportType = Report.HIDDEN;</span>
<span class="nc bnc" id="L15039" title="All 2 branches missed.">        if (entityId == Entity.NONE) {</span>
<span class="nc" id="L15040">            reportType = Report.PUBLIC;</span>
        }
<span class="nc bnc" id="L15042" title="All 2 branches missed.">        if (woods != null) {</span>
<span class="nc" id="L15043">            int tf = woods.getTerrainFactor() - nDamage;</span>
<span class="nc" id="L15044">            int level = woods.getLevel();</span>
<span class="nc" id="L15045">            int folEl = h.terrainLevel(Terrains.FOLIAGE_ELEV);</span>
<span class="nc bnc" id="L15046" title="All 2 branches missed.">            if (tf &lt;= 0) {</span>
<span class="nc" id="L15047">                h.removeTerrain(Terrains.WOODS);</span>
<span class="nc" id="L15048">                h.removeTerrain(Terrains.FOLIAGE_ELEV);</span>
<span class="nc" id="L15049">                h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                        Terrains.ROUGH, 1));
                // light converted to rough
<span class="nc" id="L15052">                r = new Report(3090, reportType);</span>
<span class="nc" id="L15053">                r.subject = entityId;</span>
<span class="nc" id="L15054">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L15055" title="All 4 branches missed.">            } else if ((tf &lt;= 50) &amp;&amp; (level &gt; 1)) {</span>
<span class="nc" id="L15056">                h.removeTerrain(Terrains.WOODS);</span>
<span class="nc" id="L15057">                h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                        Terrains.WOODS, 1));
<span class="nc bnc" id="L15059" title="All 2 branches missed.">                if (folEl != 1) {</span>
<span class="nc" id="L15060">                    h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                            Terrains.FOLIAGE_ELEV, 2));
                }
<span class="nc" id="L15063">                woods = h.getTerrain(Terrains.WOODS);</span>
                // heavy converted to light
<span class="nc" id="L15065">                r = new Report(3085, reportType);</span>
<span class="nc" id="L15066">                r.subject = entityId;</span>
<span class="nc" id="L15067">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L15068" title="All 4 branches missed.">            } else if ((tf &lt;= 90) &amp;&amp; (level &gt; 2)) {</span>
<span class="nc" id="L15069">                h.removeTerrain(Terrains.WOODS);</span>
<span class="nc" id="L15070">                h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                        Terrains.WOODS, 2));
<span class="nc bnc" id="L15072" title="All 2 branches missed.">                if (folEl != 1) {</span>
<span class="nc" id="L15073">                    h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                            Terrains.FOLIAGE_ELEV, 2));
                }
<span class="nc" id="L15076">                woods = h.getTerrain(Terrains.WOODS);</span>
                // ultra heavy converted to heavy
<span class="nc" id="L15078">                r = new Report(3082, reportType);</span>
<span class="nc" id="L15079">                r.subject = entityId;</span>
<span class="nc" id="L15080">                vPhaseReport.add(r);</span>
            }
<span class="nc" id="L15082">            woods.setTerrainFactor(tf);</span>
        }
<span class="nc bnc" id="L15084" title="All 2 branches missed.">        if (jungle != null) {</span>
<span class="nc" id="L15085">            int tf = jungle.getTerrainFactor() - nDamage;</span>
<span class="nc" id="L15086">            int level = jungle.getLevel();</span>
<span class="nc" id="L15087">            int folEl = h.terrainLevel(Terrains.FOLIAGE_ELEV);</span>
<span class="nc bnc" id="L15088" title="All 2 branches missed.">            if (tf &lt; 0) {</span>
<span class="nc" id="L15089">                h.removeTerrain(Terrains.JUNGLE);</span>
<span class="nc" id="L15090">                h.removeTerrain(Terrains.FOLIAGE_ELEV);</span>
<span class="nc" id="L15091">                h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                        Terrains.ROUGH, 1));
                // light converted to rough
<span class="nc" id="L15094">                r = new Report(3091, reportType);</span>
<span class="nc" id="L15095">                r.subject = entityId;</span>
<span class="nc" id="L15096">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L15097" title="All 4 branches missed.">            } else if ((tf &lt;= 50) &amp;&amp; (level &gt; 1)) {</span>
<span class="nc" id="L15098">                h.removeTerrain(Terrains.JUNGLE);</span>
<span class="nc" id="L15099">                h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                        Terrains.JUNGLE, 1));
<span class="nc bnc" id="L15101" title="All 2 branches missed.">                if (folEl != 1) {</span>
<span class="nc" id="L15102">                    h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                            Terrains.FOLIAGE_ELEV, 2));
                }
<span class="nc" id="L15105">                jungle = h.getTerrain(Terrains.JUNGLE);</span>
                // heavy converted to light
<span class="nc" id="L15107">                r = new Report(3086, reportType);</span>
<span class="nc" id="L15108">                r.subject = entityId;</span>
<span class="nc" id="L15109">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L15110" title="All 4 branches missed.">            } else if ((tf &lt;= 90) &amp;&amp; (level &gt; 2)) {</span>
<span class="nc" id="L15111">                h.removeTerrain(Terrains.JUNGLE);</span>
<span class="nc" id="L15112">                h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                        Terrains.JUNGLE, 2));
<span class="nc bnc" id="L15114" title="All 2 branches missed.">                if (folEl != 1) {</span>
<span class="nc" id="L15115">                    h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                            Terrains.FOLIAGE_ELEV, 2));
                }
<span class="nc" id="L15118">                jungle = h.getTerrain(Terrains.JUNGLE);</span>
                // ultra heavy converted to heavy
<span class="nc" id="L15120">                r = new Report(3083, reportType);</span>
<span class="nc" id="L15121">                r.subject = entityId;</span>
<span class="nc" id="L15122">                vPhaseReport.add(r);</span>
            }
<span class="nc" id="L15124">            jungle.setTerrainFactor(tf);</span>
        }
<span class="nc bnc" id="L15126" title="All 2 branches missed.">        if (ice != null) {</span>
<span class="nc" id="L15127">            int tf = ice.getTerrainFactor() - nDamage;</span>
<span class="nc bnc" id="L15128" title="All 2 branches missed.">            if (tf &lt;= 0) {</span>
                // ice melted
<span class="nc" id="L15130">                r = new Report(3092, reportType);</span>
<span class="nc" id="L15131">                r.subject = entityId;</span>
<span class="nc" id="L15132">                vPhaseReport.add(r);</span>
<span class="nc" id="L15133">                vPhaseReport.addAll(resolveIceBroken(c));</span>
            } else {
<span class="nc" id="L15135">                ice.setTerrainFactor(tf);</span>
            }
        }
<span class="nc bnc" id="L15138" title="All 4 branches missed.">        if ((magma != null) &amp;&amp; (magma.getLevel() == 1)) {</span>
<span class="nc" id="L15139">            int tf = magma.getTerrainFactor() - nDamage;</span>
<span class="nc bnc" id="L15140" title="All 2 branches missed.">            if (tf &lt;= 0) {</span>
                // magma crust destroyed
<span class="nc" id="L15142">                r = new Report(3093, reportType);</span>
<span class="nc" id="L15143">                r.subject = entityId;</span>
<span class="nc" id="L15144">                vPhaseReport.add(r);</span>
<span class="nc" id="L15145">                h.removeTerrain(Terrains.MAGMA);</span>
<span class="nc" id="L15146">                h.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                        Terrains.MAGMA, 2));
<span class="nc bnc" id="L15148" title="All 2 branches missed.">                for (Entity en : game.getEntitiesVector(c)) {</span>
<span class="nc" id="L15149">                    doMagmaDamage(en, false);</span>
<span class="nc" id="L15150">                }</span>
            } else {
<span class="nc" id="L15152">                magma.setTerrainFactor(tf);</span>
            }
        }
<span class="nc" id="L15155">        sendChangedHex(c);</span>

        // any attempt to clear an heavy industrial hex may cause an exposion
<span class="nc" id="L15158">        checkExplodeIndustrialZone(c, vPhaseReport);</span>

<span class="nc" id="L15160">        return vPhaseReport;</span>
    }

    /**
     * Handle all physical attacks for the round
     */
    private void resolvePhysicalAttacks() {
        // Physical phase header
<span class="nc" id="L15168">        addReport(new Report(4000, Report.PUBLIC));</span>

        // add any pending charges
<span class="nc" id="L15171">        for (Enumeration&lt;AttackAction&gt; i = game.getCharges(); i</span>
<span class="nc bnc" id="L15172" title="All 2 branches missed.">                .hasMoreElements(); ) {</span>
<span class="nc" id="L15173">            game.addAction(i.nextElement());</span>
        }
<span class="nc" id="L15175">        game.resetCharges();</span>

        // add any pending rams
<span class="nc bnc" id="L15178" title="All 2 branches missed.">        for (Enumeration&lt;AttackAction&gt; i = game.getRams(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L15179">            game.addAction(i.nextElement());</span>
        }
<span class="nc" id="L15181">        game.resetRams();</span>

        // add any pending Tele Missile Attacks
<span class="nc" id="L15184">        for (Enumeration&lt;AttackAction&gt; i = game.getTeleMissileAttacks(); i</span>
<span class="nc bnc" id="L15185" title="All 2 branches missed.">                .hasMoreElements(); ) {</span>
<span class="nc" id="L15186">            game.addAction(i.nextElement());</span>
        }
<span class="nc" id="L15188">        game.resetTeleMissileAttacks();</span>

        // remove any duplicate attack declarations
<span class="nc" id="L15191">        cleanupPhysicalAttacks();</span>

        // loop thru received attack actions
<span class="nc" id="L15194">        for (Enumeration&lt;EntityAction&gt; i = game.getActions(); i</span>
<span class="nc bnc" id="L15195" title="All 2 branches missed.">                .hasMoreElements(); ) {</span>
<span class="nc" id="L15196">            Object o = i.nextElement();</span>
            // verify that the attacker is still active
<span class="nc" id="L15198">            AttackAction aa = (AttackAction) o;</span>
<span class="nc bnc" id="L15199" title="All 4 branches missed.">            if (!game.getEntity(aa.getEntityId()).isActive()</span>
                &amp;&amp; !(o instanceof DfaAttackAction)) {
<span class="nc" id="L15201">                continue;</span>
            }
<span class="nc" id="L15203">            AbstractAttackAction aaa = (AbstractAttackAction) o;</span>
            // do searchlights immediately
<span class="nc bnc" id="L15205" title="All 2 branches missed.">            if (aaa instanceof SearchlightAttackAction) {</span>
<span class="nc" id="L15206">                SearchlightAttackAction saa = (SearchlightAttackAction) aaa;</span>
<span class="nc" id="L15207">                addReport(saa.resolveAction(game));</span>
<span class="nc" id="L15208">            } else {</span>
<span class="nc" id="L15209">                physicalResults.addElement(preTreatPhysicalAttack(aaa));</span>
            }
<span class="nc" id="L15211">        }</span>
<span class="nc" id="L15212">        int cen = Entity.NONE;</span>
<span class="nc bnc" id="L15213" title="All 2 branches missed.">        for (PhysicalResult pr : physicalResults) {</span>
<span class="nc" id="L15214">            resolvePhysicalAttack(pr, cen);</span>
<span class="nc" id="L15215">            cen = pr.aaa.getEntityId();</span>
<span class="nc" id="L15216">        }</span>
<span class="nc" id="L15217">        physicalResults.removeAllElements();</span>
<span class="nc" id="L15218">    }</span>

    /**
     * Cleans up the attack declarations for the physical phase by removing all
     * attacks past the first for any one mech. Also clears out attacks by dead
     * or disabled mechs.
     */
    private void cleanupPhysicalAttacks() {
<span class="nc bnc" id="L15226" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L15227">            Entity entity = i.next();</span>
<span class="nc" id="L15228">            removeDuplicateAttacks(entity.getId());</span>
<span class="nc" id="L15229">        }</span>
<span class="nc" id="L15230">        removeDeadAttacks();</span>
<span class="nc" id="L15231">    }</span>

    /**
     * Removes any actions in the attack queue beyond the first by the specified
     * entity, unless that entity has melee master in which case it allows two
     * attacks.
     */
    private void removeDuplicateAttacks(int entityId) {
<span class="nc" id="L15239">        int allowed = 1;</span>
<span class="nc" id="L15240">        Entity en = game.getEntity(entityId);</span>
<span class="nc bnc" id="L15241" title="All 2 branches missed.">        if (null != en) {</span>
<span class="nc" id="L15242">            allowed = en.getAllowedPhysicalAttacks();</span>
        }
<span class="nc" id="L15244">        Vector&lt;EntityAction&gt; toKeep = new Vector&lt;&gt;();</span>

<span class="nc bnc" id="L15246" title="All 2 branches missed.">        for (Enumeration&lt;EntityAction&gt; i = game.getActions(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L15247">            EntityAction action = i.nextElement();</span>
<span class="nc bnc" id="L15248" title="All 2 branches missed.">            if (action.getEntityId() != entityId) {</span>
<span class="nc" id="L15249">                toKeep.addElement(action);</span>
<span class="nc bnc" id="L15250" title="All 2 branches missed.">            } else if (allowed &gt; 0) {</span>
<span class="nc" id="L15251">                toKeep.addElement(action);</span>
<span class="nc bnc" id="L15252" title="All 2 branches missed.">                if (!(action instanceof SearchlightAttackAction)) {</span>
<span class="nc" id="L15253">                    allowed--;</span>
                }
            } else {
<span class="nc" id="L15256">                MegaMek.getLogger().error(&quot;Removing duplicate phys attack for id#&quot; + entityId</span>
<span class="nc" id="L15257">                                + &quot;\n\t\taction was &quot; + action.toString());</span>
            }
<span class="nc" id="L15259">        }</span>

        // reset actions and re-add valid elements
<span class="nc" id="L15262">        game.resetActions();</span>
<span class="nc bnc" id="L15263" title="All 2 branches missed.">        for (EntityAction entityAction : toKeep) {</span>
<span class="nc" id="L15264">            game.addAction(entityAction);</span>
<span class="nc" id="L15265">        }</span>
<span class="nc" id="L15266">    }</span>

    /**
     * Removes all attacks by any dead entities. It does this by going through
     * all the attacks and only keeping ones from active entities. DFAs are kept
     * even if the pilot is unconscious, so that he can fail.
     */
    private void removeDeadAttacks() {
<span class="nc" id="L15274">        Vector&lt;EntityAction&gt; toKeep = new Vector&lt;&gt;(game.actionsSize());</span>

<span class="nc bnc" id="L15276" title="All 2 branches missed.">        for (Enumeration&lt;EntityAction&gt; i = game.getActions(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L15277">            EntityAction action = i.nextElement();</span>
<span class="nc" id="L15278">            Entity entity = game.getEntity(action.getEntityId());</span>
<span class="nc bnc" id="L15279" title="All 4 branches missed.">            if ((entity != null) &amp;&amp; !entity.isDestroyed()</span>
<span class="nc bnc" id="L15280" title="All 4 branches missed.">                    &amp;&amp; (entity.isActive() || (action instanceof DfaAttackAction))) {</span>
<span class="nc" id="L15281">                toKeep.addElement(action);</span>
            }
<span class="nc" id="L15283">        }</span>

        // reset actions and re-add valid elements
<span class="nc" id="L15286">        game.resetActions();</span>
<span class="nc bnc" id="L15287" title="All 2 branches missed.">        for (EntityAction entityAction : toKeep) {</span>
<span class="nc" id="L15288">            game.addAction(entityAction);</span>
<span class="nc" id="L15289">        }</span>
<span class="nc" id="L15290">    }</span>

    /**
     * Apply damage to mech for zweihandering (melee attack with both hands) as per
     * pg. 82, CamOps
     * 
     * @param ae           - the attacking entity
     * @param missed       - did the attack missed. If so PSR is necessary.
     * @param criticalLocs - the locations for possible criticals, should be one or
     *                     both arms depending on if it was an unarmed attack (both
     *                     arms) or a weapon attack (the arm with the weapon).
     */
    private void applyZweihanderSelfDamage(Entity ae, boolean missed, List&lt;Integer&gt; criticalLocs) {
<span class="nc" id="L15303">        Report r = new Report(4022);</span>
<span class="nc" id="L15304">        r.subject = ae.getId();</span>
<span class="nc" id="L15305">        r.indent();</span>
<span class="nc" id="L15306">        r.addDesc(ae);</span>
<span class="nc" id="L15307">        addReport(r);</span>
<span class="nc bnc" id="L15308" title="All 2 branches missed.">        for (Integer loc : criticalLocs) {</span>
<span class="nc" id="L15309">            addReport(criticalEntity(ae, loc, false, 0, 1));</span>
<span class="nc" id="L15310">        }</span>
<span class="nc bnc" id="L15311" title="All 2 branches missed.">        if(missed) {</span>
<span class="nc" id="L15312">            game.addPSR(new PilotingRollData(ae.getId(), 0, &quot;Zweihander miss&quot;));</span>
        }
<span class="nc" id="L15314">    }</span>

    /**
     * Handle a punch attack
     */
    private void resolvePunchAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L15320">        final PunchAttackAction paa = (PunchAttackAction) pr.aaa;</span>
<span class="nc" id="L15321">        final Entity ae = game.getEntity(paa.getEntityId());</span>
<span class="nc" id="L15322">        final Targetable target = game.getTarget(paa.getTargetType(), paa.getTargetId());</span>
<span class="nc" id="L15323">        Entity te = null;</span>
<span class="nc bnc" id="L15324" title="All 2 branches missed.">        if (target.getTargetType() == Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L15325">            te = (Entity) target;</span>
        }
<span class="nc" id="L15327">        boolean throughFront = true;</span>
<span class="nc bnc" id="L15328" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L15329">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }
<span class="nc bnc" id="L15331" title="All 2 branches missed.">        final String armName = paa.getArm() == PunchAttackAction.LEFT ? &quot;Left Arm&quot; : &quot;Right Arm&quot;;</span>

<span class="nc bnc" id="L15333" title="All 2 branches missed.">        final int armLoc = paa.getArm() == PunchAttackAction.LEFT ? Mech.LOC_LARM : Mech.LOC_RARM;</span>

        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc bnc" id="L15336" title="All 2 branches missed.">        int damage = paa.getArm() == PunchAttackAction.LEFT ? pr.damage : pr.damageRight;</span>
        // LAMs in airmech mode do half damage if airborne.
<span class="nc bnc" id="L15338" title="All 2 branches missed.">        if (ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L15339">            damage = (int)Math.ceil(damage * 0.5);</span>
        }
<span class="nc bnc" id="L15341" title="All 2 branches missed.">        final ToHitData toHit = paa.getArm() == PunchAttackAction.LEFT ? pr.toHit : pr.toHitRight;</span>
<span class="nc bnc" id="L15342" title="All 2 branches missed.">        int roll = paa.getArm() == PunchAttackAction.LEFT ? pr.roll : pr.rollRight;</span>
<span class="nc" id="L15343">        final boolean targetInBuilding = Compute.isInBuilding(game, te);</span>
<span class="nc bnc" id="L15344" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L15345" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS) &amp;&amp; (roll == toHit.getValue());</span>

        Report r;

        // Set Margin of Success/Failure.
<span class="nc" id="L15350">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L15351" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L15352" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW) &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        // Which building takes the damage?
<span class="nc" id="L15355">        Building bldg = game.getBoard().getBuildingAt(target.getPosition());</span>

<span class="nc bnc" id="L15357" title="All 2 branches missed.">        if (lastEntityId != paa.getEntityId()) {</span>
            // report who is making the attacks
<span class="nc" id="L15359">            r = new Report(4005);</span>
<span class="nc" id="L15360">            r.subject = ae.getId();</span>
<span class="nc" id="L15361">            r.addDesc(ae);</span>
<span class="nc" id="L15362">            addReport(r);</span>
        }

<span class="nc" id="L15365">        r = new Report(4010);</span>
<span class="nc" id="L15366">        r.subject = ae.getId();</span>
<span class="nc" id="L15367">        r.indent();</span>
<span class="nc" id="L15368">        r.add(armName);</span>
<span class="nc" id="L15369">        r.add(target.getDisplayName());</span>
<span class="nc" id="L15370">        r.newlines = 0;</span>
<span class="nc" id="L15371">        addReport(r);</span>

<span class="nc bnc" id="L15373" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L15374">            r = new Report(4015);</span>
<span class="nc" id="L15375">            r.subject = ae.getId();</span>
<span class="nc" id="L15376">            r.add(toHit.getDesc());</span>
<span class="nc" id="L15377">            addReport(r);</span>
<span class="nc bnc" id="L15378" title="All 4 branches missed.">            if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L15379">                game.addControlRoll(new PilotingRollData(ae.getId(), 0, &quot;missed punch attack&quot;));</span>
            }
<span class="nc" id="L15381">            return;</span>
<span class="nc bnc" id="L15382" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L15383">            r = new Report(4020);</span>
<span class="nc" id="L15384">            r.subject = ae.getId();</span>
<span class="nc" id="L15385">            r.add(toHit.getDesc());</span>
<span class="nc" id="L15386">            r.newlines = 0;</span>
<span class="nc" id="L15387">            addReport(r);</span>
<span class="nc" id="L15388">            roll = Integer.MAX_VALUE;</span>
        } else {
<span class="nc" id="L15390">            r = new Report(4025);</span>
<span class="nc" id="L15391">            r.subject = ae.getId();</span>
<span class="nc" id="L15392">            r.add(toHit.getValue());</span>
<span class="nc" id="L15393">            r.add(roll);</span>
<span class="nc" id="L15394">            r.newlines = 0;</span>
<span class="nc" id="L15395">            addReport(r);</span>
<span class="nc bnc" id="L15396" title="All 2 branches missed.">            if (glancing) {</span>
<span class="nc" id="L15397">                r = new Report(3186);</span>
<span class="nc" id="L15398">                r.subject = ae.getId();</span>
<span class="nc" id="L15399">                r.newlines = 0;</span>
<span class="nc" id="L15400">                addReport(r);</span>
            }
<span class="nc bnc" id="L15402" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L15403">                r = new Report(3189);</span>
<span class="nc" id="L15404">                r.subject = ae.getId();</span>
<span class="nc" id="L15405">                r.newlines = 0;</span>
<span class="nc" id="L15406">                addReport(r);</span>
            }
        }

        // do we hit?
<span class="nc bnc" id="L15411" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // nope
<span class="nc" id="L15413">            r = new Report(4035);</span>
<span class="nc" id="L15414">            r.subject = ae.getId();</span>
<span class="nc" id="L15415">            addReport(r);</span>

<span class="nc bnc" id="L15417" title="All 4 branches missed.">            if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L15418">                game.addControlRoll(new PilotingRollData(ae.getId(), 0, &quot;missed punch attack&quot;));</span>
            }
            // If the target is in a building, the building absorbs the damage.
<span class="nc bnc" id="L15421" title="All 4 branches missed.">            if (targetInBuilding &amp;&amp; (bldg != null)) {</span>

                // Only report if damage was done to the building.
<span class="nc bnc" id="L15424" title="All 2 branches missed.">                if (damage &gt; 0) {</span>
<span class="nc" id="L15425">                    Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L15426" title="All 2 branches missed.">                    for (Report report : buildingReport) {</span>
<span class="nc" id="L15427">                        report.subject = ae.getId();</span>
<span class="nc" id="L15428">                    }</span>
<span class="nc" id="L15429">                    addReport(buildingReport);</span>
                }

            }

<span class="nc bnc" id="L15434" title="All 2 branches missed.">            if(paa.isZweihandering()) {</span>
<span class="nc" id="L15435">                ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L15436">                criticalLocs.add(Mech.LOC_RARM);</span>
<span class="nc" id="L15437">                criticalLocs.add(Mech.LOC_LARM);</span>
<span class="nc" id="L15438">                applyZweihanderSelfDamage(ae, true, criticalLocs);</span>
            }

<span class="nc" id="L15441">            return;</span>
        }

        // Targeting a building.
<span class="nc bnc" id="L15445" title="All 2 branches missed.">        if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L15446" title="All 2 branches missed.">            || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) {</span>
            // The building takes the full brunt of the attack.
<span class="nc" id="L15448">            r = new Report(4040);</span>
<span class="nc" id="L15449">            r.subject = ae.getId();</span>
<span class="nc" id="L15450">            addReport(r);</span>
<span class="nc" id="L15451">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L15452" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L15453">                report.subject = ae.getId();</span>
<span class="nc" id="L15454">            }</span>
<span class="nc" id="L15455">            addReport(buildingReport);</span>

            // Damage any infantry in the hex.
<span class="nc" id="L15458">            addReport(damageInfantryIn(bldg, damage, target.getPosition()));</span>

<span class="nc bnc" id="L15460" title="All 2 branches missed.">            if(paa.isZweihandering()) {</span>
<span class="nc" id="L15461">                ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L15462">                criticalLocs.add(Mech.LOC_RARM);</span>
<span class="nc" id="L15463">                criticalLocs.add(Mech.LOC_LARM);</span>
<span class="nc" id="L15464">                applyZweihanderSelfDamage(ae, false, criticalLocs);</span>
            }

            // And we're done!
<span class="nc" id="L15468">            return;</span>
        }

<span class="nc" id="L15471">        HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L15472">        hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L15473">        r = new Report(4045);</span>
<span class="nc" id="L15474">        r.subject = ae.getId();</span>
<span class="nc" id="L15475">        r.add(toHit.getTableDesc());</span>
<span class="nc" id="L15476">        r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L15477">        addReport(r);</span>

        // The building shields all units from a certain amount of damage.
        // The amount is based upon the building's CF at the phase's start.
<span class="nc bnc" id="L15481" title="All 4 branches missed.">        if (targetInBuilding &amp;&amp; (bldg != null)) {</span>
<span class="nc" id="L15482">            int bldgAbsorbs = bldg.getAbsorbtion(target.getPosition());</span>
<span class="nc" id="L15483">            int toBldg = Math.min(bldgAbsorbs, damage);</span>
<span class="nc" id="L15484">            damage -= toBldg;</span>
<span class="nc" id="L15485">            addNewLines();</span>
<span class="nc" id="L15486">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, toBldg, target.getPosition());</span>
<span class="nc bnc" id="L15487" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L15488">                report.subject = ae.getId();</span>
<span class="nc" id="L15489">            }</span>
<span class="nc" id="L15490">            addReport(buildingReport);</span>

            // some buildings scale remaining damage that is not absorbed
            // TODO : this isn't quite right for castles brian
<span class="nc" id="L15494">            damage = (int) Math.floor(bldg.getDamageToScale() * damage);</span>
        }

        // A building may absorb the entire shot.
<span class="nc bnc" id="L15498" title="All 2 branches missed.">        if (damage == 0) {</span>
<span class="nc" id="L15499">            r = new Report(4050);</span>
<span class="nc" id="L15500">            r.subject = ae.getId();</span>
<span class="nc" id="L15501">            r.add(te.getShortName());</span>
<span class="nc" id="L15502">            r.add(te.getOwner().getName());</span>
<span class="nc" id="L15503">            r.indent();</span>
<span class="nc" id="L15504">            addReport(r);</span>
        } else {
<span class="nc bnc" id="L15506" title="All 2 branches missed.">            if (glancing) {</span>
                // Round up glancing blows against conventional infantry
<span class="nc bnc" id="L15508" title="All 4 branches missed.">                if ((te instanceof Infantry) &amp;&amp; !(te instanceof BattleArmor)) {</span>
<span class="nc" id="L15509">                    damage = (int) Math.ceil(damage / 2.0);</span>
                } else {
<span class="nc" id="L15511">                    damage = (int) Math.floor(damage / 2.0);</span>
                }
            }
<span class="nc bnc" id="L15514" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L15515">                damage += toHit.getMoS() / 3;</span>
<span class="nc" id="L15516">                hit.makeDirectBlow(toHit.getMoS() / 3);</span>
            }

<span class="nc" id="L15519">            damage = checkForSpikes(te, hit.getLocation(), damage, ae,</span>
<span class="nc bnc" id="L15520" title="All 2 branches missed.">                    (paa.getArm() == PunchAttackAction.LEFT) ?  Mech.LOC_LARM : Mech.LOC_RARM);</span>
<span class="nc" id="L15521">            DamageType damageType = DamageType.NONE;</span>
<span class="nc" id="L15522">            addReport(damageEntity(te, hit, damage, false, damageType, false,</span>
                                   false, throughFront));
<span class="nc bnc" id="L15524" title="All 2 branches missed.">            if (target instanceof VTOL) {</span>
                // destroy rotor
<span class="nc" id="L15526">                addReport(applyCriticalHit(te, VTOL.LOC_ROTOR,</span>
                        new CriticalSlot(CriticalSlot.TYPE_SYSTEM, VTOL.CRIT_ROTOR_DESTROYED),
                        false, 0, false));
            }
            // check for extending retractable blades
<span class="nc bnc" id="L15531" title="All 2 branches missed.">            if (paa.isBladeExtended(paa.getArm())) {</span>
<span class="nc" id="L15532">                addNewLines();</span>
<span class="nc" id="L15533">                r = new Report(4455);</span>
<span class="nc" id="L15534">                r.indent(2);</span>
<span class="nc" id="L15535">                r.subject = ae.getId();</span>
<span class="nc" id="L15536">                r.newlines = 0;</span>
<span class="nc" id="L15537">                addReport(r);</span>
                // conventional infantry don't take crits and battle armor need
                // to be handled differently
<span class="nc bnc" id="L15540" title="All 2 branches missed.">                if (!(target instanceof Infantry)) {</span>
<span class="nc" id="L15541">                    addNewLines();</span>
<span class="nc" id="L15542">                    addReport(criticalEntity(te, hit.getLocation(), hit.isRear(), 0,</span>
                            true, false, damage));
                }
<span class="nc bnc" id="L15545" title="All 4 branches missed.">                if ((target instanceof BattleArmor) &amp;&amp; (hit.getLocation() &lt; te.locations())</span>
<span class="nc bnc" id="L15546" title="All 2 branches missed.">                        &amp;&amp; (te.getInternal(hit.getLocation()) &gt; 0)) {</span>
                    // TODO : we should really apply BA criticals through the critical
                    // TODO : hits methods. Right now they are applied in damageEntity
<span class="nc" id="L15549">                    HitData baHit = new HitData(hit.getLocation(), false,</span>
                            HitData.EFFECT_CRITICAL);
<span class="nc" id="L15551">                    addReport(damageEntity(te, baHit, 0));</span>
                }
                // extend the blade
                // since retracting/extending is a freebie in the movement
                // phase, lets assume that the
                // blade retracts to its original mode
                // ae.extendBlade(paa.getArm());
                // check for breaking a nail
<span class="nc bnc" id="L15559" title="All 2 branches missed.">                if (Compute.d6(2) &gt; 9) {</span>
<span class="nc" id="L15560">                    addNewLines();</span>
<span class="nc" id="L15561">                    r = new Report(4456);</span>
<span class="nc" id="L15562">                    r.indent(2);</span>
<span class="nc" id="L15563">                    r.subject = ae.getId();</span>
<span class="nc" id="L15564">                    r.newlines = 0;</span>
<span class="nc" id="L15565">                    addReport(r);</span>
<span class="nc" id="L15566">                    ae.destroyRetractableBlade(armLoc);</span>
                }
            }
        }
<span class="nc" id="L15570">        addNewLines();</span>

<span class="nc bnc" id="L15572" title="All 2 branches missed.">        if(paa.isZweihandering()) {</span>
<span class="nc" id="L15573">            ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L15574">            criticalLocs.add(Mech.LOC_RARM);</span>
<span class="nc" id="L15575">            criticalLocs.add(Mech.LOC_LARM);</span>
<span class="nc" id="L15576">            applyZweihanderSelfDamage(ae, false, criticalLocs);</span>
        }
<span class="nc" id="L15578">        addNewLines();</span>


        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L15583" title="All 4 branches missed.">        if ((target instanceof Mech) &amp;&amp; ((Mech) target).isIndustrial()) {</span>
<span class="nc" id="L15584">            ((Mech) target).setCheckForCrit(true);</span>
        }
<span class="nc" id="L15586">    }</span>

    /**
     * Handle a kick attack
     */
    private void resolveKickAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L15592">        KickAttackAction kaa = (KickAttackAction) pr.aaa;</span>
<span class="nc" id="L15593">        final Entity ae = game.getEntity(kaa.getEntityId());</span>
<span class="nc" id="L15594">        final Targetable target = game.getTarget(kaa.getTargetType(), kaa.getTargetId());</span>
<span class="nc" id="L15595">        Entity te = null;</span>
<span class="nc bnc" id="L15596" title="All 2 branches missed.">        if (target.getTargetType() == Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L15597">            te = (Entity) target;</span>
        }
<span class="nc" id="L15599">        boolean throughFront = true;</span>
<span class="nc bnc" id="L15600" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L15601">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }
<span class="nc bnc" id="L15603" title="All 2 branches missed.">        String legName = (kaa.getLeg() == KickAttackAction.LEFT)</span>
<span class="nc bnc" id="L15604" title="All 2 branches missed.">                || (kaa.getLeg() == KickAttackAction.LEFTMULE) ? &quot;Left &quot; : &quot;Right &quot;;</span>
<span class="nc bnc" id="L15605" title="All 2 branches missed.">        if ((kaa.getLeg() == KickAttackAction.LEFTMULE)</span>
<span class="nc bnc" id="L15606" title="All 2 branches missed.">                || (kaa.getLeg() == KickAttackAction.RIGHTMULE)) {</span>
<span class="nc" id="L15607">            legName = legName.concat(&quot;rear &quot;);</span>
<span class="nc bnc" id="L15608" title="All 2 branches missed.">        } else if (ae instanceof QuadMech) {</span>
<span class="nc" id="L15609">            legName = legName.concat(&quot;front &quot;);</span>
        }
<span class="nc" id="L15611">        legName = legName.concat(&quot;leg&quot;);</span>
        Report r;

        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L15615">        int damage = pr.damage;</span>
        // LAMs in airmech mode do half damage if airborne.
<span class="nc bnc" id="L15617" title="All 2 branches missed.">        if (ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L15618">            damage = (int)Math.ceil(damage * 0.5);</span>
        }
<span class="nc" id="L15620">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L15621">        int roll = pr.roll;</span>
<span class="nc" id="L15622">        final boolean targetInBuilding = Compute.isInBuilding(game, te);</span>
<span class="nc bnc" id="L15623" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L15624" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS) &amp;&amp; (roll == toHit.getValue());</span>

        // Set Margin of Success/Failure.
<span class="nc" id="L15627">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L15628" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L15629" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW) &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        // Which building takes the damage?
<span class="nc" id="L15632">        Building bldg = game.getBoard().getBuildingAt(target.getPosition());</span>

<span class="nc bnc" id="L15634" title="All 2 branches missed.">        if (lastEntityId != ae.getId()) {</span>
            // who is making the attacks
<span class="nc" id="L15636">            r = new Report(4005);</span>
<span class="nc" id="L15637">            r.subject = ae.getId();</span>
<span class="nc" id="L15638">            r.addDesc(ae);</span>
<span class="nc" id="L15639">            addReport(r);</span>
        }

<span class="nc" id="L15642">        r = new Report(4055);</span>
<span class="nc" id="L15643">        r.subject = ae.getId();</span>
<span class="nc" id="L15644">        r.indent();</span>
<span class="nc" id="L15645">        r.add(legName);</span>
<span class="nc" id="L15646">        r.add(target.getDisplayName());</span>
<span class="nc" id="L15647">        r.newlines = 0;</span>
<span class="nc" id="L15648">        addReport(r);</span>

<span class="nc bnc" id="L15650" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L15651">            r = new Report(4060);</span>
<span class="nc" id="L15652">            r.subject = ae.getId();</span>
<span class="nc" id="L15653">            r.add(toHit.getDesc());</span>
<span class="nc" id="L15654">            addReport(r);</span>
<span class="nc bnc" id="L15655" title="All 4 branches missed.">            if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L15656">                game.addControlRoll(new PilotingRollData(ae.getId(), 0, &quot;missed a kick&quot;));</span>
            } else {
<span class="nc" id="L15658">                game.addPSR(new PilotingRollData(ae.getId(), 0, &quot;missed a kick&quot;));</span>
            }
<span class="nc" id="L15660">            return;</span>
<span class="nc bnc" id="L15661" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L15662">            r = new Report(4065);</span>
<span class="nc" id="L15663">            r.subject = ae.getId();</span>
<span class="nc" id="L15664">            r.add(toHit.getDesc());</span>
<span class="nc" id="L15665">            r.newlines = 0;</span>
<span class="nc" id="L15666">            addReport(r);</span>
<span class="nc" id="L15667">            roll = Integer.MAX_VALUE;</span>
        } else {
<span class="nc" id="L15669">            r = new Report(4025);</span>
<span class="nc" id="L15670">            r.subject = ae.getId();</span>
<span class="nc" id="L15671">            r.add(toHit.getValue());</span>
<span class="nc" id="L15672">            r.add(roll);</span>
<span class="nc" id="L15673">            r.newlines = 0;</span>
<span class="nc" id="L15674">            addReport(r);</span>
<span class="nc bnc" id="L15675" title="All 2 branches missed.">            if (glancing) {</span>
<span class="nc" id="L15676">                r = new Report(3186);</span>
<span class="nc" id="L15677">                r.subject = ae.getId();</span>
<span class="nc" id="L15678">                r.newlines = 0;</span>
<span class="nc" id="L15679">                addReport(r);</span>
            }
<span class="nc bnc" id="L15681" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L15682">                r = new Report(3189);</span>
<span class="nc" id="L15683">                r.subject = ae.getId();</span>
<span class="nc" id="L15684">                r.newlines = 0;</span>
<span class="nc" id="L15685">                addReport(r);</span>
            }

        }

        // do we hit?
<span class="nc bnc" id="L15691" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L15693">            r = new Report(4035);</span>
<span class="nc" id="L15694">            r.subject = ae.getId();</span>
<span class="nc" id="L15695">            addReport(r);</span>
<span class="nc bnc" id="L15696" title="All 4 branches missed.">            if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L15697">                game.addControlRoll(new PilotingRollData(ae.getId(), 0, &quot;missed a kick&quot;));</span>
            } else {
<span class="nc" id="L15699">                game.addPSR(new PilotingRollData(ae.getId(), 0, &quot;missed a kick&quot;));</span>
            }

            // If the target is in a building, the building absorbs the damage.
<span class="nc bnc" id="L15703" title="All 4 branches missed.">            if (targetInBuilding &amp;&amp; (bldg != null)) {</span>

                // Only report if damage was done to the building.
<span class="nc bnc" id="L15706" title="All 2 branches missed.">                if (damage &gt; 0) {</span>
<span class="nc" id="L15707">                    Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L15708" title="All 2 branches missed.">                    for (Report report : buildingReport) {</span>
<span class="nc" id="L15709">                        report.subject = ae.getId();</span>
<span class="nc" id="L15710">                    }</span>
<span class="nc" id="L15711">                    addReport(buildingReport);</span>
                }

            }
<span class="nc" id="L15715">            return;</span>
        }

        // Targeting a building.
<span class="nc bnc" id="L15719" title="All 2 branches missed.">        if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L15720" title="All 2 branches missed.">            || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) {</span>
            // The building takes the full brunt of the attack.
<span class="nc" id="L15722">            r = new Report(4040);</span>
<span class="nc" id="L15723">            r.subject = ae.getId();</span>
<span class="nc" id="L15724">            addReport(r);</span>
<span class="nc" id="L15725">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L15726" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L15727">                report.subject = ae.getId();</span>
<span class="nc" id="L15728">            }</span>
<span class="nc" id="L15729">            addReport(buildingReport);</span>

            // Damage any infantry in the hex.
<span class="nc" id="L15732">            addReport(damageInfantryIn(bldg, damage, target.getPosition()));</span>

            // And we're done!
<span class="nc" id="L15735">            return;</span>
        }

<span class="nc" id="L15738">        HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L15739">        hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L15740">        r = new Report(4045);</span>
<span class="nc" id="L15741">        r.subject = ae.getId();</span>
<span class="nc" id="L15742">        r.add(toHit.getTableDesc());</span>
<span class="nc" id="L15743">        r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L15744">        addReport(r);</span>

        // The building shields all units from a certain amount of damage.
        // The amount is based upon the building's CF at the phase's start.
<span class="nc bnc" id="L15748" title="All 4 branches missed.">        if (targetInBuilding &amp;&amp; (bldg != null)) {</span>
<span class="nc" id="L15749">            int bldgAbsorbs = bldg.getAbsorbtion(target.getPosition());</span>
<span class="nc" id="L15750">            int toBldg = Math.min(bldgAbsorbs, damage);</span>
<span class="nc" id="L15751">            damage -= toBldg;</span>
<span class="nc" id="L15752">            addNewLines();</span>
<span class="nc" id="L15753">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L15754" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L15755">                report.subject = ae.getId();</span>
<span class="nc" id="L15756">            }</span>
<span class="nc" id="L15757">            addReport(buildingReport);</span>

            // some buildings scale remaining damage that is not absorbed
            // TODO : this isn't quite right for castles brian
<span class="nc" id="L15761">            damage = (int) Math.floor(bldg.getDamageToScale() * damage);</span>
        }

        // A building may absorb the entire shot.
<span class="nc bnc" id="L15765" title="All 2 branches missed.">        if (damage == 0) {</span>
<span class="nc" id="L15766">            r = new Report(4050);</span>
<span class="nc" id="L15767">            r.subject = ae.getId();</span>
<span class="nc" id="L15768">            r.add(te.getShortName());</span>
<span class="nc" id="L15769">            r.add(te.getOwner().getName());</span>
<span class="nc" id="L15770">            r.newlines = 0;</span>
<span class="nc" id="L15771">            addReport(r);</span>
        } else {
<span class="nc bnc" id="L15773" title="All 2 branches missed.">            if (glancing) {</span>
                // Round up glancing blows against conventional infantry
<span class="nc bnc" id="L15775" title="All 4 branches missed.">                if ((te instanceof Infantry) &amp;&amp; !(te instanceof BattleArmor)) {</span>
<span class="nc" id="L15776">                    damage = (int) Math.ceil(damage / 2.0);</span>
                } else {
<span class="nc" id="L15778">                    damage = (int) Math.floor(damage / 2.0);</span>
                }
            }
<span class="nc bnc" id="L15781" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L15782">                damage += toHit.getMoS() / 3;</span>
<span class="nc" id="L15783">                hit.makeDirectBlow(toHit.getMoS() / 3);</span>
            }

            int leg;
<span class="nc bnc" id="L15787" title="All 4 branches missed.">            switch (kaa.getLeg()) {</span>
                case KickAttackAction.LEFT:
<span class="nc bnc" id="L15789" title="All 2 branches missed.">                    if (ae instanceof QuadMech) {</span>
<span class="nc" id="L15790">                        leg = Mech.LOC_LARM;</span>
                    } else {
<span class="nc" id="L15792">                        leg = Mech.LOC_LLEG;</span>
                    }
<span class="nc" id="L15794">                    break;</span>
                case KickAttackAction.RIGHT:
<span class="nc bnc" id="L15796" title="All 2 branches missed.">                    if (ae instanceof QuadMech) {</span>
<span class="nc" id="L15797">                        leg = Mech.LOC_RARM;</span>
                    } else {
<span class="nc" id="L15799">                        leg = Mech.LOC_RLEG;</span>
                    }
<span class="nc" id="L15801">                    break;</span>
                case KickAttackAction.LEFTMULE:
<span class="nc" id="L15803">                    leg = Mech.LOC_LLEG;</span>
<span class="nc" id="L15804">                    break;</span>
                case KickAttackAction.RIGHTMULE:
                default:
<span class="nc" id="L15807">                    leg = Mech.LOC_RLEG;</span>
                    break;
            }
<span class="nc" id="L15810">            damage = checkForSpikes(te, hit.getLocation(), damage, ae, leg);</span>
<span class="nc" id="L15811">            DamageType damageType = DamageType.NONE;</span>
<span class="nc" id="L15812">            addReport(damageEntity(te, hit, damage, false, damageType, false,</span>
                    false, throughFront));
<span class="nc bnc" id="L15814" title="All 2 branches missed.">            if (target instanceof VTOL) {</span>
                // destroy rotor
<span class="nc" id="L15816">                addReport(applyCriticalHit(te, VTOL.LOC_ROTOR,</span>
                        new CriticalSlot(CriticalSlot.TYPE_SYSTEM,
                                VTOL.CRIT_ROTOR_DESTROYED), false, 0, false));
            }
<span class="nc bnc" id="L15820" title="All 2 branches missed.">            if (te.hasQuirk(OptionsConstants.QUIRK_NEG_WEAK_LEGS)) {</span>
<span class="nc" id="L15821">                addNewLines();</span>
<span class="nc" id="L15822">                addReport(criticalEntity(te, hit.getLocation(), hit.isRear(), 0, 0));</span>
            }
        }

<span class="nc bnc" id="L15826" title="All 2 branches missed.">        if (te.canFall()) {</span>
<span class="nc" id="L15827">            PilotingRollData kickPRD = getKickPushPSR(te, ae, te, &quot;was kicked&quot;);</span>
<span class="nc" id="L15828">            game.addPSR(kickPRD);</span>
        }

        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L15833" title="All 4 branches missed.">        if ((te instanceof Mech) &amp;&amp; ((Mech) te).isIndustrial()) {</span>
<span class="nc" id="L15834">            ((Mech) te).setCheckForCrit(true);</span>
        }

<span class="nc" id="L15837">        addNewLines();</span>
<span class="nc" id="L15838">    }</span>

    /**
     * Handle a kick attack
     */
    private void resolveJumpJetAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L15844">        JumpJetAttackAction kaa = (JumpJetAttackAction) pr.aaa;</span>
<span class="nc" id="L15845">        final Entity ae = game.getEntity(kaa.getEntityId());</span>
<span class="nc" id="L15846">        final Targetable target = game.getTarget(kaa.getTargetType(), kaa.getTargetId());</span>
<span class="nc" id="L15847">        Entity te = null;</span>
<span class="nc bnc" id="L15848" title="All 2 branches missed.">        if (target.getTargetType() == Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L15849">            te = (Entity) target;</span>
        }
<span class="nc" id="L15851">        boolean throughFront = true;</span>
<span class="nc bnc" id="L15852" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L15853">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }
        String legName;
<span class="nc bnc" id="L15856" title="All 3 branches missed.">        switch (kaa.getLeg()) {</span>
            case JumpJetAttackAction.LEFT:
<span class="nc" id="L15858">                legName = &quot;Left leg&quot;;</span>
<span class="nc" id="L15859">                break;</span>
            case JumpJetAttackAction.RIGHT:
<span class="nc" id="L15861">                legName = &quot;Right leg&quot;;</span>
<span class="nc" id="L15862">                break;</span>
            default:
<span class="nc" id="L15864">                legName = &quot;Both legs&quot;;</span>
                break;
        }

        Report r;

        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L15871">        int damage = pr.damage;</span>
<span class="nc" id="L15872">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L15873">        int roll = pr.roll;</span>
<span class="nc" id="L15874">        final boolean targetInBuilding = Compute.isInBuilding(game, te);</span>
<span class="nc bnc" id="L15875" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L15876" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS) &amp;&amp; (roll == toHit.getValue());</span>

        // Set Margin of Success/Failure.
<span class="nc" id="L15879">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L15880" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L15881" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW) &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        // Which building takes the damage?
<span class="nc" id="L15884">        Building bldg = game.getBoard().getBuildingAt(target.getPosition());</span>

<span class="nc bnc" id="L15886" title="All 2 branches missed.">        if (lastEntityId != ae.getId()) {</span>
            // who is making the attacks
<span class="nc" id="L15888">            r = new Report(4005);</span>
<span class="nc" id="L15889">            r.subject = ae.getId();</span>
<span class="nc" id="L15890">            r.addDesc(ae);</span>
<span class="nc" id="L15891">            addReport(r);</span>
        }

<span class="nc" id="L15894">        r = new Report(4290);</span>
<span class="nc" id="L15895">        r.subject = ae.getId();</span>
<span class="nc" id="L15896">        r.indent();</span>
<span class="nc" id="L15897">        r.add(legName);</span>
<span class="nc" id="L15898">        r.add(target.getDisplayName());</span>
<span class="nc" id="L15899">        r.newlines = 0;</span>
<span class="nc" id="L15900">        addReport(r);</span>

<span class="nc bnc" id="L15902" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L15903">            r = new Report(4075);</span>
<span class="nc" id="L15904">            r.subject = ae.getId();</span>
<span class="nc" id="L15905">            r.add(toHit.getDesc());</span>
<span class="nc" id="L15906">            addReport(r);</span>
<span class="nc" id="L15907">            return;</span>
<span class="nc bnc" id="L15908" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L15909">            r = new Report(4080);</span>
<span class="nc" id="L15910">            r.subject = ae.getId();</span>
<span class="nc" id="L15911">            r.add(toHit.getDesc());</span>
<span class="nc" id="L15912">            r.newlines = 0;</span>
<span class="nc" id="L15913">            addReport(r);</span>
<span class="nc" id="L15914">            roll = Integer.MAX_VALUE;</span>
        } else {
<span class="nc" id="L15916">            r = new Report(4025);</span>
<span class="nc" id="L15917">            r.subject = ae.getId();</span>
<span class="nc" id="L15918">            r.add(toHit.getValue());</span>
<span class="nc" id="L15919">            r.add(roll);</span>
<span class="nc" id="L15920">            r.newlines = 0;</span>
<span class="nc" id="L15921">            addReport(r);</span>
<span class="nc bnc" id="L15922" title="All 2 branches missed.">            if (glancing) {</span>
<span class="nc" id="L15923">                r = new Report(3186);</span>
<span class="nc" id="L15924">                r.subject = ae.getId();</span>
<span class="nc" id="L15925">                r.newlines = 0;</span>
<span class="nc" id="L15926">                addReport(r);</span>
            }
<span class="nc bnc" id="L15928" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L15929">                r = new Report(3189);</span>
<span class="nc" id="L15930">                r.subject = ae.getId();</span>
<span class="nc" id="L15931">                r.newlines = 0;</span>
<span class="nc" id="L15932">                addReport(r);</span>
            }

        }

        // do we hit?
<span class="nc bnc" id="L15938" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L15940">            r = new Report(4035);</span>
<span class="nc" id="L15941">            r.subject = ae.getId();</span>
<span class="nc" id="L15942">            addReport(r);</span>

            // If the target is in a building, the building absorbs the damage.
<span class="nc bnc" id="L15945" title="All 4 branches missed.">            if (targetInBuilding &amp;&amp; (bldg != null)) {</span>

<span class="nc" id="L15947">                damage += pr.damageRight;</span>
                // Only report if damage was done to the building.
<span class="nc bnc" id="L15949" title="All 2 branches missed.">                if (damage &gt; 0) {</span>
<span class="nc" id="L15950">                    Vector&lt;Report&gt; buildingReport = damageBuilding(bldg,</span>
<span class="nc" id="L15951">                                                                   damage, target.getPosition());</span>
<span class="nc bnc" id="L15952" title="All 2 branches missed.">                    for (Report report : buildingReport) {</span>
<span class="nc" id="L15953">                        report.subject = ae.getId();</span>
<span class="nc" id="L15954">                    }</span>
<span class="nc" id="L15955">                    addReport(buildingReport);</span>
                }

            }
<span class="nc" id="L15959">            return;</span>
        }

        // Targeting a building.
<span class="nc bnc" id="L15963" title="All 2 branches missed.">        if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L15964" title="All 2 branches missed.">            || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) {</span>
<span class="nc" id="L15965">            damage += pr.damageRight;</span>
            // The building takes the full brunt of the attack.
<span class="nc" id="L15967">            r = new Report(4040);</span>
<span class="nc" id="L15968">            r.subject = ae.getId();</span>
<span class="nc" id="L15969">            addReport(r);</span>
<span class="nc" id="L15970">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage,</span>
<span class="nc" id="L15971">                                                           target.getPosition());</span>
<span class="nc bnc" id="L15972" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L15973">                report.subject = ae.getId();</span>
<span class="nc" id="L15974">            }</span>
<span class="nc" id="L15975">            addReport(buildingReport);</span>

            // Damage any infantry in the hex.
<span class="nc" id="L15978">            addReport(damageInfantryIn(bldg, damage, target.getPosition()));</span>

            // And we're done!
<span class="nc" id="L15981">            return;</span>
        }

<span class="nc" id="L15984">        r = new Report(4040);</span>
<span class="nc" id="L15985">        r.subject = ae.getId();</span>
<span class="nc" id="L15986">        r.newlines = 0;</span>
<span class="nc" id="L15987">        addReport(r);</span>

<span class="nc bnc" id="L15989" title="All 2 branches missed.">        for (int leg = 0; leg &lt; 2; leg++) {</span>
<span class="nc bnc" id="L15990" title="All 2 branches missed.">            if (leg == 1) {</span>
<span class="nc" id="L15991">                damage = pr.damageRight;</span>
<span class="nc bnc" id="L15992" title="All 2 branches missed.">                if (damage == 0) {</span>
<span class="nc" id="L15993">                    break;</span>
                }
            }
<span class="nc" id="L15996">            HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L15997">            hit.setGeneralDamageType(HitData.DAMAGE_ENERGY);</span>

            // The building shields all units from a certain amount of damage.
            // The amount is based upon the building's CF at the phase's start.
<span class="nc bnc" id="L16001" title="All 4 branches missed.">            if (targetInBuilding &amp;&amp; (bldg != null)) {</span>
<span class="nc" id="L16002">                int bldgAbsorbs = bldg.getAbsorbtion(target.getPosition());</span>
<span class="nc" id="L16003">                int toBldg = Math.min(bldgAbsorbs, damage);</span>
<span class="nc" id="L16004">                damage -= toBldg;</span>
<span class="nc" id="L16005">                addNewLines();</span>
<span class="nc" id="L16006">                Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage,</span>
<span class="nc" id="L16007">                                                               target.getPosition());</span>
<span class="nc bnc" id="L16008" title="All 2 branches missed.">                for (Report report : buildingReport) {</span>
<span class="nc" id="L16009">                    report.subject = ae.getId();</span>
<span class="nc" id="L16010">                }</span>
<span class="nc" id="L16011">                addReport(buildingReport);</span>

                // some buildings scale remaining damage that is not absorbed
                // TODO : this isn't quite right for castles brian
<span class="nc" id="L16015">                damage = (int) Math.floor(bldg.getDamageToScale() * damage);</span>
            }

            // A building may absorb the entire shot.
<span class="nc bnc" id="L16019" title="All 2 branches missed.">            if (damage == 0) {</span>
<span class="nc" id="L16020">                r = new Report(4050);</span>
<span class="nc" id="L16021">                r.subject = ae.getId();</span>
<span class="nc" id="L16022">                r.add(te.getShortName());</span>
<span class="nc" id="L16023">                r.add(te.getOwner().getName());</span>
<span class="nc" id="L16024">                r.newlines = 0;</span>
<span class="nc" id="L16025">                addReport(r);</span>
            } else {
<span class="nc bnc" id="L16027" title="All 2 branches missed.">                if (glancing) {</span>
                    // Round up glancing blows against conventional infantry
<span class="nc bnc" id="L16029" title="All 4 branches missed.">                    if ((te instanceof Infantry)</span>
                        &amp;&amp; !(te instanceof BattleArmor)) {
<span class="nc" id="L16031">                        damage = (int) Math.ceil(damage / 2.0);</span>
                    } else {
<span class="nc" id="L16033">                        damage = (int) Math.floor(damage / 2.0);</span>
                    }
                }
<span class="nc bnc" id="L16036" title="All 2 branches missed.">                if (directBlow) {</span>
<span class="nc" id="L16037">                    damage += toHit.getMoS() / 3;</span>
<span class="nc" id="L16038">                    hit.makeDirectBlow(toHit.getMoS() / 3);</span>
                }
<span class="nc" id="L16040">                addReport(damageEntity(te, hit, damage, false, DamageType.NONE,</span>
                                       false, false, throughFront));
            }
        }

<span class="nc" id="L16045">        addNewLines();</span>

        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L16049" title="All 4 branches missed.">        if ((target instanceof Mech) &amp;&amp; ((Mech) target).isIndustrial()) {</span>
<span class="nc" id="L16050">            ((Mech) target).setCheckForCrit(true);</span>
        }
<span class="nc" id="L16052">    }</span>

    /**
     * Handle a ProtoMech physical attack
     */

    private void resolveProtoAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L16059">        final ProtomechPhysicalAttackAction ppaa = (ProtomechPhysicalAttackAction) pr.aaa;</span>
<span class="nc" id="L16060">        final Entity ae = game.getEntity(ppaa.getEntityId());</span>
        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L16062">        int damage = pr.damage;</span>
<span class="nc" id="L16063">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L16064">        int roll = pr.roll;</span>
<span class="nc" id="L16065">        final Targetable target = game.getTarget(ppaa.getTargetType(), ppaa.getTargetId());</span>
<span class="nc" id="L16066">        Entity te = null;</span>
<span class="nc bnc" id="L16067" title="All 2 branches missed.">        if (target.getTargetType() == Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L16068">            te = (Entity) target;</span>
        }
<span class="nc" id="L16070">        boolean throughFront = true;</span>
<span class="nc bnc" id="L16071" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L16072">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }
<span class="nc" id="L16074">        final boolean targetInBuilding = Compute.isInBuilding(game, te);</span>
<span class="nc bnc" id="L16075" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L16076" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS) &amp;&amp; (roll == toHit.getValue());</span>
        // Set Margin of Success/Failure.
<span class="nc" id="L16078">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L16079" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L16080" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW) &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        Report r;

        // Which building takes the damage?
<span class="nc" id="L16085">        Building bldg = game.getBoard().getBuildingAt(target.getPosition());</span>

<span class="nc bnc" id="L16087" title="All 2 branches missed.">        if (lastEntityId != ae.getId()) {</span>
            // who is making the attacks
<span class="nc" id="L16089">            r = new Report(4005);</span>
<span class="nc" id="L16090">            r.subject = ae.getId();</span>
<span class="nc" id="L16091">            r.addDesc(ae);</span>
<span class="nc" id="L16092">            addReport(r);</span>
        }

<span class="nc" id="L16095">        r = new Report(4070);</span>
<span class="nc" id="L16096">        r.subject = ae.getId();</span>
<span class="nc" id="L16097">        r.indent();</span>
<span class="nc" id="L16098">        r.add(target.getDisplayName());</span>
<span class="nc" id="L16099">        r.newlines = 0;</span>
<span class="nc" id="L16100">        addReport(r);</span>

<span class="nc bnc" id="L16102" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L16103">            r = new Report(4075);</span>
<span class="nc" id="L16104">            r.subject = ae.getId();</span>
<span class="nc" id="L16105">            r.add(toHit.getDesc());</span>
<span class="nc" id="L16106">            addReport(r);</span>
<span class="nc" id="L16107">            return;</span>
<span class="nc bnc" id="L16108" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L16109">            r = new Report(4080);</span>
<span class="nc" id="L16110">            r.subject = ae.getId();</span>
<span class="nc" id="L16111">            r.add(toHit.getDesc());</span>
<span class="nc" id="L16112">            r.newlines = 0;</span>
<span class="nc" id="L16113">            addReport(r);</span>
<span class="nc" id="L16114">            roll = Integer.MAX_VALUE;</span>
        } else {
            // report the roll
<span class="nc" id="L16117">            r = new Report(4025);</span>
<span class="nc" id="L16118">            r.subject = ae.getId();</span>
<span class="nc" id="L16119">            r.add(toHit.getValue());</span>
<span class="nc" id="L16120">            r.add(roll);</span>
<span class="nc" id="L16121">            r.newlines = 0;</span>
<span class="nc" id="L16122">            addReport(r);</span>
<span class="nc bnc" id="L16123" title="All 2 branches missed.">            if (glancing) {</span>
<span class="nc" id="L16124">                r = new Report(3186);</span>
<span class="nc" id="L16125">                r.subject = ae.getId();</span>
<span class="nc" id="L16126">                r.newlines = 0;</span>
<span class="nc" id="L16127">                addReport(r);</span>
            }
<span class="nc bnc" id="L16129" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L16130">                r = new Report(3189);</span>
<span class="nc" id="L16131">                r.subject = ae.getId();</span>
<span class="nc" id="L16132">                r.newlines = 0;</span>
<span class="nc" id="L16133">                addReport(r);</span>
            }

        }

        // do we hit?
<span class="nc bnc" id="L16139" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L16141">            r = new Report(4035);</span>
<span class="nc" id="L16142">            r.subject = ae.getId();</span>
<span class="nc" id="L16143">            addReport(r);</span>

            // If the target is in a building, the building absorbs the damage.
<span class="nc bnc" id="L16146" title="All 4 branches missed.">            if (targetInBuilding &amp;&amp; (bldg != null)) {</span>

                // Only report if damage was done to the building.
<span class="nc bnc" id="L16149" title="All 2 branches missed.">                if (damage &gt; 0) {</span>
<span class="nc" id="L16150">                    Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L16151" title="All 2 branches missed.">                    for (Report report : buildingReport) {</span>
<span class="nc" id="L16152">                        report.subject = ae.getId();</span>
<span class="nc" id="L16153">                    }</span>
<span class="nc" id="L16154">                    addReport(buildingReport);</span>
                }

            }
<span class="nc" id="L16158">            return;</span>
        }

        // Targeting a building.
<span class="nc bnc" id="L16162" title="All 2 branches missed.">        if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L16163" title="All 2 branches missed.">                || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) {</span>
            // The building takes the full brunt of the attack.
<span class="nc" id="L16165">            r = new Report(4040);</span>
<span class="nc" id="L16166">            r.subject = ae.getId();</span>
<span class="nc" id="L16167">            addReport(r);</span>
<span class="nc" id="L16168">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L16169" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L16170">                report.subject = ae.getId();</span>
<span class="nc" id="L16171">            }</span>
<span class="nc" id="L16172">            addReport(buildingReport);</span>

            // Damage any infantry in the hex.
<span class="nc" id="L16175">            addReport(damageInfantryIn(bldg, damage, target.getPosition()));</span>

            // And we're done!
<span class="nc" id="L16178">            return;</span>
        }

<span class="nc" id="L16181">        HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L16182">        hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>

<span class="nc" id="L16184">        r = new Report(4045);</span>
<span class="nc" id="L16185">        r.subject = ae.getId();</span>
<span class="nc" id="L16186">        r.add(toHit.getTableDesc());</span>
<span class="nc" id="L16187">        r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L16188">        addReport(r);</span>

        // The building shields all units from a certain amount of damage.
        // The amount is based upon the building's CF at the phase's start.
<span class="nc bnc" id="L16192" title="All 4 branches missed.">        if (targetInBuilding &amp;&amp; (bldg != null)) {</span>
<span class="nc" id="L16193">            int bldgAbsorbs = bldg.getAbsorbtion(target.getPosition());</span>
<span class="nc" id="L16194">            int toBldg = Math.min(bldgAbsorbs, damage);</span>
<span class="nc" id="L16195">            damage -= toBldg;</span>
<span class="nc" id="L16196">            addNewLines();</span>
<span class="nc" id="L16197">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage,</span>
<span class="nc" id="L16198">                                                           target.getPosition());</span>
<span class="nc bnc" id="L16199" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L16200">                report.subject = ae.getId();</span>
<span class="nc" id="L16201">            }</span>
<span class="nc" id="L16202">            addReport(buildingReport);</span>

            // some buildings scale remaining damage that is not absorbed
            // TODO : this isn't quite right for castles brian
<span class="nc" id="L16206">            damage = (int) Math.floor(bldg.getDamageToScale() * damage);</span>
        }

        // A building may absorb the entire shot.
<span class="nc bnc" id="L16210" title="All 2 branches missed.">        if (damage == 0) {</span>
<span class="nc" id="L16211">            r = new Report(4050);</span>
<span class="nc" id="L16212">            r.subject = ae.getId();</span>
<span class="nc" id="L16213">            r.add(te.getShortName());</span>
<span class="nc" id="L16214">            r.add(te.getOwner().getName());</span>
<span class="nc" id="L16215">            r.newlines = 0;</span>
<span class="nc" id="L16216">            addReport(r);</span>
        } else {
<span class="nc bnc" id="L16218" title="All 2 branches missed.">            if (glancing) {</span>
                // Round up glancing blows against conventional infantry
<span class="nc bnc" id="L16220" title="All 4 branches missed.">                if ((te instanceof Infantry) &amp;&amp; !(te instanceof BattleArmor)) {</span>
<span class="nc" id="L16221">                    damage = (int) Math.ceil(damage / 2.0);</span>
                } else {
<span class="nc" id="L16223">                    damage = (int) Math.floor(damage / 2.0);</span>
                }
            }
<span class="nc bnc" id="L16226" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L16227">                damage += toHit.getMoS() / 3;</span>
<span class="nc" id="L16228">                hit.makeDirectBlow(toHit.getMoS() / 3);</span>
            }
<span class="nc" id="L16230">            addReport(damageEntity(te, hit, damage, false, DamageType.NONE,</span>
                                   false, false, throughFront));
<span class="nc bnc" id="L16232" title="All 2 branches missed.">            if (((Protomech) ae).isEDPCharged()) {</span>
<span class="nc" id="L16233">                r = new Report(3701);</span>
<span class="nc" id="L16234">                int taserRoll = Compute.d6(2) - 2;</span>
<span class="nc" id="L16235">                r.add(taserRoll);</span>
<span class="nc" id="L16236">                r.newlines = 0;</span>
<span class="nc" id="L16237">                vPhaseReport.add(r);</span>

<span class="nc bnc" id="L16239" title="All 2 branches missed.">                if (te instanceof BattleArmor) {</span>
<span class="nc" id="L16240">                    r = new Report(3706);</span>
<span class="nc" id="L16241">                    r.addDesc(te);</span>
                    // shut down for rest of scenario, so we actually kill it
                    // TODO : fix for salvage purposes
<span class="nc" id="L16244">                    HitData targetTrooper = te.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L16245">                    r.add(te.getLocationAbbr(targetTrooper));</span>
<span class="nc" id="L16246">                    vPhaseReport.add(r);</span>
<span class="nc" id="L16247">                    vPhaseReport.addAll(criticalEntity(ae, targetTrooper.getLocation(),</span>
<span class="nc" id="L16248">                            targetTrooper.isRear(), 0, false, false, 0));</span>
<span class="nc bnc" id="L16249" title="All 2 branches missed.">                } else if (te instanceof Mech) {</span>
<span class="nc bnc" id="L16250" title="All 2 branches missed.">                    if (((Mech) te).isIndustrial()) {</span>
<span class="nc bnc" id="L16251" title="All 2 branches missed.">                        if (taserRoll &gt;= 8) {</span>
<span class="nc" id="L16252">                            r = new Report(3705);</span>
<span class="nc" id="L16253">                            r.addDesc(te);</span>
<span class="nc" id="L16254">                            r.add(4);</span>
<span class="nc" id="L16255">                            te.taserShutdown(4, false);</span>
                        } else {
                            // suffer +2 to piloting and gunnery for 4 rounds
<span class="nc" id="L16258">                            r = new Report(3710);</span>
<span class="nc" id="L16259">                            r.addDesc(te);</span>
<span class="nc" id="L16260">                            r.add(2);</span>
<span class="nc" id="L16261">                            r.add(4);</span>
<span class="nc" id="L16262">                            te.setTaserInterference(2, 4, true);</span>
                        }
                    } else {
<span class="nc bnc" id="L16265" title="All 2 branches missed.">                        if (taserRoll &gt;= 11) {</span>
<span class="nc" id="L16266">                            r = new Report(3705);</span>
<span class="nc" id="L16267">                            r.addDesc(te);</span>
<span class="nc" id="L16268">                            r.add(3);</span>
<span class="nc" id="L16269">                            vPhaseReport.add(r);</span>
<span class="nc" id="L16270">                            te.taserShutdown(3, false);</span>
                        } else {
<span class="nc" id="L16272">                            r = new Report(3710);</span>
<span class="nc" id="L16273">                            r.addDesc(te);</span>
<span class="nc" id="L16274">                            r.add(2);</span>
<span class="nc" id="L16275">                            r.add(3);</span>
<span class="nc" id="L16276">                            vPhaseReport.add(r);</span>
<span class="nc" id="L16277">                            te.setTaserInterference(2, 3, true);</span>
                        }
                    }
<span class="nc bnc" id="L16280" title="All 6 branches missed.">                } else if ((te instanceof Protomech) || (te instanceof Tank)</span>
                           || (te instanceof Aero)) {
<span class="nc bnc" id="L16282" title="All 2 branches missed.">                    if (taserRoll &gt;= 8) {</span>
<span class="nc" id="L16283">                        r = new Report(3705);</span>
<span class="nc" id="L16284">                        r.addDesc(te);</span>
<span class="nc" id="L16285">                        r.add(4);</span>
<span class="nc" id="L16286">                        vPhaseReport.add(r);</span>
<span class="nc" id="L16287">                        te.taserShutdown(4, false);</span>
                    } else {
<span class="nc" id="L16289">                        r = new Report(3710);</span>
<span class="nc" id="L16290">                        r.addDesc(te);</span>
<span class="nc" id="L16291">                        r.add(2);</span>
<span class="nc" id="L16292">                        r.add(4);</span>
<span class="nc" id="L16293">                        vPhaseReport.add(r);</span>
<span class="nc" id="L16294">                        te.setTaserInterference(2, 4, false);</span>
                    }
                }

            }
        }

<span class="nc" id="L16301">        addNewLines();</span>

        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L16305" title="All 4 branches missed.">        if ((target instanceof Mech) &amp;&amp; ((Mech) target).isIndustrial()) {</span>
<span class="nc" id="L16306">            ((Mech) target).setCheckForCrit(true);</span>
        }
<span class="nc" id="L16308">    }</span>

    /**
     * Handle a brush off attack
     */
    private void resolveBrushOffAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L16314">        final BrushOffAttackAction baa = (BrushOffAttackAction) pr.aaa;</span>
<span class="nc" id="L16315">        final Entity ae = game.getEntity(baa.getEntityId());</span>
        // PLEASE NOTE: buildings are *never* the target
        // of a &quot;brush off&quot;, but iNarc pods **are**.
<span class="nc" id="L16318">        Targetable target = game.getTarget(baa.getTargetType(), baa.getTargetId());</span>
<span class="nc" id="L16319">        Entity te = null;</span>
<span class="nc bnc" id="L16320" title="All 2 branches missed.">        final String armName = baa.getArm() == BrushOffAttackAction.LEFT ? &quot;Left Arm&quot; : &quot;Right Arm&quot;;</span>
        Report r;

<span class="nc bnc" id="L16323" title="All 2 branches missed.">        if (target.getTargetType() == Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L16324">            te = game.getEntity(baa.getTargetId());</span>
        }

        // get damage, ToHitData and roll from the PhysicalResult
        // ASSUMPTION: buildings can't absorb *this* damage.
<span class="nc bnc" id="L16329" title="All 2 branches missed.">        int damage = baa.getArm() == BrushOffAttackAction.LEFT ? pr.damage : pr.damageRight;</span>
<span class="nc bnc" id="L16330" title="All 2 branches missed.">        final ToHitData toHit = baa.getArm() == BrushOffAttackAction.LEFT ? pr.toHit : pr.toHitRight;</span>
<span class="nc bnc" id="L16331" title="All 2 branches missed.">        int roll = baa.getArm() == BrushOffAttackAction.LEFT ? pr.roll : pr.rollRight;</span>

<span class="nc bnc" id="L16333" title="All 2 branches missed.">        if (lastEntityId != baa.getEntityId()) {</span>
            // who is making the attacks
<span class="nc" id="L16335">            r = new Report(4005);</span>
<span class="nc" id="L16336">            r.subject = ae.getId();</span>
<span class="nc" id="L16337">            r.addDesc(ae);</span>
<span class="nc" id="L16338">            addReport(r);</span>
        }

<span class="nc" id="L16341">        r = new Report(4085);</span>
<span class="nc" id="L16342">        r.subject = ae.getId();</span>
<span class="nc" id="L16343">        r.indent();</span>
<span class="nc" id="L16344">        r.add(target.getDisplayName());</span>
<span class="nc" id="L16345">        r.add(armName);</span>
<span class="nc" id="L16346">        r.newlines = 0;</span>
<span class="nc" id="L16347">        addReport(r);</span>

<span class="nc bnc" id="L16349" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L16350">            r = new Report(4090);</span>
<span class="nc" id="L16351">            r.subject = ae.getId();</span>
<span class="nc" id="L16352">            r.add(toHit.getDesc());</span>
<span class="nc" id="L16353">            addReport(r);</span>
<span class="nc" id="L16354">            return;</span>
        }

        // report the roll
<span class="nc" id="L16358">        r = new Report(4025);</span>
<span class="nc" id="L16359">        r.subject = ae.getId();</span>
<span class="nc" id="L16360">        r.add(toHit.getValue());</span>
<span class="nc" id="L16361">        r.add(roll);</span>
<span class="nc" id="L16362">        r.newlines = 0;</span>
<span class="nc" id="L16363">        addReport(r);</span>

        // do we hit?
<span class="nc bnc" id="L16366" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L16368">            r = new Report(4035);</span>
<span class="nc" id="L16369">            r.subject = ae.getId();</span>
<span class="nc" id="L16370">            addReport(r);</span>

            // Missed Brush Off attacks cause punch damage to the attacker.
<span class="nc" id="L16373">            toHit.setHitTable(ToHitData.HIT_PUNCH);</span>
<span class="nc" id="L16374">            toHit.setSideTable(ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L16375">            HitData hit = ae.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L16376">            hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L16377">            r = new Report(4095);</span>
<span class="nc" id="L16378">            r.subject = ae.getId();</span>
<span class="nc" id="L16379">            r.addDesc(ae);</span>
<span class="nc" id="L16380">            r.add(ae.getLocationAbbr(hit));</span>
<span class="nc" id="L16381">            r.newlines = 0;</span>
<span class="nc" id="L16382">            addReport(r);</span>
<span class="nc" id="L16383">            addReport(damageEntity(ae, hit, damage));</span>
<span class="nc" id="L16384">            addNewLines();</span>
            // if this is an industrial mech, it needs to check for crits
            // at the end of turn
<span class="nc bnc" id="L16387" title="All 4 branches missed.">            if ((ae instanceof Mech) &amp;&amp; ((Mech) ae).isIndustrial()) {</span>
<span class="nc" id="L16388">                ((Mech) ae).setCheckForCrit(true);</span>
            }
<span class="nc" id="L16390">            return;</span>
        }

        // Different target types get different handling.
<span class="nc bnc" id="L16394" title="All 3 branches missed.">        switch (target.getTargetType()) {</span>
            case Targetable.TYPE_ENTITY:
                // Handle Entity targets.
<span class="nc" id="L16397">                HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L16398">                hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L16399">                r = new Report(4045);</span>
<span class="nc" id="L16400">                r.subject = ae.getId();</span>
<span class="nc" id="L16401">                r.add(toHit.getTableDesc());</span>
<span class="nc" id="L16402">                r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L16403">                addReport(r);</span>
<span class="nc" id="L16404">                addReport(damageEntity(te, hit, damage));</span>
<span class="nc" id="L16405">                addNewLines();</span>

                // Dislodge the swarming infantry.
<span class="nc" id="L16408">                ae.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L16409">                te.setSwarmTargetId(Entity.NONE);</span>
<span class="nc" id="L16410">                r = new Report(4100);</span>
<span class="nc" id="L16411">                r.subject = ae.getId();</span>
<span class="nc" id="L16412">                r.add(te.getDisplayName());</span>
<span class="nc" id="L16413">                addReport(r);</span>
<span class="nc" id="L16414">                break;</span>
            case Targetable.TYPE_INARC_POD:
                // Handle iNarc pod targets.
                // TODO : check the return code and handle false appropriately.
<span class="nc" id="L16418">                ae.removeINarcPod((INarcPod) target);</span>
                // // TODO : confirm that we don't need to update the attacker.
                // //killme
                // entityUpdate( ae.getId() ); // killme
<span class="nc" id="L16422">                r = new Report(4105);</span>
<span class="nc" id="L16423">                r.subject = ae.getId();</span>
<span class="nc" id="L16424">                r.add(target.getDisplayName());</span>
<span class="nc" id="L16425">                addReport(r);</span>
                break;
            // TODO : add a default: case and handle it appropriately.
        }
<span class="nc" id="L16429">    }</span>

    /**
     * Handle a thrash attack
     */
    private void resolveThrashAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L16435">        final ThrashAttackAction taa = (ThrashAttackAction) pr.aaa;</span>
<span class="nc" id="L16436">        final Entity ae = game.getEntity(taa.getEntityId());</span>

        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L16439">        int hits = pr.damage;</span>
<span class="nc" id="L16440">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L16441">        int roll = pr.roll;</span>
<span class="nc bnc" id="L16442" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS)
<span class="nc bnc" id="L16444" title="All 2 branches missed.">                                 &amp;&amp; (roll == toHit.getValue());</span>

        // Set Margin of Success/Failure.
<span class="nc" id="L16447">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L16448" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW)
<span class="nc bnc" id="L16450" title="All 2 branches missed.">                                   &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        // PLEASE NOTE: buildings are *never* the target of a &quot;thrash&quot;.
<span class="nc" id="L16453">        final Entity te = game.getEntity(taa.getTargetId());</span>
        Report r;

<span class="nc bnc" id="L16456" title="All 2 branches missed.">        if (lastEntityId != taa.getEntityId()) {</span>
            // who is making the attacks
<span class="nc" id="L16458">            r = new Report(4005);</span>
<span class="nc" id="L16459">            r.subject = ae.getId();</span>
<span class="nc" id="L16460">            r.addDesc(ae);</span>
<span class="nc" id="L16461">            addReport(r);</span>
        }

<span class="nc" id="L16464">        r = new Report(4110);</span>
<span class="nc" id="L16465">        r.subject = ae.getId();</span>
<span class="nc" id="L16466">        r.indent();</span>
<span class="nc" id="L16467">        r.addDesc(te);</span>
<span class="nc" id="L16468">        r.newlines = 0;</span>
<span class="nc" id="L16469">        addReport(r);</span>

<span class="nc bnc" id="L16471" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L16472">            r = new Report(4115);</span>
<span class="nc" id="L16473">            r.subject = ae.getId();</span>
<span class="nc" id="L16474">            r.add(toHit.getDesc());</span>
<span class="nc" id="L16475">            addReport(r);</span>
<span class="nc" id="L16476">            return;</span>
        }

        // Thrash attack may hit automatically
<span class="nc bnc" id="L16480" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L16481">            r = new Report(4120);</span>
        } else {
            // report the roll
<span class="nc" id="L16484">            r = new Report(4025);</span>
<span class="nc" id="L16485">            r.subject = ae.getId();</span>
<span class="nc" id="L16486">            r.add(toHit.getValue());</span>
<span class="nc" id="L16487">            r.add(roll);</span>
<span class="nc" id="L16488">            r.newlines = 0;</span>
<span class="nc" id="L16489">            addReport(r);</span>

            // do we hit?
<span class="nc bnc" id="L16492" title="All 2 branches missed.">            if (roll &lt; toHit.getValue()) {</span>
                // miss
<span class="nc" id="L16494">                r = new Report(4035);</span>
<span class="nc" id="L16495">                r.subject = ae.getId();</span>
<span class="nc" id="L16496">                addReport(r);</span>
<span class="nc" id="L16497">                return;</span>
            }
<span class="nc" id="L16499">            r = new Report(4125);</span>
        }
<span class="nc" id="L16501">        r.subject = ae.getId();</span>
<span class="nc" id="L16502">        r.newlines = 0;</span>
<span class="nc" id="L16503">        addReport(r);</span>

        // Standard damage loop in 5 point clusters.
<span class="nc bnc" id="L16506" title="All 2 branches missed.">        if (glancing) {</span>
<span class="nc" id="L16507">            hits = (int) Math.floor(hits / 2.0);</span>
        }
<span class="nc bnc" id="L16509" title="All 2 branches missed.">        if (directBlow) {</span>
<span class="nc" id="L16510">            hits += toHit.getMoS() / 3;</span>
        }

<span class="nc" id="L16513">        r = new Report(4130);</span>
<span class="nc" id="L16514">        r.subject = ae.getId();</span>
<span class="nc" id="L16515">        r.add(hits);</span>
<span class="nc" id="L16516">        r.newlines = 0;</span>
<span class="nc" id="L16517">        addReport(r);</span>
<span class="nc bnc" id="L16518" title="All 2 branches missed.">        if (glancing) {</span>
<span class="nc" id="L16519">            r = new Report(3186);</span>
<span class="nc" id="L16520">            r.subject = ae.getId();</span>
<span class="nc" id="L16521">            r.newlines = 0;</span>
<span class="nc" id="L16522">            addReport(r);</span>
        }
<span class="nc bnc" id="L16524" title="All 2 branches missed.">        if (directBlow) {</span>
<span class="nc" id="L16525">            r = new Report(3189);</span>
<span class="nc" id="L16526">            r.subject = ae.getId();</span>
<span class="nc" id="L16527">            r.newlines = 0;</span>
<span class="nc" id="L16528">            addReport(r);</span>
        }

<span class="nc bnc" id="L16531" title="All 2 branches missed.">        while (hits &gt; 0) {</span>
<span class="nc" id="L16532">            int damage = Math.min(5, hits);</span>
<span class="nc" id="L16533">            hits -= damage;</span>
<span class="nc" id="L16534">            HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L16535">            hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L16536">            r = new Report(4135);</span>
<span class="nc" id="L16537">            r.subject = ae.getId();</span>
<span class="nc" id="L16538">            r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L16539">            r.newlines = 0;</span>
<span class="nc" id="L16540">            addReport(r);</span>
<span class="nc" id="L16541">            addReport(damageEntity(te, hit, damage));</span>
<span class="nc" id="L16542">        }</span>

<span class="nc" id="L16544">        addNewLines();</span>

        // Thrash attacks cause PSRs. Failed PSRs cause falling damage.
        // This fall damage applies even though the Thrashing Mek is prone.
<span class="nc" id="L16548">        PilotingRollData rollData = ae.getBasePilotingRoll();</span>
<span class="nc" id="L16549">        ae.addPilotingModifierForTerrain(rollData);</span>
<span class="nc" id="L16550">        rollData.addModifier(0, &quot;thrashing at infantry&quot;);</span>
<span class="nc" id="L16551">        r = new Report(4140);</span>
<span class="nc" id="L16552">        r.subject = ae.getId();</span>
<span class="nc" id="L16553">        r.addDesc(ae);</span>
<span class="nc" id="L16554">        addReport(r);</span>
<span class="nc" id="L16555">        final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L16556">        r = new Report(2190);</span>
<span class="nc" id="L16557">        r.subject = ae.getId();</span>
<span class="nc" id="L16558">        r.add(rollData.getValueAsString());</span>
<span class="nc" id="L16559">        r.add(rollData.getDesc());</span>
<span class="nc" id="L16560">        r.add(diceRoll);</span>
<span class="nc bnc" id="L16561" title="All 2 branches missed.">        if (diceRoll &lt; rollData.getValue()) {</span>
<span class="nc" id="L16562">            r.choose(false);</span>
<span class="nc" id="L16563">            addReport(r);</span>
<span class="nc" id="L16564">            addReport(doEntityFall(ae, rollData));</span>
        } else {
<span class="nc" id="L16566">            r.choose(true);</span>
<span class="nc" id="L16567">            addReport(r);</span>
        }
<span class="nc" id="L16569">    }</span>

    /**
     * Handle a thrash attack
     */
    private void resolveBAVibroClawAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L16575">        final BAVibroClawAttackAction bvaa = (BAVibroClawAttackAction) pr.aaa;</span>
<span class="nc" id="L16576">        final Entity ae = game.getEntity(bvaa.getEntityId());</span>

        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L16579">        int hits = pr.damage;</span>
<span class="nc" id="L16580">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L16581">        int roll = pr.roll;</span>
<span class="nc bnc" id="L16582" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS)
<span class="nc bnc" id="L16584" title="All 2 branches missed.">                                 &amp;&amp; (roll == toHit.getValue());</span>

        // Set Margin of Success/Failure.
<span class="nc" id="L16587">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L16588" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW)
<span class="nc bnc" id="L16590" title="All 2 branches missed.">                                   &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        // PLEASE NOTE: buildings are *never* the target of a BA vibroclaw
        // attack.
<span class="nc" id="L16594">        final Entity te = game.getEntity(bvaa.getTargetId());</span>
        Report r;

<span class="nc bnc" id="L16597" title="All 2 branches missed.">        if (lastEntityId != bvaa.getEntityId()) {</span>
            // who is making the attacks
<span class="nc" id="L16599">            r = new Report(4005);</span>
<span class="nc" id="L16600">            r.subject = ae.getId();</span>
<span class="nc" id="L16601">            r.addDesc(ae);</span>
<span class="nc" id="L16602">            addReport(r);</span>
        }

<span class="nc" id="L16605">        r = new Report(4146);</span>
<span class="nc" id="L16606">        r.subject = ae.getId();</span>
<span class="nc" id="L16607">        r.indent();</span>
<span class="nc" id="L16608">        r.addDesc(te);</span>
<span class="nc" id="L16609">        r.newlines = 0;</span>
<span class="nc" id="L16610">        addReport(r);</span>

<span class="nc bnc" id="L16612" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L16613">            r = new Report(4147);</span>
<span class="nc" id="L16614">            r.subject = ae.getId();</span>
<span class="nc" id="L16615">            r.add(toHit.getDesc());</span>
<span class="nc" id="L16616">            addReport(r);</span>
<span class="nc" id="L16617">            return;</span>
        }

        // we may hit automatically
<span class="nc bnc" id="L16621" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L16622">            r = new Report(4120);</span>
<span class="nc" id="L16623">            r.subject = ae.getId();</span>
<span class="nc" id="L16624">            r.newlines = 0;</span>
<span class="nc" id="L16625">            addReport(r);</span>
        } else {
            // report the roll
<span class="nc" id="L16628">            r = new Report(4025);</span>
<span class="nc" id="L16629">            r.subject = ae.getId();</span>
<span class="nc" id="L16630">            r.add(toHit.getValue());</span>
<span class="nc" id="L16631">            r.add(roll);</span>
<span class="nc" id="L16632">            r.newlines = 0;</span>
<span class="nc" id="L16633">            addReport(r);</span>

            // do we hit?
<span class="nc bnc" id="L16636" title="All 2 branches missed.">            if (roll &lt; toHit.getValue()) {</span>
                // miss
<span class="nc" id="L16638">                r = new Report(4035);</span>
<span class="nc" id="L16639">                r.subject = ae.getId();</span>
<span class="nc" id="L16640">                addReport(r);</span>
<span class="nc" id="L16641">                return;</span>
            }
        }

        // Standard damage loop
<span class="nc bnc" id="L16646" title="All 2 branches missed.">        if (glancing) {</span>
<span class="nc" id="L16647">            hits = (int) Math.floor(hits / 2.0);</span>
        }
<span class="nc bnc" id="L16649" title="All 2 branches missed.">        if (directBlow) {</span>
<span class="nc" id="L16650">            hits += toHit.getMoS() / 3;</span>
        }
<span class="nc bnc" id="L16652" title="All 4 branches missed.">        if ((te instanceof Infantry) &amp;&amp; !(te instanceof BattleArmor)) {</span>
<span class="nc" id="L16653">            r = new Report(4149);</span>
<span class="nc" id="L16654">            r.subject = ae.getId();</span>
<span class="nc" id="L16655">            r.add(hits);</span>
        } else {
<span class="nc" id="L16657">            r = new Report(4148);</span>
<span class="nc" id="L16658">            r.subject = ae.getId();</span>
<span class="nc" id="L16659">            r.add(hits);</span>
<span class="nc" id="L16660">            r.add(ae.getVibroClaws());</span>
        }
<span class="nc" id="L16662">        r.newlines = 0;</span>
<span class="nc" id="L16663">        addReport(r);</span>
<span class="nc bnc" id="L16664" title="All 2 branches missed.">        if (glancing) {</span>
<span class="nc" id="L16665">            r = new Report(3186);</span>
<span class="nc" id="L16666">            r.subject = ae.getId();</span>
<span class="nc" id="L16667">            r.newlines = 0;</span>
<span class="nc" id="L16668">            addReport(r);</span>
        }
<span class="nc bnc" id="L16670" title="All 2 branches missed.">        if (directBlow) {</span>
<span class="nc" id="L16671">            r = new Report(3189);</span>
<span class="nc" id="L16672">            r.subject = ae.getId();</span>
<span class="nc" id="L16673">            r.newlines = 0;</span>
<span class="nc" id="L16674">            addReport(r);</span>
        }
<span class="nc bnc" id="L16676" title="All 2 branches missed.">        while (hits &gt; 0) {</span>
            // BA get hit separately by each attacking BA trooper
<span class="nc" id="L16678">            int damage = Math.min(ae.getVibroClaws(), hits);</span>
            // conventional infantry get hit in one lump
<span class="nc bnc" id="L16680" title="All 4 branches missed.">            if ((te instanceof Infantry) &amp;&amp; !(te instanceof BattleArmor)) {</span>
<span class="nc" id="L16681">                damage = hits;</span>
            }
<span class="nc" id="L16683">            hits -= damage;</span>
<span class="nc" id="L16684">            HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L16685">            hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L16686">            r = new Report(4135);</span>
<span class="nc" id="L16687">            r.subject = ae.getId();</span>
<span class="nc" id="L16688">            r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L16689">            r.newlines = 0;</span>
<span class="nc" id="L16690">            addReport(r);</span>
<span class="nc" id="L16691">            addReport(damageEntity(te, hit, damage));</span>
<span class="nc" id="L16692">        }</span>
<span class="nc" id="L16693">        addNewLines();</span>
<span class="nc" id="L16694">    }</span>

    /**
     * Handle a club attack
     */
    private void resolveClubAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L16700">        final ClubAttackAction caa = (ClubAttackAction) pr.aaa;</span>
<span class="nc" id="L16701">        final Entity ae = game.getEntity(caa.getEntityId());</span>
        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L16703">        int damage = pr.damage;</span>
        // LAMs in airmech mode do half damage if airborne.
<span class="nc bnc" id="L16705" title="All 2 branches missed.">        if (ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L16706">            damage = (int)Math.ceil(damage * 0.5);</span>
        }
<span class="nc" id="L16708">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L16709">        int roll = pr.roll;</span>
<span class="nc" id="L16710">        final Targetable target = game.getTarget(caa.getTargetType(), caa.getTargetId());</span>
<span class="nc" id="L16711">        Entity te = null;</span>
<span class="nc bnc" id="L16712" title="All 2 branches missed.">        if (target.getTargetType() == Targetable.TYPE_ENTITY) {</span>
<span class="nc" id="L16713">            te = (Entity) target;</span>
        }
<span class="nc" id="L16715">        boolean throughFront = true;</span>
<span class="nc bnc" id="L16716" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L16717">            throughFront = Compute</span>
<span class="nc" id="L16718">                    .isThroughFrontHex(game, ae.getPosition(), te);</span>
        }
<span class="nc" id="L16720">        final boolean targetInBuilding = Compute.isInBuilding(game, te);</span>
<span class="nc bnc" id="L16721" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L16722" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS) &amp;&amp; (roll == toHit.getValue());</span>

        // Set Margin of Success/Failure.
        // Make sure the MoS is zero for *automatic* hits in case direct blows
        // are in force.
<span class="nc bnc" id="L16727" title="All 2 branches missed.">        toHit.setMoS((roll == Integer.MAX_VALUE) ? 0 : roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L16728" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L16729" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW) &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        Report r;


        // Which building takes the damage?
<span class="nc" id="L16735">        Building bldg = game.getBoard().getBuildingAt(target.getPosition());</span>

        // restore club attack
<span class="nc" id="L16738">        caa.getClub().restore();</span>

        // Shield bash causes 1 point of damage to the shield
<span class="nc bnc" id="L16741" title="All 2 branches missed.">        if (((MiscType) caa.getClub().getType()).isShield()) {</span>
<span class="nc" id="L16742">            ((Mech) ae).shieldAbsorptionDamage(1, caa.getClub().getLocation(), false);</span>
        }

<span class="nc bnc" id="L16745" title="All 2 branches missed.">        if (lastEntityId != caa.getEntityId()) {</span>
            // who is making the attacks
<span class="nc" id="L16747">            r = new Report(4005);</span>
<span class="nc" id="L16748">            r.subject = ae.getId();</span>
<span class="nc" id="L16749">            r.addDesc(ae);</span>
<span class="nc" id="L16750">            addReport(r);</span>
        }

<span class="nc" id="L16753">        r = new Report(4145);</span>
<span class="nc" id="L16754">        r.subject = ae.getId();</span>
<span class="nc" id="L16755">        r.indent();</span>
<span class="nc" id="L16756">        r.add(caa.getClub().getName());</span>
<span class="nc" id="L16757">        r.add(target.getDisplayName());</span>
<span class="nc" id="L16758">        r.newlines = 0;</span>
<span class="nc" id="L16759">        addReport(r);</span>

        // Flail/Wrecking Ball auto misses on a 2 and hits themself.
<span class="nc bnc" id="L16762" title="All 2 branches missed.">        if ((caa.getClub().getType().hasSubType(MiscType.S_FLAIL)</span>
<span class="nc bnc" id="L16763" title="All 4 branches missed.">                || caa.getClub().getType().hasSubType(MiscType.S_WRECKING_BALL))</span>
            &amp;&amp; (roll == 2)) {
            // miss
<span class="nc" id="L16766">            r = new Report(4035);</span>
<span class="nc" id="L16767">            r.subject = ae.getId();</span>
<span class="nc" id="L16768">            addReport(r);</span>
<span class="nc" id="L16769">            ToHitData newToHit = new ToHitData(TargetRoll.AUTOMATIC_SUCCESS,</span>
                                               &quot;hit with own flail/wrecking ball&quot;);
<span class="nc" id="L16771">            pr.damage = ClubAttackAction.getDamageFor(ae, caa.getClub(), false, caa.isZweihandering());</span>
<span class="nc" id="L16772">            pr.damage = (pr.damage / 2) + (pr.damage % 2);</span>
<span class="nc" id="L16773">            newToHit.setHitTable(ToHitData.HIT_NORMAL);</span>
<span class="nc" id="L16774">            newToHit.setSideTable(ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L16775">            pr.toHit = newToHit;</span>
<span class="nc" id="L16776">            pr.aaa.setTargetId(ae.getId());</span>
<span class="nc" id="L16777">            pr.aaa.setTargetType(Targetable.TYPE_ENTITY);</span>
<span class="nc" id="L16778">            pr.roll = Integer.MAX_VALUE;</span>
<span class="nc" id="L16779">            resolveClubAttack(pr, ae.getId());</span>
<span class="nc bnc" id="L16780" title="All 4 branches missed.">            if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L16781">                game.addControlRoll(new PilotingRollData(ae.getId(), 0,</span>
                        &quot;missed a flail/wrecking ball attack&quot;));
            } else {
<span class="nc" id="L16784">                game.addPSR(new PilotingRollData(ae.getId(), 0,</span>
                                                 &quot;missed a flail/wrecking ball attack&quot;));
            }
<span class="nc bnc" id="L16787" title="All 2 branches missed.">            if(caa.isZweihandering()) {</span>
<span class="nc" id="L16788">                ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L16789">                criticalLocs.add(caa.getClub().getLocation());</span>
<span class="nc" id="L16790">                applyZweihanderSelfDamage(ae, true, criticalLocs);</span>
            }
<span class="nc" id="L16792">            return;</span>
        }

        // Need to compute 2d6 damage. and add +3 heat build up.
<span class="nc bnc" id="L16796" title="All 2 branches missed.">        if (caa.getClub().getType().hasSubType(MiscType.S_BUZZSAW)) {</span>
<span class="nc" id="L16797">            damage = Compute.d6(2);</span>
<span class="nc" id="L16798">            ae.heatBuildup += 3;</span>

            // Buzzsaw's blade will shatter on a roll of 2.
<span class="nc bnc" id="L16801" title="All 2 branches missed.">            if (roll == 2) {</span>

<span class="nc" id="L16803">                Mounted club = caa.getClub();</span>

<span class="nc bnc" id="L16805" title="All 2 branches missed.">                for (Mounted eq : ae.getWeaponList()) {</span>
<span class="nc bnc" id="L16806" title="All 2 branches missed.">                    if ((eq.getLocation() == club.getLocation())</span>
<span class="nc bnc" id="L16807" title="All 2 branches missed.">                        &amp;&amp; (eq.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L16808" title="All 2 branches missed.">                        &amp;&amp; eq.getType().hasFlag(MiscType.F_CLUB)</span>
<span class="nc bnc" id="L16809" title="All 2 branches missed.">                        &amp;&amp; eq.getType().hasSubType(MiscType.S_BUZZSAW)) {</span>
<span class="nc" id="L16810">                        eq.setHit(true);</span>
<span class="nc" id="L16811">                        break;</span>
                    }
<span class="nc" id="L16813">                }</span>
<span class="nc" id="L16814">                r = new Report(4037);</span>
<span class="nc" id="L16815">                r.subject = ae.getId();</span>
<span class="nc" id="L16816">                addReport(r);</span>
<span class="nc bnc" id="L16817" title="All 2 branches missed.">                if(caa.isZweihandering()) {</span>
<span class="nc" id="L16818">                    ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L16819">                    criticalLocs.add(caa.getClub().getLocation());</span>
<span class="nc" id="L16820">                    applyZweihanderSelfDamage(ae, true, criticalLocs);</span>
                }
<span class="nc" id="L16822">                return;</span>
            }
        }

<span class="nc bnc" id="L16826" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L16827">            r = new Report(4075);</span>
<span class="nc" id="L16828">            r.subject = ae.getId();</span>
<span class="nc" id="L16829">            r.add(toHit.getDesc());</span>
<span class="nc" id="L16830">            addReport(r);</span>
<span class="nc bnc" id="L16831" title="All 2 branches missed.">            if (caa.getClub().getType().hasSubType(MiscType.S_MACE_THB)) {</span>
<span class="nc bnc" id="L16832" title="All 4 branches missed.">                if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L16833">                    game.addControlRoll(new PilotingRollData(ae.getId(), 0,</span>
                            &quot;missed a mace attack&quot;));
                } else {
<span class="nc" id="L16836">                    game.addPSR(new PilotingRollData(ae.getId(), 0,</span>
                            &quot;missed a mace attack&quot;));
                }
            }
<span class="nc bnc" id="L16840" title="All 2 branches missed.">            if (caa.getClub().getType().hasSubType(MiscType.S_MACE)) {</span>
<span class="nc bnc" id="L16841" title="All 4 branches missed.">                if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L16842">                    game.addControlRoll(new PilotingRollData(ae.getId(), 0,</span>
                            &quot;missed a mace attack&quot;));
                } else {
<span class="nc" id="L16845">                    game.addPSR(new PilotingRollData(ae.getId(), 0,</span>
                            &quot;missed a mace attack&quot;));
                }
            }
<span class="nc bnc" id="L16849" title="All 2 branches missed.">            if(caa.isZweihandering()) {</span>
<span class="nc" id="L16850">                ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L16851">                criticalLocs.add(caa.getClub().getLocation());</span>
<span class="nc" id="L16852">                applyZweihanderSelfDamage(ae, true, criticalLocs);</span>
            }
<span class="nc" id="L16854">            return;</span>
<span class="nc bnc" id="L16855" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L16856">            r = new Report(4080);</span>
<span class="nc" id="L16857">            r.subject = ae.getId();</span>
<span class="nc" id="L16858">            r.add(toHit.getDesc());</span>
<span class="nc" id="L16859">            r.newlines = 0;</span>
<span class="nc" id="L16860">            addReport(r);</span>
<span class="nc" id="L16861">            roll = Integer.MAX_VALUE;</span>
        } else {
            // report the roll
<span class="nc" id="L16864">            r = new Report(4025);</span>
<span class="nc" id="L16865">            r.subject = ae.getId();</span>
<span class="nc" id="L16866">            r.add(toHit.getValue());</span>
<span class="nc" id="L16867">            r.add(roll);</span>
<span class="nc" id="L16868">            r.newlines = 0;</span>
<span class="nc" id="L16869">            addReport(r);</span>
<span class="nc bnc" id="L16870" title="All 2 branches missed.">            if (glancing) {</span>
<span class="nc" id="L16871">                r = new Report(3186);</span>
<span class="nc" id="L16872">                r.subject = ae.getId();</span>
<span class="nc" id="L16873">                r.newlines = 0;</span>
<span class="nc" id="L16874">                addReport(r);</span>
            }
<span class="nc bnc" id="L16876" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L16877">                r = new Report(3189);</span>
<span class="nc" id="L16878">                r.subject = ae.getId();</span>
<span class="nc" id="L16879">                r.newlines = 0;</span>
<span class="nc" id="L16880">                addReport(r);</span>
            }

        }

        // do we hit?
<span class="nc bnc" id="L16886" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L16888">            r = new Report(4035);</span>
<span class="nc" id="L16889">            r.subject = ae.getId();</span>
<span class="nc" id="L16890">            addReport(r);</span>
<span class="nc bnc" id="L16891" title="All 2 branches missed.">            if (caa.getClub().getType().hasSubType(MiscType.S_MACE_THB)) {</span>
<span class="nc bnc" id="L16892" title="All 4 branches missed.">                if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L16893">                    game.addControlRoll(new PilotingRollData(ae.getId(), 0,</span>
                            &quot;missed a mace attack&quot;));
                } else {
<span class="nc" id="L16896">                    game.addPSR(new PilotingRollData(ae.getId(), 0,</span>
                            &quot;missed a mace attack&quot;));
                }
            }
<span class="nc bnc" id="L16900" title="All 2 branches missed.">            if (caa.getClub().getType().hasSubType(MiscType.S_MACE)) {</span>
<span class="nc bnc" id="L16901" title="All 4 branches missed.">                if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L16902">                    game.addControlRoll(new PilotingRollData(ae.getId(), 2,</span>
                            &quot;missed a mace attack&quot;));
                } else {
<span class="nc" id="L16905">                    game.addPSR(new PilotingRollData(ae.getId(), 2,</span>
                            &quot;missed a mace attack&quot;));
                }
            }

            // If the target is in a building, the building absorbs the damage.
<span class="nc bnc" id="L16911" title="All 4 branches missed.">            if (targetInBuilding &amp;&amp; (bldg != null)) {</span>

                // Only report if damage was done to the building.
<span class="nc bnc" id="L16914" title="All 2 branches missed.">                if (damage &gt; 0) {</span>
<span class="nc" id="L16915">                    Vector&lt;Report&gt; buildingReport = damageBuilding(bldg,</span>
<span class="nc" id="L16916">                                                                   damage, target.getPosition());</span>
<span class="nc bnc" id="L16917" title="All 2 branches missed.">                    for (Report report : buildingReport) {</span>
<span class="nc" id="L16918">                        report.subject = ae.getId();</span>
<span class="nc" id="L16919">                    }</span>
<span class="nc" id="L16920">                    addReport(buildingReport);</span>
                }

            }
<span class="nc bnc" id="L16924" title="All 2 branches missed.">            if(caa.isZweihandering()) {</span>
<span class="nc" id="L16925">                ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L16926">                criticalLocs.add(caa.getClub().getLocation());</span>
<span class="nc" id="L16927">                applyZweihanderSelfDamage(ae, true, criticalLocs);</span>
            }
<span class="nc" id="L16929">            return;</span>
        }

        // Targeting a building.
<span class="nc bnc" id="L16933" title="All 2 branches missed.">        if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L16934" title="All 2 branches missed.">            || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) {</span>
            // The building takes the full brunt of the attack.
<span class="nc" id="L16936">            r = new Report(4040);</span>
<span class="nc" id="L16937">            r.subject = ae.getId();</span>
<span class="nc" id="L16938">            addReport(r);</span>
<span class="nc" id="L16939">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L16940" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L16941">                report.subject = ae.getId();</span>
<span class="nc" id="L16942">            }</span>
<span class="nc" id="L16943">            addReport(buildingReport);</span>

            // Damage any infantry in the hex.
<span class="nc" id="L16946">            addReport(damageInfantryIn(bldg, damage, target.getPosition()));</span>

<span class="nc bnc" id="L16948" title="All 2 branches missed.">            if(caa.isZweihandering()) {</span>
<span class="nc" id="L16949">                ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L16950">                criticalLocs.add(caa.getClub().getLocation());</span>
<span class="nc" id="L16951">                applyZweihanderSelfDamage(ae, false, criticalLocs);</span>
<span class="nc bnc" id="L16952" title="All 2 branches missed.">                if (caa.getClub().getType().hasSubType(MiscType.S_CLUB)) {</span>
                    // the club breaks
<span class="nc" id="L16954">                    r = new Report(4150);</span>
<span class="nc" id="L16955">                    r.subject = ae.getId();</span>
<span class="nc" id="L16956">                    r.add(caa.getClub().getName());</span>
<span class="nc" id="L16957">                    addReport(r);</span>
<span class="nc" id="L16958">                    ae.removeMisc(caa.getClub().getName());</span>
                }
            }
            // And we're done!
<span class="nc" id="L16962">            return;</span>
        }

<span class="nc" id="L16965">        HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L16966">        hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L16967">        r = new Report(4045);</span>
<span class="nc" id="L16968">        r.subject = ae.getId();</span>
<span class="nc" id="L16969">        r.add(toHit.getTableDesc());</span>
<span class="nc" id="L16970">        r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L16971">        addReport(r);</span>

        // The building shields all units from a certain amount of damage.
        // The amount is based upon the building's CF at the phase's start.
<span class="nc bnc" id="L16975" title="All 4 branches missed.">        if (targetInBuilding &amp;&amp; (bldg != null)) {</span>
<span class="nc" id="L16976">            int bldgAbsorbs = bldg.getAbsorbtion(target.getPosition());</span>
<span class="nc" id="L16977">            int toBldg = Math.min(bldgAbsorbs, damage);</span>
<span class="nc" id="L16978">            damage -= toBldg;</span>
<span class="nc" id="L16979">            addNewLines();</span>
<span class="nc" id="L16980">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L16981" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L16982">                report.subject = ae.getId();</span>
<span class="nc" id="L16983">            }</span>
<span class="nc" id="L16984">            addReport(buildingReport);</span>

            // some buildings scale remaining damage that is not absorbed
            // TODO : this isn't quite right for castles brian
<span class="nc" id="L16988">            damage = (int) Math.floor(bldg.getDamageToScale() * damage);</span>
        }

        // A building may absorb the entire shot.
<span class="nc bnc" id="L16992" title="All 2 branches missed.">        if (damage == 0) {</span>
<span class="nc" id="L16993">            r = new Report(4050);</span>
<span class="nc" id="L16994">            r.subject = ae.getId();</span>
<span class="nc" id="L16995">            r.add(te.getShortName());</span>
<span class="nc" id="L16996">            r.add(te.getOwner().getName());</span>
<span class="nc" id="L16997">            r.newlines = 0;</span>
<span class="nc" id="L16998">            addReport(r);</span>
        } else {
<span class="nc bnc" id="L17000" title="All 2 branches missed.">            if (glancing) {</span>
                // Round up glancing blows against conventional infantry
<span class="nc bnc" id="L17002" title="All 4 branches missed.">                if ((te instanceof Infantry) &amp;&amp; !(te instanceof BattleArmor)) {</span>
<span class="nc" id="L17003">                    damage = (int) Math.ceil(damage / 2.0);</span>
                } else {
<span class="nc" id="L17005">                    damage = (int) Math.floor(damage / 2.0);</span>
                }
            }
<span class="nc bnc" id="L17008" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L17009">                damage += toHit.getMoS() / 3;</span>
<span class="nc" id="L17010">                hit.makeDirectBlow(toHit.getMoS() / 3);</span>
            }

<span class="nc" id="L17013">            damage = checkForSpikes(te, hit.getLocation(), damage, ae, Entity.LOC_NONE);</span>

<span class="nc" id="L17015">            DamageType damageType = DamageType.NONE;</span>
<span class="nc" id="L17016">            addReport(damageEntity(te, hit, damage, false, damageType, false,</span>
                                   false, throughFront));
<span class="nc bnc" id="L17018" title="All 2 branches missed.">            if (target instanceof VTOL) {</span>
                // destroy rotor
<span class="nc" id="L17020">                addReport(applyCriticalHit(te, VTOL.LOC_ROTOR,</span>
                                           new CriticalSlot(CriticalSlot.TYPE_SYSTEM,
                                                            VTOL.CRIT_ROTOR_DESTROYED), false, 0, false));
            }
        }

        // On a roll of 10+ a lance hitting a mech/Vehicle can cause 1 point of
        // internal damage
<span class="nc bnc" id="L17028" title="All 2 branches missed.">        if (caa.getClub().getType().hasSubType(MiscType.S_LANCE)</span>
<span class="nc bnc" id="L17029" title="All 2 branches missed.">            &amp;&amp; (te.getArmor(hit) &gt; 0)</span>
<span class="nc bnc" id="L17030" title="All 2 branches missed.">            &amp;&amp; (te.getArmorType(hit.getLocation()) != EquipmentType.T_ARMOR_HARDENED)</span>
<span class="nc bnc" id="L17031" title="All 2 branches missed.">            &amp;&amp; (te.getArmorType(hit.getLocation()) != EquipmentType.T_ARMOR_FERRO_LAMELLOR)) {</span>
<span class="nc" id="L17032">            roll = Compute.d6(2);</span>
            // Pierce checking report
<span class="nc" id="L17034">            r = new Report(4021);</span>
<span class="nc" id="L17035">            r.indent(2);</span>
<span class="nc" id="L17036">            r.subject = ae.getId();</span>
<span class="nc" id="L17037">            r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L17038">            r.add(roll);</span>
<span class="nc" id="L17039">            addReport(r);</span>
<span class="nc bnc" id="L17040" title="All 2 branches missed.">            if (roll &gt;= 10) {</span>
<span class="nc" id="L17041">                hit.makeGlancingBlow();</span>
<span class="nc" id="L17042">                addReport(damageEntity(te, hit, 1, false, DamageType.NONE,</span>
                                       true, false, throughFront));
            }
        }

        // TODO : Verify this is correct according to latest rules
<span class="nc bnc" id="L17048" title="All 6 branches missed.">        if (caa.getClub().getType().hasSubType(MiscType.S_WRECKING_BALL)</span>
                &amp;&amp; (ae instanceof SupportTank) &amp;&amp; (te instanceof Mech)) {
            // forces a PSR like a charge
<span class="nc bnc" id="L17051" title="All 4 branches missed.">            if (te instanceof LandAirMech &amp;&amp; te.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L17052">                game.addControlRoll(new PilotingRollData(te.getId(), 2,</span>
                        &quot;was hit by wrecking ball&quot;));
            } else {
<span class="nc" id="L17055">                game.addPSR(new PilotingRollData(te.getId(), 2,</span>
                        &quot;was hit by wrecking ball&quot;));
            }
        }

        // Chain whips can entangle 'Mech and ProtoMech limbs. This
        // implementation assumes that in order to do so the limb must still
        // have some structure left, so if the whip hits and destroys a
        // location in the same attack no special effects take place.
<span class="nc bnc" id="L17064" title="All 6 branches missed.">        if (caa.getClub().getType().hasSubType(MiscType.S_CHAIN_WHIP)</span>
                &amp;&amp; ((te instanceof Mech) || (te instanceof Protomech))) {
<span class="nc" id="L17066">            addNewLines();</span>

<span class="nc" id="L17068">            int loc = hit.getLocation();</span>
<span class="nc" id="L17069">            int toHitNumber = toHit.getValue();</span>

<span class="nc bnc" id="L17071" title="All 2 branches missed.">            boolean mightTrip = (te instanceof Mech)</span>
<span class="nc bnc" id="L17072" title="All 2 branches missed.">                    &amp;&amp; te.locationIsLeg(loc)</span>
<span class="nc bnc" id="L17073" title="All 2 branches missed.">                    &amp;&amp; !te.isLocationBad(loc)</span>
<span class="nc bnc" id="L17074" title="All 2 branches missed.">                    &amp;&amp; !te.isLocationDoomed(loc)</span>
<span class="nc bnc" id="L17075" title="All 2 branches missed.">                    &amp;&amp; !te.hasActiveShield(loc)</span>
<span class="nc bnc" id="L17076" title="All 2 branches missed.">                    &amp;&amp; !te.hasPassiveShield(loc);</span>

<span class="nc bnc" id="L17078" title="All 6 branches missed.">            boolean mightGrapple = ((te instanceof Mech)</span>
                    &amp;&amp; ((loc == Mech.LOC_LARM) || (loc == Mech.LOC_RARM))
<span class="nc bnc" id="L17080" title="All 2 branches missed.">                    &amp;&amp; !te.isLocationBad(loc)</span>
<span class="nc bnc" id="L17081" title="All 2 branches missed.">                    &amp;&amp; !te.isLocationDoomed(loc)</span>
<span class="nc bnc" id="L17082" title="All 2 branches missed.">                    &amp;&amp; !te.hasActiveShield(loc)</span>
<span class="nc bnc" id="L17083" title="All 2 branches missed.">                    &amp;&amp; !te.hasPassiveShield(loc)</span>
<span class="nc bnc" id="L17084" title="All 10 branches missed.">                    &amp;&amp; !te.hasNoDefenseShield(loc))</span>
                    || ((te instanceof Protomech)
                        &amp;&amp; ((loc == Protomech.LOC_LARM) || (loc == Protomech.LOC_RARM)
                            || (loc == Protomech.LOC_LEG))
                        // Only check location status after confirming we did
                        // hit a limb -- Protos have no actual near-miss
                        // &quot;location&quot; and will throw an exception if it's
                        // referenced here.
<span class="nc bnc" id="L17092" title="All 2 branches missed.">                        &amp;&amp; !te.isLocationBad(loc)</span>
<span class="nc bnc" id="L17093" title="All 2 branches missed.">                        &amp;&amp; !te.isLocationDoomed(loc));</span>

<span class="nc bnc" id="L17095" title="All 2 branches missed.">            if (mightTrip) {</span>
<span class="nc" id="L17096">                roll = Compute.d6(2);</span>

<span class="nc bnc" id="L17098" title="All 6 branches missed.">                if ((ae instanceof Mech) &amp;&amp; (((Mech) ae).hasTSM() &amp;&amp; (ae.heat &gt;= 9))</span>
<span class="nc bnc" id="L17099" title="All 6 branches missed.">                        &amp;&amp; (!((Mech) te).hasTSM() || ((((Mech) te).hasTSM()) &amp;&amp; (te.heat &lt; 9)))) {</span>
<span class="nc" id="L17100">                    toHitNumber -= 2;</span>
                }

<span class="nc" id="L17103">                r = new Report(4450);</span>
<span class="nc" id="L17104">                r.subject = ae.getId();</span>
<span class="nc" id="L17105">                r.add(ae.getShortName());</span>
<span class="nc" id="L17106">                r.add(te.getShortName());</span>
<span class="nc" id="L17107">                r.add(toHitNumber);</span>
<span class="nc" id="L17108">                r.add(roll);</span>
<span class="nc" id="L17109">                r.indent(2);</span>
<span class="nc" id="L17110">                r.newlines = 0;</span>
<span class="nc" id="L17111">                addReport(r);</span>

<span class="nc bnc" id="L17113" title="All 2 branches missed.">                if (roll &gt;= toHit.getValue()) {</span>
<span class="nc" id="L17114">                    r = new Report(2270);</span>
<span class="nc" id="L17115">                    r.subject = ae.getId();</span>
<span class="nc" id="L17116">                    r.newlines = 0;</span>
<span class="nc" id="L17117">                    addReport(r);</span>

<span class="nc" id="L17119">                    game.addPSR(new PilotingRollData(te.getId(), 3, &quot;Snared by chain whip&quot;));</span>
                } else {
<span class="nc" id="L17121">                    r = new Report(2357);</span>
<span class="nc" id="L17122">                    r.subject = ae.getId();</span>
<span class="nc" id="L17123">                    r.newlines = 0;</span>
<span class="nc" id="L17124">                    addReport(r);</span>
                }
<span class="nc bnc" id="L17126" title="All 2 branches missed.">            } else if (mightGrapple) {</span>
<span class="nc" id="L17127">                GrappleAttackAction gaa = new GrappleAttackAction(ae.getId(), te.getId());</span>
                int grappleSide;
<span class="nc bnc" id="L17129" title="All 2 branches missed.">                if (caa.getClub().getLocation() == Mech.LOC_RARM) {</span>
<span class="nc" id="L17130">                    grappleSide = Entity.GRAPPLE_RIGHT;</span>
                } else {
<span class="nc" id="L17132">                    grappleSide = Entity.GRAPPLE_LEFT;</span>
                }
<span class="nc" id="L17134">                ToHitData grappleHit = GrappleAttackAction.toHit(game, ae.getId(), target,</span>
                        grappleSide, true);
<span class="nc" id="L17136">                PhysicalResult grappleResult = new PhysicalResult();</span>
<span class="nc" id="L17137">                grappleResult.aaa = gaa;</span>
<span class="nc" id="L17138">                grappleResult.toHit = grappleHit;</span>
<span class="nc" id="L17139">                grappleResult.roll = Compute.d6(2);</span>
<span class="nc" id="L17140">                resolveGrappleAttack(grappleResult, lastEntityId, grappleSide,</span>
<span class="nc bnc" id="L17141" title="All 2 branches missed.">                        hit.getLocation() == Mech.LOC_RARM ? Entity.GRAPPLE_RIGHT : Entity.GRAPPLE_LEFT);</span>
            }
        }

<span class="nc" id="L17145">        addNewLines();</span>

<span class="nc bnc" id="L17147" title="All 2 branches missed.">        if (caa.getClub().getType().hasSubType(MiscType.S_TREE_CLUB)) {</span>
            // the club breaks
<span class="nc" id="L17149">            r = new Report(4150);</span>
<span class="nc" id="L17150">            r.subject = ae.getId();</span>
<span class="nc" id="L17151">            r.add(caa.getClub().getName());</span>
<span class="nc" id="L17152">            addReport(r);</span>
<span class="nc" id="L17153">            ae.removeMisc(caa.getClub().getName());</span>
        }

<span class="nc bnc" id="L17156" title="All 2 branches missed.">        if(caa.isZweihandering()) {</span>
<span class="nc" id="L17157">            ArrayList&lt;Integer&gt; criticalLocs = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L17158">            criticalLocs.add(caa.getClub().getLocation());</span>
<span class="nc" id="L17159">            applyZweihanderSelfDamage(ae, false, criticalLocs);</span>
<span class="nc bnc" id="L17160" title="All 2 branches missed.">            if (caa.getClub().getType().hasSubType(MiscType.S_CLUB)) {</span>
                // the club breaks
<span class="nc" id="L17162">                r = new Report(4150);</span>
<span class="nc" id="L17163">                r.subject = ae.getId();</span>
<span class="nc" id="L17164">                r.add(caa.getClub().getName());</span>
<span class="nc" id="L17165">                addReport(r);</span>
<span class="nc" id="L17166">                ae.removeMisc(caa.getClub().getName());</span>
            }
        }

<span class="nc" id="L17170">        addNewLines();</span>

        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L17174" title="All 4 branches missed.">        if ((target instanceof Mech) &amp;&amp; ((Mech) target).isIndustrial()) {</span>
<span class="nc" id="L17175">            ((Mech) target).setCheckForCrit(true);</span>
        }
<span class="nc" id="L17177">    }</span>

    /**
     * Handle a push attack
     */
    private void resolvePushAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L17183">        final PushAttackAction paa = (PushAttackAction) pr.aaa;</span>
<span class="nc" id="L17184">        final Entity ae = game.getEntity(paa.getEntityId());</span>
        // PLEASE NOTE: buildings are *never* the target of a &quot;push&quot;.
<span class="nc" id="L17186">        final Entity te = game.getEntity(paa.getTargetId());</span>
        // get roll and ToHitData from the PhysicalResult
<span class="nc" id="L17188">        int roll = pr.roll;</span>
<span class="nc" id="L17189">        final ToHitData toHit = pr.toHit;</span>
        Report r;

        // was this push resolved earlier?
<span class="nc bnc" id="L17193" title="All 2 branches missed.">        if (pr.pushBackResolved) {</span>
<span class="nc" id="L17194">            return;</span>
        }
        // don't try this one again
<span class="nc" id="L17197">        pr.pushBackResolved = true;</span>

<span class="nc bnc" id="L17199" title="All 2 branches missed.">        if (lastEntityId != paa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L17201">            r = new Report(4005);</span>
<span class="nc" id="L17202">            r.subject = ae.getId();</span>
<span class="nc" id="L17203">            r.addDesc(ae);</span>
<span class="nc" id="L17204">            addReport(r);</span>
        }

<span class="nc" id="L17207">        r = new Report(4155);</span>
<span class="nc" id="L17208">        r.subject = ae.getId();</span>
<span class="nc" id="L17209">        r.indent();</span>
<span class="nc" id="L17210">        r.addDesc(te);</span>
<span class="nc" id="L17211">        r.newlines = 0;</span>
<span class="nc" id="L17212">        addReport(r);</span>

<span class="nc bnc" id="L17214" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L17215">            r = new Report(4160);</span>
<span class="nc" id="L17216">            r.subject = ae.getId();</span>
<span class="nc" id="L17217">            r.add(toHit.getDesc());</span>
<span class="nc" id="L17218">            addReport(r);</span>
<span class="nc" id="L17219">            return;</span>
        }

        // report the roll
<span class="nc" id="L17223">        r = new Report(4025);</span>
<span class="nc" id="L17224">        r.subject = ae.getId();</span>
<span class="nc" id="L17225">        r.add(toHit.getValue());</span>
<span class="nc" id="L17226">        r.add(roll);</span>
<span class="nc" id="L17227">        r.newlines = 0;</span>
<span class="nc" id="L17228">        addReport(r);</span>

        // check if our target has a push against us, too, and get it
<span class="nc" id="L17231">        PhysicalResult targetPushResult = null;</span>
<span class="nc bnc" id="L17232" title="All 2 branches missed.">        for (PhysicalResult tpr : physicalResults) {</span>
<span class="nc bnc" id="L17233" title="All 4 branches missed.">            if ((tpr.aaa.getEntityId() == te.getId()) &amp;&amp; (tpr.aaa instanceof PushAttackAction)</span>
<span class="nc bnc" id="L17234" title="All 2 branches missed.">                    &amp;&amp; (tpr.aaa.getTargetId() == ae.getId())) {</span>
<span class="nc" id="L17235">                targetPushResult = tpr;</span>
            }
<span class="nc" id="L17237">        }</span>
        // if our target has a push against us,
        // and we are hitting, we need to resolve both now
<span class="nc bnc" id="L17240" title="All 4 branches missed.">        if ((targetPushResult != null) &amp;&amp; !targetPushResult.pushBackResolved</span>
<span class="nc bnc" id="L17241" title="All 2 branches missed.">            &amp;&amp; (roll &gt;= toHit.getValue())) {</span>
<span class="nc" id="L17242">            targetPushResult.pushBackResolved = true;</span>
            // do they hit?
<span class="nc bnc" id="L17244" title="All 2 branches missed.">            if (targetPushResult.roll &gt;= targetPushResult.toHit.getValue()) {</span>
<span class="nc" id="L17245">                r = new Report(4165);</span>
<span class="nc" id="L17246">                r.subject = ae.getId();</span>
<span class="nc" id="L17247">                r.addDesc(te);</span>
<span class="nc" id="L17248">                r.addDesc(te);</span>
<span class="nc" id="L17249">                r.addDesc(ae);</span>
<span class="nc" id="L17250">                r.add(targetPushResult.toHit.getValue());</span>
<span class="nc" id="L17251">                r.add(targetPushResult.roll);</span>
<span class="nc" id="L17252">                r.addDesc(ae);</span>
<span class="nc" id="L17253">                addReport(r);</span>
<span class="nc bnc" id="L17254" title="All 2 branches missed.">                if (ae.canFall()) {</span>
<span class="nc" id="L17255">                    PilotingRollData pushPRD = getKickPushPSR(ae, ae, te, &quot;was pushed&quot;);</span>
<span class="nc" id="L17256">                    game.addPSR(pushPRD);</span>
<span class="nc bnc" id="L17257" title="All 4 branches missed.">                } else if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L17258">                    game.addControlRoll(getKickPushPSR(ae, ae, te, &quot;was pushed&quot;));</span>
                }
<span class="nc bnc" id="L17260" title="All 2 branches missed.">                if (te.canFall()) {</span>
<span class="nc" id="L17261">                    PilotingRollData targetPushPRD = getKickPushPSR(te, ae, te, &quot;was pushed&quot;);</span>
<span class="nc" id="L17262">                    game.addPSR(targetPushPRD);</span>
<span class="nc bnc" id="L17263" title="All 4 branches missed.">                } else if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L17264">                    game.addControlRoll(getKickPushPSR(te, ae, te, &quot;was pushed&quot;));</span>
                }
<span class="nc" id="L17266">                return;</span>
            }
            // report the miss
<span class="nc" id="L17269">            r = new Report(4166);</span>
<span class="nc" id="L17270">            r.subject = ae.getId();</span>
<span class="nc" id="L17271">            r.addDesc(te);</span>
<span class="nc" id="L17272">            r.addDesc(ae);</span>
<span class="nc" id="L17273">            r.add(targetPushResult.toHit.getValue());</span>
<span class="nc" id="L17274">            r.add(targetPushResult.roll);</span>
<span class="nc" id="L17275">            addReport(r);</span>
        }

        // do we hit?
<span class="nc bnc" id="L17279" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L17281">            r = new Report(4035);</span>
<span class="nc" id="L17282">            r.subject = ae.getId();</span>
<span class="nc" id="L17283">            addReport(r);</span>
<span class="nc" id="L17284">            return;</span>
        }

        // we hit...
<span class="nc" id="L17288">        int direction = ae.getFacing();</span>

<span class="nc" id="L17290">        Coords src = te.getPosition();</span>
<span class="nc" id="L17291">        Coords dest = src.translated(direction);</span>

<span class="nc" id="L17293">        PilotingRollData pushPRD = getKickPushPSR(te, ae, te, &quot;was pushed&quot;);</span>

<span class="nc bnc" id="L17295" title="All 2 branches missed.">        if (Compute.isValidDisplacement(game, te.getId(), te.getPosition(), direction)) {</span>
<span class="nc" id="L17296">            r = new Report(4170);</span>
<span class="nc" id="L17297">            r.subject = ae.getId();</span>
<span class="nc" id="L17298">            r.newlines = 0;</span>
<span class="nc" id="L17299">            addReport(r);</span>
<span class="nc bnc" id="L17300" title="All 2 branches missed.">            if (game.getBoard().contains(dest)) {</span>
<span class="nc" id="L17301">                r = new Report(4175);</span>
<span class="nc" id="L17302">                r.subject = ae.getId();</span>
<span class="nc" id="L17303">                r.add(dest.getBoardNum(), true);</span>
            } else {
                // uh-oh, pushed off board
<span class="nc" id="L17306">                r = new Report(4180);</span>
<span class="nc" id="L17307">                r.subject = ae.getId();</span>
            }
<span class="nc" id="L17309">            addReport(r);</span>

<span class="nc" id="L17311">            addReport(doEntityDisplacement(te, src, dest, pushPRD));</span>

            // if push actually moved the target, attacker follows through
<span class="nc bnc" id="L17314" title="All 2 branches missed.">            if (!te.getPosition().equals(src)) {</span>
<span class="nc" id="L17315">                ae.setPosition(src);</span>
            }
        } else {
            // target immovable
<span class="nc" id="L17319">            r = new Report(4185);</span>
<span class="nc" id="L17320">            r.subject = ae.getId();</span>
<span class="nc" id="L17321">            addReport(r);</span>
<span class="nc bnc" id="L17322" title="All 2 branches missed.">            if (te.canFall()) {</span>
<span class="nc" id="L17323">                game.addPSR(pushPRD);</span>
            }
        }

        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L17329" title="All 4 branches missed.">        if ((te instanceof Mech) &amp;&amp; ((Mech) te).isIndustrial()) {</span>
<span class="nc" id="L17330">            ((Mech) te).setCheckForCrit(true);</span>
        }

<span class="nc" id="L17333">        checkForSpikes(te, ae.rollHitLocation(ToHitData.HIT_PUNCH, Compute.targetSideTable(ae, te)).getLocation(),</span>
                0, ae, Mech.LOC_LARM, Mech.LOC_RARM);

<span class="nc" id="L17336">        addNewLines();</span>
<span class="nc" id="L17337">    }</span>

    /**
     * Handle a trip attack
     */
    private void resolveTripAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L17343">        final TripAttackAction paa = (TripAttackAction) pr.aaa;</span>
<span class="nc" id="L17344">        final Entity ae = game.getEntity(paa.getEntityId());</span>
        // PLEASE NOTE: buildings are *never* the target of a &quot;trip&quot;.
<span class="nc" id="L17346">        final Entity te = game.getEntity(paa.getTargetId());</span>
        // get roll and ToHitData from the PhysicalResult
<span class="nc" id="L17348">        int roll = pr.roll;</span>
<span class="nc" id="L17349">        final ToHitData toHit = pr.toHit;</span>
        Report r;

<span class="nc bnc" id="L17352" title="All 2 branches missed.">        if (lastEntityId != paa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L17354">            r = new Report(4005);</span>
<span class="nc" id="L17355">            r.subject = ae.getId();</span>
<span class="nc" id="L17356">            r.addDesc(ae);</span>
<span class="nc" id="L17357">            addReport(r);</span>
        }

<span class="nc" id="L17360">        r = new Report(4280);</span>
<span class="nc" id="L17361">        r.subject = ae.getId();</span>
<span class="nc" id="L17362">        r.indent();</span>
<span class="nc" id="L17363">        r.addDesc(te);</span>
<span class="nc" id="L17364">        r.newlines = 0;</span>
<span class="nc" id="L17365">        addReport(r);</span>

<span class="nc bnc" id="L17367" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L17368">            r = new Report(4285);</span>
<span class="nc" id="L17369">            r.subject = ae.getId();</span>
<span class="nc" id="L17370">            r.add(toHit.getDesc());</span>
<span class="nc" id="L17371">            addReport(r);</span>
<span class="nc" id="L17372">            return;</span>
        }

        // report the roll
<span class="nc" id="L17376">        r = new Report(4025);</span>
<span class="nc" id="L17377">        r.subject = ae.getId();</span>
<span class="nc" id="L17378">        r.add(toHit.getValue());</span>
<span class="nc" id="L17379">        r.add(roll);</span>
<span class="nc" id="L17380">        r.newlines = 0;</span>
<span class="nc" id="L17381">        addReport(r);</span>

        // do we hit?
<span class="nc bnc" id="L17384" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L17386">            r = new Report(4035);</span>
<span class="nc" id="L17387">            r.subject = ae.getId();</span>
<span class="nc" id="L17388">            addReport(r);</span>
<span class="nc" id="L17389">            return;</span>
        }

        // we hit...
<span class="nc bnc" id="L17393" title="All 2 branches missed.">        if (te.canFall()) {</span>
<span class="nc" id="L17394">            PilotingRollData pushPRD = getKickPushPSR(te, ae, te, &quot;was tripped&quot;);</span>
<span class="nc" id="L17395">            game.addPSR(pushPRD);</span>
        }

<span class="nc" id="L17398">        r = new Report(4040);</span>
<span class="nc" id="L17399">        r.subject = ae.getId();</span>
<span class="nc" id="L17400">        addReport(r);</span>
<span class="nc" id="L17401">        addNewLines();</span>
        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L17404" title="All 4 branches missed.">        if ((te instanceof Mech) &amp;&amp; ((Mech) te).isIndustrial()) {</span>
<span class="nc" id="L17405">            ((Mech) te).setCheckForCrit(true);</span>
        }
<span class="nc" id="L17407">    }</span>

    /**
     * Handle a grapple attack
     */
    private void resolveGrappleAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L17413">        resolveGrappleAttack(pr, lastEntityId, Entity.GRAPPLE_BOTH,</span>
                Entity.GRAPPLE_BOTH);
<span class="nc" id="L17415">    }</span>

    /**
     * Resolves a grapple attack.
     *
     * @param pr            the result of a physical attack - this one specifically being a grapple
     * @param lastEntityId  the entity making the attack
     * @param aeGrappleSide
     *            The side that the attacker is grappling with. For normal
     *            grapples this will be both, for chain whip grapples this will
     *            be the arm with the chain whip in it.
     * @param teGrappleSide
     *            The that the the target is grappling with. For normal grapples
     *            this will be both, for chain whip grapples this will be the
     *            arm that is being whipped.
     */
    private void resolveGrappleAttack(PhysicalResult pr, int lastEntityId,
                                      int aeGrappleSide, int teGrappleSide) {
<span class="nc" id="L17433">        final GrappleAttackAction paa = (GrappleAttackAction) pr.aaa;</span>
<span class="nc" id="L17434">        final Entity ae = game.getEntity(paa.getEntityId());</span>
        // PLEASE NOTE: buildings are *never* the target of a &quot;push&quot;.
<span class="nc" id="L17436">        final Entity te = game.getEntity(paa.getTargetId());</span>
        // get roll and ToHitData from the PhysicalResult
<span class="nc" id="L17438">        int roll = pr.roll;</span>
<span class="nc" id="L17439">        final ToHitData toHit = pr.toHit;</span>
        Report r;

        // same method as push, for counterattacks
<span class="nc bnc" id="L17443" title="All 2 branches missed.">        if (pr.pushBackResolved) {</span>
<span class="nc" id="L17444">            return;</span>
        }

<span class="nc bnc" id="L17447" title="All 2 branches missed.">        if ((te.getGrappled() != Entity.NONE)</span>
<span class="nc bnc" id="L17448" title="All 2 branches missed.">            || (ae.getGrappled() != Entity.NONE)) {</span>
<span class="nc" id="L17449">            toHit.addModifier(TargetRoll.IMPOSSIBLE, &quot;Already Grappled&quot;);</span>
        }

<span class="nc bnc" id="L17452" title="All 2 branches missed.">        if (lastEntityId != paa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L17454">            r = new Report(4005);</span>
<span class="nc" id="L17455">            r.subject = ae.getId();</span>
<span class="nc" id="L17456">            r.addDesc(ae);</span>
<span class="nc" id="L17457">            addReport(r);</span>
        }

<span class="nc" id="L17460">        r = new Report(4295);</span>
<span class="nc" id="L17461">        r.subject = ae.getId();</span>
<span class="nc" id="L17462">        r.indent();</span>
<span class="nc" id="L17463">        r.addDesc(te);</span>
<span class="nc" id="L17464">        r.newlines = 0;</span>
<span class="nc" id="L17465">        addReport(r);</span>

<span class="nc bnc" id="L17467" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L17468">            r = new Report(4300);</span>
<span class="nc" id="L17469">            r.subject = ae.getId();</span>
<span class="nc" id="L17470">            r.add(toHit.getDesc());</span>
<span class="nc" id="L17471">            addReport(r);</span>
<span class="nc" id="L17472">            return;</span>
        }

        // report the roll
<span class="nc" id="L17476">        r = new Report(4025);</span>
<span class="nc" id="L17477">        r.subject = ae.getId();</span>
<span class="nc" id="L17478">        r.add(toHit.getValue());</span>
<span class="nc" id="L17479">        r.add(roll);</span>
<span class="nc" id="L17480">        r.newlines = 0;</span>
<span class="nc" id="L17481">        addReport(r);</span>

        // do we hit?
<span class="nc bnc" id="L17484" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L17486">            r = new Report(4035);</span>
<span class="nc" id="L17487">            r.subject = ae.getId();</span>
<span class="nc" id="L17488">            addReport(r);</span>
<span class="nc" id="L17489">            return;</span>
        }

        // we hit...
<span class="nc" id="L17493">        ae.setGrappled(te.getId(), true);</span>
<span class="nc" id="L17494">        te.setGrappled(ae.getId(), false);</span>
<span class="nc" id="L17495">        ae.setGrappledThisRound(true);</span>
<span class="nc" id="L17496">        te.setGrappledThisRound(true);</span>
        // For normal grapples, AE moves into targets hex.
<span class="nc bnc" id="L17498" title="All 2 branches missed.">        if (aeGrappleSide == Entity.GRAPPLE_BOTH) {</span>
<span class="nc" id="L17499">            Coords pos = te.getPosition();</span>
<span class="nc" id="L17500">            ae.setPosition(pos);</span>
<span class="nc" id="L17501">            ae.setElevation(te.getElevation());</span>
<span class="nc" id="L17502">            te.setFacing((ae.getFacing() + 3) % 6);</span>
<span class="nc" id="L17503">            addReport(doSetLocationsExposure(ae, game.getBoard().getHex(pos),</span>
<span class="nc" id="L17504">                    false, ae.getElevation()));</span>
        }

<span class="nc" id="L17507">        ae.setGrappleSide(aeGrappleSide);</span>
<span class="nc" id="L17508">        te.setGrappleSide(teGrappleSide);</span>

<span class="nc" id="L17510">        r = new Report(4040);</span>
<span class="nc" id="L17511">        r.subject = ae.getId();</span>
<span class="nc" id="L17512">        addReport(r);</span>
<span class="nc" id="L17513">        addNewLines();</span>

        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L17517" title="All 4 branches missed.">        if ((te instanceof Mech) &amp;&amp; ((Mech) te).isIndustrial()) {</span>
<span class="nc" id="L17518">            ((Mech) te).setCheckForCrit(true);</span>
        }
<span class="nc" id="L17520">    }</span>

    /**
     * Handle a break grapple attack
     */
    private void resolveBreakGrappleAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L17526">        final BreakGrappleAttackAction paa = (BreakGrappleAttackAction) pr.aaa;</span>
<span class="nc" id="L17527">        final Entity ae = game.getEntity(paa.getEntityId());</span>
        // PLEASE NOTE: buildings are *never* the target of a &quot;push&quot;.
<span class="nc" id="L17529">        final Entity te = game.getEntity(paa.getTargetId());</span>
        // get roll and ToHitData from the PhysicalResult
<span class="nc" id="L17531">        int roll = pr.roll;</span>
<span class="nc" id="L17532">        final ToHitData toHit = pr.toHit;</span>
        Report r;

<span class="nc bnc" id="L17535" title="All 2 branches missed.">        if (lastEntityId != paa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L17537">            r = new Report(4005);</span>
<span class="nc" id="L17538">            r.subject = ae.getId();</span>
<span class="nc" id="L17539">            r.addDesc(ae);</span>
<span class="nc" id="L17540">            addReport(r);</span>
        }

<span class="nc" id="L17543">        r = new Report(4305);</span>
<span class="nc" id="L17544">        r.subject = ae.getId();</span>
<span class="nc" id="L17545">        r.indent();</span>
<span class="nc" id="L17546">        r.addDesc(te);</span>
<span class="nc" id="L17547">        r.newlines = 0;</span>
<span class="nc" id="L17548">        addReport(r);</span>

<span class="nc bnc" id="L17550" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L17551">            r = new Report(4310);</span>
<span class="nc" id="L17552">            r.subject = ae.getId();</span>
<span class="nc" id="L17553">            r.add(toHit.getDesc());</span>
<span class="nc" id="L17554">            addReport(r);</span>
<span class="nc bnc" id="L17555" title="All 4 branches missed.">            if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L17556">                game.addControlRoll(new PilotingRollData(ae.getId(), 0, &quot;missed a physical attack&quot;));</span>
            }
<span class="nc" id="L17558">            return;</span>
        }

<span class="nc bnc" id="L17561" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L17562">            r = new Report(4320);</span>
<span class="nc" id="L17563">            r.subject = ae.getId();</span>
<span class="nc" id="L17564">            r.add(toHit.getDesc());</span>
        } else {
            // report the roll
<span class="nc" id="L17567">            r = new Report(4025);</span>
<span class="nc" id="L17568">            r.subject = ae.getId();</span>
<span class="nc" id="L17569">            r.add(toHit.getValue());</span>
<span class="nc" id="L17570">            r.add(roll);</span>
<span class="nc" id="L17571">            r.newlines = 0;</span>
<span class="nc" id="L17572">            addReport(r);</span>

            // do we hit?
<span class="nc bnc" id="L17575" title="All 2 branches missed.">            if (roll &lt; toHit.getValue()) {</span>
                // miss
<span class="nc" id="L17577">                r = new Report(4035);</span>
<span class="nc" id="L17578">                r.subject = ae.getId();</span>
<span class="nc" id="L17579">                addReport(r);</span>
<span class="nc bnc" id="L17580" title="All 4 branches missed.">                if (ae instanceof LandAirMech &amp;&amp; ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L17581">                    game.addControlRoll(new PilotingRollData(ae.getId(), 0, &quot;missed a physical attack&quot;));</span>
                }
<span class="nc" id="L17583">                return;</span>
            }

            // hit
<span class="nc" id="L17587">            r = new Report(4040);</span>
<span class="nc" id="L17588">            r.subject = ae.getId();</span>
        }
<span class="nc" id="L17590">        addReport(r);</span>

        // is there a counterattack?
<span class="nc" id="L17593">        PhysicalResult targetGrappleResult = null;</span>
<span class="nc bnc" id="L17594" title="All 2 branches missed.">        for (PhysicalResult tpr : physicalResults) {</span>
<span class="nc bnc" id="L17595" title="All 4 branches missed.">            if ((tpr.aaa.getEntityId() == te.getId())</span>
                &amp;&amp; (tpr.aaa instanceof GrappleAttackAction)
<span class="nc bnc" id="L17597" title="All 2 branches missed.">                &amp;&amp; (tpr.aaa.getTargetId() == ae.getId())) {</span>
<span class="nc" id="L17598">                targetGrappleResult = tpr;</span>
<span class="nc" id="L17599">                break;</span>
            }
<span class="nc" id="L17601">        }</span>

<span class="nc bnc" id="L17603" title="All 2 branches missed.">        if (targetGrappleResult != null) {</span>
<span class="nc" id="L17604">            targetGrappleResult.pushBackResolved = true;</span>
            // counterattack
<span class="nc" id="L17606">            r = new Report(4315);</span>
<span class="nc" id="L17607">            r.subject = te.getId();</span>
<span class="nc" id="L17608">            r.newlines = 0;</span>
<span class="nc" id="L17609">            r.addDesc(te);</span>
<span class="nc" id="L17610">            addReport(r);</span>

            // report the roll
<span class="nc" id="L17613">            r = new Report(4025);</span>
<span class="nc" id="L17614">            r.subject = te.getId();</span>
<span class="nc" id="L17615">            r.add(targetGrappleResult.toHit.getValue());</span>
<span class="nc" id="L17616">            r.add(targetGrappleResult.roll);</span>
<span class="nc" id="L17617">            r.newlines = 0;</span>
<span class="nc" id="L17618">            addReport(r);</span>

            // do we hit?
<span class="nc bnc" id="L17621" title="All 2 branches missed.">            if (roll &lt; toHit.getValue()) {</span>
                // miss
<span class="nc" id="L17623">                r = new Report(4035);</span>
<span class="nc" id="L17624">                r.subject = ae.getId();</span>
<span class="nc" id="L17625">                addReport(r);</span>
            } else {
                // hit
<span class="nc" id="L17628">                r = new Report(4040);</span>
<span class="nc" id="L17629">                r.subject = ae.getId();</span>
<span class="nc" id="L17630">                addReport(r);</span>

                // exchange attacker and defender
<span class="nc" id="L17633">                ae.setGrappled(te.getId(), false);</span>
<span class="nc" id="L17634">                te.setGrappled(ae.getId(), true);</span>

<span class="nc" id="L17636">                return;</span>
            }
        }

        // score the adjacent hexes
<span class="nc" id="L17641">        Coords[] hexes = new Coords[6];</span>
<span class="nc" id="L17642">        int[] scores = new int[6];</span>

<span class="nc" id="L17644">        IHex curHex = game.getBoard().getHex(ae.getPosition());</span>
<span class="nc bnc" id="L17645" title="All 2 branches missed.">        for (int i = 0; i &lt; 6; i++) {</span>
<span class="nc" id="L17646">            hexes[i] = ae.getPosition().translated(i);</span>
<span class="nc" id="L17647">            scores[i] = 0;</span>
<span class="nc" id="L17648">            IHex hex = game.getBoard().getHex(hexes[i]);</span>
<span class="nc bnc" id="L17649" title="All 2 branches missed.">            if (hex.containsTerrain(Terrains.MAGMA)) {</span>
<span class="nc" id="L17650">                scores[i] += 10;</span>
            }
<span class="nc bnc" id="L17652" title="All 2 branches missed.">            if (hex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L17653">                scores[i] += hex.terrainLevel(Terrains.WATER);</span>
            }
<span class="nc bnc" id="L17655" title="All 2 branches missed.">            if ((curHex.surface() - hex.surface()) &gt;= 2) {</span>
<span class="nc" id="L17656">                scores[i] += 2 * (curHex.surface() - hex.surface());</span>
            }
        }

<span class="nc" id="L17660">        int bestScore = 99999;</span>
<span class="nc" id="L17661">        int best = 0;</span>
<span class="nc" id="L17662">        int worstScore = -99999;</span>
<span class="nc" id="L17663">        int worst = 0;</span>

<span class="nc bnc" id="L17665" title="All 2 branches missed.">        for (int i = 0; i &lt; 6; i++) {</span>
<span class="nc bnc" id="L17666" title="All 2 branches missed.">            if (bestScore &gt; scores[i]) {</span>
<span class="nc" id="L17667">                best = i;</span>
<span class="nc" id="L17668">                bestScore = scores[i];</span>
            }
<span class="nc bnc" id="L17670" title="All 2 branches missed.">            if (worstScore &lt; scores[i]) {</span>
<span class="nc" id="L17671">                worst = i;</span>
<span class="nc" id="L17672">                worstScore = scores[i];</span>
            }
        }

        // attacker doesn't fall, unless off a cliff
<span class="nc bnc" id="L17677" title="All 2 branches missed.">        if (ae.isGrappleAttacker()) {</span>
            // move self to least dangerous hex
<span class="nc" id="L17679">            PilotingRollData psr = ae.getBasePilotingRoll();</span>
<span class="nc" id="L17680">            psr.addModifier(TargetRoll.AUTOMATIC_SUCCESS, &quot;break grapple&quot;);</span>
<span class="nc" id="L17681">            addReport(doEntityDisplacement(ae, ae.getPosition(), hexes[best], psr));</span>
<span class="nc" id="L17682">            ae.setFacing(hexes[best].direction(te.getPosition()));</span>
<span class="nc" id="L17683">        } else {</span>
            // move enemy to most dangerous hex
<span class="nc" id="L17685">            PilotingRollData psr = te.getBasePilotingRoll();</span>
<span class="nc" id="L17686">            psr.addModifier(TargetRoll.AUTOMATIC_SUCCESS, &quot;break grapple&quot;);</span>
<span class="nc" id="L17687">            addReport(doEntityDisplacement(te, te.getPosition(), hexes[worst], psr));</span>
<span class="nc" id="L17688">            te.setFacing(hexes[worst].direction(ae.getPosition()));</span>
        }

        // grapple is broken
<span class="nc" id="L17692">        ae.setGrappled(Entity.NONE, false);</span>
<span class="nc" id="L17693">        te.setGrappled(Entity.NONE, false);</span>

<span class="nc" id="L17695">        addNewLines();</span>
<span class="nc" id="L17696">    }</span>

    /**
     * Handle a charge attack
     */
    private void resolveChargeAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L17702">        final ChargeAttackAction caa = (ChargeAttackAction) pr.aaa;</span>
<span class="nc" id="L17703">        final Entity ae = game.getEntity(caa.getEntityId());</span>
<span class="nc" id="L17704">        final Targetable target = game.getTarget(caa.getTargetType(), caa.getTargetId());</span>
        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L17706">        int damage = pr.damage;</span>
<span class="nc" id="L17707">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L17708">        int roll = pr.roll;</span>

<span class="nc" id="L17710">        Entity te = null;</span>
<span class="nc bnc" id="L17711" title="All 4 branches missed.">        if ((target != null) &amp;&amp; (target.getTargetType() == Targetable.TYPE_ENTITY)) {</span>
<span class="nc" id="L17712">            te = (Entity) target;</span>
        }
<span class="nc" id="L17714">        boolean throughFront = true;</span>
<span class="nc bnc" id="L17715" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L17716">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }
<span class="nc bnc" id="L17718" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L17719" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS) &amp;&amp; (roll == toHit.getValue());</span>

        // Set Margin of Success/Failure.
<span class="nc" id="L17722">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L17723" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L17724" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW) &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        Report r;

        // Which building takes the damage?
<span class="nc" id="L17729">        Building bldg = game.getBoard().getBuildingAt(caa.getTargetPos());</span>

        // is the attacker dead? because that sure messes up the calculations
<span class="nc bnc" id="L17732" title="All 2 branches missed.">        if (ae == null) {</span>
<span class="nc" id="L17733">            return;</span>
        }

<span class="nc" id="L17736">        final int direction = ae.getFacing();</span>

        // entity isn't charging any more
<span class="nc" id="L17739">        ae.setDisplacementAttack(null);</span>

<span class="nc bnc" id="L17741" title="All 2 branches missed.">        if (lastEntityId != caa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L17743">            r = new Report(4005);</span>
<span class="nc" id="L17744">            r.subject = ae.getId();</span>
<span class="nc" id="L17745">            r.addDesc(ae);</span>
<span class="nc" id="L17746">            addReport(r);</span>
        }

        // should we even bother?
<span class="nc bnc" id="L17750" title="All 4 branches missed.">        if ((target == null) || ((target.getTargetType() == Targetable.TYPE_ENTITY)</span>
<span class="nc bnc" id="L17751" title="All 6 branches missed.">                &amp;&amp; (te.isDestroyed() || te.isDoomed() || te.getCrew().isDead()))) {</span>
<span class="nc" id="L17752">            r = new Report(4190);</span>
<span class="nc" id="L17753">            r.subject = ae.getId();</span>
<span class="nc" id="L17754">            r.indent();</span>
<span class="nc" id="L17755">            addReport(r);</span>
            // doEntityDisplacement(ae, ae.getPosition(), caa.getTargetPos(),
            // null);
            // Randall said that if a charge fails because of target
            // destruction,
            // the attacker stays in the hex he was in at the end of the
            // movement phase
            // See Bug 912094
<span class="nc" id="L17763">            return;</span>
        }

        // attacker fell down?
<span class="nc bnc" id="L17767" title="All 2 branches missed.">        if (ae.isProne()) {</span>
<span class="nc" id="L17768">            r = new Report(4195);</span>
<span class="nc" id="L17769">            r.subject = ae.getId();</span>
<span class="nc" id="L17770">            r.indent();</span>
<span class="nc" id="L17771">            addReport(r);</span>
<span class="nc" id="L17772">            return;</span>
        }

        // attacker immobile?
<span class="nc bnc" id="L17776" title="All 2 branches missed.">        if (ae.isImmobile()) {</span>
<span class="nc" id="L17777">            r = new Report(4200);</span>
<span class="nc" id="L17778">            r.subject = ae.getId();</span>
<span class="nc" id="L17779">            r.indent();</span>
<span class="nc" id="L17780">            addReport(r);</span>
<span class="nc" id="L17781">            return;</span>
        }

        // target fell down, only for attacking Mechs, though
<span class="nc bnc" id="L17785" title="All 6 branches missed.">        if ((te != null) &amp;&amp; (te.isProne()) &amp;&amp; (ae instanceof Mech)) {</span>
<span class="nc" id="L17786">            r = new Report(4205);</span>
<span class="nc" id="L17787">            r.subject = ae.getId();</span>
<span class="nc" id="L17788">            r.indent();</span>
<span class="nc" id="L17789">            addReport(r);</span>
<span class="nc" id="L17790">            return;</span>
        }

<span class="nc" id="L17793">        r = new Report(4210);</span>
<span class="nc" id="L17794">        r.subject = ae.getId();</span>
<span class="nc" id="L17795">        r.indent();</span>
<span class="nc" id="L17796">        r.add(target.getDisplayName());</span>
<span class="nc" id="L17797">        r.newlines = 0;</span>
<span class="nc" id="L17798">        addReport(r);</span>

        // target still in the same position?
<span class="nc bnc" id="L17801" title="All 2 branches missed.">        if (!target.getPosition().equals(caa.getTargetPos())) {</span>
<span class="nc" id="L17802">            r = new Report(4215);</span>
<span class="nc" id="L17803">            r.subject = ae.getId();</span>
<span class="nc" id="L17804">            addReport(r);</span>
<span class="nc" id="L17805">            addReport(doEntityDisplacement(ae, ae.getPosition(), caa.getTargetPos(), null));</span>
<span class="nc" id="L17806">            return;</span>
        }

        // if the attacker's prone, fudge the roll
<span class="nc bnc" id="L17810" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L17811">            roll = -12;</span>
<span class="nc" id="L17812">            r = new Report(4220);</span>
<span class="nc" id="L17813">            r.subject = ae.getId();</span>
<span class="nc" id="L17814">            r.add(toHit.getDesc());</span>
<span class="nc" id="L17815">            addReport(r);</span>
<span class="nc bnc" id="L17816" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L17817">            roll = Integer.MAX_VALUE;</span>
<span class="nc" id="L17818">            r = new Report(4225);</span>
<span class="nc" id="L17819">            r.subject = ae.getId();</span>
<span class="nc" id="L17820">            r.add(toHit.getDesc());</span>
<span class="nc" id="L17821">            addReport(r);</span>
        } else {
            // report the roll
<span class="nc" id="L17824">            r = new Report(4025);</span>
<span class="nc" id="L17825">            r.subject = ae.getId();</span>
<span class="nc" id="L17826">            r.add(toHit.getValue());</span>
<span class="nc" id="L17827">            r.add(roll);</span>
<span class="nc" id="L17828">            addReport(r);</span>
<span class="nc bnc" id="L17829" title="All 2 branches missed.">            if (glancing) {</span>
<span class="nc" id="L17830">                r = new Report(3186);</span>
<span class="nc" id="L17831">                r.subject = ae.getId();</span>
<span class="nc" id="L17832">                addReport(r);</span>
            }
<span class="nc bnc" id="L17834" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L17835">                r = new Report(3189);</span>
<span class="nc" id="L17836">                r.subject = ae.getId();</span>
<span class="nc" id="L17837">                addReport(r);</span>
            }
        }

        // do we hit?
<span class="nc bnc" id="L17842" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
<span class="nc" id="L17843">            Coords src = ae.getPosition();</span>
<span class="nc" id="L17844">            Coords dest = Compute.getMissedChargeDisplacement(game, ae.getId(), src, direction);</span>

            // TODO : handle movement into/out of/through a building. Do it here?

            // miss
<span class="nc" id="L17849">            r = new Report(4035);</span>
<span class="nc" id="L17850">            r.subject = ae.getId();</span>
<span class="nc" id="L17851">            addReport(r);</span>
            // move attacker to side hex
<span class="nc" id="L17853">            addReport(doEntityDisplacement(ae, src, dest, null));</span>
<span class="nc bnc" id="L17854" title="All 2 branches missed.">        } else if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L17855" title="All 2 branches missed.">                   || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) { // Targeting</span>
            // a building.
            // The building takes the full brunt of the attack.
<span class="nc" id="L17858">            r = new Report(4040);</span>
<span class="nc" id="L17859">            r.subject = ae.getId();</span>
<span class="nc" id="L17860">            addReport(r);</span>
<span class="nc" id="L17861">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L17862" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L17863">                report.subject = ae.getId();</span>
<span class="nc" id="L17864">            }</span>
<span class="nc" id="L17865">            addReport(buildingReport);</span>

            // Damage any infantry in the hex.
<span class="nc" id="L17868">            addReport(damageInfantryIn(bldg, damage, target.getPosition()));</span>

            // Apply damage to the attacker.
<span class="nc" id="L17871">            int toAttacker = ChargeAttackAction.getDamageTakenBy(ae, bldg, target.getPosition());</span>
<span class="nc" id="L17872">            HitData hit = ae.rollHitLocation(ToHitData.HIT_NORMAL, ae.sideTable(target.getPosition()));</span>
<span class="nc" id="L17873">            hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L17874">            addReport(damageEntity(ae, hit, toAttacker, false, DamageType.NONE,</span>
                                   false, false, throughFront));
<span class="nc" id="L17876">            addNewLines();</span>
<span class="nc" id="L17877">            entityUpdate(ae.getId());</span>

            // TODO : Does the attacker enter the building?
            // TODO : What if the building collapses?
<span class="nc" id="L17881">        } else {</span>
            // Resolve the damage.
<span class="nc" id="L17883">            resolveChargeDamage(ae, te, toHit, direction, glancing, throughFront, false);</span>
        }
<span class="nc" id="L17885">    }</span>

    /**
     * Handle an Airmech ram attack
     */
    private void resolveAirmechRamAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L17891">        final AirmechRamAttackAction caa = (AirmechRamAttackAction) pr.aaa;</span>
<span class="nc" id="L17892">        final Entity ae = game.getEntity(caa.getEntityId());</span>
<span class="nc" id="L17893">        final Targetable target = game.getTarget(caa.getTargetType(), caa.getTargetId());</span>
        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L17895">        int damage = pr.damage;</span>
<span class="nc" id="L17896">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L17897">        int roll = pr.roll;</span>

<span class="nc" id="L17899">        Entity te = null;</span>
<span class="nc bnc" id="L17900" title="All 4 branches missed.">        if ((target != null) &amp;&amp; (target.getTargetType() == Targetable.TYPE_ENTITY)) {</span>
<span class="nc" id="L17901">            te = (Entity) target;</span>
        }
<span class="nc" id="L17903">        boolean throughFront = true;</span>
<span class="nc bnc" id="L17904" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L17905">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }
<span class="nc bnc" id="L17907" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L17908" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS) &amp;&amp; (roll == toHit.getValue());</span>

        // Set Margin of Success/Failure.
<span class="nc" id="L17911">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L17912" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L17913" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW) &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        Report r;

        // Which building takes the damage?
<span class="nc" id="L17918">        Building bldg = game.getBoard().getBuildingAt(caa.getTargetPos());</span>

        // is the attacker dead? because that sure messes up the calculations
<span class="nc bnc" id="L17921" title="All 2 branches missed.">        if (ae == null) {</span>
<span class="nc" id="L17922">            return;</span>
        }

<span class="nc" id="L17925">        final int direction = ae.getFacing();</span>

        // entity isn't charging any more
<span class="nc" id="L17928">        ae.setDisplacementAttack(null);</span>

<span class="nc bnc" id="L17930" title="All 2 branches missed.">        if (lastEntityId != caa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L17932">            r = new Report(4005);</span>
<span class="nc" id="L17933">            r.subject = ae.getId();</span>
<span class="nc" id="L17934">            r.addDesc(ae);</span>
<span class="nc" id="L17935">            addReport(r);</span>
        }

        // should we even bother?
<span class="nc bnc" id="L17939" title="All 4 branches missed.">        if ((target == null) || ((target.getTargetType() == Targetable.TYPE_ENTITY)</span>
<span class="nc bnc" id="L17940" title="All 6 branches missed.">                &amp;&amp; (te.isDestroyed() || te.isDoomed() || te.getCrew().isDead()))) {</span>
<span class="nc" id="L17941">            r = new Report(4192);</span>
<span class="nc" id="L17942">            r.subject = ae.getId();</span>
<span class="nc" id="L17943">            r.indent();</span>
<span class="nc" id="L17944">            addReport(r);</span>
<span class="nc" id="L17945">            game.addControlRoll(new PilotingRollData(</span>
<span class="nc" id="L17946">                    ae.getId(), 0, &quot;missed a ramming attack&quot;));</span>
<span class="nc" id="L17947">            return;</span>
        }

        // attacker landed?
<span class="nc bnc" id="L17951" title="All 2 branches missed.">        if (!ae.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L17952">            r = new Report(4197);</span>
<span class="nc" id="L17953">            r.subject = ae.getId();</span>
<span class="nc" id="L17954">            r.indent();</span>
<span class="nc" id="L17955">            addReport(r);</span>
<span class="nc" id="L17956">            return;</span>
        }

        // attacker immobile?
<span class="nc bnc" id="L17960" title="All 2 branches missed.">        if (ae.isImmobile()) {</span>
<span class="nc" id="L17961">            r = new Report(4202);</span>
<span class="nc" id="L17962">            r.subject = ae.getId();</span>
<span class="nc" id="L17963">            r.indent();</span>
<span class="nc" id="L17964">            addReport(r);</span>
<span class="nc" id="L17965">            return;</span>
        }

<span class="nc" id="L17968">        r = new Report(4212);</span>
<span class="nc" id="L17969">        r.subject = ae.getId();</span>
<span class="nc" id="L17970">        r.indent();</span>
<span class="nc" id="L17971">        r.add(target.getDisplayName());</span>
<span class="nc" id="L17972">        r.newlines = 0;</span>
<span class="nc" id="L17973">        addReport(r);</span>

        // if the attacker's prone, fudge the roll
<span class="nc bnc" id="L17976" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L17977">            roll = -12;</span>
<span class="nc" id="L17978">            r = new Report(4222);</span>
<span class="nc" id="L17979">            r.subject = ae.getId();</span>
<span class="nc" id="L17980">            r.add(toHit.getDesc());</span>
<span class="nc" id="L17981">            addReport(r);</span>
<span class="nc bnc" id="L17982" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L17983">            roll = Integer.MAX_VALUE;</span>
<span class="nc" id="L17984">            r = new Report(4227);</span>
<span class="nc" id="L17985">            r.subject = ae.getId();</span>
<span class="nc" id="L17986">            r.add(toHit.getDesc());</span>
<span class="nc" id="L17987">            addReport(r);</span>
        } else {
            // report the roll
<span class="nc" id="L17990">            r = new Report(4025);</span>
<span class="nc" id="L17991">            r.subject = ae.getId();</span>
<span class="nc" id="L17992">            r.add(toHit.getValue());</span>
<span class="nc" id="L17993">            r.add(roll);</span>
<span class="nc" id="L17994">            addReport(r);</span>
<span class="nc bnc" id="L17995" title="All 2 branches missed.">            if (glancing) {</span>
<span class="nc" id="L17996">                r = new Report(3186);</span>
<span class="nc" id="L17997">                r.subject = ae.getId();</span>
<span class="nc" id="L17998">                addReport(r);</span>
            }
<span class="nc bnc" id="L18000" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L18001">                r = new Report(3189);</span>
<span class="nc" id="L18002">                r.subject = ae.getId();</span>
<span class="nc" id="L18003">                addReport(r);</span>
            }
        }

        // do we hit?
<span class="nc bnc" id="L18008" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L18010">            r = new Report(4035);</span>
<span class="nc" id="L18011">            r.subject = ae.getId();</span>
<span class="nc" id="L18012">            addReport(r);</span>
            // attacker must make a control roll
<span class="nc" id="L18014">            game.addControlRoll(new PilotingRollData(ae.getId(), 0, &quot;missed ramming attack&quot;));</span>
<span class="nc bnc" id="L18015" title="All 2 branches missed.">        } else if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L18016" title="All 2 branches missed.">                   || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) { // Targeting</span>
            // a building.
            // The building takes the full brunt of the attack.
<span class="nc" id="L18019">            r = new Report(4040);</span>
<span class="nc" id="L18020">            r.subject = ae.getId();</span>
<span class="nc" id="L18021">            addReport(r);</span>
<span class="nc" id="L18022">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L18023" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L18024">                report.subject = ae.getId();</span>
<span class="nc" id="L18025">            }</span>
<span class="nc" id="L18026">            addReport(buildingReport);</span>

            // Damage any infantry in the hex.
<span class="nc" id="L18029">            addReport(damageInfantryIn(bldg, damage, target.getPosition()));</span>

            // Apply damage to the attacker.
<span class="nc" id="L18032">            int toAttacker = AirmechRamAttackAction.getDamageTakenBy(ae, target,</span>
                    ae.delta_distance);
<span class="nc" id="L18034">            HitData hit = new HitData(Mech.LOC_CT);</span>
<span class="nc" id="L18035">            hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L18036">            addReport(damageEntity(ae, hit, toAttacker, false, DamageType.NONE,</span>
                                   false, false, throughFront));
<span class="nc" id="L18038">            addNewLines();</span>
<span class="nc" id="L18039">            entityUpdate(ae.getId());</span>

            // TODO : Does the attacker enter the building?
            // TODO : What if the building collapses?
<span class="nc" id="L18043">        } else {</span>
            // Resolve the damage.
<span class="nc" id="L18045">            resolveChargeDamage(ae, te, toHit, direction, glancing, throughFront, true);</span>
        }
<span class="nc" id="L18047">    }</span>

    /**
     * Handle a telemissile attack
     */
    private void resolveTeleMissileAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L18053">        final TeleMissileAttackAction taa = (TeleMissileAttackAction) pr.aaa;</span>
<span class="nc" id="L18054">        final Entity ae = game.getEntity(taa.getEntityId());</span>
<span class="nc bnc" id="L18055" title="All 2 branches missed.">        if (!(ae instanceof TeleMissile)) {</span>
<span class="nc" id="L18056">            return;</span>
        }
<span class="nc" id="L18058">        TeleMissile tm = (TeleMissile) ae;</span>
<span class="nc" id="L18059">        final Targetable target = game.getTarget(taa.getTargetType(), taa.getTargetId());</span>
<span class="nc" id="L18060">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L18061">        int roll = pr.roll;</span>
<span class="nc" id="L18062">        int amsDamage = taa.CounterAVInt;</span>
<span class="nc" id="L18063">        Entity te = null;</span>
<span class="nc bnc" id="L18064" title="All 4 branches missed.">        if ((target != null) &amp;&amp; (target.getTargetType() == Targetable.TYPE_ENTITY)) {</span>
<span class="nc" id="L18065">            te = (Entity) target;</span>
        }

<span class="nc" id="L18068">        boolean throughFront = true;</span>
<span class="nc bnc" id="L18069" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L18070">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }

        Report r;

<span class="nc bnc" id="L18075" title="All 2 branches missed.">        if (lastEntityId != taa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L18077">            r = new Report(4005);</span>
<span class="nc" id="L18078">            r.subject = ae.getId();</span>
<span class="nc" id="L18079">            r.addDesc(ae);</span>
<span class="nc" id="L18080">            addReport(r);</span>
        }

        // should we even bother?
<span class="nc bnc" id="L18084" title="All 2 branches missed.">        if ((target == null)</span>
<span class="nc bnc" id="L18085" title="All 4 branches missed.">                || ((target.getTargetType() == Targetable.TYPE_ENTITY) &amp;&amp; (te.isDestroyed()</span>
<span class="nc bnc" id="L18086" title="All 4 branches missed.">                || te.isDoomed() || te.getCrew().isDead()))) {</span>
<span class="nc" id="L18087">            r = new Report(4191);</span>
<span class="nc" id="L18088">            r.subject = ae.getId();</span>
<span class="nc" id="L18089">            r.indent();</span>
<span class="nc" id="L18090">            addReport(r);</span>
<span class="nc" id="L18091">            return;</span>
        }

<span class="nc" id="L18094">        r = new Report(9031);</span>
<span class="nc" id="L18095">        r.subject = ae.getId();</span>
<span class="nc" id="L18096">        r.indent();</span>
<span class="nc" id="L18097">        r.add(target.getDisplayName());</span>
<span class="nc" id="L18098">        r.newlines = 1;</span>
<span class="nc" id="L18099">        addReport(r);</span>

        //If point defenses engaged the missile, handle that damage
<span class="nc bnc" id="L18102" title="All 2 branches missed.">        if (amsDamage &gt; 0) {</span>
            //Report the attack
<span class="nc" id="L18104">            r = new Report(3362);</span>
<span class="nc" id="L18105">            r.newlines = 1;</span>
<span class="nc" id="L18106">            r.subject = te.getId();</span>
<span class="nc" id="L18107">            vPhaseReport.add(r);</span>

            //If the target's point defenses overheated, report that
<span class="nc bnc" id="L18110" title="All 2 branches missed.">            if (taa.getPDOverheated()) {</span>
<span class="nc" id="L18111">                r = new Report(3361);</span>
<span class="nc" id="L18112">                r.newlines = 1;</span>
<span class="nc" id="L18113">                r.subject = te.getId();</span>
<span class="nc" id="L18114">                vPhaseReport.add(r);</span>
            }

            //Damage the missile
<span class="nc" id="L18118">            HitData hit = tm.rollHitLocation(ToHitData.HIT_NORMAL,</span>
<span class="nc" id="L18119">                    tm.sideTable(te.getPosition(), true));</span>
<span class="nc" id="L18120">            addReport(damageEntity(ae, hit, amsDamage, false,</span>
                    DamageType.NONE, false, false, false));

            //If point defense fire destroys the missile, don't process a hit
<span class="nc bnc" id="L18124" title="All 2 branches missed.">            if (ae.isDoomed()) {</span>
<span class="nc" id="L18125">                return;</span>
            }
        }

        // add some stuff to the to hit value
        // need to add damage done modifier
<span class="nc" id="L18131">        int damageTaken = (ae.getOArmor(TeleMissile.LOC_BODY) - ae.getArmor(TeleMissile.LOC_BODY));</span>
<span class="nc bnc" id="L18132" title="All 2 branches missed.">        if (damageTaken &gt; 10) {</span>
<span class="nc" id="L18133">            toHit.addModifier((int) (Math.floor(damageTaken / 10.0)), &quot;damage taken&quot;);</span>
        }

        // add modifiers for the originating unit missing CIC, FCS, or sensors
<span class="nc" id="L18137">        Entity ride = game.getEntity(tm.getOriginalRideId());</span>
<span class="nc bnc" id="L18138" title="All 2 branches missed.">        if (ride instanceof Aero) {</span>
<span class="nc" id="L18139">            Aero aride = (Aero) ride;</span>
<span class="nc" id="L18140">            int cic = aride.getCICHits();</span>
<span class="nc bnc" id="L18141" title="All 2 branches missed.">            if (cic &gt; 0) {</span>
<span class="nc" id="L18142">                toHit.addModifier(cic * 2, &quot;CIC damage&quot;);</span>
            }

            // sensor hits
<span class="nc" id="L18146">            int sensors = aride.getSensorHits();</span>
<span class="nc bnc" id="L18147" title="All 4 branches missed.">            if ((sensors &gt; 0) &amp;&amp; (sensors &lt; 3)) {</span>
<span class="nc" id="L18148">                toHit.addModifier(sensors, &quot;sensor damage&quot;);</span>
            }
<span class="nc bnc" id="L18150" title="All 2 branches missed.">            if (sensors &gt; 2) {</span>
<span class="nc" id="L18151">                toHit.addModifier(+5, &quot;sensors destroyed&quot;);</span>
            }

            // FCS hits
<span class="nc" id="L18155">            int fcs = aride.getFCSHits();</span>
<span class="nc bnc" id="L18156" title="All 2 branches missed.">            if (fcs &gt; 0) {</span>
<span class="nc" id="L18157">                toHit.addModifier(fcs * 2, &quot;fcs damage&quot;);</span>
            }
        }

<span class="nc bnc" id="L18161" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L18162">            roll = Integer.MAX_VALUE;</span>
<span class="nc" id="L18163">            r = new Report(4226);</span>
<span class="nc" id="L18164">            r.subject = ae.getId();</span>
<span class="nc" id="L18165">            r.add(toHit.getDesc());</span>
        } else {
            // report the roll
<span class="nc" id="L18168">            r = new Report(9033);</span>
<span class="nc" id="L18169">            r.subject = ae.getId();</span>
<span class="nc" id="L18170">            r.add(toHit.getValue());</span>
<span class="nc" id="L18171">            r.add(toHit.getDesc());</span>
<span class="nc" id="L18172">            r.add(roll);</span>
<span class="nc" id="L18173">            r.newlines = 0;</span>
        }
<span class="nc" id="L18175">        addReport(r);</span>

        // do we hit?
<span class="nc bnc" id="L18178" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L18180">            r = new Report(4035);</span>
<span class="nc" id="L18181">            r.subject = ae.getId();</span>
<span class="nc" id="L18182">            addReport(r);</span>
        } else {
            // Resolve the damage.
<span class="nc" id="L18185">            HitData hit = te.rollHitLocation(ToHitData.HIT_NORMAL,</span>
<span class="nc" id="L18186">                    te.sideTable(ae.getPosition(), true));</span>
<span class="nc" id="L18187">            hit.setCapital(true);</span>
<span class="nc" id="L18188">            hit.setCapMisCritMod(tm.getCritMod());</span>
<span class="nc" id="L18189">            addReport(damageEntity(te, hit,</span>
<span class="nc" id="L18190">                    TeleMissileAttackAction.getDamageFor(ae), false,</span>
                    DamageType.NONE, false, false, throughFront));
<span class="nc" id="L18192">            destroyEntity(ae, &quot;successful attack&quot;);</span>
        }

<span class="nc" id="L18195">    }</span>

    /**
     * Handle a ramming attack
     */
    private void resolveRamAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L18201">        final RamAttackAction raa = (RamAttackAction) pr.aaa;</span>
<span class="nc" id="L18202">        final Entity ae = game.getEntity(raa.getEntityId());</span>
<span class="nc" id="L18203">        final Targetable target = game.getTarget(raa.getTargetType(), raa.getTargetId());</span>
<span class="nc" id="L18204">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L18205">        int roll = pr.roll;</span>
<span class="nc" id="L18206">        Entity te = null;</span>
<span class="nc bnc" id="L18207" title="All 4 branches missed.">        if ((target != null) &amp;&amp; (target.getTargetType() == Targetable.TYPE_ENTITY)) {</span>
<span class="nc" id="L18208">            te = (Entity) target;</span>
        }

<span class="nc" id="L18211">        boolean throughFront = true;</span>
<span class="nc bnc" id="L18212" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L18213">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }

        Report r;

<span class="nc bnc" id="L18218" title="All 2 branches missed.">        boolean glancing = Compute.d6(1) == 6;</span>

        // entity isn't ramming any more
<span class="nc" id="L18221">        ae.setRamming(false);</span>

<span class="nc bnc" id="L18223" title="All 2 branches missed.">        if (lastEntityId != raa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L18225">            r = new Report(4005);</span>
<span class="nc" id="L18226">            r.subject = ae.getId();</span>
<span class="nc" id="L18227">            r.addDesc(ae);</span>
<span class="nc" id="L18228">            addReport(r);</span>
        }

        // should we even bother?
<span class="nc bnc" id="L18232" title="All 2 branches missed.">        if ((target == null)</span>
<span class="nc bnc" id="L18233" title="All 4 branches missed.">                || ((target.getTargetType() == Targetable.TYPE_ENTITY) &amp;&amp; (te.isDestroyed()</span>
<span class="nc bnc" id="L18234" title="All 4 branches missed.">                || te.isDoomed() || te.getCrew().isDead()))) {</span>
<span class="nc" id="L18235">            r = new Report(4190);</span>
<span class="nc" id="L18236">            r.subject = ae.getId();</span>
<span class="nc" id="L18237">            r.indent();</span>
<span class="nc" id="L18238">            addReport(r);</span>
<span class="nc" id="L18239">            return;</span>
        }

        // steel yourself for attack
<span class="nc" id="L18243">        int steelRoll = Compute.d6(2);</span>
<span class="nc" id="L18244">        r = new Report(9020);</span>
<span class="nc" id="L18245">        r.subject = ae.getId();</span>
<span class="nc" id="L18246">        r.add(steelRoll);</span>

<span class="nc bnc" id="L18248" title="All 2 branches missed.">        if (steelRoll &gt;= 11) {</span>
<span class="nc" id="L18249">            r.choose(true);</span>
<span class="nc" id="L18250">            addReport(r);</span>
        } else {
<span class="nc" id="L18252">            r.choose(false);</span>
<span class="nc" id="L18253">            addReport(r);</span>
<span class="nc" id="L18254">            return;</span>
        }

        // attacker immobile?
<span class="nc bnc" id="L18258" title="All 2 branches missed.">        if (ae.isImmobile()) {</span>
<span class="nc" id="L18259">            r = new Report(4200);</span>
<span class="nc" id="L18260">            r.subject = ae.getId();</span>
<span class="nc" id="L18261">            r.indent();</span>
<span class="nc" id="L18262">            addReport(r);</span>
<span class="nc" id="L18263">            return;</span>
        }

<span class="nc" id="L18266">        r = new Report(9030);</span>
<span class="nc" id="L18267">        r.subject = ae.getId();</span>
<span class="nc" id="L18268">        r.indent();</span>
<span class="nc" id="L18269">        r.add(target.getDisplayName());</span>
<span class="nc" id="L18270">        r.newlines = 0;</span>
<span class="nc" id="L18271">        addReport(r);</span>

<span class="nc bnc" id="L18273" title="All 2 branches missed.">        if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L18274">            roll = Integer.MAX_VALUE;</span>
<span class="nc" id="L18275">            r = new Report(4225);</span>
<span class="nc" id="L18276">            r.subject = ae.getId();</span>
<span class="nc" id="L18277">            r.add(toHit.getDesc());</span>
        } else {
            // report the roll
<span class="nc" id="L18280">            r = new Report(4025);</span>
<span class="nc" id="L18281">            r.subject = ae.getId();</span>
<span class="nc" id="L18282">            r.add(toHit.getValue());</span>
<span class="nc" id="L18283">            r.add(roll);</span>
<span class="nc" id="L18284">            r.newlines = 0;</span>
        }
<span class="nc" id="L18286">        addReport(r);</span>

        // do we hit?
<span class="nc bnc" id="L18289" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
            // miss
<span class="nc" id="L18291">            r = new Report(4035);</span>
<span class="nc" id="L18292">            r.subject = ae.getId();</span>
<span class="nc" id="L18293">            addReport(r);</span>
        } else {
            // Resolve the damage.
<span class="nc" id="L18296">            resolveRamDamage((IAero) ae, te, toHit, glancing, throughFront);</span>
        }

<span class="nc" id="L18299">    }</span>

    /**
     * Handle a ramming attack's damage
     */
    private void resolveRamDamage(IAero aero, Entity te, ToHitData toHit,
                                  boolean glancing, boolean throughFront) {

<span class="nc" id="L18307">        Entity ae = (Entity) aero;</span>

<span class="nc" id="L18309">        int damage = RamAttackAction.getDamageFor(aero, te);</span>
<span class="nc" id="L18310">        int damageTaken = RamAttackAction.getDamageTakenBy(aero, te);</span>
<span class="nc bnc" id="L18311" title="All 2 branches missed.">        if (glancing) {</span>
            // Round up glancing blows against conventional infantry
<span class="nc bnc" id="L18313" title="All 4 branches missed.">            if ((te instanceof Infantry) &amp;&amp; !(te instanceof BattleArmor)) {</span>
<span class="nc" id="L18314">                damage = (int) Math.ceil(damage / 2.0);</span>
            } else {
<span class="nc" id="L18316">                damage = (int) Math.floor(damage / 2.0);</span>
            }
<span class="nc" id="L18318">            damageTaken = (int) Math.floor(damageTaken / 2.0);</span>
        }

        // are they capital scale?
<span class="nc bnc" id="L18322" title="All 2 branches missed.">        if (te.isCapitalScale()</span>
<span class="nc bnc" id="L18323" title="All 2 branches missed.">            &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)) {</span>
<span class="nc" id="L18324">            damage = (int) Math.floor(damage / 10.0);</span>
        }
<span class="nc bnc" id="L18326" title="All 2 branches missed.">        if (ae.isCapitalScale()</span>
<span class="nc bnc" id="L18327" title="All 2 branches missed.">            &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)) {</span>
<span class="nc" id="L18328">            damageTaken = (int) Math.floor(damageTaken / 10.0);</span>
        }

        Report r;

<span class="nc bnc" id="L18333" title="All 2 branches missed.">        if (glancing) {</span>
<span class="nc" id="L18334">            r = new Report(9015);</span>
<span class="nc" id="L18335">            r.subject = ae.getId();</span>
<span class="nc" id="L18336">            r.indent(1);</span>
<span class="nc" id="L18337">            addReport(r);</span>
        }

        // damage to attacker
<span class="nc" id="L18341">        r = new Report(4240);</span>
<span class="nc" id="L18342">        r.subject = ae.getId();</span>
<span class="nc" id="L18343">        r.add(damageTaken);</span>
<span class="nc" id="L18344">        r.indent();</span>
<span class="nc" id="L18345">        addReport(r);</span>

<span class="nc" id="L18347">        HitData hit = ae.rollHitLocation(ToHitData.HIT_NORMAL,</span>
<span class="nc" id="L18348">                ae.sideTable(te.getPosition(), true));</span>
        // if the damage is greater than the initial armor then destroy the
        // entity
<span class="nc bnc" id="L18351" title="All 2 branches missed.">        if ((2 * ae.getOArmor(hit)) &lt; damageTaken) {</span>
<span class="nc" id="L18352">            addReport(destroyEntity(ae, &quot;by massive ramming damage&quot;, false));</span>
        } else {
<span class="nc" id="L18354">            addReport(damageEntity(ae, hit, damageTaken, false,</span>
                    DamageType.NONE, false, false, throughFront));
        }

<span class="nc" id="L18358">        r = new Report(4230);</span>
<span class="nc" id="L18359">        r.subject = ae.getId();</span>
<span class="nc" id="L18360">        r.add(damage);</span>
<span class="nc" id="L18361">        r.add(toHit.getTableDesc());</span>
<span class="nc" id="L18362">        r.indent();</span>
<span class="nc" id="L18363">        addReport(r);</span>

<span class="nc" id="L18365">        hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc bnc" id="L18366" title="All 2 branches missed.">        if ((2 * te.getOArmor(hit)) &lt; damage) {</span>
<span class="nc" id="L18367">            addReport(destroyEntity(te, &quot;by massive ramming damage&quot;, false));</span>
        } else {
<span class="nc" id="L18369">            addReport(damageEntity(te, hit, damage, false, DamageType.NONE,</span>
                    false, false, throughFront));
        }
<span class="nc" id="L18372">    }</span>

    /**
     * Handle a charge's damage
     */
    private void resolveChargeDamage(Entity ae, Entity te, ToHitData toHit, int direction) {
<span class="nc" id="L18378">        resolveChargeDamage(ae, te, toHit, direction, false, true, false);</span>
<span class="nc" id="L18379">    }</span>

    private void resolveChargeDamage(Entity ae, Entity te, ToHitData toHit, int direction,
                                     boolean glancing, boolean throughFront, boolean airmechRam) {

        // we hit...

<span class="nc" id="L18386">        PilotingRollData chargePSR = null;</span>
        // If we're upright, we may fall down.
<span class="nc bnc" id="L18388" title="All 4 branches missed.">        if (!ae.isProne() &amp;&amp; !airmechRam) {</span>
<span class="nc" id="L18389">            chargePSR = new PilotingRollData(ae.getId(), 2, &quot;charging&quot;);</span>
        }

        // Damage To Target
        int damage;

        // Damage to Attacker
        int damageTaken;

<span class="nc bnc" id="L18398" title="All 2 branches missed.">        if (airmechRam) {</span>
<span class="nc" id="L18399">            damage = AirmechRamAttackAction.getDamageFor(ae);</span>
<span class="nc" id="L18400">            damageTaken = AirmechRamAttackAction.getDamageTakenBy(ae, te);</span>
        } else {
<span class="nc" id="L18402">            damage = ChargeAttackAction.getDamageFor(ae, te, game.getOptions()</span>
<span class="nc" id="L18403">                    .booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_CHARGE_DAMAGE), toHit.getMoS());</span>
<span class="nc" id="L18404">            damageTaken = ChargeAttackAction.getDamageTakenBy(ae, te, game</span>
<span class="nc" id="L18405">                    .getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_CHARGE_DAMAGE));</span>
        }
<span class="nc bnc" id="L18407" title="All 2 branches missed.">        if (ae.hasWorkingMisc(MiscType.F_RAM_PLATE)) {</span>
<span class="nc" id="L18408">            damage = (int) Math.ceil(damage * 1.5);</span>
<span class="nc" id="L18409">            damageTaken = (int) Math.floor(damageTaken * 0.5);</span>
        }
<span class="nc bnc" id="L18411" title="All 2 branches missed.">        if (glancing) {</span>
            // Glancing Blow rule doesn't state whether damage to attacker on charge
            // or DFA is halved as well, assume yes. TODO : Check with PM
<span class="nc bnc" id="L18414" title="All 4 branches missed.">            if ((te instanceof Infantry) &amp;&amp; !(te instanceof BattleArmor)) {</span>
<span class="nc" id="L18415">                damage = (int) Math.ceil(damage / 2.0);</span>
            } else {
<span class="nc" id="L18417">                damage = (int) Math.floor(damage / 2.0);</span>
            }
<span class="nc" id="L18419">            damageTaken = (int) Math.floor(damageTaken / 2.0);</span>
        }
<span class="nc" id="L18421">        boolean bDirect = false;</span>
<span class="nc" id="L18422">        int directBlowCritMod = toHit.getMoS() / 3;</span>
<span class="nc bnc" id="L18423" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW)</span>
<span class="nc bnc" id="L18424" title="All 2 branches missed.">            &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1)) {</span>
<span class="nc" id="L18425">            damage += toHit.getMoS() / 3;</span>
<span class="nc" id="L18426">            bDirect = false;</span>
        }

        // Is the target inside a building?
<span class="nc" id="L18430">        final boolean targetInBuilding = Compute.isInBuilding(game, te);</span>

        // Which building takes the damage?
<span class="nc" id="L18433">        Building bldg = game.getBoard().getBuildingAt(te.getPosition());</span>

        // The building shields all units from a certain amount of damage.
        // The amount is based upon the building's CF at the phase's start.
<span class="nc" id="L18437">        int bldgAbsorbs = 0;</span>
<span class="nc bnc" id="L18438" title="All 4 branches missed.">        if (targetInBuilding &amp;&amp; (bldg != null)) {</span>
<span class="nc" id="L18439">            bldgAbsorbs = bldg.getAbsorbtion(te.getPosition());</span>
        }

        Report r;

        // damage to attacker
<span class="nc" id="L18445">        r = new Report(4240);</span>
<span class="nc" id="L18446">        r.subject = ae.getId();</span>
<span class="nc" id="L18447">        r.add(damageTaken);</span>
<span class="nc" id="L18448">        r.indent();</span>
<span class="nc" id="L18449">        addReport(r);</span>

        // Charging vehicles check for possible motive system hits.
<span class="nc bnc" id="L18452" title="All 2 branches missed.">        if (ae instanceof Tank) {</span>
<span class="nc" id="L18453">            r = new Report(4241);</span>
<span class="nc" id="L18454">            r.indent();</span>
<span class="nc" id="L18455">            addReport(r);</span>
<span class="nc" id="L18456">            int side = Compute.targetSideTable(te, ae);</span>
<span class="nc" id="L18457">            int mod = ae.getMotiveSideMod(side);</span>
<span class="nc" id="L18458">            addReport(vehicleMotiveDamage((Tank)ae, mod));</span>
        }

<span class="nc bnc" id="L18461" title="All 2 branches missed.">        while (damageTaken &gt; 0) {</span>
            int cluster;
            HitData hit;
            // An airmech ramming attack does all damage to attacker's CT
<span class="nc bnc" id="L18465" title="All 2 branches missed.">            if (airmechRam) {</span>
<span class="nc" id="L18466">                cluster = damageTaken;</span>
<span class="nc" id="L18467">                hit = new HitData(Mech.LOC_CT);</span>
            } else {
<span class="nc" id="L18469">                cluster = Math.min(5, damageTaken);</span>
<span class="nc" id="L18470">                hit = ae.rollHitLocation(toHit.getHitTable(), ae.sideTable(te.getPosition()));</span>
            }
<span class="nc" id="L18472">            damageTaken -= cluster;</span>
<span class="nc" id="L18473">            hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L18474">            cluster = checkForSpikes(ae, hit.getLocation(), cluster, te, Mech.LOC_CT);</span>
<span class="nc" id="L18475">            addReport(damageEntity(ae, hit, cluster, false, DamageType.NONE,</span>
                    false, false, throughFront));
<span class="nc" id="L18477">        }</span>

        // Damage to target
<span class="nc bnc" id="L18480" title="All 2 branches missed.">        if (ae instanceof Mech) {</span>
<span class="nc" id="L18481">            int spikeDamage = 0;</span>
<span class="nc bnc" id="L18482" title="All 2 branches missed.">            for (int loc = 0; loc &lt; ae.locations(); loc++) {</span>
<span class="nc bnc" id="L18483" title="All 4 branches missed.">                if (((Mech) ae).locationIsTorso(loc) &amp;&amp; ae.hasWorkingMisc(MiscType.F_SPIKES, -1, loc)) {</span>
<span class="nc" id="L18484">                    spikeDamage += 2;</span>
                }
            }
<span class="nc bnc" id="L18487" title="All 2 branches missed.">            if (spikeDamage &gt; 0) {</span>
<span class="nc" id="L18488">                r = new Report(4335);</span>
<span class="nc" id="L18489">                r.indent(2);</span>
<span class="nc" id="L18490">                r.subject = ae.getId();</span>
<span class="nc" id="L18491">                r.add(spikeDamage);</span>
<span class="nc" id="L18492">                addReport(r);</span>
            }
<span class="nc" id="L18494">            damage += spikeDamage;</span>
        }
<span class="nc" id="L18496">        r = new Report(4230);</span>
<span class="nc" id="L18497">        r.subject = ae.getId();</span>
<span class="nc" id="L18498">        r.add(damage);</span>
<span class="nc" id="L18499">        r.add(toHit.getTableDesc());</span>
<span class="nc" id="L18500">        r.indent();</span>
<span class="nc" id="L18501">        addReport(r);</span>

        // Vehicles that have *been* charged check for motive system damage,
        // too...
        // ...though VTOLs don't use that table and should lose their rotor
        // instead,
        // which would be handled as part of the damage already.
<span class="nc bnc" id="L18508" title="All 4 branches missed.">        if ((te instanceof Tank) &amp;&amp; !(te instanceof VTOL)) {</span>
<span class="nc" id="L18509">            r = new Report(4242);</span>
<span class="nc" id="L18510">            r.indent();</span>
<span class="nc" id="L18511">            addReport(r);</span>

<span class="nc" id="L18513">            int side = Compute.targetSideTable(ae, te);</span>
<span class="nc" id="L18514">            int mod = te.getMotiveSideMod(side);</span>
<span class="nc" id="L18515">            addReport(vehicleMotiveDamage((Tank)te, mod));</span>
        }

        // track any additional damage to the attacker due to the target having spikes
<span class="nc" id="L18519">        int spikeDamage = 0;</span>
<span class="nc bnc" id="L18520" title="All 2 branches missed.">        while (damage &gt; 0) {</span>
<span class="nc" id="L18521">            int cluster = Math.min(5, damage);</span>
            // Airmech ramming attacks do all damage to a single location
<span class="nc bnc" id="L18523" title="All 2 branches missed.">            if (airmechRam) {</span>
<span class="nc" id="L18524">                cluster = damage;</span>
            }
<span class="nc" id="L18526">            damage -= cluster;</span>
<span class="nc bnc" id="L18527" title="All 2 branches missed.">            if (bldgAbsorbs &gt; 0) {</span>
<span class="nc" id="L18528">                int toBldg = Math.min(bldgAbsorbs, cluster);</span>
<span class="nc" id="L18529">                cluster -= toBldg;</span>
<span class="nc" id="L18530">                addNewLines();</span>
<span class="nc" id="L18531">                Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage,</span>
<span class="nc" id="L18532">                                                               te.getPosition());</span>
<span class="nc bnc" id="L18533" title="All 2 branches missed.">                for (Report report : buildingReport) {</span>
<span class="nc" id="L18534">                    report.subject = ae.getId();</span>
<span class="nc" id="L18535">                }</span>
<span class="nc" id="L18536">                addReport(buildingReport);</span>

                // some buildings scale remaining damage that is not absorbed
                // TODO : this isn't quite right for castles brian
<span class="nc" id="L18540">                damage = (int) Math.floor(bldg.getDamageToScale() * damage);</span>
            }

            // A building may absorb the entire shot.
<span class="nc bnc" id="L18544" title="All 2 branches missed.">            if (cluster == 0) {</span>
<span class="nc" id="L18545">                r = new Report(4235);</span>
<span class="nc" id="L18546">                r.subject = ae.getId();</span>
<span class="nc" id="L18547">                r.addDesc(te);</span>
<span class="nc" id="L18548">                r.indent();</span>
<span class="nc" id="L18549">                addReport(r);</span>
            } else {
<span class="nc" id="L18551">                HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L18552">                hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc bnc" id="L18553" title="All 2 branches missed.">                if (bDirect) {</span>
<span class="nc" id="L18554">                    hit.makeDirectBlow(directBlowCritMod);</span>
                }
<span class="nc" id="L18556">                cluster = checkForSpikes(te, hit.getLocation(), cluster, ae, Mech.LOC_CT);</span>
<span class="nc" id="L18557">                addReport(damageEntity(te, hit, cluster, false,</span>
                                       DamageType.NONE, false, false, throughFront));
            }
<span class="nc" id="L18560">        }</span>

<span class="nc bnc" id="L18562" title="All 2 branches missed.">        if (airmechRam) {</span>
<span class="nc bnc" id="L18563" title="All 2 branches missed.">            if (!ae.isDoomed()) {</span>
<span class="nc" id="L18564">                PilotingRollData controlRoll = ae.getBasePilotingRoll();</span>
<span class="nc" id="L18565">                Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
<span class="nc" id="L18566">                r = new Report(9320);</span>
<span class="nc" id="L18567">                r.subject = ae.getId();</span>
<span class="nc" id="L18568">                r.addDesc(ae);</span>
<span class="nc" id="L18569">                r.add(&quot;successful ramming attack&quot;);</span>
<span class="nc" id="L18570">                reports.add(r);</span>
<span class="nc" id="L18571">                int diceRoll = Compute.d6(2);</span>
                // different reports depending on out-of-control status
<span class="nc" id="L18573">                r = new Report(9606);</span>
<span class="nc" id="L18574">                r.subject = ae.getId();</span>
<span class="nc" id="L18575">                r.add(controlRoll.getValueAsString());</span>
<span class="nc" id="L18576">                r.add(controlRoll.getDesc());</span>
<span class="nc" id="L18577">                r.add(diceRoll);</span>
<span class="nc" id="L18578">                r.newlines = 1;</span>
<span class="nc bnc" id="L18579" title="All 2 branches missed.">                if (diceRoll &lt; controlRoll.getValue()) {</span>
<span class="nc" id="L18580">                    r.choose(false);</span>
<span class="nc" id="L18581">                    reports.add(r);</span>
<span class="nc" id="L18582">                    crashAirMech(ae, controlRoll, reports);</span>
                } else {
<span class="nc" id="L18584">                    r.choose(true);</span>
<span class="nc" id="L18585">                    reports.addElement(r);</span>
<span class="nc bnc" id="L18586" title="All 2 branches missed.">                    if (ae instanceof LandAirMech) {</span>
<span class="nc" id="L18587">                        reports.addAll(landAirMech((LandAirMech)ae, ae.getPosition(), 1, ae.delta_distance));</span>
                    }
                }
<span class="nc" id="L18590">                addReport(reports);</span>
<span class="nc" id="L18591">            }</span>
        } else {
            // move attacker and target, if possible
<span class="nc" id="L18594">            Coords src = te.getPosition();</span>
<span class="nc" id="L18595">            Coords dest = src.translated(direction);</span>

<span class="nc bnc" id="L18597" title="All 2 branches missed.">            if (Compute.isValidDisplacement(game, te.getId(), te.getPosition(),</span>
                                            direction)) {
<span class="nc" id="L18599">                addNewLines();</span>
<span class="nc" id="L18600">                addReport(doEntityDisplacement(te, src, dest, new PilotingRollData(</span>
<span class="nc" id="L18601">                        te.getId(), 2, &quot;was charged&quot;)));</span>
<span class="nc" id="L18602">                addReport(doEntityDisplacement(ae, ae.getPosition(), src, chargePSR));</span>
            }

<span class="nc" id="L18605">            addNewLines();</span>
        }

        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L18610" title="All 4 branches missed.">        if ((te instanceof Mech) &amp;&amp; ((Mech) te).isIndustrial()) {</span>
<span class="nc" id="L18611">            ((Mech) te).setCheckForCrit(true);</span>
        }

<span class="nc" id="L18614">    } // End private void resolveChargeDamage( Entity, Entity, ToHitData )</span>

    /**
     * Checks whether the location has spikes, and if so handles the damage to the
     * attack and returns the reduced damage. Locations without spikes return the
     * original damage amount.
     *
     * @param target            The target of a physical attack
     * @param targetLocation    The location that was hit
     * @param damage            The amount of damage dealt to the target
     * @param attacker          The attacker
     * @param attackerLocation  The location on the attacker that is damaged if the
     *                          target has spikes. Entity.LOC_NONE if the attacker
     *                          can't be damaged by spikes in this attack.
     * @return          The damage after applying any reduction due to spikes
     */
    private int checkForSpikes(Entity target, int targetLocation, int damage,
                               Entity attacker, int attackerLocation) {
<span class="nc" id="L18632">        return checkForSpikes(target, targetLocation, damage, attacker, attackerLocation, Entity.LOC_NONE);</span>
    }

    /**
     * Checks whether the location has spikes, and if so handles the damage to the
     * attack and returns the reduced damage. Locations without spikes return the
     * original damage amount.
     *
     * @param target            The target of a physical attack
     * @param targetLocation    The location that was hit
     * @param damage            The amount of damage dealt to the target
     * @param attacker          The attacker
     * @param attackerLocation  The location on the attacker that is damaged if the
     *                          target has spikes. Entity.LOC_NONE if the attacker
     *                          can't be damaged by spikes in this attack.
     * @param attackerLocation2 If not Entity.LOC_NONE, the damage to the attacker
     *                          will be split between two locations.
     * @return          The damage after applying any reduction due to spikes
     */
    private int checkForSpikes(Entity target, int targetLocation, int damage,
                               Entity attacker, int attackerLocation, int attackerLocation2) {
<span class="nc bnc" id="L18653" title="All 2 branches missed.">        if (target.hasWorkingMisc(MiscType.F_SPIKES, -1, targetLocation)) {</span>
            Report r;
<span class="nc bnc" id="L18655" title="All 2 branches missed.">            if (damage == 0) {</span>
                // Only show damage to attacker (push attack)
<span class="nc" id="L18657">                r = new Report(4333);</span>
<span class="nc bnc" id="L18658" title="All 2 branches missed.">            } else if (attackerLocation != Entity.LOC_NONE) {</span>
                // Show damage reduction and damage to attacker
<span class="nc" id="L18660">                r = new Report(4330);</span>
            } else {
                // Only show damage reduction (club/physical weapon attack)
<span class="nc" id="L18663">                r = new Report(4331);</span>
            }
<span class="nc" id="L18665">            r.indent(2);</span>
<span class="nc" id="L18666">            r.subject = target.getId();</span>
<span class="nc" id="L18667">            addReport(r);</span>
            // An attack that deals zero damage can still damage the attacker in the case of a push
<span class="nc bnc" id="L18669" title="All 2 branches missed.">            if (attackerLocation != Entity.LOC_NONE) {</span>
                // Spikes also protect from retaliatory spike damage
<span class="nc bnc" id="L18671" title="All 2 branches missed.">                if (attacker.hasWorkingMisc(MiscType.F_SPIKES, -1, attackerLocation)) {</span>
<span class="nc" id="L18672">                    r = new Report(4332);</span>
<span class="nc" id="L18673">                    r.indent(2);</span>
<span class="nc" id="L18674">                    r.subject = attacker.getId();</span>
<span class="nc" id="L18675">                    addReport(r);</span>
<span class="nc bnc" id="L18676" title="All 2 branches missed.">                } else if (attackerLocation2 == Entity.LOC_NONE) {</span>
<span class="nc" id="L18677">                    addReport(damageEntity(attacker, new HitData(attackerLocation), 2, false,</span>
                            DamageType.NONE,false, false, false));
                } else {
<span class="nc" id="L18680">                    addReport(damageEntity(attacker, new HitData(attackerLocation), 1, false,</span>
                            DamageType.NONE, false, false, false));
<span class="nc" id="L18682">                    addReport(damageEntity(attacker, new HitData(attackerLocation2), 1, false,</span>
                            DamageType.NONE, false, false, false));
                }
            }
<span class="nc" id="L18686">            return Math.max(1, damage - 4);</span>
        }
<span class="nc" id="L18688">        return damage;</span>
    }

    /**
     * End-phase checks for laid explosives; check whether explosives are
     * touched off, or if we should report laying explosives
     */
    private void checkLayExplosives() {
        // Report continuing explosive work
<span class="nc bnc" id="L18697" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L18698" title="All 2 branches missed.">            if (!(e instanceof Infantry)) {</span>
<span class="nc" id="L18699">                continue;</span>
            }
<span class="nc" id="L18701">            Infantry inf = (Infantry) e;</span>
<span class="nc bnc" id="L18702" title="All 2 branches missed.">            if (inf.turnsLayingExplosives &gt; 0) {</span>
<span class="nc" id="L18703">                Report r = new Report(4271);</span>
<span class="nc" id="L18704">                r.subject = inf.getId();</span>
<span class="nc" id="L18705">                r.addDesc(inf);</span>
<span class="nc" id="L18706">                addReport(r);</span>
            }
<span class="nc" id="L18708">        }</span>
        // Check for touched-off explosives
<span class="nc" id="L18710">        Vector&lt;Building&gt; updatedBuildings = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L18711" title="All 2 branches missed.">        for (DemolitionCharge charge : explodingCharges) {</span>
<span class="nc" id="L18712">            Building bldg = game.getBoard().getBuildingAt(charge.pos);</span>
<span class="nc bnc" id="L18713" title="All 2 branches missed.">            if (bldg == null) { // Shouldn't happen...</span>
<span class="nc" id="L18714">                continue;</span>
            }
<span class="nc" id="L18716">            bldg.removeDemolitionCharge(charge);</span>
<span class="nc" id="L18717">            updatedBuildings.add(bldg);</span>
<span class="nc" id="L18718">            Report r = new Report(4272, Report.PUBLIC);</span>
<span class="nc" id="L18719">            r.add(bldg.getName());</span>
<span class="nc" id="L18720">            addReport(r);</span>
<span class="nc" id="L18721">            Vector&lt;Report&gt; dmgReports = damageBuilding(bldg, charge.damage,</span>
                    &quot; explodes for &quot;, charge.pos);
<span class="nc bnc" id="L18723" title="All 2 branches missed.">            for (Report rep : dmgReports) {</span>
<span class="nc" id="L18724">                rep.indent();</span>
<span class="nc" id="L18725">                addReport(rep);</span>
<span class="nc" id="L18726">            }</span>
<span class="nc" id="L18727">        }</span>
<span class="nc" id="L18728">        explodingCharges.clear();</span>
<span class="nc" id="L18729">        sendChangedBuildings(updatedBuildings);</span>
<span class="nc" id="L18730">    }</span>

    private void resolveLayExplosivesAttack(PhysicalResult pr) {
<span class="nc" id="L18733">        final LayExplosivesAttackAction laa = (LayExplosivesAttackAction) pr.aaa;</span>
<span class="nc" id="L18734">        final Entity ae = game.getEntity(laa.getEntityId());</span>
<span class="nc bnc" id="L18735" title="All 2 branches missed.">        if (ae instanceof Infantry) {</span>
<span class="nc" id="L18736">            Infantry inf = (Infantry) ae;</span>
<span class="nc bnc" id="L18737" title="All 2 branches missed.">            if (inf.turnsLayingExplosives &lt; 0) {</span>
<span class="nc" id="L18738">                inf.turnsLayingExplosives = 0;</span>
<span class="nc" id="L18739">                Report r = new Report(4270);</span>
<span class="nc" id="L18740">                r.subject = inf.getId();</span>
<span class="nc" id="L18741">                r.addDesc(inf);</span>
<span class="nc" id="L18742">                addReport(r);</span>
<span class="nc" id="L18743">            } else {</span>
<span class="nc" id="L18744">                Building building = game.getBoard().getBuildingAt(ae.getPosition());</span>
<span class="nc bnc" id="L18745" title="All 2 branches missed.">                if (building != null) {</span>
<span class="nc" id="L18746">                    building.addDemolitionCharge(ae.getOwner().getId(), pr.damage, ae.getPosition());</span>
<span class="nc" id="L18747">                    Report r = new Report(4275);</span>
<span class="nc" id="L18748">                    r.subject = inf.getId();</span>
<span class="nc" id="L18749">                    r.addDesc(inf);</span>
<span class="nc" id="L18750">                    r.add(pr.damage);</span>
<span class="nc" id="L18751">                    addReport(r);</span>
                    // Update clients with this info
<span class="nc" id="L18753">                    Vector&lt;Building&gt; updatedBuildings = new Vector&lt;&gt;();</span>
<span class="nc" id="L18754">                    updatedBuildings.add(building);</span>
<span class="nc" id="L18755">                    sendChangedBuildings(updatedBuildings);</span>
                }
<span class="nc" id="L18757">                inf.turnsLayingExplosives = -1;</span>
            }
        }
<span class="nc" id="L18760">    }</span>

    /**
     * Handle a death from above attack
     */
    private void resolveDfaAttack(PhysicalResult pr, int lastEntityId) {
<span class="nc" id="L18766">        final DfaAttackAction daa = (DfaAttackAction) pr.aaa;</span>
<span class="nc" id="L18767">        final Entity ae = game.getEntity(daa.getEntityId());</span>

        // is the attacker dead? because that sure messes up the calculations
<span class="nc bnc" id="L18770" title="All 2 branches missed.">        if (ae == null) {</span>
<span class="nc" id="L18771">            return;</span>
        }

<span class="nc" id="L18774">        final IHex aeHex = game.getBoard().getHex(ae.getPosition());</span>
<span class="nc" id="L18775">        final IHex teHex = game.getBoard().getHex(daa.getTargetPos());</span>
<span class="nc" id="L18776">        final Targetable target = game.getTarget(daa.getTargetType(), daa.getTargetId());</span>
        // get damage, ToHitData and roll from the PhysicalResult
<span class="nc" id="L18778">        int damage = pr.damage;</span>
<span class="nc" id="L18779">        final ToHitData toHit = pr.toHit;</span>
<span class="nc" id="L18780">        int roll = pr.roll;</span>
<span class="nc" id="L18781">        Entity te = null;</span>
<span class="nc bnc" id="L18782" title="All 2 branches missed.">        if ((target != null)</span>
<span class="nc bnc" id="L18783" title="All 2 branches missed.">            &amp;&amp; (target.getTargetType() == Targetable.TYPE_ENTITY)) {</span>
            // Lets re-write around that horrible hack that was here before.
            // So instead of asking if a specific location is wet and praying
            // that it won't cause an NPE...
            // We'll check 1) if the hex has water, and 2) if it's deep enough
            // to cover the unit in question at its current elevation.
            // It's especially important to make sure it's done this way,
            // because some units (Sylph, submarines) can be at ANY elevation
            // underwater, and VTOLs can be well above the surface.
<span class="nc" id="L18792">            te = (Entity) target;</span>
<span class="nc" id="L18793">            IHex hex = game.getBoard().getHex(te.getPosition());</span>
<span class="nc bnc" id="L18794" title="All 2 branches missed.">            if (hex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc bnc" id="L18795" title="All 2 branches missed.">                if (te.relHeight() &lt; 0) {</span>
<span class="nc" id="L18796">                    damage = (int) Math.ceil(damage * 0.5f);</span>
                }
            }
        }
<span class="nc" id="L18800">        boolean throughFront = true;</span>
<span class="nc bnc" id="L18801" title="All 2 branches missed.">        if (te != null) {</span>
<span class="nc" id="L18802">            throughFront = Compute.isThroughFrontHex(game, ae.getPosition(), te);</span>
        }
<span class="nc bnc" id="L18804" title="All 2 branches missed.">        final boolean glancing = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L18805" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_GLANCING_BLOWS) &amp;&amp; (roll == toHit.getValue());</span>
        // Set Margin of Success/Failure.
<span class="nc" id="L18807">        toHit.setMoS(roll - Math.max(2, toHit.getValue()));</span>
<span class="nc bnc" id="L18808" title="All 2 branches missed.">        final boolean directBlow = game.getOptions().booleanOption(</span>
<span class="nc bnc" id="L18809" title="All 2 branches missed.">                OptionsConstants.ADVCOMBAT_TACOPS_DIRECT_BLOW) &amp;&amp; ((toHit.getMoS() / 3) &gt;= 1);</span>

        Report r;

<span class="nc" id="L18813">        final int direction = ae.getFacing();</span>

<span class="nc bnc" id="L18815" title="All 2 branches missed.">        if (lastEntityId != daa.getEntityId()) {</span>
            // who is making the attack
<span class="nc" id="L18817">            r = new Report(4005);</span>
<span class="nc" id="L18818">            r.subject = ae.getId();</span>
<span class="nc" id="L18819">            r.addDesc(ae);</span>
<span class="nc" id="L18820">            addReport(r);</span>
        }

        // should we even bother?
<span class="nc bnc" id="L18824" title="All 4 branches missed.">        if ((target == null) || ((target.getTargetType() == Targetable.TYPE_ENTITY)</span>
<span class="nc bnc" id="L18825" title="All 6 branches missed.">                &amp;&amp; (te.isDestroyed() || te.isDoomed() || te.getCrew().isDead()))) {</span>
<span class="nc" id="L18826">            r = new Report(4245);</span>
<span class="nc" id="L18827">            r.subject = ae.getId();</span>
<span class="nc" id="L18828">            r.indent();</span>
<span class="nc" id="L18829">            addReport(r);</span>
            // entity isn't DFAing any more
<span class="nc" id="L18831">            ae.setDisplacementAttack(null);</span>
<span class="nc bnc" id="L18832" title="All 2 branches missed.">            if (ae.isProne()) {</span>
                // attacker prone during weapons phase
<span class="nc" id="L18834">                addReport(doEntityFall(ae, daa.getTargetPos(), 2, 3,</span>
<span class="nc" id="L18835">                        ae.getBasePilotingRoll(), false, false));</span>

            } else {
                // same effect as successful DFA
<span class="nc" id="L18839">                ae.setElevation(ae.calcElevation(aeHex, teHex, 0, false, false));</span>
<span class="nc" id="L18840">                addReport(doEntityDisplacement(ae, ae.getPosition(),</span>
<span class="nc" id="L18841">                        daa.getTargetPos(), new PilotingRollData(ae.getId(), 4,</span>
                                &quot;executed death from above&quot;)));
            }
<span class="nc" id="L18844">            return;</span>
        }

<span class="nc" id="L18847">        r = new Report(4246);</span>
<span class="nc" id="L18848">        r.subject = ae.getId();</span>
<span class="nc" id="L18849">        r.indent();</span>
<span class="nc" id="L18850">        r.add(target.getDisplayName());</span>
<span class="nc" id="L18851">        r.newlines = 0;</span>
<span class="nc" id="L18852">        addReport(r);</span>

        // target still in the same position?
<span class="nc bnc" id="L18855" title="All 2 branches missed.">        if (!target.getPosition().equals(daa.getTargetPos())) {</span>
<span class="nc" id="L18856">            r = new Report(4215);</span>
<span class="nc" id="L18857">            r.subject = ae.getId();</span>
<span class="nc" id="L18858">            addReport(r);</span>
            // entity isn't DFAing any more
<span class="nc" id="L18860">            ae.setDisplacementAttack(null);</span>
<span class="nc" id="L18861">            addReport(doEntityFallsInto(ae, ae.getElevation(), ae.getPosition(), daa.getTargetPos(),</span>
<span class="nc" id="L18862">                    ae.getBasePilotingRoll(), true));</span>
<span class="nc" id="L18863">            return;</span>
        }

        // hack: if the attacker's prone, or incapacitated, fudge the roll
<span class="nc bnc" id="L18867" title="All 4 branches missed.">        if (ae.isProne() || !ae.isActive()) {</span>
<span class="nc" id="L18868">            roll = -12;</span>
<span class="nc" id="L18869">            r = new Report(4250);</span>
<span class="nc" id="L18870">            r.subject = ae.getId();</span>
<span class="nc" id="L18871">            r.add(toHit.getDesc());</span>
<span class="nc" id="L18872">            r.newlines--;</span>
<span class="nc" id="L18873">            addReport(r);</span>
<span class="nc bnc" id="L18874" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L18875">            roll = -12;</span>
<span class="nc" id="L18876">            r = new Report(4255);</span>
<span class="nc" id="L18877">            r.subject = ae.getId();</span>
<span class="nc" id="L18878">            r.add(toHit.getDesc());</span>
<span class="nc" id="L18879">            addReport(r);</span>
<span class="nc bnc" id="L18880" title="All 2 branches missed.">        } else if (toHit.getValue() == TargetRoll.AUTOMATIC_SUCCESS) {</span>
<span class="nc" id="L18881">            r = new Report(4260);</span>
<span class="nc" id="L18882">            r.subject = ae.getId();</span>
<span class="nc" id="L18883">            r.add(toHit.getDesc());</span>
<span class="nc" id="L18884">            addReport(r);</span>
<span class="nc" id="L18885">            roll = Integer.MAX_VALUE;</span>
        } else {
            // report the roll
<span class="nc" id="L18888">            r = new Report(4025);</span>
<span class="nc" id="L18889">            r.subject = ae.getId();</span>
<span class="nc" id="L18890">            r.add(toHit.getValue());</span>
<span class="nc" id="L18891">            r.add(roll);</span>
<span class="nc" id="L18892">            r.newlines = 0;</span>
<span class="nc" id="L18893">            addReport(r);</span>
<span class="nc bnc" id="L18894" title="All 2 branches missed.">            if (glancing) {</span>
<span class="nc" id="L18895">                r = new Report(3186);</span>
<span class="nc" id="L18896">                r.subject = ae.getId();</span>
<span class="nc" id="L18897">                r.newlines = 0;</span>
<span class="nc" id="L18898">                addReport(r);</span>
            }
<span class="nc bnc" id="L18900" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L18901">                r = new Report(3189);</span>
<span class="nc" id="L18902">                r.subject = ae.getId();</span>
<span class="nc" id="L18903">                r.newlines = 0;</span>
<span class="nc" id="L18904">                addReport(r);</span>
            }

        }

        // do we hit?
<span class="nc bnc" id="L18910" title="All 2 branches missed.">        if (roll &lt; toHit.getValue()) {</span>
<span class="nc" id="L18911">            Coords dest = te.getPosition();</span>
<span class="nc" id="L18912">            Coords targetDest = Compute.getPreferredDisplacement(game, te.getId(), dest, direction);</span>
            // miss
<span class="nc" id="L18914">            r = new Report(4035);</span>
<span class="nc" id="L18915">            r.subject = ae.getId();</span>
<span class="nc" id="L18916">            addReport(r);</span>
<span class="nc bnc" id="L18917" title="All 2 branches missed.">            if (targetDest != null) {</span>
                // move target to preferred hex
<span class="nc" id="L18919">                addReport(doEntityDisplacement(te, dest, targetDest, null));</span>
                // attacker falls into destination hex
<span class="nc" id="L18921">                r = new Report(4265);</span>
<span class="nc" id="L18922">                r.subject = ae.getId();</span>
<span class="nc" id="L18923">                r.addDesc(ae);</span>
<span class="nc" id="L18924">                r.add(dest.getBoardNum(), true);</span>
<span class="nc" id="L18925">                r.indent();</span>
<span class="nc" id="L18926">                addReport(r);</span>
                // entity isn't DFAing any more
<span class="nc" id="L18928">                ae.setDisplacementAttack(null);</span>
<span class="nc" id="L18929">                addReport(doEntityFall(ae, dest, 2, 3, ae.getBasePilotingRoll(),</span>
                        false, false), 1);
<span class="nc" id="L18931">                Entity violation = Compute.stackingViolation(game, ae.getId(), dest);</span>
<span class="nc bnc" id="L18932" title="All 2 branches missed.">                if (violation != null) {</span>
                    // target gets displaced
<span class="nc" id="L18934">                    targetDest = Compute.getValidDisplacement(game,</span>
<span class="nc" id="L18935">                            violation.getId(), dest, direction);</span>
<span class="nc" id="L18936">                    vPhaseReport.addAll(doEntityDisplacement(violation, dest,</span>
<span class="nc" id="L18937">                            targetDest, new PilotingRollData(violation.getId(),</span>
                                    0, &quot;domino effect&quot;)));
                    // Update the violating entity's position on the client.
<span class="nc bnc" id="L18940" title="All 2 branches missed.">                    if (!game.getOutOfGameEntitiesVector().contains(violation)) {</span>
<span class="nc" id="L18941">                        entityUpdate(violation.getId());</span>
                    }
                }
<span class="nc" id="L18944">            } else {</span>
                // attacker destroyed
                // Tanks suffer an ammo/power plant hit.
                // TODO : a Mech suffers a Head Blown Off crit.
<span class="nc" id="L18948">                addReport(destroyEntity(ae, &quot;impossible displacement&quot;,</span>
                        ae instanceof Mech, ae instanceof Mech));
            }
<span class="nc" id="L18951">            return;</span>
        }

        // we hit...

<span class="nc" id="L18956">        r = new Report(4040);</span>
<span class="nc" id="L18957">        r.subject = ae.getId();</span>
<span class="nc" id="L18958">        addReport(r);</span>

<span class="nc" id="L18960">        Coords dest = target.getPosition();</span>

        // Can't DFA a target inside of a building.
<span class="nc" id="L18963">        int damageTaken = DfaAttackAction.getDamageTakenBy(ae);</span>

        // Targeting a building.
<span class="nc bnc" id="L18966" title="All 2 branches missed.">        if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L18967" title="All 2 branches missed.">            || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) {</span>

            // Which building takes the damage?
<span class="nc" id="L18970">            Building bldg = game.getBoard().getBuildingAt(daa.getTargetPos());</span>
            
            // The building takes the full brunt of the attack.
<span class="nc" id="L18973">            Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damage, target.getPosition());</span>
<span class="nc bnc" id="L18974" title="All 2 branches missed.">            for (Report report : buildingReport) {</span>
<span class="nc" id="L18975">                report.subject = ae.getId();</span>
<span class="nc" id="L18976">            }</span>
<span class="nc" id="L18977">            addReport(buildingReport);</span>

            // Damage any infantry in the hex.
<span class="nc" id="L18980">            addReport(damageInfantryIn(bldg, damage, target.getPosition()));</span>
<span class="nc" id="L18981">        } else { // Target isn't building.</span>

<span class="nc bnc" id="L18983" title="All 2 branches missed.">            if (glancing) {</span>
<span class="nc bnc" id="L18984" title="All 4 branches missed.">                if ((te instanceof Infantry) &amp;&amp; !(te instanceof BattleArmor)) {</span>
<span class="nc" id="L18985">                    damage = (int) Math.ceil(damage / 2.0);</span>
                } else {
<span class="nc" id="L18987">                    damage = (int) Math.floor(damage / 2.0);</span>
                }
            }
<span class="nc bnc" id="L18990" title="All 2 branches missed.">            if (directBlow) {</span>
<span class="nc" id="L18991">                damage += toHit.getMoS() / 3;</span>
            }
            // damage target
<span class="nc" id="L18994">            r = new Report(4230);</span>
<span class="nc" id="L18995">            r.subject = ae.getId();</span>
<span class="nc" id="L18996">            r.add(damage);</span>
<span class="nc" id="L18997">            r.add(toHit.getTableDesc());</span>
<span class="nc" id="L18998">            r.indent(2);</span>
<span class="nc" id="L18999">            addReport(r);</span>

<span class="nc bnc" id="L19001" title="All 2 branches missed.">            while (damage &gt; 0) {</span>
<span class="nc" id="L19002">                int cluster = Math.min(5, damage);</span>
<span class="nc" id="L19003">                HitData hit = te.rollHitLocation(toHit.getHitTable(), toHit.getSideTable());</span>
<span class="nc" id="L19004">                hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc bnc" id="L19005" title="All 2 branches missed.">                if (directBlow) {</span>
<span class="nc" id="L19006">                    hit.makeDirectBlow(toHit.getMoS() / 3);</span>
                }
<span class="nc" id="L19008">                damage -= cluster;</span>
<span class="nc" id="L19009">                cluster = checkForSpikes(te, hit.getLocation(), cluster, ae, Mech.LOC_LLEG, Mech.LOC_RLEG);</span>
<span class="nc" id="L19010">                addReport(damageEntity(te, hit, cluster, false,</span>
                                       DamageType.NONE, false, false, throughFront));
<span class="nc" id="L19012">            }</span>
<span class="nc bnc" id="L19013" title="All 2 branches missed.">            if (target instanceof VTOL) {</span>
                // destroy rotor
<span class="nc" id="L19015">                addReport(applyCriticalHit(te, VTOL.LOC_ROTOR,</span>
                        new CriticalSlot(CriticalSlot.TYPE_SYSTEM,
                                VTOL.CRIT_ROTOR_DESTROYED), false, 0, false));
            }
            // Target entities are pushed away or destroyed.
<span class="nc" id="L19020">            Coords targetDest = Compute.getValidDisplacement(game, te.getId(), dest, direction);</span>
<span class="nc bnc" id="L19021" title="All 2 branches missed.">            if (targetDest != null) {</span>
<span class="nc" id="L19022">                addReport(doEntityDisplacement(te, dest, targetDest,</span>
<span class="nc" id="L19023">                        new PilotingRollData(te.getId(), 2, &quot;hit by death from above&quot;)));</span>
            } else {
                // ack! automatic death! Tanks
                // suffer an ammo/power plant hit.
                // TODO : a Mech suffers a Head Blown Off crit.
<span class="nc" id="L19028">                addReport(destroyEntity(te, &quot;impossible displacement&quot;,</span>
                        te instanceof Mech, te instanceof Mech));
            }

        }

<span class="nc bnc" id="L19034" title="All 2 branches missed.">        if (glancing) {</span>
            // Glancing Blow rule doesn't state whether damage to attacker on charge
            // or DFA is halved as well, assume yes. TODO : Check with PM
<span class="nc" id="L19037">            damageTaken = (int) Math.floor(damageTaken / 2.0);</span>
        }

<span class="nc bnc" id="L19040" title="All 2 branches missed.">        if (ae.hasQuirk(OptionsConstants.QUIRK_POS_REINFORCED_LEGS)) {</span>
<span class="nc" id="L19041">            damageTaken = (int) Math.floor(damageTaken / 2.0);</span>
        }

        // damage attacker
<span class="nc" id="L19045">        r = new Report(4240);</span>
<span class="nc" id="L19046">        r.subject = ae.getId();</span>
<span class="nc" id="L19047">        r.add(damageTaken);</span>
<span class="nc" id="L19048">        r.indent(2);</span>
<span class="nc" id="L19049">        addReport(r);</span>
<span class="nc bnc" id="L19050" title="All 2 branches missed.">        while (damageTaken &gt; 0) {</span>
<span class="nc" id="L19051">            int cluster = Math.min(5, damageTaken);</span>
<span class="nc" id="L19052">            HitData hit = ae.rollHitLocation(ToHitData.HIT_KICK, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L19053">            hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L19054">            addReport(damageEntity(ae, hit, cluster));</span>
<span class="nc" id="L19055">            damageTaken -= cluster;</span>
<span class="nc" id="L19056">        }</span>

<span class="nc bnc" id="L19058" title="All 2 branches missed.">        if (ae.hasQuirk(OptionsConstants.QUIRK_NEG_WEAK_LEGS)) {</span>
<span class="nc" id="L19059">            addNewLines();</span>
<span class="nc" id="L19060">            addReport(criticalEntity(ae, Mech.LOC_LLEG, false, 0, 0));</span>
<span class="nc" id="L19061">            addNewLines();</span>
<span class="nc" id="L19062">            addReport(criticalEntity(ae, Mech.LOC_RLEG, false, 0, 0));</span>
<span class="nc bnc" id="L19063" title="All 2 branches missed.">            if (ae instanceof QuadMech) {</span>
<span class="nc" id="L19064">                addNewLines();</span>
<span class="nc" id="L19065">                addReport(criticalEntity(ae, Mech.LOC_LARM, false, 0, 0));</span>
<span class="nc" id="L19066">                addNewLines();</span>
<span class="nc" id="L19067">                addReport(criticalEntity(ae, Mech.LOC_RARM, false, 0, 0));</span>
            }
        }

<span class="nc" id="L19071">        addNewLines();</span>

        // That's it for target buildings.
<span class="nc bnc" id="L19074" title="All 2 branches missed.">        if ((target.getTargetType() == Targetable.TYPE_BUILDING)</span>
<span class="nc bnc" id="L19075" title="All 2 branches missed.">            || (target.getTargetType() == Targetable.TYPE_FUEL_TANK)) {</span>
<span class="nc" id="L19076">            return;</span>
        }
<span class="nc" id="L19078">        ae.setElevation(ae.calcElevation(aeHex, teHex, 0, false, false));</span>
        // HACK: to avoid automatic falls, displace from dest to dest
<span class="nc" id="L19080">        addReport(doEntityDisplacement(ae, dest, dest, new PilotingRollData(</span>
<span class="nc" id="L19081">                ae.getId(), 4, &quot;executed death from above&quot;)));</span>

        // entity isn't DFAing any more
<span class="nc" id="L19084">        ae.setDisplacementAttack(null);</span>

        // if the target is an industrial mech, it needs to check for crits
        // at the end of turn
<span class="nc bnc" id="L19088" title="All 4 branches missed.">        if ((target instanceof Mech) &amp;&amp; ((Mech) target).isIndustrial()) {</span>
<span class="nc" id="L19089">            ((Mech) target).setCheckForCrit(true);</span>
        }
<span class="nc" id="L19091">    }</span>

    /**
     * Get the Kick or Push PSR, modified by weight class
     *
     * @param psrEntity The &lt;code&gt;Entity&lt;/code&gt; that should make a PSR
     * @param attacker  The attacking &lt;code&gt;Entity&gt;&lt;/code&gt;
     * @param target    The target &lt;code&gt;Entity&lt;/code&gt;
     * @return The &lt;code&gt;PilotingRollData&lt;/code&gt;
     */
    private PilotingRollData getKickPushPSR(Entity psrEntity, Entity attacker,
                                            Entity target, String reason) {
<span class="nc" id="L19103">        int mod = 0;</span>
<span class="nc" id="L19104">        PilotingRollData psr = new PilotingRollData(psrEntity.getId(), mod,</span>
                                                    reason);
<span class="nc bnc" id="L19106" title="All 2 branches missed.">        if (psrEntity.hasQuirk(OptionsConstants.QUIRK_POS_STABLE)) {</span>
<span class="nc" id="L19107">            psr.addModifier(-1, &quot;stable&quot;, false);</span>
        }
<span class="nc bnc" id="L19109" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_PHYSICAL_PSR)) {</span>

<span class="nc bnc" id="L19111" title="All 5 branches missed.">            switch (target.getWeightClass()) {</span>
                case EntityWeightClass.WEIGHT_LIGHT:
<span class="nc" id="L19113">                    mod = 1;</span>
<span class="nc" id="L19114">                    break;</span>
                case EntityWeightClass.WEIGHT_MEDIUM:
<span class="nc" id="L19116">                    mod = 0;</span>
<span class="nc" id="L19117">                    break;</span>
                case EntityWeightClass.WEIGHT_HEAVY:
<span class="nc" id="L19119">                    mod = -1;</span>
<span class="nc" id="L19120">                    break;</span>
                case EntityWeightClass.WEIGHT_ASSAULT:
<span class="nc" id="L19122">                    mod = -2;</span>
                    break;
            }
            String reportStr;
<span class="nc bnc" id="L19126" title="All 2 branches missed.">            if (mod &gt; 0) {</span>
<span class="nc" id="L19127">                reportStr = (&quot;weight class modifier +&quot;) + mod;</span>
            } else {
<span class="nc" id="L19129">                reportStr = (&quot;weight class modifier &quot;) + mod;</span>
            }
<span class="nc" id="L19131">            psr.addModifier(mod, reportStr, false);</span>
        }
<span class="nc" id="L19133">        return psr;</span>
    }

    /**
     * Each mech sinks the amount of heat appropriate to its current heat
     * capacity.
     */
    private void resolveHeat() {
        Report r;
        // Heat phase header
<span class="nc" id="L19143">        addReport(new Report(5000, Report.PUBLIC));</span>
<span class="nc bnc" id="L19144" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L19145">            Entity entity = i.next();</span>
<span class="nc bnc" id="L19146" title="All 4 branches missed.">            if ((null == entity.getPosition()) &amp;&amp; !entity.isAero()) {</span>
<span class="nc" id="L19147">                continue;</span>
            }
<span class="nc" id="L19149">            IHex entityHex = game.getBoard().getHex(entity.getPosition());</span>

<span class="nc" id="L19151">            int hotDogMod = 0;</span>
<span class="nc bnc" id="L19152" title="All 2 branches missed.">            if (entity.hasAbility(OptionsConstants.PILOT_HOT_DOG)) {</span>
<span class="nc" id="L19153">                hotDogMod = 1;</span>
            }
<span class="nc bnc" id="L19155" title="All 2 branches missed.">            if (entity.getTaserInterferenceHeat()) {</span>
<span class="nc" id="L19156">                entity.heatBuildup += 5;</span>
            }
<span class="nc bnc" id="L19158" title="All 4 branches missed.">            if (entity.hasDamagedRHS() &amp;&amp; entity.weaponFired()) {</span>
<span class="nc" id="L19159">                entity.heatBuildup += 1;</span>
            }
<span class="nc bnc" id="L19161" title="All 6 branches missed.">            if ((entity instanceof Mech) &amp;&amp; ((Mech)entity).hasDamagedCoolantSystem() &amp;&amp; entity.weaponFired()) {</span>
<span class="nc" id="L19162">                entity.heatBuildup += 1;</span>
            }

<span class="nc" id="L19165">            int radicalHSBonus = 0;</span>
<span class="nc" id="L19166">            Vector&lt;Report&gt; rhsReports = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L19167" title="All 2 branches missed.">            if (entity.hasActivatedRadicalHS()) {</span>
<span class="nc bnc" id="L19168" title="All 2 branches missed.">                if (entity instanceof Mech) {</span>
<span class="nc" id="L19169">                    radicalHSBonus = ((Mech) entity).getActiveSinks();</span>
<span class="nc bnc" id="L19170" title="All 2 branches missed.">                } else if (entity instanceof Aero) {</span>
<span class="nc" id="L19171">                    radicalHSBonus = ((Aero) entity).getHeatSinks();</span>
                } else {
<span class="nc" id="L19173">                    MegaMek.getLogger().error(&quot;Radical heat sinks mounted on non-mech, non-aero Entity!&quot;);</span>
                }
<span class="nc" id="L19175">                int rhsRoll = Compute.d6(2);</span>
                int targetNumber;
<span class="nc bnc" id="L19177" title="All 7 branches missed.">                switch (entity.getConsecutiveRHSUses()) {</span>
                    case 0:
<span class="nc" id="L19179">                        targetNumber = 2;</span>
<span class="nc" id="L19180">                        break;</span>
                    case 1:
<span class="nc" id="L19182">                        targetNumber = 3;</span>
<span class="nc" id="L19183">                        break;</span>
                    case 2:
<span class="nc" id="L19185">                        targetNumber = 5;</span>
<span class="nc" id="L19186">                        break;</span>
                    case 3:
<span class="nc" id="L19188">                        targetNumber = 7;</span>
<span class="nc" id="L19189">                        break;</span>
                    case 4:
<span class="nc" id="L19191">                        targetNumber = 10;</span>
<span class="nc" id="L19192">                        break;</span>
                    case 5:
<span class="nc" id="L19194">                        targetNumber = 11;</span>
<span class="nc" id="L19195">                        break;</span>
                    case 6:
                    default:
<span class="nc" id="L19198">                        targetNumber = TargetRoll.AUTOMATIC_FAIL;</span>
                        break;
                }
<span class="nc" id="L19201">                entity.setConsecutiveRHSUses(entity.getConsecutiveRHSUses() + 1);</span>

                // RHS activation report
<span class="nc" id="L19204">                r = new Report(5540);</span>
<span class="nc" id="L19205">                r.subject = entity.getId();</span>
<span class="nc" id="L19206">                r.indent();</span>
<span class="nc" id="L19207">                r.addDesc(entity);</span>
<span class="nc" id="L19208">                r.add(radicalHSBonus);</span>
<span class="nc" id="L19209">                rhsReports.add(r);</span>

<span class="nc bnc" id="L19211" title="All 2 branches missed.">                boolean rhsFailure = rhsRoll &lt; targetNumber;</span>
<span class="nc" id="L19212">                r = new Report(5541);</span>
<span class="nc" id="L19213">                r.indent(2);</span>
<span class="nc" id="L19214">                r.subject = entity.getId();</span>
<span class="nc" id="L19215">                r.add(targetNumber);</span>
<span class="nc" id="L19216">                r.add(rhsRoll);</span>
<span class="nc" id="L19217">                r.choose(rhsFailure);</span>
<span class="nc" id="L19218">                rhsReports.add(r);</span>

<span class="nc bnc" id="L19220" title="All 2 branches missed.">                if (rhsFailure) {</span>
<span class="nc" id="L19221">                    entity.setHasDamagedRHS(true);</span>
<span class="nc" id="L19222">                    int loc = Entity.LOC_NONE;</span>
<span class="nc bnc" id="L19223" title="All 2 branches missed.">                    for (Mounted m : entity.getEquipment()) {</span>
<span class="nc bnc" id="L19224" title="All 2 branches missed.">                        if (m.getType().hasFlag(MiscType.F_RADICAL_HEATSINK)) {</span>
<span class="nc" id="L19225">                            loc = m.getLocation();</span>
<span class="nc" id="L19226">                            m.setDestroyed(true);</span>
<span class="nc" id="L19227">                            break;</span>
                        }
<span class="nc" id="L19229">                    }</span>
<span class="nc bnc" id="L19230" title="All 2 branches missed.">                    if (loc == Entity.LOC_NONE) {</span>
<span class="nc" id="L19231">                        throw new IllegalStateException(&quot;Server.resolveHeat(): &quot; +</span>
                                &quot;Could not find Radical Heat Sink mount on unit that used RHS!&quot;);
                    }
<span class="nc bnc" id="L19234" title="All 2 branches missed.">                    for (int s = 0; s &lt; entity.getNumberOfCriticals(loc); s++) {</span>
<span class="nc" id="L19235">                        CriticalSlot slot = entity.getCritical(loc, s);</span>
<span class="nc bnc" id="L19236" title="All 2 branches missed.">                        if ((slot.getType() == CriticalSlot.TYPE_EQUIPMENT)</span>
<span class="nc bnc" id="L19237" title="All 2 branches missed.">                                &amp;&amp; slot.getMount().getType().hasFlag(MiscType.F_RADICAL_HEATSINK)) {</span>
<span class="nc" id="L19238">                            slot.setHit(true);</span>
<span class="nc" id="L19239">                            break;</span>
                        }
                    }
                }
            }

            // put in ASF heat build-up first because there are few differences
<span class="nc bnc" id="L19246" title="All 4 branches missed.">            if (entity instanceof Aero &amp;&amp; !(entity instanceof ConvFighter)) {</span>
<span class="nc" id="L19247">                ServerHelper.resolveAeroHeat(game, entity, vPhaseReport, rhsReports, radicalHSBonus, hotDogMod, this);</span>
<span class="nc" id="L19248">                continue;</span>
            }

            // heat doesn't matter for non-mechs
<span class="nc bnc" id="L19252" title="All 2 branches missed.">            if (!(entity instanceof Mech)) {</span>
<span class="nc" id="L19253">                entity.heat = 0;</span>
<span class="nc" id="L19254">                entity.heatBuildup = 0;</span>
<span class="nc" id="L19255">                entity.heatFromExternal = 0;</span>
<span class="nc" id="L19256">                entity.coolFromExternal = 0;</span>

<span class="nc bnc" id="L19258" title="All 2 branches missed.">                if (entity.infernos.isStillBurning()) {</span>
<span class="nc" id="L19259">                    doFlamingDamage(entity);</span>
                }
<span class="nc bnc" id="L19261" title="All 2 branches missed.">                if (entity.getTaserShutdownRounds() == 0) {</span>
<span class="nc" id="L19262">                    entity.setBATaserShutdown(false);</span>
<span class="nc bnc" id="L19263" title="All 4 branches missed.">                    if (entity.isShutDown() &amp;&amp; !entity.isManualShutdown()</span>
<span class="nc bnc" id="L19264" title="All 2 branches missed.">                            &amp;&amp; (entity.getTsempEffect() != TSEMPWeapon.TSEMP_EFFECT_SHUTDOWN)) {</span>
<span class="nc" id="L19265">                        entity.setShutDown(false);</span>
<span class="nc" id="L19266">                        r = new Report(5045);</span>
<span class="nc" id="L19267">                        r.subject = entity.getId();</span>
<span class="nc" id="L19268">                        r.addDesc(entity);</span>
<span class="nc" id="L19269">                        addReport(r);</span>
                    }
<span class="nc bnc" id="L19271" title="All 2 branches missed.">                } else if (entity.isBATaserShutdown()) {</span>
                    // if we're shutdown by a BA taser, we might activate again
<span class="nc" id="L19273">                    int roll = Compute.d6(2);</span>
<span class="nc bnc" id="L19274" title="All 2 branches missed.">                    if (roll &gt;= 8) {</span>
<span class="nc" id="L19275">                        entity.setTaserShutdownRounds(0);</span>
<span class="nc bnc" id="L19276" title="All 2 branches missed.">                        if (!(entity.isManualShutdown())) {</span>
<span class="nc" id="L19277">                            entity.setShutDown(false);</span>
                        }
<span class="nc" id="L19279">                        entity.setBATaserShutdown(false);</span>
                    }
<span class="nc" id="L19281">                }</span>

                continue;
            }

            // Only Mechs after this point

            // Meks gain heat from inferno hits.
<span class="nc bnc" id="L19289" title="All 2 branches missed.">            if (entity.infernos.isStillBurning()) {</span>
<span class="nc" id="L19290">                int infernoHeat = entity.infernos.getHeat();</span>
<span class="nc" id="L19291">                entity.heatFromExternal += infernoHeat;</span>
<span class="nc" id="L19292">                r = new Report(5010);</span>
<span class="nc" id="L19293">                r.subject = entity.getId();</span>
<span class="nc" id="L19294">                r.add(infernoHeat);</span>
<span class="nc" id="L19295">                addReport(r);</span>
            }

            // should we even bother for this mech?
<span class="nc bnc" id="L19299" title="All 6 branches missed.">            if (entity.isDestroyed() || entity.isDoomed() || entity.getCrew().isDoomed()</span>
<span class="nc bnc" id="L19300" title="All 2 branches missed.">                    || entity.getCrew().isDead()) {</span>
<span class="nc" id="L19301">                continue;</span>
            }

            // engine hits add a lot of heat, provided the engine is on
<span class="nc" id="L19305">            entity.heatBuildup += entity.getEngineCritHeat();</span>

            // If a Mek had an active Stealth suite, add 10 heat.
<span class="nc bnc" id="L19308" title="All 2 branches missed.">            if (entity.isStealthOn()) {</span>
<span class="nc" id="L19309">                entity.heatBuildup += 10;</span>
<span class="nc" id="L19310">                r = new Report(5015);</span>
<span class="nc" id="L19311">                r.subject = entity.getId();</span>
<span class="nc" id="L19312">                addReport(r);</span>
            }

            // Greg: Nova CEWS If a Mek had an active Nova suite, add 2 heat.
<span class="nc bnc" id="L19316" title="All 2 branches missed.">            if (entity.hasActiveNovaCEWS()) {</span>
<span class="nc" id="L19317">                entity.heatBuildup += 2;</span>
<span class="nc" id="L19318">                r = new Report(5013);</span>
<span class="nc" id="L19319">                r.subject = entity.getId();</span>
<span class="nc" id="L19320">                addReport(r);</span>
            }

            // void sig adds 10 heat
<span class="nc bnc" id="L19324" title="All 2 branches missed.">            if (entity.isVoidSigOn()) {</span>
<span class="nc" id="L19325">                entity.heatBuildup += 10;</span>
<span class="nc" id="L19326">                r = new Report(5016);</span>
<span class="nc" id="L19327">                r.subject = entity.getId();</span>
<span class="nc" id="L19328">                addReport(r);</span>
            }

            // null sig adds 10 heat
<span class="nc bnc" id="L19332" title="All 2 branches missed.">            if (entity.isNullSigOn()) {</span>
<span class="nc" id="L19333">                entity.heatBuildup += 10;</span>
<span class="nc" id="L19334">                r = new Report(5017);</span>
<span class="nc" id="L19335">                r.subject = entity.getId();</span>
<span class="nc" id="L19336">                addReport(r);</span>
            }

            // chameleon polarization field adds 6
<span class="nc bnc" id="L19340" title="All 2 branches missed.">            if (entity.isChameleonShieldOn()) {</span>
<span class="nc" id="L19341">                entity.heatBuildup += 6;</span>
<span class="nc" id="L19342">                r = new Report(5014);</span>
<span class="nc" id="L19343">                r.subject = entity.getId();</span>
<span class="nc" id="L19344">                addReport(r);</span>
            }

            // If a Mek is in extreme Temperatures, add or subtract one
            // heat per 10 degrees (or fraction of 10 degrees) above or
            // below 50 or -30 degrees Celsius
<span class="nc bnc" id="L19350" title="All 2 branches missed.">            if (game.getPlanetaryConditions().getTemperatureDifference(50, -30) != 0</span>
<span class="nc bnc" id="L19351" title="All 2 branches missed.">                    &amp;&amp; !((Mech) entity).hasLaserHeatSinks()) {</span>
<span class="nc bnc" id="L19352" title="All 2 branches missed.">                if (game.getPlanetaryConditions().getTemperature() &gt; 50) {</span>
<span class="nc" id="L19353">                    int heatToAdd = game.getPlanetaryConditions()</span>
<span class="nc" id="L19354">                            .getTemperatureDifference(50, -30);</span>
<span class="nc bnc" id="L19355" title="All 2 branches missed.">                    if (((Mech) entity).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L19356">                        heatToAdd /= 2;</span>
                    }
<span class="nc" id="L19358">                    entity.heatFromExternal += heatToAdd;</span>
<span class="nc" id="L19359">                    r = new Report(5020);</span>
<span class="nc" id="L19360">                    r.subject = entity.getId();</span>
<span class="nc" id="L19361">                    r.add(heatToAdd);</span>
<span class="nc" id="L19362">                    addReport(r);</span>
<span class="nc bnc" id="L19363" title="All 2 branches missed.">                    if (((Mech) entity).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L19364">                        r = new Report(5550);</span>
<span class="nc" id="L19365">                        addReport(r);</span>
                    }
<span class="nc" id="L19367">                } else {</span>
<span class="nc" id="L19368">                    entity.heatFromExternal -= game.getPlanetaryConditions()</span>
<span class="nc" id="L19369">                            .getTemperatureDifference(50, -30);</span>
<span class="nc" id="L19370">                    r = new Report(5025);</span>
<span class="nc" id="L19371">                    r.subject = entity.getId();</span>
<span class="nc" id="L19372">                    r.add(game.getPlanetaryConditions().getTemperatureDifference(50, -30));</span>
<span class="nc" id="L19373">                    addReport(r);</span>
                }
            }

            // Add +5 Heat if the hex you're in is on fire
            // and was on fire for the full round.
<span class="nc bnc" id="L19379" title="All 2 branches missed.">            if (entityHex != null) {</span>
<span class="nc bnc" id="L19380" title="All 4 branches missed.">                if (entityHex.containsTerrain(Terrains.FIRE) &amp;&amp; (entityHex.getFireTurn() &gt; 0)</span>
<span class="nc bnc" id="L19381" title="All 2 branches missed.">                        &amp;&amp; (entity.getElevation() &lt;= 1)) {</span>
<span class="nc" id="L19382">                    int heatToAdd = 5;</span>
<span class="nc bnc" id="L19383" title="All 2 branches missed.">                    if (((Mech) entity).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L19384">                        heatToAdd /= 2;</span>
                    }
<span class="nc" id="L19386">                    entity.heatFromExternal += heatToAdd;</span>
<span class="nc" id="L19387">                    r = new Report(5030);</span>
<span class="nc" id="L19388">                    r.add(heatToAdd);</span>
<span class="nc" id="L19389">                    r.subject = entity.getId();</span>
<span class="nc" id="L19390">                    addReport(r);</span>
<span class="nc bnc" id="L19391" title="All 2 branches missed.">                    if (((Mech) entity).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L19392">                        r = new Report(5550);</span>
<span class="nc" id="L19393">                        addReport(r);</span>
                    }
                }
<span class="nc" id="L19396">                int magma = entityHex.terrainLevel(Terrains.MAGMA);</span>
<span class="nc bnc" id="L19397" title="All 4 branches missed.">                if ((magma &gt; 0) &amp;&amp; (entity.getElevation() == 0)) {</span>
<span class="nc" id="L19398">                    int heatToAdd = 5 * magma;</span>
<span class="nc bnc" id="L19399" title="All 2 branches missed.">                    if (((Mech) entity).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L19400">                        heatToAdd /= 2;</span>
                    }
<span class="nc" id="L19402">                    entity.heatFromExternal += heatToAdd;</span>
<span class="nc" id="L19403">                    r = new Report(5032);</span>
<span class="nc" id="L19404">                    r.subject = entity.getId();</span>
<span class="nc" id="L19405">                    r.add(heatToAdd);</span>
<span class="nc" id="L19406">                    addReport(r);</span>
<span class="nc bnc" id="L19407" title="All 2 branches missed.">                    if (((Mech) entity).hasIntactHeatDissipatingArmor()) {</span>
<span class="nc" id="L19408">                        r = new Report(5550);</span>
<span class="nc" id="L19409">                        addReport(r);</span>
                    }
                }
            }

            // Check the mech for vibroblades if so then check to see if any
            // are active and what heat they will produce.
<span class="nc bnc" id="L19416" title="All 2 branches missed.">            if (entity.hasVibroblades()) {</span>
                int vibroHeat;

<span class="nc" id="L19419">                vibroHeat = entity.getActiveVibrobladeHeat(Mech.LOC_RARM);</span>
<span class="nc" id="L19420">                vibroHeat += entity.getActiveVibrobladeHeat(Mech.LOC_LARM);</span>

<span class="nc bnc" id="L19422" title="All 2 branches missed.">                if (vibroHeat &gt; 0) {</span>
<span class="nc" id="L19423">                    r = new Report(5018);</span>
<span class="nc" id="L19424">                    r.subject = entity.getId();</span>
<span class="nc" id="L19425">                    r.add(vibroHeat);</span>
<span class="nc" id="L19426">                    addReport(r);</span>
<span class="nc" id="L19427">                    entity.heatBuildup += vibroHeat;</span>
                }
            }

<span class="nc" id="L19431">            int capHeat = 0;</span>
<span class="nc bnc" id="L19432" title="All 2 branches missed.">            for (Mounted m : entity.getEquipment()) {</span>
<span class="nc bnc" id="L19433" title="All 4 branches missed.">                if ((m.hasChargedOrChargingCapacitor() == 1) &amp;&amp; !m.isUsedThisRound()) {</span>
<span class="nc" id="L19434">                    capHeat += 5;</span>
                }
<span class="nc bnc" id="L19436" title="All 4 branches missed.">                if ((m.hasChargedOrChargingCapacitor() == 2) &amp;&amp; !m.isUsedThisRound()) {</span>
<span class="nc" id="L19437">                    capHeat += 10;</span>
                }
<span class="nc" id="L19439">            }</span>
<span class="nc bnc" id="L19440" title="All 2 branches missed.">            if (capHeat &gt; 0) {</span>
<span class="nc" id="L19441">                r = new Report(5019);</span>
<span class="nc" id="L19442">                r.subject = entity.getId();</span>
<span class="nc" id="L19443">                r.add(capHeat);</span>
<span class="nc" id="L19444">                addReport(r);</span>
<span class="nc" id="L19445">                entity.heatBuildup += capHeat;</span>
            }

            // Add heat from external sources to the heat buildup
<span class="nc" id="L19449">            int max_ext_heat = game.getOptions().intOption(OptionsConstants.ADVCOMBAT_MAX_EXTERNAL_HEAT);</span>
            // Check Game Options
<span class="nc bnc" id="L19451" title="All 2 branches missed.">            if (max_ext_heat &lt; 0) {</span>
<span class="nc" id="L19452">                max_ext_heat = 15; // standard value specified in TW p.159</span>
            }
<span class="nc" id="L19454">            entity.heatBuildup += Math.min(max_ext_heat, entity.heatFromExternal);</span>
<span class="nc" id="L19455">            entity.heatFromExternal = 0;</span>
            // remove heat we cooled down
<span class="nc" id="L19457">            entity.heatBuildup -= Math.min(9, entity.coolFromExternal);</span>
<span class="nc" id="L19458">            entity.coolFromExternal = 0;</span>

            // Combat computers help manage heat
<span class="nc bnc" id="L19461" title="All 2 branches missed.">            if (entity.hasQuirk(OptionsConstants.QUIRK_POS_COMBAT_COMPUTER)) {</span>
<span class="nc" id="L19462">                int reduce = Math.min(entity.heatBuildup, 4);</span>
<span class="nc" id="L19463">                r = new Report(5026);</span>
<span class="nc" id="L19464">                r.subject = entity.getId();</span>
<span class="nc" id="L19465">                r.add(reduce);</span>
<span class="nc" id="L19466">                addReport(r);</span>
<span class="nc" id="L19467">                entity.heatBuildup -= reduce;</span>
            }

<span class="nc bnc" id="L19470" title="All 2 branches missed.">            if (entity.hasQuirk(OptionsConstants.QUIRK_NEG_FLAWED_COOLING)</span>
<span class="nc bnc" id="L19471" title="All 2 branches missed.">                    &amp;&amp; ((Mech) entity).isCoolingFlawActive()) {</span>
<span class="nc" id="L19472">                int flaw = 5;</span>
<span class="nc" id="L19473">                r = new Report(5021);</span>
<span class="nc" id="L19474">                r.subject = entity.getId();</span>
<span class="nc" id="L19475">                r.add(flaw);</span>
<span class="nc" id="L19476">                addReport(r);</span>
<span class="nc" id="L19477">                entity.heatBuildup += flaw;</span>
            }
            // if heat build up is negative due to temperature, set it to 0
            // for prettier turn reports
<span class="nc bnc" id="L19481" title="All 2 branches missed.">            if (entity.heatBuildup &lt; 0) {</span>
<span class="nc" id="L19482">                entity.heatBuildup = 0;</span>
            }

            // add the heat we've built up so far.
<span class="nc" id="L19486">            entity.heat += entity.heatBuildup;</span>

            // how much heat can we sink?
<span class="nc" id="L19489">            int toSink = entity.getHeatCapacityWithWater() + radicalHSBonus;</span>

<span class="nc bnc" id="L19491" title="All 2 branches missed.">            if (entity.getCoolantFailureAmount() &gt; 0) {</span>
<span class="nc" id="L19492">                int failureAmount = entity.getCoolantFailureAmount();</span>
<span class="nc" id="L19493">                r = new Report(5520);</span>
<span class="nc" id="L19494">                r.subject = entity.getId();</span>
<span class="nc" id="L19495">                r.add(failureAmount);</span>
<span class="nc" id="L19496">                toSink -= failureAmount;</span>
            }

            // should we use a coolant pod?
<span class="nc bnc" id="L19500" title="All 2 branches missed.">            int safeHeat = entity.hasInfernoAmmo() ? 9 : 13;</span>
<span class="nc" id="L19501">            int possibleSinkage = ((Mech) entity).getNumberOfSinks() - entity.getCoolantFailureAmount();</span>
<span class="nc bnc" id="L19502" title="All 2 branches missed.">            for (Mounted m : entity.getEquipment()) {</span>
<span class="nc bnc" id="L19503" title="All 2 branches missed.">                if (m.getType() instanceof AmmoType) {</span>
<span class="nc" id="L19504">                    AmmoType at = (AmmoType) m.getType();</span>
<span class="nc bnc" id="L19505" title="All 4 branches missed.">                    if ((at.getAmmoType() == AmmoType.T_COOLANT_POD) &amp;&amp; m.isAmmoUsable()) {</span>
<span class="nc" id="L19506">                        EquipmentMode mode = m.curMode();</span>
<span class="nc bnc" id="L19507" title="All 2 branches missed.">                        if (mode.equals(&quot;dump&quot;)) {</span>
<span class="nc" id="L19508">                            r = new Report(5260);</span>
<span class="nc" id="L19509">                            r.subject = entity.getId();</span>
<span class="nc" id="L19510">                            addReport(r);</span>
<span class="nc" id="L19511">                            m.setShotsLeft(0);</span>
<span class="nc" id="L19512">                            toSink += possibleSinkage;</span>
<span class="nc" id="L19513">                            break;</span>
                        }
<span class="nc bnc" id="L19515" title="All 4 branches missed.">                        if (mode.equals(&quot;safe&quot;) &amp;&amp; ((entity.heat - toSink) &gt; safeHeat)) {</span>
<span class="nc" id="L19516">                            r = new Report(5265);</span>
<span class="nc" id="L19517">                            r.subject = entity.getId();</span>
<span class="nc" id="L19518">                            addReport(r);</span>
<span class="nc" id="L19519">                            m.setShotsLeft(0);</span>
<span class="nc" id="L19520">                            toSink += possibleSinkage;</span>
<span class="nc" id="L19521">                            break;</span>
                        }
<span class="nc bnc" id="L19523" title="All 4 branches missed.">                        if (mode.equals(&quot;efficient&quot;) &amp;&amp; ((entity.heat - toSink) &gt;= possibleSinkage)) {</span>
<span class="nc" id="L19524">                            r = new Report(5270);</span>
<span class="nc" id="L19525">                            r.subject = entity.getId();</span>
<span class="nc" id="L19526">                            addReport(r);</span>
<span class="nc" id="L19527">                            m.setShotsLeft(0);</span>
<span class="nc" id="L19528">                            toSink += possibleSinkage;</span>
<span class="nc" id="L19529">                            break;</span>
                        }
                    }
                }
<span class="nc" id="L19533">            }</span>

<span class="nc" id="L19535">            toSink = Math.min(toSink, entity.heat);</span>
<span class="nc" id="L19536">            entity.heat -= toSink;</span>
<span class="nc" id="L19537">            r = new Report(5035);</span>
<span class="nc" id="L19538">            r.subject = entity.getId();</span>
<span class="nc" id="L19539">            r.addDesc(entity);</span>
<span class="nc" id="L19540">            r.add(entity.heatBuildup);</span>
<span class="nc" id="L19541">            r.add(toSink);</span>
<span class="nc" id="L19542">            r.add(entity.heat);</span>
<span class="nc" id="L19543">            addReport(r);</span>
<span class="nc" id="L19544">            entity.heatBuildup = 0;</span>
<span class="nc" id="L19545">            vPhaseReport.addAll(rhsReports);</span>

            // Does the unit have inferno ammo?
<span class="nc bnc" id="L19548" title="All 2 branches missed.">            if (entity.hasInfernoAmmo()) {</span>

                // Roll for possible inferno ammo explosion.
<span class="nc bnc" id="L19551" title="All 2 branches missed.">                if (entity.heat &gt;= 10) {</span>
<span class="nc bnc" id="L19552" title="All 4 branches missed.">                    int boom = (4 + (entity.heat &gt;= 14 ? 2 : 0) + (entity.heat &gt;= 19 ? 2 : 0)</span>
<span class="nc bnc" id="L19553" title="All 4 branches missed.">                                + (entity.heat &gt;= 23 ? 2 : 0) + (entity.heat &gt;= 28 ? 2 : 0))</span>
                               - hotDogMod;
<span class="nc" id="L19555">                    int boomRoll = Compute.d6(2);</span>
<span class="nc bnc" id="L19556" title="All 2 branches missed.">                    if (entity.getCrew().hasActiveTechOfficer()) {</span>
<span class="nc" id="L19557">                        boomRoll += 2;</span>
                    }
<span class="nc" id="L19559">                    r = new Report(5040);</span>
<span class="nc" id="L19560">                    r.subject = entity.getId();</span>
<span class="nc" id="L19561">                    r.addDesc(entity);</span>
<span class="nc" id="L19562">                    r.add(boom);</span>
<span class="nc bnc" id="L19563" title="All 2 branches missed.">                    if (entity.getCrew().hasActiveTechOfficer()) {</span>
<span class="nc" id="L19564">                        r.add(boomRoll + &quot;(&quot; + (boomRoll - 2) + &quot;+2)&quot;);</span>
                    } else {
<span class="nc" id="L19566">                        r.add(boomRoll);</span>
                    }

<span class="nc bnc" id="L19569" title="All 2 branches missed.">                    if (boomRoll &gt;= boom) {</span>
                        // avoided
<span class="nc" id="L19571">                        r.choose(true);</span>
<span class="nc" id="L19572">                        addReport(r);</span>
                    } else {
<span class="nc" id="L19574">                        r.choose(false);</span>
<span class="nc" id="L19575">                        addReport(r);</span>
<span class="nc" id="L19576">                        addReport(explodeInfernoAmmoFromHeat(entity));</span>
                    }
                }
            } // End avoid-inferno-explosion
            int autoShutDownHeat;
            boolean mtHeat;

<span class="nc bnc" id="L19583" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_HEAT)) {</span>
<span class="nc" id="L19584">                autoShutDownHeat = 50;</span>
<span class="nc" id="L19585">                mtHeat = true;</span>
            } else {
<span class="nc" id="L19587">                autoShutDownHeat = 30;</span>
<span class="nc" id="L19588">                mtHeat = false;</span>
            }
            // heat effects: start up
<span class="nc bnc" id="L19591" title="All 6 branches missed.">            if ((entity.heat &lt; autoShutDownHeat) &amp;&amp; entity.isShutDown() &amp;&amp; !entity.isStalled()) {</span>
<span class="nc bnc" id="L19592" title="All 2 branches missed.">                if ((entity.getTaserShutdownRounds() == 0)</span>
<span class="nc bnc" id="L19593" title="All 2 branches missed.">                       &amp;&amp; (entity.getTsempEffect() != TSEMPWeapon.TSEMP_EFFECT_SHUTDOWN)) {</span>
<span class="nc bnc" id="L19594" title="All 4 branches missed.">                    if ((entity.heat &lt; 14) &amp;&amp; !(entity.isManualShutdown())) {</span>
                        // automatically starts up again
<span class="nc" id="L19596">                        entity.setShutDown(false);</span>
<span class="nc" id="L19597">                        r = new Report(5045);</span>
<span class="nc" id="L19598">                        r.subject = entity.getId();</span>
<span class="nc" id="L19599">                        r.addDesc(entity);</span>
<span class="nc" id="L19600">                        addReport(r);</span>
<span class="nc bnc" id="L19601" title="All 2 branches missed.">                    } else if (!(entity.isManualShutdown())) {</span>
                        // If the pilot is KO and we need to roll, auto-fail.
<span class="nc bnc" id="L19603" title="All 2 branches missed.">                        if (!entity.getCrew().isActive()) {</span>
<span class="nc" id="L19604">                            r = new Report(5049);</span>
<span class="nc" id="L19605">                            r.subject = entity.getId();</span>
<span class="nc" id="L19606">                            r.addDesc(entity);</span>
                        } else {
                            // roll for startup
<span class="nc" id="L19609">                            int startup = (4 + (((entity.heat - 14) / 4) * 2)) - hotDogMod;</span>
<span class="nc bnc" id="L19610" title="All 2 branches missed.">                            if (mtHeat) {</span>
<span class="nc" id="L19611">                                startup -= 5;</span>
<span class="nc bnc" id="L19612" title="All 4 branches missed.">                                switch (entity.getCrew().getPiloting()) {</span>
                                    case 0:
                                    case 1:
<span class="nc" id="L19615">                                        startup -= 2;</span>
<span class="nc" id="L19616">                                        break;</span>
                                    case 2:
                                    case 3:
<span class="nc" id="L19619">                                        startup -= 1;</span>
<span class="nc" id="L19620">                                        break;</span>
                                    case 6:
                                    case 7:
<span class="nc" id="L19623">                                        startup += 1;</span>
                                }
                            }
<span class="nc" id="L19626">                            int suRoll = Compute.d6(2);</span>
<span class="nc" id="L19627">                            r = new Report(5050);</span>
<span class="nc" id="L19628">                            r.subject = entity.getId();</span>
<span class="nc" id="L19629">                            r.addDesc(entity);</span>
<span class="nc" id="L19630">                            r.add(startup);</span>
<span class="nc" id="L19631">                            r.add(suRoll);</span>
<span class="nc bnc" id="L19632" title="All 2 branches missed.">                            if (suRoll &gt;= startup) {</span>
                                // start 'er back up
<span class="nc" id="L19634">                                entity.setShutDown(false);</span>
<span class="nc" id="L19635">                                r.choose(true);</span>
                            } else {
<span class="nc" id="L19637">                                r.choose(false);</span>
                            }
                        }
<span class="nc" id="L19640">                        addReport(r);</span>
                    }
                } else {
                    // if we're shutdown by a BA taser, we might activate
                    // again
<span class="nc bnc" id="L19645" title="All 2 branches missed.">                    if (entity.isBATaserShutdown()) {</span>
<span class="nc" id="L19646">                        int roll = Compute.d6(2);</span>
<span class="nc bnc" id="L19647" title="All 2 branches missed.">                        if (roll &gt;= 7) {</span>
<span class="nc" id="L19648">                            entity.setTaserShutdownRounds(0);</span>
<span class="nc bnc" id="L19649" title="All 2 branches missed.">                            if (!(entity.isManualShutdown())) {</span>
<span class="nc" id="L19650">                                entity.setShutDown(false);</span>
                            }
<span class="nc" id="L19652">                            entity.setBATaserShutdown(false);</span>
                        }
<span class="nc" id="L19654">                    }</span>
                }
            }

            // heat effects: shutdown!
            // Don't shut down if you just restarted.
<span class="nc bnc" id="L19660" title="All 4 branches missed.">            else if ((entity.heat &gt;= 14) &amp;&amp; !entity.isShutDown()) {</span>
<span class="nc bnc" id="L19661" title="All 2 branches missed.">                if (entity.heat &gt;= autoShutDownHeat) {</span>
<span class="nc" id="L19662">                    r = new Report(5055);</span>
<span class="nc" id="L19663">                    r.subject = entity.getId();</span>
<span class="nc" id="L19664">                    r.addDesc(entity);</span>
<span class="nc" id="L19665">                    addReport(r);</span>
                    // add a piloting roll and resolve immediately
<span class="nc bnc" id="L19667" title="All 2 branches missed.">                    if (entity.canFall()) {</span>
<span class="nc" id="L19668">                        game.addPSR(new PilotingRollData(entity.getId(), 3, &quot;reactor shutdown&quot;));</span>
<span class="nc" id="L19669">                        addReport(resolvePilotingRolls());</span>
                    }
                    // okay, now mark shut down
<span class="nc" id="L19672">                    entity.setShutDown(true);</span>
                } else {
                    // Again, pilot KO means shutdown is automatic.
<span class="nc bnc" id="L19675" title="All 2 branches missed.">                    if (!entity.getCrew().isActive()) {</span>
<span class="nc" id="L19676">                        r = new Report(5056);</span>
<span class="nc" id="L19677">                        r.subject = entity.getId();</span>
<span class="nc" id="L19678">                        r.addDesc(entity);</span>
<span class="nc" id="L19679">                        addReport(r);</span>
<span class="nc" id="L19680">                        entity.setShutDown(true);</span>
                    } else {
<span class="nc" id="L19682">                        int shutdown = (4 + (((entity.heat - 14) / 4) * 2)) - hotDogMod;</span>
<span class="nc bnc" id="L19683" title="All 2 branches missed.">                        if (mtHeat) {</span>
<span class="nc" id="L19684">                            shutdown -= 5;</span>
<span class="nc bnc" id="L19685" title="All 4 branches missed.">                            switch (entity.getCrew().getPiloting()) {</span>
                                case 0:
                                case 1:
<span class="nc" id="L19688">                                    shutdown -= 2;</span>
<span class="nc" id="L19689">                                    break;</span>
                                case 2:
                                case 3:
<span class="nc" id="L19692">                                    shutdown -= 1;</span>
<span class="nc" id="L19693">                                    break;</span>
                                case 6:
                                case 7:
<span class="nc" id="L19696">                                    shutdown += 1;</span>
                            }
                        }
<span class="nc" id="L19699">                        int shutdownRoll = Compute.d6(2);</span>
<span class="nc" id="L19700">                        r = new Report(5060);</span>
<span class="nc" id="L19701">                        r.subject = entity.getId();</span>
<span class="nc" id="L19702">                        r.addDesc(entity);</span>
<span class="nc" id="L19703">                        r.add(shutdown);</span>
<span class="nc bnc" id="L19704" title="All 2 branches missed.">                        if (entity.getCrew().hasActiveTechOfficer()) {</span>
<span class="nc" id="L19705">                            r.add((shutdownRoll + 2) + &quot; (&quot; + shutdownRoll + &quot;+2)&quot;);</span>
<span class="nc" id="L19706">                            shutdownRoll += 2;</span>
                        } else {
<span class="nc" id="L19708">                            r.add(shutdownRoll);</span>
                        }
<span class="nc bnc" id="L19710" title="All 2 branches missed.">                        if (shutdownRoll &gt;= shutdown) {</span>
                            // avoided
<span class="nc" id="L19712">                            r.choose(true);</span>
<span class="nc" id="L19713">                            addReport(r);</span>
                        } else {
                            // shutting down...
<span class="nc" id="L19716">                            r.choose(false);</span>
<span class="nc" id="L19717">                            addReport(r);</span>
                            // add a piloting roll and resolve immediately
<span class="nc bnc" id="L19719" title="All 2 branches missed.">                            if (entity.canFall()) {</span>
<span class="nc" id="L19720">                                game.addPSR(new PilotingRollData(entity.getId(), 3, &quot;reactor shutdown&quot;));</span>
<span class="nc" id="L19721">                                addReport(resolvePilotingRolls());</span>
                            }
                            // okay, now mark shut down
<span class="nc" id="L19724">                            entity.setShutDown(true);</span>
                        }
                    }
                }
            }

            // LAMs in fighter mode need to check for random movement due to heat
<span class="nc" id="L19731">            checkRandomAeroMovement(entity, hotDogMod);</span>

            // heat effects: ammo explosion!
<span class="nc bnc" id="L19734" title="All 2 branches missed.">            if (entity.heat &gt;= 19) {</span>
<span class="nc bnc" id="L19735" title="All 4 branches missed.">                int boom = (4 + (entity.heat &gt;= 23 ? 2 : 0) + (entity.heat &gt;= 28 ? 2 : 0))</span>
                           - hotDogMod;
<span class="nc bnc" id="L19737" title="All 2 branches missed.">                if (mtHeat) {</span>
<span class="nc bnc" id="L19738" title="All 2 branches missed.">                    boom += (entity.heat &gt;= 35 ? 2 : 0)</span>
<span class="nc bnc" id="L19739" title="All 2 branches missed.">                            + (entity.heat &gt;= 40 ? 2 : 0)</span>
<span class="nc bnc" id="L19740" title="All 2 branches missed.">                            + (entity.heat &gt;= 45 ? 2 : 0);</span>
                    // Last line is a crutch; 45 heat should be no roll
                    // but automatic explosion.
                }
<span class="nc bnc" id="L19744" title="All 2 branches missed.">                if (((Mech) entity).hasLaserHeatSinks()) {</span>
<span class="nc" id="L19745">                    boom--;</span>
                }
<span class="nc" id="L19747">                int boomRoll = Compute.d6(2);</span>
<span class="nc" id="L19748">                r = new Report(5065);</span>
<span class="nc" id="L19749">                r.subject = entity.getId();</span>
<span class="nc" id="L19750">                r.addDesc(entity);</span>
<span class="nc" id="L19751">                r.add(boom);</span>
<span class="nc bnc" id="L19752" title="All 2 branches missed.">                if (entity.getCrew().hasActiveTechOfficer()) {</span>
<span class="nc" id="L19753">                    r.add((boomRoll + 2) + &quot; (&quot; + boomRoll + &quot;+2)&quot;);</span>
<span class="nc" id="L19754">                    boomRoll += 2;</span>
                } else {
<span class="nc" id="L19756">                    r.add(boomRoll);</span>
                }
<span class="nc bnc" id="L19758" title="All 2 branches missed.">                if (boomRoll &gt;= boom) {</span>
                    // mech is ok
<span class="nc" id="L19760">                    r.choose(true);</span>
<span class="nc" id="L19761">                    addReport(r);</span>
                } else {
                    // boom!
<span class="nc" id="L19764">                    r.choose(false);</span>
<span class="nc" id="L19765">                    addReport(r);</span>
<span class="nc" id="L19766">                    addReport(explodeAmmoFromHeat(entity));</span>
                }
            }

            // heat effects: mechwarrior damage
            // N.B. The pilot may already be dead.
            int lifeSupportCritCount;
<span class="nc bnc" id="L19773" title="All 2 branches missed.">            boolean torsoMountedCockpit = ((Mech) entity).getCockpitType() == Mech.COCKPIT_TORSO_MOUNTED;</span>
<span class="nc bnc" id="L19774" title="All 2 branches missed.">            if (torsoMountedCockpit) {</span>
<span class="nc" id="L19775">                lifeSupportCritCount = entity.getHitCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                        Mech.SYSTEM_LIFE_SUPPORT, Mech.LOC_RT);
<span class="nc" id="L19777">                lifeSupportCritCount += entity.getHitCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                        Mech.SYSTEM_LIFE_SUPPORT, Mech.LOC_LT);
            } else {
<span class="nc" id="L19780">                lifeSupportCritCount = entity.getHitCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                        Mech.SYSTEM_LIFE_SUPPORT, Mech.LOC_HEAD);
            }
<span class="nc" id="L19783">            int damageHeat = entity.heat;</span>
<span class="nc bnc" id="L19784" title="All 2 branches missed.">            if (entity.hasQuirk(OptionsConstants.QUIRK_POS_IMP_LIFE_SUPPORT)) {</span>
<span class="nc" id="L19785">                damageHeat -= 5;</span>
            }
<span class="nc bnc" id="L19787" title="All 2 branches missed.">            if (entity.hasQuirk(OptionsConstants.QUIRK_NEG_POOR_LIFE_SUPPORT)) {</span>
<span class="nc" id="L19788">                damageHeat += 5;</span>
            }
<span class="nc bnc" id="L19790" title="All 8 branches missed.">            if ((lifeSupportCritCount &gt; 0)</span>
                    &amp;&amp; ((damageHeat &gt;= 15) || (torsoMountedCockpit &amp;&amp; (damageHeat &gt; 0)))
<span class="nc bnc" id="L19792" title="All 4 branches missed.">                    &amp;&amp; !entity.getCrew().isDead() &amp;&amp; !entity.getCrew().isDoomed()</span>
<span class="nc bnc" id="L19793" title="All 2 branches missed.">                    &amp;&amp; !entity.getCrew().isEjected()) {</span>
<span class="nc" id="L19794">                int heatLimitDesc = 1;</span>
<span class="nc" id="L19795">                int damageToCrew = 0;</span>
<span class="nc bnc" id="L19796" title="All 4 branches missed.">                if ((damageHeat &gt;= 47) &amp;&amp; mtHeat) {</span>
                    // mechwarrior takes 5 damage
<span class="nc" id="L19798">                    heatLimitDesc = 47;</span>
<span class="nc" id="L19799">                    damageToCrew = 5;</span>
<span class="nc bnc" id="L19800" title="All 4 branches missed.">                } else if ((damageHeat &gt;= 39) &amp;&amp; mtHeat) {</span>
                    // mechwarrior takes 4 damage
<span class="nc" id="L19802">                    heatLimitDesc = 39;</span>
<span class="nc" id="L19803">                    damageToCrew = 4;</span>
<span class="nc bnc" id="L19804" title="All 4 branches missed.">                } else if ((damageHeat &gt;= 32) &amp;&amp; mtHeat) {</span>
                    // mechwarrior takes 3 damage
<span class="nc" id="L19806">                    heatLimitDesc = 32;</span>
<span class="nc" id="L19807">                    damageToCrew = 3;</span>
<span class="nc bnc" id="L19808" title="All 2 branches missed.">                } else if (damageHeat &gt;= 25) {</span>
                    // mechwarrior takes 2 damage
<span class="nc" id="L19810">                    heatLimitDesc = 25;</span>
<span class="nc" id="L19811">                    damageToCrew = 2;</span>
<span class="nc bnc" id="L19812" title="All 2 branches missed.">                } else if (damageHeat &gt;= 15) {</span>
                    // mechwarrior takes 1 damage
<span class="nc" id="L19814">                    heatLimitDesc = 15;</span>
<span class="nc" id="L19815">                    damageToCrew = 1;</span>
                }
<span class="nc bnc" id="L19817" title="All 2 branches missed.">                if ((((Mech) entity).getCockpitType() == Mech.COCKPIT_TORSO_MOUNTED)</span>
<span class="nc bnc" id="L19818" title="All 2 branches missed.">                        &amp;&amp; !entity.hasAbility(OptionsConstants.MD_PAIN_SHUNT)) {</span>
<span class="nc" id="L19819">                    damageToCrew += 1;</span>
                }
<span class="nc" id="L19821">                r = new Report(5070);</span>
<span class="nc" id="L19822">                r.subject = entity.getId();</span>
<span class="nc" id="L19823">                r.addDesc(entity);</span>
<span class="nc" id="L19824">                r.add(heatLimitDesc);</span>
<span class="nc" id="L19825">                r.add(damageToCrew);</span>
<span class="nc" id="L19826">                addReport(r);</span>
<span class="nc" id="L19827">                addReport(damageCrew(entity, damageToCrew));</span>
<span class="nc bnc" id="L19828" title="All 6 branches missed.">            } else if (mtHeat &amp;&amp; (entity.heat &gt;= 32) &amp;&amp; !entity.getCrew().isDead()</span>
<span class="nc bnc" id="L19829" title="All 2 branches missed.">                    &amp;&amp; !entity.getCrew().isDoomed()</span>
<span class="nc bnc" id="L19830" title="All 2 branches missed.">                    &amp;&amp; !entity.hasAbility(OptionsConstants.MD_PAIN_SHUNT)) {</span>
                // Crew may take damage from heat if MaxTech option is set
<span class="nc" id="L19832">                int heatRoll = Compute.d6(2);</span>
                int avoidNumber;
<span class="nc bnc" id="L19834" title="All 2 branches missed.">                if (entity.heat &gt;= 47) {</span>
<span class="nc" id="L19835">                    avoidNumber = 12;</span>
<span class="nc bnc" id="L19836" title="All 2 branches missed.">                } else if (entity.heat &gt;= 39) {</span>
<span class="nc" id="L19837">                    avoidNumber = 10;</span>
                } else {
<span class="nc" id="L19839">                    avoidNumber = 8;</span>
                }
<span class="nc" id="L19841">                avoidNumber -= hotDogMod;</span>
<span class="nc" id="L19842">                r = new Report(5075);</span>
<span class="nc" id="L19843">                r.subject = entity.getId();</span>
<span class="nc" id="L19844">                r.addDesc(entity);</span>
<span class="nc" id="L19845">                r.add(avoidNumber);</span>
<span class="nc" id="L19846">                r.add(heatRoll);</span>
<span class="nc bnc" id="L19847" title="All 2 branches missed.">                if (heatRoll &gt;= avoidNumber) {</span>
                    // damage avoided
<span class="nc" id="L19849">                    r.choose(true);</span>
<span class="nc" id="L19850">                    addReport(r);</span>
                } else {
<span class="nc" id="L19852">                    r.choose(false);</span>
<span class="nc" id="L19853">                    addReport(r);</span>
<span class="nc" id="L19854">                    addReport(damageCrew(entity, 1));</span>
                }
            }

            // The pilot may have just expired.
<span class="nc bnc" id="L19859" title="All 4 branches missed.">            if ((entity.getCrew().isDead() || entity.getCrew().isDoomed())</span>
<span class="nc bnc" id="L19860" title="All 2 branches missed.">                    &amp;&amp; !entity.getCrew().isEjected()) {</span>
<span class="nc" id="L19861">                r = new Report(5080);</span>
<span class="nc" id="L19862">                r.subject = entity.getId();</span>
<span class="nc" id="L19863">                r.addDesc(entity);</span>
<span class="nc" id="L19864">                addReport(r);</span>
<span class="nc" id="L19865">                addReport(destroyEntity(entity, &quot;crew death&quot;, true));</span>
            }

            // With MaxTech Heat Scale, there may occur critical damage
<span class="nc bnc" id="L19869" title="All 2 branches missed.">            if (mtHeat) {</span>
<span class="nc bnc" id="L19870" title="All 2 branches missed.">                if (entity.heat &gt;= 36) {</span>
<span class="nc" id="L19871">                    int damageRoll = Compute.d6(2);</span>
                    int damageNumber;
<span class="nc bnc" id="L19873" title="All 2 branches missed.">                    if (entity.heat &gt;= 44) {</span>
<span class="nc" id="L19874">                        damageNumber = 10;</span>
                    } else {
<span class="nc" id="L19876">                        damageNumber = 8;</span>
                    }
<span class="nc" id="L19878">                    damageNumber -= hotDogMod;</span>
<span class="nc" id="L19879">                    r = new Report(5085);</span>
<span class="nc" id="L19880">                    r.subject = entity.getId();</span>
<span class="nc" id="L19881">                    r.addDesc(entity);</span>
<span class="nc" id="L19882">                    r.add(damageNumber);</span>
<span class="nc" id="L19883">                    r.add(damageRoll);</span>
<span class="nc" id="L19884">                    r.newlines = 0;</span>
<span class="nc bnc" id="L19885" title="All 2 branches missed.">                    if (damageRoll &gt;= damageNumber) {</span>
<span class="nc" id="L19886">                        r.choose(true);</span>
                    } else {
<span class="nc" id="L19888">                        r.choose(false);</span>
<span class="nc" id="L19889">                        addReport(r);</span>
<span class="nc" id="L19890">                        addReport(oneCriticalEntity(entity, Compute.randomInt(8), false, 0));</span>
                        // add an empty report, for line breaking
<span class="nc" id="L19892">                        r = new Report(1210, Report.PUBLIC);</span>
                    }
<span class="nc" id="L19894">                    addReport(r);</span>
                }
            }

<span class="nc bnc" id="L19898" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_COOLANT_FAILURE)</span>
<span class="nc bnc" id="L19899" title="All 4 branches missed.">                    &amp;&amp; (entity.getHeatCapacity() &gt; entity.getCoolantFailureAmount())</span>
                    &amp;&amp; (entity.heat &gt;= 5)) {
<span class="nc" id="L19901">                int roll = Compute.d6(2);</span>
<span class="nc" id="L19902">                int hitNumber = 10;</span>

<span class="nc" id="L19904">                hitNumber -= Math.max(0, (int) Math.ceil(entity.heat / 5.0) - 2);</span>

<span class="nc" id="L19906">                r = new Report(5525);</span>
<span class="nc" id="L19907">                r.subject = entity.getId();</span>
<span class="nc" id="L19908">                r.add(entity.getShortName());</span>
<span class="nc" id="L19909">                r.add(hitNumber);</span>
<span class="nc" id="L19910">                r.add(roll);</span>
<span class="nc" id="L19911">                r.newlines = 0;</span>
<span class="nc" id="L19912">                addReport(r);</span>
<span class="nc bnc" id="L19913" title="All 2 branches missed.">                if (roll &gt;= hitNumber) {</span>
<span class="nc" id="L19914">                    r = new Report(5052);</span>
<span class="nc" id="L19915">                    r.subject = entity.getId();</span>
<span class="nc" id="L19916">                    addReport(r);</span>
<span class="nc" id="L19917">                    r = new Report(5526);</span>
<span class="nc" id="L19918">                    r.subject = entity.getId();</span>
<span class="nc" id="L19919">                    r.add(entity.getShortNameRaw());</span>
<span class="nc" id="L19920">                    addReport(r);</span>
<span class="nc" id="L19921">                    entity.addCoolantFailureAmount(1);</span>
                } else {
<span class="nc" id="L19923">                    r = new Report(5041);</span>
<span class="nc" id="L19924">                    r.subject = entity.getId();</span>
<span class="nc" id="L19925">                    addReport(r);</span>
                }
            }
<span class="nc" id="L19928">        }</span>

<span class="nc bnc" id="L19930" title="All 2 branches missed.">        if (vPhaseReport.size() == 1) {</span>
            // I guess nothing happened...
<span class="nc" id="L19932">            addReport(new Report(1205, Report.PUBLIC));</span>
        }
<span class="nc" id="L19934">    }</span>

    void checkRandomAeroMovement(Entity entity, int hotDogMod) {
<span class="nc bnc" id="L19937" title="All 2 branches missed.">        if (!entity.isAero()) {</span>
<span class="nc" id="L19938">            return;</span>
        }
<span class="nc" id="L19940">        IAero a = (IAero) entity;</span>
        // heat effects: control effects (must make it unless already random moving)
<span class="nc bnc" id="L19942" title="All 4 branches missed.">        if ((entity.heat &gt;= 5) &amp;&amp; !a.isRandomMove()) {</span>
<span class="nc bnc" id="L19943" title="All 4 branches missed.">            int controlAvoid = (5 + (entity.heat &gt;= 10 ? 1 : 0) + (entity.heat &gt;= 15 ? 1 : 0)</span>
<span class="nc bnc" id="L19944" title="All 4 branches missed.">                    + (entity.heat &gt;= 20 ? 1 : 0) + (entity.heat &gt;= 25 ? 2 : 0)) - hotDogMod;</span>
<span class="nc" id="L19945">            int controlRoll = Compute.d6(2);</span>
<span class="nc" id="L19946">            Report r = new Report(9210);</span>
<span class="nc" id="L19947">            r.subject = entity.getId();</span>
<span class="nc" id="L19948">            r.addDesc(entity);</span>
<span class="nc" id="L19949">            r.add(controlAvoid);</span>
<span class="nc" id="L19950">            r.add(controlRoll);</span>
<span class="nc bnc" id="L19951" title="All 2 branches missed.">            if (controlRoll &gt;= controlAvoid) {</span>
                // in control
<span class="nc" id="L19953">                r.choose(true);</span>
<span class="nc" id="L19954">                addReport(r);</span>
            } else {
                // out of control
<span class="nc" id="L19957">                r.choose(false);</span>
<span class="nc" id="L19958">                addReport(r);</span>
                // if not already out of control, this may lead to
                // elevation decline
<span class="nc bnc" id="L19961" title="All 4 branches missed.">                if (!a.isOutControl() &amp;&amp; !a.isSpaceborne()</span>
<span class="nc bnc" id="L19962" title="All 2 branches missed.">                    &amp;&amp; a.isAirborne()) {</span>
<span class="nc" id="L19963">                    int loss = Compute.d6(1);</span>
<span class="nc" id="L19964">                    r = new Report(9366);</span>
<span class="nc" id="L19965">                    r.newlines = 0;</span>
<span class="nc" id="L19966">                    r.subject = entity.getId();</span>
<span class="nc" id="L19967">                    r.addDesc(entity);</span>
<span class="nc" id="L19968">                    r.add(loss);</span>
<span class="nc" id="L19969">                    addReport(r);</span>
<span class="nc" id="L19970">                    entity.setAltitude(entity.getAltitude() - loss);</span>
                    // check for crash
<span class="nc bnc" id="L19972" title="All 2 branches missed.">                    if (checkCrash(entity, entity.getPosition(), entity.getAltitude())) {</span>
<span class="nc" id="L19973">                        addReport(processCrash(entity, a.getCurrentVelocity(), entity.getPosition()));</span>
                    }
                }
                // force unit out of control through heat
<span class="nc" id="L19977">                a.setOutCtrlHeat(true);</span>
<span class="nc" id="L19978">                a.setRandomMove(true);</span>
            }
        }
<span class="nc" id="L19981">    }</span>

    private void resolveEmergencyCoolantSystem() {
<span class="nc bnc" id="L19984" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L19985" title="All 6 branches missed.">            if ((e instanceof Mech) &amp;&amp; e.hasWorkingMisc(MiscType.F_EMERGENCY_COOLANT_SYSTEM)</span>
                    &amp;&amp; (e.heat &gt; 13)) {
<span class="nc" id="L19987">                Mech mech = (Mech)e;</span>
<span class="nc" id="L19988">                Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
<span class="nc" id="L19989">                HashMap&lt;Integer, List&lt;CriticalSlot&gt;&gt; crits = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L19990" title="All 2 branches missed.">                if (!(mech.doRISCEmergencyCoolantCheckFor(vDesc, crits))) {</span>
<span class="nc" id="L19991">                    mech.heat -= 6 + mech.getCoolantSystemMOS();</span>
<span class="nc" id="L19992">                    Report r = new Report(5027);</span>
<span class="nc" id="L19993">                    r.add(6+mech.getCoolantSystemMOS());</span>
<span class="nc" id="L19994">                    vDesc.add(r);</span>
                }
<span class="nc" id="L19996">                addReport(vDesc);</span>
<span class="nc bnc" id="L19997" title="All 2 branches missed.">                for (Integer loc : crits.keySet()) {</span>
<span class="nc" id="L19998">                    List&lt;CriticalSlot&gt; lcs = crits.get(loc);</span>
<span class="nc bnc" id="L19999" title="All 2 branches missed.">                    for (CriticalSlot cs : lcs) {</span>
<span class="nc" id="L20000">                        addReport(applyCriticalHit(mech, loc, cs, true, 0, false));</span>
<span class="nc" id="L20001">                    }</span>
<span class="nc" id="L20002">                }</span>
            }
<span class="nc" id="L20004">        }</span>
<span class="nc" id="L20005">    }</span>

    /*
     * Resolve HarJel II/III repairs for Mechs so equipped.
     */
    private void resolveHarJelRepairs() {
        Report r;
<span class="nc bnc" id="L20012" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L20013">            Entity entity = i.next();</span>
<span class="nc bnc" id="L20014" title="All 2 branches missed.">            if (!(entity instanceof Mech)) {</span>
<span class="nc" id="L20015">                continue;</span>
            }

<span class="nc" id="L20018">            Mech me = (Mech) entity;</span>
<span class="nc bnc" id="L20019" title="All 2 branches missed.">            for (int loc = 0; loc &lt; me.locations(); ++loc) {</span>
<span class="nc" id="L20020">                boolean harJelII = me.hasHarJelIIIn(loc); // false implies HarJel III</span>
<span class="nc bnc" id="L20021" title="All 4 branches missed.">                if ((harJelII || me.hasHarJelIIIIn(loc))</span>
<span class="nc bnc" id="L20022" title="All 2 branches missed.">                    &amp;&amp; me.isArmorDamagedThisTurn(loc)) {</span>
<span class="nc bnc" id="L20023" title="All 2 branches missed.">                    if (me.hasRearArmor(loc)) {</span>
                        // must have at least one remaining armor in location
<span class="nc bnc" id="L20025" title="All 4 branches missed.">                        if (!((me.getArmor(loc) &gt; 0) || (me.getArmor(loc, true) &gt; 0))) {</span>
<span class="nc" id="L20026">                            continue;</span>
                        }

<span class="nc bnc" id="L20029" title="All 2 branches missed.">                        int toRepair = harJelII ? 2 : 4;</span>
                        int frontRepair, rearRepair;
                        int desiredFrontRepair, desiredRearRepair;

<span class="nc" id="L20033">                        Mounted harJel = null;</span>
                        // find HarJel item
                        // don't need to check ready or worry about null,
                        // we already know there is one, it's ready,
                        // and there can be at most one in a given location
<span class="nc bnc" id="L20038" title="All 2 branches missed.">                        for (Mounted m: me.getMisc()) {</span>
<span class="nc bnc" id="L20039" title="All 2 branches missed.">                            if ((m.getLocation() == loc)</span>
<span class="nc bnc" id="L20040" title="All 2 branches missed.">                                &amp;&amp; (m.getType().hasFlag(MiscType.F_HARJEL_II)</span>
<span class="nc bnc" id="L20041" title="All 2 branches missed.">                                    || m.getType().hasFlag(MiscType.F_HARJEL_III))) {</span>
<span class="nc" id="L20042">                                harJel = m;</span>
                            }
<span class="nc" id="L20044">                        }</span>

<span class="nc bnc" id="L20046" title="All 2 branches missed.">                        if (harJelII) {</span>
<span class="nc bnc" id="L20047" title="All 2 branches missed.">                            if (harJel.curMode().equals(MiscType.S_HARJEL_II_1F1R)) {</span>
<span class="nc" id="L20048">                                desiredFrontRepair = 1;</span>
<span class="nc bnc" id="L20049" title="All 2 branches missed.">                            } else if (harJel.curMode().equals(MiscType.S_HARJEL_II_2F0R)) {</span>
<span class="nc" id="L20050">                                desiredFrontRepair = 2;</span>
                            } else { // 0F2R
<span class="nc" id="L20052">                                desiredFrontRepair = 0;</span>
                            }
                        } else { // HarJel III
<span class="nc bnc" id="L20055" title="All 2 branches missed.">                            if (harJel.curMode().equals(MiscType.S_HARJEL_III_2F2R)) {</span>
<span class="nc" id="L20056">                                desiredFrontRepair = 2;</span>
<span class="nc bnc" id="L20057" title="All 2 branches missed.">                            } else if (harJel.curMode().equals(MiscType.S_HARJEL_III_4F0R)) {</span>
<span class="nc" id="L20058">                                desiredFrontRepair = 4;</span>
<span class="nc bnc" id="L20059" title="All 2 branches missed.">                            } else if (harJel.curMode().equals(MiscType.S_HARJEL_III_3F1R)) {</span>
<span class="nc" id="L20060">                                desiredFrontRepair = 3;</span>
<span class="nc bnc" id="L20061" title="All 2 branches missed.">                            } else if (harJel.curMode().equals(MiscType.S_HARJEL_III_1F3R)) {</span>
<span class="nc" id="L20062">                                desiredFrontRepair = 1;</span>
                            } else { // 0F4R
<span class="nc" id="L20064">                                desiredFrontRepair = 0;</span>
                            }
                        }
<span class="nc" id="L20067">                        desiredRearRepair = toRepair - desiredFrontRepair;</span>

<span class="nc" id="L20069">                        int availableFrontRepair = me.getOArmor(loc) - me.getArmor(loc);</span>
<span class="nc" id="L20070">                        int availableRearRepair = me.getOArmor(loc, true) - me.getArmor(loc, true);</span>
<span class="nc" id="L20071">                        frontRepair = Math.min(availableFrontRepair, desiredFrontRepair);</span>
<span class="nc" id="L20072">                        rearRepair = Math.min(availableRearRepair, desiredRearRepair);</span>
<span class="nc" id="L20073">                        int surplus = desiredFrontRepair - frontRepair;</span>
<span class="nc bnc" id="L20074" title="All 2 branches missed.">                        if (surplus &gt; 0) { // we couldn't use all the points we wanted in front</span>
<span class="nc" id="L20075">                            rearRepair = Math.min(availableRearRepair, rearRepair + surplus);</span>
                        } else {
<span class="nc" id="L20077">                            surplus = desiredRearRepair - rearRepair;</span>
                            // try to move any excess points from rear to front
<span class="nc" id="L20079">                            frontRepair = Math.min(availableFrontRepair, frontRepair + surplus);</span>
                        }

<span class="nc bnc" id="L20082" title="All 2 branches missed.">                        if (frontRepair &gt; 0) {</span>
<span class="nc" id="L20083">                            me.setArmor(me.getArmor(loc) + frontRepair, loc);</span>
<span class="nc bnc" id="L20084" title="All 2 branches missed.">                            r = new Report(harJelII ? 9850 : 9851);</span>
<span class="nc" id="L20085">                            r.subject = me.getId();</span>
<span class="nc" id="L20086">                            r.addDesc(entity);</span>
<span class="nc" id="L20087">                            r.add(frontRepair);</span>
<span class="nc" id="L20088">                            r.add(me.getLocationAbbr(loc));</span>
<span class="nc" id="L20089">                            addReport(r);</span>
                        }
<span class="nc bnc" id="L20091" title="All 2 branches missed.">                        if (rearRepair &gt; 0) {</span>
<span class="nc" id="L20092">                            me.setArmor(me.getArmor(loc, true) + rearRepair, loc, true);</span>
<span class="nc bnc" id="L20093" title="All 2 branches missed.">                            r = new Report(harJelII ? 9850 : 9851);</span>
<span class="nc" id="L20094">                            r.subject = me.getId();</span>
<span class="nc" id="L20095">                            r.addDesc(entity);</span>
<span class="nc" id="L20096">                            r.add(rearRepair);</span>
<span class="nc" id="L20097">                            r.add(me.getLocationAbbr(loc) + &quot; (R)&quot;);</span>
<span class="nc" id="L20098">                            addReport(r);</span>
                        }
<span class="nc" id="L20100">                    } else {</span>
                        // must have at least one remaining armor in location
<span class="nc bnc" id="L20102" title="All 2 branches missed.">                        if (!(me.getArmor(loc) &gt; 0)) {</span>
<span class="nc" id="L20103">                            continue;</span>
                        }
<span class="nc bnc" id="L20105" title="All 2 branches missed.">                        int toRepair = harJelII ? 2 : 4;</span>
<span class="nc" id="L20106">                        toRepair = Math.min(toRepair, me.getOArmor(loc) - me.getArmor(loc));</span>
<span class="nc" id="L20107">                        me.setArmor(me.getArmor(loc) + toRepair, loc);</span>
<span class="nc bnc" id="L20108" title="All 2 branches missed.">                        r = new Report(harJelII ? 9850 : 9851);</span>
<span class="nc" id="L20109">                        r.subject = me.getId();</span>
<span class="nc" id="L20110">                        r.addDesc(entity);</span>
<span class="nc" id="L20111">                        r.add(toRepair);</span>
<span class="nc" id="L20112">                        r.add(me.getLocationAbbr(loc));</span>
<span class="nc" id="L20113">                        addReport(r);</span>
                    }
                }
            }
<span class="nc" id="L20117">        }</span>
<span class="nc" id="L20118">    }</span>

    /**
     * Resolve Flaming Damage for the given Entity Taharqa: This is now updated
     * to TacOps rules which is much more lenient So I have change the name to
     * Flaming Damage rather than flaming death
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; that may experience flaming damage.
     */
    private void doFlamingDamage(Entity entity) {
        Report r;
<span class="nc" id="L20129">        int boomRoll = Compute.d6(2);</span>

<span class="nc bnc" id="L20131" title="All 2 branches missed.">        if ((entity.getMovementMode() == EntityMovementMode.VTOL)</span>
<span class="nc bnc" id="L20132" title="All 2 branches missed.">                &amp;&amp; !entity.infernos.isStillBurning()) {</span>
            // VTOLs don't check as long as they are flying higher than
            // the burning terrain. TODO : Check for rules conformity (ATPM?)
            // according to maxtech, elevation 0 or 1 should be affected,
            // this makes sense for level 2 as well

<span class="nc bnc" id="L20138" title="All 2 branches missed.">            if (entity.getElevation() &gt; 1) {</span>
<span class="nc" id="L20139">                return;</span>
            }
        }
        // Battle Armor squads equipped with fire protection
        // gear automatically avoid flaming damage
        // TODO : can conventional infantry mount fire-resistant armor?
<span class="nc bnc" id="L20145" title="All 2 branches missed.">        if ((entity instanceof BattleArmor)</span>
<span class="nc bnc" id="L20146" title="All 2 branches missed.">            &amp;&amp; ((BattleArmor) entity).isFireResistant()) {</span>
<span class="nc" id="L20147">            r = new Report(5095);</span>
<span class="nc" id="L20148">            r.subject = entity.getId();</span>
<span class="nc" id="L20149">            r.indent(1);</span>
<span class="nc" id="L20150">            r.addDesc(entity);</span>
<span class="nc" id="L20151">            addReport(r);</span>
<span class="nc" id="L20152">            return;</span>
        }

        // mechs shouldn't be here, but just in case
<span class="nc bnc" id="L20156" title="All 2 branches missed.">        if (entity instanceof Mech) {</span>
<span class="nc" id="L20157">            return;</span>
        }

        // fire has no effect on dropships
<span class="nc bnc" id="L20161" title="All 2 branches missed.">        if (entity instanceof Dropship) {</span>
<span class="nc" id="L20162">            return;</span>
        }

        // Must roll 8+ to survive...
<span class="nc" id="L20166">        r = new Report(5100);</span>
<span class="nc" id="L20167">        r.subject = entity.getId();</span>
<span class="nc" id="L20168">        r.newlines = 0;</span>
<span class="nc" id="L20169">        r.addDesc(entity);</span>
<span class="nc" id="L20170">        r.add(boomRoll);</span>
<span class="nc bnc" id="L20171" title="All 2 branches missed.">        if (boomRoll &gt;= 8) {</span>
            // phew!
<span class="nc" id="L20173">            r.choose(true);</span>
<span class="nc" id="L20174">            addReport(r);</span>
<span class="nc" id="L20175">            Report.addNewline(vPhaseReport);</span>
        } else {
            // eek
<span class="nc" id="L20178">            r.choose(false);</span>
<span class="nc" id="L20179">            r.newlines = 1;</span>
<span class="nc" id="L20180">            addReport(r);</span>
            // gun emplacements have their own critical rules
<span class="nc bnc" id="L20182" title="All 2 branches missed.">            if (entity instanceof GunEmplacement) {</span>
<span class="nc" id="L20183">                Vector&lt;GunEmplacement&gt; gun = new Vector&lt;&gt;();</span>
<span class="nc" id="L20184">                gun.add((GunEmplacement) entity);</span>
                
<span class="nc" id="L20186">                Building building = getGame().getBoard().getBuildingAt(entity.getPosition());</span>
                
<span class="nc" id="L20188">                Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L20189">                addReport(criticalGunEmplacement(gun, building, entity.getPosition()));            </span>
            // Taharqa: TacOps rules, protos and vees no longer die instantly
            // (hurray!)
<span class="nc bnc" id="L20192" title="All 2 branches missed.">            } else if (entity instanceof Tank) {</span>
<span class="nc" id="L20193">                int bonus = -2;</span>
<span class="nc bnc" id="L20194" title="All 4 branches missed.">                if ((entity instanceof SupportTank)</span>
                    || (entity instanceof SupportVTOL)) {
<span class="nc" id="L20196">                    bonus = 0;</span>
                }
                // roll a critical hit
<span class="nc" id="L20199">                Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L20200">                addReport(criticalTank((Tank) entity, Tank.LOC_FRONT, bonus, 0, true));</span>
<span class="nc bnc" id="L20201" title="All 2 branches missed.">            } else if (entity instanceof Protomech) {</span>
                // this code is taken from inferno hits
<span class="nc" id="L20203">                HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc bnc" id="L20204" title="All 2 branches missed.">                if (hit.getLocation() == Protomech.LOC_NMISS) {</span>
<span class="nc" id="L20205">                    Protomech proto = (Protomech) entity;</span>
<span class="nc" id="L20206">                    r = new Report(6035);</span>
<span class="nc" id="L20207">                    r.subject = entity.getId();</span>
<span class="nc" id="L20208">                    r.indent(2);</span>
<span class="nc bnc" id="L20209" title="All 2 branches missed.">                    if (proto.isGlider()) {</span>
<span class="nc" id="L20210">                        r.messageId = 6036;</span>
<span class="nc" id="L20211">                        proto.setWingHits(proto.getWingHits() + 1);</span>
                    }
<span class="nc" id="L20213">                    addReport(r);</span>
<span class="nc" id="L20214">                } else {</span>
<span class="nc" id="L20215">                    r = new Report(6690);</span>
<span class="nc" id="L20216">                    r.subject = entity.getId();</span>
<span class="nc" id="L20217">                    r.indent(1);</span>
<span class="nc" id="L20218">                    r.add(entity.getLocationName(hit));</span>
<span class="nc" id="L20219">                    addReport(r);</span>
<span class="nc" id="L20220">                    entity.destroyLocation(hit.getLocation());</span>
                    // Handle ProtoMech pilot damage due to location destruction
<span class="nc" id="L20222">                    int hits = Protomech.POSSIBLE_PILOT_DAMAGE[hit.getLocation()]</span>
<span class="nc" id="L20223">                               - ((Protomech) entity).getPilotDamageTaken(hit.getLocation());</span>
<span class="nc bnc" id="L20224" title="All 2 branches missed.">                    if (hits &gt; 0) {</span>
<span class="nc" id="L20225">                        addReport(damageCrew(entity, hits));</span>
<span class="nc" id="L20226">                        ((Protomech) entity).setPilotDamageTaken(hit.getLocation(),</span>
<span class="nc" id="L20227">                                Protomech.POSSIBLE_PILOT_DAMAGE[hit.getLocation()]);</span>
                    }
<span class="nc bnc" id="L20229" title="All 2 branches missed.">                    if (entity.getTransferLocation(hit).getLocation() == Entity.LOC_DESTROYED) {</span>
<span class="nc" id="L20230">                        addReport(destroyEntity(entity, &quot;flaming death&quot;, false, true));</span>
<span class="nc" id="L20231">                        Report.addNewline(vPhaseReport);</span>
                    }
                }
<span class="nc" id="L20234">            } else {</span>
                // sucks to be you
<span class="nc" id="L20236">                addReport(destroyEntity(entity, &quot;fire&quot;, false, false));</span>
<span class="nc" id="L20237">                Report.addNewline(vPhaseReport);</span>
            }
        }
<span class="nc" id="L20240">    }</span>

    private void clearFlawedCoolingFlags(Entity entity) {
        // If we're not using quirks, no need to do this check.
<span class="nc bnc" id="L20244" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.ADVANCED_STRATOPS_QUIRKS)) {</span>
<span class="nc" id="L20245">            return;</span>
        }
        // Only applies to Mechs.
<span class="nc bnc" id="L20248" title="All 2 branches missed.">        if (!(entity instanceof Mech)) {</span>
<span class="nc" id="L20249">            return;</span>
        }

        // Check for existence of flawed cooling quirk.
<span class="nc bnc" id="L20253" title="All 2 branches missed.">        if (!entity.hasQuirk(OptionsConstants.QUIRK_NEG_FLAWED_COOLING)) {</span>
<span class="nc" id="L20254">            return;</span>
        }
<span class="nc" id="L20256">        entity.setFallen(false);</span>
<span class="nc" id="L20257">        entity.setStruck(false);</span>
<span class="nc" id="L20258">    }</span>

    private void checkForFlawedCooling() {

        // If we're not using quirks, no need to do this check.
<span class="nc bnc" id="L20263" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.ADVANCED_STRATOPS_QUIRKS)) {</span>
<span class="nc" id="L20264">            return;</span>
        }

<span class="nc bnc" id="L20267" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L20268">            final Entity entity = i.next();</span>

            // Only applies to Mechs.
<span class="nc bnc" id="L20271" title="All 2 branches missed.">            if (!(entity instanceof Mech)) {</span>
<span class="nc" id="L20272">                continue;</span>
            }

            // Check for existence of flawed cooling quirk.
<span class="nc bnc" id="L20276" title="All 2 branches missed.">            if (!entity.hasQuirk(OptionsConstants.QUIRK_NEG_FLAWED_COOLING)) {</span>
<span class="nc" id="L20277">                continue;</span>
            }

            // Check for active Cooling Flaw
<span class="nc bnc" id="L20281" title="All 2 branches missed.">            if (((Mech) entity).isCoolingFlawActive()) {</span>
<span class="nc" id="L20282">                continue;</span>
            }

            // Perform the check.
<span class="nc bnc" id="L20286" title="All 2 branches missed.">            if (entity.damageThisPhase &gt;= 20) {</span>
<span class="nc" id="L20287">                addReport(doFlawedCoolingCheck(&quot;20+ damage&quot;, entity));</span>
            }
<span class="nc bnc" id="L20289" title="All 2 branches missed.">            if (entity.hasFallen()) {</span>
<span class="nc" id="L20290">                addReport(doFlawedCoolingCheck(&quot;fall&quot;, entity));</span>
            }
<span class="nc bnc" id="L20292" title="All 2 branches missed.">            if (entity.wasStruck()) {</span>
<span class="nc" id="L20293">                addReport(doFlawedCoolingCheck(&quot;being struck&quot;, entity));</span>
            }
<span class="nc" id="L20295">            clearFlawedCoolingFlags(entity);</span>
<span class="nc" id="L20296">        }</span>
<span class="nc" id="L20297">    }</span>

    /**
     * Checks to see if Flawed Cooling is triggered and generates a report of
     * the result.
     *
     * @param reason
     * @param entity
     * @return
     */
    private Vector&lt;Report&gt; doFlawedCoolingCheck(String reason, Entity entity) {
<span class="nc" id="L20308">        Vector&lt;Report&gt; out = new Vector&lt;&gt;();</span>
<span class="nc" id="L20309">        Report r = new Report(9800);</span>
<span class="nc" id="L20310">        r.addDesc(entity);</span>
<span class="nc" id="L20311">        r.add(reason);</span>
<span class="nc" id="L20312">        int roll = Compute.d6(2);</span>
<span class="nc" id="L20313">        r.add(roll);</span>
<span class="nc" id="L20314">        out.add(r);</span>
<span class="nc bnc" id="L20315" title="All 2 branches missed.">        if (roll &gt;= 10) {</span>
<span class="nc" id="L20316">            Report s = new Report(9805);</span>
<span class="nc" id="L20317">            ((Mech) entity).setCoolingFlawActive(true);</span>
<span class="nc" id="L20318">            out.add(s);</span>
        }

<span class="nc" id="L20321">        return out;</span>
    }

    /**
     * For chain whip grapples, a roll needs to be made at the end of the
     * physical phase to maintain the grapple.
     */
    private void checkForChainWhipGrappleChecks() {
<span class="nc bnc" id="L20329" title="All 2 branches missed.">        for (Entity ae : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L20330" title="All 4 branches missed.">            if ((ae.getGrappled() != Entity.NONE) &amp;&amp; ae.isChainWhipGrappled()</span>
<span class="nc bnc" id="L20331" title="All 4 branches missed.">                    &amp;&amp; ae.isGrappleAttacker() &amp;&amp; !ae.isGrappledThisRound()) {</span>
<span class="nc" id="L20332">                Entity te = game.getEntity(ae.getGrappled());</span>
<span class="nc" id="L20333">                ToHitData grappleHit = GrappleAttackAction.toHit(game,</span>
<span class="nc" id="L20334">                        ae.getId(), te, ae.getGrappleSide(), true);</span>
<span class="nc" id="L20335">                int roll = Compute.d6(2);</span>

<span class="nc" id="L20337">                Report r = new Report(4317);</span>
<span class="nc" id="L20338">                r.subject = ae.getId();</span>
<span class="nc" id="L20339">                r.indent();</span>
<span class="nc" id="L20340">                r.addDesc(ae);</span>
<span class="nc" id="L20341">                r.addDesc(te);</span>
<span class="nc" id="L20342">                r.newlines = 0;</span>
<span class="nc" id="L20343">                addReport(r);</span>

<span class="nc bnc" id="L20345" title="All 2 branches missed.">                if (grappleHit.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L20346">                    r = new Report(4300);</span>
<span class="nc" id="L20347">                    r.subject = ae.getId();</span>
<span class="nc" id="L20348">                    r.add(grappleHit.getDesc());</span>
<span class="nc" id="L20349">                    addReport(r);</span>
<span class="nc" id="L20350">                    return;</span>
                }

                // report the roll
<span class="nc" id="L20354">                r = new Report(4025);</span>
<span class="nc" id="L20355">                r.subject = ae.getId();</span>
<span class="nc" id="L20356">                r.add(grappleHit.getValue());</span>
<span class="nc" id="L20357">                r.add(roll);</span>
<span class="nc" id="L20358">                r.newlines = 0;</span>
<span class="nc" id="L20359">                addReport(r);</span>

                // do we hit?
<span class="nc bnc" id="L20362" title="All 2 branches missed.">                if (roll &gt;= grappleHit.getValue()) {</span>
                    // hit
<span class="nc" id="L20364">                    r = new Report(4040);</span>
<span class="nc" id="L20365">                    r.subject = ae.getId();</span>
<span class="nc" id="L20366">                    addReport(r);</span>
                    // Nothing else to do
<span class="nc" id="L20368">                    return;</span>
                }

                // miss
<span class="nc" id="L20372">                r = new Report(4035);</span>
<span class="nc" id="L20373">                r.subject = ae.getId();</span>
<span class="nc" id="L20374">                addReport(r);</span>

                // Need to break grapple
<span class="nc" id="L20377">                ae.setGrappled(Entity.NONE, false);</span>
<span class="nc" id="L20378">                te.setGrappled(Entity.NONE, false);</span>
            }
<span class="nc" id="L20380">        }</span>
<span class="nc" id="L20381">    }</span>

    /**
     * Checks to see if any entity takes enough damage that requires them to
     * make a piloting roll
     */
    private void checkForPSRFromDamage() {
<span class="nc bnc" id="L20388" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L20389">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20390" title="All 2 branches missed.">            if (entity.canFall()) {</span>
<span class="nc bnc" id="L20391" title="All 2 branches missed.">                if (entity.isAirborne()) {</span>
                    // you can't fall over when you are combat dropping because
                    // you are already falling!
<span class="nc" id="L20394">                    continue;</span>
                }
                // if this mech has 20+ damage, add another roll to the list.
                // Hulldown 'mechs ignore this rule, TO Errata
<span class="nc" id="L20398">                int psrThreshold = 20;</span>
<span class="nc bnc" id="L20399" title="All 2 branches missed.">                if (((Mech) entity).getCockpitType() == Mech.COCKPIT_DUAL</span>
<span class="nc bnc" id="L20400" title="All 2 branches missed.">                        &amp;&amp; entity.getCrew().hasDedicatedPilot()) {</span>
<span class="nc" id="L20401">                    psrThreshold = 30;</span>
                }
<span class="nc bnc" id="L20403" title="All 4 branches missed.">                if ((entity.damageThisPhase &gt;= psrThreshold) &amp;&amp; !entity.isHullDown()) {</span>
<span class="nc bnc" id="L20404" title="All 2 branches missed.">                    if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_TACOPS_TAKING_DAMAGE)) {</span>
<span class="nc" id="L20405">                        PilotingRollData damPRD = new PilotingRollData(entity.getId());</span>
<span class="nc" id="L20406">                        int damMod = entity.damageThisPhase / psrThreshold;</span>
<span class="nc" id="L20407">                        damPRD.addModifier(damMod, (damMod * psrThreshold) + &quot;+ damage&quot;);</span>
<span class="nc" id="L20408">                        int weightMod = 0;</span>
<span class="nc bnc" id="L20409" title="All 2 branches missed.">                        if (game.getOptions().booleanOption(</span>
                                OptionsConstants.ADVGRNDMOV_TACOPS_PHYSICAL_PSR)) {
<span class="nc bnc" id="L20411" title="All 5 branches missed.">                            switch (entity.getWeightClass()) {</span>
                                case EntityWeightClass.WEIGHT_LIGHT:
<span class="nc" id="L20413">                                    weightMod = 1;</span>
<span class="nc" id="L20414">                                    break;</span>
                                case EntityWeightClass.WEIGHT_MEDIUM:
<span class="nc" id="L20416">                                    weightMod = 0;</span>
<span class="nc" id="L20417">                                    break;</span>
                                case EntityWeightClass.WEIGHT_HEAVY:
<span class="nc" id="L20419">                                    weightMod = -1;</span>
<span class="nc" id="L20420">                                    break;</span>
                                case EntityWeightClass.WEIGHT_ASSAULT:
<span class="nc" id="L20422">                                    weightMod = -2;</span>
                                    break;
                            }
<span class="nc bnc" id="L20425" title="All 4 branches missed.">                            if ((entity instanceof Mech) &amp;&amp; entity.isSuperHeavy()) {</span>
<span class="nc" id="L20426">                                weightMod = -4;</span>
                            }
                            // the weight class PSR modifier is not cumulative
<span class="nc" id="L20429">                            damPRD.addModifier(weightMod,</span>
                                               &quot;weight class modifier&quot;, false);
                        }
<span class="nc bnc" id="L20432" title="All 2 branches missed.">                        if (entity.hasQuirk(OptionsConstants.QUIRK_POS_EASY_PILOT)</span>
<span class="nc bnc" id="L20433" title="All 2 branches missed.">                            &amp;&amp; (entity.getCrew().getPiloting() &gt; 3)) {</span>
<span class="nc" id="L20434">                            damPRD.addModifier(-1, &quot;easy to pilot&quot;);</span>
                        }
<span class="nc" id="L20436">                        game.addPSR(damPRD);</span>
<span class="nc" id="L20437">                    } else {</span>
<span class="nc" id="L20438">                        PilotingRollData damPRD = new PilotingRollData(</span>
<span class="nc" id="L20439">                                entity.getId(), 1, psrThreshold + &quot;+ damage&quot;);</span>
<span class="nc bnc" id="L20440" title="All 2 branches missed.">                        if (entity.hasQuirk(OptionsConstants.QUIRK_POS_EASY_PILOT)</span>
<span class="nc bnc" id="L20441" title="All 2 branches missed.">                            &amp;&amp; (entity.getCrew().getPiloting() &gt; 3)) {</span>
<span class="nc" id="L20442">                            damPRD.addModifier(-1, &quot;easy to pilot&quot;);</span>
                        }
<span class="nc" id="L20444">                        game.addPSR(damPRD);</span>
                    }
                }
            }
<span class="nc bnc" id="L20448" title="All 6 branches missed.">            if (entity.isAero() &amp;&amp; entity.isAirborne() &amp;&amp; !game.getBoard().inSpace()) {</span>
                // if this aero has any damage, add another roll to the list.
<span class="nc bnc" id="L20450" title="All 2 branches missed.">                if (entity.damageThisPhase &gt; 0) {</span>
<span class="nc bnc" id="L20451" title="All 2 branches missed.">                    if (!game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_ATMOSPHERIC_CONTROL)) {</span>
<span class="nc" id="L20452">                        int damMod = entity.damageThisPhase / 20;</span>
<span class="nc" id="L20453">                        PilotingRollData damPRD = new PilotingRollData(entity.getId(), damMod, entity.damageThisPhase + &quot; damage +&quot; + damMod);</span>
<span class="nc bnc" id="L20454" title="All 2 branches missed.">                        if (entity.hasQuirk(OptionsConstants.QUIRK_POS_EASY_PILOT)</span>
<span class="nc bnc" id="L20455" title="All 2 branches missed.">                                &amp;&amp; (entity.getCrew().getPiloting() &gt; 3)) {</span>
<span class="nc" id="L20456">                            damPRD.addModifier(-1, &quot;easy to pilot&quot;);</span>
                        }
<span class="nc" id="L20458">                        game.addControlRoll(damPRD);</span>
<span class="nc" id="L20459">                    } else {</span>
                        // was the damage threshold exceeded this round?
<span class="nc bnc" id="L20461" title="All 2 branches missed.">                        if (((IAero) entity).wasCritThresh()) {</span>
<span class="nc" id="L20462">                            PilotingRollData damThresh = new PilotingRollData(entity.getId(), 0,</span>
                                    &quot;damage threshold exceeded&quot;);
<span class="nc bnc" id="L20464" title="All 2 branches missed.">                            if (entity.hasQuirk(OptionsConstants.QUIRK_POS_EASY_PILOT)</span>
<span class="nc bnc" id="L20465" title="All 2 branches missed.">                                    &amp;&amp; (entity.getCrew().getPiloting() &gt; 3)) {</span>
<span class="nc" id="L20466">                                damThresh.addModifier(-1, &quot;easy to pilot&quot;);</span>
                            }
<span class="nc" id="L20468">                            game.addControlRoll(damThresh);</span>
                        }
                    }
                }
            }
            // Airborne AirMechs that take 20+ damage make a control roll instead of a PSR.
<span class="nc bnc" id="L20474" title="All 6 branches missed.">            if (entity instanceof LandAirMech &amp;&amp; entity.isAirborneVTOLorWIGE()</span>
                    &amp;&amp; entity.damageThisPhase &gt;= 20) {
<span class="nc" id="L20476">                PilotingRollData damPRD = new PilotingRollData(entity.getId());</span>
<span class="nc" id="L20477">                int damMod = entity.damageThisPhase / 20;</span>
<span class="nc" id="L20478">                damPRD.addModifier(damMod, (damMod * 20) + &quot;+ damage&quot;);</span>
<span class="nc" id="L20479">                game.addControlRoll(damPRD);</span>
            }
<span class="nc" id="L20481">        }</span>
<span class="nc" id="L20482">    }</span>

    /**
     * Checks to see if any non-mech units are standing in fire. Called at the
     * end of the movement phase
     */
    public void checkForFlamingDamage() {
<span class="nc bnc" id="L20489" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext();) {</span>
<span class="nc" id="L20490">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20491" title="All 4 branches missed.">            if ((null == entity.getPosition()) || (entity instanceof Mech)</span>
<span class="nc bnc" id="L20492" title="All 6 branches missed.">                    || entity.isDoomed() || entity.isDestroyed() || entity.isOffBoard()) {</span>
<span class="nc" id="L20493">                continue;</span>
            }
<span class="nc" id="L20495">            final IHex curHex = game.getBoard().getHex(entity.getPosition());</span>
<span class="nc bnc" id="L20496" title="All 2 branches missed.">            final boolean underwater = curHex.containsTerrain(Terrains.WATER)</span>
<span class="nc bnc" id="L20497" title="All 2 branches missed.">                    &amp;&amp; (curHex.depth() &gt; 0)</span>
<span class="nc bnc" id="L20498" title="All 2 branches missed.">                    &amp;&amp; (entity.getElevation() &lt; curHex.surface());</span>
<span class="nc" id="L20499">            final int numFloors = curHex.terrainLevel(Terrains.BLDG_ELEV);</span>
<span class="nc bnc" id="L20500" title="All 4 branches missed.">            if (curHex.containsTerrain(Terrains.FIRE) &amp;&amp; !underwater</span>
<span class="nc bnc" id="L20501" title="All 2 branches missed.">                    &amp;&amp; ((entity.getElevation() &lt;= 1)</span>
<span class="nc bnc" id="L20502" title="All 2 branches missed.">                            || (entity.getElevation() &lt;= numFloors))) {</span>
<span class="nc" id="L20503">                doFlamingDamage(entity);</span>
            }
<span class="nc" id="L20505">        }</span>
<span class="nc" id="L20506">    }</span>

    /**
     * Checks to see if any telemissiles are in a hex with enemy units. If so,
     * then attack one.
     */
    private void checkForTeleMissileAttacks() {
<span class="nc bnc" id="L20513" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext();) {</span>
<span class="nc" id="L20514">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20515" title="All 2 branches missed.">            if (entity instanceof TeleMissile) {</span>
                // check for enemy units
<span class="nc" id="L20517">                Vector&lt;Integer&gt; potTargets = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L20518" title="All 2 branches missed.">                for (Entity te : game.getEntitiesVector(entity.getPosition())) {</span>
                    //Telemissiles cannot target fighters or other telemissiles
                    //Fighters don't have a distinctive Etype flag, so we have to do
                    //this by exclusion.
<span class="nc bnc" id="L20522" title="All 2 branches missed.">                    if (!(te.hasETypeFlag(Entity.ETYPE_DROPSHIP)</span>
<span class="nc bnc" id="L20523" title="All 2 branches missed.">                            || te.hasETypeFlag(Entity.ETYPE_SMALL_CRAFT)</span>
<span class="nc bnc" id="L20524" title="All 2 branches missed.">                            || te.hasETypeFlag(Entity.ETYPE_JUMPSHIP)</span>
<span class="nc bnc" id="L20525" title="All 2 branches missed.">                            || te.hasETypeFlag(Entity.ETYPE_WARSHIP)</span>
<span class="nc bnc" id="L20526" title="All 2 branches missed.">                            || te.hasETypeFlag(Entity.ETYPE_SPACE_STATION))) {</span>
<span class="nc" id="L20527">                        continue;</span>
                    }
<span class="nc bnc" id="L20529" title="All 2 branches missed.">                    if (te.isEnemyOf(entity)) {</span>
                        // then add it to a vector of potential targets
<span class="nc" id="L20531">                        potTargets.add(te.getId());</span>
                    }
<span class="nc" id="L20533">                }</span>
<span class="nc bnc" id="L20534" title="All 2 branches missed.">                if (potTargets.size() &gt; 0) {</span>
                    // determine randomly
<span class="nc" id="L20536">                    Entity target = game.getEntity(potTargets.get(Compute</span>
<span class="nc" id="L20537">                            .randomInt(potTargets.size())));</span>
                    // report this and add a new TeleMissileAttackAction
<span class="nc" id="L20539">                    Report r = new Report(9085);</span>
<span class="nc" id="L20540">                    r.subject = entity.getId();</span>
<span class="nc" id="L20541">                    r.addDesc(entity);</span>
<span class="nc" id="L20542">                    r.addDesc(target);</span>
<span class="nc" id="L20543">                    addReport(r);</span>
<span class="nc" id="L20544">                    game.addTeleMissileAttack(new TeleMissileAttackAction(entity, target));</span>
                }
            }
<span class="nc" id="L20547">        }</span>
<span class="nc" id="L20548">    }</span>

    private void checkForBlueShieldDamage() {
        Report r;
<span class="nc bnc" id="L20552" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L20553">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20554" title="All 4 branches missed.">            if (!(entity instanceof Aero) &amp;&amp; entity.hasActiveBlueShield()</span>
<span class="nc bnc" id="L20555" title="All 2 branches missed.">                &amp;&amp; (entity.getBlueShieldRounds() &gt;= 6)) {</span>
<span class="nc" id="L20556">                int roll = Compute.d6(2);</span>
<span class="nc" id="L20557">                int target = (3 + entity.getBlueShieldRounds()) - 6;</span>
<span class="nc" id="L20558">                r = new Report(1240);</span>
<span class="nc" id="L20559">                r.addDesc(entity);</span>
<span class="nc" id="L20560">                r.add(target);</span>
<span class="nc" id="L20561">                r.add(roll);</span>
<span class="nc bnc" id="L20562" title="All 2 branches missed.">                if (roll &lt; target) {</span>
<span class="nc bnc" id="L20563" title="All 2 branches missed.">                    for (Mounted m : entity.getMisc()) {</span>
<span class="nc bnc" id="L20564" title="All 2 branches missed.">                        if (m.getType().hasFlag(MiscType.F_BLUE_SHIELD)) {</span>
<span class="nc" id="L20565">                            m.setBreached(true);</span>
                        }
<span class="nc" id="L20567">                    }</span>
<span class="nc" id="L20568">                    r.choose(true);</span>
                } else {
<span class="nc" id="L20570">                    r.choose(false);</span>
                }
<span class="nc" id="L20572">                vPhaseReport.add(r);</span>
            }
<span class="nc" id="L20574">        }</span>
<span class="nc" id="L20575">    }</span>

    /**
     * Check to see if anyone dies due to being in certain planetary conditions.
     */
    private void checkForConditionDeath() {
        Report r;
<span class="nc bnc" id="L20582" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L20583">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20584" title="All 6 branches missed.">            if ((null == entity.getPosition()) &amp;&amp; !entity.isOffBoard() || (entity.getTransportId() != Entity.NONE)) {</span>
                // Ignore transported units, and units that don't have a position for some unknown reason
<span class="nc" id="L20586">                continue;</span>
            }
<span class="nc" id="L20588">            String reason = game.getPlanetaryConditions().whyDoomed(entity, game);</span>
<span class="nc bnc" id="L20589" title="All 2 branches missed.">            if (null != reason) {</span>
<span class="nc" id="L20590">                r = new Report(6015);</span>
<span class="nc" id="L20591">                r.subject = entity.getId();</span>
<span class="nc" id="L20592">                r.addDesc(entity);</span>
<span class="nc" id="L20593">                r.add(reason);</span>
<span class="nc" id="L20594">                addReport(r);</span>
<span class="nc" id="L20595">                addReport(destroyEntity(entity, reason, true, true));</span>
            }
<span class="nc" id="L20597">        }</span>
<span class="nc" id="L20598">    }</span>

    /**
     * Check to see if anyone dies due to being in atmosphere.
     */
    private void checkForAtmosphereDeath() {
        Report r;
<span class="nc bnc" id="L20605" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext();) {</span>
<span class="nc" id="L20606">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20607" title="All 4 branches missed.">            if ((null == entity.getPosition()) || entity.isOffBoard()) {</span>
                // If it's not on the board - aboard something else, for
                // example...
<span class="nc" id="L20610">                continue;</span>
            }
<span class="nc bnc" id="L20612" title="All 4 branches missed.">            if (entity.doomedInAtmosphere() &amp;&amp; (entity.getAltitude() == 0)) {</span>
<span class="nc" id="L20613">                r = new Report(6016);</span>
<span class="nc" id="L20614">                r.subject = entity.getId();</span>
<span class="nc" id="L20615">                r.addDesc(entity);</span>
<span class="nc" id="L20616">                addReport(r);</span>
<span class="nc" id="L20617">                addReport(destroyEntity(entity,</span>
                        &quot;being in atmosphere where it can't survive&quot;, true,
                        true));
            }
<span class="nc" id="L20621">        }</span>
<span class="nc" id="L20622">    }</span>

    /**
     * checks if IndustrialMechs should die because they moved into to-deep
     * water last round
     */
    private void checkForIndustrialWaterDeath() {
<span class="nc bnc" id="L20629" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext();) {</span>
<span class="nc" id="L20630">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20631" title="All 4 branches missed.">            if ((null == entity.getPosition()) || entity.isOffBoard()) {</span>
                // If it's not on the board - aboard something else, for
                // example...
<span class="nc" id="L20634">                continue;</span>
            }
<span class="nc bnc" id="L20636" title="All 4 branches missed.">            if ((entity instanceof Mech) &amp;&amp; ((Mech) entity).isIndustrial()</span>
<span class="nc bnc" id="L20637" title="All 2 branches missed.">                    &amp;&amp; ((Mech) entity).shouldDieAtEndOfTurnBecauseOfWater()) {</span>
<span class="nc" id="L20638">                addReport(destroyEntity(entity,</span>
                        &quot;being in water without environmental shielding&quot;, true,
                        true));
            }

<span class="nc" id="L20643">        }</span>
<span class="nc" id="L20644">    }</span>

    private void checkForIndustrialEndOfTurn() {
<span class="nc" id="L20647">        checkForIndustrialWaterDeath();</span>
<span class="nc" id="L20648">        checkForIndustrialUnstall();</span>
<span class="nc" id="L20649">        checkForIndustrialCrit(); // This might hit an actuator or gyro, so...</span>
<span class="nc" id="L20650">        addReport(resolvePilotingRolls());</span>
<span class="nc" id="L20651">    }</span>

    private void checkForIndustrialUnstall() {
<span class="nc bnc" id="L20654" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L20655">            final Entity entity = i.next();</span>
<span class="nc" id="L20656">            entity.checkUnstall(vPhaseReport);</span>
<span class="nc" id="L20657">        }</span>
<span class="nc" id="L20658">    }</span>

    /**
     * industrial mechs might need to check for critical damage
     */
    private void checkForIndustrialCrit() {
<span class="nc bnc" id="L20664" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext();) {</span>
<span class="nc" id="L20665">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20666" title="All 4 branches missed.">            if ((entity instanceof Mech) &amp;&amp; ((Mech) entity).isIndustrial()) {</span>
<span class="nc" id="L20667">                Mech mech = (Mech) entity;</span>
                // should we check for critical damage?
<span class="nc bnc" id="L20669" title="All 2 branches missed.">                if (mech.isCheckForCrit()) {</span>
<span class="nc" id="L20670">                    Report r = new Report(5530);</span>
<span class="nc" id="L20671">                    r.addDesc(mech);</span>
<span class="nc" id="L20672">                    r.subject = mech.getId();</span>
<span class="nc" id="L20673">                    r.newlines = 0;</span>
<span class="nc" id="L20674">                    vPhaseReport.add(r);</span>
                    // for being hit by a physical weapon
<span class="nc bnc" id="L20676" title="All 2 branches missed.">                    if (mech.getLevelsFallen() == 0) {</span>
<span class="nc" id="L20677">                        r = new Report(5531);</span>
<span class="nc" id="L20678">                        r.subject = mech.getId();</span>
                        // or for falling
                    } else {
<span class="nc" id="L20681">                        r = new Report(5532);</span>
<span class="nc" id="L20682">                        r.subject = mech.getId();</span>
<span class="nc" id="L20683">                        r.add(mech.getLevelsFallen());</span>
                    }
<span class="nc" id="L20685">                    vPhaseReport.add(r);</span>
<span class="nc" id="L20686">                    HitData newHit = mech.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L20687">                    vPhaseReport.addAll(criticalEntity(mech,</span>
<span class="nc" id="L20688">                            newHit.getLocation(), newHit.isRear(),</span>
<span class="nc" id="L20689">                            mech.getLevelsFallen(), 0));</span>
                }
            }
<span class="nc" id="L20692">        }</span>
<span class="nc" id="L20693">    }</span>

    /**
     * Check to see if anyone dies due to being in space.
     */
    private void checkForSpaceDeath() {
        Report r;
<span class="nc bnc" id="L20700" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext();) {</span>
<span class="nc" id="L20701">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20702" title="All 4 branches missed.">            if ((null == entity.getPosition()) || entity.isOffBoard()) {</span>
                // If it's not on the board - aboard something else, for
                // example...
<span class="nc" id="L20705">                continue;</span>
            }
<span class="nc bnc" id="L20707" title="All 2 branches missed.">            if (entity.doomedInSpace()) {</span>
<span class="nc" id="L20708">                r = new Report(6017);</span>
<span class="nc" id="L20709">                r.subject = entity.getId();</span>
<span class="nc" id="L20710">                r.addDesc(entity);</span>
<span class="nc" id="L20711">                addReport(r);</span>
<span class="nc" id="L20712">                addReport(destroyEntity(entity,</span>
                        &quot;being in space where it can't survive&quot;, true, true));
            }
<span class="nc" id="L20715">        }</span>
<span class="nc" id="L20716">    }</span>

    /**
     * Checks to see if any entities are underwater (or in vacuum) with damaged
     * life support. Called during the end phase.
     */
    private void checkForSuffocation() {
<span class="nc bnc" id="L20723" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext();) {</span>
<span class="nc" id="L20724">            final Entity entity = i.next();</span>
<span class="nc bnc" id="L20725" title="All 4 branches missed.">            if ((null == entity.getPosition()) || entity.isOffBoard()) {</span>
<span class="nc" id="L20726">                continue;</span>
            }
<span class="nc" id="L20728">            final IHex curHex = game.getBoard().getHex(entity.getPosition());</span>
<span class="nc bnc" id="L20729" title="All 2 branches missed.">            if ((((entity.getElevation() &lt; 0) &amp;&amp; ((curHex</span>
<span class="nc bnc" id="L20730" title="All 2 branches missed.">                    .terrainLevel(Terrains.WATER) &gt; 1) || ((curHex</span>
<span class="nc bnc" id="L20731" title="All 4 branches missed.">                    .terrainLevel(Terrains.WATER) == 1) &amp;&amp; entity.isProne()))) || game</span>
<span class="nc bnc" id="L20732" title="All 2 branches missed.">                    .getPlanetaryConditions().isVacuum())</span>
<span class="nc bnc" id="L20733" title="All 2 branches missed.">                    &amp;&amp; (entity.getHitCriticals(CriticalSlot.TYPE_SYSTEM,</span>
                            Mech.SYSTEM_LIFE_SUPPORT, Mech.LOC_HEAD) &gt; 0)) {
<span class="nc" id="L20735">                Report r = new Report(6020);</span>
<span class="nc" id="L20736">                r.subject = entity.getId();</span>
<span class="nc" id="L20737">                r.addDesc(entity);</span>
<span class="nc" id="L20738">                addReport(r);</span>
<span class="nc" id="L20739">                addReport(damageCrew(entity, 1));</span>

            }
<span class="nc" id="L20742">        }</span>
<span class="nc" id="L20743">    }</span>

    /**
     * Iterates over all entities and gets rid of Narc pods attached to destroyed
     * or lost locations.
     */
    private void cleanupDestroyedNarcPods() {
<span class="nc bnc" id="L20750" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L20751">            i.next().clearDestroyedNarcPods();</span>
        }
<span class="nc" id="L20753">    }</span>

    /**
     * Resolves all built up piloting skill rolls. Used at end of weapons,
     * physical phases.
     */
    private Vector&lt;Report&gt; resolvePilotingRolls() {
<span class="nc" id="L20760">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L20761" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L20762">            vPhaseReport.addAll(resolvePilotingRolls(i.next()));</span>
        }
<span class="nc" id="L20764">        game.resetPSRs();</span>
<span class="nc" id="L20765">        return vPhaseReport;</span>
    }

    /**
     * Resolves and reports all piloting skill rolls for a single mech.
     */
    private Vector&lt;Report&gt; resolvePilotingRolls(Entity entity) {
<span class="nc" id="L20772">        return resolvePilotingRolls(entity, false, entity.getPosition(),</span>
<span class="nc" id="L20773">                                    entity.getPosition());</span>
    }

    private Vector&lt;Report&gt; resolvePilotingRolls(Entity entity, boolean moving,
                                                Coords src, Coords dest) {
<span class="nc" id="L20778">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
        // dead and undeployed and offboard units don't need to.
<span class="nc bnc" id="L20780" title="All 8 branches missed.">        if (entity.isDoomed() || entity.isDestroyed() || entity.isOffBoard() || !entity.isDeployed()</span>
<span class="nc bnc" id="L20781" title="All 2 branches missed.">                || (entity.getTransportId() != Entity.NONE)) {</span>
<span class="nc" id="L20782">            return vPhaseReport;</span>
        }

        // airborne units don't make piloting rolls, they make control rolls
<span class="nc bnc" id="L20786" title="All 2 branches missed.">        if (entity.isAirborne()) {</span>
<span class="nc" id="L20787">            return vPhaseReport;</span>
        }

        Report r;

        // first, do extreme gravity PSR, because non-mechs do these, too
<span class="nc" id="L20793">        PilotingRollData rollTarget = null;</span>
<span class="nc bnc" id="L20794" title="All 2 branches missed.">        for (Enumeration&lt;PilotingRollData&gt; i = game.getExtremeGravityPSRs(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L20795">            final PilotingRollData roll = i.nextElement();</span>
<span class="nc bnc" id="L20796" title="All 2 branches missed.">            if (roll.getEntityId() != entity.getId()) {</span>
<span class="nc" id="L20797">                continue;</span>
            }
            // found a roll, use it (there can be only 1 per entity)
<span class="nc" id="L20800">            rollTarget = roll;</span>
<span class="nc" id="L20801">            game.resetExtremeGravityPSRs(entity);</span>
<span class="nc" id="L20802">        }</span>
<span class="nc bnc" id="L20803" title="All 4 branches missed.">        if ((rollTarget != null) &amp;&amp; (rollTarget.getValue() != TargetRoll.CHECK_FALSE)) {</span>
            // okay, print the info
<span class="nc" id="L20805">            r = new Report(2180);</span>
<span class="nc" id="L20806">            r.subject = entity.getId();</span>
<span class="nc" id="L20807">            r.addDesc(entity);</span>
<span class="nc" id="L20808">            r.add(rollTarget.getLastPlainDesc());</span>
<span class="nc" id="L20809">            vPhaseReport.add(r);</span>
            // roll
<span class="nc" id="L20811">            final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L20812">            r = new Report(2190);</span>
<span class="nc" id="L20813">            r.subject = entity.getId();</span>
<span class="nc" id="L20814">            r.add(rollTarget.getValueAsString());</span>
<span class="nc" id="L20815">            r.add(rollTarget.getDesc());</span>
<span class="nc" id="L20816">            r.add(diceRoll);</span>
<span class="nc bnc" id="L20817" title="All 2 branches missed.">            if ((diceRoll &lt; rollTarget.getValue())</span>
<span class="nc bnc" id="L20818" title="All 4 branches missed.">                    || (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_FUMBLES)</span>
                    &amp;&amp; (diceRoll == 2))) {
<span class="nc" id="L20820">                r.choose(false);</span>
                // Report the fumble
<span class="nc bnc" id="L20822" title="All 4 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_FUMBLES)</span>
                    &amp;&amp; (diceRoll == 2)) {
<span class="nc" id="L20824">                    r.messageId = 2306;</span>
                }
<span class="nc" id="L20826">                vPhaseReport.add(r);</span>
                // walking and running, 1 damage per MP used more than we would
                // have normally
<span class="nc bnc" id="L20829" title="All 12 branches missed.">                if ((entity.moved == EntityMovementType.MOVE_WALK)</span>
                        || (entity.moved == EntityMovementType.MOVE_VTOL_WALK)
                        || (entity.moved == EntityMovementType.MOVE_RUN)
                        || (entity.moved == EntityMovementType.MOVE_SPRINT)
                        || (entity.moved == EntityMovementType.MOVE_VTOL_RUN)
                        || (entity.moved == EntityMovementType.MOVE_VTOL_SPRINT)) {
<span class="nc bnc" id="L20835" title="All 2 branches missed.">                    if (entity instanceof Mech) {</span>
<span class="nc" id="L20836">                        int j = entity.mpUsed;</span>
<span class="nc" id="L20837">                        int damage = 0;</span>
<span class="nc bnc" id="L20838" title="All 2 branches missed.">                        while (j &gt; entity.getRunningGravityLimit()) {</span>
<span class="nc" id="L20839">                            j--;</span>
<span class="nc" id="L20840">                            damage++;</span>
                        }
                        // Wee, direct internal damage
<span class="nc" id="L20843">                        vPhaseReport.addAll(doExtremeGravityDamage(entity,</span>
                                                                   damage));
<span class="nc bnc" id="L20845" title="All 2 branches missed.">                    } else if (entity instanceof Tank) {</span>
                        // if we got a pavement bonus, take care of it
<span class="nc bnc" id="L20847" title="All 2 branches missed.">                        int k = entity.gotPavementBonus ? 1 : 0;</span>
<span class="nc bnc" id="L20848" title="All 2 branches missed.">                        if (!entity.gotPavementBonus) {</span>
<span class="nc" id="L20849">                            int j = entity.mpUsed;</span>
<span class="nc" id="L20850">                            int damage = 0;</span>
<span class="nc bnc" id="L20851" title="All 2 branches missed.">                            while (j &gt; (entity.getRunMP(false, false, false) + k)) {</span>
<span class="nc" id="L20852">                                j--;</span>
<span class="nc" id="L20853">                                damage++;</span>
                            }
<span class="nc" id="L20855">                            vPhaseReport.addAll(doExtremeGravityDamage(entity,</span>
                                                                       damage));
                        }
                    }
                }
                // jumping
<span class="nc bnc" id="L20861" title="All 4 branches missed.">                if ((entity.moved == EntityMovementType.MOVE_JUMP)</span>
                    &amp;&amp; (entity instanceof Mech)) {
                    // low g, 1 damage for each hex jumped further than
                    // possible normally
<span class="nc bnc" id="L20865" title="All 2 branches missed.">                    if (game.getPlanetaryConditions().getGravity() &lt; 1) {</span>
<span class="nc" id="L20866">                        int j = entity.mpUsed;</span>
<span class="nc" id="L20867">                        int damage = 0;</span>
<span class="nc bnc" id="L20868" title="All 2 branches missed.">                        while (j &gt; entity.getJumpMP(false)) {</span>
<span class="nc" id="L20869">                            j--;</span>
<span class="nc" id="L20870">                            damage++;</span>
                        }
                        // Wee, direct internal damage
<span class="nc" id="L20873">                        vPhaseReport.addAll(doExtremeGravityDamage(entity,</span>
                                                                   damage));
<span class="nc" id="L20875">                    }</span>
                    // high g, 1 damage for each MP we have less than normally
<span class="nc bnc" id="L20877" title="All 2 branches missed.">                    else if (game.getPlanetaryConditions().getGravity() &gt; 1) {</span>
<span class="nc" id="L20878">                        int damage = entity.getWalkMP(false, false)</span>
<span class="nc" id="L20879">                                     - entity.getWalkMP();</span>
                        // Wee, direct internal damage
<span class="nc" id="L20881">                        vPhaseReport.addAll(doExtremeGravityDamage(entity,</span>
                                                                   damage));
                    }
                }
                // failed a PSR, check for ICE engine stalling
<span class="nc" id="L20886">                entity.doCheckEngineStallRoll(vPhaseReport);</span>
            } else {
<span class="nc" id="L20888">                r.choose(true);</span>
<span class="nc" id="L20889">                vPhaseReport.add(r);</span>
            }
        }

        // Glider ProtoMechs without sufficient movement to stay airborne make forced landings.
<span class="nc bnc" id="L20894" title="All 4 branches missed.">        if ((entity instanceof Protomech) &amp;&amp; ((Protomech)entity).isGlider()</span>
<span class="nc bnc" id="L20895" title="All 4 branches missed.">                &amp;&amp; entity.isAirborneVTOLorWIGE() &amp;&amp; (entity.getRunMP() &lt; 4)) {</span>
<span class="nc" id="L20896">            vPhaseReport.addAll(landGliderPM((Protomech) entity, entity.getPosition(), entity.getElevation(),</span>
                    entity.delta_distance));
        }

        // non mechs and prone mechs can now return
<span class="nc bnc" id="L20901" title="All 6 branches missed.">        if (!entity.canFall() || (entity.isHullDown() &amp;&amp; entity.canGoHullDown())) {</span>
<span class="nc" id="L20902">            return vPhaseReport;</span>
        }

        // Mechs with UMU float and don't have to roll???
<span class="nc bnc" id="L20906" title="All 2 branches missed.">        if (entity instanceof Mech) {</span>
<span class="nc" id="L20907">            IHex hex = game.getBoard().getHex(dest);</span>
<span class="nc" id="L20908">            int water = hex.terrainLevel(Terrains.WATER);</span>
<span class="nc bnc" id="L20909" title="All 4 branches missed.">            if ((water &gt; 0) &amp;&amp; (entity.getElevation() != -hex.depth(true))</span>
<span class="nc bnc" id="L20910" title="All 4 branches missed.">                    &amp;&amp; ((entity.getElevation() &lt; 0) || ((entity.getElevation() == 0)</span>
<span class="nc bnc" id="L20911" title="All 4 branches missed.">                    &amp;&amp; (hex.terrainLevel(Terrains.BRIDGE_ELEV) != 0) &amp;&amp; !hex.containsTerrain(Terrains.ICE)))</span>
<span class="nc bnc" id="L20912" title="All 4 branches missed.">                    &amp;&amp; !entity.isMakingDfa() &amp;&amp; !entity.isDropping()) {</span>
                // mech is floating in water....
<span class="nc bnc" id="L20914" title="All 2 branches missed.">                if (entity.hasUMU()) {</span>
<span class="nc" id="L20915">                    return vPhaseReport;</span>
                }
                // game.addPSR(new PilotingRollData(entity.getId(),
                // TargetRoll.AUTOMATIC_FAIL, &quot;lost buoyancy&quot;));
            }
        }
        // add all cumulative mods from other rolls to each PSR
        // holds all rolls to make
<span class="nc" id="L20923">        Vector&lt;PilotingRollData&gt; rolls = new Vector&lt;&gt;();</span>
        // holds the initial reason for each roll
<span class="nc" id="L20925">        StringBuilder reasons = new StringBuilder();</span>
<span class="nc" id="L20926">        PilotingRollData base = entity.getBasePilotingRoll();</span>
<span class="nc" id="L20927">        entity.addPilotingModifierForTerrain(base);</span>
<span class="nc bnc" id="L20928" title="All 2 branches missed.">        for (Enumeration&lt;PilotingRollData&gt; i = game.getPSRs(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L20929">            PilotingRollData psr = i.nextElement();</span>
<span class="nc bnc" id="L20930" title="All 2 branches missed.">            if (psr.getEntityId() != entity.getId()) {</span>
<span class="nc" id="L20931">                continue;</span>
            }
            // found a roll
<span class="nc bnc" id="L20934" title="All 2 branches missed.">            if (reasons.length() &gt; 0) {</span>
<span class="nc" id="L20935">                reasons.append(&quot;; &quot;);</span>
            }
<span class="nc" id="L20937">            reasons.append(psr.getPlainDesc());</span>
<span class="nc" id="L20938">            PilotingRollData toUse = entity.getBasePilotingRoll();</span>
<span class="nc" id="L20939">            entity.addPilotingModifierForTerrain(toUse);</span>
<span class="nc" id="L20940">            toUse.append(psr);</span>
            // now, append all other roll's cumulative mods, not the
            // non-cumulative
            // ones
<span class="nc bnc" id="L20944" title="All 2 branches missed.">            for (Enumeration&lt;PilotingRollData&gt; j = game.getPSRs(); j.hasMoreElements(); ) {</span>
<span class="nc" id="L20945">                final PilotingRollData other = j.nextElement();</span>
<span class="nc bnc" id="L20946" title="All 4 branches missed.">                if ((other.getEntityId() != entity.getId()) || other.equals(psr)) {</span>
<span class="nc" id="L20947">                    continue;</span>
                }
<span class="nc" id="L20949">                toUse.append(other, false);</span>
<span class="nc" id="L20950">            }</span>
<span class="nc" id="L20951">            rolls.add(toUse);</span>
<span class="nc" id="L20952">        }</span>
        // any rolls needed?
<span class="nc bnc" id="L20954" title="All 2 branches missed.">        if (rolls.size() == 0) {</span>
<span class="nc" id="L20955">            return vPhaseReport;</span>
        }
        // is our base roll impossible?
<span class="nc bnc" id="L20958" title="All 4 branches missed.">        if ((base.getValue() == TargetRoll.AUTOMATIC_FAIL) || (base.getValue() == TargetRoll.IMPOSSIBLE)) {</span>
<span class="nc" id="L20959">            r = new Report(2275);</span>
<span class="nc" id="L20960">            r.subject = entity.getId();</span>
<span class="nc" id="L20961">            r.addDesc(entity);</span>
<span class="nc" id="L20962">            r.add(rolls.size());</span>
<span class="nc" id="L20963">            r.add(base.getDesc()); // international issue</span>
<span class="nc" id="L20964">            vPhaseReport.add(r);</span>
<span class="nc bnc" id="L20965" title="All 2 branches missed.">            if (moving) {</span>
<span class="nc" id="L20966">                vPhaseReport.addAll(doEntityFallsInto(entity, entity.getElevation(), src, dest,</span>
                        base, true));
<span class="nc bnc" id="L20968" title="All 4 branches missed.">            } else if ((entity instanceof Mech) &amp;&amp; game.getOptions().booleanOption(</span>
                    OptionsConstants.ADVGRNDMOV_TACOPS_FALLING_EXPANDED)
<span class="nc bnc" id="L20970" title="All 2 branches missed.">                    &amp;&amp; (entity.getCrew().getPiloting() &lt; 6)</span>
<span class="nc bnc" id="L20971" title="All 4 branches missed.">                    &amp;&amp; !entity.isHullDown() &amp;&amp; entity.canGoHullDown()) {</span>
<span class="nc bnc" id="L20972" title="All 4 branches missed.">                if (entity.isHullDown() &amp;&amp; entity.canGoHullDown()) {</span>
<span class="nc" id="L20973">                    r = new Report(2317);</span>
<span class="nc" id="L20974">                    r.subject = entity.getId();</span>
<span class="nc" id="L20975">                    r.add(entity.getDisplayName());</span>
<span class="nc" id="L20976">                    vPhaseReport.add(r);</span>
                } else {
<span class="nc" id="L20978">                    vPhaseReport.addAll(doEntityFall(entity, base));</span>
                }
            } else {
<span class="nc" id="L20981">                vPhaseReport.addAll(doEntityFall(entity, base));</span>
            }
            // failed a PSR, check for ICE engine stalling
<span class="nc" id="L20984">            entity.doCheckEngineStallRoll(vPhaseReport);</span>
<span class="nc" id="L20985">            return vPhaseReport;</span>
        }
        // loop through rolls we do have to make...
<span class="nc" id="L20988">        r = new Report(2280);</span>
<span class="nc" id="L20989">        r.subject = entity.getId();</span>
<span class="nc" id="L20990">        r.addDesc(entity);</span>
<span class="nc" id="L20991">        r.add(rolls.size());</span>
<span class="nc" id="L20992">        r.add(reasons.toString()); // international issue</span>
<span class="nc" id="L20993">        vPhaseReport.add(r);</span>
<span class="nc" id="L20994">        r = new Report(2285);</span>
<span class="nc" id="L20995">        r.subject = entity.getId();</span>
<span class="nc" id="L20996">        r.add(base.getValueAsString());</span>
<span class="nc" id="L20997">        r.add(base.getDesc()); // international issue</span>
<span class="nc" id="L20998">        vPhaseReport.add(r);</span>
<span class="nc bnc" id="L20999" title="All 2 branches missed.">        for (int i = 0; i &lt; rolls.size(); i++) {</span>
<span class="nc" id="L21000">            PilotingRollData roll = rolls.elementAt(i);</span>
<span class="nc" id="L21001">            r = new Report(2290);</span>
<span class="nc" id="L21002">            r.subject = entity.getId();</span>
<span class="nc" id="L21003">            r.indent();</span>
<span class="nc" id="L21004">            r.newlines = 0;</span>
<span class="nc" id="L21005">            r.add(i + 1);</span>
<span class="nc" id="L21006">            r.add(roll.getDesc()); // international issue</span>
<span class="nc" id="L21007">            vPhaseReport.add(r);</span>
<span class="nc bnc" id="L21008" title="All 2 branches missed.">            if ((roll.getValue() == TargetRoll.AUTOMATIC_FAIL)</span>
<span class="nc bnc" id="L21009" title="All 2 branches missed.">                || (roll.getValue() == TargetRoll.IMPOSSIBLE)) {</span>
<span class="nc" id="L21010">                r = new Report(2295);</span>
<span class="nc" id="L21011">                r.subject = entity.getId();</span>
<span class="nc" id="L21012">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L21013" title="All 2 branches missed.">                if (moving) {</span>
<span class="nc" id="L21014">                    vPhaseReport.addAll(doEntityFallsInto(entity, entity.getElevation(), src, dest,</span>
                            roll, true));
                } else {
<span class="nc bnc" id="L21017" title="All 4 branches missed.">                    if ((entity instanceof Mech) &amp;&amp; game.getOptions().booleanOption(</span>
                                OptionsConstants.ADVGRNDMOV_TACOPS_FALLING_EXPANDED)
<span class="nc bnc" id="L21019" title="All 2 branches missed.">                            &amp;&amp; (entity.getCrew().getPiloting() &lt; 6)</span>
<span class="nc bnc" id="L21020" title="All 4 branches missed.">                            &amp;&amp; !entity.isHullDown() &amp;&amp; entity.canGoHullDown()) {</span>
<span class="nc bnc" id="L21021" title="All 4 branches missed.">                        if (entity.isHullDown() &amp;&amp; entity.canGoHullDown()) {</span>
<span class="nc" id="L21022">                            r = new Report(2317);</span>
<span class="nc" id="L21023">                            r.subject = entity.getId();</span>
<span class="nc" id="L21024">                            r.add(entity.getDisplayName());</span>
<span class="nc" id="L21025">                            vPhaseReport.add(r);</span>
                        } else {
<span class="nc" id="L21027">                            vPhaseReport.addAll(doEntityFall(entity, roll));</span>
                        }
                    } else {
<span class="nc" id="L21030">                        vPhaseReport.addAll(doEntityFall(entity, roll));</span>
                    }
                }
                // failed a PSR, check for ICE engine stalling
<span class="nc" id="L21034">                entity.doCheckEngineStallRoll(vPhaseReport);</span>
<span class="nc" id="L21035">                return vPhaseReport;</span>
            }
<span class="nc" id="L21037">            int diceRoll = entity.getCrew().rollPilotingSkill();</span>
<span class="nc" id="L21038">            r = new Report(2300);</span>
<span class="nc" id="L21039">            r.add(roll.getValueAsString());</span>
<span class="nc" id="L21040">            r.add(diceRoll);</span>
<span class="nc" id="L21041">            r.subject = entity.getId();</span>
<span class="nc bnc" id="L21042" title="All 2 branches missed.">            if ((diceRoll &lt; roll.getValue())</span>
<span class="nc bnc" id="L21043" title="All 4 branches missed.">                || (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_FUMBLES) &amp;&amp; (diceRoll == 2))) {</span>
<span class="nc" id="L21044">                r.choose(false);</span>
                // Report the fumble
<span class="nc bnc" id="L21046" title="All 4 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_FUMBLES)</span>
                    &amp;&amp; (diceRoll == 2)) {
<span class="nc" id="L21048">                    r.messageId = 2306;</span>
                }
<span class="nc" id="L21050">                vPhaseReport.add(r);</span>
<span class="nc bnc" id="L21051" title="All 2 branches missed.">                if (moving) {</span>
<span class="nc" id="L21052">                    vPhaseReport.addAll(doEntityFallsInto(entity,</span>
<span class="nc" id="L21053">                                                          entity.getElevation(), src, dest, roll, true));</span>
                } else {
<span class="nc bnc" id="L21055" title="All 2 branches missed.">                    if ((entity instanceof Mech)</span>
<span class="nc bnc" id="L21056" title="All 2 branches missed.">                        &amp;&amp; game.getOptions().booleanOption(</span>
                            OptionsConstants.ADVGRNDMOV_TACOPS_FALLING_EXPANDED)
<span class="nc bnc" id="L21058" title="All 2 branches missed.">                        &amp;&amp; (entity.getCrew().getPiloting() &lt; 6)</span>
<span class="nc bnc" id="L21059" title="All 4 branches missed.">                        &amp;&amp; !entity.isHullDown() &amp;&amp; entity.canGoHullDown()) {</span>
<span class="nc bnc" id="L21060" title="All 2 branches missed.">                        if ((entity.getCrew().getPiloting() &gt; 1)</span>
<span class="nc bnc" id="L21061" title="All 2 branches missed.">                            &amp;&amp; ((roll.getValue() - diceRoll) &lt; 2)) {</span>
<span class="nc" id="L21062">                            entity.setHullDown(true);</span>
<span class="nc bnc" id="L21063" title="All 2 branches missed.">                        } else if ((entity.getCrew().getPiloting() &lt;= 1)</span>
<span class="nc bnc" id="L21064" title="All 2 branches missed.">                                   &amp;&amp; ((roll.getValue() - diceRoll) &lt; 3)) {</span>
<span class="nc" id="L21065">                            entity.setHullDown(true);</span>
                        }
<span class="nc bnc" id="L21067" title="All 4 branches missed.">                        if (entity.isHullDown() &amp;&amp; entity.canGoHullDown()) {</span>
<span class="nc" id="L21068">                            ServerHelper.sinkToBottom(entity);</span>
                            
<span class="nc" id="L21070">                            r = new Report(2317);</span>
<span class="nc" id="L21071">                            r.subject = entity.getId();</span>
<span class="nc" id="L21072">                            r.add(entity.getDisplayName());</span>
<span class="nc" id="L21073">                            vPhaseReport.add(r);</span>
                        } else {
<span class="nc" id="L21075">                            vPhaseReport.addAll(doEntityFall(entity, roll));</span>
                        }
                    } else {
<span class="nc" id="L21078">                        vPhaseReport.addAll(doEntityFall(entity, roll));</span>
                    }
                }
                // failed a PSR, check for ICE engine stalling
<span class="nc" id="L21082">                entity.doCheckEngineStallRoll(vPhaseReport);</span>
<span class="nc" id="L21083">                return vPhaseReport;</span>
            }
<span class="nc" id="L21085">            r.choose(true);</span>
<span class="nc" id="L21086">            vPhaseReport.add(r);</span>
        }
<span class="nc" id="L21088">        return vPhaseReport;</span>
    }

    private Vector&lt;Report&gt; checkForTraitors() {
<span class="nc" id="L21092">        Vector&lt;Report&gt; vFullReport = new Vector&lt;&gt;();</span>
        // check for traitors
<span class="nc bnc" id="L21094" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L21095">            Entity entity = i.next();</span>
<span class="nc bnc" id="L21096" title="All 6 branches missed.">            if (entity.isDoomed() || entity.isDestroyed() || entity.isOffBoard()</span>
<span class="nc bnc" id="L21097" title="All 2 branches missed.">                    || !entity.isDeployed()) {</span>
<span class="nc" id="L21098">                continue;</span>
            }
<span class="nc bnc" id="L21100" title="All 4 branches missed.">            if ((entity.getTraitorId() != -1) &amp;&amp; (entity.getOwnerId() != entity.getTraitorId())) {</span>
<span class="nc" id="L21101">                IPlayer p = game.getPlayer(entity.getTraitorId());</span>
<span class="nc bnc" id="L21102" title="All 2 branches missed.">                if (null != p) {</span>
<span class="nc" id="L21103">                    Report r = new Report(7305);</span>
<span class="nc" id="L21104">                    r.subject = entity.getId();</span>
<span class="nc" id="L21105">                    r.add(entity.getDisplayName());</span>
<span class="nc" id="L21106">                    r.add(p.getName());</span>
<span class="nc" id="L21107">                    entity.setOwner(p);</span>
<span class="nc" id="L21108">                    entityUpdate(entity.getId());</span>
<span class="nc" id="L21109">                    vFullReport.add(r);</span>
                }
<span class="nc" id="L21111">                entity.setTraitorId(-1);</span>
            }
<span class="nc" id="L21113">        }</span>
<span class="nc bnc" id="L21114" title="All 2 branches missed.">        if (!vFullReport.isEmpty()) {</span>
<span class="nc" id="L21115">            vFullReport.add(0, new Report(7300));</span>
        }
<span class="nc" id="L21117">        return vFullReport;</span>
    }

    /**
     * Resolves all built up control rolls. Used only during end phase
     */
    private Vector&lt;Report&gt; resolveControlRolls() {
<span class="nc" id="L21124">        Vector&lt;Report&gt; vFullReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L21125">        vFullReport.add(new Report(5001, Report.PUBLIC));</span>
<span class="nc bnc" id="L21126" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L21127">            vFullReport.addAll(resolveControl(i.next()));</span>
        }
<span class="nc" id="L21129">        game.resetControlRolls();</span>
<span class="nc" id="L21130">        return vFullReport;</span>
    }

    /**
     * Resolves and reports all control skill rolls for a single aero or airborne LAM in airmech mode.
     */
    private Vector&lt;Report&gt; resolveControl(Entity e) {
<span class="nc" id="L21137">        Vector&lt;Report&gt; vReport = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L21138" title="All 8 branches missed.">        if (e.isDoomed() || e.isDestroyed() || e.isOffBoard() || !e.isDeployed()) {</span>
<span class="nc" id="L21139">            return vReport;</span>
        }
        Report r;

        /*
         * See forum answers on OOC
         * http://forums.classicbattletech.com/index.php/topic,20424.0.html
         */

<span class="nc" id="L21148">        IAero a = null;</span>
<span class="nc" id="L21149">        boolean canRecover = false;</span>
<span class="nc bnc" id="L21150" title="All 6 branches missed.">        if (e.isAero() &amp;&amp; (e.isAirborne() || e.isSpaceborne())) {</span>
<span class="nc" id="L21151">            a = (IAero) e;</span>
            // they should get a shot at a recovery roll at the end of all this
            // if they are already out of control
<span class="nc" id="L21154">            canRecover = a.isOutControl();</span>
<span class="nc bnc" id="L21155" title="All 4 branches missed.">        } else if (!(e instanceof LandAirMech) || !e.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L21156">            return vReport;</span>
        }

        // if the unit already is moving randomly then it can't get any
        // worse
<span class="nc bnc" id="L21161" title="All 4 branches missed.">        if (a == null || !a.isRandomMove()) {</span>

            // find control rolls and make them
<span class="nc" id="L21164">            Vector&lt;PilotingRollData&gt; rolls = new Vector&lt;&gt;();</span>
<span class="nc" id="L21165">            StringBuilder reasons = new StringBuilder();</span>
<span class="nc" id="L21166">            PilotingRollData target = e.getBasePilotingRoll();</span>
            // maneuvering ace
            // TODO : pending rules query
            // http://www.classicbattletech.com/forums/index.php/topic,63552.new.html#new
            // for now I am assuming Man Ace applies to all out-of-control
            // rolls, but not other
            // uses of control rolls (thus it doesn't go in
            // Entity#addEntityBonuses) and
            // furthermore it doesn't apply to recovery rolls
<span class="nc bnc" id="L21175" title="All 2 branches missed.">            if (e.isUsingManAce()) {</span>
<span class="nc" id="L21176">                target.addModifier(-1, &quot;maneuvering ace&quot;);</span>
            }
<span class="nc bnc" id="L21178" title="All 2 branches missed.">            for (Enumeration&lt;PilotingRollData&gt; j = game.getControlRolls(); j.hasMoreElements(); ) {</span>
<span class="nc" id="L21179">                final PilotingRollData modifier = j.nextElement();</span>
<span class="nc bnc" id="L21180" title="All 2 branches missed.">                if (modifier.getEntityId() != e.getId()) {</span>
<span class="nc" id="L21181">                    continue;</span>
                }
                // found a roll, add it
<span class="nc" id="L21184">                rolls.addElement(modifier);</span>
<span class="nc bnc" id="L21185" title="All 2 branches missed.">                if (reasons.length() &gt; 0) {</span>
<span class="nc" id="L21186">                    reasons.append(&quot;; &quot;);</span>
                }
<span class="nc" id="L21188">                reasons.append(modifier.getCumulativePlainDesc());</span>
<span class="nc" id="L21189">                target.append(modifier);</span>
<span class="nc" id="L21190">            }</span>
            // any rolls needed?
<span class="nc bnc" id="L21192" title="All 2 branches missed.">            if (rolls.size() &gt; 0) {</span>
                // loop through rolls we do have to make...
<span class="nc" id="L21194">                r = new Report(9310);</span>
<span class="nc" id="L21195">                r.subject = e.getId();</span>
<span class="nc" id="L21196">                r.addDesc(e);</span>
<span class="nc" id="L21197">                r.add(rolls.size());</span>
<span class="nc" id="L21198">                r.add(reasons.toString()); // international issue</span>
<span class="nc" id="L21199">                vReport.add(r);</span>
<span class="nc" id="L21200">                r = new Report(2285);</span>
<span class="nc" id="L21201">                r.subject = e.getId();</span>
<span class="nc" id="L21202">                r.add(target.getValueAsString());</span>
<span class="nc" id="L21203">                r.add(target.getDesc()); // international issue</span>
<span class="nc" id="L21204">                vReport.add(r);</span>
<span class="nc bnc" id="L21205" title="All 2 branches missed.">                for (int j = 0; j &lt; rolls.size(); j++) {</span>
<span class="nc" id="L21206">                    PilotingRollData modifier = rolls.elementAt(j);</span>
<span class="nc" id="L21207">                    r = new Report(2290);</span>
<span class="nc" id="L21208">                    r.subject = e.getId();</span>
<span class="nc" id="L21209">                    r.indent();</span>
<span class="nc" id="L21210">                    r.newlines = 0;</span>
<span class="nc" id="L21211">                    r.add(j + 1);</span>
<span class="nc" id="L21212">                    r.add(modifier.getPlainDesc()); // international issue</span>
<span class="nc" id="L21213">                    vReport.add(r);</span>
<span class="nc" id="L21214">                    int diceRoll = Compute.d6(2);</span>
                    // different reports depending on out-of-control status
<span class="nc bnc" id="L21216" title="All 4 branches missed.">                    if (a != null &amp;&amp; a.isOutControl()) {</span>
<span class="nc" id="L21217">                        r = new Report(9360);</span>
<span class="nc" id="L21218">                        r.subject = e.getId();</span>
<span class="nc" id="L21219">                        r.add(target.getValueAsString());</span>
<span class="nc" id="L21220">                        r.add(diceRoll);</span>
<span class="nc bnc" id="L21221" title="All 2 branches missed.">                        if (diceRoll &lt; (target.getValue() - 5)) {</span>
<span class="nc" id="L21222">                            r.choose(false);</span>
<span class="nc" id="L21223">                            vReport.add(r);</span>
<span class="nc" id="L21224">                            a.setRandomMove(true);</span>
                        } else {
<span class="nc" id="L21226">                            r.choose(true);</span>
<span class="nc" id="L21227">                            vReport.add(r);</span>
                        }
                    } else {
<span class="nc" id="L21230">                        r = new Report(9315);</span>
<span class="nc" id="L21231">                        r.subject = e.getId();</span>
<span class="nc" id="L21232">                        r.add(target.getValueAsString());</span>
<span class="nc" id="L21233">                        r.add(diceRoll);</span>
<span class="nc" id="L21234">                        r.newlines = 1;</span>
<span class="nc bnc" id="L21235" title="All 2 branches missed.">                        if (diceRoll &lt; target.getValue()) {</span>
<span class="nc" id="L21236">                            r.choose(false);</span>
<span class="nc" id="L21237">                            vReport.add(r);</span>
<span class="nc bnc" id="L21238" title="All 2 branches missed.">                            if (a != null) {</span>
<span class="nc" id="L21239">                                a.setOutControl(true);</span>
                                // do we have random movement?
<span class="nc bnc" id="L21241" title="All 2 branches missed.">                                if ((target.getValue() - diceRoll) &gt; 5) {</span>
<span class="nc" id="L21242">                                    r = new Report(9365);</span>
<span class="nc" id="L21243">                                    r.newlines = 0;</span>
<span class="nc" id="L21244">                                    r.subject = e.getId();</span>
<span class="nc" id="L21245">                                    vReport.add(r);</span>
<span class="nc" id="L21246">                                    a.setRandomMove(true);</span>
                                }
                                // if on the atmospheric map, then lose altitude
                                // and check
                                // for crash
<span class="nc bnc" id="L21251" title="All 4 branches missed.">                                if (!a.isSpaceborne() &amp;&amp; a.isAirborne()) {</span>
<span class="nc" id="L21252">                                    int loss = Compute.d6(1);</span>
<span class="nc" id="L21253">                                    int origAltitude = e.getAltitude();</span>
<span class="nc" id="L21254">                                    e.setAltitude(e.getAltitude() - loss);</span>
                                    //Reroll altitude loss with edge if the new altitude would result in a crash
<span class="nc bnc" id="L21256" title="All 4 branches missed.">                                    if (e.getAltitude() &lt;= 0</span>
                                            //Don't waste the edge if it won't help
                                            &amp;&amp; origAltitude &gt; 1
<span class="nc bnc" id="L21259" title="All 2 branches missed.">                                            &amp;&amp; e.getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L21260" title="All 2 branches missed.">                                            &amp;&amp; e.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_ALT_LOSS)) {</span>
<span class="nc" id="L21261">                                        loss = Compute.d6(1);</span>
                                        //Report the edge use
<span class="nc" id="L21263">                                        r = new Report(9367);</span>
<span class="nc" id="L21264">                                        r.newlines = 1;</span>
<span class="nc" id="L21265">                                        r.subject = e.getId();</span>
<span class="nc" id="L21266">                                        vReport.add(r);</span>
<span class="nc" id="L21267">                                        e.setAltitude(origAltitude - loss);</span>
                                        // and spend the edge point
<span class="nc" id="L21269">                                        e.getCrew().decreaseEdge();</span>
                                    }
                                    //Report the altitude loss
<span class="nc" id="L21272">                                    r = new Report(9366);</span>
<span class="nc" id="L21273">                                    r.newlines = 0;</span>
<span class="nc" id="L21274">                                    r.subject = e.getId();</span>
<span class="nc" id="L21275">                                    r.addDesc(e);</span>
<span class="nc" id="L21276">                                    r.add(loss);</span>
<span class="nc" id="L21277">                                    vReport.add(r);</span>
                                    // check for crash
<span class="nc bnc" id="L21279" title="All 2 branches missed.">                                    if (checkCrash(e, e.getPosition(),</span>
<span class="nc" id="L21280">                                            e.getAltitude())) {</span>
<span class="nc" id="L21281">                                        vReport.addAll(processCrash(e,</span>
<span class="nc" id="L21282">                                                a.getCurrentVelocity(),</span>
<span class="nc" id="L21283">                                                e.getPosition()));</span>
<span class="nc" id="L21284">                                        break;</span>
                                    }
<span class="nc" id="L21286">                                }</span>
<span class="nc bnc" id="L21287" title="All 4 branches missed.">                            } else if (e instanceof LandAirMech &amp;&amp; e.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L21288">                                int loss = target.getValue() - diceRoll;</span>
<span class="nc" id="L21289">                                r = new Report(9366);</span>
<span class="nc" id="L21290">                                r.subject = e.getId();</span>
<span class="nc" id="L21291">                                r.addDesc(e);</span>
<span class="nc" id="L21292">                                r.add(loss);</span>
<span class="nc" id="L21293">                                vReport.add(r);</span>
<span class="nc" id="L21294">                                IHex hex = game.getBoard().getHex(e.getPosition());</span>
<span class="nc" id="L21295">                                int elevation = Math.max(0, hex.terrainLevel(Terrains.BLDG_ELEV));</span>
<span class="nc bnc" id="L21296" title="All 2 branches missed.">                                if (e.getElevation() - loss &lt;= elevation) {</span>
<span class="nc" id="L21297">                                    crashAirMech(e, target, vReport);</span>
                                } else {
<span class="nc" id="L21299">                                    e.setElevation(e.getElevation() - loss);</span>
                                }
<span class="nc" id="L21301">                            }</span>
                        } else {
<span class="nc" id="L21303">                            r.choose(true);</span>
<span class="nc" id="L21304">                            vReport.add(r);</span>
                        }
                    }
                }
            }
        }

        // if they were out-of-control to start with, give them a chance to
        // regain control
<span class="nc bnc" id="L21313" title="All 2 branches missed.">        if (canRecover) {</span>
<span class="nc" id="L21314">            PilotingRollData base = e.getBasePilotingRoll();</span>
            // is our base roll impossible?
<span class="nc bnc" id="L21316" title="All 2 branches missed.">            if ((base.getValue() == TargetRoll.AUTOMATIC_FAIL)</span>
<span class="nc bnc" id="L21317" title="All 2 branches missed.">                    || (base.getValue() == TargetRoll.IMPOSSIBLE)) {</span>
                // report something
<span class="nc" id="L21319">                r = new Report(9340);</span>
<span class="nc" id="L21320">                r.subject = e.getId();</span>
<span class="nc" id="L21321">                r.addDesc(e);</span>
<span class="nc" id="L21322">                r.add(base.getDesc()); // international issue</span>
<span class="nc" id="L21323">                vReport.add(r);</span>
<span class="nc" id="L21324">                return vReport;</span>
            }
<span class="nc" id="L21326">            r = new Report(9345);</span>
<span class="nc" id="L21327">            r.subject = e.getId();</span>
<span class="nc" id="L21328">            r.addDesc(e);</span>
<span class="nc" id="L21329">            r.add(base.getDesc()); // international issue</span>
<span class="nc" id="L21330">            vReport.add(r);</span>
<span class="nc" id="L21331">            int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L21332">            r = new Report(9350);</span>
<span class="nc" id="L21333">            r.subject = e.getId();</span>
<span class="nc" id="L21334">            r.add(base.getValueAsString());</span>
<span class="nc" id="L21335">            r.add(diceRoll);</span>
<span class="nc bnc" id="L21336" title="All 2 branches missed.">            if (diceRoll &lt; base.getValue()) {</span>
<span class="nc" id="L21337">                r.choose(false);</span>
<span class="nc" id="L21338">                vReport.add(r);</span>
            } else {
<span class="nc" id="L21340">                r.choose(true);</span>
<span class="nc" id="L21341">                vReport.add(r);</span>
<span class="nc" id="L21342">                a.setOutControl(false);</span>
<span class="nc" id="L21343">                a.setOutCtrlHeat(false);</span>
<span class="nc" id="L21344">                a.setRandomMove(false);</span>
            }
        }
<span class="nc" id="L21347">        return vReport;</span>
    }

    /**
     * Inflict damage on a pilot
     *
     * @param en     The &lt;code&gt;Entity&lt;/code&gt; who's pilot gets damaged.
     * @param damage The &lt;code&gt;int&lt;/code&gt; amount of damage.
     */
    public Vector&lt;Report&gt; damageCrew(Entity en, int damage) {
<span class="nc" id="L21357">        return damageCrew(en, damage, -1);</span>
    }

    /**
     * Inflict damage on a pilot
     *
     * @param en        The &lt;code&gt;Entity&lt;/code&gt; who's pilot gets damaged.
     * @param damage    The &lt;code&gt;int&lt;/code&gt; amount of damage.
     * @param crewPos   The &lt;code&gt;int&lt;/code&gt;position of the crew member in a &lt;code&gt;MultiCrewCockpit&lt;/crew&gt;
     *                  that takes the damage. A value &lt; 0 applies the damage to all crew members.
     *                  The basic &lt;crew&gt;Crew&lt;/crew&gt; ignores this value.
     */
    public Vector&lt;Report&gt; damageCrew(Entity en, int damage, int crewPos) {
<span class="nc" id="L21370">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
<span class="nc" id="L21371">        Crew crew = en.getCrew();</span>
        Report r;
<span class="nc bnc" id="L21373" title="All 6 branches missed.">        if (!crew.isDead() &amp;&amp; !crew.isEjected() &amp;&amp; !crew.isDoomed()) {</span>
<span class="nc bnc" id="L21374" title="All 2 branches missed.">            for (int pos = 0; pos &lt; en.getCrew().getSlotCount(); pos++) {</span>
<span class="nc bnc" id="L21375" title="All 4 branches missed.">                if (crewPos &gt;= 0</span>
<span class="nc bnc" id="L21376" title="All 2 branches missed.">                        &amp;&amp; (crewPos != pos || crew.isDead(crewPos))) {</span>
<span class="nc" id="L21377">                    continue;</span>
                }
<span class="nc bnc" id="L21379" title="All 2 branches missed.">                boolean wasPilot = crew.getCurrentPilotIndex() == pos;</span>
<span class="nc bnc" id="L21380" title="All 2 branches missed.">                boolean wasGunner = crew.getCurrentGunnerIndex() == pos;</span>
<span class="nc" id="L21381">                crew.setHits(crew.getHits(pos) + damage, pos);</span>
<span class="nc bnc" id="L21382" title="All 2 branches missed.">                if (en.isLargeCraft()) {</span>
<span class="nc" id="L21383">                    r = new Report (6028);</span>
<span class="nc" id="L21384">                    r.subject = en.getId();</span>
<span class="nc" id="L21385">                    r.indent(2);</span>
<span class="nc" id="L21386">                    r.addDesc(en);</span>
<span class="nc" id="L21387">                    r.add(damage);</span>
<span class="nc bnc" id="L21388" title="All 2 branches missed.">                    if (((Aero)en).isEjecting()) {</span>
<span class="nc" id="L21389">                        r.add(&quot;as crew depart the ship&quot;);</span>
                    } else {
                        //Blank data
<span class="nc" id="L21392">                        r.add(&quot;&quot;);</span>
                    }
<span class="nc" id="L21394">                    r.add(crew.getHits(pos));</span>
<span class="nc" id="L21395">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L21396" title="All 2 branches missed.">                    if (Crew.DEATH &gt; crew.getHits()) {</span>
<span class="nc" id="L21397">                        vDesc.addAll(resolveCrewDamage(en, damage, pos));</span>
<span class="nc bnc" id="L21398" title="All 2 branches missed.">                    } else if (!crew.isDoomed()) {</span>
<span class="nc" id="L21399">                        crew.setDoomed(true);</span>
                        //Safety. We might use this logic for large naval vessels later on
<span class="nc bnc" id="L21401" title="All 4 branches missed.">                        if (en instanceof Aero &amp;&amp; ((Aero)en).isEjecting()) {</span>
<span class="nc" id="L21402">                            vDesc.addAll(destroyEntity(en, &quot;ejection&quot;, true));</span>
<span class="nc" id="L21403">                            ((Aero)en).setEjecting(false);</span>
                        } else {
<span class="nc" id="L21405">                            vDesc.addAll(destroyEntity(en, &quot;crew casualties&quot;, true));</span>
                        }
                    }
                } else {
<span class="nc bnc" id="L21409" title="All 2 branches missed.">                    if (Crew.DEATH &gt; crew.getHits(pos)) {</span>
<span class="nc" id="L21410">                        r = new Report(6025);</span>
                    } else {
<span class="nc" id="L21412">                        r = new Report(6026);</span>
                    }
<span class="nc" id="L21414">                    r.subject = en.getId();</span>
<span class="nc" id="L21415">                    r.indent(2);</span>
<span class="nc" id="L21416">                    r.add(crew.getCrewType().getRoleName(pos));</span>
<span class="nc" id="L21417">                    r.addDesc(en);</span>
<span class="nc" id="L21418">                    r.add(crew.getName(pos));</span>
<span class="nc" id="L21419">                    r.add(damage);</span>
<span class="nc" id="L21420">                    r.add(crew.getHits(pos));</span>
<span class="nc" id="L21421">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L21422" title="All 2 branches missed.">                    if (crew.isDead(pos)) {</span>
<span class="nc" id="L21423">                        r = createCrewTakeoverReport(en, pos, wasPilot, wasGunner);</span>
<span class="nc bnc" id="L21424" title="All 2 branches missed.">                        if (null != r) {</span>
<span class="nc" id="L21425">                            vDesc.addElement(r);</span>
                        }
                    }
<span class="nc bnc" id="L21428" title="All 2 branches missed.">                    if (Crew.DEATH &gt; crew.getHits()) {</span>
<span class="nc" id="L21429">                        vDesc.addAll(resolveCrewDamage(en, damage, pos));</span>
<span class="nc bnc" id="L21430" title="All 2 branches missed.">                    } else if (!crew.isDoomed()) {</span>
<span class="nc" id="L21431">                        crew.setDoomed(true);</span>
<span class="nc" id="L21432">                        vDesc.addAll(destroyEntity(en, &quot;pilot death&quot;, true));</span>
                    }
                }
            }
        } else {
<span class="nc bnc" id="L21437" title="All 8 branches missed.">            boolean isPilot = (en instanceof Mech) || ((en instanceof Aero)</span>
                    &amp;&amp; !(en instanceof SmallCraft) &amp;&amp; !(en instanceof Jumpship));
<span class="nc bnc" id="L21439" title="All 4 branches missed.">            if (crew.isDead() || crew.isDoomed()) {</span>
<span class="nc bnc" id="L21440" title="All 2 branches missed.">                if (isPilot) {</span>
<span class="nc" id="L21441">                    r = new Report(6021);</span>
                } else {
<span class="nc" id="L21443">                    r = new Report(6022);</span>
                }
            } else {
<span class="nc bnc" id="L21446" title="All 2 branches missed.">                if (isPilot) {</span>
<span class="nc" id="L21447">                    r = new Report(6023);</span>
                } else {
<span class="nc" id="L21449">                    r = new Report(6024);</span>
                }
            }
<span class="nc" id="L21452">            r.subject = en.getId();</span>
<span class="nc" id="L21453">            r.addDesc(en);</span>
<span class="nc" id="L21454">            r.add(crew.getName());</span>
<span class="nc" id="L21455">            r.indent(2);</span>
<span class="nc" id="L21456">            vDesc.add(r);</span>
        }
<span class="nc bnc" id="L21458" title="All 4 branches missed.">        if (en.isAirborneVTOLorWIGE() &amp;&amp; !en.getCrew().isActive()) {</span>
<span class="nc bnc" id="L21459" title="All 2 branches missed.">            if (en instanceof LandAirMech) {</span>
<span class="nc" id="L21460">                crashAirMech(en, en.getBasePilotingRoll(), vDesc);</span>
<span class="nc bnc" id="L21461" title="All 2 branches missed.">            } else if (en instanceof Protomech) {</span>
<span class="nc" id="L21462">                vDesc.addAll(landGliderPM((Protomech)en));</span>
            }
        }
<span class="nc" id="L21465">        return vDesc;</span>
    }

    /**
     * Convenience method that fills in a report showing that a crew member of a multicrew cockpit
     * has taken over for another incapacitated crew member.
     *
     * @param e         The &lt;code&gt;Entity&lt;/code&gt; for the crew.
     * @param slot      The slot index of the crew member that was incapacitated.
     * @param wasPilot  Whether the crew member was the pilot before becoming incapacitated.
     * @param wasGunner Whether the crew member was the gunner before becoming incapacitated.
     * @return          A completed &lt;code&gt;Report&lt;/code&gt; if the position was assumed by another
     *                  crew members, otherwise null.
     */
    private Report createCrewTakeoverReport(Entity e, int slot, boolean wasPilot, boolean wasGunner) {
<span class="nc bnc" id="L21480" title="All 4 branches missed.">        if (wasPilot &amp;&amp; e.getCrew().getCurrentPilotIndex() != slot) {</span>
<span class="nc" id="L21481">            Report r = new Report(5560);</span>
<span class="nc" id="L21482">            r.subject = e.getId();</span>
<span class="nc" id="L21483">            r.indent(4);</span>
<span class="nc" id="L21484">            r.add(e.getCrew().getNameAndRole(e.getCrew().getCurrentPilotIndex()));</span>
<span class="nc" id="L21485">            r.add(e.getCrew().getCrewType().getRoleName(e.getCrew().getCrewType().getPilotPos()));</span>
<span class="nc" id="L21486">            r.addDesc(e);</span>
<span class="nc" id="L21487">            return r;</span>
        }
<span class="nc bnc" id="L21489" title="All 4 branches missed.">        if (wasGunner &amp;&amp; e.getCrew().getCurrentGunnerIndex() != slot) {</span>
<span class="nc" id="L21490">            Report r = new Report(5560);</span>
<span class="nc" id="L21491">            r.subject = e.getId();</span>
<span class="nc" id="L21492">            r.indent(4);</span>
<span class="nc" id="L21493">            r.add(e.getCrew().getNameAndRole(e.getCrew().getCurrentGunnerIndex()));</span>
<span class="nc" id="L21494">            r.add(e.getCrew().getCrewType().getRoleName(e.getCrew().getCrewType().getGunnerPos()));</span>
<span class="nc" id="L21495">            r.addDesc(e);</span>
<span class="nc" id="L21496">            return r;</span>
        }
<span class="nc" id="L21498">        return null;</span>
    }

    /**
     * resolves consciousness rolls for one entity
     *
     * @param e         The &lt;code&gt;Entity&lt;/code&gt; that took damage
     * @param damage    The &lt;code&gt;int&lt;/code&gt; damage taken by the pilot
     * @param crewPos   The &lt;code&gt;int&lt;/code&gt; index of the crew member for multi crew cockpits, ignored by
     *                  basic &lt;code&gt;crew&lt;/code&gt;
     */
    private Vector&lt;Report&gt; resolveCrewDamage(Entity e, int damage, int crewPos) {
<span class="nc" id="L21510">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
<span class="nc" id="L21511">        final int totalHits = e.getCrew().getHits(crewPos);</span>
<span class="nc bnc" id="L21512" title="All 4 branches missed.">        if ((e instanceof MechWarrior) || !e.isTargetable()</span>
<span class="nc bnc" id="L21513" title="All 4 branches missed.">            || !e.getCrew().isActive(crewPos) || (damage == 0)) {</span>
<span class="nc" id="L21514">            return vDesc;</span>
        }

        // no consciousness roll for pain-shunted warriors
<span class="nc bnc" id="L21518" title="All 2 branches missed.">        if (e.hasAbility(OptionsConstants.MD_PAIN_SHUNT)) {</span>
<span class="nc" id="L21519">            return vDesc;</span>
        }

        // no consciousness roll for capital fighter pilots or large craft crews
<span class="nc bnc" id="L21523" title="All 4 branches missed.">        if (e.isCapitalFighter() || e.isLargeCraft()) {</span>
<span class="nc" id="L21524">            return vDesc;</span>
        }

<span class="nc bnc" id="L21527" title="All 2 branches missed.">        for (int hit = (totalHits - damage) + 1; hit &lt;= totalHits; hit++) {</span>
<span class="nc" id="L21528">            int rollTarget = Compute.getConsciousnessNumber(hit);</span>
<span class="nc bnc" id="L21529" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.RPG_TOUGHNESS)) {</span>
<span class="nc" id="L21530">                rollTarget -= e.getCrew().getToughness(crewPos);</span>
            }
<span class="nc" id="L21532">            boolean edgeUsed = false;</span>
            do {
<span class="nc bnc" id="L21534" title="All 2 branches missed.">                if (edgeUsed) {</span>
<span class="nc" id="L21535">                    e.getCrew().decreaseEdge();</span>
                }
<span class="nc" id="L21537">                int roll = Compute.d6(2);</span>
<span class="nc bnc" id="L21538" title="All 2 branches missed.">                if (e.hasAbility(OptionsConstants.MISC_PAIN_RESISTANCE)) {</span>
<span class="nc" id="L21539">                    roll = Math.min(12, roll + 1);</span>
                }
<span class="nc" id="L21541">                Report r = new Report(6030);</span>
<span class="nc" id="L21542">                r.indent(2);</span>
<span class="nc" id="L21543">                r.subject = e.getId();</span>
<span class="nc" id="L21544">                r.add(e.getCrew().getCrewType().getRoleName(crewPos));</span>
<span class="nc" id="L21545">                r.addDesc(e);</span>
<span class="nc" id="L21546">                r.add(e.getCrew().getName(crewPos));</span>
<span class="nc" id="L21547">                r.add(rollTarget);</span>
<span class="nc" id="L21548">                r.add(roll);</span>
<span class="nc bnc" id="L21549" title="All 2 branches missed.">                if (roll &gt;= rollTarget) {</span>
<span class="nc" id="L21550">                    e.getCrew().setKoThisRound(false, crewPos);</span>
<span class="nc" id="L21551">                    r.choose(true);</span>
                } else {
<span class="nc" id="L21553">                    e.getCrew().setKoThisRound(true, crewPos);</span>
<span class="nc" id="L21554">                    r.choose(false);</span>
<span class="nc bnc" id="L21555" title="All 2 branches missed.">                    if (e.getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L21556" title="All 2 branches missed.">                            &amp;&amp; (e.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_KO)</span>
<span class="nc bnc" id="L21557" title="All 2 branches missed.">                            || e.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_KO))) {</span>
<span class="nc" id="L21558">                        edgeUsed = true;</span>
<span class="nc" id="L21559">                        vDesc.add(r);</span>
<span class="nc" id="L21560">                        r = new Report(6520);</span>
<span class="nc" id="L21561">                        r.subject = e.getId();</span>
<span class="nc" id="L21562">                        r.addDesc(e);</span>
<span class="nc" id="L21563">                        r.add(e.getCrew().getName(crewPos));</span>
<span class="nc" id="L21564">                        r.add(e.getCrew().getOptions().intOption(OptionsConstants.EDGE));</span>
                    } // if
                    // return true;
                } // else
<span class="nc" id="L21568">                vDesc.add(r);</span>
<span class="nc bnc" id="L21569" title="All 2 branches missed.">            } while (e.getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L21570" title="All 2 branches missed.">                     &amp;&amp; e.getCrew().isKoThisRound(crewPos)</span>
<span class="nc bnc" id="L21571" title="All 2 branches missed.">                     &amp;&amp; (e.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_KO)</span>
<span class="nc bnc" id="L21572" title="All 2 branches missed.">                         || e.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_KO)));</span>
            // end of do-while
<span class="nc bnc" id="L21574" title="All 2 branches missed.">            if (e.getCrew().isKoThisRound(crewPos)) {</span>
<span class="nc bnc" id="L21575" title="All 2 branches missed.">                boolean wasPilot = e.getCrew().getCurrentPilotIndex() == crewPos;</span>
<span class="nc bnc" id="L21576" title="All 2 branches missed.">                boolean wasGunner = e.getCrew().getCurrentGunnerIndex() == crewPos;</span>
<span class="nc" id="L21577">                e.getCrew().setUnconscious(true, crewPos);</span>
<span class="nc" id="L21578">                Report r = createCrewTakeoverReport(e, crewPos, wasPilot, wasGunner);</span>
<span class="nc bnc" id="L21579" title="All 2 branches missed.">                if (null != r) {</span>
<span class="nc" id="L21580">                    vDesc.add(r);</span>
                }
<span class="nc" id="L21582">                return vDesc;</span>
            }
        }
<span class="nc" id="L21585">        return vDesc;</span>
    }

    /**
     * Make the rolls indicating whether any unconscious crews wake up
     */
    private void resolveCrewWakeUp() {
<span class="nc bnc" id="L21592" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L21593">            final Entity e = i.next();</span>

            // only unconscious pilots of mechs and protos, ASF and Small Craft
            // and MechWarriors can roll to wake up
<span class="nc bnc" id="L21597" title="All 12 branches missed.">            if (e.isTargetable()</span>
                    &amp;&amp; ((e instanceof Mech) || (e instanceof Protomech)
                            || (e instanceof MechWarrior) || ((e instanceof Aero) &amp;&amp; !(e instanceof Jumpship)))) {
<span class="nc bnc" id="L21600" title="All 2 branches missed.">                for (int pos = 0; pos &lt; e.getCrew().getSlotCount(); pos++) {</span>
<span class="nc bnc" id="L21601" title="All 2 branches missed.">                    if (e.getCrew().isMissing(pos)) {</span>
<span class="nc" id="L21602">                        continue;</span>
                    }
<span class="nc bnc" id="L21604" title="All 2 branches missed.">                    if (e.getCrew().isUnconscious(pos)</span>
<span class="nc bnc" id="L21605" title="All 2 branches missed.">                            &amp;&amp; !e.getCrew().isKoThisRound(pos)) {</span>
<span class="nc" id="L21606">                        int roll = Compute.d6(2);</span>

<span class="nc bnc" id="L21608" title="All 2 branches missed.">                        if (e.hasAbility(OptionsConstants.MISC_PAIN_RESISTANCE)) {</span>
<span class="nc" id="L21609">                            roll = Math.min(12, roll + 1);</span>
                        }

<span class="nc" id="L21612">                        int rollTarget = Compute.getConsciousnessNumber(e.getCrew()</span>
<span class="nc" id="L21613">                                                                         .getHits(pos));</span>
<span class="nc" id="L21614">                        Report r = new Report(6029);</span>
<span class="nc" id="L21615">                        r.subject = e.getId();</span>
<span class="nc" id="L21616">                        r.add(e.getCrew().getCrewType().getRoleName(pos));</span>
<span class="nc" id="L21617">                        r.addDesc(e);</span>
<span class="nc" id="L21618">                        r.add(e.getCrew().getName(pos));</span>
<span class="nc" id="L21619">                        r.add(rollTarget);</span>
<span class="nc" id="L21620">                        r.add(roll);</span>
<span class="nc bnc" id="L21621" title="All 2 branches missed.">                        if (roll &gt;= rollTarget) {</span>
<span class="nc" id="L21622">                            r.choose(true);</span>
<span class="nc" id="L21623">                            e.getCrew().setUnconscious(false, pos);</span>
                        } else {
<span class="nc" id="L21625">                            r.choose(false);</span>
                        }
<span class="nc" id="L21627">                        addReport(r);</span>
                    }
                }
            }
<span class="nc" id="L21631">        }</span>
<span class="nc" id="L21632">    }</span>

    /**
     * Check whether any &lt;code&gt;Entity&lt;/code&gt; with a cockpit command console has been scheduled to swap
     * roles between the two crew members.
     */
    private void resolveConsoleCrewSwaps() {
<span class="nc bnc" id="L21639" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; i = game.getEntities(); i.hasNext(); ) {</span>
<span class="nc" id="L21640">            final Entity e = i.next();</span>
<span class="nc bnc" id="L21641" title="All 2 branches missed.">            if (e.getCrew().doConsoleRoleSwap()) {</span>
<span class="nc" id="L21642">                final Crew crew = e.getCrew();</span>
<span class="nc" id="L21643">                final int current = crew.getCurrentPilotIndex();</span>
<span class="nc" id="L21644">                Report r = new Report(5560);</span>
<span class="nc" id="L21645">                r.subject = e.getId();</span>
<span class="nc" id="L21646">                r.add(crew.getNameAndRole(current));</span>
<span class="nc" id="L21647">                r.add(crew.getCrewType().getRoleName(0));</span>
<span class="nc" id="L21648">                r.addDesc(e);</span>
<span class="nc" id="L21649">                addReport(r);</span>
            }
<span class="nc" id="L21651">        }</span>
<span class="nc" id="L21652">    }</span>

    /*
     * Resolve any outstanding self destructions...
     */
    private void resolveSelfDestruct() {
<span class="nc bnc" id="L21658" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L21659" title="All 2 branches missed.">            if (e.getSelfDestructing()) {</span>
<span class="nc" id="L21660">                e.setSelfDestructing(false);</span>
<span class="nc" id="L21661">                e.setSelfDestructInitiated(true);</span>
<span class="nc" id="L21662">                Report r = new Report(5535, Report.PUBLIC);</span>
<span class="nc" id="L21663">                r.subject = e.getId();</span>
<span class="nc" id="L21664">                r.addDesc(e);</span>
<span class="nc" id="L21665">                addReport(r);</span>
            }
<span class="nc" id="L21667">        }</span>
<span class="nc" id="L21668">    }</span>

    /*
     * Resolve any outstanding crashes from shutting down and being airborne
     * VTOL or WiGE...
     */
    private void resolveShutdownCrashes() {
<span class="nc bnc" id="L21675" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L21676" title="All 4 branches missed.">            if (e.isShutDown() &amp;&amp; e.isAirborneVTOLorWIGE()</span>
<span class="nc bnc" id="L21677" title="All 4 branches missed.">                &amp;&amp; !(e.isDestroyed() || e.isDoomed())) {</span>
<span class="nc" id="L21678">                Tank t = (Tank) e;</span>
<span class="nc" id="L21679">                t.immobilize();</span>
<span class="nc" id="L21680">                addReport(forceLandVTOLorWiGE(t));</span>
            }
<span class="nc" id="L21682">        }</span>
<span class="nc" id="L21683">    }</span>

    /**
     * Resolve any potential fatal damage to Capital Fighter after each
     * individual attacker is finished
     */
    private Vector&lt;Report&gt; checkFatalThresholds(int nextAE, int prevAE) {
<span class="nc" id="L21690">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L21691" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; e = game.getEntities(); e.hasNext();) {</span>
<span class="nc" id="L21692">            Entity en = e.next();</span>
<span class="nc bnc" id="L21693" title="All 4 branches missed.">            if (!en.isCapitalFighter() || (nextAE == Entity.NONE)) {</span>
<span class="nc" id="L21694">                continue;</span>
            }
<span class="nc" id="L21696">            IAero ship = (IAero) en;</span>
<span class="nc" id="L21697">            int damage = ship.getCurrentDamage();</span>
<span class="nc" id="L21698">            double divisor = 2.0;</span>
<span class="nc bnc" id="L21699" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)) {</span>
<span class="nc" id="L21700">                divisor = 20.0;</span>
            }
<span class="nc bnc" id="L21702" title="All 2 branches missed.">            if (damage &gt;= ship.getFatalThresh()) {</span>
<span class="nc" id="L21703">                int roll = Compute.d6(2)</span>
<span class="nc" id="L21704">                        + (int) Math.floor((damage - ship.getFatalThresh())</span>
                                / divisor);
<span class="nc bnc" id="L21706" title="All 2 branches missed.">                if (roll &gt; 9) {</span>
                    // Lets auto-eject if we can!
<span class="nc bnc" id="L21708" title="All 2 branches missed.">                    if (ship instanceof LandAirMech) {</span>
                        // LAMs eject if the CT destroyed switch is on
<span class="nc" id="L21710">                        LandAirMech lam = (LandAirMech) ship;</span>
<span class="nc bnc" id="L21711" title="All 2 branches missed.">                        if (lam.isAutoEject()</span>
<span class="nc bnc" id="L21712" title="All 2 branches missed.">                            &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L21713" title="All 2 branches missed.">                                    || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L21714" title="All 2 branches missed.">                                            &amp;&amp; lam.isCondEjectCTDest()))) {</span>
<span class="nc" id="L21715">                            addReport(ejectEntity(en, true, false));</span>
                        }
<span class="nc" id="L21717">                    } else {</span>
                        // Aeros eject if the SI Destroyed switch is on
<span class="nc" id="L21719">                        Aero aero = (Aero) ship;</span>
<span class="nc bnc" id="L21720" title="All 2 branches missed.">                        if (aero.isAutoEject()</span>
<span class="nc bnc" id="L21721" title="All 2 branches missed.">                            &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L21722" title="All 2 branches missed.">                                    || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L21723" title="All 2 branches missed.">                                            &amp;&amp; aero.isCondEjectSIDest()))) {</span>
<span class="nc" id="L21724">                            addReport(ejectEntity(en, true, false));</span>
                        }
                    }
<span class="nc" id="L21727">                    vDesc.addAll(destroyEntity((Entity)ship, &quot;fatal damage threshold&quot;));</span>
<span class="nc" id="L21728">                    ship.doDisbandDamage();</span>
<span class="nc bnc" id="L21729" title="All 2 branches missed.">                    if (prevAE != Entity.NONE) {</span>
<span class="nc" id="L21730">                        creditKill(en, game.getEntity(prevAE));</span>
                    }
                }
            }
<span class="nc" id="L21734">            ship.setCurrentDamage(0);</span>
<span class="nc" id="L21735">        }</span>
<span class="nc" id="L21736">        return vDesc;</span>
    }

    /**
     * damage an Entity
     *
     * @param te            the &lt;code&gt;Entity&lt;/code&gt; to be damaged
     * @param hit           the corresponding &lt;code&gt;HitData&lt;/code&gt;
     * @param damage        the &lt;code&gt;int&lt;/code&gt; amount of damage
     * @param ammoExplosion a &lt;code&gt;boolean&lt;/code&gt; indicating if this is an ammo explosion
     * @return a &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt; containing the phase reports
     */
    private Vector&lt;Report&gt; damageEntity(Entity te, HitData hit, int damage,
                                        boolean ammoExplosion) {
<span class="nc" id="L21750">        return damageEntity(te, hit, damage, ammoExplosion, DamageType.NONE,</span>
                            false, false);
    }

    /**
     * Deals the listed damage to an entity. Returns a vector of Reports for the
     * phase report
     *
     * @param te     the target entity
     * @param hit    the hit data for the location hit
     * @param damage the damage to apply
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt;s
     */
    public Vector&lt;Report&gt; damageEntity(Entity te, HitData hit, int damage) {
<span class="nc" id="L21764">        return damageEntity(te, hit, damage, false, DamageType.NONE, false,</span>
                            false);
    }

    /**
     * Deals the listed damage to an entity. Returns a vector of Reports for the
     * phase report
     *
     * @param te            the target entity
     * @param hit           the hit data for the location hit
     * @param damage        the damage to apply
     * @param ammoExplosion ammo explosion type damage is applied directly to the IS,
     *                      hurts the pilot, causes auto-ejects, and can blow the unit to
     *                      smithereens
     * @param bFrag         The DamageType of the attack.
     * @param damageIS      Should the target location's internal structure be damaged
     *                      directly?
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt;s
     */
    public Vector&lt;Report&gt; damageEntity(Entity te, HitData hit, int damage,
                                       boolean ammoExplosion, DamageType bFrag, boolean damageIS) {
<span class="nc" id="L21785">        return damageEntity(te, hit, damage, ammoExplosion, bFrag, damageIS,</span>
                            false);
    }

    /**
     * Deals the listed damage to an entity. Returns a vector of Reports for the
     * phase report
     *
     * @param te            the target entity
     * @param hit           the hit data for the location hit
     * @param damage        the damage to apply
     * @param ammoExplosion ammo explosion type damage is applied directly to the IS,
     *                      hurts the pilot, causes auto-ejects, and can blow the unit to
     *                      smithereens
     * @param bFrag         The DamageType of the attack.
     * @param damageIS      Should the target location's internal structure be damaged
     *                      directly?
     * @param areaSatArty   Is the damage from an area saturating artillery attack?
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt;s
     */
    public Vector&lt;Report&gt; damageEntity(Entity te, HitData hit, int damage,
                                        boolean ammoExplosion, DamageType bFrag, boolean damageIS,
                                        boolean areaSatArty) {
<span class="nc" id="L21808">        return damageEntity(te, hit, damage, ammoExplosion, bFrag, damageIS,</span>
                            areaSatArty, true);
    }

    /**
     * Deals the listed damage to an entity. Returns a vector of Reports for the
     * phase report
     *
     * @param te            the target entity
     * @param hit           the hit data for the location hit
     * @param damage        the damage to apply
     * @param ammoExplosion ammo explosion type damage is applied directly to the IS,
     *                      hurts the pilot, causes auto-ejects, and can blow the unit to
     *                      smithereens
     * @param bFrag         The DamageType of the attack.
     * @param damageIS      Should the target location's internal structure be damaged
     *                      directly?
     * @param areaSatArty   Is the damage from an area saturating artillery attack?
     * @param throughFront  Is the damage coming through the hex the unit is facing?
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt;s
     */
    public Vector&lt;Report&gt; damageEntity(Entity te, HitData hit, int damage,
                                       boolean ammoExplosion, DamageType bFrag, boolean damageIS,
                                       boolean areaSatArty, boolean throughFront) {
<span class="nc" id="L21832">        return damageEntity(te, hit, damage, ammoExplosion, bFrag, damageIS,</span>
                            areaSatArty, throughFront, false, false);
    }

    /**
     * Deals the listed damage to an entity. Returns a vector of Reports for the
     * phase report
     *
     * @param te            the target entity
     * @param hit           the hit data for the location hit
     * @param damage        the damage to apply
     * @param ammoExplosion ammo explosion type damage is applied directly to the IS,
     *                      hurts the pilot, causes auto-ejects, and can blow the unit to
     *                      smithereens
     * @param bFrag         The DamageType of the attack.
     * @param damageIS      Should the target location's internal structure be damaged
     *                      directly?
     * @param areaSatArty   Is the damage from an area saturating artillery attack?
     * @param throughFront  Is the damage coming through the hex the unit is facing?
     * @param underWater    Is the damage coming from an underwater attack
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt;s
     */
    public Vector&lt;Report&gt; damageEntity(Entity te, HitData hit, int damage,
            boolean ammoExplosion, DamageType bFrag, boolean damageIS,
            boolean areaSatArty, boolean throughFront, boolean underWater) {
<span class="nc" id="L21857">        return damageEntity(te, hit, damage, ammoExplosion, bFrag, damageIS,</span>
                            areaSatArty, throughFront, underWater, false);
    }

    /**
     * Deals the listed damage to an entity. Returns a vector of Reports for the
     * phase report
     *
     * @param te            the target entity
     * @param hit           the hit data for the location hit
     * @param damage        the damage to apply
     * @param ammoExplosion ammo explosion type damage is applied directly to the IS,
     *                      hurts the pilot, causes auto-ejects, and can blow the unit to
     *                      smithereens
     * @param bFrag         The DamageType of the attack.
     * @param damageIS      Should the target location's internal structure be damaged
     *                      directly?
     * @param areaSatArty   Is the damage from an area saturating artillery attack?
     * @param throughFront  Is the damage coming through the hex the unit is facing?
     * @param underWater    Is the damage coming from an underwater attack?
     * @param nukeS2S       is this a ship-to-ship nuke?
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt;s
     */
    public Vector&lt;Report&gt; damageEntity(Entity te, HitData hit, int damage,
            boolean ammoExplosion, DamageType bFrag, boolean damageIS,
            boolean areaSatArty, boolean throughFront, boolean underWater,
            boolean nukeS2S) {

<span class="nc" id="L21885">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L21887">        int te_n = te.getId();</span>

        // if this is a fighter squadron then pick an active fighter and pass on
        // the damage
<span class="nc bnc" id="L21891" title="All 2 branches missed.">        if (te instanceof FighterSquadron) {</span>
<span class="nc bnc" id="L21892" title="All 2 branches missed.">            if(te.getActiveSubEntities().orElse(Collections.emptyList()).isEmpty()) {</span>
<span class="nc" id="L21893">                return vDesc;</span>
            }
<span class="nc" id="L21895">            List&lt;Entity&gt; fighters = te.getSubEntities().orElse(Collections.emptyList());</span>
<span class="nc" id="L21896">            Entity fighter = fighters.get(hit.getLocation());</span>
<span class="nc" id="L21897">            HitData new_hit = fighter.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L21898">            new_hit.setBoxCars(hit.rolledBoxCars());</span>
<span class="nc" id="L21899">            new_hit.setGeneralDamageType(hit.getGeneralDamageType());</span>
<span class="nc" id="L21900">            new_hit.setCapital(hit.isCapital());</span>
<span class="nc" id="L21901">            new_hit.setCapMisCritMod(hit.getCapMisCritMod());</span>
<span class="nc" id="L21902">            new_hit.setSingleAV(hit.getSingleAV());</span>
<span class="nc" id="L21903">            new_hit.setAttackerId(hit.getAttackerId());</span>
<span class="nc" id="L21904">            return damageEntity(fighter, new_hit, damage, ammoExplosion, bFrag,</span>
                                damageIS, areaSatArty, throughFront, underWater, nukeS2S);
        }

        // Battle Armor takes full damage to each trooper from area-effect.
<span class="nc bnc" id="L21909" title="All 4 branches missed.">        if (areaSatArty &amp;&amp; (te instanceof BattleArmor)) {</span>
<span class="nc" id="L21910">            r = new Report(6044);</span>
<span class="nc" id="L21911">            r.subject = te.getId();</span>
<span class="nc" id="L21912">            r.indent(2);</span>
<span class="nc" id="L21913">            vDesc.add(r);</span>
<span class="nc bnc" id="L21914" title="All 2 branches missed.">            for (int i = 0; i &lt; ((BattleArmor) te).getTroopers(); i++) {</span>
<span class="nc" id="L21915">                hit.setLocation(BattleArmor.LOC_TROOPER_1 + i);</span>
<span class="nc bnc" id="L21916" title="All 2 branches missed.">                if (te.getInternal(hit) &gt; 0) {</span>
<span class="nc" id="L21917">                    vDesc.addAll(damageEntity(te, hit, damage, ammoExplosion, bFrag,</span>
                            damageIS, false, throughFront, underWater, nukeS2S));
                }
            }
<span class="nc" id="L21921">            return vDesc;</span>
        }

        // This is good for shields if a shield absorps the hit it shouldn't
        // effect the pilot.
        // TC SRM's that hit the head do external and internal damage but its
        // one hit and shouldn't cause
        // 2 hits to the pilot.
<span class="nc bnc" id="L21929" title="All 2 branches missed.">        boolean isHeadHit = (te instanceof Mech)</span>
<span class="nc bnc" id="L21930" title="All 2 branches missed.">                            &amp;&amp; (((Mech) te).getCockpitType() != Mech.COCKPIT_TORSO_MOUNTED)</span>
<span class="nc bnc" id="L21931" title="All 2 branches missed.">                            &amp;&amp; (hit.getLocation() == Mech.LOC_HEAD)</span>
<span class="nc bnc" id="L21932" title="All 2 branches missed.">                            &amp;&amp; ((hit.getEffect() &amp; HitData.EFFECT_NO_CRITICALS) != HitData.EFFECT_NO_CRITICALS);</span>

        // booleans to indicate criticals for AT2
<span class="nc" id="L21935">        boolean critSI = false;</span>
<span class="nc" id="L21936">        boolean critThresh = false;</span>

        // get the relevant damage for damage thresholding
<span class="nc" id="L21939">        int threshDamage = damage;</span>
        // weapon groups only get the damage of one weapon
<span class="nc bnc" id="L21941" title="All 2 branches missed.">        if ((hit.getSingleAV() &gt; -1)</span>
<span class="nc bnc" id="L21942" title="All 2 branches missed.">            &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)) {</span>
<span class="nc" id="L21943">            threshDamage = hit.getSingleAV();</span>
        }

        // is this capital-scale damage
<span class="nc" id="L21947">        boolean isCapital = hit.isCapital();</span>

        // check capital/standard damage
<span class="nc bnc" id="L21950" title="All 2 branches missed.">        if (isCapital</span>
<span class="nc bnc" id="L21951" title="All 4 branches missed.">            &amp;&amp; (!te.isCapitalScale() || game.getOptions().booleanOption(</span>
                OptionsConstants.ADVAERORULES_AERO_SANITY))) {
<span class="nc" id="L21953">            damage = 10 * damage;</span>
<span class="nc" id="L21954">            threshDamage = 10 * threshDamage;</span>
        }
<span class="nc bnc" id="L21956" title="All 4 branches missed.">        if (!isCapital &amp;&amp; te.isCapitalScale()</span>
<span class="nc bnc" id="L21957" title="All 2 branches missed.">            &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)) {</span>
<span class="nc" id="L21958">            damage = (int) Math.round(damage / 10.0);</span>
<span class="nc" id="L21959">            threshDamage = (int) Math.round(threshDamage / 10.0);</span>
        }

<span class="nc" id="L21962">        int damage_orig = damage;</span>

        // show Locations which have rerolled with Edge
<span class="nc" id="L21965">        HitData undoneLocation = hit.getUndoneLocation();</span>
<span class="nc bnc" id="L21966" title="All 2 branches missed.">        while (undoneLocation != null) {</span>
<span class="nc" id="L21967">            r = new Report(6500);</span>
<span class="nc" id="L21968">            r.subject = te_n;</span>
<span class="nc" id="L21969">            r.indent(2);</span>
<span class="nc" id="L21970">            r.addDesc(te);</span>
<span class="nc" id="L21971">            r.add(te.getLocationAbbr(undoneLocation));</span>
<span class="nc" id="L21972">            vDesc.addElement(r);</span>
<span class="nc" id="L21973">            undoneLocation = undoneLocation.getUndoneLocation();</span>
        } // while
        // if edge was uses, give at end overview of remaining
<span class="nc bnc" id="L21976" title="All 2 branches missed.">        if (hit.getUndoneLocation() != null) {</span>
<span class="nc" id="L21977">            r = new Report(6510);</span>
<span class="nc" id="L21978">            r.subject = te_n;</span>
<span class="nc" id="L21979">            r.indent(2);</span>
<span class="nc" id="L21980">            r.addDesc(te);</span>
<span class="nc" id="L21981">            r.add(te.getCrew().getOptions().intOption(OptionsConstants.EDGE));</span>
<span class="nc" id="L21982">            vDesc.addElement(r);</span>
        } // if

<span class="nc" id="L21985">        boolean autoEject = false;</span>
<span class="nc bnc" id="L21986" title="All 2 branches missed.">        if (ammoExplosion) {</span>
<span class="nc bnc" id="L21987" title="All 2 branches missed.">            if (te instanceof Mech) {</span>
<span class="nc" id="L21988">                Mech mech = (Mech) te;</span>
<span class="nc bnc" id="L21989" title="All 4 branches missed.">                if (mech.isAutoEject() &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION)</span>
<span class="nc bnc" id="L21990" title="All 2 branches missed.">                        || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION)</span>
<span class="nc bnc" id="L21991" title="All 2 branches missed.">                                &amp;&amp; mech.isCondEjectAmmo()))) {</span>
<span class="nc" id="L21992">                    autoEject = true;</span>
<span class="nc" id="L21993">                    vDesc.addAll(ejectEntity(te, true));</span>
                }
<span class="nc bnc" id="L21995" title="All 2 branches missed.">            } else if (te instanceof Aero) {</span>
<span class="nc" id="L21996">                Aero aero = (Aero) te;</span>
<span class="nc bnc" id="L21997" title="All 4 branches missed.">                if (aero.isAutoEject() &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION)</span>
<span class="nc bnc" id="L21998" title="All 2 branches missed.">                        || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION)</span>
<span class="nc bnc" id="L21999" title="All 2 branches missed.">                                &amp;&amp; aero.isCondEjectAmmo()))) {</span>
<span class="nc" id="L22000">                    autoEject = true;</span>
<span class="nc" id="L22001">                    vDesc.addAll(ejectEntity(te, true));</span>
                }
            }
        }
<span class="nc" id="L22005">        boolean isBattleArmor = te instanceof BattleArmor;</span>
<span class="nc bnc" id="L22006" title="All 4 branches missed.">        boolean isPlatoon = !isBattleArmor &amp;&amp; (te instanceof Infantry);</span>
<span class="nc" id="L22007">        boolean isFerroFibrousTarget = false;</span>
<span class="nc" id="L22008">        boolean wasDamageIS = false;</span>
<span class="nc" id="L22009">        boolean tookInternalDamage = damageIS;</span>
<span class="nc" id="L22010">        IHex te_hex = null;</span>

<span class="nc bnc" id="L22012" title="All 4 branches missed.">        boolean hardenedArmor = ((te instanceof Mech) || (te instanceof Tank))</span>
<span class="nc bnc" id="L22013" title="All 2 branches missed.">                &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_HARDENED);</span>
<span class="nc bnc" id="L22014" title="All 6 branches missed.">        boolean ferroLamellorArmor = ((te instanceof Mech) || (te instanceof Tank) || (te instanceof Aero))</span>
<span class="nc bnc" id="L22015" title="All 2 branches missed.">                &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_FERRO_LAMELLOR);</span>
<span class="nc bnc" id="L22016" title="All 6 branches missed.">        boolean reflectiveArmor = (((te instanceof Mech) || (te instanceof Tank) || (te instanceof Aero))</span>
<span class="nc bnc" id="L22017" title="All 4 branches missed.">                &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_REFLECTIVE))</span>
<span class="nc bnc" id="L22018" title="All 2 branches missed.">                || (isBattleArmor &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_BA_REFLECTIVE));</span>
<span class="nc bnc" id="L22019" title="All 6 branches missed.">        boolean reactiveArmor = (((te instanceof Mech) || (te instanceof Tank) || (te instanceof Aero))</span>
<span class="nc bnc" id="L22020" title="All 4 branches missed.">                &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_REACTIVE))</span>
<span class="nc bnc" id="L22021" title="All 2 branches missed.">                || (isBattleArmor &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_BA_REACTIVE));</span>
<span class="nc bnc" id="L22022" title="All 6 branches missed.">        boolean ballisticArmor = ((te instanceof Mech) || (te instanceof Tank) || (te instanceof Aero))</span>
<span class="nc bnc" id="L22023" title="All 2 branches missed.">                &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_BALLISTIC_REINFORCED);</span>
<span class="nc bnc" id="L22024" title="All 2 branches missed.">        boolean impactArmor = (te instanceof Mech)</span>
<span class="nc bnc" id="L22025" title="All 2 branches missed.">                &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_IMPACT_RESISTANT);</span>
<span class="nc bnc" id="L22026" title="All 2 branches missed.">        boolean bar5 = te.getBARRating(hit.getLocation()) &lt;= 5;</span>

        // TACs from the hit location table
        int crits;
<span class="nc bnc" id="L22030" title="All 2 branches missed.">        if ((hit.getEffect() &amp; HitData.EFFECT_CRITICAL) == HitData.EFFECT_CRITICAL) {</span>
<span class="nc" id="L22031">            crits = 1;</span>
        } else {
<span class="nc" id="L22033">            crits = 0;</span>
        }

        // this is for special crits, like AP and tandem-charge
<span class="nc" id="L22037">        int specCrits = 0;</span>

        // the bonus to the crit roll if using the
        // &quot;advanced determining critical hits rule&quot;
<span class="nc" id="L22041">        int critBonus = 0;</span>
<span class="nc bnc" id="L22042" title="All 8 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_CRIT_ROLL)</span>
            &amp;&amp; (damage_orig &gt; 0)
            &amp;&amp; ((te instanceof Mech) || (te instanceof Protomech))) {
<span class="nc" id="L22045">            critBonus = Math.min((damage_orig - 1) / 5, 4);</span>
        }

        // Find out if Human TRO plays a part it crit bonus
<span class="nc" id="L22049">        Entity ae = game.getEntity(hit.getAttackerId());</span>
<span class="nc bnc" id="L22050" title="All 4 branches missed.">        if ((ae != null) &amp;&amp; !areaSatArty) {</span>
<span class="nc bnc" id="L22051" title="All 4 branches missed.">            if ((te instanceof Mech) &amp;&amp; ae.hasAbility(OptionsConstants.MISC_HUMAN_TRO, Crew.HUMANTRO_MECH)) {</span>
<span class="nc" id="L22052">                critBonus += 1;</span>
<span class="nc bnc" id="L22053" title="All 4 branches missed.">            } else if ((te instanceof Aero) &amp;&amp; ae.hasAbility(OptionsConstants.MISC_HUMAN_TRO, Crew.HUMANTRO_AERO)) {</span>
<span class="nc" id="L22054">                critBonus += 1;</span>
<span class="nc bnc" id="L22055" title="All 4 branches missed.">            } else if ((te instanceof Tank) &amp;&amp; ae.hasAbility(OptionsConstants.MISC_HUMAN_TRO, Crew.HUMANTRO_VEE)) {</span>
<span class="nc" id="L22056">                critBonus += 1;</span>
<span class="nc bnc" id="L22057" title="All 4 branches missed.">            } else if ((te instanceof BattleArmor) &amp;&amp; ae.hasAbility(OptionsConstants.MISC_HUMAN_TRO, Crew.HUMANTRO_BA)) {</span>
<span class="nc" id="L22058">                critBonus += 1;</span>
            }
        }

<span class="nc" id="L22062">        HitData nextHit = null;</span>

        // Some &quot;hits&quot; on a ProtoMech are actually misses.
<span class="nc bnc" id="L22065" title="All 4 branches missed.">        if ((te instanceof Protomech) &amp;&amp; (hit.getLocation() == Protomech.LOC_NMISS)) {</span>
<span class="nc" id="L22066">            Protomech proto = (Protomech) te;</span>
<span class="nc" id="L22067">            r = new Report(6035);</span>
<span class="nc" id="L22068">            r.subject = te.getId();</span>
<span class="nc" id="L22069">            r.indent(2);</span>
<span class="nc bnc" id="L22070" title="All 2 branches missed.">            if (proto.isGlider()) {</span>
<span class="nc" id="L22071">                r.messageId = 6036;</span>
<span class="nc" id="L22072">                proto.setWingHits(proto.getWingHits() + 1);</span>
            }
<span class="nc" id="L22074">            vDesc.add(r);</span>
<span class="nc" id="L22075">            return vDesc;</span>
        }

        // check for critical hit/miss vs. a BA
<span class="nc bnc" id="L22079" title="All 4 branches missed.">        if ((crits &gt; 0) &amp;&amp; (te instanceof BattleArmor)) {</span>
            // possible critical miss if the rerolled location isn't alive
<span class="nc bnc" id="L22081" title="All 4 branches missed.">            if ((hit.getLocation() &gt;= te.locations()) || (te.getInternal(hit.getLocation()) &lt;= 0)) {</span>
<span class="nc" id="L22082">                r = new Report(6037);</span>
<span class="nc" id="L22083">                r.add(hit.getLocation());</span>
<span class="nc" id="L22084">                r.subject = te_n;</span>
<span class="nc" id="L22085">                r.indent(2);</span>
<span class="nc" id="L22086">                vDesc.addElement(r);</span>
<span class="nc" id="L22087">                return vDesc;</span>
            }
            // otherwise critical hit
<span class="nc" id="L22090">            r = new Report(6225);</span>
<span class="nc" id="L22091">            r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L22092">            r.subject = te_n;</span>
<span class="nc" id="L22093">            r.indent(2);</span>
<span class="nc" id="L22094">            vDesc.addElement(r);</span>

<span class="nc" id="L22096">            crits = 0;</span>
<span class="nc" id="L22097">            damage = Math.max(te.getInternal(hit.getLocation()) + te.getArmor(hit.getLocation()), damage);</span>
        }

<span class="nc bnc" id="L22100" title="All 4 branches missed.">        if ((te.getArmor(hit) &gt; 0) &amp;&amp; ((te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_FERRO_FIBROUS)</span>
<span class="nc bnc" id="L22101" title="All 2 branches missed.">                || (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_LIGHT_FERRO)</span>
<span class="nc bnc" id="L22102" title="All 2 branches missed.">                || (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_HEAVY_FERRO))) {</span>
<span class="nc" id="L22103">            isFerroFibrousTarget = true;</span>
        }

        // area effect against infantry is double damage
<span class="nc bnc" id="L22107" title="All 4 branches missed.">        if (isPlatoon &amp;&amp; areaSatArty) {</span>
            // PBI. Double damage.
<span class="nc" id="L22109">            damage *= 2;</span>
<span class="nc" id="L22110">            r = new Report(6039);</span>
<span class="nc" id="L22111">            r.subject = te_n;</span>
<span class="nc" id="L22112">            r.indent(2);</span>
<span class="nc" id="L22113">            vDesc.addElement(r);</span>
        }

        // Is the infantry in the open?
<span class="nc bnc" id="L22117" title="All 2 branches missed.">        if(ServerHelper.infantryInOpen(te, te_hex, game, isPlatoon, ammoExplosion, hit.isIgnoreInfantryDoubleDamage())) {</span>
            // PBI. Damage is doubled.
<span class="nc" id="L22119">            damage *= 2;</span>
<span class="nc" id="L22120">            r = new Report(6040);</span>
<span class="nc" id="L22121">            r.subject = te_n;</span>
<span class="nc" id="L22122">            r.indent(2);</span>
<span class="nc" id="L22123">            vDesc.addElement(r);</span>
        }

        // Is the infantry in vacuum?
<span class="nc bnc" id="L22127" title="All 8 branches missed.">        if ((isPlatoon || isBattleArmor) &amp;&amp; !te.isDestroyed() &amp;&amp; !te.isDoomed()</span>
<span class="nc bnc" id="L22128" title="All 2 branches missed.">            &amp;&amp; game.getPlanetaryConditions().isVacuum()) {</span>
            // PBI. Double damage.
<span class="nc" id="L22130">            damage *= 2;</span>
<span class="nc" id="L22131">            r = new Report(6041);</span>
<span class="nc" id="L22132">            r.subject = te_n;</span>
<span class="nc" id="L22133">            r.indent(2);</span>
<span class="nc" id="L22134">            vDesc.addElement(r);</span>
        }
        // If dealing with fragmentation missiles,
        // it does double damage to infantry...
        // We're actually going to abuse this for AX-head warheads, too, so as
        // to not add another parameter.
<span class="nc bnc" id="L22140" title="All 8 branches missed.">        switch (bFrag) {</span>
            case FRAGMENTATION:
                // Fragmentation missiles deal full damage to conventional
                // infantry
                // (only) and no damage to other target types.
<span class="nc bnc" id="L22145" title="All 2 branches missed.">                if (!isPlatoon) {</span>
<span class="nc" id="L22146">                    damage = 0;</span>
<span class="nc" id="L22147">                    r = new Report(6050); // For some reason this report never</span>
                    // actually shows up...
<span class="nc" id="L22149">                    r.subject = te_n;</span>
<span class="nc" id="L22150">                    r.indent(2);</span>
<span class="nc" id="L22151">                    vDesc.addElement(r);</span>
                } else {
<span class="nc" id="L22153">                    r = new Report(6045); // ...but this one displays just fine.</span>
<span class="nc" id="L22154">                    r.subject = te_n;</span>
<span class="nc" id="L22155">                    r.indent(2);</span>
<span class="nc" id="L22156">                    vDesc.addElement(r);</span>
                }
<span class="nc" id="L22158">                break;</span>
            case NONPENETRATING:
<span class="nc bnc" id="L22160" title="All 2 branches missed.">                if (!isPlatoon) {</span>
<span class="nc" id="L22161">                    damage = 0;</span>
<span class="nc" id="L22162">                    r = new Report(6051);</span>
<span class="nc" id="L22163">                    r.subject = te_n;</span>
<span class="nc" id="L22164">                    r.indent(2);</span>
<span class="nc" id="L22165">                    vDesc.addElement(r);</span>
                }
                break;
            case FLECHETTE:
                // Flechette ammo deals full damage to conventional infantry and
                // half damage to other targets (including battle armor).
<span class="nc bnc" id="L22171" title="All 2 branches missed.">                if (!isPlatoon) {</span>
<span class="nc" id="L22172">                    damage /= 2;</span>
<span class="nc" id="L22173">                    r = new Report(6060);</span>
<span class="nc" id="L22174">                    r.subject = te_n;</span>
<span class="nc" id="L22175">                    r.indent(2);</span>
<span class="nc" id="L22176">                    vDesc.addElement(r);</span>
                } else {
<span class="nc" id="L22178">                    r = new Report(6055);</span>
<span class="nc" id="L22179">                    r.subject = te_n;</span>
<span class="nc" id="L22180">                    r.indent(2);</span>
<span class="nc" id="L22181">                    vDesc.addElement(r);</span>
                }
<span class="nc" id="L22183">                break;</span>
            case ACID:
<span class="nc bnc" id="L22185" title="All 10 branches missed.">                if (isFerroFibrousTarget || reactiveArmor || reflectiveArmor</span>
                    || ferroLamellorArmor || bar5) {
<span class="nc bnc" id="L22187" title="All 2 branches missed.">                    if (te.getArmor(hit) &lt;= 0) {</span>
<span class="nc" id="L22188">                        break; // hitting IS, not acid-affected armor</span>
                    }
<span class="nc" id="L22190">                    damage = Math.min(te.getArmor(hit), 3);</span>
<span class="nc" id="L22191">                    r = new Report(6061);</span>
<span class="nc" id="L22192">                    r.subject = te_n;</span>
<span class="nc" id="L22193">                    r.indent(2);</span>
<span class="nc" id="L22194">                    r.add(damage);</span>
<span class="nc" id="L22195">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22196" title="All 2 branches missed.">                } else if (isPlatoon) {</span>
<span class="nc" id="L22197">                    damage = (int) Math.ceil(damage * 1.5);</span>
<span class="nc" id="L22198">                    r = new Report(6062);</span>
<span class="nc" id="L22199">                    r.subject = te_n;</span>
<span class="nc" id="L22200">                    r.indent(2);</span>
<span class="nc" id="L22201">                    vDesc.addElement(r);</span>
                }
                break;
            case INCENDIARY:
                // Incendiary AC ammo does +2 damage to unarmoured infantry
<span class="nc bnc" id="L22206" title="All 2 branches missed.">                if (isPlatoon) {</span>
<span class="nc" id="L22207">                    damage += 2;</span>
<span class="nc" id="L22208">                    r = new Report(6064);</span>
<span class="nc" id="L22209">                    r.subject = te_n;</span>
<span class="nc" id="L22210">                    r.indent(2);</span>
<span class="nc" id="L22211">                    vDesc.addElement(r);</span>
                }
                break;
            case ANTI_TSM:
<span class="nc" id="L22215">                te.hitThisRoundByAntiTSM = true;</span>
<span class="nc" id="L22216">                break;</span>
            case NAIL_RIVET:
                // no damage against armor of BAR rating &gt;=5
<span class="nc bnc" id="L22219" title="All 2 branches missed.">                if ((te.getBARRating(hit.getLocation()) &gt;= 5)</span>
<span class="nc bnc" id="L22220" title="All 2 branches missed.">                    &amp;&amp; (te.getArmor(hit.getLocation()) &gt; 0)) {</span>
<span class="nc" id="L22221">                    damage = 0;</span>
<span class="nc" id="L22222">                    r = new Report(6063);</span>
<span class="nc" id="L22223">                    r.subject = te_n;</span>
<span class="nc" id="L22224">                    r.indent(2);</span>
<span class="nc" id="L22225">                    vDesc.add(r);</span>
                }
                break;
            default:
                // We can ignore this.
                break;
        }

        // adjust VTOL rotor damage
<span class="nc bnc" id="L22234" title="All 4 branches missed.">        if ((te instanceof VTOL) &amp;&amp; (hit.getLocation() == VTOL.LOC_ROTOR)</span>
<span class="nc bnc" id="L22235" title="All 2 branches missed.">            &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_PHYSICAL)</span>
<span class="nc bnc" id="L22236" title="All 2 branches missed.">            &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_FULL_ROTOR_HITS)) {</span>
<span class="nc" id="L22237">            damage = (damage + 9) / 10;</span>
        }

        // save EI status, in case sensors crit destroys it
<span class="nc" id="L22241">        final boolean eiStatus = te.hasActiveEiCockpit();</span>
        // BA using EI implants receive +1 damage from attacks
<span class="nc bnc" id="L22243" title="All 6 branches missed.">        if (!(te instanceof Mech) &amp;&amp; !(te instanceof Protomech) &amp;&amp; eiStatus) {</span>
<span class="nc" id="L22244">            damage += 1;</span>
        }

        // check for case on Aeros
<span class="nc bnc" id="L22248" title="All 2 branches missed.">        if (te instanceof Aero) {</span>
<span class="nc" id="L22249">            Aero a = (Aero) te;</span>
<span class="nc bnc" id="L22250" title="All 4 branches missed.">            if (ammoExplosion &amp;&amp; a.hasCase()) {</span>
                // damage should be reduced by a factor of 2 for ammo explosions
                // according to p. 161, TW
<span class="nc" id="L22253">                damage /= 2;</span>
<span class="nc" id="L22254">                r = new Report(9010);</span>
<span class="nc" id="L22255">                r.subject = te_n;</span>
<span class="nc" id="L22256">                r.add(damage);</span>
<span class="nc" id="L22257">                r.indent(3);</span>
<span class="nc" id="L22258">                vDesc.addElement(r);</span>
            }
        }

        // infantry armor can reduce damage
<span class="nc bnc" id="L22263" title="All 4 branches missed.">        if (isPlatoon &amp;&amp; (((Infantry) te).calcDamageDivisor() != 1.0)) {</span>
<span class="nc" id="L22264">            r = new Report(6074);</span>
<span class="nc" id="L22265">            r.subject = te_n;</span>
<span class="nc" id="L22266">            r.indent(2);</span>
<span class="nc" id="L22267">            r.add(damage);</span>
<span class="nc" id="L22268">            damage = (int) Math.ceil((damage) / ((Infantry) te).calcDamageDivisor());</span>
<span class="nc" id="L22269">            r.add(damage);</span>
<span class="nc" id="L22270">            vDesc.addElement(r);</span>
        }

        // Allocate the damage
<span class="nc bnc" id="L22274" title="All 2 branches missed.">        while (damage &gt; 0) {</span>

            // first check for ammo explosions on aeros separately, because it
            // must be done before
            // standard to capital damage conversions
<span class="nc bnc" id="L22279" title="All 6 branches missed.">            if ((te instanceof Aero) &amp;&amp; (hit.getLocation() == Aero.LOC_AFT)</span>
                &amp;&amp; !damageIS) {
<span class="nc bnc" id="L22281" title="All 2 branches missed.">                for (Mounted mAmmo : te.getAmmo()) {</span>
<span class="nc bnc" id="L22282" title="All 6 branches missed.">                    if (mAmmo.isDumping() &amp;&amp; !mAmmo.isDestroyed() &amp;&amp; !mAmmo.isHit()</span>
<span class="nc bnc" id="L22283" title="All 2 branches missed.">                            &amp;&amp; !(mAmmo.getType() instanceof BombType)) {</span>
                        // doh. explode it
<span class="nc" id="L22285">                        vDesc.addAll(explodeEquipment(te, mAmmo.getLocation(), mAmmo));</span>
<span class="nc" id="L22286">                        mAmmo.setHit(true);</span>
                    }
<span class="nc" id="L22288">                }</span>
            }

<span class="nc bnc" id="L22291" title="All 2 branches missed.">            if (te.isAero()) {</span>
                // chance of a critical if damage greater than threshold
<span class="nc" id="L22293">                IAero a = (IAero) te;</span>
<span class="nc bnc" id="L22294" title="All 2 branches missed.">                if ((threshDamage &gt; a.getThresh(hit.getLocation()))) {</span>
<span class="nc" id="L22295">                    critThresh = true;</span>
<span class="nc" id="L22296">                    a.setCritThresh(true);</span>
                }
            }

            // Capital fighters receive damage differently
<span class="nc bnc" id="L22301" title="All 2 branches missed.">            if (te.isCapitalFighter()) {</span>
<span class="nc" id="L22302">                IAero a = (IAero) te;</span>
<span class="nc" id="L22303">                a.setCurrentDamage(a.getCurrentDamage() + damage);</span>
<span class="nc" id="L22304">                a.setCapArmor(a.getCapArmor() - damage);</span>
<span class="nc" id="L22305">                r = new Report(9065);</span>
<span class="nc" id="L22306">                r.subject = te_n;</span>
<span class="nc" id="L22307">                r.indent(2);</span>
<span class="nc" id="L22308">                r.newlines = 0;</span>
<span class="nc" id="L22309">                r.addDesc(te);</span>
<span class="nc" id="L22310">                r.add(damage);</span>
<span class="nc" id="L22311">                vDesc.addElement(r);</span>
<span class="nc" id="L22312">                r = new Report(6085);</span>
<span class="nc" id="L22313">                r.subject = te_n;</span>
<span class="nc" id="L22314">                r.add(Math.max(a.getCapArmor(), 0));</span>
<span class="nc" id="L22315">                vDesc.addElement(r);</span>
                // check to see if this destroyed the entity
<span class="nc bnc" id="L22317" title="All 2 branches missed.">                if (a.getCapArmor() &lt;= 0) {</span>
                    // Lets auto-eject if we can!
<span class="nc bnc" id="L22319" title="All 2 branches missed.">                    if (a instanceof LandAirMech) {</span>
                        // LAMs eject if the CT destroyed switch is on
<span class="nc" id="L22321">                        LandAirMech lam = (LandAirMech) a;</span>
<span class="nc bnc" id="L22322" title="All 2 branches missed.">                        if (lam.isAutoEject()</span>
<span class="nc bnc" id="L22323" title="All 2 branches missed.">                            &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L22324" title="All 2 branches missed.">                                    || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L22325" title="All 2 branches missed.">                                            &amp;&amp; lam.isCondEjectCTDest()))) {</span>
<span class="nc" id="L22326">                            addReport(ejectEntity(te, true, false));</span>
                        }
<span class="nc" id="L22328">                    } else {</span>
                        // Aeros eject if the SI Destroyed switch is on
<span class="nc" id="L22330">                        Aero aero = (Aero) a;</span>
<span class="nc bnc" id="L22331" title="All 2 branches missed.">                        if (aero.isAutoEject()</span>
<span class="nc bnc" id="L22332" title="All 2 branches missed.">                                &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION)</span>
<span class="nc bnc" id="L22333" title="All 2 branches missed.">                                    || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L22334" title="All 2 branches missed.">                                            &amp;&amp; aero.isCondEjectSIDest()))) {</span>
<span class="nc" id="L22335">                            addReport(ejectEntity(te, true, false));</span>
                        }
                    }
<span class="nc" id="L22338">                    vDesc.addAll(destroyEntity(te, &quot;Structural Integrity Collapse&quot;));</span>
<span class="nc" id="L22339">                    a.doDisbandDamage();</span>
<span class="nc" id="L22340">                    a.setCapArmor(0);</span>
<span class="nc bnc" id="L22341" title="All 2 branches missed.">                    if (hit.getAttackerId() != Entity.NONE) {</span>
<span class="nc" id="L22342">                        creditKill(te, game.getEntity(hit.getAttackerId()));</span>
                    }
                }
                // check for aero crits from natural 12 or threshold; LAMs take damage as mechs
<span class="nc bnc" id="L22346" title="All 2 branches missed.">                if (te instanceof Aero) {</span>
<span class="nc" id="L22347">                    checkAeroCrits(vDesc, (Aero) te, hit, damage_orig, critThresh,</span>
                                   critSI, ammoExplosion, nukeS2S);
                }
<span class="nc" id="L22350">                return vDesc;</span>
            }

<span class="nc bnc" id="L22353" title="All 4 branches missed.">            if (!((te instanceof Aero) &amp;&amp; ammoExplosion)) {</span>
                // report something different for Aero ammo explosions
<span class="nc" id="L22355">                r = new Report(6065);</span>
<span class="nc" id="L22356">                r.subject = te_n;</span>
<span class="nc" id="L22357">                r.indent(2);</span>
<span class="nc" id="L22358">                r.addDesc(te);</span>
<span class="nc" id="L22359">                r.add(damage);</span>
<span class="nc bnc" id="L22360" title="All 2 branches missed.">                if (damageIS) {</span>
<span class="nc" id="L22361">                    r.messageId = 6070;</span>
                }
<span class="nc" id="L22363">                r.add(te.getLocationAbbr(hit));</span>
<span class="nc" id="L22364">                vDesc.addElement(r);</span>
            }

            // was the section destroyed earlier this phase?
<span class="nc bnc" id="L22368" title="All 2 branches missed.">            if (te.getInternal(hit) == IArmorState.ARMOR_DOOMED) {</span>
                // cannot transfer a through armor crit if so
<span class="nc" id="L22370">                crits = 0;</span>
            }

            // here goes the fun :)
            // Shields take damage first then cowls then armor whee
            // Shield does not protect from ammo explosions or falls.
<span class="nc bnc" id="L22376" title="All 8 branches missed.">            if (!ammoExplosion &amp;&amp; !hit.isFallDamage() &amp;&amp; !damageIS &amp;&amp; te.hasShield()</span>
<span class="nc bnc" id="L22377" title="All 2 branches missed.">                    &amp;&amp; ((hit.getEffect() &amp; HitData.EFFECT_NO_CRITICALS) != HitData.EFFECT_NO_CRITICALS)) {</span>
<span class="nc" id="L22378">                Mech me = (Mech) te;</span>
<span class="nc" id="L22379">                int damageNew = me.shieldAbsorptionDamage(damage, hit.getLocation(), hit.isRear());</span>
                // if a shield absorbed the damage then lets tell the world
                // about it.
<span class="nc bnc" id="L22382" title="All 2 branches missed.">                if (damageNew != damage) {</span>
<span class="nc" id="L22383">                    int absorb = damage - damageNew;</span>
<span class="nc" id="L22384">                    te.damageThisPhase += absorb;</span>
<span class="nc" id="L22385">                    damage = damageNew;</span>

<span class="nc" id="L22387">                    r = new Report(3530);</span>
<span class="nc" id="L22388">                    r.subject = te_n;</span>
<span class="nc" id="L22389">                    r.indent(3);</span>
<span class="nc" id="L22390">                    r.add(absorb);</span>
<span class="nc" id="L22391">                    vDesc.addElement(r);</span>

<span class="nc bnc" id="L22393" title="All 2 branches missed.">                    if (damage &lt;= 0) {</span>
<span class="nc" id="L22394">                        crits = 0;</span>
<span class="nc" id="L22395">                        specCrits = 0;</span>
<span class="nc" id="L22396">                        isHeadHit = false;</span>
                    }
                }
            }

            // Armored Cowl may absorb some damage from hit
<span class="nc bnc" id="L22402" title="All 2 branches missed.">            if (te instanceof Mech) {</span>
<span class="nc" id="L22403">                Mech me = (Mech) te;</span>
<span class="nc bnc" id="L22404" title="All 6 branches missed.">                if (me.hasCowl() &amp;&amp; (hit.getLocation() == Mech.LOC_HEAD)</span>
                    &amp;&amp; !throughFront) {
<span class="nc" id="L22406">                    int damageNew = me.damageCowl(damage);</span>
<span class="nc" id="L22407">                    int damageDiff = damage - damageNew;</span>
<span class="nc" id="L22408">                    me.damageThisPhase += damageDiff;</span>
<span class="nc" id="L22409">                    damage = damageNew;</span>

<span class="nc" id="L22411">                    r = new Report(3520);</span>
<span class="nc" id="L22412">                    r.subject = te_n;</span>
<span class="nc" id="L22413">                    r.indent(3);</span>
<span class="nc" id="L22414">                    r.add(damageDiff);</span>
<span class="nc" id="L22415">                    vDesc.addElement(r);</span>
                }
            }

            // So might modular armor, if the location mounts any.
<span class="nc bnc" id="L22420" title="All 4 branches missed.">            if (!ammoExplosion &amp;&amp; !damageIS</span>
<span class="nc bnc" id="L22421" title="All 2 branches missed.">                    &amp;&amp; ((hit.getEffect() &amp; HitData.EFFECT_NO_CRITICALS) != HitData.EFFECT_NO_CRITICALS)) {</span>
<span class="nc" id="L22422">                int damageNew = te.getDamageReductionFromModularArmor(hit, damage, vDesc);</span>
<span class="nc" id="L22423">                int damageDiff = damage - damageNew;</span>
<span class="nc" id="L22424">                te.damageThisPhase += damageDiff;</span>
<span class="nc" id="L22425">                damage = damageNew;</span>
            }

            // Destroy searchlights on 7+ (torso hits on mechs)
<span class="nc bnc" id="L22429" title="All 2 branches missed.">            if (te.hasSpotlight()) {</span>
<span class="nc" id="L22430">                boolean spotlightHittable = true;</span>
<span class="nc" id="L22431">                int loc = hit.getLocation();</span>
<span class="nc bnc" id="L22432" title="All 2 branches missed.">                if (te instanceof Mech) {</span>
<span class="nc bnc" id="L22433" title="All 6 branches missed.">                    if ((loc != Mech.LOC_CT) &amp;&amp; (loc != Mech.LOC_LT) &amp;&amp; (loc != Mech.LOC_RT)) {</span>
<span class="nc" id="L22434">                        spotlightHittable = false;</span>
                    }
<span class="nc bnc" id="L22436" title="All 2 branches missed.">                } else if (te instanceof Tank) {</span>
<span class="nc bnc" id="L22437" title="All 2 branches missed.">                    if (te instanceof SuperHeavyTank) {</span>
<span class="nc bnc" id="L22438" title="All 10 branches missed.">                        if ((loc != Tank.LOC_FRONT)</span>
                                &amp;&amp; (loc != SuperHeavyTank.LOC_FRONTRIGHT)
                                &amp;&amp; (loc != SuperHeavyTank.LOC_FRONTLEFT)
                                &amp;&amp; (loc != SuperHeavyTank.LOC_REARRIGHT)
                                &amp;&amp; (loc != SuperHeavyTank.LOC_REARLEFT)) {
<span class="nc" id="L22443">                            spotlightHittable = false;</span>
                        }
<span class="nc bnc" id="L22445" title="All 2 branches missed.">                    } else if (te instanceof LargeSupportTank) {</span>
<span class="nc bnc" id="L22446" title="All 10 branches missed.">                        if ((loc != Tank.LOC_FRONT)</span>
                                &amp;&amp; (loc != LargeSupportTank.LOC_FRONTRIGHT)
                                &amp;&amp; (loc != LargeSupportTank.LOC_FRONTLEFT)
                                &amp;&amp; (loc != LargeSupportTank.LOC_REARRIGHT)
                                &amp;&amp; (loc != LargeSupportTank.LOC_REARLEFT)) {
<span class="nc" id="L22451">                            spotlightHittable = false;</span>
                        }
                    } else {
<span class="nc bnc" id="L22454" title="All 6 branches missed.">                        if ((loc != Tank.LOC_FRONT) &amp;&amp; (loc != Tank.LOC_RIGHT)</span>
                                &amp;&amp; (loc != Tank.LOC_LEFT)) {
<span class="nc" id="L22456">                            spotlightHittable = false;</span>
                        }
                    }

                }
<span class="nc bnc" id="L22461" title="All 2 branches missed.">                if (spotlightHittable) {</span>
<span class="nc" id="L22462">                    int spotroll = Compute.d6(2);</span>
<span class="nc" id="L22463">                    r = new Report(6072);</span>
<span class="nc" id="L22464">                    r.indent(2);</span>
<span class="nc" id="L22465">                    r.subject = te_n;</span>
<span class="nc" id="L22466">                    r.add(&quot;7+&quot;);</span>
<span class="nc" id="L22467">                    r.add(&quot;Searchlight&quot;);</span>
<span class="nc" id="L22468">                    r.add(spotroll);</span>
<span class="nc" id="L22469">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22470" title="All 2 branches missed.">                    if (spotroll &gt;= 7) {</span>
<span class="nc" id="L22471">                        r = new Report(6071);</span>
<span class="nc" id="L22472">                        r.subject = te_n;</span>
<span class="nc" id="L22473">                        r.indent(2);</span>
<span class="nc" id="L22474">                        r.add(&quot;Searchlight&quot;);</span>
<span class="nc" id="L22475">                        vDesc.addElement(r);</span>
<span class="nc" id="L22476">                        te.destroyOneSpotlight();</span>
                    }
                }
            }

            // Does an exterior passenger absorb some of the damage?
<span class="nc bnc" id="L22482" title="All 2 branches missed.">            if (!damageIS) {</span>
<span class="nc" id="L22483">                int nLoc = hit.getLocation();</span>
<span class="nc" id="L22484">                Entity passenger = te.getExteriorUnitAt(nLoc, hit.isRear());</span>
                // Does an exterior passenger absorb some of the damage?
<span class="nc bnc" id="L22486" title="All 8 branches missed.">                if (!ammoExplosion &amp;&amp; (null != passenger) &amp;&amp; !passenger.isDoomed()</span>
                        &amp;&amp; (bFrag != DamageType.IGNORE_PASSENGER)) {
<span class="nc" id="L22488">                    damage = damageExternalPassenger(te, hit, damage, vDesc, passenger);</span>
                }

<span class="nc bnc" id="L22491" title="All 6 branches missed.">                boolean bTorso = (nLoc == Mech.LOC_CT) || (nLoc == Mech.LOC_RT)</span>
                        || (nLoc == Mech.LOC_LT);

                // Does a swarming unit absorb damage?
<span class="nc" id="L22495">                int swarmer = te.getSwarmAttackerId();</span>
<span class="nc bnc" id="L22496" title="All 6 branches missed.">                if ((!(te instanceof Mech) || bTorso) &amp;&amp; (swarmer != Entity.NONE)</span>
<span class="nc bnc" id="L22497" title="All 8 branches missed.">                        &amp;&amp; ((hit.getEffect() &amp; HitData.EFFECT_CRITICAL) == 0) &amp;&amp; (Compute.d6() &gt;= 5)</span>
                        &amp;&amp; (bFrag != DamageType.IGNORE_PASSENGER) &amp;&amp; !ammoExplosion) {
<span class="nc" id="L22499">                    Entity swarm = game.getEntity(swarmer);</span>
                    // Yup. Roll up some hit data for that passenger.
<span class="nc" id="L22501">                    r = new Report(6076);</span>
<span class="nc" id="L22502">                    r.subject = swarmer;</span>
<span class="nc" id="L22503">                    r.indent(3);</span>
<span class="nc" id="L22504">                    r.addDesc(swarm);</span>
<span class="nc" id="L22505">                    vDesc.addElement(r);</span>

<span class="nc" id="L22507">                    HitData passHit = swarm.rollHitLocation(</span>
                            ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);

                    // How much damage will the swarm absorb?
<span class="nc" id="L22511">                    int absorb = 0;</span>
<span class="nc" id="L22512">                    HitData nextPassHit = passHit;</span>
                    do {
<span class="nc bnc" id="L22514" title="All 2 branches missed.">                        if (0 &lt; swarm.getArmor(nextPassHit)) {</span>
<span class="nc" id="L22515">                            absorb += swarm.getArmor(nextPassHit);</span>
                        }
<span class="nc bnc" id="L22517" title="All 2 branches missed.">                        if (0 &lt; swarm.getInternal(nextPassHit)) {</span>
<span class="nc" id="L22518">                            absorb += swarm.getInternal(nextPassHit);</span>
                        }
<span class="nc" id="L22520">                        nextPassHit = swarm.getTransferLocation(nextPassHit);</span>
<span class="nc bnc" id="L22521" title="All 2 branches missed.">                    } while ((damage &gt; absorb)</span>
<span class="nc bnc" id="L22522" title="All 2 branches missed.">                             &amp;&amp; (nextPassHit.getLocation() &gt;= 0));</span>

                    // Damage the swarm.
<span class="nc" id="L22525">                    int absorbedDamage = Math.min(damage, absorb);</span>
<span class="nc" id="L22526">                    Vector&lt;Report&gt; newReports = damageEntity(swarm, passHit,</span>
                                                             absorbedDamage);
<span class="nc bnc" id="L22528" title="All 2 branches missed.">                    for (Report newReport : newReports) {</span>
<span class="nc" id="L22529">                        newReport.indent(2);</span>
<span class="nc" id="L22530">                    }</span>
<span class="nc" id="L22531">                    vDesc.addAll(newReports);</span>

                    // Did some damage pass on?
<span class="nc bnc" id="L22534" title="All 2 branches missed.">                    if (damage &gt; absorb) {</span>
                        // Yup. Remove the absorbed damage.
<span class="nc" id="L22536">                        damage -= absorb;</span>
<span class="nc" id="L22537">                        r = new Report(6080);</span>
<span class="nc" id="L22538">                        r.subject = te_n;</span>
<span class="nc" id="L22539">                        r.indent(2);</span>
<span class="nc" id="L22540">                        r.add(damage);</span>
<span class="nc" id="L22541">                        r.addDesc(te);</span>
<span class="nc" id="L22542">                        vDesc.addElement(r);</span>
                    } else {
                        // Nope. Return our description.
<span class="nc" id="L22545">                        return vDesc;</span>
                    }
                }

                // is this a mech/tank dumping ammo being hit in the rear torso?
<span class="nc bnc" id="L22550" title="All 8 branches missed.">                if (((te instanceof Mech) &amp;&amp; hit.isRear() &amp;&amp; bTorso)</span>
<span class="nc bnc" id="L22551" title="All 2 branches missed.">                        || ((te instanceof Tank) &amp;&amp; (hit.getLocation() == (te instanceof SuperHeavyTank ? SuperHeavyTank.LOC_REAR</span>
<span class="nc bnc" id="L22552" title="All 2 branches missed.">                                : Tank.LOC_REAR)))) {</span>
<span class="nc bnc" id="L22553" title="All 2 branches missed.">                    for (Mounted mAmmo : te.getAmmo()) {</span>
<span class="nc bnc" id="L22554" title="All 4 branches missed.">                        if (mAmmo.isDumping() &amp;&amp; !mAmmo.isDestroyed()</span>
<span class="nc bnc" id="L22555" title="All 2 branches missed.">                            &amp;&amp; !mAmmo.isHit()) {</span>
                            // doh. explode it
<span class="nc" id="L22557">                            vDesc.addAll(explodeEquipment(te,</span>
<span class="nc" id="L22558">                                                          mAmmo.getLocation(), mAmmo));</span>
<span class="nc" id="L22559">                            mAmmo.setHit(true);</span>
                        }
<span class="nc" id="L22561">                    }</span>
                }
            }
            // is there armor in the location hit?
<span class="nc bnc" id="L22565" title="All 6 branches missed.">            if (!ammoExplosion &amp;&amp; (te.getArmor(hit) &gt; 0) &amp;&amp; !damageIS) {</span>
<span class="nc" id="L22566">                int tmpDamageHold = -1;</span>
<span class="nc" id="L22567">                int origDamage = damage;</span>

<span class="nc bnc" id="L22569" title="All 2 branches missed.">                if (isPlatoon) {</span>
                    // infantry armour works differently
<span class="nc" id="L22571">                    int armor = te.getArmor(hit);</span>
<span class="nc" id="L22572">                    int men = te.getInternal(hit);</span>
<span class="nc" id="L22573">                    tmpDamageHold = damage % 2;</span>
<span class="nc" id="L22574">                    damage /= 2;</span>
<span class="nc bnc" id="L22575" title="All 4 branches missed.">                    if ((tmpDamageHold == 1) &amp;&amp; (armor &gt;= men)) {</span>
                        // extra 1 point of damage to armor
<span class="nc" id="L22577">                        tmpDamageHold = damage;</span>
<span class="nc" id="L22578">                        damage++;</span>
                    } else {
                        // extra 0 or 1 point of damage to men
<span class="nc" id="L22581">                        tmpDamageHold += damage;</span>
                    }
                    // If the target has Ferro-Lamellor armor, we need to adjust
                    // damage. (4/5ths rounded down),
                    // Also check to eliminate crit chances for damage reduced
                    // to 0
<span class="nc bnc" id="L22587" title="All 2 branches missed.">                } else if (ferroLamellorArmor</span>
<span class="nc bnc" id="L22588" title="All 2 branches missed.">                           &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING)</span>
<span class="nc bnc" id="L22589" title="All 2 branches missed.">                           &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING_MISSILE)</span>
<span class="nc bnc" id="L22590" title="All 2 branches missed.">                           &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_IGNORES_DMG_REDUCTION)) {</span>
<span class="nc" id="L22591">                    tmpDamageHold = damage;</span>
<span class="nc" id="L22592">                    damage = (int) Math.floor((((double) damage) * 4) / 5);</span>
<span class="nc bnc" id="L22593" title="All 2 branches missed.">                    if (damage &lt;= 0) {</span>
<span class="nc" id="L22594">                        isHeadHit = false;</span>
<span class="nc" id="L22595">                        crits = 0;</span>
                    }
<span class="nc" id="L22597">                    r = new Report(6073);</span>
<span class="nc" id="L22598">                    r.subject = te_n;</span>
<span class="nc" id="L22599">                    r.indent(3);</span>
<span class="nc" id="L22600">                    r.add(damage);</span>
<span class="nc" id="L22601">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22602" title="All 2 branches missed.">                } else if (ballisticArmor</span>
<span class="nc bnc" id="L22603" title="All 2 branches missed.">                           &amp;&amp; ((hit.getGeneralDamageType() == HitData.DAMAGE_ARMOR_PIERCING_MISSILE)</span>
<span class="nc bnc" id="L22604" title="All 2 branches missed.">                               || (hit.getGeneralDamageType() == HitData.DAMAGE_ARMOR_PIERCING)</span>
<span class="nc bnc" id="L22605" title="All 2 branches missed.">                               || (hit.getGeneralDamageType() == HitData.DAMAGE_BALLISTIC)</span>
<span class="nc bnc" id="L22606" title="All 2 branches missed.">                               || (hit.getGeneralDamageType() == HitData.DAMAGE_MISSILE))) {</span>
<span class="nc" id="L22607">                    tmpDamageHold = damage;</span>
<span class="nc" id="L22608">                    damage = Math.max(1, damage / 2);</span>
<span class="nc" id="L22609">                    r = new Report(6088);</span>
<span class="nc" id="L22610">                    r.subject = te_n;</span>
<span class="nc" id="L22611">                    r.indent(3);</span>
<span class="nc" id="L22612">                    r.add(damage);</span>
<span class="nc" id="L22613">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22614" title="All 2 branches missed.">                } else if (impactArmor</span>
<span class="nc bnc" id="L22615" title="All 2 branches missed.">                           &amp;&amp; (hit.getGeneralDamageType() == HitData.DAMAGE_PHYSICAL)) {</span>
<span class="nc" id="L22616">                    tmpDamageHold = damage;</span>
<span class="nc" id="L22617">                    damage -= (int) Math.ceil((double) damage / 3);</span>
<span class="nc" id="L22618">                    damage = Math.max(1, damage);</span>
<span class="nc" id="L22619">                    r = new Report(6089);</span>
<span class="nc" id="L22620">                    r.subject = te_n;</span>
<span class="nc" id="L22621">                    r.indent(3);</span>
<span class="nc" id="L22622">                    r.add(damage);</span>
<span class="nc" id="L22623">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22624" title="All 2 branches missed.">                } else if (reflectiveArmor</span>
<span class="nc bnc" id="L22625" title="All 4 branches missed.">                           &amp;&amp; (hit.getGeneralDamageType() == HitData.DAMAGE_PHYSICAL)</span>
                           &amp;&amp; !isBattleArmor) { // BA reflec does not receive extra physical damage
<span class="nc" id="L22627">                    tmpDamageHold = damage;</span>
<span class="nc" id="L22628">                    int currArmor = te.getArmor(hit);</span>
<span class="nc" id="L22629">                    int dmgToDouble = Math.min(damage, currArmor / 2);</span>
<span class="nc" id="L22630">                    damage += dmgToDouble;</span>
<span class="nc" id="L22631">                    r = new Report(6066);</span>
<span class="nc" id="L22632">                    r.subject = te_n;</span>
<span class="nc" id="L22633">                    r.indent(3);</span>
<span class="nc" id="L22634">                    r.add(currArmor);</span>
<span class="nc" id="L22635">                    r.add(tmpDamageHold);</span>
<span class="nc" id="L22636">                    r.add(dmgToDouble);</span>
<span class="nc" id="L22637">                    r.add(damage);</span>
<span class="nc" id="L22638">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22639" title="All 6 branches missed.">                } else if (reflectiveArmor &amp;&amp; areaSatArty &amp;&amp; !isBattleArmor) {</span>
<span class="nc" id="L22640">                    tmpDamageHold = damage; // BA reflec does not receive extra AE damage</span>
<span class="nc" id="L22641">                    int currArmor = te.getArmor(hit);</span>
<span class="nc" id="L22642">                    int dmgToDouble = Math.min(damage, currArmor / 2);</span>
<span class="nc" id="L22643">                    damage += dmgToDouble;</span>
<span class="nc" id="L22644">                    r = new Report(6087);</span>
<span class="nc" id="L22645">                    r.subject = te_n;</span>
<span class="nc" id="L22646">                    r.indent(3);</span>
<span class="nc" id="L22647">                    r.add(currArmor);</span>
<span class="nc" id="L22648">                    r.add(tmpDamageHold);</span>
<span class="nc" id="L22649">                    r.add(dmgToDouble);</span>
<span class="nc" id="L22650">                    r.add(damage);</span>
<span class="nc" id="L22651">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22652" title="All 2 branches missed.">                } else if (reflectiveArmor</span>
<span class="nc bnc" id="L22653" title="All 2 branches missed.">                           &amp;&amp; (hit.getGeneralDamageType() == HitData.DAMAGE_ENERGY)) {</span>
<span class="nc" id="L22654">                    tmpDamageHold = damage;</span>
<span class="nc" id="L22655">                    damage = (int) Math.floor(((double) damage) / 2);</span>
<span class="nc bnc" id="L22656" title="All 2 branches missed.">                    if (tmpDamageHold == 1) {</span>
<span class="nc" id="L22657">                        damage = 1;</span>
                    }
<span class="nc" id="L22659">                    r = new Report(6067);</span>
<span class="nc" id="L22660">                    r.subject = te_n;</span>
<span class="nc" id="L22661">                    r.indent(3);</span>
<span class="nc" id="L22662">                    r.add(damage);</span>
<span class="nc" id="L22663">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22664" title="All 2 branches missed.">                } else if (reactiveArmor</span>
<span class="nc bnc" id="L22665" title="All 2 branches missed.">                           &amp;&amp; ((hit.getGeneralDamageType() == HitData.DAMAGE_MISSILE)</span>
<span class="nc bnc" id="L22666" title="All 4 branches missed.">                               || (hit.getGeneralDamageType() == HitData.DAMAGE_ARMOR_PIERCING_MISSILE) ||</span>
                               areaSatArty)) {
<span class="nc" id="L22668">                    tmpDamageHold = damage;</span>
<span class="nc" id="L22669">                    damage = (int) Math.floor(((double) damage) / 2);</span>
<span class="nc bnc" id="L22670" title="All 2 branches missed.">                    if (tmpDamageHold == 1) {</span>
<span class="nc" id="L22671">                        damage = 1;</span>
                    }
<span class="nc" id="L22673">                    r = new Report(6068);</span>
<span class="nc" id="L22674">                    r.subject = te_n;</span>
<span class="nc" id="L22675">                    r.indent(3);</span>
<span class="nc" id="L22676">                    r.add(damage);</span>
<span class="nc" id="L22677">                    vDesc.addElement(r);</span>
                }

                // If we're using optional tank damage thresholds, setup our hit
                // effects now...
<span class="nc bnc" id="L22682" title="All 2 branches missed.">                if ((te instanceof Tank)</span>
<span class="nc" id="L22683">                        &amp;&amp; game.getOptions()</span>
<span class="nc bnc" id="L22684" title="All 6 branches missed.">                                .booleanOption(OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)</span>
                        &amp;&amp; !((te instanceof VTOL) || (te instanceof GunEmplacement))) {
<span class="nc" id="L22686">                    int thresh = (int) Math.ceil(</span>
<span class="nc bnc" id="L22687" title="All 2 branches missed.">                            (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD_VARIABLE)</span>
<span class="nc" id="L22688">                                    ? te.getArmor(hit)</span>
<span class="nc" id="L22689">                                    : te.getOArmor(hit)) / (double) game.getOptions().intOption(</span>
                                            OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD_DIVISOR));

                    // adjust for hardened armor
<span class="nc bnc" id="L22693" title="All 2 branches missed.">                    if (hardenedArmor</span>
<span class="nc bnc" id="L22694" title="All 2 branches missed.">                            &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING)</span>
<span class="nc bnc" id="L22695" title="All 2 branches missed.">                            &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING_MISSILE)</span>
<span class="nc bnc" id="L22696" title="All 2 branches missed.">                            &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_IGNORES_DMG_REDUCTION)) {</span>
<span class="nc" id="L22697">                        thresh *= 2;</span>
                    }

<span class="nc bnc" id="L22700" title="All 4 branches missed.">                    if ((damage &gt; thresh) || (te.getArmor(hit) &lt; damage)) {</span>
<span class="nc" id="L22701">                        hit.setEffect(((Tank) te).getPotCrit());</span>
<span class="nc" id="L22702">                        ((Tank) te).setOverThresh(true);</span>
                        // TACs from the hit location table
<span class="nc bnc" id="L22704" title="All 2 branches missed.">                        crits = ((hit.getEffect() &amp; HitData.EFFECT_CRITICAL)</span>
<span class="nc" id="L22705">                                == HitData.EFFECT_CRITICAL) ? 1 : 0;</span>
                    } else {
<span class="nc" id="L22707">                        ((Tank) te).setOverThresh(false);</span>
<span class="nc" id="L22708">                        crits = 0;</span>
                    }
                }

                // if there's a mast mount in the rotor, it and all other
                // equipment
                // on it get destroyed
<span class="nc bnc" id="L22715" title="All 2 branches missed.">                if ((te instanceof VTOL)</span>
<span class="nc bnc" id="L22716" title="All 2 branches missed.">                    &amp;&amp; (hit.getLocation() == VTOL.LOC_ROTOR)</span>
<span class="nc bnc" id="L22717" title="All 2 branches missed.">                    &amp;&amp; te.hasWorkingMisc(MiscType.F_MAST_MOUNT, -1,</span>
                                         VTOL.LOC_ROTOR)) {
<span class="nc" id="L22719">                    r = new Report(6081);</span>
<span class="nc" id="L22720">                    r.subject = te_n;</span>
<span class="nc" id="L22721">                    r.indent(2);</span>
<span class="nc" id="L22722">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22723" title="All 2 branches missed.">                    for (Mounted mount : te.getMisc()) {</span>
<span class="nc bnc" id="L22724" title="All 2 branches missed.">                        if (mount.getLocation() == VTOL.LOC_ROTOR) {</span>
<span class="nc" id="L22725">                            mount.setHit(true);</span>
                        }
<span class="nc" id="L22727">                    }</span>
                }
                // Need to account for the possibility of hardened armor here
<span class="nc" id="L22730">                int armorThreshold = te.getArmor(hit);</span>
<span class="nc bnc" id="L22731" title="All 2 branches missed.">                if (hardenedArmor</span>
<span class="nc bnc" id="L22732" title="All 2 branches missed.">                    &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING)</span>
<span class="nc bnc" id="L22733" title="All 2 branches missed.">                    &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING_MISSILE)</span>
<span class="nc bnc" id="L22734" title="All 2 branches missed.">                    &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_IGNORES_DMG_REDUCTION)) {</span>
<span class="nc" id="L22735">                    armorThreshold *= 2;</span>
<span class="nc bnc" id="L22736" title="All 2 branches missed.">                    armorThreshold -= (te.isHardenedArmorDamaged(hit)) ? 1 : 0;</span>
<span class="nc" id="L22737">                    vDesc.lastElement().newlines = 0;</span>
<span class="nc" id="L22738">                    r = new Report(6069);</span>
<span class="nc" id="L22739">                    r.subject = te_n;</span>
<span class="nc" id="L22740">                    r.indent(3);</span>
<span class="nc" id="L22741">                    int reportedDamage = damage / 2;</span>
<span class="nc bnc" id="L22742" title="All 2 branches missed.">                    if ((damage % 2) &gt; 0) {</span>
<span class="nc" id="L22743">                        r.add(reportedDamage + &quot;.5&quot;);</span>
                    } else {
<span class="nc" id="L22745">                        r.add(reportedDamage);</span>
                    }

<span class="nc" id="L22748">                    vDesc.addElement(r);</span>
                }
<span class="nc bnc" id="L22750" title="All 2 branches missed.">                if (armorThreshold &gt;= damage) {</span>

                    // armor absorbs all damage
                    // Hardened armor deals with damage in its own fashion...
<span class="nc bnc" id="L22754" title="All 2 branches missed.">                    if (hardenedArmor</span>
<span class="nc bnc" id="L22755" title="All 2 branches missed.">                        &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING)</span>
<span class="nc bnc" id="L22756" title="All 2 branches missed.">                        &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING_MISSILE)</span>
<span class="nc bnc" id="L22757" title="All 2 branches missed.">                        &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_IGNORES_DMG_REDUCTION)) {</span>
<span class="nc" id="L22758">                        armorThreshold -= damage;</span>
<span class="nc bnc" id="L22759" title="All 2 branches missed.">                        te.setHardenedArmorDamaged(hit, (armorThreshold % 2) &gt; 0);</span>
<span class="nc" id="L22760">                        te.setArmor((armorThreshold / 2) + (armorThreshold % 2), hit);</span>
                    } else {
<span class="nc" id="L22762">                        te.setArmor(te.getArmor(hit) - damage, hit);</span>
                    }

                    // set &quot;armor damage&quot; flag for HarJel II/III
                    // we only care about this if there is armor remaining,
                    // so don't worry about the case where damage exceeds
                    // armorThreshold
<span class="nc bnc" id="L22769" title="All 4 branches missed.">                    if ((te instanceof Mech) &amp;&amp; (damage &gt; 0)) {</span>
<span class="nc" id="L22770">                        ((Mech) te).setArmorDamagedThisTurn(hit.getLocation(), true);</span>
                    }

                    // if the armor is hardened, any penetrating crits are
                    // rolled at -2
<span class="nc bnc" id="L22775" title="All 2 branches missed.">                    if (hardenedArmor) {</span>
<span class="nc" id="L22776">                        critBonus -= 2;</span>
                    }

<span class="nc bnc" id="L22779" title="All 2 branches missed.">                    if (tmpDamageHold &gt;= 0) {</span>
<span class="nc" id="L22780">                        te.damageThisPhase += tmpDamageHold;</span>
                    } else {
<span class="nc" id="L22782">                        te.damageThisPhase += damage;</span>
                    }
<span class="nc" id="L22784">                    damage = 0;</span>
<span class="nc bnc" id="L22785" title="All 2 branches missed.">                    if (!te.isHardenedArmorDamaged(hit)) {</span>
<span class="nc" id="L22786">                        r = new Report(6085);</span>
                    } else {
<span class="nc" id="L22788">                        r = new Report(6086);</span>
                    }

<span class="nc" id="L22791">                    r.subject = te_n;</span>
<span class="nc" id="L22792">                    r.indent(3);</span>
<span class="nc" id="L22793">                    r.add(te.getArmor(hit));</span>
<span class="nc" id="L22794">                    vDesc.addElement(r);</span>

                    // telemissiles are destroyed if they lose all armor
<span class="nc bnc" id="L22797" title="All 2 branches missed.">                    if ((te instanceof TeleMissile)</span>
<span class="nc bnc" id="L22798" title="All 2 branches missed.">                        &amp;&amp; (te.getArmor(hit) == damage)) {</span>
<span class="nc" id="L22799">                        vDesc.addAll(destroyEntity(te, &quot;damage&quot;, false));</span>
                    }

                } else {
                    // damage goes on to internal
<span class="nc" id="L22804">                    int absorbed = Math.max(te.getArmor(hit), 0);</span>
<span class="nc bnc" id="L22805" title="All 2 branches missed.">                    if (hardenedArmor</span>
<span class="nc bnc" id="L22806" title="All 2 branches missed.">                        &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING)</span>
<span class="nc bnc" id="L22807" title="All 2 branches missed.">                        &amp;&amp; (hit.getGeneralDamageType() != HitData.DAMAGE_ARMOR_PIERCING_MISSILE)) {</span>
<span class="nc" id="L22808">                        absorbed = (absorbed * 2)</span>
<span class="nc bnc" id="L22809" title="All 2 branches missed.">                                   - ((te.isHardenedArmorDamaged(hit)) ? 1 : 0);</span>
                    }
<span class="nc bnc" id="L22811" title="All 6 branches missed.">                    if (reflectiveArmor &amp;&amp; (hit.getGeneralDamageType() == HitData.DAMAGE_PHYSICAL)</span>
                            &amp;&amp; !isBattleArmor) {
<span class="nc" id="L22813">                        absorbed = (int) Math.ceil(absorbed / 2.0);</span>
<span class="nc" id="L22814">                        damage = tmpDamageHold;</span>
<span class="nc" id="L22815">                        tmpDamageHold = 0;</span>
                    }
<span class="nc" id="L22817">                    te.setArmor(IArmorState.ARMOR_DESTROYED, hit);</span>
<span class="nc bnc" id="L22818" title="All 2 branches missed.">                    if (tmpDamageHold &gt;= 0) {</span>
<span class="nc" id="L22819">                        te.damageThisPhase += 2 * absorbed;</span>
                    } else {
<span class="nc" id="L22821">                        te.damageThisPhase += absorbed;</span>
                    }
<span class="nc" id="L22823">                    damage -= absorbed;</span>
<span class="nc" id="L22824">                    r = new Report(6090);</span>
<span class="nc" id="L22825">                    r.subject = te_n;</span>
<span class="nc" id="L22826">                    r.indent(3);</span>
<span class="nc" id="L22827">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L22828" title="All 2 branches missed.">                    if (te instanceof GunEmplacement) {</span>
                        // gun emplacements have no internal,
                        // destroy the section
<span class="nc" id="L22831">                        te.destroyLocation(hit.getLocation());</span>
<span class="nc" id="L22832">                        r = new Report(6115);</span>
<span class="nc" id="L22833">                        r.subject = te_n;</span>
<span class="nc" id="L22834">                        vDesc.addElement(r);</span>

<span class="nc bnc" id="L22836" title="All 2 branches missed.">                        if (te.getTransferLocation(hit).getLocation() == Entity.LOC_DESTROYED) {</span>
<span class="nc" id="L22837">                            vDesc.addAll(destroyEntity(te, &quot;damage&quot;, false));</span>
                        }
                    }
                }

                // targets with BAR armor get crits, depending on damage and BAR
                // rating
<span class="nc bnc" id="L22844" title="All 2 branches missed.">                if (te.hasBARArmor(hit.getLocation())) {</span>
<span class="nc bnc" id="L22845" title="All 2 branches missed.">                    if (origDamage &gt; te.getBARRating(hit.getLocation())) {</span>
<span class="nc bnc" id="L22846" title="All 2 branches missed.">                        if (te.hasArmoredChassis()) {</span>
                            // crit roll with -1 mod
<span class="nc" id="L22848">                            vDesc.addAll(criticalEntity(te, hit.getLocation(),</span>
<span class="nc" id="L22849">                                                        hit.isRear(), -1 + critBonus, damage_orig));</span>
                        } else {
<span class="nc" id="L22851">                            vDesc.addAll(criticalEntity(te, hit.getLocation(),</span>
<span class="nc" id="L22852">                                                        hit.isRear(), critBonus, damage_orig));</span>
                        }
                    }
                }

<span class="nc bnc" id="L22857" title="All 4 branches missed.">                if ((tmpDamageHold &gt; 0) &amp;&amp; isPlatoon) {</span>
<span class="nc" id="L22858">                    damage = tmpDamageHold;</span>
                }
            }

            // For optional tank damage thresholds, the overthresh flag won't
            // be set if IS is damaged, so set it here.
<span class="nc bnc" id="L22864" title="All 2 branches missed.">            if ((te instanceof Tank)</span>
<span class="nc bnc" id="L22865" title="All 4 branches missed.">                    &amp;&amp; ((te.getArmor(hit) &lt; 1) || damageIS)</span>
<span class="nc bnc" id="L22866" title="All 6 branches missed.">                    &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)</span>
                    &amp;&amp; !((te instanceof VTOL)
                            || (te instanceof GunEmplacement))) {
<span class="nc" id="L22869">                ((Tank) te).setOverThresh(true);</span>
            }

            // is there damage remaining?
<span class="nc bnc" id="L22873" title="All 2 branches missed.">            if (damage &gt; 0) {</span>

                // if this is an Aero then I need to apply internal damage
                // to the SI after halving it. Return from here to prevent
                // further processing
<span class="nc bnc" id="L22878" title="All 2 branches missed.">                if (te instanceof Aero) {</span>
<span class="nc" id="L22879">                    Aero a = (Aero) te;</span>

                    // check for large craft ammo explosions here: damage vented through armor, excess
                    // dissipating, much like Tank CASE.
<span class="nc bnc" id="L22883" title="All 4 branches missed.">                    if (ammoExplosion &amp;&amp; te.isLargeCraft()) {</span>
<span class="nc" id="L22884">                        te.damageThisPhase += damage;</span>
<span class="nc" id="L22885">                        r = new Report(6128);</span>
<span class="nc" id="L22886">                        r.subject = te_n;</span>
<span class="nc" id="L22887">                        r.indent(2);</span>
<span class="nc" id="L22888">                        r.add(damage);</span>
<span class="nc" id="L22889">                        int loc = hit.getLocation();</span>
                        //Roll for broadside weapons so fore/aft side armor facing takes the damage
<span class="nc bnc" id="L22891" title="All 2 branches missed.">                        if (loc == Warship.LOC_LBS) {</span>
<span class="nc" id="L22892">                            int locRoll = Compute.d6();</span>
<span class="nc bnc" id="L22893" title="All 2 branches missed.">                            if (locRoll &lt; 4) {</span>
<span class="nc" id="L22894">                                loc = Jumpship.LOC_FLS;</span>
                            } else {
<span class="nc" id="L22896">                                loc = Jumpship.LOC_ALS;</span>
                            }
                        }
<span class="nc bnc" id="L22899" title="All 2 branches missed.">                        if (loc == Warship.LOC_RBS) {</span>
<span class="nc" id="L22900">                            int locRoll = Compute.d6();</span>
<span class="nc bnc" id="L22901" title="All 2 branches missed.">                            if (locRoll &lt; 4) {</span>
<span class="nc" id="L22902">                                loc = Jumpship.LOC_FRS;</span>
                            } else {
<span class="nc" id="L22904">                                loc = Jumpship.LOC_ARS;</span>
                            }
                        }
<span class="nc" id="L22907">                        r.add(te.getLocationAbbr(loc));</span>
<span class="nc" id="L22908">                        vDesc.add(r);</span>
<span class="nc bnc" id="L22909" title="All 2 branches missed.">                        if (damage &gt; te.getArmor(loc)) {</span>
<span class="nc" id="L22910">                            te.setArmor(IArmorState.ARMOR_DESTROYED, loc);</span>
<span class="nc" id="L22911">                            r = new Report(6090);</span>
                        } else {
<span class="nc" id="L22913">                            te.setArmor(te.getArmor(loc) - damage, loc);</span>
<span class="nc" id="L22914">                            r = new Report(6085);</span>
<span class="nc" id="L22915">                            r.add(te.getArmor(loc));</span>
                        }
<span class="nc" id="L22917">                        r.subject = te_n;</span>
<span class="nc" id="L22918">                        r.indent(3);</span>
<span class="nc" id="L22919">                        vDesc.add(r);</span>
<span class="nc" id="L22920">                        damage = 0;</span>
                    }

                    // check for overpenetration
<span class="nc bnc" id="L22924" title="All 2 branches missed.">                    if (game.getOptions().booleanOption(</span>
                            OptionsConstants.ADVAERORULES_STRATOPS_OVER_PENETRATE)) {
<span class="nc" id="L22926">                        int opRoll = Compute.d6(1);</span>
<span class="nc bnc" id="L22927" title="All 14 branches missed.">                        if ((((te instanceof Jumpship) || (te instanceof SpaceStation))</span>
                             &amp;&amp; !(te instanceof Warship) &amp;&amp; (opRoll &gt; 3))
                            || ((te instanceof Dropship) &amp;&amp; (opRoll &gt; 4))
                            || ((te instanceof Warship)
<span class="nc bnc" id="L22931" title="All 4 branches missed.">                                &amp;&amp; (a.get0SI() &lt;= 30) &amp;&amp; (opRoll &gt; 5))) {</span>
                            // over-penetration happened
<span class="nc" id="L22933">                            r = new Report(9090);</span>
<span class="nc" id="L22934">                            r.subject = te_n;</span>
<span class="nc" id="L22935">                            r.newlines = 0;</span>
<span class="nc" id="L22936">                            vDesc.addElement(r);</span>
<span class="nc" id="L22937">                            int new_loc = a.getOppositeLocation(hit</span>
<span class="nc" id="L22938">                                                                        .getLocation());</span>
<span class="nc" id="L22939">                            damage = Math.min(damage, te.getArmor(new_loc));</span>
                            // We don't want to deal negative damage
<span class="nc" id="L22941">                            damage = Math.max(damage, 0);</span>
<span class="nc" id="L22942">                            r = new Report(6065);</span>
<span class="nc" id="L22943">                            r.subject = te_n;</span>
<span class="nc" id="L22944">                            r.indent(2);</span>
<span class="nc" id="L22945">                            r.newlines = 0;</span>
<span class="nc" id="L22946">                            r.addDesc(te);</span>
<span class="nc" id="L22947">                            r.add(damage);</span>
<span class="nc" id="L22948">                            r.add(te.getLocationAbbr(new_loc));</span>
<span class="nc" id="L22949">                            vDesc.addElement(r);</span>
<span class="nc" id="L22950">                            te.setArmor(te.getArmor(new_loc) - damage, new_loc);</span>
<span class="nc bnc" id="L22951" title="All 4 branches missed.">                            if ((te instanceof Warship)</span>
                                || (te instanceof Dropship)) {
<span class="nc" id="L22953">                                damage = 2;</span>
                            } else {
<span class="nc" id="L22955">                                damage = 0;</span>
                            }
                        }
                    }

                    // divide damage in half
                    // do not divide by half if it is an ammo exposion
<span class="nc bnc" id="L22962" title="All 4 branches missed.">                    if (!ammoExplosion &amp;&amp; !nukeS2S</span>
<span class="nc bnc" id="L22963" title="All 2 branches missed.">                        &amp;&amp; !game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AERO_SANITY)) {</span>
<span class="nc" id="L22964">                        damage /= 2;</span>
                    }

                    // this should result in a crit
                    // but only if it really did damage after rounding down
<span class="nc bnc" id="L22969" title="All 2 branches missed.">                    if (damage &gt; 0) {</span>
<span class="nc" id="L22970">                        critSI = true;</span>
                    }

                    // Now apply damage to the structural integrity
<span class="nc" id="L22974">                    a.setSI(a.getSI() - damage);</span>
<span class="nc" id="L22975">                    te.damageThisPhase += damage;</span>
                    // send the report
<span class="nc" id="L22977">                    r = new Report(1210);</span>
<span class="nc" id="L22978">                    r.subject = te_n;</span>
<span class="nc" id="L22979">                    r.newlines = 1;</span>
<span class="nc bnc" id="L22980" title="All 2 branches missed.">                    if (!ammoExplosion) {</span>
<span class="nc" id="L22981">                        r.messageId = 9005;</span>
                    }
                    //Only for fighters
<span class="nc bnc" id="L22984" title="All 4 branches missed.">                    if (ammoExplosion &amp;&amp; !a.isLargeCraft()) {</span>
<span class="nc" id="L22985">                        r.messageId = 9006;</span>
                    }
<span class="nc" id="L22987">                    r.add(damage);</span>
<span class="nc" id="L22988">                    r.add(Math.max(a.getSI(), 0));</span>
<span class="nc" id="L22989">                    vDesc.addElement(r);</span>
                    // check to see if this would destroy the ASF
<span class="nc bnc" id="L22991" title="All 2 branches missed.">                    if (a.getSI() &lt;= 0) {</span>
                        // Lets auto-eject if we can!
<span class="nc bnc" id="L22993" title="All 2 branches missed.">                        if (a.isAutoEject()</span>
<span class="nc bnc" id="L22994" title="All 2 branches missed.">                            &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L22995" title="All 2 branches missed.">                                    || (game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION) </span>
<span class="nc bnc" id="L22996" title="All 2 branches missed.">                                            &amp;&amp; a.isCondEjectSIDest()))) {</span>
<span class="nc" id="L22997">                            vDesc.addAll(ejectEntity(te, true, false));</span>
                        } else {
<span class="nc" id="L22999">                            vDesc.addAll(destroyEntity(te,&quot;Structural Integrity Collapse&quot;));</span>
                        }
<span class="nc" id="L23001">                        a.setSI(0);</span>
<span class="nc bnc" id="L23002" title="All 2 branches missed.">                        if (hit.getAttackerId() != Entity.NONE) {</span>
<span class="nc" id="L23003">                            creditKill(a, game.getEntity(hit.getAttackerId()));</span>
                        }
                    }
<span class="nc" id="L23006">                    checkAeroCrits(vDesc, a, hit, damage_orig, critThresh, critSI, ammoExplosion, nukeS2S);</span>
<span class="nc" id="L23007">                    return vDesc;</span>
                }

                // Check for CASE II right away. if so reduce damage to 1
                // and let it hit the IS.
                // Also remove as much of the rear armor as allowed by the
                // damage. If arm/leg/head
                // Then they lose all their armor if its less then the
                // explosion damage.
<span class="nc bnc" id="L23016" title="All 4 branches missed.">                if (ammoExplosion &amp;&amp; te.hasCASEII(hit.getLocation())) {</span>
                    // 1 point of damage goes to IS
<span class="nc" id="L23018">                    damage--;</span>
                    // Remaining damage prevented by CASE II
<span class="nc" id="L23020">                    r = new Report(6126);</span>
<span class="nc" id="L23021">                    r.subject = te_n;</span>
<span class="nc" id="L23022">                    r.add(damage);</span>
<span class="nc" id="L23023">                    r.indent(3);</span>
<span class="nc" id="L23024">                    vDesc.addElement(r);</span>
<span class="nc" id="L23025">                    int loc = hit.getLocation();</span>
<span class="nc bnc" id="L23026" title="All 6 branches missed.">                    if ((te instanceof Mech) &amp;&amp; ((loc == Mech.LOC_HEAD) || ((Mech) te).isArm(loc)</span>
<span class="nc bnc" id="L23027" title="All 2 branches missed.">                            || te.locationIsLeg(loc))) {</span>
<span class="nc" id="L23028">                        int half = (int) Math.ceil(te.getOArmor(loc, false) / 2.0);</span>
<span class="nc bnc" id="L23029" title="All 2 branches missed.">                        if (damage &gt; half) {</span>
<span class="nc" id="L23030">                            damage = half;</span>
                        }
<span class="nc bnc" id="L23032" title="All 2 branches missed.">                        if (damage &gt;= te.getArmor(loc, false)) {</span>
<span class="nc" id="L23033">                            te.setArmor(IArmorState.ARMOR_DESTROYED, loc, false);</span>
                        } else {
<span class="nc" id="L23035">                            te.setArmor(te.getArmor(loc, false) - damage, loc, false);</span>
                        }
<span class="nc" id="L23037">                    } else {</span>
<span class="nc bnc" id="L23038" title="All 2 branches missed.">                        if (damage &gt;= te.getArmor(loc, true)) {</span>
<span class="nc" id="L23039">                            te.setArmor(IArmorState.ARMOR_DESTROYED, loc, true);</span>
                        } else {
<span class="nc" id="L23041">                            te.setArmor(te.getArmor(loc, true) - damage, loc, true);</span>
                        }
                    }

<span class="nc bnc" id="L23045" title="All 2 branches missed.">                    if (te.getInternal(hit) &gt; 0) {</span>
                        // Mek takes 1 point of IS damage
<span class="nc" id="L23047">                        damage = 1;</span>
                    } else {
<span class="nc" id="L23049">                        damage = 0;</span>
                    }

<span class="nc" id="L23052">                    te.damageThisPhase += damage;</span>

<span class="nc" id="L23054">                    int roll = Compute.d6(2);</span>
<span class="nc" id="L23055">                    r = new Report(6127);</span>
<span class="nc" id="L23056">                    r.subject = te.getId();</span>
<span class="nc" id="L23057">                    r.add(roll);</span>
<span class="nc" id="L23058">                    vDesc.add(r);</span>
<span class="nc bnc" id="L23059" title="All 2 branches missed.">                    if (roll &gt;= 8) {</span>
<span class="nc" id="L23060">                        hit.setEffect(HitData.EFFECT_NO_CRITICALS);</span>
                    }
                }
                // check for tank CASE here: damage to rear armor, excess
                // dissipating, and a crew stunned crit
<span class="nc bnc" id="L23065" title="All 4 branches missed.">                if (ammoExplosion &amp;&amp; (te instanceof Tank)</span>
<span class="nc bnc" id="L23066" title="All 2 branches missed.">                    &amp;&amp; te.locationHasCase(Tank.LOC_BODY)) {</span>
<span class="nc" id="L23067">                    te.damageThisPhase += damage;</span>
<span class="nc" id="L23068">                    r = new Report(6124);</span>
<span class="nc" id="L23069">                    r.subject = te_n;</span>
<span class="nc" id="L23070">                    r.indent(2);</span>
<span class="nc" id="L23071">                    r.add(damage);</span>
<span class="nc" id="L23072">                    vDesc.add(r);</span>
<span class="nc bnc" id="L23073" title="All 2 branches missed.">                    int loc = (te instanceof SuperHeavyTank) ? SuperHeavyTank.LOC_REAR</span>
<span class="nc bnc" id="L23074" title="All 2 branches missed.">                            : (te instanceof LargeSupportTank) ? LargeSupportTank.LOC_REAR : Tank.LOC_REAR;</span>
<span class="nc bnc" id="L23075" title="All 2 branches missed.">                    if (damage &gt; te.getArmor(loc)) {</span>
<span class="nc" id="L23076">                        te.setArmor(IArmorState.ARMOR_DESTROYED, loc);</span>
<span class="nc" id="L23077">                        r = new Report(6090);</span>
                    } else {
<span class="nc" id="L23079">                        te.setArmor(te.getArmor(loc) - damage, loc);</span>
<span class="nc" id="L23080">                        r = new Report(6085);</span>
<span class="nc" id="L23081">                        r.add(te.getArmor(loc));</span>
                    }
<span class="nc" id="L23083">                    r.subject = te_n;</span>
<span class="nc" id="L23084">                    r.indent(3);</span>
<span class="nc" id="L23085">                    vDesc.add(r);</span>
<span class="nc" id="L23086">                    damage = 0;</span>
                    int critIndex;
<span class="nc bnc" id="L23088" title="All 2 branches missed.">                    if (((Tank) te).isCommanderHit()</span>
<span class="nc bnc" id="L23089" title="All 2 branches missed.">                        &amp;&amp; ((Tank) te).isDriverHit()) {</span>
<span class="nc" id="L23090">                        critIndex = Tank.CRIT_CREW_KILLED;</span>
                    } else {
<span class="nc" id="L23092">                        critIndex = Tank.CRIT_CREW_STUNNED;</span>
                    }
<span class="nc" id="L23094">                    vDesc.addAll(applyCriticalHit(te, Entity.NONE, new CriticalSlot(0, critIndex), true, 0, false));</span>
                }

                // is there internal structure in the location hit?
<span class="nc bnc" id="L23098" title="All 2 branches missed.">                if (te.getInternal(hit) &gt; 0) {</span>

                    // Now we need to consider alternate structure types!
<span class="nc" id="L23101">                    int tmpDamageHold = -1;</span>
<span class="nc bnc" id="L23102" title="All 2 branches missed.">                    if ((te instanceof Mech)</span>
<span class="nc bnc" id="L23103" title="All 2 branches missed.">                        &amp;&amp; ((Mech) te).hasCompositeStructure()) {</span>
<span class="nc" id="L23104">                        tmpDamageHold = damage;</span>
<span class="nc" id="L23105">                        damage *= 2;</span>
<span class="nc" id="L23106">                        r = new Report(6091);</span>
<span class="nc" id="L23107">                        r.subject = te_n;</span>
<span class="nc" id="L23108">                        r.indent(3);</span>
<span class="nc" id="L23109">                        vDesc.add(r);</span>
                    }
<span class="nc bnc" id="L23111" title="All 2 branches missed.">                    if ((te instanceof Mech)</span>
<span class="nc bnc" id="L23112" title="All 2 branches missed.">                        &amp;&amp; ((Mech) te).hasReinforcedStructure()) {</span>
<span class="nc" id="L23113">                        tmpDamageHold = damage;</span>
<span class="nc" id="L23114">                        damage /= 2;</span>
<span class="nc" id="L23115">                        damage += tmpDamageHold % 2;</span>
<span class="nc" id="L23116">                        r = new Report(6092);</span>
<span class="nc" id="L23117">                        r.subject = te_n;</span>
<span class="nc" id="L23118">                        r.indent(3);</span>
<span class="nc" id="L23119">                        vDesc.add(r);</span>
                    }
<span class="nc bnc" id="L23121" title="All 4 branches missed.">                    if ((te.getInternal(hit) &gt; damage) &amp;&amp; (damage &gt; 0)) {</span>
                        // internal structure absorbs all damage
<span class="nc" id="L23123">                        te.setInternal(te.getInternal(hit) - damage, hit);</span>
                        // Triggers a critical hit on Vehicles and Mechs.
<span class="nc bnc" id="L23125" title="All 4 branches missed.">                        if (!isPlatoon &amp;&amp; !isBattleArmor) {</span>
<span class="nc" id="L23126">                            crits++;</span>
                        }
<span class="nc" id="L23128">                        tookInternalDamage = true;</span>
                        // Alternate structures don't affect our damage total
                        // for later PSR purposes, so use the previously stored
                        // value here as necessary.
<span class="nc bnc" id="L23132" title="All 2 branches missed.">                        te.damageThisPhase += (tmpDamageHold &gt; -1) ?</span>
<span class="nc" id="L23133">                                tmpDamageHold : damage;</span>
<span class="nc" id="L23134">                        damage = 0;</span>
<span class="nc" id="L23135">                        r = new Report(6100);</span>
<span class="nc" id="L23136">                        r.subject = te_n;</span>
<span class="nc" id="L23137">                        r.indent(3);</span>
                        // Infantry platoons have men not &quot;Internals&quot;.
<span class="nc bnc" id="L23139" title="All 2 branches missed.">                        if (isPlatoon) {</span>
<span class="nc" id="L23140">                            r.messageId = 6095;</span>
                        }
<span class="nc" id="L23142">                        r.add(te.getInternal(hit));</span>
<span class="nc" id="L23143">                        vDesc.addElement(r);</span>
<span class="nc bnc" id="L23144" title="All 2 branches missed.">                    } else if (damage &gt; 0) {</span>
                        // Triggers a critical hit on Vehicles and Mechs.
<span class="nc bnc" id="L23146" title="All 4 branches missed.">                        if (!isPlatoon &amp;&amp; !isBattleArmor) {</span>
<span class="nc" id="L23147">                            crits++;</span>
                        }
                        // damage transfers, maybe
<span class="nc" id="L23150">                        int absorbed = Math.max(te.getInternal(hit), 0);</span>

                        // Handle ProtoMech pilot damage
                        // due to location destruction
<span class="nc bnc" id="L23154" title="All 2 branches missed.">                        if (te instanceof Protomech) {</span>
<span class="nc" id="L23155">                            int hits = Protomech.POSSIBLE_PILOT_DAMAGE[hit.getLocation()]</span>
<span class="nc" id="L23156">                                    - ((Protomech) te).getPilotDamageTaken(hit.getLocation());</span>
<span class="nc bnc" id="L23157" title="All 2 branches missed.">                            if (hits &gt; 0) {</span>
<span class="nc" id="L23158">                                vDesc.addAll(damageCrew(te, hits));</span>
<span class="nc" id="L23159">                                ((Protomech) te).setPilotDamageTaken(hit.getLocation(),</span>
<span class="nc" id="L23160">                                        Protomech.POSSIBLE_PILOT_DAMAGE[hit.getLocation()]);</span>
                            }
                        }

                        // Platoon, Trooper, or Section destroyed message
<span class="nc" id="L23165">                        r = new Report(1210);</span>
<span class="nc" id="L23166">                        r.subject = te_n;</span>
<span class="nc bnc" id="L23167" title="All 2 branches missed.">                        if (isPlatoon) {</span>
                            // Infantry have only one section, and
                            // are therefore destroyed.
<span class="nc bnc" id="L23170" title="All 2 branches missed.">                            if (((Infantry) te).isSquad()) {</span>
<span class="nc" id="L23171">                                r.messageId = 6106; // Squad Killed</span>
                            } else {
<span class="nc" id="L23173">                                r.messageId = 6105; // Platoon Killed</span>
                            }
<span class="nc bnc" id="L23175" title="All 2 branches missed.">                        } else if (isBattleArmor) {</span>
<span class="nc" id="L23176">                            r.messageId = 6110;</span>
                        } else {
<span class="nc" id="L23178">                            r.messageId = 6115;</span>
                        }
<span class="nc" id="L23180">                        r.indent(3);</span>
<span class="nc" id="L23181">                        vDesc.addElement(r);</span>

                        // If a sidetorso got destroyed, and the
                        // corresponding arm is not yet destroyed, add
                        // it as a club to that hex (p.35 BMRr)
<span class="nc bnc" id="L23186" title="All 2 branches missed.">                        if ((te instanceof Mech)</span>
<span class="nc bnc" id="L23187" title="All 2 branches missed.">                                &amp;&amp; (((hit.getLocation() == Mech.LOC_RT)</span>
<span class="nc bnc" id="L23188" title="All 2 branches missed.">                                        &amp;&amp; (te.getInternal(Mech.LOC_RARM) &gt; 0))</span>
<span class="nc bnc" id="L23189" title="All 2 branches missed.">                                    || ((hit.getLocation() == Mech.LOC_LT)</span>
<span class="nc bnc" id="L23190" title="All 2 branches missed.">                                        &amp;&amp; (te.getInternal(Mech.LOC_LARM) &gt; 0)))) {</span>
                            int blownOffLocation;
<span class="nc bnc" id="L23192" title="All 2 branches missed.">                            if (hit.getLocation() == Mech.LOC_RT) {</span>
<span class="nc" id="L23193">                                blownOffLocation = Mech.LOC_RARM;</span>
                            } else {
<span class="nc" id="L23195">                                blownOffLocation = Mech.LOC_LARM;</span>
                            }
<span class="nc" id="L23197">                            te.destroyLocation(blownOffLocation, true);</span>
<span class="nc" id="L23198">                            r = new Report(6120);</span>
<span class="nc" id="L23199">                            r.subject = te_n;</span>
<span class="nc" id="L23200">                            r.add(te.getLocationName(blownOffLocation));</span>
<span class="nc" id="L23201">                            vDesc.addElement(r);</span>
<span class="nc" id="L23202">                            IHex h = game.getBoard().getHex(te.getPosition());</span>
<span class="nc bnc" id="L23203" title="All 2 branches missed.">                            if(null != h) {</span>
<span class="nc bnc" id="L23204" title="All 2 branches missed.">                                if (te instanceof BipedMech) {</span>
<span class="nc bnc" id="L23205" title="All 2 branches missed.">                                    if (!h.containsTerrain(Terrains.ARMS)) {</span>
<span class="nc" id="L23206">                                        h.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L23207">                                                             .createTerrain(Terrains.ARMS, 1));</span>
                                    } else {
<span class="nc" id="L23209">                                        h.addTerrain(Terrains</span>
<span class="nc" id="L23210">                                                             .getTerrainFactory()</span>
<span class="nc" id="L23211">                                                             .createTerrain(</span>
                                                                     Terrains.ARMS,
<span class="nc" id="L23213">                                                                     h.terrainLevel(Terrains.ARMS) + 1));</span>
                                    }
<span class="nc bnc" id="L23215" title="All 2 branches missed.">                                } else if (!h.containsTerrain(Terrains.LEGS)) {</span>
<span class="nc" id="L23216">                                    h.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L23217">                                                         .createTerrain(Terrains.LEGS, 1));</span>
                                } else {
<span class="nc" id="L23219">                                    h.addTerrain(Terrains</span>
<span class="nc" id="L23220">                                                         .getTerrainFactory()</span>
<span class="nc" id="L23221">                                                         .createTerrain(</span>
                                                                 Terrains.LEGS,
<span class="nc" id="L23223">                                                                 h.terrainLevel(Terrains.LEGS) + 1));</span>
                                }
<span class="nc" id="L23225">                                sendChangedHex(te.getPosition());</span>
                            }
                        }

                        // Troopers riding on a location
                        // all die when the location is destroyed.
<span class="nc bnc" id="L23231" title="All 4 branches missed.">                        if ((te instanceof Mech) || (te instanceof Tank)) {</span>
<span class="nc" id="L23232">                            Entity passenger = te.getExteriorUnitAt(</span>
<span class="nc" id="L23233">                                    hit.getLocation(), hit.isRear());</span>
<span class="nc bnc" id="L23234" title="All 4 branches missed.">                            if ((null != passenger) &amp;&amp; !passenger.isDoomed()) {</span>
<span class="nc" id="L23235">                                HitData passHit = passenger</span>
<span class="nc" id="L23236">                                        .getTrooperAtLocation(hit, te);</span>
                                // ensures a kill
<span class="nc" id="L23238">                                passHit.setEffect(HitData.EFFECT_CRITICAL);</span>
<span class="nc bnc" id="L23239" title="All 2 branches missed.">                                if (passenger.getInternal(passHit) &gt; 0) {</span>
<span class="nc" id="L23240">                                    vDesc.addAll(damageEntity(passenger,</span>
                                                              passHit, damage));
                                }
<span class="nc" id="L23243">                                passHit = new HitData(hit.getLocation(),</span>
<span class="nc bnc" id="L23244" title="All 2 branches missed.">                                                      !hit.isRear());</span>
<span class="nc" id="L23245">                                passHit = passenger.getTrooperAtLocation(</span>
                                        passHit, te);
                                // ensures a kill
<span class="nc" id="L23248">                                passHit.setEffect(HitData.EFFECT_CRITICAL);</span>
<span class="nc bnc" id="L23249" title="All 2 branches missed.">                                if (passenger.getInternal(passHit) &gt; 0) {</span>
<span class="nc" id="L23250">                                    vDesc.addAll(damageEntity(passenger,</span>
                                                              passHit, damage));
                                }
                            }
                        }

                        // BA inferno explosions
<span class="nc bnc" id="L23257" title="All 2 branches missed.">                        if (te instanceof BattleArmor) {</span>
<span class="nc" id="L23258">                            int infernos = 0;</span>
<span class="nc bnc" id="L23259" title="All 2 branches missed.">                            for (Mounted m : te.getEquipment()) {</span>
<span class="nc bnc" id="L23260" title="All 2 branches missed.">                                if (m.getType() instanceof AmmoType) {</span>
<span class="nc" id="L23261">                                    AmmoType at = (AmmoType) m.getType();</span>
<span class="nc bnc" id="L23262" title="All 4 branches missed.">                                    if (((at.getAmmoType() == AmmoType.T_SRM) || (at.getAmmoType() == AmmoType.T_MML))</span>
<span class="nc bnc" id="L23263" title="All 2 branches missed.">                                            &amp;&amp; (at.getMunitionType() == AmmoType.M_INFERNO)) {</span>
<span class="nc" id="L23264">                                        infernos += at.getRackSize() * m.getHittableShotsLeft();</span>
                                    }
<span class="nc bnc" id="L23266" title="All 2 branches missed.">                                } else if (m.getType().hasFlag(MiscType.F_FIRE_RESISTANT)) {</span>
                                    // immune to inferno explosion
<span class="nc" id="L23268">                                    infernos = 0;</span>
<span class="nc" id="L23269">                                    break;</span>
                                }
<span class="nc" id="L23271">                            }</span>
<span class="nc bnc" id="L23272" title="All 2 branches missed.">                            if (infernos &gt; 0) {</span>
<span class="nc" id="L23273">                                int roll = Compute.d6(2);</span>
<span class="nc" id="L23274">                                r = new Report(6680);</span>
<span class="nc" id="L23275">                                r.add(roll);</span>
<span class="nc" id="L23276">                                vDesc.add(r);</span>
<span class="nc bnc" id="L23277" title="All 2 branches missed.">                                if (roll &gt;= 8) {</span>
<span class="nc" id="L23278">                                    Coords c = te.getPosition();</span>
<span class="nc bnc" id="L23279" title="All 2 branches missed.">                                    if (c == null) {</span>
<span class="nc" id="L23280">                                        Entity transport = game.getEntity(te.getTransportId());</span>
<span class="nc bnc" id="L23281" title="All 2 branches missed.">                                        if (transport != null) {</span>
<span class="nc" id="L23282">                                            c = transport.getPosition();</span>
                                        }
<span class="nc" id="L23284">                                        vPhaseReport.addAll(deliverInfernoMissiles(te, te, infernos));</span>
                                    }
<span class="nc bnc" id="L23286" title="All 2 branches missed.">                                    if (c != null) {</span>
<span class="nc" id="L23287">                                        vPhaseReport.addAll(deliverInfernoMissiles(te,</span>
<span class="nc" id="L23288">                                                new HexTarget(c, game.getBoard(), Targetable.TYPE_HEX_ARTILLERY),</span>
                                                infernos));
                                    }
                                }
                            }
                        }

                        // Mark off the internal structure here, but *don't*
                        // destroy the location just yet -- there are checks
                        // still to run!
<span class="nc" id="L23298">                        te.setInternal(0, hit);</span>
<span class="nc" id="L23299">                        te.damageThisPhase += absorbed;</span>
<span class="nc" id="L23300">                        damage -= absorbed;</span>

                        // Now we need to consider alternate structure types!
<span class="nc bnc" id="L23303" title="All 2 branches missed.">                        if (tmpDamageHold &gt; 0) {</span>
<span class="nc bnc" id="L23304" title="All 2 branches missed.">                            if (((Mech) te).hasCompositeStructure()) {</span>
                                // If there's a remainder, we can actually
                                // ignore it.
<span class="nc" id="L23307">                                damage /= 2;</span>
<span class="nc bnc" id="L23308" title="All 2 branches missed.">                            } else if (((Mech) te).hasReinforcedStructure()) {</span>
<span class="nc" id="L23309">                                damage *= 2;</span>
<span class="nc" id="L23310">                                damage -= tmpDamageHold % 2;</span>
                            }
                        }
                    }
                }
<span class="nc bnc" id="L23315" title="All 2 branches missed.">                if (te.getInternal(hit) &lt;= 0) {</span>
                    // internal structure is gone, what are the transfer
                    // potentials?
<span class="nc" id="L23318">                    nextHit = te.getTransferLocation(hit);</span>
<span class="nc bnc" id="L23319" title="All 2 branches missed.">                    if (nextHit.getLocation() == Entity.LOC_DESTROYED) {</span>
<span class="nc bnc" id="L23320" title="All 2 branches missed.">                        if (te instanceof Mech) {</span>
                            // Start with the number of engine crits in this
                            // location, if any...
<span class="nc" id="L23323">                            te.engineHitsThisPhase += te.getNumberOfCriticals(</span>
                                    CriticalSlot.TYPE_SYSTEM,
<span class="nc" id="L23325">                                    Mech.SYSTEM_ENGINE, hit.getLocation());</span>
                            // ...then deduct the ones destroyed previously or
                            // critically
                            // hit this round already. That leaves the ones
                            // actually
                            // destroyed with the location.
<span class="nc" id="L23331">                            te.engineHitsThisPhase -= te.getHitCriticals(</span>
                                    CriticalSlot.TYPE_SYSTEM,
<span class="nc" id="L23333">                                    Mech.SYSTEM_ENGINE, hit.getLocation());</span>
                        }

<span class="nc" id="L23336">                        boolean engineExploded = checkEngineExplosion(te,</span>
                                vDesc, te.engineHitsThisPhase);

<span class="nc bnc" id="L23339" title="All 2 branches missed.">                        if (!engineExploded) {</span>
                            // Entity destroyed. Ammo explosions are
                            // neither survivable nor salvageable.
                            // Only ammo explosions in the CT are devastating.
<span class="nc bnc" id="L23343" title="All 10 branches missed.">                            vDesc.addAll(destroyEntity(te, &quot;damage&quot;, !ammoExplosion,</span>
                                    !((ammoExplosion || areaSatArty) &amp;&amp; ((te instanceof Tank)
<span class="nc bnc" id="L23345" title="All 2 branches missed.">                                            || ((te instanceof Mech) &amp;&amp; (hit.getLocation() == Mech.LOC_CT))))));</span>
                            // If the head is destroyed, kill the crew.

<span class="nc bnc" id="L23348" title="All 4 branches missed.">                            if ((te instanceof Mech) &amp;&amp; (hit.getLocation() == Mech.LOC_HEAD)</span>
<span class="nc bnc" id="L23349" title="All 4 branches missed.">                                    &amp;&amp; !te.getCrew().isDead() &amp;&amp; !te.getCrew().isDoomed()</span>
<span class="nc bnc" id="L23350" title="All 2 branches missed.">                                    &amp;&amp; game.getOptions().booleanOption(</span>
                                            OptionsConstants.ADVANCED_TACOPS_SKIN_OF_THE_TEETH_EJECTION)) {
<span class="nc" id="L23352">                                Mech mech = (Mech) te;</span>
<span class="nc bnc" id="L23353" title="All 2 branches missed.">                                if (mech.isAutoEject()</span>
<span class="nc bnc" id="L23354" title="All 2 branches missed.">                                        &amp;&amp; (!game.getOptions().booleanOption(</span>
                                                OptionsConstants.RPG_CONDITIONAL_EJECTION)
<span class="nc bnc" id="L23356" title="All 2 branches missed.">                                        || (game.getOptions().booleanOption(</span>
                                                OptionsConstants.RPG_CONDITIONAL_EJECTION)
<span class="nc bnc" id="L23358" title="All 2 branches missed.">                                                &amp;&amp; mech.isCondEjectHeadshot()))) {</span>
<span class="nc" id="L23359">                                    autoEject = true;</span>
<span class="nc" id="L23360">                                    vDesc.addAll(ejectEntity(te, true, true));</span>
                                }
                            }

<span class="nc bnc" id="L23364" title="All 4 branches missed.">                            if ((te instanceof Mech) &amp;&amp; (hit.getLocation() == Mech.LOC_CT)</span>
<span class="nc bnc" id="L23365" title="All 4 branches missed.">                                    &amp;&amp; !te.getCrew().isDead() &amp;&amp; !te.getCrew().isDoomed()) {</span>
<span class="nc" id="L23366">                                Mech mech = (Mech) te;</span>
<span class="nc bnc" id="L23367" title="All 2 branches missed.">                                if (mech.isAutoEject()</span>
<span class="nc bnc" id="L23368" title="All 2 branches missed.">                                        &amp;&amp; game.getOptions().booleanOption(</span>
                                                OptionsConstants.RPG_CONDITIONAL_EJECTION)
<span class="nc bnc" id="L23370" title="All 2 branches missed.">                                        &amp;&amp; mech.isCondEjectCTDest()) {</span>
<span class="nc bnc" id="L23371" title="All 2 branches missed.">                                    if (mech.getCrew().getHits() &lt; 5) {</span>
<span class="nc" id="L23372">                                        Report.addNewline(vDesc);</span>
<span class="nc" id="L23373">                                        mech.setDoomed(false);</span>
<span class="nc" id="L23374">                                        mech.setDoomed(true);</span>
                                    }
<span class="nc" id="L23376">                                    autoEject = true;</span>
<span class="nc" id="L23377">                                    vDesc.addAll(ejectEntity(te, true));</span>
                                }
                            }

<span class="nc bnc" id="L23381" title="All 2 branches missed.">                            if ((hit.getLocation() == Mech.LOC_HEAD)</span>
<span class="nc bnc" id="L23382" title="All 8 branches missed.">                                    || ((hit.getLocation() == Mech.LOC_CT)</span>
                                    &amp;&amp; ((ammoExplosion &amp;&amp; !autoEject) || areaSatArty))) {
<span class="nc" id="L23384">                                te.getCrew().setDoomed(true);</span>
                            }
<span class="nc bnc" id="L23386" title="All 2 branches missed.">                            if (game.getOptions().booleanOption(</span>
                                    OptionsConstants.ADVGRNDMOV_AUTO_ABANDON_UNIT)) {
<span class="nc" id="L23388">                                vDesc.addAll(abandonEntity(te));</span>
                            }
                        }

                        // nowhere for further damage to go
<span class="nc" id="L23393">                        damage = 0;</span>
<span class="nc bnc" id="L23394" title="All 2 branches missed.">                    } else if (nextHit.getLocation() == Entity.LOC_NONE) {</span>
                        // Rest of the damage is wasted.
<span class="nc" id="L23396">                        damage = 0;</span>
<span class="nc bnc" id="L23397" title="All 2 branches missed.">                    } else if (ammoExplosion</span>
<span class="nc bnc" id="L23398" title="All 2 branches missed.">                               &amp;&amp; te.locationHasCase(hit.getLocation())) {</span>
                        // Remaining damage prevented by CASE
<span class="nc" id="L23400">                        r = new Report(6125);</span>
<span class="nc" id="L23401">                        r.subject = te_n;</span>
<span class="nc" id="L23402">                        r.add(damage);</span>
<span class="nc" id="L23403">                        r.indent(3);</span>
<span class="nc" id="L23404">                        vDesc.addElement(r);</span>

                        // The target takes no more damage from the explosion.
<span class="nc" id="L23407">                        damage = 0;</span>
<span class="nc bnc" id="L23408" title="All 2 branches missed.">                    } else if (damage &gt; 0) {</span>
                        // remaining damage transfers
<span class="nc" id="L23410">                        r = new Report(6130);</span>
<span class="nc" id="L23411">                        r.subject = te_n;</span>
<span class="nc" id="L23412">                        r.indent(2);</span>
<span class="nc" id="L23413">                        r.add(damage);</span>
<span class="nc" id="L23414">                        r.add(te.getLocationAbbr(nextHit));</span>
<span class="nc" id="L23415">                        vDesc.addElement(r);</span>

                        // If there are split weapons in this location, mark it
                        // as hit, even if it took no criticals.
<span class="nc bnc" id="L23419" title="All 2 branches missed.">                        for (Mounted m : te.getWeaponList()) {</span>
<span class="nc bnc" id="L23420" title="All 2 branches missed.">                            if (m.isSplit()) {</span>
<span class="nc bnc" id="L23421" title="All 2 branches missed.">                                if ((m.getLocation() == hit.getLocation())</span>
<span class="nc" id="L23422">                                    || (m.getLocation() == nextHit</span>
<span class="nc bnc" id="L23423" title="All 2 branches missed.">                                        .getLocation())) {</span>
<span class="nc" id="L23424">                                    te.setWeaponHit(m);</span>
                                }
                            }
<span class="nc" id="L23427">                        }</span>
                        // if this is damage from a nail/rivet gun, and we
                        // transfer
                        // to a location that has armor, and BAR &gt;=5, no damage
<span class="nc bnc" id="L23431" title="All 2 branches missed.">                        if ((bFrag == DamageType.NAIL_RIVET)</span>
<span class="nc bnc" id="L23432" title="All 2 branches missed.">                            &amp;&amp; (te.getArmor(nextHit.getLocation()) &gt; 0)</span>
<span class="nc bnc" id="L23433" title="All 2 branches missed.">                            &amp;&amp; (te.getBARRating(nextHit.getLocation()) &gt;= 5)) {</span>
<span class="nc" id="L23434">                            damage = 0;</span>
<span class="nc" id="L23435">                            r = new Report(6065);</span>
<span class="nc" id="L23436">                            r.subject = te_n;</span>
<span class="nc" id="L23437">                            r.indent(2);</span>
<span class="nc" id="L23438">                            vDesc.add(r);</span>
                        }
                    }
                }
<span class="nc bnc" id="L23442" title="All 2 branches missed.">            } else if (hit.getSpecCrit()) {</span>
                // ok, we dealt damage but didn't go on to internal
                // we get a chance of a crit, using Armor Piercing.
                // but only if we don't have hardened, Ferro-Lamellor, or reactive armor
<span class="nc bnc" id="L23446" title="All 6 branches missed.">                if (!hardenedArmor &amp;&amp; !ferroLamellorArmor &amp;&amp; !reactiveArmor) {</span>
<span class="nc" id="L23447">                    specCrits++;</span>
                }
            }
            // check for breaching
<span class="nc" id="L23451">            vDesc.addAll(breachCheck(te, hit.getLocation(), null, underWater));</span>

            // resolve special results
<span class="nc bnc" id="L23454" title="All 2 branches missed.">            if ((hit.getEffect() &amp; HitData.EFFECT_VEHICLE_MOVE_DAMAGED) == HitData.EFFECT_VEHICLE_MOVE_DAMAGED) {</span>
<span class="nc" id="L23455">                vDesc.addAll(vehicleMotiveDamage((Tank) te, hit.getMotiveMod()));</span>
            }
            // Damage from any source can break spikes
<span class="nc bnc" id="L23458" title="All 2 branches missed.">            if (te.hasWorkingMisc(MiscType.F_SPIKES, -1, hit.getLocation())) {</span>
<span class="nc" id="L23459">                vDesc.add(checkBreakSpikes(te, hit.getLocation()));</span>
            }

            // roll all critical hits against this location
            // unless the section destroyed in a previous phase?
            // Cause a crit.
<span class="nc bnc" id="L23465" title="All 2 branches missed.">            if ((te.getInternal(hit) != IArmorState.ARMOR_DESTROYED)</span>
<span class="nc bnc" id="L23466" title="All 2 branches missed.">                    &amp;&amp; ((hit.getEffect() &amp; HitData.EFFECT_NO_CRITICALS) != HitData.EFFECT_NO_CRITICALS)) {</span>
<span class="nc bnc" id="L23467" title="All 2 branches missed.">                for (int i = 0; i &lt; crits; i++) {</span>
<span class="nc" id="L23468">                    vDesc.addAll(criticalEntity(te, hit.getLocation(), hit.isRear(),</span>
<span class="nc" id="L23469">                            hit.glancingMod() + critBonus, damage_orig));</span>
                }
<span class="nc" id="L23471">                crits = 0;</span>

<span class="nc bnc" id="L23473" title="All 2 branches missed.">                for (int i = 0; i &lt; specCrits; i++) {</span>
                    // against BAR or reflective armor, we get a +2 mod
<span class="nc bnc" id="L23475" title="All 2 branches missed.">                    int critMod = te.hasBARArmor(hit.getLocation()) ? 2 : 0;</span>
<span class="nc bnc" id="L23476" title="All 4 branches missed.">                    critMod += (reflectiveArmor &amp;&amp; !isBattleArmor) ? 2 : 0; // BA</span>
                    // against impact armor, we get a +1 mod
<span class="nc bnc" id="L23478" title="All 2 branches missed.">                    critMod += impactArmor ? 1 : 0;</span>
                    // hardened armour has no crit penalty
<span class="nc bnc" id="L23480" title="All 2 branches missed.">                    if (!hardenedArmor) {</span>
                        // non-hardened armor gets modifiers
                        // the -2 for hardened is handled in the critBonus
                        // variable
<span class="nc" id="L23484">                        critMod += hit.getSpecCritMod();</span>
<span class="nc" id="L23485">                        critMod += hit.glancingMod();</span>
                    }
<span class="nc" id="L23487">                    vDesc.addAll(criticalEntity(te, hit.getLocation(), hit.isRear(),</span>
                            critMod + critBonus, damage_orig));
                }
<span class="nc" id="L23490">                specCrits = 0;</span>
            }

            // resolve Aero crits
<span class="nc bnc" id="L23494" title="All 2 branches missed.">            if (te instanceof Aero) {</span>
<span class="nc" id="L23495">                checkAeroCrits(vDesc, (Aero) te, hit, damage_orig, critThresh, critSI,</span>
                        ammoExplosion, nukeS2S);
            }

<span class="nc bnc" id="L23499" title="All 2 branches missed.">            if (isHeadHit</span>
<span class="nc bnc" id="L23500" title="All 2 branches missed.">                &amp;&amp; !te.hasAbility(OptionsConstants.MD_DERMAL_ARMOR)) {</span>
<span class="nc" id="L23501">                Report.addNewline(vDesc);</span>
<span class="nc" id="L23502">                vDesc.addAll(damageCrew(te, 1));</span>
            }

            // If the location has run out of internal structure, finally
            // actually
            // destroy it here. *EXCEPTION:* Aero units have 0 internal
            // structure
            // in every location by default and are handled elsewhere, so they
            // get a bye.
<span class="nc bnc" id="L23511" title="All 4 branches missed.">            if (!(te instanceof Aero) &amp;&amp; (te.getInternal(hit) &lt;= 0)) {</span>
<span class="nc" id="L23512">                te.destroyLocation(hit.getLocation());</span>

                // Check for possible engine destruction here
<span class="nc bnc" id="L23515" title="All 2 branches missed.">                if ((te instanceof Mech)</span>
<span class="nc bnc" id="L23516" title="All 4 branches missed.">                        &amp;&amp; ((hit.getLocation() == Mech.LOC_RT) || (hit.getLocation() == Mech.LOC_LT))) {</span>

<span class="nc" id="L23518">                    int numEngineHits = te.getEngineHits();</span>
<span class="nc" id="L23519">                    boolean engineExploded = checkEngineExplosion(te, vDesc, numEngineHits);</span>

<span class="nc" id="L23521">                    int hitsToDestroy = 3;</span>
<span class="nc bnc" id="L23522" title="All 6 branches missed.">                    if ((te instanceof Mech) &amp;&amp; te.isSuperHeavy() &amp;&amp; te.hasEngine()</span>
<span class="nc bnc" id="L23523" title="All 2 branches missed.">                            &amp;&amp; (te.getEngine().getEngineType() == Engine.COMPACT_ENGINE)) {</span>
<span class="nc" id="L23524">                        hitsToDestroy = 2;</span>
                    }

<span class="nc bnc" id="L23527" title="All 4 branches missed.">                    if (!engineExploded &amp;&amp; (numEngineHits &gt;= hitsToDestroy)) {</span>
                        // third engine hit
<span class="nc" id="L23529">                        vDesc.addAll(destroyEntity(te, &quot;engine destruction&quot;));</span>
<span class="nc" id="L23530">                        if (game.getOptions()</span>
<span class="nc bnc" id="L23531" title="All 2 branches missed.">                                .booleanOption(OptionsConstants.ADVGRNDMOV_AUTO_ABANDON_UNIT)) {</span>
<span class="nc" id="L23532">                            vDesc.addAll(abandonEntity(te));</span>
                        }
<span class="nc" id="L23534">                        te.setSelfDestructing(false);</span>
<span class="nc" id="L23535">                        te.setSelfDestructInitiated(false);</span>
                    }

                    // Torso destruction in airborne LAM causes immediate crash.
<span class="nc bnc" id="L23539" title="All 6 branches missed.">                    if ((te instanceof LandAirMech) &amp;&amp; !te.isDestroyed() &amp;&amp; !te.isDoomed()) {</span>
<span class="nc" id="L23540">                        r = new Report(9710);</span>
<span class="nc" id="L23541">                        r.subject = te.getId();</span>
<span class="nc" id="L23542">                        r.addDesc(te);</span>
<span class="nc bnc" id="L23543" title="All 2 branches missed.">                        if (te.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L23544">                            vDesc.add(r);</span>
<span class="nc" id="L23545">                            crashAirMech(te, new PilotingRollData(te.getId(), TargetRoll.AUTOMATIC_FAIL,</span>
                                    &quot;side torso destroyed&quot;), vDesc);
<span class="nc bnc" id="L23547" title="All 4 branches missed.">                        } else if (te.isAirborne() &amp;&amp; te.isAero()) {</span>
<span class="nc" id="L23548">                            vDesc.add(r);</span>
<span class="nc" id="L23549">                            vDesc.addAll(processCrash(te, ((IAero)te).getCurrentVelocity(), te.getPosition()));</span>
                        }
                    }
                }

            }

            // If damage remains, loop to next location; if not, be sure to stop
            // here because we may need to refer back to the last *damaged*
            // location again later. (This is safe because at damage &lt;= 0 the
            // loop terminates anyway.)
<span class="nc bnc" id="L23560" title="All 2 branches missed.">            if (damage &gt; 0) {</span>
<span class="nc" id="L23561">                hit = nextHit;</span>
                // Need to update armor status for the new location
<span class="nc bnc" id="L23563" title="All 4 branches missed.">                hardenedArmor = ((te instanceof Mech) || (te instanceof Tank))</span>
<span class="nc bnc" id="L23564" title="All 2 branches missed.">                        &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_HARDENED);</span>
<span class="nc bnc" id="L23565" title="All 6 branches missed.">                ferroLamellorArmor = ((te instanceof Mech) || (te instanceof Tank) || (te instanceof Aero))</span>
<span class="nc bnc" id="L23566" title="All 2 branches missed.">                        &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_FERRO_LAMELLOR);</span>
<span class="nc bnc" id="L23567" title="All 6 branches missed.">                reflectiveArmor = (((te instanceof Mech) || (te instanceof Tank) || (te instanceof Aero))</span>
<span class="nc bnc" id="L23568" title="All 4 branches missed.">                        &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_REFLECTIVE))</span>
                        || (isBattleArmor
<span class="nc bnc" id="L23570" title="All 2 branches missed.">                                &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_BA_REFLECTIVE));</span>
<span class="nc bnc" id="L23571" title="All 6 branches missed.">                reactiveArmor = (((te instanceof Mech) || (te instanceof Tank) || (te instanceof Aero))</span>
<span class="nc bnc" id="L23572" title="All 4 branches missed.">                        &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_REACTIVE))</span>
<span class="nc bnc" id="L23573" title="All 2 branches missed.">                        || (isBattleArmor &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_BA_REACTIVE));</span>
<span class="nc bnc" id="L23574" title="All 6 branches missed.">                ballisticArmor = ((te instanceof Mech) || (te instanceof Tank) || (te instanceof Aero))</span>
<span class="nc bnc" id="L23575" title="All 2 branches missed.">                        &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_BALLISTIC_REINFORCED);</span>
<span class="nc bnc" id="L23576" title="All 2 branches missed.">                impactArmor = (te instanceof Mech)</span>
<span class="nc bnc" id="L23577" title="All 2 branches missed.">                        &amp;&amp; (te.getArmorType(hit.getLocation()) == EquipmentType.T_ARMOR_IMPACT_RESISTANT);</span>
            }
<span class="nc bnc" id="L23579" title="All 2 branches missed.">            if (damageIS) {</span>
<span class="nc" id="L23580">                wasDamageIS = true;</span>
<span class="nc" id="L23581">                damageIS = false;</span>
            }
        }
        // Mechs using EI implants take pilot damage each time a hit
        // inflicts IS damage
<span class="nc bnc" id="L23586" title="All 6 branches missed.">        if (tookInternalDamage</span>
            &amp;&amp; ((te instanceof Mech) || (te instanceof Protomech))
<span class="nc bnc" id="L23588" title="All 2 branches missed.">            &amp;&amp; te.hasActiveEiCockpit()) {</span>
<span class="nc" id="L23589">            Report.addNewline(vDesc);</span>
<span class="nc" id="L23590">            int roll = Compute.d6(2);</span>
<span class="nc" id="L23591">            r = new Report(5075);</span>
<span class="nc" id="L23592">            r.subject = te.getId();</span>
<span class="nc" id="L23593">            r.addDesc(te);</span>
<span class="nc" id="L23594">            r.add(7);</span>
<span class="nc" id="L23595">            r.add(roll);</span>
<span class="nc bnc" id="L23596" title="All 2 branches missed.">            r.choose(roll &gt;= 7);</span>
<span class="nc" id="L23597">            r.indent(2);</span>
<span class="nc" id="L23598">            vDesc.add(r);</span>
<span class="nc bnc" id="L23599" title="All 2 branches missed.">            if (roll &lt; 7) {</span>
<span class="nc" id="L23600">                vDesc.addAll(damageCrew(te, 1));</span>
            }
        }

        // if using VDNI (but not buffered), check for damage on an internal hit
<span class="nc bnc" id="L23605" title="All 2 branches missed.">        if (tookInternalDamage</span>
<span class="nc bnc" id="L23606" title="All 2 branches missed.">            &amp;&amp; te.hasAbility(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L23607" title="All 2 branches missed.">            &amp;&amp; !te.hasAbility(OptionsConstants.MD_BVDNI)</span>
<span class="nc bnc" id="L23608" title="All 2 branches missed.">            &amp;&amp; !te.hasAbility(OptionsConstants.MD_PAIN_SHUNT)) {</span>
<span class="nc" id="L23609">            Report.addNewline(vDesc);</span>
<span class="nc" id="L23610">            int roll = Compute.d6(2);</span>
<span class="nc" id="L23611">            r = new Report(3580);</span>
<span class="nc" id="L23612">            r.subject = te.getId();</span>
<span class="nc" id="L23613">            r.addDesc(te);</span>
<span class="nc" id="L23614">            r.add(7);</span>
<span class="nc" id="L23615">            r.add(roll);</span>
<span class="nc bnc" id="L23616" title="All 2 branches missed.">            r.choose(roll &gt;= 8);</span>
<span class="nc" id="L23617">            r.indent(2);</span>
<span class="nc" id="L23618">            vDesc.add(r);</span>
<span class="nc bnc" id="L23619" title="All 2 branches missed.">            if (roll &gt;= 8) {</span>
<span class="nc" id="L23620">                vDesc.addAll(damageCrew(te, 1));</span>
            }
        }

        // TacOps p.78 Ammo booms can hurt other units in same and adjacent hexes
        // But, this does not apply to CASE'd units and it only applies if the
        // ammo explosion
        // destroyed the unit
<span class="nc bnc" id="L23628" title="All 4 branches missed.">        if (ammoExplosion &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_AMMUNITION)</span>
            // For 'Mechs we care whether there was CASE specifically in the
            // location that went boom...
<span class="nc bnc" id="L23631" title="All 8 branches missed.">            &amp;&amp; !(te.locationHasCase(hit.getLocation()) || te.hasCASEII(hit.getLocation()))</span>
            // ...but vehicles and ASFs just have one CASE item for the
            // whole unit, so we need to look whether there's CASE anywhere
            // at all.
            &amp;&amp; !(((te instanceof Tank) || (te instanceof Aero)) &amp;&amp; te
<span class="nc bnc" id="L23636" title="All 10 branches missed.">                .hasCase()) &amp;&amp; (te.isDestroyed() || te.isDoomed())</span>
            &amp;&amp; (damage_orig &gt; 0) &amp;&amp; ((damage_orig / 10) &gt; 0)) {
<span class="nc" id="L23638">            Report.addNewline(vDesc);</span>
<span class="nc" id="L23639">            r = new Report(5068, Report.PUBLIC);</span>
<span class="nc" id="L23640">            r.subject = te.getId();</span>
<span class="nc" id="L23641">            r.addDesc(te);</span>
<span class="nc" id="L23642">            r.indent(2);</span>
<span class="nc" id="L23643">            vDesc.add(r);</span>
<span class="nc" id="L23644">            Report.addNewline(vDesc);</span>
<span class="nc" id="L23645">            r = new Report(5400, Report.PUBLIC);</span>
<span class="nc" id="L23646">            r.subject = te.getId();</span>
<span class="nc" id="L23647">            r.indent(2);</span>
<span class="nc" id="L23648">            vDesc.add(r);</span>
<span class="nc" id="L23649">            int[] damages = {(int) Math.floor(damage_orig / 10.0),</span>
<span class="nc" id="L23650">                             (int) Math.floor(damage_orig / 20.0)};</span>
<span class="nc" id="L23651">            doExplosion(damages, false, te.getPosition(), true, vDesc, null, 5,</span>
<span class="nc" id="L23652">                        te.getId(), false);</span>
<span class="nc" id="L23653">            Report.addNewline(vDesc);</span>
<span class="nc" id="L23654">            r = new Report(5410, Report.PUBLIC);</span>
<span class="nc" id="L23655">            r.subject = te.getId();</span>
<span class="nc" id="L23656">            r.indent(2);</span>
<span class="nc" id="L23657">            vDesc.add(r);</span>
        }

        // This flag indicates the hit was directly to IS
<span class="nc bnc" id="L23661" title="All 2 branches missed.">        if (wasDamageIS) {</span>
<span class="nc" id="L23662">            Report.addNewline(vDesc);</span>
        }
<span class="nc" id="L23664">        return vDesc;</span>
    }

    /**
     * Apply damage to an Entity carrying external Battle Armor or ProtoMech
     * when a location with a trooper present is hit.
     *
     * @param te             The carrying Entity
     * @param hit            The hit to resolve
     * @param damage         The amount of damage to be allocated
     * @param vDesc          The report vector
     * @param passenger      The BA squad
     * @return               The amount of damage remaining
     */
    private int damageExternalPassenger(Entity te, HitData hit, int damage, Vector&lt;Report&gt; vDesc,
                                        Entity passenger) {
        Report r;
<span class="nc" id="L23681">        int passengerDamage = damage;</span>
<span class="nc" id="L23682">        int avoidRoll = Compute.d6();</span>
<span class="nc" id="L23683">        HitData passHit = passenger.getTrooperAtLocation(hit, te);</span>
<span class="nc bnc" id="L23684" title="All 2 branches missed.">        if (passenger.hasETypeFlag(Entity.ETYPE_PROTOMECH)) {</span>
<span class="nc" id="L23685">            passengerDamage -= damage / 2;</span>
<span class="nc" id="L23686">            passHit = passenger.rollHitLocation(ToHitData.HIT_SPECIAL_PROTO, ToHitData.SIDE_FRONT);</span>
<span class="nc bnc" id="L23687" title="All 2 branches missed.">        } else if (avoidRoll &lt; 5) {</span>
<span class="nc" id="L23688">            passengerDamage = 0;</span>
        }
<span class="nc" id="L23690">        passHit.setGeneralDamageType(hit.getGeneralDamageType());</span>

<span class="nc bnc" id="L23692" title="All 2 branches missed.">        if (passengerDamage &gt; 0) {</span>
            // Yup. Roll up some hit data for that passenger.
<span class="nc" id="L23694">            r = new Report(6075);</span>
<span class="nc" id="L23695">            r.subject = passenger.getId();</span>
<span class="nc" id="L23696">            r.indent(3);</span>
<span class="nc" id="L23697">            r.addDesc(passenger);</span>
<span class="nc" id="L23698">            vDesc.addElement(r);</span>

            // How much damage will the passenger absorb?
<span class="nc" id="L23701">            int absorb = 0;</span>
<span class="nc" id="L23702">            HitData nextPassHit = passHit;</span>
            do {
<span class="nc" id="L23704">                int armorType = passenger.getArmorType(nextPassHit.getLocation());</span>
<span class="nc" id="L23705">                boolean armorDamageReduction = false;</span>
<span class="nc bnc" id="L23706" title="All 2 branches missed.">                if (((armorType == EquipmentType.T_ARMOR_BA_REACTIVE)</span>
<span class="nc bnc" id="L23707" title="All 2 branches missed.">                        &amp;&amp; ((hit.getGeneralDamageType() == HitData.DAMAGE_MISSILE)))</span>
<span class="nc bnc" id="L23708" title="All 2 branches missed.">                        || (hit.getGeneralDamageType() == HitData.DAMAGE_ARMOR_PIERCING_MISSILE)) {</span>
<span class="nc" id="L23709">                    armorDamageReduction = true;</span>
                }
                // Check for reflective armor
<span class="nc bnc" id="L23712" title="All 2 branches missed.">                if ((armorType == EquipmentType.T_ARMOR_BA_REFLECTIVE)</span>
<span class="nc bnc" id="L23713" title="All 2 branches missed.">                    &amp;&amp; (hit.getGeneralDamageType() == HitData.DAMAGE_ENERGY)) {</span>
<span class="nc" id="L23714">                    armorDamageReduction = true;</span>
                }
<span class="nc bnc" id="L23716" title="All 2 branches missed.">                if (0 &lt; passenger.getArmor(nextPassHit)) {</span>
<span class="nc" id="L23717">                    absorb += passenger.getArmor(nextPassHit);</span>
<span class="nc bnc" id="L23718" title="All 2 branches missed.">                    if (armorDamageReduction) {</span>
<span class="nc" id="L23719">                        absorb *= 2;</span>
                    }
                }
<span class="nc bnc" id="L23722" title="All 2 branches missed.">                if (0 &lt; passenger.getInternal(nextPassHit)) {</span>
<span class="nc" id="L23723">                    absorb += passenger.getInternal(nextPassHit);</span>
                    // Armor damage reduction, like for reflective or
                    // reactive armor will divide the whole damage
                    // total by 2 and round down. If we have an odd
                    // damage total, need to add 1 to make this
                    // evenly divisible by 2
<span class="nc bnc" id="L23729" title="All 4 branches missed.">                    if (((absorb % 2) != 0) &amp;&amp; armorDamageReduction) {</span>
<span class="nc" id="L23730">                        absorb++;</span>
                    }
                }
<span class="nc" id="L23733">                nextPassHit = passenger.getTransferLocation(nextPassHit);</span>
<span class="nc bnc" id="L23734" title="All 4 branches missed.">            } while ((damage &gt; absorb) &amp;&amp; (nextPassHit.getLocation() &gt;= 0));</span>

            // Damage the passenger.
<span class="nc" id="L23737">            absorb = Math.min(passengerDamage, absorb);</span>
<span class="nc" id="L23738">            Vector&lt;Report&gt; newReports = damageEntity(passenger, passHit, absorb);</span>
<span class="nc bnc" id="L23739" title="All 2 branches missed.">            for (Report newReport : newReports) {</span>
<span class="nc" id="L23740">                newReport.indent(2);</span>
<span class="nc" id="L23741">            }</span>
<span class="nc" id="L23742">            vDesc.addAll(newReports);</span>

            // Did some damage pass on?
<span class="nc bnc" id="L23745" title="All 2 branches missed.">            if (damage &gt; absorb) {</span>
                // Yup. Remove the absorbed damage.
<span class="nc" id="L23747">                damage -= absorb;</span>
<span class="nc" id="L23748">                r = new Report(6080);</span>
<span class="nc" id="L23749">                r.subject = te.getId();</span>
<span class="nc" id="L23750">                r.indent(2);</span>
<span class="nc" id="L23751">                r.add(damage);</span>
<span class="nc" id="L23752">                r.addDesc(te);</span>
<span class="nc" id="L23753">                vDesc.addElement(r);</span>
            } else {
                // Nope. Return our description.
<span class="nc" id="L23756">                return 0;</span>
            }

<span class="nc" id="L23759">        } else {</span>
            // Report that a passenger that could've been missed
            // narrowly avoids damage
<span class="nc" id="L23762">            r = new Report(6084);</span>
<span class="nc" id="L23763">            r.subject = passenger.getId();</span>
<span class="nc" id="L23764">            r.indent(3);</span>
<span class="nc" id="L23765">            r.addDesc(passenger);</span>
<span class="nc" id="L23766">            vDesc.addElement(r);</span>
        } // End nLoc-has-exterior-passenger
<span class="nc bnc" id="L23768" title="All 4 branches missed.">        if (passenger.hasETypeFlag(Entity.ETYPE_PROTOMECH)</span>
<span class="nc bnc" id="L23769" title="All 4 branches missed.">                &amp;&amp; (passengerDamage &gt; 0) &amp;&amp; !passenger.isDoomed() &amp;&amp; !passenger.isDestroyed()) {</span>
<span class="nc" id="L23770">            r = new Report(3850);</span>
<span class="nc" id="L23771">            r.subject = passenger.getId();</span>
<span class="nc" id="L23772">            r.indent(3);</span>
<span class="nc" id="L23773">            r.addDesc(passenger);</span>
<span class="nc" id="L23774">            vDesc.addElement(r);</span>
<span class="nc" id="L23775">            int facing = te.getFacing();</span>
            // We're going to assume that it's mounted facing the mech
<span class="nc" id="L23777">            Coords position = te.getPosition();</span>
<span class="nc bnc" id="L23778" title="All 2 branches missed.">            if (!hit.isRear()) {</span>
<span class="nc" id="L23779">                facing = (facing + 3) % 6;</span>
            }
<span class="nc" id="L23781">            unloadUnit(te, passenger, position, facing, te.getElevation(), false, false);</span>
<span class="nc" id="L23782">            Entity violation = Compute.stackingViolation(game,</span>
<span class="nc" id="L23783">                    passenger.getId(), position);</span>
<span class="nc bnc" id="L23784" title="All 2 branches missed.">            if (violation != null) {</span>
<span class="nc" id="L23785">                Coords targetDest = Compute.getValidDisplacement(game, passenger.getId(), position,</span>
<span class="nc" id="L23786">                        Compute.d6() - 1);</span>
<span class="nc" id="L23787">                addReport(doEntityDisplacement(violation, position, targetDest, null));</span>
                // Update the violating entity's position on the client.
<span class="nc" id="L23789">                entityUpdate(violation.getId());</span>
            }
        }
<span class="nc" id="L23792">        return damage;</span>
    }

    /**
     * Check to see if the entity's engine explodes. Rules for ICE explosions
     * are different to fusion engines.
     *
     * @param en    - the &lt;code&gt;Entity&lt;/code&gt; in question. This value must not be
     *              &lt;code&gt;null&lt;/code&gt;.
     * @param vDesc - the &lt;code&gt;Vector&lt;/code&gt; that this function should add its
     *              &lt;code&gt;Report&lt;code&gt;s to.  It may be empty, but not
     *              &lt;code&gt;null&lt;/code&gt;.
     * @param hits  - the number of criticals on the engine
     * @return &lt;code&gt;true&lt;/code&gt; if the unit's engine exploded,
     * &lt;code&gt;false&lt;/code&gt; if not.
     */
    private boolean checkEngineExplosion(Entity en, Vector&lt;Report&gt; vDesc, int hits) {
<span class="nc bnc" id="L23809" title="All 6 branches missed.">        if (!(en instanceof Mech) &amp;&amp; !(en instanceof Aero) &amp;&amp; !(en instanceof Tank)) {</span>
<span class="nc" id="L23810">            return false;</span>
        }
        // If this method gets called for an entity that's already destroyed or
        // that hasn't taken any actual engine hits this phase yet, do nothing.
<span class="nc bnc" id="L23814" title="All 4 branches missed.">        if (en.isDestroyed() || (en.engineHitsThisPhase &lt;= 0)</span>
<span class="nc bnc" id="L23815" title="All 4 branches missed.">                || en.getSelfDestructedThisTurn() || !en.hasEngine()) {</span>
<span class="nc" id="L23816">            return false;</span>
        }
<span class="nc" id="L23818">        int explosionBTH = 10;</span>
<span class="nc" id="L23819">        int hitsPerRound = 4;</span>
<span class="nc" id="L23820">        Engine engine = en.getEngine();</span>

<span class="nc bnc" id="L23822" title="All 2 branches missed.">        if(en instanceof Tank) {</span>
<span class="nc" id="L23823">            explosionBTH = 12;</span>
<span class="nc" id="L23824">            hitsPerRound = 1;</span>
<span class="nc bnc" id="L23825" title="All 2 branches missed.">        } else if(!(en instanceof Mech)) {</span>
<span class="nc" id="L23826">            explosionBTH = 12;</span>
<span class="nc" id="L23827">            hitsPerRound = 1;</span>
        }

        // Non mechs and mechs that already rolled are safe
<span class="nc bnc" id="L23831" title="All 4 branches missed.">        if (en.rolledForEngineExplosion || !(en instanceof Mech)) {</span>
<span class="nc" id="L23832">            return false;</span>
        }
        // ICE can always explode and roll every time hit
<span class="nc bnc" id="L23835" title="All 2 branches missed.">        if (engine.isFusion()</span>
<span class="nc bnc" id="L23836" title="All 4 branches missed.">                &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_ENGINE_EXPLOSIONS)</span>
                        || (en.engineHitsThisPhase &lt; hitsPerRound))) {
<span class="nc" id="L23838">            return false;</span>
        }
<span class="nc bnc" id="L23840" title="All 2 branches missed.">        if (!engine.isFusion()) {</span>
<span class="nc bnc" id="L23841" title="All 4 branches missed.">            switch (hits) {</span>
                case 0:
<span class="nc" id="L23843">                    return false;</span>
                case 1:
<span class="nc" id="L23845">                    explosionBTH = 10;</span>
<span class="nc" id="L23846">                    break;</span>
                case 2:
<span class="nc" id="L23848">                    explosionBTH = 7;</span>
<span class="nc" id="L23849">                    break;</span>
                case 3:
                default:
<span class="nc" id="L23852">                    explosionBTH = 4;</span>
                    break;
            }
        }
<span class="nc" id="L23856">        int explosionRoll = Compute.d6(2);</span>
<span class="nc bnc" id="L23857" title="All 2 branches missed.">        boolean didExplode = explosionRoll &gt;= explosionBTH;</span>

        Report r;
<span class="nc" id="L23860">        r = new Report(6150);</span>
<span class="nc" id="L23861">        r.subject = en.getId();</span>
<span class="nc" id="L23862">        r.indent(2);</span>
<span class="nc" id="L23863">        r.addDesc(en);</span>
<span class="nc" id="L23864">        r.add(en.engineHitsThisPhase);</span>
<span class="nc" id="L23865">        vDesc.addElement(r);</span>
<span class="nc" id="L23866">        r = new Report(6155);</span>
<span class="nc" id="L23867">        r.subject = en.getId();</span>
<span class="nc" id="L23868">        r.indent(2);</span>
<span class="nc" id="L23869">        r.add(explosionBTH);</span>
<span class="nc" id="L23870">        r.add(explosionRoll);</span>
<span class="nc" id="L23871">        vDesc.addElement(r);</span>

<span class="nc bnc" id="L23873" title="All 2 branches missed.">        if (!didExplode) {</span>
            // whew!
<span class="nc bnc" id="L23875" title="All 2 branches missed.">            if (engine.isFusion()) {</span>
<span class="nc" id="L23876">                en.rolledForEngineExplosion = true;</span>
            }
            // fusion engines only roll 1/phase but ICE roll every time damaged
<span class="nc" id="L23879">            r = new Report(6160);</span>
<span class="nc" id="L23880">            r.subject = en.getId();</span>
<span class="nc" id="L23881">            r.indent(2);</span>
<span class="nc" id="L23882">            vDesc.addElement(r);</span>
        } else {
<span class="nc" id="L23884">            en.rolledForEngineExplosion = true;</span>
<span class="nc" id="L23885">            r = new Report(6165, Report.PUBLIC);</span>
<span class="nc" id="L23886">            r.subject = en.getId();</span>
<span class="nc" id="L23887">            r.indent(2);</span>
<span class="nc" id="L23888">            vDesc.addElement(r);</span>
<span class="nc" id="L23889">            vDesc.addAll(destroyEntity(en, &quot;engine explosion&quot;, false, false));</span>
            // kill the crew
<span class="nc" id="L23891">            en.getCrew().setDoomed(true);</span>

            // This is a hack so MM.NET marks the mech as not salvageable
<span class="nc" id="L23894">            en.destroyLocation(Mech.LOC_CT);</span>

            // ICE explosions don't hurt anyone else, but fusion do
<span class="nc bnc" id="L23897" title="All 2 branches missed.">            if (engine.isFusion()) {</span>
<span class="nc" id="L23898">                int engineRating = en.getEngine().getRating();</span>
<span class="nc" id="L23899">                Report.addNewline(vDesc);</span>
<span class="nc" id="L23900">                r = new Report(5400, Report.PUBLIC);</span>
<span class="nc" id="L23901">                r.subject = en.getId();</span>
<span class="nc" id="L23902">                r.indent(2);</span>
<span class="nc" id="L23903">                vDesc.add(r);</span>

<span class="nc" id="L23905">                Mech mech = (Mech) en;</span>
<span class="nc bnc" id="L23906" title="All 4 branches missed.">                if (mech.isAutoEject() &amp;&amp; (!game.getOptions().booleanOption(</span>
                        OptionsConstants.RPG_CONDITIONAL_EJECTION)
<span class="nc bnc" id="L23908" title="All 2 branches missed.">                        || (game.getOptions().booleanOption(</span>
                                OptionsConstants.RPG_CONDITIONAL_EJECTION)
<span class="nc bnc" id="L23910" title="All 2 branches missed.">                        &amp;&amp; mech.isCondEjectEngine()))) {</span>
<span class="nc" id="L23911">                    vDesc.addAll(ejectEntity(en, true));</span>
                }

<span class="nc" id="L23914">                doFusionEngineExplosion(engineRating, en.getPosition(), vDesc, null);</span>
<span class="nc" id="L23915">                Report.addNewline(vDesc);</span>
<span class="nc" id="L23916">                r = new Report(5410, Report.PUBLIC);</span>
<span class="nc" id="L23917">                r.subject = en.getId();</span>
<span class="nc" id="L23918">                r.indent(2);</span>
<span class="nc" id="L23919">                vDesc.add(r);</span>

            }
        }

<span class="nc" id="L23924">        return didExplode;</span>
    }

    /**
     * Extract explosion functionality for generalized explosions in areas.
     */
    public void doFusionEngineExplosion(int engineRating, Coords position, Vector&lt;Report&gt; vDesc,
                                        Vector&lt;Integer&gt; vUnits) {
<span class="nc" id="L23932">        int[] myDamages = { engineRating, (engineRating / 10), (engineRating / 20),</span>
                (engineRating / 40) };
<span class="nc" id="L23934">        doExplosion(myDamages, true, position, false, vDesc, vUnits, 5, -1, true);</span>
<span class="nc" id="L23935">    }</span>

    /**
     * General function to cause explosions in areas.
     */
    public void doExplosion(int damage, int degradation, boolean autoDestroyInSameHex,
                            Coords position, boolean allowShelter, Vector&lt;Report&gt; vDesc,
                            Vector&lt;Integer&gt; vUnits, int excludedUnitId) {
<span class="nc bnc" id="L23943" title="All 2 branches missed.">        if (degradation &lt; 1) {</span>
<span class="nc" id="L23944">            return;</span>
        }

<span class="nc" id="L23947">        int[] myDamages = new int[damage / degradation];</span>

<span class="nc bnc" id="L23949" title="All 2 branches missed.">        if (myDamages.length &lt; 1) {</span>
<span class="nc" id="L23950">            return;</span>
        }

<span class="nc" id="L23953">        myDamages[0] = damage;</span>
<span class="nc bnc" id="L23954" title="All 2 branches missed.">        for (int x = 1; x &lt; myDamages.length; x++) {</span>
<span class="nc" id="L23955">            myDamages[x] = myDamages[x - 1] - degradation;</span>
        }
<span class="nc" id="L23957">        doExplosion(myDamages, autoDestroyInSameHex, position, allowShelter, vDesc, vUnits,</span>
                5, excludedUnitId, false);
<span class="nc" id="L23959">    }</span>

    /**
     * General function to cause explosions in areas.
     */
    public void doExplosion(int[] damages, boolean autoDestroyInSameHex, Coords position,
                            boolean allowShelter, Vector&lt;Report&gt; vDesc, Vector&lt;Integer&gt; vUnits,
                            int clusterAmt, int excludedUnitId, boolean engineExplosion) {
<span class="nc bnc" id="L23967" title="All 2 branches missed.">        if (vDesc == null) {</span>
<span class="nc" id="L23968">            vDesc = new Vector&lt;&gt;();</span>
        }

<span class="nc bnc" id="L23971" title="All 2 branches missed.">        if (vUnits == null) {</span>
<span class="nc" id="L23972">            vUnits = new Vector&lt;&gt;();</span>
        }

        Report r;
<span class="nc" id="L23976">        HashSet&lt;Entity&gt; entitiesHit = new HashSet&lt;&gt;();</span>

        // We need to damage buildings.
<span class="nc" id="L23979">        Enumeration&lt;Building&gt; buildings = game.getBoard().getBuildings();</span>
<span class="nc bnc" id="L23980" title="All 2 branches missed.">        while (buildings.hasMoreElements()) {</span>
<span class="nc" id="L23981">            final Building bldg = buildings.nextElement();</span>

            // Lets find the closest hex from the building.
<span class="nc" id="L23984">            Enumeration&lt;Coords&gt; hexes = bldg.getCoords();</span>

<span class="nc bnc" id="L23986" title="All 2 branches missed.">            while (hexes.hasMoreElements()) {</span>
<span class="nc" id="L23987">                final Coords coords = hexes.nextElement();</span>
<span class="nc" id="L23988">                int dist = position.distance(coords);</span>
<span class="nc bnc" id="L23989" title="All 2 branches missed.">                if (dist &lt; damages.length) {</span>
<span class="nc" id="L23990">                    Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, damages[dist], coords);</span>
<span class="nc bnc" id="L23991" title="All 2 branches missed.">                    for (Report report : buildingReport) {</span>
<span class="nc" id="L23992">                        report.type = Report.PUBLIC;</span>
<span class="nc" id="L23993">                    }</span>
<span class="nc" id="L23994">                    vDesc.addAll(buildingReport);</span>
                }
<span class="nc" id="L23996">            }</span>
<span class="nc" id="L23997">        }</span>

        // We need to damage terrain
<span class="nc" id="L24000">        int maxDist = damages.length;</span>
<span class="nc" id="L24001">        IHex hex = game.getBoard().getHex(position);</span>
        // Center hex starts on fire for engine explosions
<span class="nc bnc" id="L24003" title="All 6 branches missed.">        if (engineExplosion &amp;&amp; (hex != null) &amp;&amp; !hex.containsTerrain(Terrains.FIRE)) {</span>
<span class="nc" id="L24004">            r = new Report(5136);</span>
<span class="nc" id="L24005">            r.indent(2);</span>
<span class="nc" id="L24006">            r.type = Report.PUBLIC;</span>
<span class="nc" id="L24007">            r.add(position.getBoardNum());</span>
<span class="nc" id="L24008">            vDesc.add(r);</span>
<span class="nc" id="L24009">            Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
<span class="nc" id="L24010">            ignite(position, Terrains.FIRE_LVL_NORMAL, reports);</span>
<span class="nc bnc" id="L24011" title="All 2 branches missed.">            for (Report report : reports) {</span>
<span class="nc" id="L24012">                report.indent();</span>
<span class="nc" id="L24013">            }</span>
<span class="nc" id="L24014">            vDesc.addAll(reports);</span>
        }
<span class="nc bnc" id="L24016" title="All 4 branches missed.">        if ((hex != null) &amp;&amp; hex.hasTerrainfactor()) {</span>
<span class="nc" id="L24017">            r = new Report(3384);</span>
<span class="nc" id="L24018">            r.indent(2);</span>
<span class="nc" id="L24019">            r.type = Report.PUBLIC;</span>
<span class="nc" id="L24020">            r.add(position.getBoardNum());</span>
<span class="nc" id="L24021">            r.add(damages[0]);</span>
<span class="nc" id="L24022">            vDesc.add(r);</span>
        }
<span class="nc" id="L24024">        Vector&lt;Report&gt; reports = tryClearHex(position, damages[0], Entity.NONE);</span>
<span class="nc bnc" id="L24025" title="All 2 branches missed.">        for (Report report : reports) {</span>
<span class="nc" id="L24026">            report.indent(3);</span>
<span class="nc" id="L24027">        }</span>
<span class="nc" id="L24028">        vDesc.addAll(reports);</span>

        // Handle surrounding coords
<span class="nc bnc" id="L24031" title="All 2 branches missed.">        for (int dist = 1; dist &lt; maxDist; dist++) {</span>
<span class="nc" id="L24032">            List&lt;Coords&gt; coords = position.allAtDistance(dist);</span>
<span class="nc bnc" id="L24033" title="All 2 branches missed.">            for (Coords c : coords) {</span>
<span class="nc" id="L24034">                hex = game.getBoard().getHex(c);</span>
<span class="nc bnc" id="L24035" title="All 4 branches missed.">                if ((hex != null) &amp;&amp; hex.hasTerrainfactor()) {</span>
<span class="nc" id="L24036">                    r = new Report(3384);</span>
<span class="nc" id="L24037">                    r.indent(2);</span>
<span class="nc" id="L24038">                    r.type = Report.PUBLIC;</span>
<span class="nc" id="L24039">                    r.add(c.getBoardNum());</span>
<span class="nc" id="L24040">                    r.add(damages[dist]);</span>
<span class="nc" id="L24041">                    vDesc.add(r);</span>
                }
<span class="nc" id="L24043">                reports = tryClearHex(c, damages[dist], Entity.NONE);</span>
<span class="nc bnc" id="L24044" title="All 2 branches missed.">                for (Report report : reports) {</span>
<span class="nc" id="L24045">                    report.indent(3);</span>
<span class="nc" id="L24046">                }</span>
<span class="nc" id="L24047">                vDesc.addAll(reports);</span>
<span class="nc" id="L24048">            }</span>
        }

        // Now we damage people near the explosion.
<span class="nc" id="L24052">        List&lt;Entity&gt; loaded = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L24053" title="All 2 branches missed.">        for (Iterator&lt;Entity&gt; ents = game.getEntities(); ents.hasNext();) {</span>
<span class="nc" id="L24054">            Entity entity = ents.next();</span>

<span class="nc bnc" id="L24056" title="All 2 branches missed.">            if (entitiesHit.contains(entity)) {</span>
<span class="nc" id="L24057">                continue;</span>
            }

<span class="nc bnc" id="L24060" title="All 2 branches missed.">            if (entity.getId() == excludedUnitId) {</span>
<span class="nc" id="L24061">                continue;</span>
            }

<span class="nc bnc" id="L24064" title="All 4 branches missed.">            if (entity.isDestroyed() || !entity.isDeployed()) {</span>
                // FIXME
                // IS this the behavior we want?
                // This means, incidentally, that salvage is never affected by
                // explosions
                // as long as it was destroyed before the explosion.
<span class="nc" id="L24070">                continue;</span>
            }

            // We are going to assume that explosions are on the ground here so
            // flying entities should be unaffected
<span class="nc bnc" id="L24075" title="All 2 branches missed.">            if (entity.isAirborne()) {</span>
<span class="nc" id="L24076">                continue;</span>
            }

<span class="nc bnc" id="L24079" title="All 4 branches missed.">            if ((entity instanceof MechWarrior) &amp;&amp; !((MechWarrior) entity).hasLanded()) {</span>
                // MechWarrior is still up in the air ejecting hence safe
                // from this explosion.
<span class="nc" id="L24082">                continue;</span>
            }

<span class="nc" id="L24085">            Coords entityPos = entity.getPosition();</span>
<span class="nc bnc" id="L24086" title="All 2 branches missed.">            if (entityPos == null) {</span>
                // maybe its loaded?
<span class="nc" id="L24088">                Entity transport = game.getEntity(entity.getTransportId());</span>
<span class="nc bnc" id="L24089" title="All 4 branches missed.">                if ((transport != null) &amp;&amp; !transport.isAirborne()) {</span>
<span class="nc" id="L24090">                    loaded.add(entity);</span>
                }
                continue;
            }
<span class="nc" id="L24094">            int range = position.distance(entityPos);</span>

<span class="nc bnc" id="L24096" title="All 2 branches missed.">            if (range &gt;= damages.length) {</span>
                // Yeah, this is fine. It's outside the blast radius.
<span class="nc" id="L24098">                continue;</span>
            }

            // We might need to nuke everyone in the explosion hex. If so...
<span class="nc bnc" id="L24102" title="All 4 branches missed.">            if ((range == 0) &amp;&amp; autoDestroyInSameHex) {</span>
                // Add the reports
<span class="nc" id="L24104">                vDesc.addAll(destroyEntity(entity, &quot;explosion proximity&quot;, false, false));</span>
                // Add it to the &quot;blasted units&quot; list
<span class="nc" id="L24106">                vUnits.add(entity.getId());</span>
                // Kill the crew
<span class="nc" id="L24108">                entity.getCrew().setDoomed(true);</span>

<span class="nc" id="L24110">                entitiesHit.add(entity);</span>
<span class="nc" id="L24111">                continue;</span>
            }

<span class="nc" id="L24114">            int damage = damages[range];</span>

<span class="nc bnc" id="L24116" title="All 4 branches missed.">            if (allowShelter &amp;&amp; canShelter(entityPos, position, entity.relHeight())) {</span>
<span class="nc bnc" id="L24117" title="All 2 branches missed.">                if (isSheltered()) {</span>
<span class="nc" id="L24118">                    r = new Report(6545);</span>
<span class="nc" id="L24119">                    r.addDesc(entity);</span>
<span class="nc" id="L24120">                    r.subject = entity.getId();</span>
<span class="nc" id="L24121">                    vDesc.addElement(r);</span>
<span class="nc" id="L24122">                    continue;</span>
                }
                // If shelter is allowed but didn't work, report that.
<span class="nc" id="L24125">                r = new Report(6546);</span>
<span class="nc" id="L24126">                r.subject = entity.getId();</span>
<span class="nc" id="L24127">                r.addDesc(entity);</span>
<span class="nc" id="L24128">                vDesc.addElement(r);</span>
            }

            // Since it's taking damage, add it to the list of units hit.
<span class="nc" id="L24132">            vUnits.add(entity.getId());</span>

<span class="nc" id="L24134">            AreaEffectHelper.applyExplosionClusterDamageToEntity(entity, damage, clusterAmt, position, vDesc, this);</span>
            
<span class="nc" id="L24136">            Report.addNewline(vDesc);</span>
<span class="nc" id="L24137">        }</span>

        // now deal with loaded units...
<span class="nc bnc" id="L24140" title="All 2 branches missed.">        for (Entity e : loaded) {</span>
            // This can be null, if the transport died from damage
<span class="nc" id="L24142">            final Entity transporter = game.getEntity(e.getTransportId());</span>
<span class="nc bnc" id="L24143" title="All 4 branches missed.">            if ((transporter == null) || transporter.getExternalUnits().contains(e)) {</span>
                // Its external or transport was destroyed - hit it.
<span class="nc bnc" id="L24145" title="All 2 branches missed.">                final Coords entityPos = (transporter == null ? e.getPosition()</span>
<span class="nc" id="L24146">                        : transporter.getPosition());</span>
<span class="nc" id="L24147">                final int range = position.distance(entityPos);</span>

<span class="nc bnc" id="L24149" title="All 2 branches missed.">                if (range &gt;= damages.length) {</span>
                    // Yeah, this is fine. It's outside the blast radius.
<span class="nc" id="L24151">                    continue;</span>
                }

<span class="nc" id="L24154">                int damage = damages[range];</span>
<span class="nc bnc" id="L24155" title="All 2 branches missed.">                if (allowShelter) {</span>
<span class="nc bnc" id="L24156" title="All 2 branches missed.">                    final int absHeight = (transporter == null ? e.relHeight()</span>
<span class="nc" id="L24157">                            : transporter.relHeight());</span>
<span class="nc bnc" id="L24158" title="All 2 branches missed.">                    if (canShelter(entityPos, position, absHeight)) {</span>
<span class="nc bnc" id="L24159" title="All 2 branches missed.">                        if (isSheltered()) {</span>
<span class="nc" id="L24160">                            r = new Report(6545);</span>
<span class="nc" id="L24161">                            r.addDesc(e);</span>
<span class="nc" id="L24162">                            r.subject = e.getId();</span>
<span class="nc" id="L24163">                            vDesc.addElement(r);</span>
<span class="nc" id="L24164">                            continue;</span>
                        }
                        // If shelter is allowed but didn't work, report that.
<span class="nc" id="L24167">                        r = new Report(6546);</span>
<span class="nc" id="L24168">                        r.subject = e.getId();</span>
<span class="nc" id="L24169">                        r.addDesc(e);</span>
<span class="nc" id="L24170">                        vDesc.addElement(r);</span>
                    }
                }
                // No shelter
                // Since it's taking damage, add it to the list of units hit.
<span class="nc" id="L24175">                vUnits.add(e.getId());</span>

<span class="nc" id="L24177">                r = new Report(6175);</span>
<span class="nc" id="L24178">                r.subject = e.getId();</span>
<span class="nc" id="L24179">                r.indent(2);</span>
<span class="nc" id="L24180">                r.addDesc(e);</span>
<span class="nc" id="L24181">                r.add(damage);</span>
<span class="nc" id="L24182">                vDesc.addElement(r);</span>

<span class="nc bnc" id="L24184" title="All 2 branches missed.">                while (damage &gt; 0) {</span>
<span class="nc" id="L24185">                    int cluster = Math.min(5, damage);</span>
<span class="nc" id="L24186">                    int table = ToHitData.HIT_NORMAL;</span>
<span class="nc bnc" id="L24187" title="All 2 branches missed.">                    if (e instanceof Protomech) {</span>
<span class="nc" id="L24188">                        table = ToHitData.HIT_SPECIAL_PROTO;</span>
                    }
<span class="nc" id="L24190">                    HitData hit = e.rollHitLocation(table, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L24191">                    vDesc.addAll(damageEntity(e, hit, cluster, false,</span>
                            DamageType.IGNORE_PASSENGER, false, true));
<span class="nc" id="L24193">                    damage -= cluster;</span>
<span class="nc" id="L24194">                }</span>
<span class="nc" id="L24195">                Report.addNewline(vDesc);</span>
            }
<span class="nc" id="L24197">        }</span>
<span class="nc" id="L24198">    }</span>

    /**
     * Check if an Entity of the passed height can find shelter from a nuke blast
     *
     * @param entityPosition  the &lt;code&gt;Coords&lt;/code&gt; the Entity is at
     * @param position        the &lt;code&gt;Coords&lt;/code&gt; of the explosion
     * @param entityAbsHeight the &lt;code&gt;int&lt;/code&gt; height of the entity
     * @return a &lt;code&gt;boolean&lt;/code&gt; value indicating if the entity of the
     * given height can find shelter
     */
    public boolean canShelter(Coords entityPosition, Coords position, int entityAbsHeight) {
        // What is the next hex in the direction of the blast?
<span class="nc" id="L24211">        Coords shelteringCoords = Coords.nextHex(entityPosition, position);</span>
<span class="nc" id="L24212">        IHex shelteringHex = game.getBoard().getHex(shelteringCoords);</span>

        // This is an error condition. It really shouldn't ever happen.
<span class="nc bnc" id="L24215" title="All 2 branches missed.">        if (shelteringHex == null) {</span>
<span class="nc" id="L24216">            return false;</span>
        }

        // Now figure out the height to which that hex will provide shelter.
        // It's worth noting, this assumes that any building in the hex has
        // already survived the bomb blast. In the case where a building
        // won't survive the blast but hasn't actually taken the damage
        // yet, this will be wrong.
<span class="nc" id="L24224">        int shelterLevel = shelteringHex.floor();</span>
<span class="nc bnc" id="L24225" title="All 2 branches missed.">        if (shelteringHex.containsTerrain(Terrains.BUILDING)) {</span>
<span class="nc" id="L24226">            shelterLevel = shelteringHex.ceiling();</span>
        }

        // Get the absolute height of the unit relative to level 0.
<span class="nc" id="L24230">        entityAbsHeight += game.getBoard().getHex(entityPosition).surface();</span>

        // Now find the height that needs to be sheltered, and compare.
<span class="nc bnc" id="L24233" title="All 2 branches missed.">        return entityAbsHeight &lt; shelterLevel;</span>
    }

    /**
     * @return true if the unit succeeds a shelter roll
     */
    private boolean isSheltered() {
<span class="nc bnc" id="L24240" title="All 2 branches missed.">        return Compute.d6(2) &gt;= 9;</span>
    }

    /**
     * add a nuke to be exploded in the next weapons attack phase
     *
     * @param nuke this is an int[] with i=0 and i=1 being X and Y coordinates respectively,
     *             If the input array is length 3, then i=2 is NukeType (from HS:3070)
     *             If the input array is length 6, then i=2 is the base damage dealt,
     *             i=3 is the degradation, i=4 is the secondary radius, and i=5 is the crater depth
     */
    public void addScheduledNuke(int[] nuke) {
<span class="nc" id="L24252">        scheduledNukes.add(nuke);</span>
<span class="nc" id="L24253">    }</span>

    /**
     * explode any scheduled nukes
     */
    private void resolveScheduledNukes() {
<span class="nc bnc" id="L24259" title="All 2 branches missed.">        for (int[] nuke : scheduledNukes) {</span>
<span class="nc bnc" id="L24260" title="All 2 branches missed.">            if (nuke.length == 3) {</span>
<span class="nc" id="L24261">                doNuclearExplosion(new Coords(nuke[0] - 1, nuke[1] - 1), nuke[2],</span>
                        vPhaseReport);
            }
<span class="nc bnc" id="L24264" title="All 2 branches missed.">            if (nuke.length == 6) {</span>
<span class="nc" id="L24265">                doNuclearExplosion(new Coords(nuke[0] - 1, nuke[1] - 1), nuke[2], nuke[3],</span>
                        nuke[4], nuke[5], vPhaseReport);
            }
<span class="nc" id="L24268">        }</span>
<span class="nc" id="L24269">        scheduledNukes.clear();</span>
<span class="nc" id="L24270">    }</span>

    /**
     * do a nuclear explosion
     *
     * @param position the position that will be hit by the nuke
     * @param nukeType the type of nuke
     * @param vDesc    a vector that contains the output report
     */
    public void doNuclearExplosion(Coords position, int nukeType, Vector&lt;Report&gt; vDesc) {
<span class="nc" id="L24280">        NukeStats nukeStats = AreaEffectHelper.getNukeStats(nukeType);</span>
        
<span class="nc bnc" id="L24282" title="All 2 branches missed.">        if(nukeStats == null) {</span>
<span class="nc" id="L24283">            MegaMek.getLogger().error(&quot;Illegal nuke not listed in HS:3070&quot;);</span>
        }
        
<span class="nc" id="L24286">        doNuclearExplosion(position, nukeStats.baseDamage, nukeStats.degradation, nukeStats.secondaryRadius,</span>
                nukeStats.craterDepth, vDesc);        
<span class="nc" id="L24288">    }</span>

    /**
     * explode a nuke
     *
     * @param position          the position that will be hit by the nuke
     * @param baseDamage        the base damage from the blast
     * @param degradation       how fast the blast's power degrades
     * @param secondaryRadius   the secondary blast radius
     * @param craterDepth       the depth of the crater created by the blast
     * @param vDesc             a vector that contains the output report
     */
    public void doNuclearExplosion(Coords position, int baseDamage, int degradation,
                                   int secondaryRadius, int craterDepth, Vector&lt;Report&gt; vDesc) {
        // Just in case.
<span class="nc bnc" id="L24303" title="All 2 branches missed.">        if (vDesc == null) {</span>
<span class="nc" id="L24304">            vDesc = new Vector&lt;&gt;();</span>
        }

        // First, crater the terrain.
        // All terrain, units, buildings... EVERYTHING in here is just gone.
        // Gotta love nukes.
<span class="nc" id="L24310">        Report r = new Report(1215, Report.PUBLIC);</span>

<span class="nc" id="L24312">        r.indent();</span>
<span class="nc" id="L24313">        r.add(position.getBoardNum(), true);</span>
<span class="nc" id="L24314">        vDesc.add(r);</span>

<span class="nc" id="L24316">        int curDepth = craterDepth;</span>
<span class="nc" id="L24317">        int range = 0;</span>
<span class="nc bnc" id="L24318" title="All 2 branches missed.">        while (range &lt; (2 * craterDepth)) {</span>
            // Get the set of hexes at this range.
<span class="nc" id="L24320">            List&lt;Coords&gt; hexSet = position.allAtDistance(range);</span>

            // Iterate through the hexes.
<span class="nc bnc" id="L24323" title="All 2 branches missed.">            for (Coords myHexCoords: hexSet) {</span>
                // ignore out of bounds coordinates
<span class="nc bnc" id="L24325" title="All 2 branches missed.">                if (!game.getBoard().contains(myHexCoords)) {</span>
<span class="nc" id="L24326">                    continue;</span>
                }
                
<span class="nc" id="L24329">                IHex myHex = game.getBoard().getHex(myHexCoords);</span>
                // In each hex, first, sink the terrain if necessary.
<span class="nc" id="L24331">                myHex.setLevel((myHex.getLevel() - curDepth));</span>

                // Then, remove ANY terrains here.
                // I mean ALL of them; they're all just gone.
                // No ruins, no water, no rough, no nothing.
<span class="nc bnc" id="L24336" title="All 2 branches missed.">                if (myHex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L24337">                    myHex.setLevel(myHex.floor());</span>
                }
<span class="nc" id="L24339">                myHex.removeAllTerrains();</span>
<span class="nc" id="L24340">                myHex.clearExits();</span>

<span class="nc" id="L24342">                sendChangedHex(myHexCoords);</span>
<span class="nc" id="L24343">            }</span>

            // Lastly, if the next distance is a multiple of 2...
            // The crater depth goes down one.
<span class="nc bnc" id="L24347" title="All 4 branches missed.">            if ((range &gt; 0) &amp;&amp; ((range % 2) == 0)) {</span>
<span class="nc" id="L24348">                curDepth--;</span>
            }

            // Now that the hexes are dealt with, increment the distance.
<span class="nc" id="L24352">            range++;</span>
<span class="nc" id="L24353">        }</span>

        // This is technically part of cratering, but...
        // Now we destroy all the units inside the cratering range.
<span class="nc bnc" id="L24357" title="All 2 branches missed.">        for (Entity entity : game.getEntitiesVector()) {</span>
            // loaded units and off board units don't have a position,
            // so we don't count 'em here
<span class="nc bnc" id="L24360" title="All 4 branches missed.">            if ((entity.getTransportId() != Entity.NONE) || (entity.getPosition() == null)) {</span>
<span class="nc" id="L24361">                continue;</span>
            }

            // If it's too far away for this...
<span class="nc bnc" id="L24365" title="All 2 branches missed.">            if (position.distance(entity.getPosition()) &gt;= range) {</span>
<span class="nc" id="L24366">                continue;</span>
            }

            // If it's already destroyed...
<span class="nc bnc" id="L24370" title="All 2 branches missed.">            if (entity.isDestroyed()) {</span>
<span class="nc" id="L24371">                continue;</span>
            }

<span class="nc" id="L24374">            vDesc.addAll(destroyEntity(entity, &quot;nuclear explosion proximity&quot;,</span>
                    false, false));
            // Kill the crew
<span class="nc" id="L24377">            entity.getCrew().setDoomed(true);</span>
<span class="nc" id="L24378">        }</span>

        // Then, do actual blast damage.
        // Use the standard blast function for this.
<span class="nc" id="L24382">        Vector&lt;Report&gt; tmpV = new Vector&lt;&gt;();</span>
<span class="nc" id="L24383">        Vector&lt;Integer&gt; blastedUnitsVec = new Vector&lt;&gt;();</span>
<span class="nc" id="L24384">        doExplosion(baseDamage, degradation, true, position, true, tmpV,</span>
                    blastedUnitsVec, -1);
<span class="nc" id="L24386">        Report.indentAll(tmpV, 2);</span>
<span class="nc" id="L24387">        vDesc.addAll(tmpV);</span>

        // Everything that was blasted by the explosion has to make a piloting
        // check at +6.
<span class="nc bnc" id="L24391" title="All 2 branches missed.">        for (int i : blastedUnitsVec) {</span>
<span class="nc" id="L24392">            Entity o = game.getEntity(i);</span>
<span class="nc bnc" id="L24393" title="All 2 branches missed.">            if (o.canFall()) {</span>
                // Needs a piloting check at +6 to avoid falling over.
<span class="nc" id="L24395">                game.addPSR(new PilotingRollData(o.getId(), 6,</span>
                        &quot;hit by nuclear blast&quot;));
<span class="nc bnc" id="L24397" title="All 2 branches missed.">            } else if (o instanceof VTOL) {</span>
                // Needs a piloting check at +6 to avoid crashing.
                // Wheeeeee!
<span class="nc" id="L24400">                VTOL vt = (VTOL) o;</span>

                // Check only applies if it's in the air.
                // FIXME: is this actually correct? What about
                // buildings/bridges?
<span class="nc bnc" id="L24405" title="All 2 branches missed.">                if (vt.getElevation() &gt; 0) {</span>
<span class="nc" id="L24406">                    game.addPSR(new PilotingRollData(vt.getId(), 6,</span>
                                                     &quot;hit by nuclear blast&quot;));
                }
<span class="nc bnc" id="L24409" title="All 2 branches missed.">            } else if (o instanceof Tank) {</span>
                // As per official answer on the rules questions board...
                // Needs a piloting check at +6 to avoid a 1-level fall...
                // But ONLY if a hover-tank.
                // TODO : Fix me
            }
<span class="nc" id="L24415">        }</span>

        // This ISN'T part of the blast, but if there's ANYTHING in the ground
        // zero hex, destroy it.
<span class="nc" id="L24419">        Building tmpB = game.getBoard().getBuildingAt(position);</span>
<span class="nc bnc" id="L24420" title="All 2 branches missed.">        if (tmpB != null) {</span>
<span class="nc" id="L24421">            r = new Report(2415);</span>
<span class="nc" id="L24422">            r.add(tmpB.getName());</span>
<span class="nc" id="L24423">            addReport(r);</span>
<span class="nc" id="L24424">            tmpB.setCurrentCF(0, position);</span>
        }
<span class="nc" id="L24426">        IHex gzHex = game.getBoard().getHex(position);</span>
<span class="nc bnc" id="L24427" title="All 2 branches missed.">        if (gzHex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L24428">            gzHex.setLevel(gzHex.floor());</span>
        }
<span class="nc" id="L24430">        gzHex.removeAllTerrains();</span>

        // Next, for whatever's left, do terrain effects
        // such as clearing, roughing, and boiling off water.
<span class="nc" id="L24434">        boolean damageFlag = true;</span>
<span class="nc" id="L24435">        int damageAtRange = baseDamage - (degradation * range);</span>
<span class="nc bnc" id="L24436" title="All 2 branches missed.">        if (damageAtRange &gt; 0) {</span>
<span class="nc bnc" id="L24437" title="All 2 branches missed.">            for (int x = range; damageFlag; x++) {</span>
                // Damage terrain as necessary.
                // Get all the hexes, and then iterate through them.
<span class="nc" id="L24440">                List&lt;Coords&gt; hexSet = position.allAtDistance(x);</span>

                // Iterate through the hexes.
<span class="nc bnc" id="L24443" title="All 2 branches missed.">                for (Coords myHexCoords : hexSet) {</span>
                    // ignore out of bounds coordinates
<span class="nc bnc" id="L24445" title="All 2 branches missed.">                    if (!game.getBoard().contains(myHexCoords)) {</span>
<span class="nc" id="L24446">                        continue;</span>
                    }
                    
<span class="nc" id="L24449">                    IHex myHex = game.getBoard().getHex(myHexCoords);</span>

                    // For each 3000 damage, water level is reduced by 1.
<span class="nc bnc" id="L24452" title="All 4 branches missed.">                    if ((damageAtRange &gt;= 3000) &amp;&amp; (myHex.containsTerrain(Terrains.WATER))) {</span>
<span class="nc" id="L24453">                        int numCleared = damageAtRange / 3000;</span>
<span class="nc" id="L24454">                        int oldLevel = myHex.terrainLevel(Terrains.WATER);</span>
<span class="nc" id="L24455">                        myHex.removeTerrain(Terrains.WATER);</span>
<span class="nc bnc" id="L24456" title="All 2 branches missed.">                        if (oldLevel &gt; numCleared) {</span>
<span class="nc" id="L24457">                            myHex.setLevel(myHex.getLevel() - numCleared);</span>
<span class="nc" id="L24458">                            myHex.addTerrain(new Terrain(Terrains.WATER, oldLevel - numCleared));</span>
                        } else {
<span class="nc" id="L24460">                            myHex.setLevel(myHex.getLevel() - oldLevel);</span>
                        }
                    }

                    // ANY non-water hex that takes 200 becomes rough.
<span class="nc bnc" id="L24465" title="All 4 branches missed.">                    if ((damageAtRange &gt;= 200) &amp;&amp; (!myHex.containsTerrain(Terrains.WATER))) {</span>
<span class="nc" id="L24466">                        myHex.removeAllTerrains();</span>
<span class="nc" id="L24467">                        myHex.clearExits();</span>
<span class="nc" id="L24468">                        myHex.addTerrain(new Terrain(Terrains.ROUGH, 1));</span>
<span class="nc bnc" id="L24469" title="All 2 branches missed.">                    } else if ((damageAtRange &gt;= 20)</span>
<span class="nc bnc" id="L24470" title="All 2 branches missed.">                            &amp;&amp; ((myHex.containsTerrain(Terrains.WOODS))</span>
<span class="nc bnc" id="L24471" title="All 2 branches missed.">                            || (myHex.containsTerrain(Terrains.JUNGLE)))) {</span>
                        // Each 20 clears woods by 1 level.
<span class="nc" id="L24473">                        int numCleared = damageAtRange / 20;</span>
<span class="nc bnc" id="L24474" title="All 2 branches missed.">                        int terrainType = (myHex.containsTerrain(Terrains.WOODS)</span>
<span class="nc" id="L24475">                                ? Terrains.WOODS : Terrains.JUNGLE);</span>
<span class="nc" id="L24476">                        int oldLevel = myHex.terrainLevel(terrainType);</span>
<span class="nc" id="L24477">                        int oldEl = myHex.terrainLevel(Terrains.FOLIAGE_ELEV);</span>
<span class="nc" id="L24478">                        myHex.removeTerrain(terrainType);</span>
<span class="nc bnc" id="L24479" title="All 2 branches missed.">                        if (oldLevel &gt; numCleared) {</span>
<span class="nc" id="L24480">                            myHex.addTerrain(new Terrain(terrainType, oldLevel - numCleared));</span>
<span class="nc bnc" id="L24481" title="All 2 branches missed.">                            if (oldEl != 1) {</span>
<span class="nc" id="L24482">                                myHex.addTerrain(new Terrain(Terrains.FOLIAGE_ELEV, </span>
<span class="nc bnc" id="L24483" title="All 2 branches missed.">                                        oldLevel - numCleared == 3 ? 3 : 2));</span>
                            }
                        } else {
<span class="nc" id="L24486">                            myHex.removeTerrain(Terrains.FOLIAGE_ELEV);</span>
                        }
                    }

<span class="nc" id="L24490">                    sendChangedHex(myHexCoords);</span>
<span class="nc" id="L24491">                }</span>

                // Initialize for the next iteration.
<span class="nc" id="L24494">                damageAtRange = baseDamage - ((degradation * x) + 1);</span>

                // If the damage is less than 20, it has no terrain effect.
<span class="nc bnc" id="L24497" title="All 2 branches missed.">                if (damageAtRange &lt; 20) {</span>
<span class="nc" id="L24498">                    damageFlag = false;</span>
                }
            }
        }

        // Lastly, do secondary effects.
<span class="nc bnc" id="L24504" title="All 2 branches missed.">        for (Entity entity : game.getEntitiesVector()) {</span>
            // loaded units and off board units don't have a position,
            // so we don't count 'em here
<span class="nc bnc" id="L24507" title="All 4 branches missed.">            if ((entity.getTransportId() != Entity.NONE) || (entity.getPosition() == null)) {</span>
<span class="nc" id="L24508">                continue;</span>
            }

            // If it's already destroyed...
<span class="nc bnc" id="L24512" title="All 4 branches missed.">            if ((entity.isDoomed()) || (entity.isDestroyed())) {</span>
<span class="nc" id="L24513">                continue;</span>
            }

            // If it's too far away for this...
<span class="nc bnc" id="L24517" title="All 2 branches missed.">            if (position.distance(entity.getPosition()) &gt; secondaryRadius) {</span>
<span class="nc" id="L24518">                continue;</span>
            }

            // Actually do secondary effects against it.
            // Since the effects are unit-dependant, we'll just define it in the
            // entity.
<span class="nc" id="L24524">            applySecondaryNuclearEffects(entity, position, vDesc);</span>
<span class="nc" id="L24525">        }</span>

        // All right. We're done.
<span class="nc" id="L24528">        r = new Report(1216, Report.PUBLIC);</span>
<span class="nc" id="L24529">        r.indent();</span>
<span class="nc" id="L24530">        r.newlines = 2;</span>
<span class="nc" id="L24531">        vDesc.add(r);</span>
<span class="nc" id="L24532">    }</span>

    /**
     * Handles secondary effects from nuclear blasts against all units in range.
     *
     * @param entity   The entity to affect.
     * @param position The coordinates of the nuclear blast, for to-hit directions.
     * @param vDesc    a description vector to use for reports.
     */
    public void applySecondaryNuclearEffects(Entity entity, Coords position, Vector&lt;Report&gt; vDesc) {
        // If it's already destroyed, give up. We really don't care.
<span class="nc bnc" id="L24543" title="All 2 branches missed.">        if (entity.isDestroyed()) {</span>
<span class="nc" id="L24544">            return;</span>
        }

        // Check to see if the infantry is in a protective structure.
<span class="nc bnc" id="L24548" title="All 2 branches missed.">        boolean inHardenedBuilding = (Compute.isInBuilding(game, entity)</span>
<span class="nc bnc" id="L24549" title="All 2 branches missed.">                &amp;&amp; (game.getBoard().getHex(entity.getPosition()).terrainLevel(Terrains.BUILDING) == 4));</span>

        // Roll 2d6.
<span class="nc" id="L24552">        int roll = Compute.d6(2);</span>

<span class="nc" id="L24554">        Report r = new Report(6555);</span>
<span class="nc" id="L24555">        r.subject = entity.getId();</span>
<span class="nc" id="L24556">        r.add(entity.getDisplayName());</span>
<span class="nc" id="L24557">        r.add(roll);</span>

        // If they are in protective structure, add 2 to the roll.
<span class="nc bnc" id="L24560" title="All 2 branches missed.">        if (inHardenedBuilding) {</span>
<span class="nc" id="L24561">            roll += 2;</span>
<span class="nc" id="L24562">            r.add(&quot; + 2 (unit is in hardened building)&quot;);</span>
        } else {
<span class="nc" id="L24564">            r.add(&quot;&quot;);</span>
        }

        // Also, if the entity is &quot;hardened&quot; against EMI, it gets a +2.
        // For these purposes, I'm going to hand this off to the Entity itself
        // to tell us.
        // Right now, it IS based purely on class, but I won't rule out the idea
        // of
        // &quot;nuclear hardening&quot; as equipment for a support vehicle, for example.
<span class="nc bnc" id="L24573" title="All 2 branches missed.">        if (entity.isNuclearHardened()) {</span>
<span class="nc" id="L24574">            roll += 2;</span>
<span class="nc" id="L24575">            r.add(&quot; + 2 (unit is hardened against EMI)&quot;);</span>
        } else {
<span class="nc" id="L24577">            r.add(&quot;&quot;);</span>
        }

<span class="nc" id="L24580">        r.indent(2);</span>
<span class="nc" id="L24581">        vDesc.add(r);</span>

        // Now, compare it to the table, and apply the effects.
<span class="nc bnc" id="L24584" title="All 2 branches missed.">        if (roll &lt;= 4) {</span>
            // The unit is destroyed.
            // Sucks, doesn't it?
            // This applies to all units.
            // Yup, just sucks.
<span class="nc" id="L24589">            vDesc.addAll(destroyEntity(entity,</span>
                    &quot;nuclear explosion secondary effects&quot;, false, false));
            // Kill the crew
<span class="nc" id="L24592">            entity.getCrew().setDoomed(true);</span>
<span class="nc bnc" id="L24593" title="All 2 branches missed.">        } else if (roll &lt;= 6) {</span>
<span class="nc bnc" id="L24594" title="All 2 branches missed.">            if (entity instanceof BattleArmor) {</span>
                // It takes 50% casualties, rounded up.
<span class="nc" id="L24596">                BattleArmor myBA = (BattleArmor) entity;</span>
<span class="nc" id="L24597">                int numDeaths = (int) (Math.ceil((myBA.getNumberActiverTroopers())) / 2.0);</span>
<span class="nc bnc" id="L24598" title="All 2 branches missed.">                for (int x = 0; x &lt; numDeaths; x++) {</span>
<span class="nc" id="L24599">                    vDesc.addAll(applyCriticalHit(entity, 0, null, false,</span>
                            0, false));
                }
<span class="nc bnc" id="L24602" title="All 2 branches missed.">            } else if (entity instanceof Infantry) {</span>
                // Standard infantry are auto-killed in this band, unless
                // they're in a building.
<span class="nc bnc" id="L24605" title="All 2 branches missed.">                if (game.getBoard().getHex(entity.getPosition()).containsTerrain(Terrains.BUILDING)) {</span>
                    // 50% casualties, rounded up.
<span class="nc" id="L24607">                    int damage = (int) (Math.ceil((entity.getInternal(Infantry.LOC_INFANTRY)) / 2.0));</span>
<span class="nc" id="L24608">                    vDesc.addAll(damageEntity(entity, new HitData(</span>
                            Infantry.LOC_INFANTRY), damage, true));
<span class="nc" id="L24610">                } else {</span>
<span class="nc" id="L24611">                    vDesc.addAll(destroyEntity(entity,</span>
                            &quot;nuclear explosion secondary effects&quot;, false, false));
<span class="nc" id="L24613">                    entity.getCrew().setDoomed(true);</span>
                }
<span class="nc bnc" id="L24615" title="All 2 branches missed.">            } else if (entity instanceof Tank) {</span>
                // All vehicles suffer two critical hits...
<span class="nc" id="L24617">                HitData hd = entity.rollHitLocation(ToHitData.HIT_NORMAL, entity.sideTable(position));</span>
<span class="nc" id="L24618">                vDesc.addAll(oneCriticalEntity(entity, hd.getLocation(), hd.isRear(), 0));</span>
<span class="nc" id="L24619">                hd = entity.rollHitLocation(ToHitData.HIT_NORMAL, entity.sideTable(position));</span>
<span class="nc" id="L24620">                vDesc.addAll(oneCriticalEntity(entity, hd.getLocation(), hd.isRear(), 0));</span>

                // ...and a Crew Killed hit.
<span class="nc" id="L24623">                vDesc.addAll(applyCriticalHit(entity, 0, new CriticalSlot(0,</span>
                        Tank.CRIT_CREW_KILLED), false, 0, false));
<span class="nc bnc" id="L24625" title="All 4 branches missed.">            } else if ((entity instanceof Mech) || (entity instanceof Protomech)) {</span>
                // 'Mechs suffer two critical hits...
<span class="nc" id="L24627">                HitData hd = entity.rollHitLocation(ToHitData.HIT_NORMAL, entity.sideTable(position));</span>
<span class="nc" id="L24628">                vDesc.addAll(oneCriticalEntity(entity, hd.getLocation(), hd.isRear(), 0));</span>
<span class="nc" id="L24629">                hd = entity.rollHitLocation(ToHitData.HIT_NORMAL, entity.sideTable(position));</span>
<span class="nc" id="L24630">                vDesc.addAll(oneCriticalEntity(entity, hd.getLocation(), hd.isRear(), 0));</span>

                // and four pilot hits.
<span class="nc" id="L24633">                vDesc.addAll(damageCrew(entity, 4));</span>
<span class="nc" id="L24634">            }</span>
            // Buildings and gun emplacements and such are only affected by the EMI.
            // No auto-crits or anything.
<span class="nc bnc" id="L24637" title="All 2 branches missed.">        } else if (roll &lt;= 10) {</span>
<span class="nc bnc" id="L24638" title="All 2 branches missed.">            if (entity instanceof BattleArmor) {</span>
                // It takes 25% casualties, rounded up.
<span class="nc" id="L24640">                BattleArmor myBA = (BattleArmor) entity;</span>
<span class="nc" id="L24641">                int numDeaths = (int) (Math.ceil(((myBA.getNumberActiverTroopers())) / 4.0));</span>
<span class="nc bnc" id="L24642" title="All 2 branches missed.">                for (int x = 0; x &lt; numDeaths; x++) {</span>
<span class="nc" id="L24643">                    vDesc.addAll(applyCriticalHit(entity, 0, null, false, 0, false));</span>
                }
<span class="nc bnc" id="L24645" title="All 2 branches missed.">            } else if (entity instanceof Infantry) {</span>
<span class="nc bnc" id="L24646" title="All 2 branches missed.">                if (game.getBoard().getHex(entity.getPosition()).containsTerrain(Terrains.BUILDING)) {</span>
                    // 25% casualties, rounded up.
<span class="nc" id="L24648">                    int damage = (int) (Math.ceil((entity.getInternal(Infantry.LOC_INFANTRY)) / 4.0));</span>
<span class="nc" id="L24649">                    vDesc.addAll(damageEntity(entity, new HitData(Infantry.LOC_INFANTRY), damage, true));</span>
<span class="nc" id="L24650">                } else {</span>
                    // 50% casualties, rounded up.
<span class="nc" id="L24652">                    int damage = (int) (Math.ceil((entity.getInternal(Infantry.LOC_INFANTRY)) / 2.0));</span>
<span class="nc" id="L24653">                    vDesc.addAll(damageEntity(entity, new HitData(Infantry.LOC_INFANTRY), damage, true));</span>
<span class="nc" id="L24654">                }</span>
<span class="nc bnc" id="L24655" title="All 2 branches missed.">            } else if (entity instanceof Tank) {</span>
                // It takes one crit...
<span class="nc" id="L24657">                HitData hd = entity.rollHitLocation(ToHitData.HIT_NORMAL, entity.sideTable(position));</span>
<span class="nc" id="L24658">                vDesc.addAll(oneCriticalEntity(entity, hd.getLocation(), hd.isRear(), 0));</span>

                // Plus a Crew Stunned critical.
<span class="nc" id="L24661">                vDesc.addAll(applyCriticalHit(entity, 0, new CriticalSlot(0,</span>
                        Tank.CRIT_CREW_STUNNED), false, 0, false));
<span class="nc bnc" id="L24663" title="All 4 branches missed.">            } else if ((entity instanceof Mech) || (entity instanceof Protomech)) {</span>
                // 'Mechs suffer a critical hit...
<span class="nc" id="L24665">                HitData hd = entity.rollHitLocation(ToHitData.HIT_NORMAL, entity.sideTable(position));</span>
<span class="nc" id="L24666">                vDesc.addAll(oneCriticalEntity(entity, hd.getLocation(), hd.isRear(), 0));</span>

                // and two pilot hits.
<span class="nc" id="L24669">                vDesc.addAll(damageCrew(entity, 2));</span>
            }
            // Buildings and gun emplacements and such are only affected by
            // the EMI.
            // No auto-crits or anything.
        }
        // If it's 11+, there are no secondary effects beyond EMI.
        // Lucky bastards.

        // And lastly, the unit is now affected by electromagnetic interference.
<span class="nc" id="L24679">        entity.setEMI(true);</span>
<span class="nc" id="L24680">    }</span>

    /**
     * Apply a single critical hit. The following private member of Server are
     * accessed from this function, preventing it from being factored out of the
     * Server class: destroyEntity() destroyLocation() checkEngineExplosion()
     * damageCrew() explodeEquipment() game
     *
     * @param en               the &lt;code&gt;Entity&lt;/code&gt; that is being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;.
     * @param loc              the &lt;code&gt;int&lt;/code&gt; location of critical hit. This value may
     *                         be &lt;code&gt;Entity.NONE&lt;/code&gt; for hits to &lt;code&gt;Tank&lt;/code&gt;s and
     *                         for hits to a &lt;code&gt;Protomech&lt;/code&gt; torso weapon.
     * @param cs               the &lt;code&gt;CriticalSlot&lt;/code&gt; being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;. For critical hits on a
     *                         &lt;code&gt;Tank&lt;/code&gt;, the index of the slot should be the index
     *                         of the critical hit table.
     * @param secondaryEffects the &lt;code&gt;boolean&lt;/code&gt; flag that indicates whether to allow
     *                         critical hits to cause secondary effects (such as triggering
     *                         an ammo explosion, sending hovercraft to watery graves, or
     *                         damaging ProtoMech torso weapons). This value is normally
     *                         &lt;code&gt;true&lt;/code&gt;, but it will be &lt;code&gt;false&lt;/code&gt; when the
     *                         hit is being applied from a saved game or scenario.
     * @param damageCaused     the amount of damage causing this critical.
     * @param isCapital        whether it was capital scale damage that caused critical
     */
    public Vector&lt;Report&gt; applyCriticalHit(Entity en, int loc, CriticalSlot cs,
                                           boolean secondaryEffects, int damageCaused,
                                           boolean isCapital) {
<span class="nc" id="L24709">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

<span class="nc bnc" id="L24712" title="All 2 branches missed.">        if (en instanceof Tank) {</span>
<span class="nc" id="L24713">            vDesc.addAll(applyTankCritical((Tank)en, loc, cs, damageCaused));</span>
<span class="nc bnc" id="L24714" title="All 2 branches missed.">        } else if (en instanceof Aero) {</span>
<span class="nc" id="L24715">            vDesc.addAll(applyAeroCritical((Aero)en, loc, cs, damageCaused, isCapital));</span>
<span class="nc bnc" id="L24716" title="All 2 branches missed.">        } else if (en instanceof BattleArmor) {</span>
            // We might as well handle this here.
            // However, we're considering a crit against BA as a &quot;crew kill&quot;.
<span class="nc" id="L24719">            BattleArmor ba = (BattleArmor) en;</span>
<span class="nc" id="L24720">            r = new Report(6111);</span>
<span class="nc" id="L24721">            int randomTrooper = ba.getRandomTrooper();</span>
<span class="nc" id="L24722">            ba.destroyLocation(randomTrooper);</span>
<span class="nc" id="L24723">            r.add(randomTrooper);</span>
<span class="nc" id="L24724">            r.newlines = 1;</span>
<span class="nc" id="L24725">            vDesc.add(r);</span>
<span class="nc bnc" id="L24726" title="All 2 branches missed.">        } else if (CriticalSlot.TYPE_SYSTEM == cs.getType()) {</span>
            // Handle critical hits on system slots.
<span class="nc" id="L24728">            cs.setHit(true);</span>
<span class="nc bnc" id="L24729" title="All 2 branches missed.">            if (en instanceof Protomech) {</span>
<span class="nc" id="L24730">                vDesc.addAll(applyProtomechCritical((Protomech)en, loc, cs, secondaryEffects, damageCaused, isCapital));</span>
            } else {
<span class="nc" id="L24732">                vDesc.addAll(applyMechSystemCritical(en, loc, cs));</span>
            }
<span class="nc bnc" id="L24734" title="All 2 branches missed.">        } else if (CriticalSlot.TYPE_EQUIPMENT == cs.getType()) {</span>
<span class="nc" id="L24735">            vDesc.addAll(applyEquipmentCritical(en, loc, cs, secondaryEffects));</span>
        } // End crit-on-equipment-slot
        // mechs with TSM hit by anti-tsm missiles this round get another
        // crit
<span class="nc bnc" id="L24739" title="All 4 branches missed.">        if ((en instanceof Mech) &amp;&amp; en.hitThisRoundByAntiTSM) {</span>
<span class="nc" id="L24740">            Mech mech = (Mech) en;</span>
<span class="nc bnc" id="L24741" title="All 2 branches missed.">            if (mech.hasTSM()) {</span>
<span class="nc" id="L24742">                r = new Report(6430);</span>
<span class="nc" id="L24743">                r.subject = en.getId();</span>
<span class="nc" id="L24744">                r.indent(2);</span>
<span class="nc" id="L24745">                r.addDesc(en);</span>
<span class="nc" id="L24746">                r.newlines = 0;</span>
<span class="nc" id="L24747">                vDesc.addElement(r);</span>
<span class="nc" id="L24748">                vDesc.addAll(oneCriticalEntity(en, Compute.d6(2), false, damageCaused));</span>
            }
<span class="nc" id="L24750">            en.hitThisRoundByAntiTSM = false;</span>
        }

        // if using buffered VDNI then a possible pilot hit
<span class="nc bnc" id="L24754" title="All 4 branches missed.">        if (en.hasAbility(OptionsConstants.MD_BVDNI) &amp;&amp; !en.hasAbility(OptionsConstants.MD_PAIN_SHUNT)) {</span>
<span class="nc" id="L24755">            Report.addNewline(vDesc);</span>
<span class="nc" id="L24756">            int roll = Compute.d6(2);</span>
<span class="nc" id="L24757">            r = new Report(3580);</span>
<span class="nc" id="L24758">            r.subject = en.getId();</span>
<span class="nc" id="L24759">            r.addDesc(en);</span>
<span class="nc" id="L24760">            r.add(7);</span>
<span class="nc" id="L24761">            r.add(roll);</span>
<span class="nc bnc" id="L24762" title="All 2 branches missed.">            r.choose(roll &gt;= 8);</span>
<span class="nc" id="L24763">            r.indent(2);</span>
<span class="nc" id="L24764">            vDesc.add(r);</span>
<span class="nc bnc" id="L24765" title="All 2 branches missed.">            if (roll &gt;= 8) {</span>
<span class="nc" id="L24766">                vDesc.addAll(damageCrew(en, 1));</span>
            }
        }

        // Return the results of the damage.
<span class="nc" id="L24771">        return vDesc;</span>
    }

    /**
     * Apply a single critical hit to an equipment slot.
     *
     * @param en               the &lt;code&gt;Entity&lt;/code&gt; that is being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;.
     * @param loc              the &lt;code&gt;int&lt;/code&gt; location of critical hit.
     * @param cs               the &lt;code&gt;CriticalSlot&lt;/code&gt; being damaged.
     * @param secondaryEffects the &lt;code&gt;boolean&lt;/code&gt; flag that indicates whether to allow
     *                         critical hits to cause secondary effects (such as triggering
     *                         an ammo explosion, sending hovercraft to watery graves, or
     *                         damaging ProtoMech torso weapons). This value is normally
     *                         &lt;code&gt;true&lt;/code&gt;, but it will be &lt;code&gt;false&lt;/code&gt; when the
     *                         hit is being applied from a saved game or scenario.
     */
    private Vector&lt;Report&gt; applyEquipmentCritical(Entity en, int loc, CriticalSlot cs,
                                                  boolean secondaryEffects) {
<span class="nc" id="L24790">        Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L24792">        cs.setHit(true);</span>
<span class="nc" id="L24793">        Mounted mounted = cs.getMount();</span>
<span class="nc" id="L24794">        EquipmentType eqType = mounted.getType();</span>
<span class="nc" id="L24795">        boolean hitBefore = mounted.isHit();</span>

<span class="nc" id="L24797">        r = new Report(6225);</span>
<span class="nc" id="L24798">        r.subject = en.getId();</span>
<span class="nc" id="L24799">        r.indent(3);</span>
<span class="nc" id="L24800">        r.add(mounted.getDesc());</span>
<span class="nc" id="L24801">        reports.addElement(r);</span>

        // Shield objects are not useless when they take one crit.
        // Shields can be critted and still be usable.
<span class="nc bnc" id="L24805" title="All 4 branches missed.">        if ((eqType instanceof MiscType) &amp;&amp; ((MiscType) eqType).isShield()) {</span>
<span class="nc" id="L24806">            mounted.setHit(false);</span>
        } else {
<span class="nc" id="L24808">            mounted.setHit(true);</span>
        }

<span class="nc bnc" id="L24811" title="All 4 branches missed.">        if ((eqType instanceof MiscType) &amp;&amp; eqType.hasFlag(MiscType.F_EMERGENCY_COOLANT_SYSTEM)) {</span>
<span class="nc" id="L24812">            ((Mech)en).setHasDamagedCoolantSystem(true);</span>
        }

<span class="nc bnc" id="L24815" title="All 4 branches missed.">        if ((eqType instanceof MiscType) &amp;&amp; eqType.hasFlag(MiscType.F_HARJEL)) {</span>
<span class="nc" id="L24816">            reports.addAll(breachLocation(en, loc, null, true));</span>
        }

        // HarJel II/III hits trigger another possible critical hit on
        // the same location
        // it's like an ammunition explosion---a secondary effect
<span class="nc bnc" id="L24822" title="All 4 branches missed.">        if (secondaryEffects &amp;&amp; (eqType instanceof MiscType)</span>
<span class="nc bnc" id="L24823" title="All 6 branches missed.">                &amp;&amp; (eqType.hasFlag(MiscType.F_HARJEL_II) || eqType.hasFlag(MiscType.F_HARJEL_III))</span>
                &amp;&amp; !hitBefore) {
<span class="nc" id="L24825">            r = new Report(9852);</span>
<span class="nc" id="L24826">            r.subject = en.getId();</span>
<span class="nc" id="L24827">            r.indent(2);</span>
<span class="nc" id="L24828">            reports.addElement(r);</span>
<span class="nc" id="L24829">            reports.addAll(criticalEntity(en, loc, false, 0, 0));</span>
        }

        // If the item is the ECM suite of a Mek Stealth system
        // then it's destruction turns off the stealth.
<span class="nc bnc" id="L24834" title="All 4 branches missed.">        if (!hitBefore &amp;&amp; (eqType instanceof MiscType)</span>
<span class="nc bnc" id="L24835" title="All 2 branches missed.">            &amp;&amp; eqType.hasFlag(MiscType.F_ECM)</span>
<span class="nc bnc" id="L24836" title="All 2 branches missed.">            &amp;&amp; (mounted.getLinkedBy() != null)) {</span>
<span class="nc" id="L24837">            Mounted stealth = mounted.getLinkedBy();</span>
<span class="nc" id="L24838">            r = new Report(6255);</span>
<span class="nc" id="L24839">            r.subject = en.getId();</span>
<span class="nc" id="L24840">            r.indent(2);</span>
<span class="nc" id="L24841">            r.add(stealth.getType().getName());</span>
<span class="nc" id="L24842">            reports.addElement(r);</span>
<span class="nc" id="L24843">            stealth.setMode(&quot;Off&quot;);</span>
        }

        // Handle equipment explosions.
        // Equipment explosions are secondary effects and
        // do not occur when loading from a scenario.
<span class="nc bnc" id="L24849" title="All 4 branches missed.">        if (((secondaryEffects &amp;&amp; eqType.isExplosive(mounted))</span>
<span class="nc bnc" id="L24850" title="All 6 branches missed.">                || mounted.isHotLoaded() || (mounted.hasChargedCapacitor() != 0))</span>
                &amp;&amp; !hitBefore) {
<span class="nc" id="L24852">            reports.addAll(explodeEquipment(en, loc, mounted));</span>
        }

        // Make sure that ammo in this slot is exhausted.
<span class="nc bnc" id="L24856" title="All 2 branches missed.">        if (mounted.getBaseShotsLeft() &gt; 0) {</span>
<span class="nc" id="L24857">            mounted.setShotsLeft(0);</span>
        }

        // LAMs that are part of a fighter squadron will need to have the squadron recalculate
        // the bomb load out on a bomb bay critical.
<span class="nc bnc" id="L24862" title="All 4 branches missed.">        if (en.isPartOfFighterSquadron() &amp;&amp; (mounted.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L24863" title="All 2 branches missed.">                &amp;&amp; mounted.getType().hasFlag(MiscType.F_BOMB_BAY)) {</span>
<span class="nc" id="L24864">            Entity squadron = game.getEntity(en.getTransportId());</span>
<span class="nc bnc" id="L24865" title="All 2 branches missed.">            if (squadron instanceof FighterSquadron) {</span>
<span class="nc" id="L24866">                ((FighterSquadron) squadron).computeSquadronBombLoadout();</span>
            }
        }
<span class="nc" id="L24869">        return reports;</span>
    }

    /**
     * Apply a single critical hit to a Mech system.
     *
     * @param en   the &lt;code&gt;Entity&lt;/code&gt; that is being damaged. This value may
     *             not be &lt;code&gt;null&lt;/code&gt;.
     * @param loc  the &lt;code&gt;int&lt;/code&gt; location of critical hit.
     * @param cs   the &lt;code&gt;CriticalSlot&lt;/code&gt; being damaged. This value may
     *             not be &lt;code&gt;null&lt;/code&gt;.
     */
    private Vector&lt;Report&gt; applyMechSystemCritical(Entity en, int loc, CriticalSlot cs) {
<span class="nc" id="L24882">        Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L24884">        r = new Report(6225);</span>
<span class="nc" id="L24885">        r.subject = en.getId();</span>
<span class="nc" id="L24886">        r.indent(3);</span>
<span class="nc" id="L24887">        r.add(((Mech) en).getSystemName(cs.getIndex()));</span>
<span class="nc" id="L24888">        reports.addElement(r);</span>
<span class="nc bnc" id="L24889" title="All 7 branches missed.">        switch (cs.getIndex()) {</span>
            case Mech.SYSTEM_COCKPIT:
                // Lets auto-eject if we can!
<span class="nc" id="L24892">                Mech mech = (Mech) en;</span>
<span class="nc bnc" id="L24893" title="All 2 branches missed.">                if (game.getOptions().booleanOption(</span>
                        OptionsConstants.ADVANCED_TACOPS_SKIN_OF_THE_TEETH_EJECTION)) {
<span class="nc bnc" id="L24895" title="All 2 branches missed.">                    if (mech.isAutoEject()</span>
<span class="nc bnc" id="L24896" title="All 2 branches missed.">                        &amp;&amp; (!game.getOptions().booleanOption(OptionsConstants.RPG_CONDITIONAL_EJECTION)</span>
<span class="nc bnc" id="L24897" title="All 2 branches missed.">                            || (game.getOptions().booleanOption(</span>
                                    OptionsConstants.RPG_CONDITIONAL_EJECTION)
<span class="nc bnc" id="L24899" title="All 2 branches missed.">                            &amp;&amp; mech.isCondEjectHeadshot()))) {</span>
<span class="nc" id="L24900">                        reports.addAll(ejectEntity(en, true, true));</span>
                    }
                }

                //First check whether this hit takes out the whole crew; for multi-crew cockpits
                //we need to check the other critical positions (if any).
<span class="nc" id="L24906">                boolean allDead = true;</span>
<span class="nc" id="L24907">                int crewSlot = ((Mech)en).getCrewForCockpitSlot(loc, cs);</span>
<span class="nc bnc" id="L24908" title="All 2 branches missed.">                if (crewSlot &gt;= 0) {</span>
<span class="nc bnc" id="L24909" title="All 2 branches missed.">                    for (int i = 0; i &lt; en.getCrew().getSlotCount(); i++) {</span>
<span class="nc bnc" id="L24910" title="All 6 branches missed.">                        if (i != crewSlot &amp;&amp; !en.getCrew().isDead(i) &amp;&amp; !en.getCrew().isMissing(i)) {</span>
<span class="nc" id="L24911">                            allDead = false;</span>
                        }
                    }
                }
<span class="nc bnc" id="L24915" title="All 2 branches missed.">                if (allDead) {</span>
                    // Don't kill a pilot multiple times.
<span class="nc bnc" id="L24917" title="All 2 branches missed.">                    if (Crew.DEATH &gt; en.getCrew().getHits()) {</span>
                        // Single pilot or tripod cockpit; all crew are killed.
<span class="nc" id="L24919">                        en.getCrew().setDoomed(true);</span>
<span class="nc" id="L24920">                        Report.addNewline(reports);</span>
<span class="nc" id="L24921">                        reports.addAll(destroyEntity(en, &quot;pilot death&quot;, true));</span>
                    }
<span class="nc bnc" id="L24923" title="All 2 branches missed.">                } else if (!en.getCrew().isMissing(crewSlot)){</span>
<span class="nc bnc" id="L24924" title="All 2 branches missed.">                    boolean wasPilot = en.getCrew().getCurrentPilotIndex() == crewSlot;</span>
<span class="nc bnc" id="L24925" title="All 2 branches missed.">                    boolean wasGunner = en.getCrew().getCurrentGunnerIndex() == crewSlot;</span>
<span class="nc" id="L24926">                    en.getCrew().setDead(true, crewSlot);</span>
<span class="nc" id="L24927">                    r = new Report(6027);</span>
<span class="nc" id="L24928">                    r.subject = en.getId();</span>
<span class="nc" id="L24929">                    r.indent(2);</span>
<span class="nc" id="L24930">                    r.add(en.getCrew().getCrewType().getRoleName(crewSlot));</span>
<span class="nc" id="L24931">                    r.addDesc(en);</span>
<span class="nc" id="L24932">                    r.add(en.getCrew().getName(crewSlot));</span>
<span class="nc" id="L24933">                    reports.addElement(r);</span>
<span class="nc" id="L24934">                    r = createCrewTakeoverReport(en, crewSlot, wasPilot, wasGunner);</span>
<span class="nc bnc" id="L24935" title="All 2 branches missed.">                    if (null != r) {</span>
<span class="nc" id="L24936">                        reports.add(r);</span>
                    }
<span class="nc" id="L24938">                }</span>

                break;
            case Mech.SYSTEM_ENGINE:
                // if the slot is missing, the location was previously
                // destroyed and the engine hit was then counted already
<span class="nc bnc" id="L24944" title="All 2 branches missed.">                if (!cs.isMissing()) {</span>
<span class="nc" id="L24945">                    en.engineHitsThisPhase++;</span>
                }
<span class="nc" id="L24947">                int numEngineHits = en.getEngineHits();</span>
<span class="nc" id="L24948">                boolean engineExploded = checkEngineExplosion(en, reports, numEngineHits);</span>
<span class="nc" id="L24949">                int hitsToDestroy = 3;</span>
<span class="nc bnc" id="L24950" title="All 4 branches missed.">                if (en.isSuperHeavy() &amp;&amp; en.hasEngine()</span>
<span class="nc bnc" id="L24951" title="All 2 branches missed.">                        &amp;&amp; (en.getEngine().getEngineType() == Engine.COMPACT_ENGINE)) {</span>
<span class="nc" id="L24952">                    hitsToDestroy = 2;</span>
                }

<span class="nc bnc" id="L24955" title="All 4 branches missed.">                if (!engineExploded &amp;&amp; (numEngineHits &gt;= hitsToDestroy)) {</span>
                    // third engine hit
<span class="nc" id="L24957">                    reports.addAll(destroyEntity(en, &quot;engine destruction&quot;));</span>
<span class="nc" id="L24958">                    if (game.getOptions()</span>
<span class="nc bnc" id="L24959" title="All 2 branches missed.">                            .booleanOption(OptionsConstants.ADVGRNDMOV_AUTO_ABANDON_UNIT)) {</span>
<span class="nc" id="L24960">                        reports.addAll(abandonEntity(en));</span>
                    }
<span class="nc" id="L24962">                    en.setSelfDestructing(false);</span>
<span class="nc" id="L24963">                    en.setSelfDestructInitiated(false);</span>
                }
                break;
            case Mech.SYSTEM_GYRO:
<span class="nc" id="L24967">                int gyroHits = en.getHitCriticals(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_GYRO, loc);</span>
<span class="nc bnc" id="L24968" title="All 2 branches missed.">                if (en.getGyroType() != Mech.GYRO_HEAVY_DUTY) {</span>
<span class="nc" id="L24969">                    gyroHits++;</span>
                }
                // Automatically falls in AirMech mode, which it seems would indicate a crash if airborne.
<span class="nc bnc" id="L24972" title="All 6 branches missed.">                if (gyroHits == 3 &amp;&amp; en instanceof LandAirMech &amp;&amp; en.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L24973">                    crashAirMech(en, new PilotingRollData(en.getId(),</span>
                            TargetRoll.AUTOMATIC_FAIL, 1, &quot;gyro destroyed&quot;), reports);
<span class="nc" id="L24975">                    break;</span>
                }
                //No PSR for Mechs in non-leg mode
<span class="nc bnc" id="L24978" title="All 2 branches missed.">                if (!en.canFall(true)) {</span>
<span class="nc" id="L24979">                    break;</span>
                }
<span class="nc bnc" id="L24981" title="All 4 branches missed.">                switch (gyroHits) {</span>
                    case 3:
                        // HD 3 hits, standard 2 hits
<span class="nc" id="L24984">                        game.addPSR(new PilotingRollData(en.getId(), TargetRoll.AUTOMATIC_FAIL,</span>
                                1, &quot;gyro destroyed&quot;));
                        // Gyro destroyed entities may not be hull down
<span class="nc" id="L24987">                        en.setHullDown(false);</span>
<span class="nc" id="L24988">                        break;</span>
                    case 2:
                        // HD 2 hits, standard 1 hit
<span class="nc" id="L24991">                        game.addPSR(new PilotingRollData(en.getId(), 3, &quot;gyro hit&quot;));</span>
<span class="nc" id="L24992">                        break;</span>
                    case 1:
                        // HD 1 hit
<span class="nc" id="L24995">                        game.addPSR(new PilotingRollData(en.getId(), 2, &quot;gyro hit&quot;));</span>
<span class="nc" id="L24996">                        break;</span>
                    default:
                        // ignore if &gt;4 hits (don't over do it, the auto fail
                        // already happened.)
                }
<span class="nc" id="L25001">                break;</span>
            case Mech.ACTUATOR_UPPER_LEG:
            case Mech.ACTUATOR_LOWER_LEG:
            case Mech.ACTUATOR_FOOT:
<span class="nc bnc" id="L25005" title="All 2 branches missed.">                if (en.canFall(true)) {</span>
                    // leg/foot actuator piloting roll
<span class="nc" id="L25007">                    game.addPSR(new PilotingRollData(en.getId(), 1, &quot;leg/foot actuator hit&quot;));</span>
                }
                break;
            case Mech.ACTUATOR_HIP:
<span class="nc bnc" id="L25011" title="All 2 branches missed.">                if (en.canFall(true)) {</span>
                    // hip piloting roll
<span class="nc" id="L25013">                    game.addPSR(new PilotingRollData(en.getId(), 2, &quot;hip actuator hit&quot;));</span>
                }
                break;
            case LandAirMech.LAM_AVIONICS:
<span class="nc bnc" id="L25017" title="All 2 branches missed.">                if (en.getConversionMode() == LandAirMech.CONV_MODE_FIGHTER) {</span>
<span class="nc bnc" id="L25018" title="All 2 branches missed.">                    if (en.isPartOfFighterSquadron()) {</span>
<span class="nc" id="L25019">                        game.addControlRoll(new PilotingRollData(</span>
<span class="nc" id="L25020">                                en.getTransportId(), 1, &quot;avionics hit&quot;));</span>
<span class="nc bnc" id="L25021" title="All 2 branches missed.">                    } else if (en.isCapitalFighter()){</span>
<span class="nc" id="L25022">                        game.addControlRoll(new PilotingRollData(en.getId(), 1,</span>
                                &quot;avionics hit&quot;));
                    } else {
<span class="nc" id="L25025">                        game.addControlRoll(new PilotingRollData(en.getId(), 0,</span>
                                &quot;avionics hit&quot;));
                    }
                }
                break;
        }
<span class="nc" id="L25031">        return reports;</span>
    }

    /**
     * Apply a single critical hit to a ProtoMech.
     *
     * @param pm               the &lt;code&gt;Protomech&lt;/code&gt; that is being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;.
     * @param loc              the &lt;code&gt;int&lt;/code&gt; location of critical hit. This value may
     *                         be &lt;code&gt;Entity.NONE&lt;/code&gt; for hits to a &lt;code&gt;Protomech&lt;/code&gt;
     *                         torso weapon.
     * @param cs               the &lt;code&gt;CriticalSlot&lt;/code&gt; being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;.
     * @param secondaryEffects the &lt;code&gt;boolean&lt;/code&gt; flag that indicates whether to allow
     *                         critical hits to cause secondary effects (such as damaging
     *                         ProtoMech torso weapons). This value is normally
     *                         &lt;code&gt;true&lt;/code&gt;, but it will be &lt;code&gt;false&lt;/code&gt; when the
     *                         hit is being applied from a saved game or scenario.
     * @param damageCaused     the amount of damage causing this critical.
     * @param isCapital        whether it was capital scale damage that caused critical
     */
    private Vector&lt;Report&gt; applyProtomechCritical(Protomech pm, int loc, CriticalSlot cs,
                                                  boolean secondaryEffects, int damageCaused,
                                                  boolean isCapital) {
<span class="nc" id="L25055">        Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L25057">        int numHit = pm.getCritsHit(loc);</span>
<span class="nc bnc" id="L25058" title="All 2 branches missed.">        if ((cs.getIndex() != Protomech.SYSTEM_TORSO_WEAPON_A)</span>
<span class="nc bnc" id="L25059" title="All 2 branches missed.">                &amp;&amp; (cs.getIndex() != Protomech.SYSTEM_TORSO_WEAPON_B)</span>
<span class="nc bnc" id="L25060" title="All 2 branches missed.">                &amp;&amp; (cs.getIndex() != Protomech.SYSTEM_TORSO_WEAPON_C)</span>
<span class="nc bnc" id="L25061" title="All 2 branches missed.">                &amp;&amp; (cs.getIndex() != Protomech.SYSTEM_TORSO_WEAPON_D)</span>
<span class="nc bnc" id="L25062" title="All 2 branches missed.">                &amp;&amp; (cs.getIndex() != Protomech.SYSTEM_TORSO_WEAPON_E)</span>
<span class="nc bnc" id="L25063" title="All 2 branches missed.">                &amp;&amp; (cs.getIndex() != Protomech.SYSTEM_TORSO_WEAPON_F)) {</span>
<span class="nc" id="L25064">            r = new Report(6225);</span>
<span class="nc" id="L25065">            r.subject = pm.getId();</span>
<span class="nc" id="L25066">            r.indent(3);</span>
<span class="nc" id="L25067">            r.add(Protomech.systemNames[cs.getIndex()]);</span>
<span class="nc" id="L25068">            reports.addElement(r);</span>
        }
<span class="nc bnc" id="L25070" title="All 11 branches missed.">        switch (cs.getIndex()) {</span>
            case Protomech.SYSTEM_HEADCRIT:
<span class="nc bnc" id="L25072" title="All 2 branches missed.">                if (2 == numHit) {</span>
<span class="nc" id="L25073">                    r = new Report(6230);</span>
<span class="nc" id="L25074">                    r.subject = pm.getId();</span>
<span class="nc" id="L25075">                    reports.addElement(r);</span>
<span class="nc" id="L25076">                    pm.destroyLocation(loc);</span>
                }
                break;
            case Protomech.SYSTEM_ARMCRIT:
<span class="nc bnc" id="L25080" title="All 2 branches missed.">                if (2 == numHit) {</span>
<span class="nc" id="L25081">                    r = new Report(6235);</span>
<span class="nc" id="L25082">                    r.subject = pm.getId();</span>
<span class="nc" id="L25083">                    reports.addElement(r);</span>
<span class="nc" id="L25084">                    pm.destroyLocation(loc);</span>
                }
                break;
            case Protomech.SYSTEM_LEGCRIT:
<span class="nc bnc" id="L25088" title="All 2 branches missed.">                if (3 == numHit) {</span>
<span class="nc" id="L25089">                    r = new Report(6240);</span>
<span class="nc" id="L25090">                    r.subject = pm.getId();</span>
<span class="nc" id="L25091">                    r.newlines = 0;</span>
<span class="nc" id="L25092">                    reports.addElement(r);</span>
<span class="nc" id="L25093">                    pm.destroyLocation(loc);</span>
                }
                break;
            case Protomech.SYSTEM_TORSOCRIT:
<span class="nc bnc" id="L25097" title="All 2 branches missed.">                if (3 == numHit) {</span>
<span class="nc" id="L25098">                    reports.addAll(destroyEntity(pm, &quot;torso destruction&quot;));</span>
                }
                // Torso weapon hits are secondary effects and
                // do not occur when loading from a scenario.
<span class="nc bnc" id="L25102" title="All 2 branches missed.">                else if (secondaryEffects) {</span>
<span class="nc" id="L25103">                    int tweapRoll = Compute.d6(1);</span>
                    CriticalSlot newSlot;

<span class="nc bnc" id="L25106" title="All 7 branches missed.">                    switch (tweapRoll) {</span>
                        case 1:
<span class="nc bnc" id="L25108" title="All 2 branches missed.">                            if (pm.isQuad()) {</span>
<span class="nc" id="L25109">                                newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                        Protomech.SYSTEM_TORSO_WEAPON_A);
<span class="nc" id="L25111">                                reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                        secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25113">                                break;</span>
                            }
                        case 2:
<span class="nc bnc" id="L25116" title="All 2 branches missed.">                            if (pm.isQuad()) {</span>
<span class="nc" id="L25117">                                newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                        Protomech.SYSTEM_TORSO_WEAPON_B);
<span class="nc" id="L25119">                                reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                        secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25121">                                break;</span>
                            }
<span class="nc" id="L25123">                            newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                    Protomech.SYSTEM_TORSO_WEAPON_A);
<span class="nc" id="L25125">                            reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                    secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25127">                            break;</span>
                        case 3:
<span class="nc bnc" id="L25129" title="All 2 branches missed.">                            if (pm.isQuad()) {</span>
<span class="nc" id="L25130">                                newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                        Protomech.SYSTEM_TORSO_WEAPON_C);
<span class="nc" id="L25132">                                reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                        secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25134">                                break;</span>
                            }
                        case 4:
<span class="nc bnc" id="L25137" title="All 2 branches missed.">                            if (pm.isQuad()) {</span>
<span class="nc" id="L25138">                                newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                        Protomech.SYSTEM_TORSO_WEAPON_D);
<span class="nc" id="L25140">                                reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                        secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25142">                                break;</span>
                            }
<span class="nc" id="L25144">                            newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                    Protomech.SYSTEM_TORSO_WEAPON_B);
<span class="nc" id="L25146">                            reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                    secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25148">                            break;</span>
                        case 5:
<span class="nc bnc" id="L25150" title="All 2 branches missed.">                            if (pm.getWeight() &gt; 9) {</span>
<span class="nc bnc" id="L25151" title="All 2 branches missed.">                                if (pm.isQuad()) {</span>
<span class="nc" id="L25152">                                    newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                            Protomech.SYSTEM_TORSO_WEAPON_E);
<span class="nc" id="L25154">                                    reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                            secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25156">                                    break;</span>
                                }
<span class="nc" id="L25158">                                newSlot = new CriticalSlot(</span>
                                        CriticalSlot.TYPE_SYSTEM,
                                        Protomech.SYSTEM_TORSO_WEAPON_C);
<span class="nc" id="L25161">                                reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                        secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25163">                                break;</span>
                            }
                        case 6:
<span class="nc bnc" id="L25166" title="All 2 branches missed.">                            if (pm.getWeight() &gt; 9) {</span>
<span class="nc bnc" id="L25167" title="All 2 branches missed.">                                if (pm.isQuad()) {</span>
<span class="nc" id="L25168">                                    newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                            Protomech.SYSTEM_TORSO_WEAPON_F);
<span class="nc" id="L25170">                                    reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                            secondaryEffects, damageCaused, isCapital));
<span class="nc" id="L25172">                                    break;</span>
                                }
<span class="nc" id="L25174">                                newSlot = new CriticalSlot(CriticalSlot.TYPE_SYSTEM,</span>
                                        Protomech.SYSTEM_TORSO_WEAPON_C);
<span class="nc" id="L25176">                                reports.addAll(applyCriticalHit(pm, Entity.NONE, newSlot,</span>
                                        secondaryEffects, damageCaused, isCapital));
                                break;
                            }
                    }
                    // A magnetic clamp system is destroyed by any torso critical.
<span class="nc" id="L25182">                    Mounted magClamp = pm.getMisc().stream().filter(m -&gt; m.getType()</span>
<span class="nc" id="L25183">                            .hasFlag(MiscType.F_MAGNETIC_CLAMP)).findFirst().orElse(null);</span>
<span class="nc bnc" id="L25184" title="All 4 branches missed.">                    if ((magClamp != null) &amp;&amp; !magClamp.isHit()) {</span>
<span class="nc" id="L25185">                        magClamp.setHit(true);</span>
<span class="nc" id="L25186">                        r = new Report(6252);</span>
<span class="nc" id="L25187">                        r.subject = pm.getId();</span>
<span class="nc" id="L25188">                        reports.addElement(r);</span>
                    }
<span class="nc" id="L25190">                }</span>
                break;
            case Protomech.SYSTEM_TORSO_WEAPON_A:
<span class="nc" id="L25193">                Mounted weaponA = pm.getTorsoWeapon(cs.getIndex());</span>
<span class="nc bnc" id="L25194" title="All 2 branches missed.">                if (null != weaponA) {</span>
<span class="nc" id="L25195">                    weaponA.setHit(true);</span>
<span class="nc" id="L25196">                    r = new Report(6245);</span>
<span class="nc" id="L25197">                    r.subject = pm.getId();</span>
<span class="nc" id="L25198">                    r.newlines = 0;</span>
<span class="nc" id="L25199">                    reports.addElement(r);</span>
                }
                break;
            case Protomech.SYSTEM_TORSO_WEAPON_B:
<span class="nc" id="L25203">                Mounted weaponB = pm.getTorsoWeapon(cs.getIndex());</span>
<span class="nc bnc" id="L25204" title="All 2 branches missed.">                if (null != weaponB) {</span>
<span class="nc" id="L25205">                    weaponB.setHit(true);</span>
<span class="nc" id="L25206">                    r = new Report(6246);</span>
<span class="nc" id="L25207">                    r.subject = pm.getId();</span>
<span class="nc" id="L25208">                    r.newlines = 0;</span>
<span class="nc" id="L25209">                    reports.addElement(r);</span>
                }
                break;
            case Protomech.SYSTEM_TORSO_WEAPON_C:
<span class="nc" id="L25213">                Mounted weaponC = pm.getTorsoWeapon(cs.getIndex());</span>
<span class="nc bnc" id="L25214" title="All 2 branches missed.">                if (null != weaponC) {</span>
<span class="nc" id="L25215">                    weaponC.setHit(true);</span>
<span class="nc" id="L25216">                    r = new Report(6247);</span>
<span class="nc" id="L25217">                    r.subject = pm.getId();</span>
<span class="nc" id="L25218">                    r.newlines = 0;</span>
<span class="nc" id="L25219">                    reports.addElement(r);</span>
                }
                break;
            case Protomech.SYSTEM_TORSO_WEAPON_D:
<span class="nc" id="L25223">                Mounted weaponD = pm.getTorsoWeapon(cs.getIndex());</span>
<span class="nc bnc" id="L25224" title="All 2 branches missed.">                if (null != weaponD) {</span>
<span class="nc" id="L25225">                    weaponD.setHit(true);</span>
<span class="nc" id="L25226">                    r = new Report(6248);</span>
<span class="nc" id="L25227">                    r.subject = pm.getId();</span>
<span class="nc" id="L25228">                    r.newlines = 0;</span>
<span class="nc" id="L25229">                    reports.addElement(r);</span>
                }
                break;
            case Protomech.SYSTEM_TORSO_WEAPON_E:
<span class="nc" id="L25233">                Mounted weaponE = pm.getTorsoWeapon(cs.getIndex());</span>
<span class="nc bnc" id="L25234" title="All 2 branches missed.">                if (null != weaponE) {</span>
<span class="nc" id="L25235">                    weaponE.setHit(true);</span>
<span class="nc" id="L25236">                    r = new Report(6249);</span>
<span class="nc" id="L25237">                    r.subject = pm.getId();</span>
<span class="nc" id="L25238">                    r.newlines = 0;</span>
<span class="nc" id="L25239">                    reports.addElement(r);</span>
                }
                break;
            case Protomech.SYSTEM_TORSO_WEAPON_F:
<span class="nc" id="L25243">                Mounted weaponF = pm.getTorsoWeapon(cs.getIndex());</span>
<span class="nc bnc" id="L25244" title="All 2 branches missed.">                if (null != weaponF) {</span>
<span class="nc" id="L25245">                    weaponF.setHit(true);</span>
<span class="nc" id="L25246">                    r = new Report(6250);</span>
<span class="nc" id="L25247">                    r.subject = pm.getId();</span>
<span class="nc" id="L25248">                    r.newlines = 0;</span>
<span class="nc" id="L25249">                    reports.addElement(r);</span>
                }
                break;
        } // End switch( cs.getType() )

        // Shaded hits cause pilot damage.
<span class="nc bnc" id="L25255" title="All 2 branches missed.">        if (pm.shaded(loc, numHit)) {</span>
            // Destroyed ProtoMech sections have
            // already damaged the pilot.
<span class="nc" id="L25258">            int pHits = Protomech.POSSIBLE_PILOT_DAMAGE[loc]</span>
<span class="nc" id="L25259">                        - pm.getPilotDamageTaken(loc);</span>
<span class="nc bnc" id="L25260" title="All 2 branches missed.">            if (Math.min(1, pHits) &gt; 0) {</span>
<span class="nc" id="L25261">                Report.addNewline(reports);</span>
<span class="nc" id="L25262">                reports.addAll(damageCrew(pm, 1));</span>
<span class="nc" id="L25263">                pHits = 1 + pm.getPilotDamageTaken(loc);</span>
<span class="nc" id="L25264">                pm.setPilotDamageTaken(loc, pHits);</span>
            }
        } // End have-shaded-hit
<span class="nc" id="L25267">        return reports;</span>
    }

    /**
     * Apply a single critical hit to an aerospace unit.
     *
     * @param aero             the &lt;code&gt;Aero&lt;/code&gt; that is being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;.
     * @param loc              the &lt;code&gt;int&lt;/code&gt; location of critical hit.
     * @param cs               the &lt;code&gt;CriticalSlot&lt;/code&gt; being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;.
     * @param damageCaused     the amount of damage causing this critical.
     * @param isCapital        whether it was capital scale damage that caused critical
     */
    private Vector&lt;Report&gt; applyAeroCritical(Aero aero, int loc, CriticalSlot cs, int damageCaused, boolean isCapital) {
<span class="nc" id="L25282">        Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L25284">        Jumpship js = null;</span>
<span class="nc bnc" id="L25285" title="All 2 branches missed.">        if (aero instanceof Jumpship) {</span>
<span class="nc" id="L25286">            js = (Jumpship)aero;</span>
        }

<span class="nc bnc" id="L25289" title="All 24 branches missed.">        switch (cs.getIndex()) {</span>
            case Aero.CRIT_NONE:
                // no effect
<span class="nc" id="L25292">                r = new Report(6005);</span>
<span class="nc" id="L25293">                r.subject = aero.getId();</span>
<span class="nc" id="L25294">                reports.add(r);</span>
<span class="nc" id="L25295">                break;</span>
            case Aero.CRIT_FCS:
                // Fire control system
<span class="nc" id="L25298">                r = new Report(9105);</span>
<span class="nc" id="L25299">                r.subject = aero.getId();</span>
<span class="nc" id="L25300">                reports.add(r);</span>
<span class="nc" id="L25301">                aero.setFCSHits(aero.getFCSHits() + 1);</span>
<span class="nc" id="L25302">                break;</span>
            case Aero.CRIT_SENSOR:
                // sensors
<span class="nc" id="L25305">                r = new Report(6620);</span>
<span class="nc" id="L25306">                r.subject = aero.getId();</span>
<span class="nc" id="L25307">                reports.add(r);</span>
<span class="nc" id="L25308">                aero.setSensorHits(aero.getSensorHits() + 1);</span>
<span class="nc" id="L25309">                break;</span>
            case Aero.CRIT_AVIONICS:
                // avionics
<span class="nc" id="L25312">                r = new Report(9110);</span>
<span class="nc" id="L25313">                r.subject = aero.getId();</span>
<span class="nc" id="L25314">                reports.add(r);</span>
<span class="nc" id="L25315">                aero.setAvionicsHits(aero.getAvionicsHits() + 1);</span>
<span class="nc bnc" id="L25316" title="All 2 branches missed.">                if (aero.isPartOfFighterSquadron()) {</span>
<span class="nc" id="L25317">                    game.addControlRoll(new PilotingRollData(</span>
<span class="nc" id="L25318">                            aero.getTransportId(), 1, &quot;avionics hit&quot;));</span>
<span class="nc bnc" id="L25319" title="All 2 branches missed.">                } else if (aero.isCapitalFighter()) {</span>
<span class="nc" id="L25320">                    game.addControlRoll(new PilotingRollData(aero.getId(), 1,</span>
                                                             &quot;avionics hit&quot;));
                } else {
<span class="nc" id="L25323">                    game.addControlRoll(new PilotingRollData(aero.getId(), 0,</span>
                                                             &quot;avionics hit&quot;));
                }
<span class="nc" id="L25326">                break;</span>
            case Aero.CRIT_CONTROL:
                // force control roll
<span class="nc" id="L25329">                r = new Report(9115);</span>
<span class="nc" id="L25330">                r.subject = aero.getId();</span>
<span class="nc" id="L25331">                reports.add(r);</span>
<span class="nc bnc" id="L25332" title="All 2 branches missed.">                if (aero.isPartOfFighterSquadron()) {</span>
<span class="nc" id="L25333">                    game.addControlRoll(new PilotingRollData(</span>
<span class="nc" id="L25334">                            aero.getTransportId(), 1, &quot;critical hit&quot;));</span>
<span class="nc bnc" id="L25335" title="All 2 branches missed.">                } else if (aero.isCapitalFighter()) {</span>
<span class="nc" id="L25336">                    game.addControlRoll(new PilotingRollData(aero.getId(), 1,</span>
                                                             &quot;critical hit&quot;));
                } else {
<span class="nc" id="L25339">                    game.addControlRoll(new PilotingRollData(aero.getId(), 0,</span>
                                                             &quot;critical hit&quot;));
                }
<span class="nc" id="L25342">                break;</span>
            case Aero.CRIT_FUEL_TANK:
                // fuel tank
<span class="nc" id="L25345">                int boomTarget = 10;</span>
<span class="nc bnc" id="L25346" title="All 2 branches missed.">                if (aero.hasQuirk(OptionsConstants.QUIRK_NEG_FRAGILE_FUEL)) {</span>
<span class="nc" id="L25347">                    boomTarget = 8;</span>
                }
<span class="nc bnc" id="L25349" title="All 4 branches missed.">                if (aero.isLargeCraft() &amp;&amp; aero.isClan()</span>
<span class="nc bnc" id="L25350" title="All 2 branches missed.">                        &amp;&amp; game.getOptions().booleanOption(</span>
                                OptionsConstants.ADVAERORULES_STRATOPS_HARJEL)) {
<span class="nc" id="L25352">                    boomTarget = 12;</span>
                }
                // check for possible explosion
<span class="nc" id="L25355">                int fuelroll = Compute.d6(2);</span>
<span class="nc" id="L25356">                r = new Report(9120);</span>
<span class="nc" id="L25357">                r.subject = aero.getId();</span>
<span class="nc bnc" id="L25358" title="All 2 branches missed.">                if (fuelroll &gt;= boomTarget) {</span>
                    // A chance to reroll the explosion with edge
<span class="nc bnc" id="L25360" title="All 2 branches missed.">                    if (aero.getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L25361" title="All 2 branches missed.">                            &amp;&amp; aero.getCrew().getOptions().booleanOption(</span>
                                    OptionsConstants.EDGE_WHEN_AERO_EXPLOSION)) {
                        // Reporting this is funky because 9120 only has room for 2 choices. Replace it.
<span class="nc" id="L25364">                        r = new Report(9123);</span>
<span class="nc" id="L25365">                        r.subject = aero.getId();</span>
<span class="nc" id="L25366">                        r.newlines = 0;</span>
<span class="nc" id="L25367">                        reports.add(r);</span>
<span class="nc" id="L25368">                        aero.getCrew().decreaseEdge();</span>
<span class="nc" id="L25369">                        fuelroll = Compute.d6(2);</span>
                        // To explode, or not to explode
<span class="nc bnc" id="L25371" title="All 2 branches missed.">                        if (fuelroll &gt;= boomTarget) {</span>
<span class="nc" id="L25372">                            r = new Report(9124);</span>
<span class="nc" id="L25373">                            r.subject = aero.getId();</span>
                        } else {
<span class="nc" id="L25375">                            r = new Report(9122);</span>
<span class="nc" id="L25376">                            r.subject = aero.getId();</span>
<span class="nc" id="L25377">                            reports.add(r);</span>
<span class="nc" id="L25378">                            break;</span>
                        }
                    }
<span class="nc" id="L25381">                    r.choose(true);</span>
<span class="nc" id="L25382">                    reports.add(r);</span>
                    // Lets auto-eject if we can!
<span class="nc bnc" id="L25384" title="All 2 branches missed.">                    if (aero.isFighter()) {</span>
<span class="nc bnc" id="L25385" title="All 2 branches missed.">                        if (aero.isAutoEject()</span>
<span class="nc bnc" id="L25386" title="All 2 branches missed.">                                &amp;&amp; (!game.getOptions().booleanOption(</span>
                                        OptionsConstants.RPG_CONDITIONAL_EJECTION)
<span class="nc bnc" id="L25388" title="All 2 branches missed.">                                || (game.getOptions().booleanOption(</span>
                                        OptionsConstants.RPG_CONDITIONAL_EJECTION)
<span class="nc bnc" id="L25390" title="All 2 branches missed.">                                &amp;&amp; aero.isCondEjectFuel()))) {</span>
<span class="nc" id="L25391">                            reports.addAll(ejectEntity(aero, true, false));</span>
                        }
                    }
<span class="nc" id="L25394">                    reports.addAll(destroyEntity(aero, &quot;fuel explosion&quot;, false, false));</span>
                } else {
<span class="nc" id="L25396">                    r.choose(false);</span>
<span class="nc" id="L25397">                    reports.add(r);</span>
                }
                
<span class="nc" id="L25400">                aero.setFuelTankHit(true);</span>
<span class="nc" id="L25401">                break;</span>
            case Aero.CRIT_CREW:
                // pilot hit
<span class="nc" id="L25404">                r = new Report(6650);</span>
<span class="nc bnc" id="L25405" title="All 2 branches missed.">                if (aero.hasAbility(OptionsConstants.MD_DERMAL_ARMOR)) {</span>
<span class="nc" id="L25406">                    r = new Report(6651);</span>
<span class="nc" id="L25407">                    r.subject = aero.getId();</span>
<span class="nc" id="L25408">                    reports.add(r);</span>
<span class="nc" id="L25409">                    break;</span>
<span class="nc bnc" id="L25410" title="All 2 branches missed.">                } else if (aero.hasAbility(OptionsConstants.MD_TSM_IMPLANT)) {</span>
<span class="nc" id="L25411">                    r = new Report(6652);</span>
<span class="nc" id="L25412">                    r.subject = aero.getId();</span>
<span class="nc" id="L25413">                    reports.add(r);</span>
<span class="nc" id="L25414">                    break;</span>
                }
<span class="nc bnc" id="L25416" title="All 4 branches missed.">                if ((aero instanceof SmallCraft) || (aero instanceof Jumpship)) {</span>
<span class="nc" id="L25417">                    r = new Report(9197);</span>
                }
<span class="nc bnc" id="L25419" title="All 4 branches missed.">                if (aero.isLargeCraft() &amp;&amp; aero.isClan()</span>
<span class="nc bnc" id="L25420" title="All 2 branches missed.">                        &amp;&amp; game.getOptions().booleanOption(</span>
                                OptionsConstants.ADVAERORULES_STRATOPS_HARJEL)
<span class="nc bnc" id="L25422" title="All 2 branches missed.">                        &amp;&amp; (aero.getIgnoredCrewHits() &lt; 2)) {</span>
<span class="nc" id="L25423">                    aero.setIgnoredCrewHits(aero.getIgnoredCrewHits() + 1);</span>
<span class="nc" id="L25424">                    r = new Report(9198);</span>
<span class="nc" id="L25425">                    r.subject = aero.getId();</span>
<span class="nc" id="L25426">                    reports.add(r);</span>
<span class="nc" id="L25427">                    break;</span>
                }
<span class="nc" id="L25429">                r.subject = aero.getId();</span>
<span class="nc" id="L25430">                reports.add(r);</span>
<span class="nc" id="L25431">                reports.addAll(damageCrew(aero, 1));</span>
                // The pilot may have just expired.
<span class="nc bnc" id="L25433" title="All 4 branches missed.">                if ((aero.getCrew().isDead() || aero.getCrew().isDoomed())</span>
<span class="nc bnc" id="L25434" title="All 2 branches missed.">                       &amp;&amp; !aero.getCrew().isEjected()) {</span>
<span class="nc" id="L25435">                    reports.addAll(destroyEntity(aero, &quot;pilot death&quot;, true, true));</span>
                }
                break;
            case Aero.CRIT_GEAR:
                // landing gear
<span class="nc" id="L25440">                r = new Report(9125);</span>
<span class="nc" id="L25441">                r.subject = aero.getId();</span>
<span class="nc" id="L25442">                reports.add(r);</span>
<span class="nc" id="L25443">                aero.setGearHit(true);</span>
<span class="nc" id="L25444">                break;</span>
            case Aero.CRIT_BOMB:
                // bomb destroyed
                // go through bomb list and choose one
<span class="nc" id="L25448">                List&lt;Mounted&gt; bombs = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L25449" title="All 2 branches missed.">                for (Mounted bomb : aero.getBombs()) {</span>
<span class="nc bnc" id="L25450" title="All 4 branches missed.">                    if (bomb.getType().isHittable() &amp;&amp; (bomb.getHittableShotsLeft() &gt; 0)) {</span>
<span class="nc" id="L25451">                        bombs.add(bomb);</span>
                    }
<span class="nc" id="L25453">                }</span>
<span class="nc bnc" id="L25454" title="All 2 branches missed.">                if (bombs.size() &gt; 0) {</span>
<span class="nc" id="L25455">                    Mounted hitbomb = bombs.get(Compute.randomInt(bombs.size()));</span>
<span class="nc" id="L25456">                    hitbomb.setShotsLeft(0);</span>
<span class="nc" id="L25457">                    hitbomb.setDestroyed(true);</span>
<span class="nc" id="L25458">                    r = new Report(9130);</span>
<span class="nc" id="L25459">                    r.subject = aero.getId();</span>
<span class="nc" id="L25460">                    r.add(hitbomb.getDesc());</span>
<span class="nc" id="L25461">                    reports.add(r);</span>
                    // If we are part of a squadron, we should recalculate
                    // the bomb salvo for the squadron
<span class="nc bnc" id="L25464" title="All 2 branches missed.">                    if (aero.getTransportId() != Entity.NONE) {</span>
<span class="nc" id="L25465">                        Entity e = game.getEntity(aero.getTransportId());</span>
<span class="nc bnc" id="L25466" title="All 2 branches missed.">                        if (e instanceof FighterSquadron) {</span>
<span class="nc" id="L25467">                            ((FighterSquadron) e).computeSquadronBombLoadout();</span>
                        }
                    }
<span class="nc" id="L25470">                } else {</span>
<span class="nc" id="L25471">                    r = new Report(9131);</span>
<span class="nc" id="L25472">                    r.subject = aero.getId();</span>
<span class="nc" id="L25473">                    reports.add(r);</span>
                }
<span class="nc" id="L25475">                break;</span>
            case Aero.CRIT_HEATSINK:
                // heat sink hit
<span class="nc" id="L25478">                int sinksLost = 1;</span>
<span class="nc bnc" id="L25479" title="All 2 branches missed.">                if (isCapital) {</span>
<span class="nc" id="L25480">                    sinksLost = 10;</span>
                }
<span class="nc" id="L25482">                r = new Report(9135);</span>
<span class="nc" id="L25483">                r.subject = aero.getId();</span>
<span class="nc" id="L25484">                r.add(sinksLost);</span>
<span class="nc" id="L25485">                reports.add(r);</span>
<span class="nc" id="L25486">                aero.setHeatSinks(Math.max(0, aero.getHeatSinks() - sinksLost));</span>
<span class="nc" id="L25487">                break;</span>
            case Aero.CRIT_WEAPON_BROAD:
<span class="nc bnc" id="L25489" title="All 2 branches missed.">                if (aero instanceof Warship) {</span>
<span class="nc bnc" id="L25490" title="All 4 branches missed.">                    if ((loc == Jumpship.LOC_ALS) || (loc == Jumpship.LOC_FLS)) {</span>
<span class="nc" id="L25491">                        loc = Warship.LOC_LBS;</span>
<span class="nc bnc" id="L25492" title="All 4 branches missed.">                    } else if ((loc == Jumpship.LOC_ARS)</span>
                               || (loc == Jumpship.LOC_FRS)) {
<span class="nc" id="L25494">                        loc = Warship.LOC_RBS;</span>
                    }
                }
            case Aero.CRIT_WEAPON:
<span class="nc bnc" id="L25498" title="All 2 branches missed.">                if (aero.isCapitalFighter()) {</span>
<span class="nc" id="L25499">                    boolean destroyAll = false;</span>
                    // CRIT_WEAPON damages the capital fighter/squadron's weapon groups
                    // Go ahead and map damage for the fighter's weapon criticals for MHQ
                    // resolution.
<span class="nc" id="L25503">                    aero.damageCapFighterWeapons(loc);</span>
<span class="nc bnc" id="L25504" title="All 4 branches missed.">                    if ((loc == Aero.LOC_NOSE) || (loc == Aero.LOC_AFT)) {</span>
<span class="nc" id="L25505">                        destroyAll = true;</span>
                    }
                    
                    // Convert L/R wing location to wings, else wing weapons never get hit
<span class="nc bnc" id="L25509" title="All 4 branches missed.">                    if (loc == Aero.LOC_LWING || loc == Aero.LOC_RWING) {</span>
<span class="nc" id="L25510">                        loc = Aero.LOC_WINGS;</span>
                    }
                    
<span class="nc bnc" id="L25513" title="All 2 branches missed.">                    if (loc == Aero.LOC_WINGS) {</span>
<span class="nc bnc" id="L25514" title="All 2 branches missed.">                        if (aero.areWingsHit()) {</span>
<span class="nc" id="L25515">                            destroyAll = true;</span>
                        } else {
<span class="nc" id="L25517">                            aero.setWingsHit(true);</span>
                        }
                    }
<span class="nc bnc" id="L25520" title="All 2 branches missed.">                    for (Mounted weapon : aero.getWeaponList()) {</span>
<span class="nc bnc" id="L25521" title="All 2 branches missed.">                        if (weapon.getLocation() == loc) {</span>
<span class="nc bnc" id="L25522" title="All 2 branches missed.">                            if (destroyAll) {</span>
<span class="nc" id="L25523">                                weapon.setHit(true);</span>
                            } else {
<span class="nc" id="L25525">                                weapon.setNWeapons(weapon.getNWeapons() / 2);</span>
                            }
                        }
<span class="nc" id="L25528">                    }</span>
                    // also destroy any ECM or BAP in the location hit
<span class="nc bnc" id="L25530" title="All 2 branches missed.">                    for (Mounted misc : aero.getMisc()) {</span>
<span class="nc bnc" id="L25531" title="All 2 branches missed.">                        if ((misc.getType().hasFlag(MiscType.F_ECM)</span>
<span class="nc bnc" id="L25532" title="All 2 branches missed.">                            || misc.getType().hasFlag(MiscType.F_ANGEL_ECM)</span>
<span class="nc bnc" id="L25533" title="All 2 branches missed.">                            || misc.getType().hasFlag(MiscType.F_BAP))</span>
<span class="nc bnc" id="L25534" title="All 2 branches missed.">                                &amp;&amp; misc.getLocation() == loc) {</span>
<span class="nc" id="L25535">                            misc.setHit(true);</span>
                            //Taharqa: We should also damage the critical slot, or
                            //MM and MHQ won't remember that this weapon is damaged on the MUL
                            //file
<span class="nc bnc" id="L25539" title="All 2 branches missed.">                            for (int i = 0; i &lt; aero.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L25540">                                CriticalSlot slot1 = aero.getCritical(loc, i);</span>
<span class="nc bnc" id="L25541" title="All 2 branches missed.">                                if ((slot1 == null) ||</span>
<span class="nc bnc" id="L25542" title="All 2 branches missed.">                                        (slot1.getType() == CriticalSlot.TYPE_SYSTEM)) {</span>
<span class="nc" id="L25543">                                    continue;</span>
                                }
<span class="nc" id="L25545">                                Mounted mounted = slot1.getMount();</span>
<span class="nc bnc" id="L25546" title="All 2 branches missed.">                                if (mounted.equals(misc)) {</span>
<span class="nc" id="L25547">                                    aero.hitAllCriticals(loc, i);</span>
<span class="nc" id="L25548">                                    break;</span>
                                }
                            }
                        }
<span class="nc" id="L25552">                    }</span>
<span class="nc" id="L25553">                    r = new Report(9152);</span>
<span class="nc" id="L25554">                    r.subject = aero.getId();</span>
<span class="nc" id="L25555">                    r.add(aero.getLocationName(loc));</span>
<span class="nc" id="L25556">                    reports.add(r);</span>
<span class="nc" id="L25557">                    break;</span>
                }
<span class="nc" id="L25559">                r = new Report(9150);</span>
<span class="nc" id="L25560">                r.subject = aero.getId();</span>
<span class="nc" id="L25561">                List&lt;Mounted&gt; weapons = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L25562" title="All 2 branches missed.">                for (Mounted weapon : aero.getWeaponList()) {</span>
<span class="nc bnc" id="L25563" title="All 4 branches missed.">                    if ((weapon.getLocation() == loc) &amp;&amp; !weapon.isDestroyed()</span>
<span class="nc bnc" id="L25564" title="All 2 branches missed.">                            &amp;&amp; weapon.getType().isHittable()) {</span>
<span class="nc" id="L25565">                        weapons.add(weapon);</span>
                    }
<span class="nc" id="L25567">                }</span>
                // add in in hittable misc equipment
<span class="nc bnc" id="L25569" title="All 2 branches missed.">                for (Mounted misc : aero.getMisc()) {</span>
<span class="nc bnc" id="L25570" title="All 2 branches missed.">                    if (misc.getType().isHittable()</span>
<span class="nc bnc" id="L25571" title="All 2 branches missed.">                        &amp;&amp; (misc.getLocation() == loc)</span>
<span class="nc bnc" id="L25572" title="All 2 branches missed.">                        &amp;&amp; !misc.isDestroyed()) {</span>
<span class="nc" id="L25573">                        weapons.add(misc);</span>
                    }
<span class="nc" id="L25575">                }</span>
<span class="nc bnc" id="L25576" title="All 2 branches missed.">                if (weapons.size() &gt; 0) {</span>
<span class="nc" id="L25577">                    Mounted weapon = weapons.get(Compute.randomInt(weapons.size()));</span>
                    // possibly check for an ammo explosion
                    // don't allow ammo explosions on fighter squadrons
<span class="nc bnc" id="L25580" title="All 4 branches missed.">                    if (game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_AMMO_EXPLOSIONS)</span>
                        &amp;&amp; !(aero instanceof FighterSquadron)
<span class="nc bnc" id="L25582" title="All 2 branches missed.">                        &amp;&amp; (weapon.getType() instanceof WeaponType)) {</span>
                        //Bay Weapons
<span class="nc bnc" id="L25584" title="All 2 branches missed.">                        if (aero.usesWeaponBays()) {</span>
                            //Finish reporting(9150) a hit on the bay
<span class="nc" id="L25586">                            r.add(weapon.getName());</span>
<span class="nc" id="L25587">                            reports.add(r);</span>
                            //Pick a random weapon in the bay and get the stats
<span class="nc" id="L25589">                            int wId = weapon.getBayWeapons().get(Compute.randomInt(weapon.getBayWeapons().size()));</span>
<span class="nc" id="L25590">                            Mounted bayW = aero.getEquipment(wId);</span>
<span class="nc" id="L25591">                            Mounted bayWAmmo = bayW.getLinked();</span>
<span class="nc bnc" id="L25592" title="All 4 branches missed.">                            if (bayWAmmo != null &amp;&amp; bayWAmmo.getType().isExplosive(bayWAmmo)) {</span>
<span class="nc" id="L25593">                                r = new Report(9156);</span>
<span class="nc" id="L25594">                                r.subject = aero.getId();</span>
<span class="nc" id="L25595">                                r.newlines = 1;</span>
<span class="nc" id="L25596">                                r.indent(2);</span>
                                //On a roll of 10+, the ammo bin explodes
<span class="nc" id="L25598">                                int ammoRoll = Compute.d6(2);</span>
<span class="nc" id="L25599">                                boomTarget = 10;</span>
<span class="nc bnc" id="L25600" title="All 2 branches missed.">                                r.choose(ammoRoll &gt;= boomTarget);</span>
                                // A chance to reroll an explosion with edge
<span class="nc bnc" id="L25602" title="All 2 branches missed.">                                if (aero.getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L25603" title="All 4 branches missed.">                                        &amp;&amp; aero.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_EXPLOSION)</span>
                                        &amp;&amp; ammoRoll &gt;= boomTarget) {
                                    // Report 9156 doesn't offer the right choices. Replace it.
<span class="nc" id="L25606">                                    r = new Report(9158);</span>
<span class="nc" id="L25607">                                    r.subject = aero.getId();</span>
<span class="nc" id="L25608">                                    r.newlines = 0;</span>
<span class="nc" id="L25609">                                    r.indent(2);</span>
<span class="nc" id="L25610">                                    reports.add(r);</span>
<span class="nc" id="L25611">                                    aero.getCrew().decreaseEdge();</span>
<span class="nc" id="L25612">                                    ammoRoll = Compute.d6(2);</span>
                                    // To explode, or not to explode
<span class="nc bnc" id="L25614" title="All 2 branches missed.">                                    if (ammoRoll &gt;= boomTarget) {</span>
<span class="nc" id="L25615">                                        reports.addAll(explodeEquipment(aero, loc, bayWAmmo));</span>
                                    } else {
<span class="nc" id="L25617">                                        r = new Report(9157);</span>
<span class="nc" id="L25618">                                        r.subject = aero.getId();</span>
<span class="nc" id="L25619">                                        reports.add(r);</span>
                                    }
                                } else {
                                    //Finish handling report 9156
<span class="nc" id="L25623">                                    reports.add(r);</span>
<span class="nc bnc" id="L25624" title="All 2 branches missed.">                                    if (ammoRoll &gt;= boomTarget) {</span>
<span class="nc" id="L25625">                                        reports.addAll(explodeEquipment(aero, loc, bayWAmmo));</span>
                                    }
                                }
                            }
                            //Hit the weapon then also hit all the other weapons in the bay
<span class="nc" id="L25630">                            weapon.setHit(true);</span>
<span class="nc bnc" id="L25631" title="All 2 branches missed.">                            for(int next : weapon.getBayWeapons()) {</span>
<span class="nc" id="L25632">                                Mounted bayWeap = aero.getEquipment(next);</span>
<span class="nc bnc" id="L25633" title="All 2 branches missed.">                                if(null != bayWeap) {</span>
<span class="nc" id="L25634">                                    bayWeap.setHit(true);</span>
                                    //Taharqa: We should also damage the critical slot, or
                                    //MM and MHQ won't remember that this weapon is damaged on the MUL
                                    //file
<span class="nc bnc" id="L25638" title="All 2 branches missed.">                                    for (int i = 0; i &lt; aero.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L25639">                                        CriticalSlot slot1 = aero.getCritical(loc, i);</span>
<span class="nc bnc" id="L25640" title="All 2 branches missed.">                                        if ((slot1 == null) ||</span>
<span class="nc bnc" id="L25641" title="All 2 branches missed.">                                                (slot1.getType() == CriticalSlot.TYPE_SYSTEM)) {</span>
<span class="nc" id="L25642">                                            continue;</span>
                                        }
<span class="nc" id="L25644">                                        Mounted mounted = slot1.getMount();</span>
<span class="nc bnc" id="L25645" title="All 2 branches missed.">                                        if (mounted.equals(bayWeap)) {</span>
<span class="nc" id="L25646">                                            aero.hitAllCriticals(loc, i);</span>
<span class="nc" id="L25647">                                            break;</span>
                                        }
                                    }
                                }
<span class="nc" id="L25651">                            }</span>
<span class="nc" id="L25652">                            break;</span>
                        }
                        // does it use Ammo?
<span class="nc" id="L25655">                        WeaponType wtype = (WeaponType) weapon.getType();</span>
<span class="nc bnc" id="L25656" title="All 2 branches missed.">                        if (wtype.getAmmoType() != AmmoType.T_NA) {</span>
<span class="nc" id="L25657">                            Mounted m = weapon.getLinked();</span>
<span class="nc" id="L25658">                            int ammoroll = Compute.d6(2);</span>
<span class="nc bnc" id="L25659" title="All 2 branches missed.">                            if (ammoroll &gt;= 10) {</span>
                                // A chance to reroll an explosion with edge
<span class="nc bnc" id="L25661" title="All 2 branches missed.">                                if (aero.getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L25662" title="All 2 branches missed.">                                        &amp;&amp; aero.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_EXPLOSION)) {</span>
<span class="nc" id="L25663">                                    aero.getCrew().decreaseEdge();</span>
<span class="nc" id="L25664">                                    r = new Report(6530);</span>
<span class="nc" id="L25665">                                    r.subject = aero.getId();</span>
<span class="nc" id="L25666">                                    r.add(aero.getCrew().getOptions().intOption(OptionsConstants.EDGE));</span>
<span class="nc" id="L25667">                                    reports.add(r);</span>
<span class="nc" id="L25668">                                    ammoroll = Compute.d6(2);</span>
<span class="nc bnc" id="L25669" title="All 2 branches missed.">                                    if (ammoroll &gt;= 10) {</span>
<span class="nc" id="L25670">                                        reports.addAll(explodeEquipment(aero, loc, m));</span>
<span class="nc" id="L25671">                                        break;</span>
                                    } else {
                                        //Crisis averted, set report 9150 back up
<span class="nc" id="L25674">                                        r = new Report(9150);</span>
<span class="nc" id="L25675">                                        r.subject = aero.getId();</span>
                                    }
                                } else {
<span class="nc" id="L25678">                                    r = new Report(9151);</span>
<span class="nc" id="L25679">                                    r.subject = aero.getId();</span>
<span class="nc" id="L25680">                                    r.add(m.getName());</span>
<span class="nc" id="L25681">                                    r.newlines = 0;</span>
<span class="nc" id="L25682">                                    reports.add(r);</span>
<span class="nc" id="L25683">                                    reports.addAll(explodeEquipment(aero, loc, m));</span>
<span class="nc" id="L25684">                                    break;</span>
                                }
                            }
                        }
                    }
                    // If the weapon is explosive, use edge to roll up a new one
<span class="nc bnc" id="L25690" title="All 2 branches missed.">                    if (aero.getCrew().hasEdgeRemaining()</span>
<span class="nc bnc" id="L25691" title="All 2 branches missed.">                            &amp;&amp; aero.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_EXPLOSION)</span>
<span class="nc bnc" id="L25692" title="All 4 branches missed.">                            &amp;&amp; (weapon.getType().isExplosive(weapon) &amp;&amp; !weapon.isHit()</span>
<span class="nc bnc" id="L25693" title="All 2 branches missed.">                                    &amp;&amp; !weapon.isDestroyed())) {</span>
<span class="nc" id="L25694">                        aero.getCrew().decreaseEdge();</span>
                        //Try something new for an interrupting report. r is still 9150.
<span class="nc" id="L25696">                        Report r1 = new Report(6530);</span>
<span class="nc" id="L25697">                        r1.subject = aero.getId();</span>
<span class="nc" id="L25698">                        r1.add(aero.getCrew().getOptions().intOption(OptionsConstants.EDGE));</span>
<span class="nc" id="L25699">                        reports.add(r1);</span>
<span class="nc" id="L25700">                        weapon = weapons.get(Compute.randomInt(weapons.size()));</span>
                    }
<span class="nc" id="L25702">                    r.add(weapon.getName());</span>
<span class="nc" id="L25703">                    reports.add(r);</span>
                    // explosive weapons e.g. gauss now explode
<span class="nc bnc" id="L25705" title="All 4 branches missed.">                    if (weapon.getType().isExplosive(weapon) &amp;&amp; !weapon.isHit()</span>
<span class="nc bnc" id="L25706" title="All 2 branches missed.">                        &amp;&amp; !weapon.isDestroyed()) {</span>
<span class="nc" id="L25707">                        reports.addAll(explodeEquipment(aero, loc, weapon));</span>
                    }
<span class="nc" id="L25709">                    weapon.setHit(true);</span>
                    //Taharqa: We should also damage the critical slot, or
                    //MM and MHQ won't remember that this weapon is damaged on the MUL
                    //file
<span class="nc bnc" id="L25713" title="All 2 branches missed.">                    for (int i = 0; i &lt; aero.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L25714">                        CriticalSlot slot1 = aero.getCritical(loc, i);</span>
<span class="nc bnc" id="L25715" title="All 2 branches missed.">                        if ((slot1 == null) ||</span>
<span class="nc bnc" id="L25716" title="All 2 branches missed.">                                (slot1.getType() == CriticalSlot.TYPE_SYSTEM)) {</span>
<span class="nc" id="L25717">                            continue;</span>
                        }
<span class="nc" id="L25719">                        Mounted mounted = slot1.getMount();</span>
<span class="nc bnc" id="L25720" title="All 2 branches missed.">                        if (mounted.equals(weapon)) {</span>
<span class="nc" id="L25721">                            aero.hitAllCriticals(loc, i);</span>
<span class="nc" id="L25722">                            break;</span>
                        }
                    }
                    //if this is a weapons bay then also hit all the other weapons
<span class="nc bnc" id="L25726" title="All 2 branches missed.">                    for(int wId : weapon.getBayWeapons()) {</span>
<span class="nc" id="L25727">                        Mounted bayWeap = aero.getEquipment(wId);</span>
<span class="nc bnc" id="L25728" title="All 2 branches missed.">                        if(null != bayWeap) {</span>
<span class="nc" id="L25729">                            bayWeap.setHit(true);</span>
                            //Taharqa: We should also damage the critical slot, or
                            //MM and MHQ won't remember that this weapon is damaged on the MUL
                            //file
<span class="nc bnc" id="L25733" title="All 2 branches missed.">                            for (int i = 0; i &lt; aero.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L25734">                                CriticalSlot slot1 = aero.getCritical(loc, i);</span>
<span class="nc bnc" id="L25735" title="All 2 branches missed.">                                if ((slot1 == null) ||</span>
<span class="nc bnc" id="L25736" title="All 2 branches missed.">                                        (slot1.getType() == CriticalSlot.TYPE_SYSTEM)) {</span>
<span class="nc" id="L25737">                                    continue;</span>
                                }
<span class="nc" id="L25739">                                Mounted mounted = slot1.getMount();</span>
<span class="nc bnc" id="L25740" title="All 2 branches missed.">                                if (mounted.equals(bayWeap)) {</span>
<span class="nc" id="L25741">                                    aero.hitAllCriticals(loc, i);</span>
<span class="nc" id="L25742">                                    break;</span>
                                }
                            }
                        }
<span class="nc" id="L25746">                    }</span>
<span class="nc" id="L25747">                } else {</span>
<span class="nc" id="L25748">                    r = new Report(9155);</span>
<span class="nc" id="L25749">                    r.subject = aero.getId();</span>
<span class="nc" id="L25750">                    reports.add(r);</span>
                }
<span class="nc" id="L25752">                break;</span>
            case Aero.CRIT_ENGINE:
                // engine hit
<span class="nc" id="L25755">                r = new Report(9140);</span>
<span class="nc" id="L25756">                r.subject = aero.getId();</span>
<span class="nc" id="L25757">                reports.add(r);</span>
<span class="nc" id="L25758">                aero.engineHitsThisPhase++;</span>
<span class="nc" id="L25759">                boolean engineExploded = checkEngineExplosion(aero, reports, 1);</span>
<span class="nc" id="L25760">                aero.setEngineHits(aero.getEngineHits() + 1);</span>
<span class="nc bnc" id="L25761" title="All 4 branches missed.">                if ((aero.getEngineHits() &gt;= aero.getMaxEngineHits())</span>
                    || engineExploded) {
                    // this engine hit puts the ASF out of commission
<span class="nc" id="L25764">                    reports.addAll(destroyEntity(aero, &quot;engine destruction&quot;, true,</span>
                                               true));
<span class="nc" id="L25766">                    aero.setSelfDestructing(false);</span>
<span class="nc" id="L25767">                    aero.setSelfDestructInitiated(false);</span>
                }
                break;
            case Aero.CRIT_LEFT_THRUSTER:
                // thruster hit
<span class="nc" id="L25772">                r = new Report(9160);</span>
<span class="nc" id="L25773">                r.subject = aero.getId();</span>
<span class="nc" id="L25774">                reports.add(r);</span>
<span class="nc" id="L25775">                aero.setLeftThrustHits(aero.getLeftThrustHits() + 1);</span>
<span class="nc" id="L25776">                break;</span>
            case Aero.CRIT_RIGHT_THRUSTER:
                // thruster hit
<span class="nc" id="L25779">                r = new Report(9160);</span>
<span class="nc" id="L25780">                r.subject = aero.getId();</span>
<span class="nc" id="L25781">                reports.add(r);</span>
<span class="nc" id="L25782">                aero.setRightThrustHits(aero.getRightThrustHits() + 1);</span>
<span class="nc" id="L25783">                break;</span>
            case Aero.CRIT_CARGO:
<span class="nc" id="L25785">                applyCargoCritical(aero, damageCaused, reports);</span>
<span class="nc" id="L25786">                break;</span>
            case Aero.CRIT_DOOR:
                // door hit
                // choose a random bay
<span class="nc" id="L25790">                String bayType = aero.damageBayDoor();</span>
<span class="nc bnc" id="L25791" title="All 2 branches missed.">                if (!bayType.equals(&quot;none&quot;)) {</span>
<span class="nc" id="L25792">                    r = new Report(9170);</span>
<span class="nc" id="L25793">                    r.subject = aero.getId();</span>
<span class="nc" id="L25794">                    r.add(bayType);</span>
<span class="nc" id="L25795">                    reports.add(r);</span>
                } else {
<span class="nc" id="L25797">                    r = new Report(9171);</span>
<span class="nc" id="L25798">                    r.subject = aero.getId();</span>
<span class="nc" id="L25799">                    reports.add(r);</span>
                }
<span class="nc" id="L25801">                break;</span>
            case Aero.CRIT_DOCK_COLLAR:
                // docking collar hit
                // different effect for DropShips and JumpShips
<span class="nc bnc" id="L25805" title="All 2 branches missed.">                if (aero instanceof Dropship) {</span>
<span class="nc" id="L25806">                    ((Dropship)aero).setDamageDockCollar(true);</span>
<span class="nc" id="L25807">                    r = new Report(9175);</span>
<span class="nc" id="L25808">                    r.subject = aero.getId();</span>
<span class="nc" id="L25809">                    reports.add(r);</span>
                }
<span class="nc bnc" id="L25811" title="All 2 branches missed.">                if (aero instanceof Jumpship) {</span>
                    // damage a random docking collar
<span class="nc bnc" id="L25813" title="All 2 branches missed.">                    if (aero.damageDockCollar()) {</span>
<span class="nc" id="L25814">                        r = new Report(9176);</span>
<span class="nc" id="L25815">                        r.subject = aero.getId();</span>
<span class="nc" id="L25816">                        reports.add(r);</span>
                    } else {
<span class="nc" id="L25818">                        r = new Report(9177);</span>
<span class="nc" id="L25819">                        r.subject = aero.getId();</span>
<span class="nc" id="L25820">                        reports.add(r);</span>
                    }
                }
                break;
            case Aero.CRIT_KF_BOOM:
                // KF boom hit
                // no real effect yet
<span class="nc bnc" id="L25827" title="All 2 branches missed.">                if (aero instanceof Dropship) {</span>
<span class="nc" id="L25828">                    ((Dropship)aero).setDamageKFBoom(true);</span>
<span class="nc" id="L25829">                    r = new Report(9180);</span>
<span class="nc" id="L25830">                    r.subject = aero.getId();</span>
<span class="nc" id="L25831">                    reports.add(r);</span>
                }
                break;
            case Aero.CRIT_CIC:
<span class="nc bnc" id="L25835" title="All 2 branches missed.">                if (js == null) {</span>
<span class="nc" id="L25836">                    break;</span>
                }
                // CIC hit
<span class="nc" id="L25839">                r = new Report(9185);</span>
<span class="nc" id="L25840">                r.subject = aero.getId();</span>
<span class="nc" id="L25841">                reports.add(r);</span>
<span class="nc" id="L25842">                js.setCICHits(js.getCICHits() + 1);</span>
<span class="nc" id="L25843">                break;</span>
            case Aero.CRIT_KF_DRIVE:
                //Per SO construction rules, stations have no KF drive, therefore they can't take a hit to it...
<span class="nc bnc" id="L25846" title="All 4 branches missed.">                if (js == null || js instanceof SpaceStation) {</span>
<span class="nc" id="L25847">                    break;</span>
                }
                // KF Drive hit - damage the drive integrity
<span class="nc" id="L25850">                js.setKFIntegrity(Math.max(0, (js.getKFIntegrity() - 1)));</span>
<span class="nc bnc" id="L25851" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_EXPANDED_KF_DRIVE_DAMAGE)) {</span>
                    //Randomize the component struck - probabilities taken from the old BattleSpace record sheets
<span class="nc bnc" id="L25853" title="All 7 branches missed.">                    switch (Compute.d6(2)) {</span>
                    case 2:
                        //Drive Coil Hit
<span class="nc" id="L25856">                        r = new Report(9186);</span>
<span class="nc" id="L25857">                        r.subject = aero.getId();</span>
<span class="nc" id="L25858">                        reports.add(r);</span>
<span class="nc" id="L25859">                        js.setKFDriveCoilHit(true);</span>
<span class="nc" id="L25860">                        break;</span>
                    case 3:
                    case 11:
                        //Charging System Hit
<span class="nc" id="L25864">                        r = new Report(9187);</span>
<span class="nc" id="L25865">                        r.subject = aero.getId();</span>
<span class="nc" id="L25866">                        reports.add(r);</span>
<span class="nc" id="L25867">                        js.setKFChargingSystemHit(true);</span>
<span class="nc" id="L25868">                        break;</span>
                    case 5:
                        //Field Initiator Hit
<span class="nc" id="L25871">                        r = new Report(9190);</span>
<span class="nc" id="L25872">                        r.subject = aero.getId();</span>
<span class="nc" id="L25873">                        reports.add(r);</span>
<span class="nc" id="L25874">                        js.setKFFieldInitiatorHit(true);</span>
<span class="nc" id="L25875">                        break;</span>
                    case 4:
                    case 6:
                    case 7:
                    case 8:
                        //Helium Tank Hit
<span class="nc" id="L25881">                        r = new Report(9189);</span>
<span class="nc" id="L25882">                        r.subject = aero.getId();</span>
<span class="nc" id="L25883">                        reports.add(r);</span>
<span class="nc" id="L25884">                        js.setKFHeliumTankHit(true);</span>
<span class="nc" id="L25885">                        break;</span>
                    case 9:
                        //Drive Controller Hit
<span class="nc" id="L25888">                        r = new Report(9191);</span>
<span class="nc" id="L25889">                        r.subject = aero.getId();</span>
<span class="nc" id="L25890">                        reports.add(r);</span>
<span class="nc" id="L25891">                        js.setKFDriveControllerHit(true);</span>
<span class="nc" id="L25892">                        break;</span>
                    case 10:
                    case 12:
                        //LF Battery Hit - if you don't have one, treat as helium tank
<span class="nc bnc" id="L25896" title="All 2 branches missed.">                        if (js.hasLF()) {</span>
<span class="nc" id="L25897">                            r = new Report(9188);</span>
<span class="nc" id="L25898">                            r.subject = aero.getId();</span>
<span class="nc" id="L25899">                            reports.add(r);</span>
<span class="nc" id="L25900">                            js.setLFBatteryHit(true);</span>
                        } else {
<span class="nc" id="L25902">                            r = new Report(9189);</span>
<span class="nc" id="L25903">                            r.subject = aero.getId();</span>
<span class="nc" id="L25904">                            reports.add(r);</span>
<span class="nc" id="L25905">                            js.setKFHeliumTankHit(true);</span>
                        }
<span class="nc" id="L25907">                        break;</span>
                    }
                } else {
                    //Just report the standard KF hit, per SO rules
<span class="nc" id="L25911">                    r = new Report(9194);</span>
<span class="nc" id="L25912">                    r.subject = aero.getId();</span>
<span class="nc" id="L25913">                    reports.add(r);</span>
                }
<span class="nc" id="L25915">                break;</span>
            case Aero.CRIT_GRAV_DECK:
<span class="nc bnc" id="L25917" title="All 2 branches missed.">                if (js == null) {</span>
<span class="nc" id="L25918">                    break;</span>
                }
<span class="nc" id="L25920">                int choice = Compute.randomInt(js.getTotalGravDeck());</span>
                // Grav Deck hit
<span class="nc" id="L25922">                r = new Report(9195);</span>
<span class="nc" id="L25923">                r.subject = aero.getId();</span>
<span class="nc" id="L25924">                reports.add(r);</span>
<span class="nc" id="L25925">                js.setGravDeckDamageFlag(choice, 1);</span>
<span class="nc" id="L25926">                break;</span>
            case Aero.CRIT_LIFE_SUPPORT:
                // Life Support hit
<span class="nc" id="L25929">                aero.setLifeSupport(false);</span>
<span class="nc" id="L25930">                r = new Report(9196);</span>
<span class="nc" id="L25931">                r.subject = aero.getId();</span>
<span class="nc" id="L25932">                reports.add(r);</span>
                break;
        }
<span class="nc" id="L25935">        return reports;</span>
    }

    /**
     * Selects random undestroyed bay and applies damage, destroying loaded units where applicable.
     *
     * @param aero           The unit that received the cargo critical.
     * @param damageCaused   The amount of damage applied by the hit that resulted in the cargo critical.
     * @param reports        Used to return any report generated while applying the critical.
     */
    private void applyCargoCritical(Aero aero, int damageCaused, Vector&lt;Report&gt; reports) {
        Report r;
        // cargo hit
        // First what percentage of the cargo did the hit destroy?
<span class="nc" id="L25949">        double percentDestroyed = 0.0;</span>
<span class="nc" id="L25950">        double mult = 2.0;</span>
<span class="nc bnc" id="L25951" title="All 4 branches missed.">        if (aero.isLargeCraft() &amp;&amp; aero.isClan()</span>
<span class="nc bnc" id="L25952" title="All 2 branches missed.">            &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_HARJEL)) {</span>
<span class="nc" id="L25953">            mult = 4.0;</span>
        }
<span class="nc bnc" id="L25955" title="All 2 branches missed.">        if (damageCaused &gt; 0) {</span>
<span class="nc" id="L25956">            percentDestroyed = Math.min(</span>
<span class="nc" id="L25957">                    damageCaused / (mult * aero.getSI()), 1.0);</span>
        }
        List&lt;Bay&gt; bays;
<span class="nc" id="L25960">        double destroyed = 0;</span>
        // did it hit cargo or units
<span class="nc" id="L25962">        int roll = Compute.d6(1);</span>
        // A hit on a bay filled with transported units is devastating
        // allow a reroll with edge
<span class="nc bnc" id="L25965" title="All 2 branches missed.">        if (aero.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_UNIT_CARGO_LOST)</span>
<span class="nc bnc" id="L25966" title="All 4 branches missed.">                &amp;&amp; aero.getCrew().hasEdgeRemaining() &amp;&amp; roll &gt; 3) {</span>
<span class="nc" id="L25967">            aero.getCrew().decreaseEdge();</span>
<span class="nc" id="L25968">            r = new Report(9172);</span>
<span class="nc" id="L25969">            r.subject = aero.getId();</span>
<span class="nc" id="L25970">            r.add(aero.getCrew().getOptions().intOption(OptionsConstants.EDGE));</span>
<span class="nc" id="L25971">            reports.add(r);</span>
            //Reroll. Maybe we'll hit cargo.
<span class="nc" id="L25973">            roll = Compute.d6(1);</span>
        }
<span class="nc bnc" id="L25975" title="All 2 branches missed.">        if (roll &lt; 4) {</span>
<span class="nc" id="L25976">            bays = aero.getTransportBays().stream().filter(Bay::isCargo).collect(Collectors.toList());</span>
        } else {
<span class="nc" id="L25978">            bays = aero.getTransportBays().stream()</span>
<span class="nc bnc" id="L25979" title="All 4 branches missed.">                    .filter(b -&gt; !b.isCargo() &amp;&amp; !b.isQuarters()).collect(Collectors.toList());</span>
        }
<span class="nc" id="L25981">        Bay hitBay = null;</span>
<span class="nc bnc" id="L25982" title="All 4 branches missed.">        while ((null == hitBay) &amp;&amp; !bays.isEmpty()) {</span>
<span class="nc" id="L25983">            hitBay = bays.remove(Compute.randomInt(bays.size()));</span>
<span class="nc bnc" id="L25984" title="All 2 branches missed.">            if (hitBay.getBayDamage() &lt; hitBay.getCapacity()) {</span>
<span class="nc bnc" id="L25985" title="All 2 branches missed.">                if (hitBay.isCargo()) {</span>
<span class="nc" id="L25986">                    destroyed = (hitBay.getCapacity() * percentDestroyed * 2.0) / 2.0;</span>
                } else {
<span class="nc" id="L25988">                    destroyed = Math.ceil(hitBay.getCapacity() * percentDestroyed);</span>
                }
            } else {
<span class="nc" id="L25991">                hitBay = null;</span>
            }
        }
<span class="nc bnc" id="L25994" title="All 2 branches missed.">        if (null != hitBay) {</span>
<span class="nc" id="L25995">            destroyed = Math.min(destroyed, hitBay.getCapacity() - hitBay.getBayDamage());</span>
<span class="nc bnc" id="L25996" title="All 2 branches missed.">            if (hitBay.isCargo()) {</span>
<span class="nc" id="L25997">                r = new Report(9165);</span>
            } else {
<span class="nc" id="L25999">                r = new Report(9166);</span>
            }
<span class="nc" id="L26001">            r.subject = aero.getId();</span>
<span class="nc" id="L26002">            r.add(hitBay.getBayNumber());</span>
<span class="nc bnc" id="L26003" title="All 2 branches missed.">            if (destroyed == (int) destroyed) {</span>
<span class="nc" id="L26004">                r.add((int) destroyed);</span>
            } else {
<span class="nc" id="L26006">                r.add(String.valueOf(Math.ceil(destroyed * 2.0) / 2.0));</span>
            }
<span class="nc" id="L26008">            reports.add(r);</span>
<span class="nc bnc" id="L26009" title="All 2 branches missed.">            if (!hitBay.isCargo()) {</span>
<span class="nc" id="L26010">                List&lt;Entity&gt; units = new ArrayList&lt;&gt;(hitBay.getLoadedUnits());</span>
<span class="nc" id="L26011">                List&lt;Entity&gt; toRemove = new ArrayList&lt;&gt;();</span>
                //We're letting destroyed units stay in the bay now, but take them off the targets list
<span class="nc bnc" id="L26013" title="All 2 branches missed.">                for (Entity en : units) {</span>
<span class="nc bnc" id="L26014" title="All 4 branches missed.">                    if (en.isDestroyed() || en.isDoomed()) {</span>
<span class="nc" id="L26015">                        toRemove.add(en);</span>
                    }
<span class="nc" id="L26017">                }</span>
<span class="nc" id="L26018">                units.removeAll(toRemove);</span>
<span class="nc bnc" id="L26019" title="All 4 branches missed.">                while ((destroyed &gt; 0) &amp;&amp; !units.isEmpty()) {</span>
<span class="nc" id="L26020">                    Entity target = units.remove(Compute.randomInt(units.size()));</span>
<span class="nc" id="L26021">                    reports.addAll(destroyEntity(target, &quot;cargo damage&quot;,</span>
                            false, true));
<span class="nc" id="L26023">                    destroyed--;</span>
<span class="nc" id="L26024">                }</span>
<span class="nc" id="L26025">            }</span>
        } else {
<span class="nc" id="L26027">            r = new Report(9167);</span>
<span class="nc" id="L26028">            r.subject = aero.getId();</span>
<span class="nc bnc" id="L26029" title="All 2 branches missed.">            r.choose(roll &lt; 4); // cargo or transport</span>
<span class="nc" id="L26030">            reports.add(r);</span>
        }
<span class="nc" id="L26032">    }</span>

    /**
     * Apply a single critical hit to a vehicle.
     *
     * @param tank             the &lt;code&gt;Tank&lt;/code&gt; that is being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;.
     * @param loc              the &lt;code&gt;int&lt;/code&gt; location of critical hit. This value may
     *                         be &lt;code&gt;Entity.NONE&lt;/code&gt; for hits to &lt;code&gt;Tank&lt;/code&gt;s and
     *                         for hits to a &lt;code&gt;Protomech&lt;/code&gt; torso weapon.
     * @param cs               the &lt;code&gt;CriticalSlot&lt;/code&gt; being damaged. This value may
     *                         not be &lt;code&gt;null&lt;/code&gt;. The index of the slot should be the index
     *                         of the critical hit table.
     * @param damageCaused     the amount of damage causing this critical.
     */
    private Vector&lt;Report&gt; applyTankCritical(Tank tank, int loc, CriticalSlot cs, int damageCaused) {
<span class="nc" id="L26048">        Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
        Report r;
        HitData hit;
<span class="nc bnc" id="L26051" title="All 22 branches missed.">        switch (cs.getIndex()) {</span>
            case Tank.CRIT_NONE:
                // no effect
<span class="nc" id="L26054">                r = new Report(6005);</span>
<span class="nc" id="L26055">                r.subject = tank.getId();</span>
<span class="nc" id="L26056">                reports.add(r);</span>
<span class="nc" id="L26057">                break;</span>
            case Tank.CRIT_AMMO:
                // ammo explosion
<span class="nc" id="L26060">                r = new Report(6610);</span>
<span class="nc" id="L26061">                r.subject = tank.getId();</span>
<span class="nc" id="L26062">                reports.add(r);</span>
<span class="nc" id="L26063">                int damage = 0;</span>
<span class="nc bnc" id="L26064" title="All 2 branches missed.">                for (Mounted m : tank.getAmmo()) {</span>
                    // Don't include ammo of one-shot weapons.
<span class="nc bnc" id="L26066" title="All 2 branches missed.">                    if (m.getLocation() == Entity.LOC_NONE) {</span>
<span class="nc" id="L26067">                        continue;</span>
                    }
<span class="nc" id="L26069">                    m.setHit(true);</span>
<span class="nc" id="L26070">                    int tmp = m.getHittableShotsLeft()</span>
<span class="nc" id="L26071">                              * ((AmmoType) m.getType()).getDamagePerShot()</span>
<span class="nc" id="L26072">                              * ((AmmoType) m.getType()).getRackSize();</span>
<span class="nc" id="L26073">                    m.setShotsLeft(0);</span>
                    // non-explosive ammo can't explode
<span class="nc bnc" id="L26075" title="All 2 branches missed.">                    if (!m.getType().isExplosive(m)) {</span>
<span class="nc" id="L26076">                        continue;</span>
                    }
<span class="nc" id="L26078">                    damage += tmp;</span>
<span class="nc" id="L26079">                    r = new Report(6390);</span>
<span class="nc" id="L26080">                    r.subject = tank.getId();</span>
<span class="nc" id="L26081">                    r.add(m.getName());</span>
<span class="nc" id="L26082">                    r.add(tmp);</span>
<span class="nc" id="L26083">                    reports.add(r);</span>
<span class="nc" id="L26084">                }</span>
<span class="nc" id="L26085">                hit = new HitData(loc);</span>
<span class="nc" id="L26086">                reports.addAll(damageEntity(tank, hit, damage, true));</span>
<span class="nc" id="L26087">                break;</span>
            case Tank.CRIT_CARGO:
                // Cargo/infantry damage
<span class="nc" id="L26090">                r = new Report(6615);</span>
<span class="nc" id="L26091">                r.subject = tank.getId();</span>
<span class="nc" id="L26092">                reports.add(r);</span>
<span class="nc" id="L26093">                List&lt;Entity&gt; passengers = tank.getLoadedUnits();</span>
<span class="nc bnc" id="L26094" title="All 2 branches missed.">                if (passengers.size() &gt; 0) {</span>
<span class="nc" id="L26095">                    Entity target = passengers.get(Compute.randomInt(passengers.size()));</span>
<span class="nc" id="L26096">                    hit = target.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L26097">                    reports.addAll(damageEntity(target, hit, damageCaused));</span>
<span class="nc" id="L26098">                }</span>
                break;
            case Tank.CRIT_COMMANDER:
<span class="nc bnc" id="L26101" title="All 2 branches missed.">                if (tank.hasAbility(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L26102" title="All 2 branches missed.">                        || tank.hasAbility(OptionsConstants.MD_BVDNI)) {</span>
<span class="nc" id="L26103">                    r = new Report(6191);</span>
<span class="nc" id="L26104">                    r.subject = tank.getId();</span>
<span class="nc" id="L26105">                    reports.add(r);</span>
<span class="nc" id="L26106">                    reports.addAll(damageCrew(tank, 1));</span>
                } else {
<span class="nc bnc" id="L26108" title="All 2 branches missed.">                    if (tank.hasAbility(OptionsConstants.MD_PAIN_SHUNT)</span>
<span class="nc bnc" id="L26109" title="All 2 branches missed.">                        &amp;&amp; !tank.isCommanderHitPS()) {</span>
<span class="nc" id="L26110">                        r = new Report(6606);</span>
<span class="nc" id="L26111">                        r.subject = tank.getId();</span>
<span class="nc" id="L26112">                        reports.add(r);</span>
<span class="nc" id="L26113">                        tank.setCommanderHitPS(true);</span>
<span class="nc bnc" id="L26114" title="All 2 branches missed.">                    } else if (tank.hasWorkingMisc(MiscType.F_COMMAND_CONSOLE)</span>
<span class="nc bnc" id="L26115" title="All 2 branches missed.">                            &amp;&amp; !tank.isUsingConsoleCommander()) {</span>
<span class="nc" id="L26116">                        r = new Report(6607);</span>
<span class="nc" id="L26117">                        r.subject = tank.getId();</span>
<span class="nc" id="L26118">                        reports.add(r);</span>
<span class="nc" id="L26119">                        tank.setUsingConsoleCommander(true);</span>
                    } else {
<span class="nc" id="L26121">                        r = new Report(6605);</span>
<span class="nc" id="L26122">                        r.subject = tank.getId();</span>
<span class="nc" id="L26123">                        reports.add(r);</span>
<span class="nc" id="L26124">                        tank.setCommanderHit(true);</span>
                    }
                }
                // fall through here, because effects of crew stunned also
                // apply
            case Tank.CRIT_CREW_STUNNED:
<span class="nc bnc" id="L26130" title="All 2 branches missed.">                if (tank.hasAbility(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L26131" title="All 2 branches missed.">                        || tank.hasAbility(OptionsConstants.MD_BVDNI)) {</span>
<span class="nc" id="L26132">                    r = new Report(6191);</span>
<span class="nc" id="L26133">                    r.subject = tank.getId();</span>
<span class="nc" id="L26134">                    reports.add(r);</span>
<span class="nc" id="L26135">                    reports.addAll(damageCrew(tank, 1));</span>
                } else {
<span class="nc bnc" id="L26137" title="All 2 branches missed.">                    if (tank.hasAbility(OptionsConstants.MD_PAIN_SHUNT)</span>
<span class="nc bnc" id="L26138" title="All 2 branches missed.">                            || tank.hasAbility(OptionsConstants.MD_DERMAL_ARMOR)) {</span>
<span class="nc" id="L26139">                        r = new Report(6186);</span>
                    } else {
<span class="nc" id="L26141">                        tank.stunCrew();</span>
<span class="nc" id="L26142">                        r = new Report(6185);</span>
<span class="nc" id="L26143">                        r.add(tank.getStunnedTurns() - 1);</span>
                    }
<span class="nc" id="L26145">                    r.subject = tank.getId();</span>
<span class="nc" id="L26146">                    reports.add(r);</span>
                }
<span class="nc" id="L26148">                break;</span>
            case Tank.CRIT_DRIVER:
<span class="nc bnc" id="L26150" title="All 2 branches missed.">                if (tank.hasAbility(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L26151" title="All 2 branches missed.">                        || tank.hasAbility(OptionsConstants.MD_BVDNI)) {</span>
<span class="nc" id="L26152">                    r = new Report(6191);</span>
<span class="nc" id="L26153">                    r.subject = tank.getId();</span>
<span class="nc" id="L26154">                    reports.add(r);</span>
<span class="nc" id="L26155">                    reports.addAll(damageCrew(tank, 1));</span>
                } else {
<span class="nc bnc" id="L26157" title="All 2 branches missed.">                    if (tank.hasAbility(OptionsConstants.MD_PAIN_SHUNT)</span>
<span class="nc bnc" id="L26158" title="All 2 branches missed.">                        &amp;&amp; !tank.isDriverHitPS()) {</span>
<span class="nc" id="L26159">                        r = new Report(6601);</span>
<span class="nc" id="L26160">                        r.subject = tank.getId();</span>
<span class="nc" id="L26161">                        reports.add(r);</span>
<span class="nc" id="L26162">                        tank.setDriverHitPS(true);</span>
                    } else {
<span class="nc" id="L26164">                        r = new Report(6600);</span>
<span class="nc" id="L26165">                        r.subject = tank.getId();</span>
<span class="nc" id="L26166">                        reports.add(r);</span>
<span class="nc" id="L26167">                        tank.setDriverHit(true);</span>
                    }
                }
<span class="nc" id="L26170">                break;</span>
            case Tank.CRIT_CREW_KILLED:
<span class="nc bnc" id="L26172" title="All 2 branches missed.">                if (tank.hasAbility(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L26173" title="All 2 branches missed.">                        || tank.hasAbility(OptionsConstants.MD_BVDNI)) {</span>
<span class="nc" id="L26174">                    r = new Report(6191);</span>
<span class="nc" id="L26175">                    r.subject = tank.getId();</span>
<span class="nc" id="L26176">                    reports.add(r);</span>
<span class="nc" id="L26177">                    reports.addAll(damageCrew(tank, 1));</span>
                } else {
<span class="nc bnc" id="L26179" title="All 4 branches missed.">                    if (tank.hasAbility(OptionsConstants.MD_PAIN_SHUNT) &amp;&amp; !tank.isCrewHitPS()) {</span>
<span class="nc" id="L26180">                        r = new Report(6191);</span>
<span class="nc" id="L26181">                        r.subject = tank.getId();</span>
<span class="nc" id="L26182">                        reports.add(r);</span>
<span class="nc" id="L26183">                        tank.setCrewHitPS(true);</span>
                    } else {
<span class="nc" id="L26185">                        r = new Report(6190);</span>
<span class="nc" id="L26186">                        r.subject = tank.getId();</span>
<span class="nc" id="L26187">                        reports.add(r);</span>
<span class="nc" id="L26188">                        tank.getCrew().setDoomed(true);</span>
<span class="nc bnc" id="L26189" title="All 2 branches missed.">                        if (tank.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L26190">                            reports.addAll(crashVTOLorWiGE(tank));</span>
                        }
                    }
                }
                break;
            case Tank.CRIT_ENGINE:
<span class="nc" id="L26196">                r = new Report(6210);</span>
<span class="nc" id="L26197">                r.subject = tank.getId();</span>
<span class="nc" id="L26198">                reports.add(r);</span>
<span class="nc" id="L26199">                tank.engineHit();</span>
<span class="nc" id="L26200">                tank.engineHitsThisPhase++;</span>
<span class="nc" id="L26201">                boolean engineExploded = checkEngineExplosion(tank, reports, 1);</span>
<span class="nc bnc" id="L26202" title="All 2 branches missed.">                if (engineExploded) {</span>
<span class="nc" id="L26203">                    reports.addAll(destroyEntity(tank, &quot;engine destruction&quot;, true, true));</span>
<span class="nc" id="L26204">                    tank.setSelfDestructing(false);</span>
<span class="nc" id="L26205">                    tank.setSelfDestructInitiated(false);</span>
                }
<span class="nc bnc" id="L26207" title="All 2 branches missed.">                if (tank.isAirborneVTOLorWIGE()</span>
<span class="nc bnc" id="L26208" title="All 4 branches missed.">                    &amp;&amp; !(tank.isDestroyed() || tank.isDoomed())) {</span>
<span class="nc" id="L26209">                    tank.immobilize();</span>
<span class="nc" id="L26210">                    reports.addAll(forceLandVTOLorWiGE(tank));</span>
                }
                break;
            case Tank.CRIT_FUEL_TANK:
<span class="nc" id="L26214">                r = new Report(6215);</span>
<span class="nc" id="L26215">                r.subject = tank.getId();</span>
<span class="nc" id="L26216">                reports.add(r);</span>
<span class="nc" id="L26217">                reports.addAll(destroyEntity(tank, &quot;fuel explosion&quot;, false, false));</span>
<span class="nc" id="L26218">                break;</span>
            case Tank.CRIT_SENSOR:
<span class="nc" id="L26220">                r = new Report(6620);</span>
<span class="nc" id="L26221">                r.subject = tank.getId();</span>
<span class="nc" id="L26222">                reports.add(r);</span>
<span class="nc" id="L26223">                tank.setSensorHits(tank.getSensorHits() + 1);</span>
<span class="nc" id="L26224">                break;</span>
            case Tank.CRIT_STABILIZER:
<span class="nc" id="L26226">                r = new Report(6625);</span>
<span class="nc" id="L26227">                r.subject = tank.getId();</span>
<span class="nc" id="L26228">                reports.add(r);</span>
<span class="nc" id="L26229">                tank.setStabiliserHit(loc);</span>
<span class="nc" id="L26230">                break;</span>
            case Tank.CRIT_TURRET_DESTROYED:
<span class="nc" id="L26232">                r = new Report(6630);</span>
<span class="nc" id="L26233">                r.subject = tank.getId();</span>
<span class="nc" id="L26234">                reports.add(r);</span>
<span class="nc" id="L26235">                tank.destroyLocation(tank.getLocTurret());</span>
<span class="nc" id="L26236">                reports.addAll(destroyEntity(tank, &quot;turret blown off&quot;, true, true));</span>
<span class="nc" id="L26237">                break;</span>
            case Tank.CRIT_TURRET_JAM:
<span class="nc bnc" id="L26239" title="All 2 branches missed.">                if (tank.isTurretEverJammed(loc)) {</span>
<span class="nc" id="L26240">                    r = new Report(6640);</span>
<span class="nc" id="L26241">                    r.subject = tank.getId();</span>
<span class="nc" id="L26242">                    reports.add(r);</span>
<span class="nc" id="L26243">                    tank.lockTurret(loc);</span>
<span class="nc" id="L26244">                    break;</span>
                }
<span class="nc" id="L26246">                r = new Report(6635);</span>
<span class="nc" id="L26247">                r.subject = tank.getId();</span>
<span class="nc" id="L26248">                reports.add(r);</span>
<span class="nc" id="L26249">                tank.jamTurret(loc);</span>
<span class="nc" id="L26250">                break;</span>
            case Tank.CRIT_TURRET_LOCK:
<span class="nc" id="L26252">                r = new Report(6640);</span>
<span class="nc" id="L26253">                r.subject = tank.getId();</span>
<span class="nc" id="L26254">                reports.add(r);</span>
<span class="nc" id="L26255">                tank.lockTurret(loc);</span>
<span class="nc" id="L26256">                break;</span>
            case Tank.CRIT_WEAPON_DESTROYED: {
<span class="nc" id="L26258">                r = new Report(6305);</span>
<span class="nc" id="L26259">                r.subject = tank.getId();</span>
<span class="nc" id="L26260">                List&lt;Mounted&gt; weapons = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L26261" title="All 2 branches missed.">                for (Mounted weapon : tank.getWeaponList()) {</span>
<span class="nc bnc" id="L26262" title="All 6 branches missed.">                    if ((weapon.getLocation() == loc) &amp;&amp; !weapon.isHit() &amp;&amp; !weapon.isDestroyed()) {</span>
<span class="nc" id="L26263">                        weapons.add(weapon);</span>
                    }
<span class="nc" id="L26265">                }</span>
                // sort weapons by BV
<span class="nc" id="L26267">                weapons.sort(new WeaponComparatorBV());</span>
<span class="nc" id="L26268">                int roll = Compute.d6();</span>
                Mounted weapon;
<span class="nc bnc" id="L26270" title="All 2 branches missed.">                if (roll &lt; 4) {</span>
                    // defender should choose, we'll just use the lowest BV
                    // weapon
<span class="nc" id="L26273">                    weapon = weapons.get(weapons.size() - 1);</span>
                } else {
                    // attacker chooses, we'll use the highest BV weapon
<span class="nc" id="L26276">                    weapon = weapons.get(0);</span>
                }
<span class="nc" id="L26278">                r.add(weapon.getName());</span>
<span class="nc" id="L26279">                reports.add(r);</span>
                // explosive weapons e.g. gauss now explode
<span class="nc bnc" id="L26281" title="All 4 branches missed.">                if (weapon.getType().isExplosive(weapon) &amp;&amp; !weapon.isHit()</span>
<span class="nc bnc" id="L26282" title="All 2 branches missed.">                       &amp;&amp; !weapon.isDestroyed()) {</span>
<span class="nc" id="L26283">                    reports.addAll(explodeEquipment(tank, loc, weapon));</span>
                }
<span class="nc" id="L26285">                weapon.setHit(true);</span>
                //Taharqa: We should also damage the critical slot, or
                //MM and MHQ won't remember that this weapon is damaged on the MUL
                //file
<span class="nc bnc" id="L26289" title="All 2 branches missed.">                for (int i = 0; i &lt; tank.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L26290">                    CriticalSlot slot1 = tank.getCritical(loc, i);</span>
<span class="nc bnc" id="L26291" title="All 4 branches missed.">                    if ((slot1 == null) || (slot1.getType() == CriticalSlot.TYPE_SYSTEM)) {</span>
<span class="nc" id="L26292">                        continue;</span>
                    }
<span class="nc" id="L26294">                    Mounted mounted = slot1.getMount();</span>
<span class="nc bnc" id="L26295" title="All 2 branches missed.">                    if (mounted.equals(weapon)) {</span>
<span class="nc" id="L26296">                        tank.hitAllCriticals(loc, i);</span>
<span class="nc" id="L26297">                        break;</span>
                    }
                }
<span class="nc" id="L26300">                break;</span>
            }
            case Tank.CRIT_WEAPON_JAM: {
<span class="nc" id="L26303">                r = new Report(6645);</span>
<span class="nc" id="L26304">                r.subject = tank.getId();</span>
<span class="nc" id="L26305">                ArrayList&lt;Mounted&gt; weapons = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L26306" title="All 2 branches missed.">                for (Mounted weapon : tank.getWeaponList()) {</span>
<span class="nc bnc" id="L26307" title="All 4 branches missed.">                    if ((weapon.getLocation() == loc) &amp;&amp; !weapon.isJammed()</span>
<span class="nc bnc" id="L26308" title="All 4 branches missed.">                        &amp;&amp; !weapon.jammedThisPhase() &amp;&amp; !weapon.isHit()</span>
<span class="nc bnc" id="L26309" title="All 2 branches missed.">                        &amp;&amp; !weapon.isDestroyed()) {</span>
<span class="nc" id="L26310">                        weapons.add(weapon);</span>
                    }
<span class="nc" id="L26312">                }</span>
<span class="nc bnc" id="L26313" title="All 2 branches missed.">                if (weapons.size() &gt; 0) {</span>
<span class="nc" id="L26314">                    Mounted weapon = weapons.get(Compute.randomInt(weapons.size()));</span>
<span class="nc" id="L26315">                    weapon.setJammed(true);</span>
<span class="nc" id="L26316">                    tank.addJammedWeapon(weapon);</span>
<span class="nc" id="L26317">                    r.add(weapon.getName());</span>
<span class="nc" id="L26318">                    reports.add(r);</span>
<span class="nc" id="L26319">                }</span>
                break;
            }
            case VTOL.CRIT_PILOT:
<span class="nc" id="L26323">                r = new Report(6650);</span>
<span class="nc" id="L26324">                r.subject = tank.getId();</span>
<span class="nc" id="L26325">                reports.add(r);</span>
<span class="nc" id="L26326">                tank.setDriverHit(true);</span>
<span class="nc" id="L26327">                PilotingRollData psr = tank.getBasePilotingRoll();</span>
<span class="nc" id="L26328">                psr.addModifier(0, &quot;pilot injury&quot;);</span>
<span class="nc bnc" id="L26329" title="All 2 branches missed.">                if (!doSkillCheckInPlace(tank, psr)) {</span>
<span class="nc" id="L26330">                    r = new Report(6675);</span>
<span class="nc" id="L26331">                    r.subject = tank.getId();</span>
<span class="nc" id="L26332">                    r.addDesc(tank);</span>
<span class="nc" id="L26333">                    reports.add(r);</span>
<span class="nc" id="L26334">                    boolean crash = true;</span>
<span class="nc bnc" id="L26335" title="All 2 branches missed.">                    if (tank.canGoDown()) {</span>
<span class="nc" id="L26336">                        tank.setElevation(tank.getElevation() - 1);</span>
<span class="nc bnc" id="L26337" title="All 2 branches missed.">                        crash = !tank.canGoDown();</span>
                    }
<span class="nc bnc" id="L26339" title="All 2 branches missed.">                    if (crash) {</span>
<span class="nc" id="L26340">                        reports.addAll(crashVTOLorWiGE(tank));</span>
                    }
<span class="nc" id="L26342">                }</span>
                break;
            case VTOL.CRIT_COPILOT:
<span class="nc" id="L26345">                r = new Report(6655);</span>
<span class="nc" id="L26346">                r.subject = tank.getId();</span>
<span class="nc" id="L26347">                reports.add(r);</span>
<span class="nc" id="L26348">                tank.setCommanderHit(true);</span>
<span class="nc" id="L26349">                break;</span>
            case VTOL.CRIT_ROTOR_DAMAGE: {
                // Only resolve rotor crits if the rotor was actually still
                // there.
<span class="nc bnc" id="L26353" title="All 4 branches missed.">                if (!(tank.isLocationBad(VTOL.LOC_ROTOR) || tank.isLocationDoomed(VTOL.LOC_ROTOR))) {</span>
<span class="nc" id="L26354">                    r = new Report(6660);</span>
<span class="nc" id="L26355">                    r.subject = tank.getId();</span>
<span class="nc" id="L26356">                    reports.add(r);</span>
<span class="nc" id="L26357">                    tank.setMotiveDamage(tank.getMotiveDamage() + 1);</span>
<span class="nc bnc" id="L26358" title="All 2 branches missed.">                    if (tank.getMotiveDamage() &gt;= tank.getOriginalWalkMP()) {</span>
<span class="nc" id="L26359">                        tank.immobilize();</span>
<span class="nc bnc" id="L26360" title="All 2 branches missed.">                        if (tank.isAirborneVTOLorWIGE()</span>
                            // Don't bother with forcing a landing if
                            // we're already otherwise destroyed.
<span class="nc bnc" id="L26363" title="All 4 branches missed.">                            &amp;&amp; !(tank.isDestroyed() || tank.isDoomed())) {</span>
<span class="nc" id="L26364">                            reports.addAll(forceLandVTOLorWiGE(tank));</span>
                        }
                    }
                }
                break;
            }
            case VTOL.CRIT_ROTOR_DESTROYED:
                // Only resolve rotor crits if the rotor was actually still
                // there. Note that despite the name this critical hit does
                // not in itself physically destroy the rotor *location*
                // (which would simply kill the VTOL).
<span class="nc bnc" id="L26375" title="All 4 branches missed.">                if (!(tank.isLocationBad(VTOL.LOC_ROTOR) || tank.isLocationDoomed(VTOL.LOC_ROTOR))) {</span>
<span class="nc" id="L26376">                    r = new Report(6670);</span>
<span class="nc" id="L26377">                    r.subject = tank.getId();</span>
<span class="nc" id="L26378">                    reports.add(r);</span>
<span class="nc" id="L26379">                    tank.immobilize();</span>
<span class="nc" id="L26380">                    reports.addAll(crashVTOLorWiGE(tank, true));</span>
                }
                break;
            case VTOL.CRIT_FLIGHT_STABILIZER:
                // Only resolve rotor crits if the rotor was actually still
                // there.
<span class="nc bnc" id="L26386" title="All 4 branches missed.">                if (!(tank.isLocationBad(VTOL.LOC_ROTOR) || tank.isLocationDoomed(VTOL.LOC_ROTOR))) {</span>
<span class="nc" id="L26387">                    r = new Report(6665);</span>
<span class="nc" id="L26388">                    r.subject = tank.getId();</span>
<span class="nc" id="L26389">                    reports.add(r);</span>
<span class="nc" id="L26390">                    tank.setStabiliserHit(VTOL.LOC_ROTOR);</span>
                }
                break;
        }
<span class="nc" id="L26394">        return reports;</span>
    }

    /**
     * Rolls and resolves critical hits with a die roll modifier.
     */

    public Vector&lt;Report&gt; criticalEntity(Entity en, int loc, boolean isRear, int critMod, int damage) {
<span class="nc" id="L26402">        return criticalEntity(en, loc, isRear, critMod, true, false, damage);</span>
    }

    /**
     * Rolls and resolves critical hits with a die roll modifier.
     */

    public Vector&lt;Report&gt; criticalEntity(Entity en, int loc, boolean isRear, int critMod, int damage,
                                         boolean damagedByFire) {
<span class="nc" id="L26411">        return criticalEntity(en, loc, isRear, critMod, true, false, damage, damagedByFire);</span>
    }

    /**
     * Rolls one critical hit
     */
    public Vector&lt;Report&gt; oneCriticalEntity(Entity en, int loc, boolean isRear, int damage) {
<span class="nc" id="L26418">        return criticalEntity(en, loc, isRear, 0, false, false, damage);</span>
    }

    /**
     * Makes any roll required when an AirMech lands and resolve any damage or
     * skidding resulting from a failed roll. Updates final position and elevation.
     *
     * @param lam       the landing LAM
     * @param pos       the &lt;code&gt;Coords&lt;/code&gt; of the landing hex
     * @param elevation the elevation from which the landing is attempted (usually 1, but may be higher
     *                          if the unit is forced to land due to insufficient movement
     * @param distance  the distance the unit moved in the turn prior to landing
     */
    private Vector&lt;Report&gt; landAirMech(LandAirMech lam, Coords pos, int elevation, int distance) {
<span class="nc" id="L26432">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>

<span class="nc" id="L26434">        lam.setPosition(pos);</span>
<span class="nc" id="L26435">        IHex hex = game.getBoard().getHex(pos);</span>
<span class="nc bnc" id="L26436" title="All 2 branches missed.">        if (hex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L26437">            lam.setElevation(hex.terrainLevel(Terrains.BLDG_ELEV));</span>
        } else {
<span class="nc" id="L26439">            lam.setElevation(0);</span>
        }
<span class="nc" id="L26441">        PilotingRollData psr = lam.checkAirMechLanding();</span>
<span class="nc bnc" id="L26442" title="All 2 branches missed.">        if (psr.getValue() != TargetRoll.CHECK_FALSE</span>
<span class="nc bnc" id="L26443" title="All 2 branches missed.">                &amp;&amp; (0 &gt; doSkillCheckWhileMoving(lam, elevation, pos, pos, psr, false))) {</span>
<span class="nc" id="L26444">            crashAirMech(lam, pos, elevation, distance, psr, vDesc);</span>
        }
<span class="nc" id="L26446">        return vDesc;</span>
    }

    private boolean crashAirMech(Entity en, PilotingRollData psr, Vector&lt;Report&gt; vDesc) {
<span class="nc" id="L26450">        return crashAirMech(en, en.getPosition(), en.getElevation(), en.delta_distance, psr, vDesc);</span>
    }

    private boolean crashAirMech(Entity en, Coords pos, int elevation, int distance,
                                 PilotingRollData psr, Vector&lt;Report&gt; vDesc) {
<span class="nc" id="L26455">        MoveStep step = new MoveStep(null, MoveStepType.DOWN);</span>
<span class="nc" id="L26456">        step.setFromEntity(en, game);</span>
<span class="nc" id="L26457">        return crashAirMech(en, pos, elevation, distance, psr, step, vDesc);</span>
    }

    private boolean crashAirMech(Entity en, Coords pos, int elevation, int distance,
                                 PilotingRollData psr, MoveStep lastStep, Vector&lt;Report&gt; vDesc) {
<span class="nc" id="L26462">        vDesc.addAll(doEntityFallsInto(en, elevation, pos, pos, psr, true, 0));</span>
<span class="nc bnc" id="L26463" title="All 2 branches missed.">        return en.isDoomed()</span>
<span class="nc bnc" id="L26464" title="All 2 branches missed.">                || processSkid(en, pos, 0, 0, distance, lastStep, en.moved, false);</span>
    }

    /**
     * Makes the landing roll required for a glider ProtoMech and resolves any damage
     * resulting from a failed roll. Updates final position and elevation.
     *
     * @param en    the landing glider ProtoMech
     */
    private Vector&lt;Report&gt; landGliderPM(Protomech en) {
<span class="nc" id="L26474">        return landGliderPM(en, en.getPosition(), en.getElevation(), en.delta_distance);</span>
    }

    /**
     * Makes the landing roll required for a glider ProtoMech and resolves any damage
     * resulting from a failed roll. Updates final position and elevation.
     *
     * @param en    the landing glider ProtoMech
     * @param pos   the &lt;code&gt;Coords&lt;/code&gt; of the landing hex
     * @param startElevation    the elevation from which the landing is attempted (usually 1, but may be higher
     *                          if the unit is forced to land due to insufficient movement
     * @param distance  the distance the unit moved in the turn prior to landing
     */
    private Vector&lt;Report&gt; landGliderPM(Protomech en, Coords pos, int startElevation,
                                        int distance) {
<span class="nc" id="L26489">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>

<span class="nc" id="L26491">        en.setPosition(pos);</span>
<span class="nc" id="L26492">        IHex hex = game.getBoard().getHex(pos);</span>
<span class="nc bnc" id="L26493" title="All 2 branches missed.">        if (hex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L26494">            en.setElevation(hex.terrainLevel(Terrains.BLDG_ELEV));</span>
        } else {
<span class="nc" id="L26496">            en.setElevation(0);</span>
        }
<span class="nc" id="L26498">        PilotingRollData psr = en.checkGliderLanding();</span>
<span class="nc bnc" id="L26499" title="All 2 branches missed.">        if ((psr.getValue() != TargetRoll.CHECK_FALSE)</span>
<span class="nc bnc" id="L26500" title="All 2 branches missed.">                &amp;&amp; (0 &gt; doSkillCheckWhileMoving(en, startElevation, pos, pos, psr, false))) {</span>
<span class="nc bnc" id="L26501" title="All 2 branches missed.">            for (int i = 0; i &lt; en.getNumberOfCriticals(Protomech.LOC_LEG); i++) {</span>
<span class="nc" id="L26502">                en.getCritical(Protomech.LOC_LEG, i).setHit(true);</span>
            }
<span class="nc" id="L26504">            HitData hit = new HitData(Protomech.LOC_LEG);</span>
<span class="nc" id="L26505">            vDesc.addAll(damageEntity(en, hit, 2 * startElevation));</span>
        }
<span class="nc" id="L26507">        return vDesc;</span>
    }

    /**
     * Resolves the forced landing of one airborne {@code VTOL} or {@code WiGE}
     * in its current hex. As this method is only for internal use and not part
     * of the exported public API, it simply relies on its client code to only
     * ever hand it a valid airborne vehicle and does not run any further checks
     * of its own.
     *
     * @param en The {@code VTOL} or {@code WiGE} in question.
     * @return The resulting {@code Vector} of {@code Report}s.
     */
    private Vector&lt;Report&gt; forceLandVTOLorWiGE(Tank en) {
<span class="nc" id="L26521">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
<span class="nc" id="L26522">        PilotingRollData psr = en.getBasePilotingRoll();</span>
<span class="nc" id="L26523">        IHex hex = game.getBoard().getHex(en.getPosition());</span>
<span class="nc bnc" id="L26524" title="All 2 branches missed.">        if (en instanceof VTOL) {</span>
<span class="nc" id="L26525">            psr.addModifier(4, &quot;VTOL making forced landing&quot;);</span>
        } else {
<span class="nc" id="L26527">            psr.addModifier(0, &quot;WiGE making forced landing&quot;);</span>
        }
<span class="nc" id="L26529">        int elevation = Math.max(hex.terrainLevel(Terrains.BLDG_ELEV),</span>
<span class="nc" id="L26530">                                 hex.terrainLevel(Terrains.BRIDGE_ELEV));</span>
<span class="nc" id="L26531">        elevation = Math.max(elevation, 0);</span>
<span class="nc" id="L26532">        elevation = Math.min(elevation, en.getElevation());</span>
<span class="nc bnc" id="L26533" title="All 2 branches missed.">        if (en.getElevation() &gt; elevation) {</span>
<span class="nc bnc" id="L26534" title="All 2 branches missed.">            if (!hex.containsTerrain(Terrains.FUEL_TANK)</span>
<span class="nc bnc" id="L26535" title="All 2 branches missed.">                    &amp;&amp; !hex.containsTerrain(Terrains.JUNGLE)</span>
<span class="nc bnc" id="L26536" title="All 2 branches missed.">                    &amp;&amp; !hex.containsTerrain(Terrains.MAGMA)</span>
<span class="nc bnc" id="L26537" title="All 2 branches missed.">                    &amp;&amp; !hex.containsTerrain(Terrains.MUD)</span>
<span class="nc bnc" id="L26538" title="All 2 branches missed.">                    &amp;&amp; !hex.containsTerrain(Terrains.RUBBLE)</span>
<span class="nc bnc" id="L26539" title="All 2 branches missed.">                    &amp;&amp; !hex.containsTerrain(Terrains.WATER)</span>
<span class="nc bnc" id="L26540" title="All 2 branches missed.">                    &amp;&amp; !hex.containsTerrain(Terrains.WOODS)) {</span>
<span class="nc" id="L26541">                Report r = new Report(2180);</span>
<span class="nc" id="L26542">                r.subject = en.getId();</span>
<span class="nc" id="L26543">                r.addDesc(en);</span>
<span class="nc" id="L26544">                r.add(psr.getLastPlainDesc(), true);</span>
<span class="nc" id="L26545">                vDesc.add(r);</span>

                // roll
<span class="nc" id="L26548">                final int diceRoll = Compute.d6(2);</span>
<span class="nc" id="L26549">                r = new Report(2185);</span>
<span class="nc" id="L26550">                r.subject = en.getId();</span>
<span class="nc" id="L26551">                r.add(psr.getValueAsString());</span>
<span class="nc" id="L26552">                r.add(psr.getDesc());</span>
<span class="nc" id="L26553">                r.add(diceRoll);</span>
<span class="nc bnc" id="L26554" title="All 2 branches missed.">                if (diceRoll &lt; psr.getValue()) {</span>
<span class="nc" id="L26555">                    r.choose(false);</span>
<span class="nc" id="L26556">                    vDesc.add(r);</span>
<span class="nc" id="L26557">                    vDesc.addAll(crashVTOLorWiGE(en, true));</span>
                } else {
<span class="nc" id="L26559">                    r.choose(true);</span>
<span class="nc" id="L26560">                    vDesc.add(r);</span>
<span class="nc" id="L26561">                    en.setElevation(elevation);</span>
                }
<span class="nc" id="L26563">            } else {</span>
<span class="nc" id="L26564">                vDesc.addAll(crashVTOLorWiGE(en, true));</span>
            }
        }
<span class="nc" id="L26567">        return vDesc;</span>
    }

    /**
     * Crash a VTOL
     *
     * @param en the &lt;code&gt;VTOL&lt;/code&gt; to be crashed
     * @return the &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt; containing phase reports
     */
    private Vector&lt;Report&gt; crashVTOLorWiGE(Tank en) {
<span class="nc" id="L26577">        return crashVTOLorWiGE(en, false, false, 0, en.getPosition(),</span>
<span class="nc" id="L26578">                               en.getElevation(), 0);</span>
    }

    /**
     * Crash a VTOL or WiGE.
     *
     * @param en              The {@code VTOL} or {@code WiGE} to crash.
     * @param rerollRotorHits Whether any rotor hits from the crash should be rerolled,
     *                        typically after a &quot;rotor destroyed&quot; critical hit.
     * @return The {@code Vector&lt;Report&gt;} of resulting reports.
     */
    private Vector&lt;Report&gt; crashVTOLorWiGE(Tank en, boolean rerollRotorHits) {
<span class="nc" id="L26590">        return crashVTOLorWiGE(en, rerollRotorHits, false, 0, en.getPosition(),</span>
<span class="nc" id="L26591">                               en.getElevation(), 0);</span>
    }

    /**
     * Crash a VTOL or WiGE.
     *
     * @param en              The {@code VTOL} or {@code WiGE} to crash.
     * @param rerollRotorHits Whether any rotor hits from the crash should be rerolled,
     *                        typically after a &quot;rotor destroyed&quot; critical hit.
     * @param sideSlipCrash   A &lt;code&gt;boolean&lt;/code&gt; value indicating whether this is a
     *                        sideslip crash or not.
     * @param hexesMoved      The &lt;code&gt;int&lt;/code&gt; number of hexes moved.
     * @param crashPos        The &lt;code&gt;Coords&lt;/code&gt; of the crash
     * @param crashElevation  The &lt;code&gt;int&lt;/code&gt; elevation of the VTOL
     * @param impactSide      The &lt;code&gt;int&lt;/code&gt; describing the side on which the VTOL
     *                        falls
     * @return a &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt; of Reports.
     */

    private Vector&lt;Report&gt; crashVTOLorWiGE(Tank en, boolean rerollRotorHits,
                                           boolean sideSlipCrash, int hexesMoved, Coords crashPos,
                                           int crashElevation, int impactSide) {
<span class="nc" id="L26613">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

        // we might be off the board after a DFA, so return then
<span class="nc bnc" id="L26617" title="All 2 branches missed.">        if (!game.getBoard().contains(crashPos)) {</span>
<span class="nc" id="L26618">            return vDesc;</span>
        }

<span class="nc bnc" id="L26621" title="All 2 branches missed.">        if (!sideSlipCrash) {</span>
            // report lost movement and crashing
<span class="nc" id="L26623">            r = new Report(6260);</span>
<span class="nc" id="L26624">            r.subject = en.getId();</span>
<span class="nc" id="L26625">            r.newlines = 0;</span>
<span class="nc" id="L26626">            r.addDesc(en);</span>
<span class="nc" id="L26627">            vDesc.addElement(r);</span>
<span class="nc" id="L26628">            int newElevation = 0;</span>
<span class="nc" id="L26629">            IHex fallHex = game.getBoard().getHex(crashPos);</span>

            // May land on roof of building or bridge
<span class="nc bnc" id="L26632" title="All 2 branches missed.">            if (fallHex.containsTerrain(Terrains.BLDG_ELEV)) {</span>
<span class="nc" id="L26633">                newElevation = fallHex.terrainLevel(Terrains.BLDG_ELEV);</span>
<span class="nc bnc" id="L26634" title="All 2 branches missed.">            } else if (fallHex.containsTerrain(Terrains.BRIDGE_ELEV)) {</span>
<span class="nc" id="L26635">                newElevation = fallHex.terrainLevel(Terrains.BRIDGE_ELEV);</span>
<span class="nc bnc" id="L26636" title="All 2 branches missed.">                if (newElevation &gt; crashElevation) {</span>
<span class="nc" id="L26637">                    newElevation = 0; // vtol was under bridge already</span>
                }
            }

<span class="nc" id="L26641">            int fall = crashElevation - newElevation;</span>
<span class="nc bnc" id="L26642" title="All 2 branches missed.">            if (fall == 0) {</span>
                // already on ground, no harm done
<span class="nc" id="L26644">                r = new Report(6265);</span>
<span class="nc" id="L26645">                r.subject = en.getId();</span>
<span class="nc" id="L26646">                vDesc.addElement(r);</span>
<span class="nc" id="L26647">                return vDesc;</span>
            }
            // set elevation 1st to avoid multiple crashes
<span class="nc" id="L26650">            en.setElevation(newElevation);</span>

            // plummets to ground
<span class="nc" id="L26653">            r = new Report(6270);</span>
<span class="nc" id="L26654">            r.subject = en.getId();</span>
<span class="nc" id="L26655">            r.add(fall);</span>
<span class="nc" id="L26656">            vDesc.addElement(r);</span>

            // facing after fall
            String side;
            int table;
<span class="nc" id="L26661">            int facing = Compute.d6() - 1;</span>
<span class="nc bnc" id="L26662" title="All 4 branches missed.">            switch (facing) {</span>
                case 1:
                case 2:
<span class="nc" id="L26665">                    side = &quot;right side&quot;;</span>
<span class="nc" id="L26666">                    table = ToHitData.SIDE_RIGHT;</span>
<span class="nc" id="L26667">                    break;</span>
                case 3:
<span class="nc" id="L26669">                    side = &quot;rear&quot;;</span>
<span class="nc" id="L26670">                    table = ToHitData.SIDE_REAR;</span>
<span class="nc" id="L26671">                    break;</span>
                case 4:
                case 5:
<span class="nc" id="L26674">                    side = &quot;left side&quot;;</span>
<span class="nc" id="L26675">                    table = ToHitData.SIDE_LEFT;</span>
<span class="nc" id="L26676">                    break;</span>
                case 0:
                default:
<span class="nc" id="L26679">                    side = &quot;front&quot;;</span>
<span class="nc" id="L26680">                    table = ToHitData.SIDE_FRONT;</span>
            }

<span class="nc bnc" id="L26683" title="All 2 branches missed.">            if (newElevation &lt;= 0) {</span>
<span class="nc" id="L26684">                boolean waterFall = fallHex.containsTerrain(Terrains.WATER);</span>
<span class="nc bnc" id="L26685" title="All 4 branches missed.">                if (waterFall &amp;&amp; fallHex.containsTerrain(Terrains.ICE)) {</span>
<span class="nc" id="L26686">                    int roll = Compute.d6(1);</span>
<span class="nc" id="L26687">                    r = new Report(2119);</span>
<span class="nc" id="L26688">                    r.subject = en.getId();</span>
<span class="nc" id="L26689">                    r.addDesc(en);</span>
<span class="nc" id="L26690">                    r.add(roll);</span>
<span class="nc" id="L26691">                    r.subject = en.getId();</span>
<span class="nc" id="L26692">                    vDesc.add(r);</span>
<span class="nc bnc" id="L26693" title="All 2 branches missed.">                    if (roll &gt; 3) {</span>
<span class="nc" id="L26694">                        vDesc.addAll(resolveIceBroken(crashPos));</span>
                    } else {
<span class="nc" id="L26696">                        waterFall = false; // saved by ice</span>
                    }
                }
<span class="nc bnc" id="L26699" title="All 2 branches missed.">                if (waterFall) {</span>
                    // falls into water and is destroyed
<span class="nc" id="L26701">                    r = new Report(6275);</span>
<span class="nc" id="L26702">                    r.subject = en.getId();</span>
<span class="nc" id="L26703">                    vDesc.addElement(r);</span>
<span class="nc" id="L26704">                    vDesc.addAll(destroyEntity(en, &quot;Fell into water&quot;, false, false));</span>
                    // not sure, is this salvageable?
                }
            }

            // calculate damage for hitting the surface
<span class="nc" id="L26710">            int damage = (int) Math.round(en.getWeight() / 10.0) * (fall + 1);</span>

            // adjust damage for gravity
<span class="nc" id="L26713">            damage = Math.round(damage * game.getPlanetaryConditions().getGravity());</span>
            // report falling
<span class="nc" id="L26715">            r = new Report(6280);</span>
<span class="nc" id="L26716">            r.subject = en.getId();</span>
<span class="nc" id="L26717">            r.indent();</span>
<span class="nc" id="L26718">            r.addDesc(en);</span>
<span class="nc" id="L26719">            r.add(side);</span>
<span class="nc" id="L26720">            r.add(damage);</span>
            //r.newlines = 0;
<span class="nc" id="L26722">            vDesc.addElement(r);</span>

<span class="nc" id="L26724">            en.setFacing((en.getFacing() + (facing)) % 6);</span>

<span class="nc" id="L26726">            boolean exploded = false;</span>

            // standard damage loop
<span class="nc bnc" id="L26729" title="All 2 branches missed.">            while (damage &gt; 0) {</span>
<span class="nc" id="L26730">                int cluster = Math.min(5, damage);</span>
<span class="nc" id="L26731">                HitData hit = en.rollHitLocation(ToHitData.HIT_NORMAL, table);</span>
<span class="nc bnc" id="L26732" title="All 6 branches missed.">                if ((en instanceof VTOL) &amp;&amp; (hit.getLocation() == VTOL.LOC_ROTOR) &amp;&amp; rerollRotorHits) {</span>
<span class="nc" id="L26733">                    continue;</span>
                }
<span class="nc" id="L26735">                hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L26736">                int[] isBefore = {en.getInternal(Tank.LOC_FRONT), en.getInternal(Tank.LOC_RIGHT),</span>
<span class="nc" id="L26737">                                  en.getInternal(Tank.LOC_LEFT), en.getInternal(Tank.LOC_REAR)};</span>
<span class="nc" id="L26738">                vDesc.addAll(damageEntity(en, hit, cluster));</span>
<span class="nc" id="L26739">                int[] isAfter = {en.getInternal(Tank.LOC_FRONT), en.getInternal(Tank.LOC_RIGHT),</span>
<span class="nc" id="L26740">                                 en.getInternal(Tank.LOC_LEFT), en.getInternal(Tank.LOC_REAR)};</span>
<span class="nc bnc" id="L26741" title="All 2 branches missed.">                for (int x = 0; x &lt;= 3; x++) {</span>
<span class="nc bnc" id="L26742" title="All 2 branches missed.">                    if (isBefore[x] != isAfter[x]) {</span>
<span class="nc" id="L26743">                        exploded = true;</span>
<span class="nc" id="L26744">                        break;</span>
                    }
                }
<span class="nc" id="L26747">                damage -= cluster;</span>
<span class="nc" id="L26748">            }</span>
<span class="nc bnc" id="L26749" title="All 2 branches missed.">            if (exploded) {</span>
<span class="nc" id="L26750">                r = new Report(6285);</span>
<span class="nc" id="L26751">                r.subject = en.getId();</span>
<span class="nc" id="L26752">                r.addDesc(en);</span>
<span class="nc" id="L26753">                vDesc.addElement(r);</span>
<span class="nc" id="L26754">                vDesc.addAll(explodeVTOLorWiGE(en));</span>
            }

            // check for location exposure
<span class="nc" id="L26758">            vDesc.addAll(doSetLocationsExposure(en, fallHex, false, newElevation));</span>

<span class="nc" id="L26760">        } else {</span>
<span class="nc" id="L26761">            en.setElevation(0);// considered landed in the hex.</span>
            // crashes into ground thanks to sideslip
<span class="nc" id="L26763">            r = new Report(6290);</span>
<span class="nc" id="L26764">            r.subject = en.getId();</span>
<span class="nc" id="L26765">            r.addDesc(en);</span>
<span class="nc" id="L26766">            vDesc.addElement(r);</span>
<span class="nc" id="L26767">            int damage = (int) Math.round(en.getWeight() / 10.0) * (hexesMoved + 1);</span>
<span class="nc" id="L26768">            boolean exploded = false;</span>

            // standard damage loop
<span class="nc bnc" id="L26771" title="All 2 branches missed.">            while (damage &gt; 0) {</span>
<span class="nc" id="L26772">                int cluster = Math.min(5, damage);</span>
<span class="nc" id="L26773">                HitData hit = en.rollHitLocation(ToHitData.HIT_NORMAL, impactSide);</span>
<span class="nc" id="L26774">                hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L26775">                int[] isBefore = {en.getInternal(Tank.LOC_FRONT), en.getInternal(Tank.LOC_RIGHT),</span>
<span class="nc" id="L26776">                                  en.getInternal(Tank.LOC_LEFT), en.getInternal(Tank.LOC_REAR)};</span>
<span class="nc" id="L26777">                vDesc.addAll(damageEntity(en, hit, cluster));</span>
<span class="nc" id="L26778">                int[] isAfter = {en.getInternal(Tank.LOC_FRONT), en.getInternal(Tank.LOC_RIGHT),</span>
<span class="nc" id="L26779">                                 en.getInternal(Tank.LOC_LEFT), en.getInternal(Tank.LOC_REAR)};</span>
<span class="nc bnc" id="L26780" title="All 2 branches missed.">                for (int x = 0; x &lt;= 3; x++) {</span>
<span class="nc bnc" id="L26781" title="All 2 branches missed.">                    if (isBefore[x] != isAfter[x]) {</span>
<span class="nc" id="L26782">                        exploded = true;</span>
<span class="nc" id="L26783">                        break;</span>
                    }
                }
<span class="nc" id="L26786">                damage -= cluster;</span>
<span class="nc" id="L26787">            }</span>
<span class="nc bnc" id="L26788" title="All 2 branches missed.">            if (exploded) {</span>
<span class="nc" id="L26789">                r = new Report(6295);</span>
<span class="nc" id="L26790">                r.subject = en.getId();</span>
<span class="nc" id="L26791">                r.addDesc(en);</span>
<span class="nc" id="L26792">                vDesc.addElement(r);</span>
<span class="nc" id="L26793">                vDesc.addAll(explodeVTOLorWiGE(en));</span>
            }

        }

<span class="nc bnc" id="L26798" title="All 2 branches missed.">        if (game.containsMinefield(crashPos)) {</span>
            // may set off any minefields in the hex
<span class="nc" id="L26800">            enterMinefield(en, crashPos, 0, true, vDesc, 7);</span>
            // it may also clear any minefields that it detonated
<span class="nc" id="L26802">            clearDetonatedMines(crashPos, 5);</span>
<span class="nc" id="L26803">            resetMines();</span>
        }

<span class="nc" id="L26806">        return vDesc;</span>

    }

    /**
     * Explode a VTOL
     *
     * @param en The &lt;code&gt;VTOL&lt;/code&gt; to explode.
     * @return a &lt;code&gt;Vector&lt;/code&gt; of reports
     */
    private Vector&lt;Report&gt; explodeVTOLorWiGE(Tank en) {
<span class="nc" id="L26817">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

<span class="nc bnc" id="L26820" title="All 4 branches missed.">        if(en.hasEngine() &amp;&amp; en.getEngine().isFusion()) {</span>
            // fusion engine, no effect
<span class="nc" id="L26822">            r = new Report(6300);</span>
<span class="nc" id="L26823">            r.subject = en.getId();</span>
<span class="nc" id="L26824">            vDesc.addElement(r);</span>
        } else {
<span class="nc" id="L26826">            Coords pos = en.getPosition();</span>
<span class="nc" id="L26827">            IHex hex = game.getBoard().getHex(pos);</span>
<span class="nc bnc" id="L26828" title="All 4 branches missed.">            if (hex.containsTerrain(Terrains.WOODS) || hex.containsTerrain(Terrains.JUNGLE)) {</span>
<span class="nc" id="L26829">                ignite(pos, Terrains.FIRE_LVL_NORMAL, vDesc);</span>
            } else {
<span class="nc" id="L26831">                ignite(pos, Terrains.FIRE_LVL_INFERNO, vDesc);</span>
            }
<span class="nc" id="L26833">            vDesc.addAll(destroyEntity(en, &quot;crashed and burned&quot;, false, false));</span>
        }

<span class="nc" id="L26836">        return vDesc;</span>
    }

    /**
     * rolls and resolves one tank critical hit
     *
     * @param t       the &lt;code&gt;Tank&lt;/code&gt; to be critted
     * @param loc     the &lt;code&gt;int&lt;/code&gt; location of the Tank to be critted
     * @param critMod the &lt;code&gt;int&lt;/code&gt; modifier to the crit roll
     * @return a &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt; containing the phase reports
     */
    private Vector&lt;Report&gt; criticalTank(Tank t, int loc, int critMod, int damage, boolean damagedByFire) {
<span class="nc" id="L26848">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

        // roll the critical
<span class="nc" id="L26852">        r = new Report(6305);</span>
<span class="nc" id="L26853">        r.subject = t.getId();</span>
<span class="nc" id="L26854">        r.indent(3);</span>
<span class="nc" id="L26855">        r.add(t.getLocationAbbr(loc));</span>
<span class="nc" id="L26856">        r.newlines = 0;</span>
<span class="nc" id="L26857">        vDesc.add(r);</span>
<span class="nc" id="L26858">        int roll = Compute.d6(2);</span>
<span class="nc" id="L26859">        r = new Report(6310);</span>
<span class="nc" id="L26860">        r.subject = t.getId();</span>
<span class="nc" id="L26861">        String rollString = &quot;&quot;;</span>
<span class="nc bnc" id="L26862" title="All 2 branches missed.">        if (critMod != 0) {</span>
<span class="nc" id="L26863">            rollString = &quot;(&quot; + roll;</span>
<span class="nc bnc" id="L26864" title="All 2 branches missed.">            if (critMod &gt; 0) {</span>
<span class="nc" id="L26865">                rollString += &quot;+&quot;;</span>
            }
<span class="nc" id="L26867">            rollString += critMod + &quot;) = &quot;;</span>
<span class="nc" id="L26868">            roll += critMod;</span>
        }
<span class="nc" id="L26870">        rollString += roll;</span>
<span class="nc" id="L26871">        r.add(rollString);</span>
<span class="nc" id="L26872">        r.newlines = 0;</span>
<span class="nc" id="L26873">        vDesc.add(r);</span>

        // now look up on vehicle crits table
<span class="nc" id="L26876">        int critType = t.getCriticalEffect(roll, loc, damagedByFire);</span>
<span class="nc bnc" id="L26877" title="All 2 branches missed.">        if ((critType == Tank.CRIT_NONE)</span>
<span class="nc bnc" id="L26878" title="All 6 branches missed.">                &amp;&amp; game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_VEHICLES_THRESHOLD)</span>
                &amp;&amp; !((t instanceof VTOL) || (t instanceof GunEmplacement))
<span class="nc bnc" id="L26880" title="All 2 branches missed.">                &amp;&amp; !t.getOverThresh()) {</span>
<span class="nc" id="L26881">            r = new Report(6006);</span>
<span class="nc" id="L26882">            r.subject = t.getId();</span>
<span class="nc" id="L26883">            r.newlines = 0;</span>
<span class="nc" id="L26884">            vDesc.add(r);</span>
        }
<span class="nc" id="L26886">        vDesc.addAll(applyCriticalHit(t, loc, new CriticalSlot(0, critType),</span>
                                      true, damage, false));
<span class="nc bnc" id="L26888" title="All 6 branches missed.">        if ((critType != Tank.CRIT_NONE) &amp;&amp; t.hasEngine() &amp;&amp; !t.getEngine().isFusion()</span>
<span class="nc bnc" id="L26889" title="All 4 branches missed.">                &amp;&amp; t.hasQuirk(OptionsConstants.QUIRK_NEG_FRAGILE_FUEL) &amp;&amp; (Compute.d6(2) &gt; 9)) {</span>
            // BOOM!!
<span class="nc" id="L26891">            vDesc.addAll(applyCriticalHit(t, loc, new CriticalSlot(0,</span>
                    Tank.CRIT_FUEL_TANK), true, damage, false));
        }
<span class="nc" id="L26894">        return vDesc;</span>
    }

    /**
     * Checks for aero criticals
     *
     * @param vDesc         - report vector
     * @param a             - the entity being critted
     * @param hit           - the hitdata for the attack
     * @param damage_orig   - the original damage of the attack
     * @param critThresh    - did the attack go over the damage threshold
     * @param critSI        - did the attack damage SI
     * @param ammoExplosion - was the damage from an ammo explosion
     * @param nukeS2S       - was this a ship 2 ship nuke attack
     */
    private void checkAeroCrits(Vector&lt;Report&gt; vDesc, Aero a, HitData hit,
                                int damage_orig, boolean critThresh, boolean critSI,
                                boolean ammoExplosion, boolean nukeS2S) {

        Report r;

<span class="nc" id="L26915">        boolean isCapital = hit.isCapital();</span>
        // get any capital missile critical mods
<span class="nc" id="L26917">        int capitalMissile = hit.getCapMisCritMod();</span>

        // check for nuclear critical
<span class="nc bnc" id="L26920" title="All 2 branches missed.">        if (nukeS2S) {</span>
            // add a control roll
<span class="nc" id="L26922">            PilotingRollData nukePSR = new PilotingRollData(a.getId(), 4,</span>
                    &quot;Nuclear attack&quot;, false);
<span class="nc" id="L26924">            game.addControlRoll(nukePSR);</span>

<span class="nc" id="L26926">            Report.addNewline(vDesc);</span>
            // need some kind of report
<span class="nc" id="L26928">            int nukeroll = Compute.d6(2);</span>
<span class="nc" id="L26929">            r = new Report(9145);</span>
<span class="nc" id="L26930">            r.subject = a.getId();</span>
<span class="nc" id="L26931">            r.indent(3);</span>
<span class="nc" id="L26932">            r.add(capitalMissile);</span>
<span class="nc" id="L26933">            r.add(nukeroll);</span>
<span class="nc" id="L26934">            vDesc.add(r);</span>
<span class="nc bnc" id="L26935" title="All 2 branches missed.">            if (nukeroll &gt;= capitalMissile) {</span>
                // Allow a reroll with edge
<span class="nc bnc" id="L26937" title="All 2 branches missed.">                if (a.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_NUKE_CRIT)</span>
<span class="nc bnc" id="L26938" title="All 2 branches missed.">                        &amp;&amp; a.getCrew().hasEdgeRemaining()) {</span>
<span class="nc" id="L26939">                    a.getCrew().decreaseEdge();</span>
<span class="nc" id="L26940">                    r = new Report(9148);</span>
<span class="nc" id="L26941">                    r.subject = a.getId();</span>
<span class="nc" id="L26942">                    r.indent(3);</span>
<span class="nc" id="L26943">                    r.add(a.getCrew().getOptions().intOption(OptionsConstants.EDGE));</span>
<span class="nc" id="L26944">                    vDesc.add(r);</span>
                    // Reroll
<span class="nc" id="L26946">                    nukeroll = Compute.d6(2);</span>
                    // and report the new results
<span class="nc" id="L26948">                    r = new Report(9149);</span>
<span class="nc" id="L26949">                    r.subject = a.getId();</span>
<span class="nc" id="L26950">                    r.indent(3);</span>
<span class="nc" id="L26951">                    r.add(capitalMissile);</span>
<span class="nc" id="L26952">                    r.add(nukeroll);</span>
<span class="nc bnc" id="L26953" title="All 2 branches missed.">                    r.choose(nukeroll &gt;= capitalMissile);</span>
<span class="nc" id="L26954">                    vDesc.add(r);</span>
<span class="nc bnc" id="L26955" title="All 2 branches missed.">                    if (nukeroll &lt; capitalMissile) {</span>
                        // We might be vaporized by the damage itself, but no additional effect
<span class="nc" id="L26957">                        return;</span>
                    }
                }
<span class="nc" id="L26960">                a.setSI(a.getSI() - (damage_orig * 10));</span>
<span class="nc" id="L26961">                a.damageThisPhase += (damage_orig * 10);</span>
<span class="nc" id="L26962">                r = new Report(9146);</span>
<span class="nc" id="L26963">                r.subject = a.getId();</span>
<span class="nc" id="L26964">                r.add((damage_orig * 10));</span>
<span class="nc" id="L26965">                r.indent(4);</span>
<span class="nc" id="L26966">                r.add(Math.max(a.getSI(), 0));</span>
<span class="nc" id="L26967">                vDesc.addElement(r);</span>
<span class="nc bnc" id="L26968" title="All 2 branches missed.">                if (a.getSI() &lt;= 0) {</span>
                    //No auto-ejection chance here. Nuke would vaporize the pilot.
<span class="nc" id="L26970">                    vDesc.addAll(destroyEntity(a, &quot;Structural Integrity Collapse&quot;));</span>
<span class="nc" id="L26971">                    a.setSI(0);</span>
<span class="nc bnc" id="L26972" title="All 2 branches missed.">                    if (hit.getAttackerId() != Entity.NONE) {</span>
<span class="nc" id="L26973">                        creditKill(a, game.getEntity(hit.getAttackerId()));</span>
                    }
<span class="nc bnc" id="L26975" title="All 2 branches missed.">                } else if (!critSI) {</span>
<span class="nc" id="L26976">                    critSI = true;</span>
                }
            } else {
<span class="nc" id="L26979">                r = new Report(9147);</span>
<span class="nc" id="L26980">                r.subject = a.getId();</span>
<span class="nc" id="L26981">                r.indent(4);</span>
<span class="nc" id="L26982">                vDesc.addElement(r);</span>
            }
        }

        // apply crits
<span class="nc bnc" id="L26987" title="All 2 branches missed.">        if (hit.rolledBoxCars()) {</span>
<span class="nc bnc" id="L26988" title="All 2 branches missed.">            if (hit.isFirstHit()) {</span>
                // Allow edge use to ignore the critical roll
<span class="nc bnc" id="L26990" title="All 2 branches missed.">                if (a.getCrew().getOptions().booleanOption(OptionsConstants.EDGE_WHEN_AERO_LUCKY_CRIT)</span>
<span class="nc bnc" id="L26991" title="All 2 branches missed.">                        &amp;&amp; a.getCrew().hasEdgeRemaining()) {</span>
<span class="nc" id="L26992">                    a.getCrew().decreaseEdge();</span>
<span class="nc" id="L26993">                    r = new Report(9103);</span>
<span class="nc" id="L26994">                    r.subject = a.getId();</span>
<span class="nc" id="L26995">                    r.indent(3);</span>
<span class="nc" id="L26996">                    r.add(a.getCrew().getOptions().intOption(OptionsConstants.EDGE));</span>
<span class="nc" id="L26997">                    vDesc.addElement(r);</span>
                    // Skip the critical roll
<span class="nc" id="L26999">                    return;</span>
                }
<span class="nc" id="L27001">                vDesc.addAll(criticalAero(a, hit.getLocation(), hit.glancingMod(), &quot;12 to hit&quot;,</span>
                        8, damage_orig, isCapital));
            } else { // Let the user know why the lucky crit doesn't apply
<span class="nc" id="L27004">                r = new Report(9102);</span>
<span class="nc" id="L27005">                r.subject = a.getId();</span>
<span class="nc" id="L27006">                r.indent(3);</span>
<span class="nc" id="L27007">                vDesc.addElement(r);</span>
            }
        }
        // ammo explosions shouldn't affect threshold because they
        // go right to SI
<span class="nc bnc" id="L27012" title="All 4 branches missed.">        if (critThresh &amp;&amp; !ammoExplosion) {</span>
<span class="nc" id="L27013">            vDesc.addAll(criticalAero(a, hit.getLocation(), hit.glancingMod(),</span>
                    &quot;Damage threshold exceeded&quot;, 8, damage_orig, isCapital));
        }
<span class="nc bnc" id="L27016" title="All 4 branches missed.">        if (critSI &amp;&amp; !ammoExplosion) {</span>
<span class="nc" id="L27017">            vDesc.addAll(criticalAero(a, hit.getLocation(), hit.glancingMod(),</span>
                    &quot;SI damaged&quot;, 8, damage_orig, isCapital));
        }
<span class="nc bnc" id="L27020" title="All 4 branches missed.">        if ((capitalMissile &gt; 0) &amp;&amp; !nukeS2S) {</span>
<span class="nc" id="L27021">            vDesc.addAll(criticalAero(a, hit.getLocation(), hit.glancingMod(),</span>
                    &quot;Capital Missile&quot;, capitalMissile, damage_orig, isCapital));
        }
<span class="nc" id="L27024">    }</span>

    private Vector&lt;Report&gt; criticalAero(Aero a, int loc, int critMod,
            String reason, int target, int damage, boolean isCapital) {
<span class="nc" id="L27028">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

        //Telemissiles don't take critical hits
<span class="nc bnc" id="L27032" title="All 2 branches missed.">        if (a instanceof TeleMissile) {</span>
<span class="nc" id="L27033">            return vDesc;</span>
        }

        // roll the critical
<span class="nc" id="L27037">        r = new Report(9100);</span>
<span class="nc" id="L27038">        r.subject = a.getId();</span>
<span class="nc" id="L27039">        r.add(reason);</span>
<span class="nc" id="L27040">        r.indent(3);</span>
<span class="nc" id="L27041">        r.newlines = 0;</span>
<span class="nc" id="L27042">        vDesc.add(r);</span>
<span class="nc" id="L27043">        int roll = Compute.d6(2);</span>
<span class="nc" id="L27044">        r = new Report(9101);</span>
<span class="nc" id="L27045">        r.subject = a.getId();</span>
<span class="nc" id="L27046">        r.add(target);</span>
<span class="nc" id="L27047">        String rollString = &quot;&quot;;</span>
<span class="nc bnc" id="L27048" title="All 2 branches missed.">        if (critMod != 0) {</span>
<span class="nc" id="L27049">            rollString = &quot;(&quot; + roll;</span>
<span class="nc bnc" id="L27050" title="All 2 branches missed.">            if (critMod &gt; 0) {</span>
<span class="nc" id="L27051">                rollString += &quot;+&quot;;</span>
            }
<span class="nc" id="L27053">            rollString += critMod + &quot;) = &quot;;</span>
<span class="nc" id="L27054">            roll += critMod;</span>
        }
<span class="nc" id="L27056">        rollString += roll;</span>
<span class="nc" id="L27057">        r.add(rollString);</span>
<span class="nc" id="L27058">        r.newlines = 0;</span>
<span class="nc" id="L27059">        vDesc.add(r);</span>

        // now look up on vehicle crits table
<span class="nc" id="L27062">        int critType = a.getCriticalEffect(roll, target);</span>
<span class="nc" id="L27063">        vDesc.addAll(applyCriticalHit(a, loc, new CriticalSlot(0, critType),</span>
                true, damage, isCapital));
<span class="nc" id="L27065">        return vDesc;</span>
    }

    /**
     * Rolls and resolves critical hits on mechs or vehicles. if rollNumber is
     * false, a single hit is applied - needed for MaxTech Heat Scale rule.
     */
    public Vector&lt;Report&gt; criticalEntity(Entity en, int loc, boolean isRear,
            int critMod, boolean rollNumber, boolean isCapital, int damage) {
<span class="nc" id="L27074">        return criticalEntity(en, loc, isRear, critMod, rollNumber, isCapital,</span>
                damage, false);
    }

    /**
     * Rolls and resolves critical hits on mechs or vehicles. if rollNumber is
     * false, a single hit is applied - needed for MaxTech Heat Scale rule.
     */
    public Vector&lt;Report&gt; criticalEntity(Entity en, int loc, boolean isRear,
            int critMod, boolean rollNumber, boolean isCapital, int damage,
            boolean damagedByFire) {

<span class="nc bnc" id="L27086" title="All 2 branches missed.">        if (en.hasQuirk(&quot;poor_work&quot;)) {</span>
<span class="nc" id="L27087">            critMod += 1;</span>
        }
<span class="nc bnc" id="L27089" title="All 2 branches missed.">        if (en.hasQuirk(OptionsConstants.QUIRK_NEG_PROTOTYPE)) {</span>
<span class="nc" id="L27090">            critMod += 2;</span>
        }

        // Apply modifiers for Anti-penetrative ablation armor
<span class="nc bnc" id="L27094" title="All 2 branches missed.">        if ((en.getArmor(loc, isRear) &gt; 0)</span>
<span class="nc bnc" id="L27095" title="All 2 branches missed.">                &amp;&amp; (en.getArmorType(loc) == EquipmentType.T_ARMOR_ANTI_PENETRATIVE_ABLATION)) {</span>
<span class="nc" id="L27096">            critMod -= 2;</span>
        }

<span class="nc bnc" id="L27099" title="All 2 branches missed.">        if (en instanceof Tank) {</span>
<span class="nc" id="L27100">            return criticalTank((Tank) en, loc, critMod, damage, damagedByFire);</span>
        }

<span class="nc bnc" id="L27103" title="All 2 branches missed.">        if (en instanceof Aero) {</span>
<span class="nc" id="L27104">            return criticalAero((Aero) en, loc, critMod, &quot;unknown&quot;, 8, damage,</span>
                    isCapital);
        }
        CriticalSlot slot;
<span class="nc" id="L27108">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L27110">        Coords coords = en.getPosition();</span>
<span class="nc" id="L27111">        IHex hex = null;</span>
        int hits;
<span class="nc bnc" id="L27113" title="All 2 branches missed.">        if (rollNumber) {</span>
<span class="nc bnc" id="L27114" title="All 2 branches missed.">            if (null != coords) {</span>
<span class="nc" id="L27115">                hex = game.getBoard().getHex(coords);</span>
            }
<span class="nc" id="L27117">            r = new Report(6305);</span>
<span class="nc" id="L27118">            r.subject = en.getId();</span>
<span class="nc" id="L27119">            r.indent(3);</span>
<span class="nc" id="L27120">            r.add(en.getLocationAbbr(loc));</span>
<span class="nc" id="L27121">            r.newlines = 0;</span>
<span class="nc" id="L27122">            vDesc.addElement(r);</span>
<span class="nc" id="L27123">            hits = 0;</span>
<span class="nc" id="L27124">            int roll = Compute.d6(2);</span>
<span class="nc" id="L27125">            r = new Report(6310);</span>
<span class="nc" id="L27126">            r.subject = en.getId();</span>
<span class="nc" id="L27127">            String rollString = &quot;&quot;;</span>
            // industrials get a +2 bonus on the roll
<span class="nc bnc" id="L27129" title="All 4 branches missed.">            if ((en instanceof Mech) &amp;&amp; ((Mech) en).isIndustrial()) {</span>
<span class="nc" id="L27130">                critMod += 2;</span>
            }
            // reinforced structure gets a -1 mod
<span class="nc bnc" id="L27133" title="All 4 branches missed.">            if ((en instanceof Mech) &amp;&amp; ((Mech) en).hasReinforcedStructure()) {</span>
<span class="nc" id="L27134">                critMod -= 1;</span>
            }
<span class="nc bnc" id="L27136" title="All 2 branches missed.">            if (critMod != 0) {</span>
<span class="nc" id="L27137">                rollString = &quot;(&quot; + roll;</span>
<span class="nc bnc" id="L27138" title="All 2 branches missed.">                if (critMod &gt; 0) {</span>
<span class="nc" id="L27139">                    rollString += &quot;+&quot;;</span>
                }
<span class="nc" id="L27141">                rollString += critMod + &quot;) = &quot;;</span>
<span class="nc" id="L27142">                roll += critMod;</span>
            }
<span class="nc" id="L27144">            rollString += roll;</span>
<span class="nc" id="L27145">            r.add(rollString);</span>
<span class="nc" id="L27146">            r.newlines = 0;</span>
<span class="nc" id="L27147">            vDesc.addElement(r);</span>
<span class="nc" id="L27148">            boolean advancedCrit = game.getOptions().booleanOption(</span>
                    OptionsConstants.ADVCOMBAT_TACOPS_CRIT_ROLL);
<span class="nc bnc" id="L27150" title="All 8 branches missed.">            if ((!advancedCrit &amp;&amp; (roll &lt;= 7)) || (advancedCrit &amp;&amp; (roll &lt;= 8))) {</span>
                // no effect
<span class="nc" id="L27152">                r = new Report(6005);</span>
<span class="nc" id="L27153">                r.subject = en.getId();</span>
<span class="nc" id="L27154">                vDesc.addElement(r);</span>
<span class="nc" id="L27155">                return vDesc;</span>
<span class="nc bnc" id="L27156" title="All 12 branches missed.">            } else if ((!advancedCrit &amp;&amp; (roll &gt;= 8) &amp;&amp; (roll &lt;= 9))</span>
                    || (advancedCrit &amp;&amp; (roll &gt;= 9) &amp;&amp; (roll &lt;= 10))) {
<span class="nc" id="L27158">                hits = 1;</span>
<span class="nc" id="L27159">                r = new Report(6315);</span>
<span class="nc" id="L27160">                r.subject = en.getId();</span>
<span class="nc" id="L27161">                vDesc.addElement(r);</span>
<span class="nc bnc" id="L27162" title="All 12 branches missed.">            } else if ((!advancedCrit &amp;&amp; (roll &gt;= 10) &amp;&amp; (roll &lt;= 11))</span>
                    || (advancedCrit &amp;&amp; (roll &gt;= 11) &amp;&amp; (roll &lt;= 12))) {
<span class="nc" id="L27164">                hits = 2;</span>
<span class="nc" id="L27165">                r = new Report(6320);</span>
<span class="nc" id="L27166">                r.subject = en.getId();</span>
<span class="nc" id="L27167">                vDesc.addElement(r);</span>
<span class="nc bnc" id="L27168" title="All 6 branches missed.">            } else if (advancedCrit &amp;&amp; (roll &gt;= 13) &amp;&amp; (roll &lt;= 14)) {</span>
<span class="nc" id="L27169">                hits = 3;</span>
<span class="nc" id="L27170">                r = new Report(6325);</span>
<span class="nc" id="L27171">                r.subject = en.getId();</span>
<span class="nc" id="L27172">                vDesc.addElement(r);</span>
<span class="nc bnc" id="L27173" title="All 8 branches missed.">            } else if ((!advancedCrit &amp;&amp; (roll &gt;= 12)) || (advancedCrit &amp;&amp; (roll &gt;= 15))) {</span>
<span class="nc bnc" id="L27174" title="All 2 branches missed.">                if (en instanceof Protomech) {</span>
<span class="nc" id="L27175">                    hits = 3;</span>
<span class="nc" id="L27176">                    r = new Report(6325);</span>
<span class="nc" id="L27177">                    r.subject = en.getId();</span>
<span class="nc" id="L27178">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L27179" title="All 2 branches missed.">                } else if (en.locationIsLeg(loc)) {</span>
<span class="nc" id="L27180">                    CriticalSlot cs = en.getCritical(loc, 0);</span>
<span class="nc bnc" id="L27181" title="All 4 branches missed.">                    if ((cs != null) &amp;&amp; cs.isArmored()) {</span>
<span class="nc" id="L27182">                        r = new Report(6700);</span>
<span class="nc" id="L27183">                        r.subject = en.getId();</span>
<span class="nc" id="L27184">                        r.add(en.getLocationName(loc));</span>
<span class="nc" id="L27185">                        r.newlines = 0;</span>
<span class="nc" id="L27186">                        vDesc.addElement(r);</span>
<span class="nc" id="L27187">                        cs.setArmored(false);</span>
<span class="nc" id="L27188">                        return vDesc;</span>
                    }
                    // limb blown off
<span class="nc" id="L27191">                    r = new Report(6120);</span>
<span class="nc" id="L27192">                    r.subject = en.getId();</span>
<span class="nc" id="L27193">                    r.add(en.getLocationName(loc));</span>
<span class="nc" id="L27194">                    vDesc.addElement(r);</span>
<span class="nc bnc" id="L27195" title="All 2 branches missed.">                    if (en.getInternal(loc) &gt; 0) {</span>
<span class="nc" id="L27196">                        en.destroyLocation(loc, true);</span>
                    }
<span class="nc bnc" id="L27198" title="All 2 branches missed.">                    if (null != hex) {</span>
<span class="nc bnc" id="L27199" title="All 2 branches missed.">                        if (!hex.containsTerrain(Terrains.LEGS)) {</span>
<span class="nc" id="L27200">                            hex.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L27201">                                    .createTerrain(Terrains.LEGS, 1));</span>
                        } else {
<span class="nc" id="L27203">                            hex.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L27204">                                    .createTerrain(Terrains.LEGS,</span>
<span class="nc" id="L27205">                                            hex.terrainLevel(Terrains.LEGS) + 1));</span>
                        }
                    }
<span class="nc" id="L27208">                    sendChangedHex(en.getPosition());</span>
<span class="nc" id="L27209">                    return vDesc;</span>
<span class="nc bnc" id="L27210" title="All 4 branches missed.">                } else if ((loc == Mech.LOC_RARM) || (loc == Mech.LOC_LARM)) {</span>
<span class="nc" id="L27211">                    CriticalSlot cs = en.getCritical(loc, 0);</span>
<span class="nc bnc" id="L27212" title="All 4 branches missed.">                    if ((cs != null) &amp;&amp; cs.isArmored()) {</span>
<span class="nc" id="L27213">                        r = new Report(6700);</span>
<span class="nc" id="L27214">                        r.subject = en.getId();</span>
<span class="nc" id="L27215">                        r.add(en.getLocationName(loc));</span>
<span class="nc" id="L27216">                        r.newlines = 0;</span>
<span class="nc" id="L27217">                        vDesc.addElement(r);</span>
<span class="nc" id="L27218">                        cs.setArmored(false);</span>
<span class="nc" id="L27219">                        return vDesc;</span>
                    }

                    // limb blown off
<span class="nc" id="L27223">                    r = new Report(6120);</span>
<span class="nc" id="L27224">                    r.subject = en.getId();</span>
<span class="nc" id="L27225">                    r.add(en.getLocationName(loc));</span>
<span class="nc" id="L27226">                    vDesc.addElement(r);</span>
<span class="nc" id="L27227">                    en.destroyLocation(loc, true);</span>
<span class="nc bnc" id="L27228" title="All 2 branches missed.">                    if (null != hex) {</span>
<span class="nc bnc" id="L27229" title="All 2 branches missed.">                        if (!hex.containsTerrain(Terrains.ARMS)) {</span>
<span class="nc" id="L27230">                            hex.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L27231">                                    .createTerrain(Terrains.ARMS, 1));</span>
                        } else {
<span class="nc" id="L27233">                            hex.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L27234">                                    .createTerrain(Terrains.ARMS,</span>
<span class="nc" id="L27235">                                            hex.terrainLevel(Terrains.ARMS) + 1));</span>
                        }
                    }
<span class="nc" id="L27238">                    sendChangedHex(en.getPosition());</span>
<span class="nc" id="L27239">                    return vDesc;</span>
<span class="nc bnc" id="L27240" title="All 2 branches missed.">                } else if (loc == Mech.LOC_HEAD) {</span>
                    // head blown off
<span class="nc" id="L27242">                    r = new Report(6330);</span>
<span class="nc" id="L27243">                    r.subject = en.getId();</span>
<span class="nc" id="L27244">                    r.add(en.getLocationName(loc));</span>
<span class="nc" id="L27245">                    vDesc.addElement(r);</span>
<span class="nc" id="L27246">                    en.destroyLocation(loc, true);</span>
<span class="nc bnc" id="L27247" title="All 2 branches missed.">                    if (((Mech) en).getCockpitType() != Mech.COCKPIT_TORSO_MOUNTED) {</span>
                        // Don't kill a pilot multiple times.
<span class="nc bnc" id="L27249" title="All 2 branches missed.">                        if (Crew.DEATH &gt; en.getCrew().getHits()) {</span>
<span class="nc" id="L27250">                            en.getCrew().setDoomed(true);</span>
<span class="nc" id="L27251">                            Report.addNewline(vDesc);</span>
<span class="nc" id="L27252">                            vDesc.addAll(destroyEntity(en, &quot;pilot death&quot;, true));</span>
                        }
                    }
<span class="nc" id="L27255">                    return vDesc;</span>
                } else {
                    // torso hit
<span class="nc" id="L27258">                    hits = 3;</span>
                    // industrials get 4 crits on a modified result of 14
<span class="nc bnc" id="L27260" title="All 6 branches missed.">                    if ((roll &gt;= 14) &amp;&amp; (en instanceof Mech) &amp;&amp; ((Mech) en).isIndustrial()) {</span>
<span class="nc" id="L27261">                        hits = 4;</span>
                    }
<span class="nc" id="L27263">                    r = new Report(6325);</span>
<span class="nc" id="L27264">                    r.subject = en.getId();</span>
<span class="nc" id="L27265">                    vDesc.addElement(r);</span>
                }
            }
<span class="nc" id="L27268">        } else {</span>
<span class="nc" id="L27269">            hits = 1;</span>
        }

        // Check if there is the potential for a reactive armor crit
        // Because reactive armor isn't hittable, the transfer check doesn't
        // consider it
<span class="nc bnc" id="L27275" title="All 2 branches missed.">        boolean possibleReactiveCrit = (en.getArmor(loc) &gt; 0)</span>
<span class="nc bnc" id="L27276" title="All 2 branches missed.">                &amp;&amp; (en.getArmorType(loc) == EquipmentType.T_ARMOR_REACTIVE);</span>
<span class="nc" id="L27277">        boolean locContainsReactiveArmor = false;</span>
<span class="nc bnc" id="L27278" title="All 4 branches missed.">        for (int i = 0; (i &lt; en.getNumberOfCriticals(loc)) &amp;&amp; possibleReactiveCrit; i++) {</span>
<span class="nc" id="L27279">            CriticalSlot crit = en.getCritical(loc, i);</span>
<span class="nc bnc" id="L27280" title="All 4 branches missed.">            if ((crit != null) &amp;&amp; (crit.getType() == CriticalSlot.TYPE_EQUIPMENT)</span>
<span class="nc bnc" id="L27281" title="All 2 branches missed.">                    &amp;&amp; (crit.getMount() != null)</span>
<span class="nc bnc" id="L27282" title="All 2 branches missed.">                    &amp;&amp; crit.getMount().getType().hasFlag(MiscType.F_REACTIVE)) {</span>
<span class="nc" id="L27283">                locContainsReactiveArmor = true;</span>
<span class="nc" id="L27284">                break;</span>
            }
        }
<span class="nc" id="L27287">        possibleReactiveCrit &amp;= locContainsReactiveArmor;</span>

        // transfer criticals, if needed
<span class="nc bnc" id="L27290" title="All 4 branches missed.">        while ((en.canTransferCriticals(loc) &amp;&amp; !possibleReactiveCrit)</span>
<span class="nc bnc" id="L27291" title="All 2 branches missed.">                &amp;&amp; (en.getTransferLocation(loc) != Entity.LOC_DESTROYED)</span>
<span class="nc bnc" id="L27292" title="All 2 branches missed.">                &amp;&amp; (en.getTransferLocation(loc) != Entity.LOC_NONE)) {</span>
<span class="nc" id="L27293">            loc = en.getTransferLocation(loc);</span>
<span class="nc" id="L27294">            r = new Report(6335);</span>
<span class="nc" id="L27295">            r.subject = en.getId();</span>
<span class="nc" id="L27296">            r.indent(3);</span>
<span class="nc" id="L27297">            r.add(en.getLocationAbbr(loc));</span>
<span class="nc" id="L27298">            vDesc.addElement(r);</span>
        }

        // Roll critical hits in this location.
<span class="nc bnc" id="L27302" title="All 2 branches missed.">        while (hits &gt; 0) {</span>

            // Have we hit all available slots in this location?
<span class="nc bnc" id="L27305" title="All 2 branches missed.">            if (en.getHittableCriticals(loc) &lt;= 0) {</span>
<span class="nc" id="L27306">                r = new Report(6340);</span>
<span class="nc" id="L27307">                r.subject = en.getId();</span>
<span class="nc" id="L27308">                r.indent(3);</span>
<span class="nc" id="L27309">                vDesc.addElement(r);</span>
<span class="nc" id="L27310">                break;</span>
            }

            // Randomly pick a slot to be hit.
<span class="nc" id="L27314">            int slotIndex = Compute.randomInt(en.getNumberOfCriticals(loc));</span>
<span class="nc" id="L27315">            slot = en.getCritical(loc, slotIndex);</span>

            // There are certain special cases, like reactive armor
            // some crits aren't normally hittable, except in certain cases
<span class="nc" id="L27319">            boolean reactiveArmorCrit = false;</span>
<span class="nc bnc" id="L27320" title="All 4 branches missed.">            if ((slot != null) &amp;&amp; (slot.getType() == CriticalSlot.TYPE_EQUIPMENT)</span>
<span class="nc bnc" id="L27321" title="All 2 branches missed.">                    &amp;&amp; (slot.getMount() != null)) {</span>
<span class="nc" id="L27322">                Mounted eq = slot.getMount();</span>
<span class="nc bnc" id="L27323" title="All 4 branches missed.">                if (eq.getType().hasFlag(MiscType.F_REACTIVE) &amp;&amp; (en.getArmor(loc) &gt; 0)) {</span>
<span class="nc" id="L27324">                    reactiveArmorCrit = true;</span>
                }
            }

            // Ignore empty or unhitable slots (this
            // includes all previously hit slots).
<span class="nc bnc" id="L27330" title="All 6 branches missed.">            if ((slot != null) &amp;&amp; (slot.isHittable() || reactiveArmorCrit)) {</span>

<span class="nc bnc" id="L27332" title="All 2 branches missed.">                if (slot.isArmored()) {</span>
<span class="nc" id="L27333">                    r = new Report(6710);</span>
<span class="nc" id="L27334">                    r.subject = en.getId();</span>
<span class="nc bnc" id="L27335" title="All 2 branches missed.">                    if (slot.getType() == CriticalSlot.TYPE_SYSTEM) {</span>
                        // Pretty sure that only 'mechs have system crits,
                        // but just in case....
<span class="nc bnc" id="L27338" title="All 2 branches missed.">                        if (en instanceof Mech) {</span>
<span class="nc" id="L27339">                            r.add(((Mech) en).getSystemName(slot.getIndex()));</span>
                        }
                    } else {
                        // Shouldn't be null, but we'll be careful...
<span class="nc bnc" id="L27343" title="All 2 branches missed.">                        if (slot.getMount() != null) {</span>
<span class="nc" id="L27344">                            r.add(slot.getMount().getName());</span>
                        }
                    }
<span class="nc" id="L27347">                    vDesc.addElement(r);</span>
<span class="nc" id="L27348">                    slot.setArmored(false);</span>
<span class="nc" id="L27349">                    hits--;</span>
<span class="nc" id="L27350">                    continue;</span>
                }
                // if explosive use edge
<span class="nc bnc" id="L27353" title="All 2 branches missed.">                if ((en instanceof Mech)</span>
<span class="nc bnc" id="L27354" title="All 2 branches missed.">                        &amp;&amp; (en.getCrew().hasEdgeRemaining() &amp;&amp; en.getCrew().getOptions()</span>
<span class="nc bnc" id="L27355" title="All 2 branches missed.">                                .booleanOption(OptionsConstants.EDGE_WHEN_EXPLOSION))</span>
<span class="nc bnc" id="L27356" title="All 2 branches missed.">                        &amp;&amp; (slot.getType() == CriticalSlot.TYPE_EQUIPMENT)</span>
<span class="nc bnc" id="L27357" title="All 2 branches missed.">                        &amp;&amp; slot.getMount().getType().isExplosive(slot.getMount())) {</span>
<span class="nc" id="L27358">                    en.getCrew().decreaseEdge();</span>
<span class="nc" id="L27359">                    r = new Report(6530);</span>
<span class="nc" id="L27360">                    r.subject = en.getId();</span>
<span class="nc" id="L27361">                    r.indent(3);</span>
<span class="nc" id="L27362">                    r.add(en.getCrew().getOptions().intOption(OptionsConstants.EDGE));</span>
<span class="nc" id="L27363">                    vDesc.addElement(r);</span>
<span class="nc" id="L27364">                    continue;</span>
                }

                // check for reactive armor exploding
<span class="nc bnc" id="L27368" title="All 2 branches missed.">                if (reactiveArmorCrit) {</span>
<span class="nc" id="L27369">                    Mounted mount = slot.getMount();</span>
<span class="nc bnc" id="L27370" title="All 4 branches missed.">                    if ((mount != null) &amp;&amp; mount.getType().hasFlag(MiscType.F_REACTIVE)) {</span>
<span class="nc" id="L27371">                        int roll = Compute.d6(2);</span>
<span class="nc" id="L27372">                        r = new Report(6082);</span>
<span class="nc" id="L27373">                        r.subject = en.getId();</span>
<span class="nc" id="L27374">                        r.indent(3);</span>
<span class="nc" id="L27375">                        r.add(roll);</span>
<span class="nc" id="L27376">                        vDesc.addElement(r);</span>
                        // big budda boom
<span class="nc bnc" id="L27378" title="All 2 branches missed.">                        if (roll == 2) {</span>
<span class="nc" id="L27379">                            r = new Report(6083);</span>
<span class="nc" id="L27380">                            r.subject = en.getId();</span>
<span class="nc" id="L27381">                            r.indent(4);</span>
<span class="nc" id="L27382">                            vDesc.addElement(r);</span>
<span class="nc" id="L27383">                            Vector&lt;Report&gt; newReports = new Vector&lt;&gt;(damageEntity(en,</span>
<span class="nc" id="L27384">                                    new HitData(loc), en.getArmor(loc)));</span>
<span class="nc bnc" id="L27385" title="All 2 branches missed.">                            if (en.hasRearArmor(loc)) {</span>
<span class="nc" id="L27386">                                newReports.addAll(damageEntity(en, new HitData(loc, true),</span>
<span class="nc" id="L27387">                                        en.getArmor(loc, true)));</span>
                            }
<span class="nc" id="L27389">                            newReports.addAll(damageEntity(en, new HitData(loc), 1));</span>
<span class="nc bnc" id="L27390" title="All 2 branches missed.">                            for (Report rep : newReports) {</span>
<span class="nc" id="L27391">                                rep.indent(4);</span>
<span class="nc" id="L27392">                            }</span>
<span class="nc" id="L27393">                            vDesc.addAll(newReports);</span>
<span class="nc" id="L27394">                        } else {</span>
                            // If only hittable crits are reactive,
                            // this crit is absorbed
<span class="nc" id="L27397">                            boolean allHittableCritsReactive = true;</span>
<span class="nc bnc" id="L27398" title="All 2 branches missed.">                            for (int i = 0; i &lt; en.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L27399">                                CriticalSlot crit = en.getCritical(loc, i);</span>
<span class="nc bnc" id="L27400" title="All 2 branches missed.">                                if (crit.isHittable()) {</span>
<span class="nc" id="L27401">                                    allHittableCritsReactive = false;</span>
<span class="nc" id="L27402">                                    break;</span>
                                }
                                // We must have reactive crits to get to this
                                // point, so if nothing else is hittable, we
                                // must only have reactive crits
                            }
<span class="nc bnc" id="L27408" title="All 2 branches missed.">                            if (allHittableCritsReactive) {</span>
<span class="nc" id="L27409">                                hits--;</span>
                            }
                            continue;
                        }
                    }
                }
<span class="nc" id="L27415">                vDesc.addAll(applyCriticalHit(en, loc, slot, true, damage, isCapital));</span>
<span class="nc" id="L27416">                hits--;</span>
            }
<span class="nc" id="L27418">        } // Hit another slot in this location.</span>

<span class="nc" id="L27420">        return vDesc;</span>
    }

    /**
     * Checks for location breach and returns phase logging.
     * &lt;p/&gt;
     *
     * @param entity the &lt;code&gt;Entity&lt;/code&gt; that needs to be checked.
     * @param loc    the &lt;code&gt;int&lt;/code&gt; location on the entity that needs to be
     *               checked for a breach.
     * @param hex    the &lt;code&gt;IHex&lt;/code&gt; the entity occupies when checking. This
     *               value will be &lt;code&gt;null&lt;/code&gt; if the check is the result of
     *               an attack, and non-null if it occurs during movement.
     */
    private Vector&lt;Report&gt; breachCheck(Entity entity, int loc, IHex hex) {
<span class="nc" id="L27435">        return breachCheck(entity, loc, hex, false);</span>
    }

    /**
     * Checks for location breach and returns phase logging.
     * &lt;p/&gt;
     *
     * @param entity     the &lt;code&gt;Entity&lt;/code&gt; that needs to be checked.
     * @param loc        the &lt;code&gt;int&lt;/code&gt; location on the entity that needs to be
     *                   checked for a breach.
     * @param hex        the &lt;code&gt;IHex&lt;/code&gt; the entity occupies when checking. This
     *                   value will be &lt;code&gt;null&lt;/code&gt; if the check is the result of
     *                   an attack, and non-null if it occurs during movement.
     * @param underWater Is the breach check a result of an underwater attack?
     */
    private Vector&lt;Report&gt; breachCheck(Entity entity, int loc, IHex hex, boolean underWater) {
<span class="nc" id="L27451">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

        // Infantry do not suffer breaches, nor do Telemissiles
        // VTOLs can't operate in vacuum or underwater, so no breaches
<span class="nc bnc" id="L27456" title="All 6 branches missed.">        if (entity instanceof Infantry || entity instanceof TeleMissile || entity instanceof VTOL) {</span>
<span class="nc" id="L27457">            return vDesc;</span>
        }

<span class="nc" id="L27460">        boolean dumping = false;</span>
<span class="nc bnc" id="L27461" title="All 2 branches missed.">        for (Mounted m : entity.getAmmo()) {</span>
<span class="nc bnc" id="L27462" title="All 2 branches missed.">            if (m.isDumping()) {</span>
                // dumping ammo underwater is very stupid thing to do
<span class="nc" id="L27464">                dumping = true;</span>
<span class="nc" id="L27465">                break;</span>
            }
<span class="nc" id="L27467">        }</span>
        // This handles both water and vacuum breaches.
        // Also need to account for hull breaches on surface naval vessels which
        // are technically not &quot;wet&quot;
<span class="nc bnc" id="L27471" title="All 2 branches missed.">        if ((entity.getLocationStatus(loc) &gt; ILocationExposureStatus.NORMAL)</span>
<span class="nc bnc" id="L27472" title="All 4 branches missed.">                || (entity.isSurfaceNaval() &amp;&amp; (loc != ((Tank) entity).getLocTurret()))) {</span>
            // Does the location have armor (check rear armor on Mek)
            // and is the check due to damage?
<span class="nc" id="L27475">            int breachroll = 0;</span>
            // set the target roll for the breach
<span class="nc" id="L27477">            int target = 10;</span>
            // if this is a vacuum check and we are in trace atmosphere then
            // adjust target
<span class="nc bnc" id="L27480" title="All 2 branches missed.">            if ((entity.getLocationStatus(loc) == ILocationExposureStatus.VACUUM)</span>
<span class="nc bnc" id="L27481" title="All 2 branches missed.">                    &amp;&amp; (game.getPlanetaryConditions().getAtmosphere() == PlanetaryConditions.ATMO_TRACE)) {</span>
<span class="nc" id="L27482">                target = 12;</span>
            }
            // if this is a surface naval vessel and the attack is not from
            // underwater
            // then the breach should only occur on a roll of 12
<span class="nc bnc" id="L27487" title="All 4 branches missed.">            if (entity.isSurfaceNaval() &amp;&amp; !underWater) {</span>
<span class="nc" id="L27488">                target = 12;</span>
            }
<span class="nc bnc" id="L27490" title="All 4 branches missed.">            if ((entity.getArmor(loc) &gt; 0)</span>
<span class="nc bnc" id="L27491" title="All 4 branches missed.">                    &amp;&amp; (!(entity instanceof Mech) || entity.getArmor(loc, true) &gt; 0) &amp;&amp; (null == hex)) {</span>
                // functional HarJel prevents breach
<span class="nc bnc" id="L27493" title="All 2 branches missed.">                if (entity.hasHarJelIn(loc)) {</span>
<span class="nc" id="L27494">                    r = new Report(6342);</span>
<span class="nc" id="L27495">                    r.subject = entity.getId();</span>
<span class="nc" id="L27496">                    r.indent(3);</span>
<span class="nc" id="L27497">                    vDesc.addElement(r);</span>
<span class="nc" id="L27498">                    return vDesc;</span>
                }
<span class="nc bnc" id="L27500" title="All 4 branches missed.">                if ((entity instanceof Mech) &amp;&amp; (((Mech) entity).hasHarJelIIIn(loc)</span>
<span class="nc bnc" id="L27501" title="All 2 branches missed.">                        || ((Mech) entity).hasHarJelIIIIn(loc))) {</span>
<span class="nc" id="L27502">                    r = new Report(6343);</span>
<span class="nc" id="L27503">                    r.subject = entity.getId();</span>
<span class="nc" id="L27504">                    r.indent(3);</span>
<span class="nc" id="L27505">                    vDesc.addElement(r);</span>
<span class="nc" id="L27506">                    target -= 2;</span>
                }
                // Impact-resistant armor easier to breach
<span class="nc bnc" id="L27509" title="All 2 branches missed.">                if ((entity.getArmorType(loc) == EquipmentType.T_ARMOR_IMPACT_RESISTANT)) {</span>
<span class="nc" id="L27510">                    r = new Report(6344);</span>
<span class="nc" id="L27511">                    r.subject = entity.getId();</span>
<span class="nc" id="L27512">                    r.indent(3);</span>
<span class="nc" id="L27513">                    vDesc.addElement(r);</span>
<span class="nc" id="L27514">                    target += 1;</span>
                }
<span class="nc" id="L27516">                breachroll = Compute.d6(2);</span>
<span class="nc" id="L27517">                r = new Report(6345);</span>
<span class="nc" id="L27518">                r.subject = entity.getId();</span>
<span class="nc" id="L27519">                r.indent(3);</span>
<span class="nc" id="L27520">                r.add(entity.getLocationAbbr(loc));</span>
<span class="nc" id="L27521">                r.add(breachroll);</span>
<span class="nc" id="L27522">                r.newlines = 0;</span>
<span class="nc bnc" id="L27523" title="All 2 branches missed.">                if (breachroll &gt;= target) {</span>
<span class="nc" id="L27524">                    r.choose(false);</span>
                } else {
<span class="nc" id="L27526">                    r.choose(true);</span>
                }
<span class="nc" id="L27528">                vDesc.addElement(r);</span>
            }
            // Breach by damage or lack of armor.
<span class="nc bnc" id="L27531" title="All 16 branches missed.">            if ((breachroll &gt;= target) || !(entity.getArmor(loc) &gt; 0)</span>
                    || (dumping &amp;&amp; (!(entity instanceof Mech)
                        || (loc == Mech.LOC_CT) || (loc == Mech.LOC_RT) || (loc == Mech.LOC_LT)))
<span class="nc bnc" id="L27534" title="All 2 branches missed.">                    || !(!(entity instanceof Mech) || entity.getArmor(loc, true) &gt; 0)) {</span>
                // Functional HarJel prevents breach as long as armor remains
                // (and, presumably, as long as you don't open your chassis on
                // purpose, say to dump ammo...).
<span class="nc bnc" id="L27538" title="All 6 branches missed.">                if ((entity.hasHarJelIn(loc)) &amp;&amp; (entity.getArmor(loc) &gt; 0)</span>
<span class="nc bnc" id="L27539" title="All 4 branches missed.">                    &amp;&amp; (!(entity instanceof Mech) || entity.getArmor(loc, true) &gt; 0) &amp;&amp; !dumping) {</span>
<span class="nc" id="L27540">                    r = new Report(6342);</span>
<span class="nc" id="L27541">                    r.subject = entity.getId();</span>
<span class="nc" id="L27542">                    r.indent(3);</span>
<span class="nc" id="L27543">                    vDesc.addElement(r);</span>
<span class="nc" id="L27544">                    return vDesc;</span>
                }
<span class="nc" id="L27546">                vDesc.addAll(breachLocation(entity, loc, hex, false));</span>
            }
        }
<span class="nc" id="L27549">        return vDesc;</span>
    }

    /**
     * Marks all equipment in a location on an entity as useless.
     *
     * @param entity the &lt;code&gt;Entity&lt;/code&gt; that needs to be checked.
     * @param loc    the &lt;code&gt;int&lt;/code&gt; location on the entity that needs to be
     *               checked for a breach.
     * @param hex    the &lt;code&gt;IHex&lt;/code&gt; the entity occupies when checking. This
     *               value will be &lt;code&gt;null&lt;/code&gt; if the check is the result of
     *               an attack, and non-null if it occurs during movement.
     * @param harJel a &lt;code&gt;boolean&lt;/code&gt; value indicating if the uselessness is
     *               the cause of a critically hit HarJel system
     */
    private Vector&lt;Report&gt; breachLocation(Entity entity, int loc, IHex hex, boolean harJel) {
<span class="nc" id="L27565">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

<span class="nc bnc" id="L27568" title="All 2 branches missed.">        if ((entity.getInternal(loc) &lt; 0)</span>
<span class="nc bnc" id="L27569" title="All 2 branches missed.">                || (entity.getLocationStatus(loc) &lt; ILocationExposureStatus.NORMAL)) {</span>
            // already destroyed or breached? don't bother
<span class="nc" id="L27571">            return vDesc;</span>
        }

<span class="nc" id="L27574">        r = new Report(6350);</span>
<span class="nc bnc" id="L27575" title="All 2 branches missed.">        if (harJel) {</span>
<span class="nc" id="L27576">            r.messageId = 6351;</span>
        }
<span class="nc" id="L27578">        r.subject = entity.getId();</span>
<span class="nc" id="L27579">        r.add(entity.getShortName());</span>
<span class="nc" id="L27580">        r.add(entity.getLocationAbbr(loc));</span>
<span class="nc" id="L27581">        vDesc.addElement(r);</span>

<span class="nc bnc" id="L27583" title="All 2 branches missed.">        if (entity instanceof Tank) {</span>
<span class="nc" id="L27584">            vDesc.addAll(destroyEntity(entity, &quot;hull breach&quot;, true, true));</span>
<span class="nc" id="L27585">            return vDesc;</span>
        }
<span class="nc bnc" id="L27587" title="All 2 branches missed.">        if (entity instanceof Mech) {</span>
<span class="nc" id="L27588">            Mech mech = (Mech) entity;</span>
            // equipment and crits will be marked in applyDamage?

            // equipment marked missing
<span class="nc bnc" id="L27592" title="All 2 branches missed.">            for (Mounted mounted : entity.getEquipment()) {</span>
<span class="nc bnc" id="L27593" title="All 2 branches missed.">                if (mounted.getLocation() == loc) {</span>
<span class="nc" id="L27594">                    mounted.setBreached(true);</span>
                }
<span class="nc" id="L27596">            }</span>
            // all critical slots set as useless
<span class="nc bnc" id="L27598" title="All 2 branches missed.">            for (int i = 0; i &lt; entity.getNumberOfCriticals(loc); i++) {</span>
<span class="nc" id="L27599">                final CriticalSlot cs = entity.getCritical(loc, i);</span>
<span class="nc bnc" id="L27600" title="All 2 branches missed.">                if (cs != null) {</span>
                    // for every undamaged actuator destroyed by breaching,
                    // we make a PSR (see bug 1040858)
<span class="nc bnc" id="L27603" title="All 4 branches missed.">                    if (entity.locationIsLeg(loc) &amp;&amp; entity.canFall(true)) {</span>
<span class="nc bnc" id="L27604" title="All 2 branches missed.">                        if (cs.isHittable()) {</span>
<span class="nc bnc" id="L27605" title="All 3 branches missed.">                            switch (cs.getIndex()) {</span>
                                case Mech.ACTUATOR_UPPER_LEG:
                                case Mech.ACTUATOR_LOWER_LEG:
                                case Mech.ACTUATOR_FOOT:
                                    // leg/foot actuator piloting roll
<span class="nc" id="L27610">                                    game.addPSR(new PilotingRollData(entity.getId(), 1,</span>
                                            &quot;leg/foot actuator hit&quot;));
<span class="nc" id="L27612">                                    break;</span>
                                case Mech.ACTUATOR_HIP:
                                    // hip piloting roll at +0, because we get the +2 anyway
                                    // because the location is breached.
                                    // The phase report will look a bit weird, but the
                                    // roll is correct
<span class="nc" id="L27618">                                    game.addPSR(new PilotingRollData(entity.getId(), 0,</span>
                                            &quot;hip actuator hit&quot;));
                                    break;
                            }
                        }
                    }
<span class="nc" id="L27624">                    cs.setBreached(true);</span>
                }
            }

            // Check location for engine/cockpit breach and report accordingly
<span class="nc bnc" id="L27629" title="All 2 branches missed.">            if (loc == Mech.LOC_CT) {</span>
<span class="nc" id="L27630">                vDesc.addAll(destroyEntity(entity, &quot;hull breach&quot;));</span>
<span class="nc bnc" id="L27631" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_AUTO_ABANDON_UNIT)) {</span>
<span class="nc" id="L27632">                    vDesc.addAll(abandonEntity(entity));</span>
                }
            }
<span class="nc bnc" id="L27635" title="All 2 branches missed.">            if (loc == Mech.LOC_HEAD) {</span>
<span class="nc" id="L27636">                entity.getCrew().setDoomed(true);</span>
<span class="nc" id="L27637">                vDesc.addAll(destroyEntity(entity, &quot;hull breach&quot;));</span>
<span class="nc bnc" id="L27638" title="All 2 branches missed.">                if (entity.getLocationStatus(loc) == ILocationExposureStatus.WET) {</span>
<span class="nc" id="L27639">                    r = new Report(6355);</span>
                } else {
<span class="nc" id="L27641">                    r = new Report(6360);</span>
                }
<span class="nc" id="L27643">                r.subject = entity.getId();</span>
<span class="nc" id="L27644">                r.addDesc(entity);</span>
<span class="nc" id="L27645">                vDesc.addElement(r);</span>
            }

            // Set the status of the location.
            // N.B. if we set the status before rolling water PSRs, we get a
            // &quot;LEG DESTROYED&quot; modifier; setting the status after gives a hip
            // actuator modifier.
<span class="nc" id="L27652">            entity.setLocationStatus(loc, ILocationExposureStatus.BREACHED);</span>

            // Did the hull breach destroy the engine?
<span class="nc" id="L27655">            int hitsToDestroy = 3;</span>
<span class="nc bnc" id="L27656" title="All 4 branches missed.">            if (mech.isSuperHeavy() &amp;&amp; mech.hasEngine()</span>
<span class="nc bnc" id="L27657" title="All 2 branches missed.">                    &amp;&amp; (mech.getEngine().getEngineType() == Engine.COMPACT_ENGINE)) {</span>
<span class="nc" id="L27658">                hitsToDestroy = 2;</span>
            }
<span class="nc" id="L27660">            if ((entity.getHitCriticals(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_ENGINE, Mech.LOC_LT)</span>
<span class="nc" id="L27661">                    + entity.getHitCriticals(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_ENGINE, Mech.LOC_CT)</span>
<span class="nc bnc" id="L27662" title="All 2 branches missed.">                    + entity.getHitCriticals(CriticalSlot.TYPE_SYSTEM, Mech.SYSTEM_ENGINE, Mech.LOC_RT))</span>
                    &gt;= hitsToDestroy) {
<span class="nc" id="L27664">                vDesc.addAll(destroyEntity(entity, &quot;engine destruction&quot;));</span>
<span class="nc bnc" id="L27665" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_AUTO_ABANDON_UNIT)) {</span>
<span class="nc" id="L27666">                    vDesc.addAll(abandonEntity(entity));</span>
                }
            }

<span class="nc bnc" id="L27670" title="All 2 branches missed.">            if (loc == Mech.LOC_LT) {</span>
<span class="nc" id="L27671">                vDesc.addAll(breachLocation(entity, Mech.LOC_LARM, hex, false));</span>
            }
<span class="nc bnc" id="L27673" title="All 2 branches missed.">            if (loc == Mech.LOC_RT) {</span>
<span class="nc" id="L27674">                vDesc.addAll(breachLocation(entity, Mech.LOC_RARM, hex, false));</span>
            }
        }

<span class="nc" id="L27678">        return vDesc;</span>
    }

    /**
     * Mark the unit as destroyed! Units transported in the destroyed unit will
     * get a chance to escape.
     *
     * @param entity - the &lt;code&gt;Entity&lt;/code&gt; that has been destroyed.
     * @param reason - a &lt;code&gt;String&lt;/code&gt; detailing why the entity was
     *               destroyed.
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt; objects that can be
     * sent to the output log.
     */
    private Vector&lt;Report&gt; destroyEntity(Entity entity, String reason) {
<span class="nc" id="L27692">        return destroyEntity(entity, reason, true);</span>
    }

    /**
     * Marks a unit as destroyed! Units transported inside the destroyed unit
     * will get a chance to escape unless the destruction was not survivable.
     *
     * @param entity     - the &lt;code&gt;Entity&lt;/code&gt; that has been destroyed.
     * @param reason     - a &lt;code&gt;String&lt;/code&gt; detailing why the entity was
     *                   destroyed.
     * @param survivable - a &lt;code&gt;boolean&lt;/code&gt; that identifies the destruction as
     *                   unsurvivable for transported units.
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt; objects that can be
     * sent to the output log.
     */
    public Vector&lt;Report&gt; destroyEntity(Entity entity, String reason, boolean survivable) {
        // Generally, the entity can still be salvaged.
<span class="nc" id="L27709">        return destroyEntity(entity, reason, survivable, true);</span>
    }

    /**
     * Marks a unit as destroyed! Units transported inside the destroyed unit
     * will get a chance to escape unless the destruction was not survivable.
     *
     * @param entity     - the &lt;code&gt;Entity&lt;/code&gt; that has been destroyed.
     * @param reason     - a &lt;code&gt;String&lt;/code&gt; detailing why the entity was
     *                   destroyed.
     * @param survivable - a &lt;code&gt;boolean&lt;/code&gt; that identifies the destruction as
     *                   unsurvivable for transported units.
     * @param canSalvage - a &lt;code&gt;boolean&lt;/code&gt; that indicates if the unit can be
     *                   salvaged (or cannibalized for spare parts). If
     *                   &lt;code&gt;true&lt;/code&gt;, salvage operations are possible, if
     *                   &lt;code&gt;false&lt;/code&gt;, the unit is too badly damaged.
     * @return a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Report&lt;/code&gt; objects that can be
     * sent to the output log.
     */
    public Vector&lt;Report&gt; destroyEntity(Entity entity, String reason, boolean survivable,
                                         boolean canSalvage) {
        // can't destroy an entity if it's already been destroyed        
<span class="nc bnc" id="L27731" title="All 2 branches missed.">        if(entity.isDestroyed()) {</span>
<span class="nc" id="L27732">            return new Vector&lt;Report&gt;();</span>
        }
        
<span class="nc" id="L27735">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;
        
        //We'll need this later...
<span class="nc" id="L27739">        Aero ship = null;</span>
<span class="nc bnc" id="L27740" title="All 2 branches missed.">        if (entity.isLargeCraft()) {</span>
<span class="nc" id="L27741">            ship = (Aero) entity;</span>
        }

        // regardless of what was passed in, units loaded onto aeros not on the
        // ground are destroyed
<span class="nc bnc" id="L27746" title="All 2 branches missed.">        if (entity.isAirborne()) {</span>
<span class="nc" id="L27747">            survivable = false;</span>
<span class="nc bnc" id="L27748" title="All 2 branches missed.">        } else if (entity.isAero()) {</span>
<span class="nc" id="L27749">            survivable = true;</span>
        }

        // The unit can suffer an ammo explosion after it has been destroyed.
<span class="nc" id="L27753">        int condition = IEntityRemovalConditions.REMOVE_SALVAGEABLE;</span>
<span class="nc bnc" id="L27754" title="All 2 branches missed.">        if (!canSalvage) {</span>
<span class="nc" id="L27755">            entity.setSalvage(false);</span>
<span class="nc" id="L27756">            condition = IEntityRemovalConditions.REMOVE_DEVASTATED;</span>
        }

        // Destroy the entity, unless it's already destroyed.
<span class="nc bnc" id="L27760" title="All 4 branches missed.">        if (!entity.isDoomed() &amp;&amp; !entity.isDestroyed()) {</span>
<span class="nc" id="L27761">            r = new Report(6365);</span>
<span class="nc" id="L27762">            r.subject = entity.getId();</span>
<span class="nc" id="L27763">            r.addDesc(entity);</span>
<span class="nc" id="L27764">            r.add(reason);</span>
<span class="nc" id="L27765">            vDesc.addElement(r);</span>

<span class="nc" id="L27767">            entity.setDoomed(true);</span>

            // Kill any picked up MechWarriors
<span class="nc" id="L27770">            Enumeration&lt;Integer&gt; iter = entity.getPickedUpMechWarriors().elements();</span>
<span class="nc bnc" id="L27771" title="All 2 branches missed.">            while (iter.hasMoreElements()) {</span>
<span class="nc" id="L27772">                int mechWarriorId = iter.nextElement();</span>
<span class="nc" id="L27773">                Entity mw = game.getEntity(mechWarriorId);</span>

                // in some situations, a &quot;picked up&quot; mechwarrior won't actually exist
                // probably this is brought about by picking up a mechwarrior in a previous MekHQ scenario
                // then having the same unit get blown up in a subsequent scenario
                // in that case, we simply move on
<span class="nc bnc" id="L27779" title="All 2 branches missed.">                if(mw == null) {</span>
<span class="nc" id="L27780">                    continue;</span>
                }

<span class="nc" id="L27783">                mw.setDestroyed(true);</span>
                // We can safely remove these, as they can't be targeted
<span class="nc" id="L27785">                game.removeEntity(mw.getId(), condition);</span>
<span class="nc" id="L27786">                entityUpdate(mw.getId());</span>
<span class="nc" id="L27787">                send(createRemoveEntityPacket(mw.getId(), condition));</span>
<span class="nc" id="L27788">                r = new Report(6370);</span>
<span class="nc" id="L27789">                r.subject = mw.getId();</span>
<span class="nc" id="L27790">                r.addDesc(mw);</span>
<span class="nc" id="L27791">                vDesc.addElement(r);</span>
<span class="nc" id="L27792">            }</span>

            // make any remaining telemissiles operated by this entity
            // out of contact
<span class="nc bnc" id="L27796" title="All 2 branches missed.">            for (int missileId : entity.getTMTracker().getMissiles()) {</span>
<span class="nc" id="L27797">                Entity tm = game.getEntity(missileId);</span>
<span class="nc bnc" id="L27798" title="All 6 branches missed.">                if ((null != tm) &amp;&amp; !tm.isDestroyed() &amp;&amp; (tm instanceof TeleMissile)) {</span>
<span class="nc" id="L27799">                    ((TeleMissile) tm).setOutContact(true);</span>
<span class="nc" id="L27800">                    entityUpdate(tm.getId());</span>
                }
<span class="nc" id="L27802">            }</span>

            // Mechanized BA that could die on a 3+
<span class="nc" id="L27805">            ArrayList&lt;Entity&gt; externalUnits = entity.getExternalUnits();</span>

            // Handle escape of transported units.
<span class="nc bnc" id="L27808" title="All 2 branches missed.">            if (entity.getLoadedUnits().size() &gt; 0) {</span>
<span class="nc" id="L27809">                Coords curPos = entity.getPosition();</span>
<span class="nc" id="L27810">                int curFacing = entity.getFacing();</span>
<span class="nc bnc" id="L27811" title="All 2 branches missed.">                for (Entity other : entity.getLoadedUnits()) {</span>
                    //If the unit has been destroyed (as from a cargo hit), skip it
<span class="nc bnc" id="L27813" title="All 2 branches missed.">                    if (other.isDestroyed()) {</span>
<span class="nc" id="L27814">                        continue;</span>
                    }
                    // Can the other unit survive?
<span class="nc" id="L27817">                    boolean survived = false;</span>
<span class="nc bnc" id="L27818" title="All 2 branches missed.">                    if (entity instanceof Tank) {</span>
<span class="nc bnc" id="L27819" title="All 2 branches missed.">                        if ((entity.getMovementMode() == EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L27820" title="All 2 branches missed.">                                || (entity.getMovementMode() == EntityMovementMode.HYDROFOIL)) {</span>
<span class="nc bnc" id="L27821" title="All 2 branches missed.">                            if (other.getMovementMode() == EntityMovementMode.INF_UMU) {</span>
<span class="nc bnc" id="L27822" title="All 2 branches missed.">                                survived = Compute.d6() &lt;= 3;</span>
<span class="nc bnc" id="L27823" title="All 2 branches missed.">                            } else if (other.getMovementMode() == EntityMovementMode.INF_JUMP) {</span>
<span class="nc bnc" id="L27824" title="All 2 branches missed.">                                survived = Compute.d6() == 1;</span>
<span class="nc bnc" id="L27825" title="All 2 branches missed.">                            } else if (other.getMovementMode() == EntityMovementMode.VTOL) {</span>
<span class="nc bnc" id="L27826" title="All 2 branches missed.">                                survived = Compute.d6() &lt;= 2;</span>
                            }
<span class="nc bnc" id="L27828" title="All 2 branches missed.">                        } else if (entity.getMovementMode() == EntityMovementMode.SUBMARINE) {</span>
<span class="nc bnc" id="L27829" title="All 2 branches missed.">                            if (other.getMovementMode() == EntityMovementMode.INF_UMU) {</span>
<span class="nc bnc" id="L27830" title="All 2 branches missed.">                                survived = Compute.d6() == 1;</span>
                            }
                        } else {
<span class="nc bnc" id="L27833" title="All 2 branches missed.">                            survived = Compute.d6() &lt;= 4;</span>
                        }
<span class="nc bnc" id="L27835" title="All 2 branches missed.">                    } else if (entity instanceof Mech) {</span>
                        // mechanized BA can escape on a roll of 1 or 2
<span class="nc bnc" id="L27837" title="All 2 branches missed.">                        if (externalUnits.contains(other)) {</span>
<span class="nc bnc" id="L27838" title="All 2 branches missed.">                            survived = Compute.d6() &lt; 3;</span>
                        }
                    }
<span class="nc bnc" id="L27841" title="All 8 branches missed.">                    if (!survivable || (externalUnits.contains(other) &amp;&amp; !survived)</span>
                            //Don't unload from ejecting spacecraft. The crews aren't in their units...
<span class="nc bnc" id="L27843" title="All 2 branches missed.">                            || (ship != null &amp;&amp; ship.isEjecting())) {</span>
                        // Nope.
<span class="nc" id="L27845">                        other.setDestroyed(true);</span>
                        // We need to unload the unit, since it's ID goes away
<span class="nc" id="L27847">                        entity.unload(other);</span>
                        // Safe to remove, as they aren't targeted
<span class="nc" id="L27849">                        game.moveToGraveyard(other.getId());</span>
<span class="nc" id="L27850">                        send(createRemoveEntityPacket(other.getId(), condition));</span>
<span class="nc" id="L27851">                        r = new Report(6370);</span>
<span class="nc" id="L27852">                        r.subject = other.getId();</span>
<span class="nc" id="L27853">                        r.addDesc(other);</span>
<span class="nc" id="L27854">                        vDesc.addElement(r);</span>
                    }
                    // Can we unload the unit to the current hex?
                    // TODO : unloading into stacking violation is not
                    // explicitly prohibited in the BMRr.
<span class="nc bnc" id="L27859" title="All 2 branches missed.">                    else if ((null != Compute.stackingViolation(game, other.getId(), curPos))</span>
<span class="nc bnc" id="L27860" title="All 2 branches missed.">                             || other.isLocationProhibited(curPos)) {</span>
                        // Nope.
<span class="nc" id="L27862">                        other.setDestroyed(true);</span>
                        // We need to unload the unit, since it's ID goes away
<span class="nc" id="L27864">                        entity.unload(other);</span>
                        // Safe to remove, as they aren't targeted
<span class="nc" id="L27866">                        game.moveToGraveyard(other.getId());</span>
<span class="nc" id="L27867">                        send(createRemoveEntityPacket(other.getId(), condition));</span>
<span class="nc" id="L27868">                        r = new Report(6375);</span>
<span class="nc" id="L27869">                        r.subject = other.getId();</span>
<span class="nc" id="L27870">                        r.addDesc(other);</span>
<span class="nc" id="L27871">                        vDesc.addElement(r);</span>
                    } // End can-not-unload
                    else {
                        // The other unit survives.
<span class="nc" id="L27875">                        unloadUnit(entity, other, curPos, curFacing,</span>
<span class="nc" id="L27876">                                   entity.getElevation(), true, false);</span>
                    }

<span class="nc" id="L27879">                } // Handle the next transported unit.</span>

            } // End has-transported-unit

            // Handle transporting unit.
<span class="nc bnc" id="L27884" title="All 2 branches missed.">            if (Entity.NONE != entity.getTransportId()) {</span>
<span class="nc" id="L27885">                final Entity transport = game.getEntity(entity.getTransportId());</span>
<span class="nc" id="L27886">                Coords curPos = transport.getPosition();</span>
<span class="nc" id="L27887">                int curFacing = transport.getFacing();</span>
<span class="nc bnc" id="L27888" title="All 2 branches missed.">                if (!transport.isLargeCraft()) {</span>
<span class="nc" id="L27889">                    unloadUnit(transport, entity, curPos, curFacing, transport.getElevation());</span>
                }
<span class="nc" id="L27891">                entityUpdate(transport.getId());</span>

                // if this is the last fighter in a fighter squadron then remove
                // the squadron
<span class="nc bnc" id="L27895" title="All 2 branches missed.">                if ((transport instanceof FighterSquadron)</span>
<span class="nc bnc" id="L27896" title="All 2 branches missed.">                        &amp;&amp; transport.getSubEntities().orElse(Collections.emptyList()).isEmpty()) {</span>
<span class="nc" id="L27897">                    transport.setDestroyed(true);</span>
                    // Can't remove this here, otherwise later attacks will fail
                    //game.moveToGraveyard(transport.getId());
                    //entityUpdate(transport.getId());
                    //send(createRemoveEntityPacket(transport.getId(), condition));
<span class="nc" id="L27902">                    r = new Report(6365);</span>
<span class="nc" id="L27903">                    r.subject = transport.getId();</span>
<span class="nc" id="L27904">                    r.addDesc(transport);</span>
<span class="nc" id="L27905">                    r.add(&quot;fighter destruction&quot;);</span>
<span class="nc" id="L27906">                    vDesc.addElement(r);</span>
                }

            } // End unit-is-transported

            // Is this unit towing some trailers?
            // If so, disconnect them
<span class="nc bnc" id="L27913" title="All 2 branches missed.">            if (!entity.getAllTowedUnits().isEmpty()) {</span>
                //Find the first trailer in the list and drop it
                //this will disconnect all that follow too
<span class="nc" id="L27916">                Entity leadTrailer = game.getEntity(entity.getAllTowedUnits().get(0));</span>
<span class="nc" id="L27917">                disconnectUnit(entity, leadTrailer, entity.getPosition());</span>
            }

            // Is this unit a trailer being towed? If so, disconnect it from its tractor
<span class="nc bnc" id="L27921" title="All 2 branches missed.">            if (entity.getTractor() != Entity.NONE) {</span>
<span class="nc" id="L27922">                Entity tractor = game.getEntity(entity.getTractor());</span>
<span class="nc" id="L27923">                disconnectUnit(tractor, entity, tractor.getPosition());</span>
            }

            // Is this unit being swarmed?
<span class="nc" id="L27927">            final int swarmerId = entity.getSwarmAttackerId();</span>
<span class="nc bnc" id="L27928" title="All 2 branches missed.">            if (Entity.NONE != swarmerId) {</span>
<span class="nc" id="L27929">                final Entity swarmer = game.getEntity(swarmerId);</span>

<span class="nc" id="L27931">                swarmer.setSwarmTargetId(Entity.NONE);</span>
                // a unit that stopped swarming due to the swarmed unit dieing
                // should be able to move: setSwarmTargetId to Entity.None
                // changes done to true and unloaded to true, need to undo this
<span class="nc" id="L27935">                swarmer.setUnloaded(false);</span>
<span class="nc" id="L27936">                swarmer.setDone(false);</span>
<span class="nc" id="L27937">                entity.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L27938">                Report.addNewline(vDesc);</span>
<span class="nc" id="L27939">                r = new Report(6380);</span>
<span class="nc" id="L27940">                r.subject = swarmerId;</span>
<span class="nc" id="L27941">                r.addDesc(swarmer);</span>
<span class="nc" id="L27942">                vDesc.addElement(r);</span>
                // Swarming infantry shouldn't take damage when their target dies
                // http://bg.battletech.com/forums/total-warfare/swarming-question
<span class="nc" id="L27945">                entityUpdate(swarmerId);</span>
            }

            // Is this unit swarming somebody?
<span class="nc" id="L27949">            final int swarmedId = entity.getSwarmTargetId();</span>
<span class="nc bnc" id="L27950" title="All 2 branches missed.">            if (Entity.NONE != swarmedId) {</span>
<span class="nc" id="L27951">                final Entity swarmed = game.getEntity(swarmedId);</span>
<span class="nc" id="L27952">                swarmed.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L27953">                entity.setSwarmTargetId(Entity.NONE);</span>
<span class="nc" id="L27954">                r = new Report(6385);</span>
<span class="nc" id="L27955">                r.subject = swarmed.getId();</span>
<span class="nc" id="L27956">                r.addDesc(swarmed);</span>
<span class="nc" id="L27957">                vDesc.addElement(r);</span>
<span class="nc" id="L27958">                entityUpdate(swarmedId);</span>
            }

            // If in a grapple, release both mechs
<span class="nc bnc" id="L27962" title="All 2 branches missed.">            if (entity.getGrappled() != Entity.NONE) {</span>
<span class="nc" id="L27963">                int grappler = entity.getGrappled();</span>
<span class="nc" id="L27964">                entity.setGrappled(Entity.NONE, false);</span>
<span class="nc" id="L27965">                Entity e = game.getEntity(grappler);</span>
<span class="nc bnc" id="L27966" title="All 2 branches missed.">                if (e != null) {</span>
<span class="nc" id="L27967">                    e.setGrappled(Entity.NONE, false);</span>
                }
<span class="nc" id="L27969">                entityUpdate(grappler);</span>
            }
        } // End entity-not-already-destroyed.

        // if using battlefield wreckage rules, then the destruction of this
        // unit
        // might convert the hex to rough
<span class="nc" id="L27976">        Coords curPos = entity.getPosition();</span>
<span class="nc" id="L27977">        IHex entityHex = game.getBoard().getHex(curPos);</span>
<span class="nc bnc" id="L27978" title="All 4 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_BATTLE_WRECK)</span>
<span class="nc bnc" id="L27979" title="All 6 branches missed.">                &amp;&amp; (entityHex != null) &amp;&amp; game.getBoard().onGround()</span>
                &amp;&amp; !((entity instanceof Infantry) || (entity instanceof Protomech))) {
            // large support vees will create ultra rough, otherwise rough
<span class="nc bnc" id="L27982" title="All 2 branches missed.">            if (entity instanceof LargeSupportTank) {</span>
<span class="nc bnc" id="L27983" title="All 2 branches missed.">                if (entityHex.terrainLevel(Terrains.ROUGH) &lt; 2) {</span>
<span class="nc" id="L27984">                    entityHex.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L27985">                            .createTerrain(Terrains.ROUGH, 2));</span>
<span class="nc" id="L27986">                    sendChangedHex(curPos);</span>
                }
<span class="nc bnc" id="L27988" title="All 4 branches missed.">            } else if ((entity.getWeight() &gt;= 40) &amp;&amp; !entityHex.containsTerrain(Terrains.ROUGH)) {</span>
<span class="nc" id="L27989">                entityHex.addTerrain(Terrains.getTerrainFactory()</span>
<span class="nc" id="L27990">                        .createTerrain(Terrains.ROUGH, 1));</span>
<span class="nc" id="L27991">                sendChangedHex(curPos);</span>
            }
        }

        // update our entity, so clients have correct data needed for MekWars stuff
<span class="nc" id="L27996">        entityUpdate(entity.getId());</span>

<span class="nc" id="L27998">        return vDesc;</span>
    }

    /**
     * Makes a piece of equipment on a mech explode! POW! This expects either
     * ammo, or an explosive weapon. Returns a vector of Report objects.
     */
    private Vector&lt;Report&gt; explodeEquipment(Entity en, int loc, int slot) {
<span class="nc" id="L28006">        CriticalSlot critSlot = en.getCritical(loc, slot);</span>
<span class="nc" id="L28007">        Vector&lt;Report&gt; reports = explodeEquipment(en, loc, critSlot.getMount());</span>
<span class="nc bnc" id="L28008" title="All 2 branches missed.">        if (critSlot.getMount2() != null) {</span>
<span class="nc" id="L28009">            reports.addAll(explodeEquipment(en, loc, critSlot.getMount2()));</span>
        }
<span class="nc" id="L28011">        return reports;</span>
    }

    /**
     * Explodes a piece of equipment on the unit.
     */
    public Vector&lt;Report&gt; explodeEquipment(Entity en, int loc, Mounted mounted) { 
<span class="nc" id="L28018">        return explodeEquipment(en, loc, mounted, false);</span>
    }
    
    /**
     * Makes a piece of equipment on a mech explode! POW! This expects either
     * ammo, or an explosive weapon. Returns a vector of Report objects.
     * Possible to override 'is explosive' check
     */
    public Vector&lt;Report&gt; explodeEquipment(Entity en, int loc, Mounted mounted, boolean overrideExplosiveCheck) {
<span class="nc" id="L28027">        final String METHOD_NAME = &quot;explodeEquipment(Entity,int,Mounted)&quot;;</span>
<span class="nc" id="L28028">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        // is this already destroyed?
<span class="nc bnc" id="L28030" title="All 2 branches missed.">        if (mounted.isDestroyed()) {</span>
<span class="nc" id="L28031">            MegaMek.getLogger().error(&quot;Called on destroyed equipment(&quot; + mounted.getName() + &quot;)&quot;);</span>
<span class="nc" id="L28032">            return vDesc;</span>
        }

        // Special case: LAM bomb bays explode the bomb stored there, which may involve going through a
        // launch weapon to the bomb ammo.
<span class="nc bnc" id="L28037" title="All 4 branches missed.">        if ((mounted.getType() instanceof MiscType) &amp;&amp; mounted.getType().hasFlag(MiscType.F_BOMB_BAY)) {</span>
<span class="nc bnc" id="L28038" title="All 2 branches missed.">            while (mounted.getLinked() != null) {</span>
<span class="nc" id="L28039">                mounted = mounted.getLinked();</span>
            }
            // Fuel tank explodes on 2d6 roll of 10+
<span class="nc bnc" id="L28042" title="All 4 branches missed.">            if ((mounted.getType() instanceof MiscType) &amp;&amp; mounted.getType().hasFlag(MiscType.F_FUEL)) {</span>
<span class="nc" id="L28043">                Report r = new Report(9120);</span>
<span class="nc" id="L28044">                r.subject = en.getId();</span>
<span class="nc" id="L28045">                int boomTarget = 10;</span>
                // check for possible explosion
<span class="nc" id="L28047">                int fuelRoll = Compute.d6(2);</span>
<span class="nc bnc" id="L28048" title="All 2 branches missed.">                r.choose(fuelRoll &gt;= boomTarget);</span>
<span class="nc bnc" id="L28049" title="All 2 branches missed.">                if (fuelRoll &gt;= boomTarget) {</span>
<span class="nc" id="L28050">                    r.choose(true);</span>
<span class="nc" id="L28051">                    vDesc.add(r);</span>
                } else {
<span class="nc" id="L28053">                    r.choose(false);</span>
<span class="nc" id="L28054">                    vDesc.add(r);</span>
<span class="nc" id="L28055">                    return vDesc;</span>
                }
            }
        }

<span class="nc bnc" id="L28060" title="All 4 branches missed.">        if(!overrideExplosiveCheck &amp;&amp; !mounted.getType().isExplosive(mounted, false)) {</span>
<span class="nc" id="L28061">            return vDesc;</span>
        }

        // Inferno ammo causes heat buildup as well as the damage
<span class="nc bnc" id="L28065" title="All 2 branches missed.">        if ((mounted.getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L28066" title="All 2 branches missed.">                &amp;&amp; ((((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_SRM)</span>
<span class="nc bnc" id="L28067" title="All 2 branches missed.">                        || (((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_SRM_IMP)</span>
<span class="nc bnc" id="L28068" title="All 2 branches missed.">                        || (((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_IATM)</span>
<span class="nc bnc" id="L28069" title="All 2 branches missed.">                        || (((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_MML))</span>
<span class="nc bnc" id="L28070" title="All 2 branches missed.">                &amp;&amp; (((AmmoType) mounted.getType()).getMunitionType() == AmmoType.M_INFERNO)</span>
<span class="nc bnc" id="L28071" title="All 2 branches missed.">                &amp;&amp; (mounted.getHittableShotsLeft() &gt; 0)) {</span>
<span class="nc" id="L28072">            en.heatBuildup += Math.min(mounted.getExplosionDamage(), 30);</span>
        }

        // Inferno bombs in LAM bomb bays
<span class="nc bnc" id="L28076" title="All 2 branches missed.">        if ((mounted.getType() instanceof BombType)</span>
<span class="nc bnc" id="L28077" title="All 2 branches missed.">                &amp;&amp; (((BombType)mounted.getType()).getBombType() == BombType.B_INFERNO)) {</span>
<span class="nc" id="L28078">            en.heatBuildup += Math.min(mounted.getExplosionDamage(), 30);</span>
        }

        // determine and deal damage
<span class="nc" id="L28082">        int damage = mounted.getExplosionDamage();</span>

        // Smoke ammo halves damage
<span class="nc bnc" id="L28085" title="All 2 branches missed.">        if ((mounted.getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L28086" title="All 2 branches missed.">                &amp;&amp; ((((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_SRM)</span>
<span class="nc bnc" id="L28087" title="All 2 branches missed.">                        || (((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_SRM_IMP)</span>
<span class="nc bnc" id="L28088" title="All 2 branches missed.">                        || (((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_LRM)</span>
<span class="nc bnc" id="L28089" title="All 2 branches missed.">                        || (((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_LRM_IMP))</span>
<span class="nc bnc" id="L28090" title="All 2 branches missed.">                &amp;&amp; (((AmmoType) mounted.getType()).getMunitionType() == AmmoType.M_SMOKE_WARHEAD)</span>
<span class="nc bnc" id="L28091" title="All 2 branches missed.">                &amp;&amp; (mounted.getHittableShotsLeft() &gt; 0)) {</span>
<span class="nc" id="L28092">            damage = ((mounted.getExplosionDamage()) / 2);</span>
        }
        // coolant explodes for 2 damage and reduces heat by 3
<span class="nc bnc" id="L28095" title="All 2 branches missed.">        if ((mounted.getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L28096" title="All 2 branches missed.">                &amp;&amp; ((((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_VEHICLE_FLAMER)</span>
<span class="nc bnc" id="L28097" title="All 2 branches missed.">                || (((AmmoType) mounted.getType()).getAmmoType() == AmmoType.T_HEAVY_FLAMER))</span>
<span class="nc bnc" id="L28098" title="All 2 branches missed.">                &amp;&amp; (((AmmoType) mounted.getType()).getMunitionType() == AmmoType.M_COOLANT)</span>
<span class="nc bnc" id="L28099" title="All 2 branches missed.">                &amp;&amp; (mounted.getHittableShotsLeft() &gt; 0)) {</span>
<span class="nc" id="L28100">            damage = 2;</span>
<span class="nc" id="L28101">            en.coolFromExternal += 3;</span>
        }

        // divide damage by 10 for aeros, per TW rules on pg. 161
<span class="nc bnc" id="L28105" title="All 2 branches missed.">        if (en instanceof Aero) {</span>
<span class="nc" id="L28106">            int newDamage = (int) Math.floor(damage / 10.0);</span>
<span class="nc bnc" id="L28107" title="All 4 branches missed.">            if ((newDamage == 0) &amp;&amp; (damage &gt; 0)) {</span>
<span class="nc" id="L28108">                damage = 1;</span>
            } else {
<span class="nc" id="L28110">                damage = newDamage;</span>
            }
        }

<span class="nc bnc" id="L28114" title="All 2 branches missed.">        if (damage &lt;= 0) {</span>
<span class="nc" id="L28115">            return vDesc;</span>
        }

<span class="nc" id="L28118">        Report r = new Report(6390);</span>
<span class="nc" id="L28119">        r.subject = en.getId();</span>
<span class="nc" id="L28120">        r.add(mounted.getName());</span>
<span class="nc" id="L28121">        r.add(damage);</span>
<span class="nc" id="L28122">        r.indent(3);</span>
<span class="nc" id="L28123">        vDesc.addElement(r);</span>
        // Mounted is a weapon and has Hot-Loaded ammo in it and it exploded now
        // we need to roll for chain reaction
<span class="nc bnc" id="L28126" title="All 4 branches missed.">        if ((mounted.getType() instanceof WeaponType) &amp;&amp; mounted.isHotLoaded()) {</span>
<span class="nc" id="L28127">            int roll = Compute.d6(2);</span>
<span class="nc" id="L28128">            int ammoExploded = 0;</span>
<span class="nc" id="L28129">            r = new Report(6077);</span>
<span class="nc" id="L28130">            r.subject = en.getId();</span>
<span class="nc" id="L28131">            r.add(roll);</span>
<span class="nc" id="L28132">            r.indent(2);</span>
<span class="nc" id="L28133">            vDesc.addElement(r);</span>

            // roll of 2-5 means a chain reaction happened
<span class="nc bnc" id="L28136" title="All 2 branches missed.">            if (roll &lt; 6) {</span>
<span class="nc bnc" id="L28137" title="All 2 branches missed.">                for (Mounted ammo : en.getAmmo()) {</span>
<span class="nc bnc" id="L28138" title="All 4 branches missed.">                    if ((ammo.getLocation() == loc) &amp;&amp; (ammo.getExplosionDamage() &gt; 0)</span>
                            // Dead-Fire ammo bins are designed not to explode
                            // from the chain reaction
                            // Of Critted Launchers with DFM or HotLoaded ammo.
<span class="nc bnc" id="L28142" title="All 2 branches missed.">                            &amp;&amp; (((AmmoType) ammo.getType()).getMunitionType() != AmmoType.M_DEAD_FIRE)) {</span>
<span class="nc" id="L28143">                        ammoExploded++;</span>
<span class="nc" id="L28144">                        vDesc.addAll(this.explodeEquipment(en, loc, ammo));</span>
<span class="nc" id="L28145">                        break;</span>
                    }
<span class="nc" id="L28147">                }</span>
<span class="nc bnc" id="L28148" title="All 2 branches missed.">                if (ammoExploded == 0) {</span>
<span class="nc" id="L28149">                    r = new Report(6078);</span>
<span class="nc" id="L28150">                    r.subject = en.getId();</span>
<span class="nc" id="L28151">                    r.indent(2);</span>
<span class="nc" id="L28152">                    vDesc.addElement(r);</span>
                }
            } else {
<span class="nc" id="L28155">                r = new Report(6079);</span>
<span class="nc" id="L28156">                r.subject = en.getId();</span>
<span class="nc" id="L28157">                r.indent(2);</span>
<span class="nc" id="L28158">                vDesc.addElement(r);</span>
            }
        }

<span class="nc" id="L28162">        HitData hit = new HitData(loc);</span>
        // check to determine whether this is capital scale if we have a capital
        // scale entity
<span class="nc bnc" id="L28165" title="All 2 branches missed.">        if (mounted.getType() instanceof AmmoType) {</span>
<span class="nc bnc" id="L28166" title="All 2 branches missed.">            if (((AmmoType) mounted.getType()).isCapital()) {</span>
<span class="nc" id="L28167">                hit.setCapital(true);</span>
            }
        }

        // exploding RISC laser pulse module should cause no normal crits, just
        // automatically crit the first uncritted crit of the laser it's
        // attached to
<span class="nc bnc" id="L28174" title="All 4 branches missed.">        if ((mounted.getType() instanceof MiscType)  &amp;&amp; mounted.getType().hasFlag(MiscType.F_RISC_LASER_PULSE_MODULE)) {</span>
<span class="nc" id="L28175">            hit.setEffect(HitData.EFFECT_NO_CRITICALS);</span>
<span class="nc" id="L28176">            Mounted laser = mounted.getLinkedBy();</span>
<span class="nc bnc" id="L28177" title="All 2 branches missed.">            if (en instanceof Mech) {</span>
<span class="nc bnc" id="L28178" title="All 2 branches missed.">                for (int slot = 0; slot &lt; en.getNumberOfCriticals(laser.getLocation()); slot++) {</span>
<span class="nc" id="L28179">                    CriticalSlot cs = en.getCritical(laser.getLocation(), slot);</span>
<span class="nc bnc" id="L28180" title="All 4 branches missed.">                    if ((cs.getType() == CriticalSlot.TYPE_EQUIPMENT) &amp;&amp; cs.getMount().equals(laser)</span>
<span class="nc bnc" id="L28181" title="All 2 branches missed.">                            &amp;&amp; cs.isHittable()) {</span>
<span class="nc" id="L28182">                        cs.setHit(true);</span>
<span class="nc" id="L28183">                        cs.setRepairable(true);</span>
<span class="nc" id="L28184">                        break;</span>
                    }
                }
            }
<span class="nc" id="L28188">            laser.setHit(true);</span>
        }

<span class="nc" id="L28191">        mounted.setShotsLeft(0);</span>

<span class="nc" id="L28193">        int pilotDamage = 2;</span>
<span class="nc bnc" id="L28194" title="All 2 branches missed.">        if (en instanceof Aero) {</span>
<span class="nc" id="L28195">            pilotDamage = 1;</span>
        }
<span class="nc bnc" id="L28197" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_CASE_PILOT_DAMAGE)</span>
<span class="nc bnc" id="L28198" title="All 4 branches missed.">                &amp;&amp; (en.locationHasCase(hit.getLocation()) || en.hasCASEII(hit.getLocation()))) {</span>
<span class="nc" id="L28199">            pilotDamage = 1;</span>
        }
<span class="nc bnc" id="L28201" title="All 2 branches missed.">        if (en.hasAbility(OptionsConstants.MISC_PAIN_RESISTANCE)</span>
<span class="nc bnc" id="L28202" title="All 2 branches missed.">                || en.hasAbility(OptionsConstants.MISC_IRON_MAN)) {</span>
<span class="nc" id="L28203">            pilotDamage -= 1;</span>
        }
        // tanks only take pilot damage when using BVDNI or VDNI
<span class="nc bnc" id="L28206" title="All 4 branches missed.">        if ((en instanceof Tank) &amp;&amp; !(en.hasAbility(OptionsConstants.MD_VDNI)</span>
<span class="nc bnc" id="L28207" title="All 2 branches missed.">                || en.hasAbility(OptionsConstants.MD_BVDNI))) {</span>
<span class="nc" id="L28208">            pilotDamage = 0;</span>
        }
<span class="nc bnc" id="L28210" title="All 2 branches missed.">        if (!en.hasAbility(OptionsConstants.MD_PAIN_SHUNT)) {</span>
<span class="nc" id="L28211">            vDesc.addAll(damageCrew(en, pilotDamage, en.getCrew().getCurrentPilotIndex()));</span>
        }
<span class="nc bnc" id="L28213" title="All 4 branches missed.">        if (en.getCrew().isDoomed() || en.getCrew().isDead()) {</span>
<span class="nc" id="L28214">            vDesc.addAll(destroyEntity(en, &quot;crew death&quot;, true));</span>
        } else {
<span class="nc" id="L28216">            Report.addNewline(vDesc);</span>
        }

<span class="nc" id="L28219">        Vector&lt;Report&gt; newReports = damageEntity(en, hit, damage, true);</span>
<span class="nc bnc" id="L28220" title="All 2 branches missed.">        for (Report rep : newReports) {</span>
<span class="nc" id="L28221">            rep.indent(2);</span>
<span class="nc" id="L28222">        }</span>
<span class="nc" id="L28223">        vDesc.addAll(newReports);</span>
<span class="nc" id="L28224">        Report.addNewline(vDesc);</span>

<span class="nc" id="L28226">        return vDesc;</span>
    }

    /**
     * Makes one slot of ammo, determined by certain rules, explode on a mech.
     */
    Vector&lt;Report&gt; explodeAmmoFromHeat(Entity entity) {
<span class="nc" id="L28233">        int damage = 0;</span>
<span class="nc" id="L28234">        int rack = 0;</span>
<span class="nc" id="L28235">        int boomloc = -1;</span>
<span class="nc" id="L28236">        int boomslot = -1;</span>
<span class="nc" id="L28237">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>

<span class="nc bnc" id="L28239" title="All 2 branches missed.">        for (int j = 0; j &lt; entity.locations(); j++) {</span>
<span class="nc bnc" id="L28240" title="All 2 branches missed.">            for (int k = 0; k &lt; entity.getNumberOfCriticals(j); k++) {</span>
<span class="nc" id="L28241">                CriticalSlot cs = entity.getCritical(j, k);</span>
<span class="nc bnc" id="L28242" title="All 6 branches missed.">                if ((cs == null) || cs.isDestroyed() || cs.isHit()</span>
<span class="nc bnc" id="L28243" title="All 2 branches missed.">                        || (cs.getType() != CriticalSlot.TYPE_EQUIPMENT)) {</span>
<span class="nc" id="L28244">                    continue;</span>
                }
<span class="nc" id="L28246">                Mounted mounted = cs.getMount();</span>
<span class="nc bnc" id="L28247" title="All 4 branches missed.">                if ((mounted == null) || (!(mounted.getType() instanceof AmmoType))) {</span>
<span class="nc" id="L28248">                    continue;</span>
                }
<span class="nc" id="L28250">                AmmoType atype = (AmmoType) mounted.getType();</span>
<span class="nc bnc" id="L28251" title="All 2 branches missed.">                if (!atype.isExplosive(mounted)) {</span>
<span class="nc" id="L28252">                    continue;</span>
                }
                // coolant pods and flamer coolant ammo don't explode from heat
<span class="nc bnc" id="L28255" title="All 2 branches missed.">                if ((atype.getAmmoType() == AmmoType.T_COOLANT_POD)</span>
<span class="nc bnc" id="L28256" title="All 2 branches missed.">                        || (((atype.getAmmoType() == AmmoType.T_VEHICLE_FLAMER)</span>
<span class="nc bnc" id="L28257" title="All 2 branches missed.">                                || (atype.getAmmoType() == AmmoType.T_HEAVY_FLAMER))</span>
<span class="nc bnc" id="L28258" title="All 2 branches missed.">                                &amp;&amp; (atype.getMunitionType() == AmmoType.M_COOLANT))) {</span>
<span class="nc" id="L28259">                    continue;</span>
                }
                // ignore empty, destroyed, or missing bins
<span class="nc bnc" id="L28262" title="All 2 branches missed.">                if (mounted.getHittableShotsLeft() == 0) {</span>
<span class="nc" id="L28263">                    continue;</span>
                }
                // TW page 160, compare one rack's
                // damage. Ties go to most rounds.
<span class="nc" id="L28267">                int newRack = atype.getDamagePerShot() * atype.getRackSize();</span>
<span class="nc" id="L28268">                int newDamage = mounted.getExplosionDamage();</span>
<span class="nc" id="L28269">                Mounted mount2 = cs.getMount2();</span>
<span class="nc bnc" id="L28270" title="All 4 branches missed.">                if ((mount2 != null) &amp;&amp; (mount2.getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L28271" title="All 2 branches missed.">                        &amp;&amp; (mount2.getHittableShotsLeft() &gt; 0)) {</span>
                    // must be for same weaponType, so rackSize stays
<span class="nc" id="L28273">                    atype = (AmmoType) mount2.getType();</span>
<span class="nc" id="L28274">                    newRack += atype.getDamagePerShot() * atype.getRackSize();</span>
<span class="nc" id="L28275">                    newDamage += mount2.getExplosionDamage();</span>
                }
<span class="nc bnc" id="L28277" title="All 8 branches missed.">                if (!mounted.isHit()</span>
                        &amp;&amp; ((rack &lt; newRack) || ((rack == newRack) &amp;&amp; (damage &lt; newDamage)))) {
<span class="nc" id="L28279">                    rack = newRack;</span>
<span class="nc" id="L28280">                    damage = newDamage;</span>
<span class="nc" id="L28281">                    boomloc = j;</span>
<span class="nc" id="L28282">                    boomslot = k;</span>
                }
            }
        }
<span class="nc bnc" id="L28286" title="All 4 branches missed.">        if ((boomloc != -1) &amp;&amp; (boomslot != -1)) {</span>
<span class="nc" id="L28287">            CriticalSlot slot = entity.getCritical(boomloc, boomslot);</span>
<span class="nc" id="L28288">            slot.setHit(true);</span>
<span class="nc" id="L28289">            slot.getMount().setHit(true);</span>
<span class="nc bnc" id="L28290" title="All 2 branches missed.">            if (slot.getMount2() != null) {</span>
<span class="nc" id="L28291">                slot.getMount2().setHit(true);</span>
            }
<span class="nc" id="L28293">            vDesc.addAll(explodeEquipment(entity, boomloc, boomslot));</span>
<span class="nc" id="L28294">        } else {</span>
            // Luckily, there is no ammo to explode.
<span class="nc" id="L28296">            Report r = new Report(5105);</span>
<span class="nc" id="L28297">            r.subject = entity.getId();</span>
<span class="nc" id="L28298">            r.indent();</span>
<span class="nc" id="L28299">            vDesc.addElement(r);</span>
        }
<span class="nc" id="L28301">        return vDesc;</span>
    }

    /**
     * Makes a mech fall.
     *
     * @param entity
     *            The Entity that is falling. It is expected that the Entity's
     *            position and elevation reflect the state prior to the fall
     * @param fallPos
     *            The location that the Entity is falling into.
     * @param fallHeight
     *            The height that Entity is falling.
     * @param facing
     *            The facing of the fall. Used to determine the the hit location
     *            and also determines facing after the fall (used as an offset
     *            of the Entity's current facing).
     * @param roll
     *            The PSR required to avoid damage to the pilot/crew.
     * @param intoBasement
     *            Flag that determines whether this is a fall into a basement or
     *            not.
     */
    private Vector&lt;Report&gt; doEntityFall(Entity entity, Coords fallPos, int fallHeight, int facing,
                                        PilotingRollData roll, boolean intoBasement, boolean fromCliff) {
<span class="nc" id="L28326">        entity.setFallen(true);</span>

<span class="nc" id="L28328">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
        Report r;

<span class="nc" id="L28331">        IHex fallHex = game.getBoard().getHex(fallPos);</span>

<span class="nc" id="L28333">        boolean handlingBasement = false;</span>
<span class="nc" id="L28334">        int damageTable = ToHitData.HIT_NORMAL;</span>

        // we don't need to deal damage yet, if the entity is doing DFA
<span class="nc bnc" id="L28337" title="All 2 branches missed.">        if (entity.isMakingDfa()) {</span>
<span class="nc" id="L28338">            r = new Report(2305);</span>
<span class="nc" id="L28339">            r.subject = entity.getId();</span>
<span class="nc" id="L28340">            vPhaseReport.add(r);</span>
<span class="nc" id="L28341">            entity.setProne(true);</span>
<span class="nc" id="L28342">            return vPhaseReport;</span>
        }

        // facing after fall
        String side;
        int table;
<span class="nc bnc" id="L28348" title="All 4 branches missed.">        switch (facing) {</span>
            case 1:
            case 2:
<span class="nc" id="L28351">                side = &quot;right side&quot;;</span>
<span class="nc" id="L28352">                table = ToHitData.SIDE_RIGHT;</span>
<span class="nc" id="L28353">                break;</span>
            case 3:
<span class="nc" id="L28355">                side = &quot;rear&quot;;</span>
<span class="nc" id="L28356">                table = ToHitData.SIDE_REAR;</span>
<span class="nc" id="L28357">                break;</span>
            case 4:
            case 5:
<span class="nc" id="L28360">                side = &quot;left side&quot;;</span>
<span class="nc" id="L28361">                table = ToHitData.SIDE_LEFT;</span>
<span class="nc" id="L28362">                break;</span>
            case 0:
            default:
<span class="nc" id="L28365">                side = &quot;front&quot;;</span>
<span class="nc" id="L28366">                table = ToHitData.SIDE_FRONT;</span>
        }

<span class="nc" id="L28369">        int waterDepth = 0;</span>
<span class="nc bnc" id="L28370" title="All 2 branches missed.">        if (fallHex.containsTerrain(Terrains.WATER)) {</span>
            // *Only* use this if there actually is water in the hex, otherwise
            // we get ITerrain.LEVEL_NONE, i.e. Integer.minValue...
<span class="nc" id="L28373">            waterDepth = fallHex.terrainLevel(Terrains.WATER);</span>
        }
<span class="nc" id="L28375">        boolean fallOntoBridge = false;</span>
        // only fall onto the bridge if we were in the hex and on it,
        // or we fell from a hex that the bridge exits to
<span class="nc bnc" id="L28378" title="All 4 branches missed.">        if ((entity.climbMode() &amp;&amp; (entity.getPosition() != fallPos)</span>
<span class="nc bnc" id="L28379" title="All 2 branches missed.">                &amp;&amp; fallHex.containsTerrain(Terrains.BRIDGE)</span>
<span class="nc bnc" id="L28380" title="All 2 branches missed.">                &amp;&amp; fallHex.containsTerrainExit(Terrains.BRIDGE, fallPos.direction(entity.getPosition())))</span>
<span class="nc bnc" id="L28381" title="All 2 branches missed.">                || (entity.getElevation() == fallHex.terrainLevel(Terrains.BRIDGE_ELEV))) {</span>
<span class="nc" id="L28382">            fallOntoBridge = true;</span>
        }
<span class="nc" id="L28384">        int bridgeElev = fallHex.terrainLevel(Terrains.BRIDGE_ELEV);</span>
<span class="nc" id="L28385">        int buildingElev = fallHex.terrainLevel(Terrains.BLDG_ELEV);</span>
<span class="nc" id="L28386">        int damageHeight = fallHeight;</span>
<span class="nc" id="L28387">        int newElevation = 0;</span>

        // we might have to check if the building/bridge we are falling onto
        // collapses
<span class="nc" id="L28391">        boolean checkCollapse = false;</span>

<span class="nc bnc" id="L28393" title="All 4 branches missed.">        if ((entity.getElevation() &gt;= buildingElev) &amp;&amp; (buildingElev &gt;= 0)) {</span>
            // fallHeight should already reflect this
<span class="nc" id="L28395">            newElevation = buildingElev;</span>
<span class="nc" id="L28396">            checkCollapse = true;</span>
<span class="nc bnc" id="L28397" title="All 6 branches missed.">        } else if (fallOntoBridge &amp;&amp; (entity.getElevation() &gt;= bridgeElev) &amp;&amp; (bridgeElev &gt;= 0)) {</span>
            // fallHeight should already reflect this
<span class="nc" id="L28399">            waterDepth = 0;</span>
<span class="nc" id="L28400">            newElevation = fallHex.terrainLevel(Terrains.BRIDGE_ELEV);</span>
<span class="nc" id="L28401">            checkCollapse = true;</span>
<span class="nc bnc" id="L28402" title="All 4 branches missed.">        } else if (fallHex.containsTerrain(Terrains.ICE) &amp;&amp; (entity.getElevation() == 0)) {</span>
<span class="nc" id="L28403">            waterDepth = 0;</span>
<span class="nc" id="L28404">            newElevation = 0;</span>
            // If we are in a basement, we are at a negative elevation, and so
            // setting newElevation = 0 will cause us to &quot;fall up&quot;
<span class="nc bnc" id="L28407" title="All 2 branches missed.">        } else if ((entity.getMovementMode() != EntityMovementMode.VTOL)</span>
<span class="nc bnc" id="L28408" title="All 2 branches missed.">                   &amp;&amp; (game.getBoard().getBuildingAt(fallPos) != null)) {</span>
<span class="nc" id="L28409">            newElevation = entity.getElevation();</span>
        }
        // HACK: if the destination hex is water, assume that the fall height given is
        // to the floor of the hex, and modify it so that it's to the surface
<span class="nc bnc" id="L28413" title="All 2 branches missed.">        else if (waterDepth &gt; 0) {</span>
<span class="nc" id="L28414">            damageHeight = fallHeight - waterDepth;</span>
<span class="nc" id="L28415">            newElevation = -waterDepth;</span>
        }
        // only do these basement checks if we didn't fall onto the building
        // from above
<span class="nc bnc" id="L28419" title="All 2 branches missed.">        if (intoBasement) {</span>
<span class="nc" id="L28420">            Building bldg = game.getBoard().getBuildingAt(fallPos);</span>
<span class="nc" id="L28421">            BasementType basement = bldg.getBasement(fallPos);</span>
<span class="nc bnc" id="L28422" title="All 4 branches missed.">            if ((basement != BasementType.NONE) &amp;&amp; (basement != BasementType.ONE_DEEP_NORMALINFONLY)</span>
<span class="nc bnc" id="L28423" title="All 4 branches missed.">                    &amp;&amp; (entity.getElevation() == 0) &amp;&amp; (bldg.getBasementCollapsed(fallPos))) {</span>

<span class="nc bnc" id="L28425" title="All 2 branches missed.">                if (fallHex.depth(true) == 0) {</span>
<span class="nc" id="L28426">                    MegaMek.getLogger().error(&quot;Entity &quot; + entity.getDisplayName() + &quot; is falling into a depth &quot;</span>
<span class="nc" id="L28427">                            + fallHex.depth(true) + &quot; basement -- not allowed!!&quot;);</span>
<span class="nc" id="L28428">                    return vPhaseReport;</span>
                }
<span class="nc" id="L28430">                damageHeight = basement.getDepth();</span>

<span class="nc" id="L28432">                newElevation = newElevation - damageHeight;</span>

<span class="nc" id="L28434">                handlingBasement = true;</span>
                // May have to adjust hit table for 'mechs
<span class="nc bnc" id="L28436" title="All 2 branches missed.">                if (entity instanceof Mech) {</span>
<span class="nc bnc" id="L28437" title="All 4 branches missed.">                    if ((basement == BasementType.TWO_DEEP_FEET)</span>
                            || (basement == BasementType.ONE_DEEP_FEET)) {
<span class="nc" id="L28439">                        damageTable = ToHitData.HIT_KICK;</span>
<span class="nc bnc" id="L28440" title="All 4 branches missed.">                    } else if ((basement == BasementType.TWO_DEEP_HEAD)</span>
                            || (basement == BasementType.ONE_DEEP_HEAD)) {
<span class="nc" id="L28442">                        damageTable = ToHitData.HIT_PUNCH;</span>
                    } else {
<span class="nc" id="L28444">                        damageTable = ToHitData.HIT_NORMAL;</span>
                    }
                }
            }
        }
<span class="nc bnc" id="L28449" title="All 2 branches missed.">        if (entity instanceof Protomech) {</span>
<span class="nc" id="L28450">            damageTable = ToHitData.HIT_SPECIAL_PROTO;</span>
        }
        // Falling into water instantly destroys most non-mechs
<span class="nc bnc" id="L28453" title="All 6 branches missed.">        if ((waterDepth &gt; 0)</span>
            &amp;&amp; !(entity instanceof Mech)
            &amp;&amp; !(entity instanceof Protomech)
<span class="nc bnc" id="L28456" title="All 4 branches missed.">            &amp;&amp; !((entity.getRunMP() &gt; 0) &amp;&amp; (entity.getMovementMode() == EntityMovementMode.HOVER))</span>
<span class="nc bnc" id="L28457" title="All 2 branches missed.">            &amp;&amp; (entity.getMovementMode() != EntityMovementMode.HYDROFOIL)</span>
<span class="nc bnc" id="L28458" title="All 2 branches missed.">            &amp;&amp; (entity.getMovementMode() != EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L28459" title="All 2 branches missed.">            &amp;&amp; (entity.getMovementMode() != EntityMovementMode.SUBMARINE)</span>
<span class="nc bnc" id="L28460" title="All 2 branches missed.">            &amp;&amp; (entity.getMovementMode() != EntityMovementMode.INF_UMU)) {</span>
<span class="nc" id="L28461">            vPhaseReport.addAll(destroyEntity(entity, &quot;a watery grave&quot;, false));</span>
<span class="nc" id="L28462">            return vPhaseReport;</span>
        }

        // set how deep the mech has fallen
<span class="nc bnc" id="L28466" title="All 2 branches missed.">        if (entity instanceof Mech) {</span>
<span class="nc" id="L28467">            Mech mech = (Mech) entity;</span>
<span class="nc" id="L28468">            mech.setLevelsFallen(damageHeight + waterDepth + 1);</span>
            // an industrial mech now needs to check for a crit at the end of
            // the turn
<span class="nc bnc" id="L28471" title="All 2 branches missed.">            if (mech.isIndustrial()) {</span>
<span class="nc" id="L28472">                mech.setCheckForCrit(true);</span>
            }
        }

        // calculate damage for hitting the surface
<span class="nc" id="L28477">        int damage = (int) Math.round(entity.getWeight() / 10.0)</span>
                     * (damageHeight + 1);
        // different rules (pg. 151 of TW) for battle armor and infantry
<span class="nc bnc" id="L28480" title="All 2 branches missed.">        if (entity instanceof Infantry) {</span>
<span class="nc" id="L28481">            damage = (int) Math.ceil(damageHeight / 2.0);</span>
            // no damage for fall from less than 2 levels
<span class="nc bnc" id="L28483" title="All 2 branches missed.">            if (damageHeight &lt; 2) {</span>
<span class="nc" id="L28484">                damage = 0;</span>
            }
<span class="nc bnc" id="L28486" title="All 2 branches missed.">            if (!(entity instanceof BattleArmor)) {</span>
<span class="nc" id="L28487">                int dice = 3;</span>
<span class="nc bnc" id="L28488" title="All 2 branches missed.">                if (entity.getMovementMode() == EntityMovementMode.INF_MOTORIZED) {</span>
<span class="nc" id="L28489">                    dice = 2;</span>
<span class="nc bnc" id="L28490" title="All 2 branches missed.">                } else if ((entity.getMovementMode() == EntityMovementMode.INF_JUMP)</span>
<span class="nc bnc" id="L28491" title="All 2 branches missed.">                           || ((Infantry) entity).isMechanized()) {</span>
<span class="nc" id="L28492">                    dice = 1;</span>
                }
<span class="nc" id="L28494">                damage = damage * Compute.d6(dice);</span>
            }
        }
        // Different rules (pg 62/63/152 of TW) for Tanks
<span class="nc bnc" id="L28498" title="All 2 branches missed.">        if (entity instanceof Tank) {</span>
            // Falls from less than 2 levels don't damage combat vehicles
            // except if they fall off a sheer cliff
<span class="nc bnc" id="L28501" title="All 4 branches missed.">            if (damageHeight &lt; 2 &amp;&amp; !fromCliff) {</span>
<span class="nc" id="L28502">                damage = 0; </span>
            }
            // Falls from &gt;= 2 elevations damage like crashing VTOLs
            // Ends up being the regular damage: weight / 10 * (height + 1)
            // And this was already computed
        }
        // calculate damage for hitting the ground, but only if we actually fell
        // into water
        // if we fell onto the water surface, that damage is halved.
<span class="nc" id="L28511">        int waterDamage = 0;</span>
<span class="nc bnc" id="L28512" title="All 2 branches missed.">        if (waterDepth &gt; 0) {</span>
<span class="nc" id="L28513">            damage /= 2;</span>
<span class="nc" id="L28514">            waterDamage = ((int) Math.round(entity.getWeight() / 10.0) * (waterDepth + 1)) / 2;</span>
        }

        // If the waterDepth is larger than the fall height, we fell underwater
<span class="nc bnc" id="L28518" title="All 6 branches missed.">        if ((waterDepth &gt;= fallHeight) &amp;&amp; ((waterDepth != 0) || (fallHeight != 0))) {</span>
<span class="nc" id="L28519">            damage = 0;</span>
<span class="nc" id="L28520">            waterDamage = ((int) Math.round(entity.getWeight() / 10.0) * (fallHeight + 1)) / 2;</span>
        }
        // adjust damage for gravity
<span class="nc" id="L28523">        damage = Math</span>
<span class="nc" id="L28524">                .round(damage * game.getPlanetaryConditions().getGravity());</span>
<span class="nc" id="L28525">        waterDamage = Math.round(waterDamage</span>
<span class="nc" id="L28526">                                 * game.getPlanetaryConditions().getGravity());</span>

        // report falling
<span class="nc bnc" id="L28529" title="All 2 branches missed.">        if (waterDamage == 0) {</span>
<span class="nc" id="L28530">            r = new Report(2310);</span>
<span class="nc" id="L28531">            r.subject = entity.getId();</span>
<span class="nc" id="L28532">            r.indent();</span>
<span class="nc" id="L28533">            r.addDesc(entity);</span>
<span class="nc" id="L28534">            r.add(side); // international issue</span>
<span class="nc" id="L28535">            r.add(damage);</span>
<span class="nc bnc" id="L28536" title="All 2 branches missed.">        } else if (damage &gt; 0) {</span>
<span class="nc" id="L28537">            r = new Report(2315);</span>
<span class="nc" id="L28538">            r.subject = entity.getId();</span>
<span class="nc" id="L28539">            r.indent();</span>
<span class="nc" id="L28540">            r.addDesc(entity);</span>
<span class="nc" id="L28541">            r.add(side); // international issue</span>
<span class="nc" id="L28542">            r.add(damage);</span>
<span class="nc" id="L28543">            r.add(waterDamage);</span>
        } else {
<span class="nc" id="L28545">            r = new Report(2310);</span>
<span class="nc" id="L28546">            r.subject = entity.getId();</span>
<span class="nc" id="L28547">            r.indent();</span>
<span class="nc" id="L28548">            r.addDesc(entity);</span>
<span class="nc" id="L28549">            r.add(side); // international issue</span>
<span class="nc" id="L28550">            r.add(waterDamage);</span>
        }
<span class="nc" id="L28552">        vPhaseReport.add(r);</span>

        // Any swarming infantry will be dislodged, but we don't want to
        // interrupt the fall's report. We have to get the ID now because
        // the fall may kill the entity which will reset the attacker ID.
<span class="nc" id="L28557">        final int swarmerId = entity.getSwarmAttackerId();</span>

        // Positioning must be prior to damage for proper handling of breaches
        // Only Mechs can fall prone.
<span class="nc bnc" id="L28561" title="All 2 branches missed.">        if (entity instanceof Mech) {</span>
<span class="nc" id="L28562">            entity.setProne(true);</span>
        }
<span class="nc" id="L28564">        entity.setPosition(fallPos);</span>
<span class="nc" id="L28565">        entity.setElevation(newElevation);</span>
        // Only 'mechs change facing when they fall
<span class="nc bnc" id="L28567" title="All 2 branches missed.">        if (entity instanceof Mech) {</span>
<span class="nc" id="L28568">            entity.setFacing((entity.getFacing() + (facing)) % 6);</span>
<span class="nc" id="L28569">            entity.setSecondaryFacing(entity.getFacing());</span>
        }

        // if falling into a bog-down hex, the entity automatically gets stuck (except when on a bridge or building)
        // but avoid reporting this twice in the case of DFAs
<span class="nc bnc" id="L28574" title="All 4 branches missed.">        if (!entity.isStuck() &amp;&amp; (entity.getElevation() == 0)) {</span>
<span class="nc bnc" id="L28575" title="All 2 branches missed.">            if (fallHex.getBogDownModifier(entity.getMovementMode(),</span>
                    entity instanceof LargeSupportTank) != TargetRoll.AUTOMATIC_SUCCESS) {
<span class="nc" id="L28577">                entity.setStuck(true);</span>
<span class="nc" id="L28578">                r = new Report(2081);</span>
<span class="nc" id="L28579">                r.subject = entity.getId();</span>
<span class="nc" id="L28580">                r.add(entity.getDisplayName(), true);</span>
<span class="nc" id="L28581">                vPhaseReport.add(r);</span>
                // check for quicksand
<span class="nc" id="L28583">                vPhaseReport.addAll(checkQuickSand(fallPos));</span>
            }
        }

        // standard damage loop
<span class="nc bnc" id="L28588" title="All 4 branches missed.">        if ((entity instanceof Infantry) &amp;&amp; (damage &gt; 0)) {</span>
<span class="nc bnc" id="L28589" title="All 2 branches missed.">            if (entity instanceof BattleArmor) {</span>
<span class="nc bnc" id="L28590" title="All 2 branches missed.">                for (int i = 1; i &lt; entity.locations(); i++) {</span>
<span class="nc" id="L28591">                    HitData h = new HitData(i);</span>
<span class="nc" id="L28592">                    vPhaseReport.addAll(damageEntity(entity, h, damage));</span>
<span class="nc" id="L28593">                    addNewLines();</span>
                }
            } else {
<span class="nc" id="L28596">                HitData h = new HitData(Infantry.LOC_INFANTRY);</span>
<span class="nc" id="L28597">                vPhaseReport.addAll(damageEntity(entity, h, damage));</span>
<span class="nc" id="L28598">            }</span>
        } else {
<span class="nc bnc" id="L28600" title="All 2 branches missed.">            while (damage &gt; 0) {</span>
<span class="nc" id="L28601">                int cluster = Math.min(5, damage);</span>
<span class="nc" id="L28602">                HitData hit = entity.rollHitLocation(damageTable, table);</span>
<span class="nc" id="L28603">                hit.makeFallDamage(true);</span>
<span class="nc" id="L28604">                vPhaseReport.addAll(damageEntity(entity, hit, cluster));</span>
<span class="nc" id="L28605">                damage -= cluster;</span>
<span class="nc" id="L28606">            }</span>
        }

<span class="nc bnc" id="L28609" title="All 2 branches missed.">        if (waterDepth &gt; 0) {</span>
<span class="nc bnc" id="L28610" title="All 2 branches missed.">            for (int loop = 0; loop &lt; entity.locations(); loop++) {</span>
<span class="nc" id="L28611">                entity.setLocationStatus(loop, ILocationExposureStatus.WET);</span>
            }
        }
        // Water damage
<span class="nc bnc" id="L28615" title="All 2 branches missed.">        while (waterDamage &gt; 0) {</span>
<span class="nc" id="L28616">            int cluster = Math.min(5, waterDamage);</span>
<span class="nc" id="L28617">            HitData hit = entity.rollHitLocation(damageTable, table);</span>
<span class="nc" id="L28618">            hit.makeFallDamage(true);</span>
<span class="nc" id="L28619">            vPhaseReport.addAll(damageEntity(entity, hit, cluster));</span>
<span class="nc" id="L28620">            waterDamage -= cluster;</span>
<span class="nc" id="L28621">        }</span>

        // check for location exposure
<span class="nc" id="L28624">        vPhaseReport.addAll(doSetLocationsExposure(entity, fallHex, false,</span>
                                                   -waterDepth));

        // only mechs should roll to avoid pilot damage
        // vehicles may fall due to sideslips
<span class="nc bnc" id="L28629" title="All 2 branches missed.">        if (entity instanceof Mech) {</span>
<span class="nc" id="L28630">            vPhaseReport.addAll(checkPilotAvoidFallDamage(entity, fallHeight, roll));</span>
        }

        // Now dislodge any swarming infantry.
<span class="nc bnc" id="L28634" title="All 2 branches missed.">        if (Entity.NONE != swarmerId) {</span>
<span class="nc" id="L28635">            final Entity swarmer = game.getEntity(swarmerId);</span>
<span class="nc" id="L28636">            entity.setSwarmAttackerId(Entity.NONE);</span>
<span class="nc" id="L28637">            swarmer.setSwarmTargetId(Entity.NONE);</span>
            // Did the infantry fall into water?
<span class="nc bnc" id="L28639" title="All 2 branches missed.">            if ((waterDepth &gt; 0)</span>
<span class="nc bnc" id="L28640" title="All 2 branches missed.">                &amp;&amp; (swarmer.getMovementMode() != EntityMovementMode.INF_UMU)) {</span>
                // Swarming infantry die.
<span class="nc" id="L28642">                swarmer.setPosition(fallPos);</span>
<span class="nc" id="L28643">                r = new Report(2330);</span>
<span class="nc" id="L28644">                r.newlines = 0;</span>
<span class="nc" id="L28645">                r.subject = swarmer.getId();</span>
<span class="nc" id="L28646">                r.addDesc(swarmer);</span>
<span class="nc" id="L28647">                vPhaseReport.add(r);</span>
<span class="nc" id="L28648">                vPhaseReport.addAll(destroyEntity(swarmer, &quot;a watery grave&quot;,</span>
                                                  false));
            } else {
                // Swarming infantry take a 2d6 point hit.
                // ASSUMPTION : damage should not be doubled.
<span class="nc" id="L28653">                r = new Report(2335);</span>
<span class="nc" id="L28654">                r.newlines = 0;</span>
<span class="nc" id="L28655">                r.subject = swarmer.getId();</span>
<span class="nc" id="L28656">                r.addDesc(swarmer);</span>
<span class="nc" id="L28657">                vPhaseReport.add(r);</span>
<span class="nc" id="L28658">                vPhaseReport.addAll(damageEntity(swarmer, swarmer</span>
<span class="nc" id="L28659">                        .rollHitLocation(ToHitData.HIT_NORMAL,</span>
<span class="nc" id="L28660">                                         ToHitData.SIDE_FRONT), Compute.d6(2)));</span>
<span class="nc" id="L28661">                Report.addNewline(vPhaseReport);</span>
            }
<span class="nc" id="L28663">            swarmer.setPosition(fallPos);</span>
<span class="nc" id="L28664">            entityUpdate(swarmerId);</span>
<span class="nc bnc" id="L28665" title="All 2 branches missed.">            if (!swarmer.isDone()) {</span>
<span class="nc" id="L28666">                game.removeTurnFor(swarmer);</span>
<span class="nc" id="L28667">                swarmer.setDone(true);</span>
<span class="nc" id="L28668">                send(createTurnVectorPacket());</span>
            }
        } // End dislodge-infantry

        // clear all PSRs after a fall -- the Mek has already failed ONE and
        // fallen, it'd be cruel to make it fail some more!
<span class="nc" id="L28674">        game.resetPSRs(entity);</span>

        // if there is a minefield in this hex, then the mech may set it off
<span class="nc bnc" id="L28677" title="All 2 branches missed.">        if (game.containsMinefield(fallPos)</span>
<span class="nc bnc" id="L28678" title="All 2 branches missed.">            &amp;&amp; enterMinefield(entity, fallPos, newElevation, true,</span>
                              vPhaseReport, 12)) {
<span class="nc" id="L28680">            resetMines();</span>
        }
        // if we have to, check if the building/bridge we fell on collapses -
        // unless it's a fall into a basement,
        // then we're already gonna check that in building collapse, where we
        // came from
<span class="nc bnc" id="L28686" title="All 4 branches missed.">        if (checkCollapse &amp;&amp; !handlingBasement) {</span>

<span class="nc" id="L28688">            checkForCollapse(game.getBoard().getBuildingAt(fallPos),</span>
<span class="nc" id="L28689">                             game.getPositionMap(), fallPos, false, vPhaseReport);</span>
        }

<span class="nc" id="L28692">        return vPhaseReport;</span>
    }

    private Vector&lt;Report&gt; checkPilotAvoidFallDamage(Entity entity, int fallHeight, PilotingRollData roll) {
<span class="nc" id="L28696">        Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>

<span class="nc bnc" id="L28698" title="All 2 branches missed.">        if (entity.hasAbility(OptionsConstants.MD_DERMAL_ARMOR)</span>
<span class="nc bnc" id="L28699" title="All 2 branches missed.">                || entity.hasAbility(OptionsConstants.MD_TSM_IMPLANT)) {</span>
<span class="nc" id="L28700">            return reports;</span>
        }
        // we want to be able to avoid pilot damage even when it was
        // an automatic fall, only unconsciousness should cause auto-damage
<span class="nc" id="L28704">        roll.removeAutos();</span>

<span class="nc bnc" id="L28706" title="All 2 branches missed.">        if (fallHeight &gt; 1) {</span>
<span class="nc" id="L28707">            roll.addModifier(fallHeight - 1, &quot;height of fall&quot;);</span>
        }

<span class="nc bnc" id="L28710" title="All 2 branches missed.">        if (entity.getCrew().getSlotCount() &gt; 1) {</span>
            //Extract the base from the list of modifiers so we can replace it with the piloting
            //skill of each crew member.
<span class="nc" id="L28713">            List&lt;TargetRollModifier&gt; modifiers = new ArrayList&lt;&gt;(roll.getModifiers());</span>
<span class="nc bnc" id="L28714" title="All 2 branches missed.">            if (modifiers.size() &gt; 0) {</span>
<span class="nc" id="L28715">                modifiers.remove(0);</span>
            }
<span class="nc bnc" id="L28717" title="All 2 branches missed.">            for (int pos = 0; pos &lt; entity.getCrew().getSlotCount(); pos++) {</span>
<span class="nc bnc" id="L28718" title="All 4 branches missed.">                if (entity.getCrew().isMissing(pos) || entity.getCrew().isDead(pos)) {</span>
<span class="nc" id="L28719">                    continue;</span>
                }
                PilotingRollData prd;
<span class="nc bnc" id="L28722" title="All 2 branches missed.">                if (entity.getCrew().isDead(pos)) {</span>
<span class="nc" id="L28723">                    continue;</span>
<span class="nc bnc" id="L28724" title="All 2 branches missed.">                } else if (entity.getCrew().isUnconscious(pos)) {</span>
<span class="nc" id="L28725">                    prd = new PilotingRollData(entity.getId(), TargetRoll.AUTOMATIC_FAIL,</span>
                            &quot;Crew member unconscious&quot;);
                } else {
<span class="nc" id="L28728">                    prd = new PilotingRollData(entity.getId(),</span>
<span class="nc" id="L28729">                            entity.getCrew().getPiloting(pos), &quot;Base piloting skill&quot;);</span>
<span class="nc" id="L28730">                    modifiers.forEach(prd::addModifier);</span>
                }
<span class="nc" id="L28732">                reports.addAll(resolvePilotDamageFromFall(entity, prd, pos));</span>
            }
<span class="nc" id="L28734">        } else {</span>
<span class="nc" id="L28735">            reports.addAll(resolvePilotDamageFromFall(entity, roll, 0));</span>
        }
<span class="nc" id="L28737">        return reports;</span>
    }

    private Vector&lt;Report&gt; resolvePilotDamageFromFall(Entity entity, PilotingRollData roll, int crewPos) {
<span class="nc" id="L28741">        Vector&lt;Report&gt; reports = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc bnc" id="L28743" title="All 2 branches missed.">        if (roll.getValue() == TargetRoll.IMPOSSIBLE) {</span>
<span class="nc" id="L28744">            r = new Report(2320);</span>
<span class="nc" id="L28745">            r.subject = entity.getId();</span>
<span class="nc" id="L28746">            r.add(entity.getCrew().getCrewType().getRoleName(crewPos));</span>
<span class="nc" id="L28747">            r.addDesc(entity);</span>
<span class="nc" id="L28748">            r.add(entity.getCrew().getName(crewPos));</span>
<span class="nc" id="L28749">            r.indent();</span>
<span class="nc" id="L28750">            reports.add(r);</span>
<span class="nc" id="L28751">            reports.addAll(damageCrew(entity, 1, crewPos));</span>
        } else {
<span class="nc" id="L28753">            int diceRoll = entity.getCrew().rollPilotingSkill();</span>
<span class="nc" id="L28754">            r = new Report(2325);</span>
<span class="nc" id="L28755">            r.subject = entity.getId();</span>
<span class="nc" id="L28756">            r.add(entity.getCrew().getCrewType().getRoleName(crewPos));</span>
<span class="nc" id="L28757">            r.addDesc(entity);</span>
<span class="nc" id="L28758">            r.add(entity.getCrew().getName(crewPos));</span>
<span class="nc" id="L28759">            r.add(roll.getValueAsString());</span>
<span class="nc" id="L28760">            r.add(diceRoll);</span>
<span class="nc bnc" id="L28761" title="All 2 branches missed.">            if (diceRoll &gt;= roll.getValue()) {</span>
<span class="nc" id="L28762">                r.choose(true);</span>
<span class="nc" id="L28763">                reports.add(r);</span>
            } else {
<span class="nc" id="L28765">                r.choose(false);</span>
<span class="nc" id="L28766">                reports.add(r);</span>
<span class="nc" id="L28767">                reports.addAll(damageCrew(entity, 1, crewPos));</span>
            }
        }
<span class="nc" id="L28770">        Report.addNewline(reports);</span>
<span class="nc" id="L28771">        return reports;</span>
    }

    /**
     * The mech falls into an unoccupied hex from the given height above
     */
    private Vector&lt;Report&gt; doEntityFall(Entity entity, Coords fallPos,
                                        int height, PilotingRollData roll) {
<span class="nc" id="L28779">        return doEntityFall(entity, fallPos, height, Compute.d6(1) - 1, roll,</span>
                            false, false);
    }

    /**
     * The mech falls down in place
     */
    private Vector&lt;Report&gt; doEntityFall(Entity entity, PilotingRollData roll) {
<span class="nc" id="L28787">        boolean fallToSurface = false;</span>
        // on ice
<span class="nc" id="L28789">        int toSubtract = 0;</span>
<span class="nc" id="L28790">        IHex currHex = game.getBoard().getHex(entity.getPosition());</span>
<span class="nc bnc" id="L28791" title="All 2 branches missed.">        if (currHex.containsTerrain(Terrains.ICE)</span>
<span class="nc bnc" id="L28792" title="All 2 branches missed.">            &amp;&amp; (entity.getElevation() != -currHex.depth())) {</span>
<span class="nc" id="L28793">            fallToSurface = true;</span>
<span class="nc" id="L28794">            toSubtract = 0;</span>
        }
        // on a bridge
<span class="nc bnc" id="L28797" title="All 2 branches missed.">        if (currHex.containsTerrain(Terrains.BRIDGE_ELEV)</span>
<span class="nc" id="L28798">            &amp;&amp; (entity.getElevation() &gt;= currHex</span>
<span class="nc bnc" id="L28799" title="All 2 branches missed.">                .terrainLevel(Terrains.BRIDGE_ELEV))) {</span>
<span class="nc" id="L28800">            fallToSurface = true;</span>
<span class="nc" id="L28801">            toSubtract = currHex.terrainLevel(Terrains.BRIDGE_ELEV);</span>
        }
        // on a building
<span class="nc bnc" id="L28804" title="All 2 branches missed.">        if (currHex.containsTerrain(Terrains.BLDG_ELEV)</span>
<span class="nc" id="L28805">            &amp;&amp; (entity.getElevation() &gt;= currHex</span>
<span class="nc bnc" id="L28806" title="All 2 branches missed.">                .terrainLevel(Terrains.BLDG_ELEV))) {</span>
<span class="nc" id="L28807">            fallToSurface = true;</span>
<span class="nc" id="L28808">            toSubtract = currHex.terrainLevel(Terrains.BLDG_ELEV);</span>
        }
<span class="nc" id="L28810">        return doEntityFall(entity, entity.getPosition(), entity.getElevation()</span>
<span class="nc bnc" id="L28811" title="All 2 branches missed.">                + (!fallToSurface ? currHex.depth(true) : -toSubtract), roll);</span>
    }

    /**
     * Report: - Any ammo dumps beginning the following round. - Any ammo dumps
     * that have ended with the end of this round.
     */
    private void resolveAmmoDumps() {
        Report r;
<span class="nc bnc" id="L28820" title="All 2 branches missed.">        for (Entity entity : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L28821" title="All 2 branches missed.">            for (Mounted m : entity.getAmmo()) {</span>
<span class="nc bnc" id="L28822" title="All 2 branches missed.">                if (m.isPendingDump()) {</span>
                    // report dumping next round
<span class="nc" id="L28824">                    r = new Report(5110);</span>
<span class="nc" id="L28825">                    r.subject = entity.getId();</span>
<span class="nc" id="L28826">                    r.addDesc(entity);</span>
<span class="nc" id="L28827">                    r.add(m.getName());</span>
<span class="nc" id="L28828">                    addReport(r);</span>
                    // update status
<span class="nc" id="L28830">                    m.setPendingDump(false);</span>
<span class="nc" id="L28831">                    m.setDumping(true);</span>
<span class="nc bnc" id="L28832" title="All 2 branches missed.">                } else if (m.isDumping()) {</span>
                    // report finished dumping
<span class="nc" id="L28834">                    r = new Report(5115);</span>
<span class="nc" id="L28835">                    r.subject = entity.getId();</span>
<span class="nc" id="L28836">                    r.addDesc(entity);</span>
<span class="nc" id="L28837">                    r.add(m.getName());</span>
<span class="nc" id="L28838">                    addReport(r);</span>
                    // update status
<span class="nc" id="L28840">                    m.setDumping(false);</span>
<span class="nc" id="L28841">                    m.setShotsLeft(0);</span>
                }
<span class="nc" id="L28843">            }</span>
            // also do DWP dumping
<span class="nc bnc" id="L28845" title="All 2 branches missed.">            if (entity instanceof BattleArmor) {</span>
<span class="nc bnc" id="L28846" title="All 2 branches missed.">                for (Mounted m : entity.getWeaponList()) {</span>
<span class="nc bnc" id="L28847" title="All 4 branches missed.">                    if (m.isDWPMounted() &amp;&amp; m.isPendingDump()) {</span>
<span class="nc" id="L28848">                        m.setMissing(true);</span>
<span class="nc" id="L28849">                        r = new Report(5116);</span>
<span class="nc" id="L28850">                        r.subject = entity.getId();</span>
<span class="nc" id="L28851">                        r.addDesc(entity);</span>
<span class="nc" id="L28852">                        r.add(m.getName());</span>
<span class="nc" id="L28853">                        addReport(r);</span>
<span class="nc" id="L28854">                        m.setPendingDump(false);</span>
                        // Also dump all of the ammo in the DWP
<span class="nc bnc" id="L28856" title="All 2 branches missed.">                        for (Mounted ammo : entity.getAmmo()) {</span>
<span class="nc bnc" id="L28857" title="All 2 branches missed.">                            if (m.equals(ammo.getLinkedBy())) {</span>
<span class="nc" id="L28858">                                ammo.setMissing(true);</span>
                            }
<span class="nc" id="L28860">                        }</span>
                    // Check for jettisoning missiles
<span class="nc bnc" id="L28862" title="All 4 branches missed.">                    } else if (m.isBodyMounted() &amp;&amp; m.isPendingDump()</span>
<span class="nc bnc" id="L28863" title="All 2 branches missed.">                            &amp;&amp; m.getType().hasFlag(WeaponType.F_MISSILE)</span>
<span class="nc bnc" id="L28864" title="All 2 branches missed.">                            &amp;&amp; (m.getLinked() != null)</span>
<span class="nc bnc" id="L28865" title="All 2 branches missed.">                            &amp;&amp; (m.getLinked().getUsableShotsLeft() &gt; 0)) {</span>
<span class="nc" id="L28866">                        m.setMissing(true);</span>
<span class="nc" id="L28867">                        r = new Report(5116);</span>
<span class="nc" id="L28868">                        r.subject = entity.getId();</span>
<span class="nc" id="L28869">                        r.addDesc(entity);</span>
<span class="nc" id="L28870">                        r.add(m.getName());</span>
<span class="nc" id="L28871">                        addReport(r);</span>
<span class="nc" id="L28872">                        m.setPendingDump(false);</span>
                        // Dump all ammo related to this launcher
                        // BA burdened is based on whether the launcher has
                        // ammo left
<span class="nc bnc" id="L28876" title="All 2 branches missed.">                        while ((m.getLinked() != null)</span>
<span class="nc bnc" id="L28877" title="All 2 branches missed.">                                &amp;&amp; (m.getLinked().getUsableShotsLeft() &gt; 0)) {</span>
<span class="nc" id="L28878">                            m.getLinked().setMissing(true);</span>
<span class="nc" id="L28879">                            entity.loadWeapon(m);</span>
                        }
                    }
<span class="nc" id="L28882">                }</span>
            }
<span class="nc" id="L28884">            entity.reloadEmptyWeapons();</span>
<span class="nc" id="L28885">        }</span>
<span class="nc" id="L28886">    }</span>

    /**
     * Checks for fire ignition based on a given target roll. If successful,
     * lights a fire also checks to see that fire is possible in the specified
     * hex.
     *
     * @param c        - the &lt;code&gt;Coords&lt;/code&gt; to be lit.
     * @param roll     - the &lt;code&gt;TargetRoll&lt;/code&gt; for the ignition roll
     * @param bInferno - &lt;code&gt;true&lt;/code&gt; if the fire is an inferno fire. If this
     *                 value is &lt;code&gt;false&lt;/code&gt; the hex will be lit only if it
     *                 contains Woods,jungle or a Building.
     * @param entityId - the entityId responsible for the ignite attempt. If the
     *                 value is Entity.NONE, then the roll attempt will not be
     *                 included in the report.
     */
    public boolean checkIgnition(Coords c, TargetRoll roll, boolean bInferno, int entityId,
                                 Vector&lt;Report&gt; vPhaseReport) {

<span class="nc" id="L28905">        IHex hex = game.getBoard().getHex(c);</span>

        // The hex might be null due to spreadFire translation
        // goes outside of the board limit.
<span class="nc bnc" id="L28909" title="All 2 branches missed.">        if (null == hex) {</span>
<span class="nc" id="L28910">            return false;</span>
        }

        // The hex may already be on fire.
<span class="nc bnc" id="L28914" title="All 2 branches missed.">        if (hex.containsTerrain(Terrains.FIRE)) {</span>
<span class="nc" id="L28915">            return false;</span>
        }

<span class="nc bnc" id="L28918" title="All 4 branches missed.">        if (!bInferno &amp;&amp; !hex.isIgnitable()) {</span>
<span class="nc" id="L28919">            return false;</span>
        }

<span class="nc" id="L28922">        int fireRoll = Compute.d6(2);</span>
        Report r;
<span class="nc bnc" id="L28924" title="All 2 branches missed.">        if (entityId != Entity.NONE) {</span>
<span class="nc" id="L28925">            r = new Report(3430);</span>
<span class="nc" id="L28926">            r.indent(2);</span>
<span class="nc" id="L28927">            r.subject = entityId;</span>
<span class="nc" id="L28928">            r.add(roll.getValueAsString());</span>
<span class="nc" id="L28929">            r.add(roll.getDesc());</span>
<span class="nc" id="L28930">            r.add(fireRoll);</span>
<span class="nc" id="L28931">            vPhaseReport.add(r);</span>
        }
<span class="nc bnc" id="L28933" title="All 2 branches missed.">        if (fireRoll &gt;= roll.getValue()) {</span>
<span class="nc" id="L28934">            ignite(c, Terrains.FIRE_LVL_NORMAL, vPhaseReport);</span>
<span class="nc" id="L28935">            return true;</span>
        }
<span class="nc" id="L28937">        return false;</span>
    }

    /**
     * Returns true if the hex is set on fire with the specified roll. Of
     * course, also checks to see that fire is possible in the specified hex.
     * This version of the method will not report the attempt roll.
     *
     * @param c        - the &lt;code&gt;Coords&lt;/code&gt; to be lit.
     * @param roll     - the &lt;code&gt;int&lt;/code&gt; target number for the ignition roll
     * @param bInferno - &lt;code&gt;true&lt;/code&gt; if the fire can be lit in any terrain. If
     *                 this value is &lt;code&gt;false&lt;/code&gt; the hex will be lit only if
     *                 it contains Woods, jungle or a Building.
     */
    public boolean checkIgnition(Coords c, TargetRoll roll, boolean bInferno) {
<span class="nc" id="L28952">        return checkIgnition(c, roll, bInferno, Entity.NONE, null);</span>
    }

    /**
     * Returns true if the hex is set on fire with the specified roll. Of
     * course, also checks to see that fire is possible in the specified hex.
     * This version of the method will not report the attempt roll.
     *
     * @param c    - the &lt;code&gt;Coords&lt;/code&gt; to be lit.
     * @param roll - the &lt;code&gt;int&lt;/code&gt; target number for the ignition roll
     */
    public boolean checkIgnition(Coords c, TargetRoll roll) {
        // default signature, assuming only woods can burn
<span class="nc" id="L28965">        return checkIgnition(c, roll, false, Entity.NONE, null);</span>
    }

    /**
     * add fire to a hex
     *
     * @param c         - the &lt;code&gt;Coords&lt;/code&gt; of the hex to be set on fire
     * @param fireLevel - The level of fire, see Terrains
     */
    public void ignite(Coords c, int fireLevel, Vector&lt;Report&gt; vReport) {
        // you can't start fires in some planetary conditions!
<span class="nc bnc" id="L28976" title="All 2 branches missed.">        if (null != game.getPlanetaryConditions().cannotStartFire()) {</span>
<span class="nc bnc" id="L28977" title="All 2 branches missed.">            if (null != vReport) {</span>
<span class="nc" id="L28978">                Report r = new Report(3007);</span>
<span class="nc" id="L28979">                r.indent(2);</span>
<span class="nc" id="L28980">                r.add(game.getPlanetaryConditions().cannotStartFire());</span>
<span class="nc" id="L28981">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L28982">                vReport.add(r);</span>
            }
<span class="nc" id="L28984">            return;</span>
        }

<span class="nc bnc" id="L28987" title="All 2 branches missed.">        if (!game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_START_FIRE)) {</span>
<span class="nc bnc" id="L28988" title="All 2 branches missed.">            if (null != vReport) {</span>
<span class="nc" id="L28989">                Report r = new Report(3008);</span>
<span class="nc" id="L28990">                r.indent(2);</span>
<span class="nc" id="L28991">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L28992">                vReport.add(r);</span>
            }
<span class="nc" id="L28994">            return;</span>
        }

<span class="nc" id="L28997">        IHex hex = game.getBoard().getHex(c);</span>
<span class="nc bnc" id="L28998" title="All 2 branches missed.">        if (null == hex) {</span>
<span class="nc" id="L28999">            return;</span>
        }

<span class="nc" id="L29002">        Report r = new Report(3005);</span>
<span class="nc" id="L29003">        r.indent(2);</span>
<span class="nc" id="L29004">        r.add(c.getBoardNum());</span>
<span class="nc" id="L29005">        r.type = Report.PUBLIC;</span>

        // Adjust report message for inferno types
<span class="nc bnc" id="L29008" title="All 4 branches missed.">        switch (fireLevel) {</span>
            case Terrains.FIRE_LVL_INFERNO:
<span class="nc" id="L29010">                r.messageId = 3006;</span>
<span class="nc" id="L29011">                break;</span>
            case Terrains.FIRE_LVL_INFERNO_BOMB:
<span class="nc" id="L29013">                r.messageId = 3003;</span>
<span class="nc" id="L29014">                break;</span>
            case Terrains.FIRE_LVL_INFERNO_IV:
<span class="nc" id="L29016">                r.messageId = 3004;</span>
                break;
        }

        // report it
<span class="nc bnc" id="L29021" title="All 2 branches missed.">        if (null != vReport) {</span>
<span class="nc" id="L29022">            vReport.add(r);</span>
        }
<span class="nc" id="L29024">        hex.addTerrain(Terrains.getTerrainFactory().createTerrain(Terrains.FIRE, fireLevel));</span>
<span class="nc" id="L29025">        sendChangedHex(c);</span>
<span class="nc" id="L29026">    }</span>

    /**
     * remove fire from a hex
     *
     * @param fireCoords
     * @param reason
     */
    public void removeFire(Coords fireCoords, String reason) {
<span class="nc" id="L29035">        IHex hex = game.getBoard().getHex(fireCoords);</span>
<span class="nc bnc" id="L29036" title="All 2 branches missed.">        if (null == hex) {</span>
<span class="nc" id="L29037">            return;</span>
        }
<span class="nc" id="L29039">        hex.removeTerrain(Terrains.FIRE);</span>
<span class="nc" id="L29040">        hex.resetFireTurn();</span>
<span class="nc" id="L29041">        sendChangedHex(fireCoords);</span>
        // fire goes out
<span class="nc" id="L29043">        Report r = new Report(5170, Report.PUBLIC);</span>
<span class="nc" id="L29044">        r.add(fireCoords.getBoardNum());</span>
<span class="nc" id="L29045">        r.add(reason);</span>
<span class="nc" id="L29046">        addReport(r);</span>
<span class="nc" id="L29047">    }</span>

    /**
     * Called when a fire is burning. Called 3 times per fire hex.
     *
     * @param coords The &lt;code&gt;Coords&lt;/code&gt; x-coordinate of the hex
     */
    public void addSmoke(ArrayList&lt;Coords&gt; coords, int windDir, boolean bInferno) {
        // if a tornado, then no smoke!
<span class="nc bnc" id="L29056" title="All 2 branches missed.">        if (game.getPlanetaryConditions().getWindStrength() &gt; PlanetaryConditions.WI_STORM) {</span>
<span class="nc" id="L29057">            return;</span>
        }

<span class="nc" id="L29060">        int smokeLevel = 0;</span>
<span class="nc bnc" id="L29061" title="All 2 branches missed.">        for (Coords smokeCoords : coords) {</span>
<span class="nc" id="L29062">            IHex smokeHex = game.getBoard().getHex(smokeCoords);</span>
            Report r;
<span class="nc bnc" id="L29064" title="All 2 branches missed.">            if (smokeHex == null) {</span>
<span class="nc" id="L29065">                continue;</span>
            }
            // Have to check if it's inferno smoke or from a heavy/hardened
            // building
            // - heavy smoke from those
<span class="nc bnc" id="L29070" title="All 4 branches missed.">            if (bInferno || (Building.MEDIUM &lt; smokeHex.terrainLevel(Terrains.FUEL_TANK))</span>
<span class="nc bnc" id="L29071" title="All 2 branches missed.">                    || (Building.MEDIUM &lt; smokeHex.terrainLevel(Terrains.BUILDING))) {</span>
<span class="nc bnc" id="L29072" title="All 2 branches missed.">                if (smokeHex.terrainLevel(Terrains.SMOKE) == SmokeCloud.SMOKE_HEAVY) {</span>
                    // heavy smoke fills hex
<span class="nc" id="L29074">                    r = new Report(5180, Report.PUBLIC);</span>
                } else {
<span class="nc" id="L29076">                    r = new Report(5185, Report.PUBLIC);</span>
                }
<span class="nc" id="L29078">                smokeLevel = SmokeCloud.SMOKE_HEAVY;</span>
<span class="nc" id="L29079">                r.add(smokeCoords.getBoardNum());</span>
<span class="nc" id="L29080">                addReport(r);</span>
            } else {
<span class="nc bnc" id="L29082" title="All 2 branches missed.">                if (smokeHex.terrainLevel(Terrains.SMOKE) == SmokeCloud.SMOKE_HEAVY) {</span>
                    // heavy smoke overpowers light
<span class="nc" id="L29084">                    r = new Report(5190, Report.PUBLIC);</span>
<span class="nc" id="L29085">                    r.add(smokeCoords.getBoardNum());</span>
<span class="nc" id="L29086">                    smokeLevel = Math.max(smokeLevel, SmokeCloud.SMOKE_LIGHT);</span>
<span class="nc" id="L29087">                    addReport(r);</span>
<span class="nc bnc" id="L29088" title="All 2 branches missed.">                } else if (smokeHex.terrainLevel(Terrains.SMOKE) == SmokeCloud.SMOKE_LIGHT) {</span>
                    // light smoke continue to fill hex
<span class="nc" id="L29090">                    r = new Report(5195, Report.PUBLIC);</span>
<span class="nc" id="L29091">                    r.add(smokeCoords.getBoardNum());</span>
<span class="nc" id="L29092">                    addReport(r);</span>
<span class="nc" id="L29093">                    smokeLevel = Math.max(smokeLevel, SmokeCloud.SMOKE_LIGHT);</span>
                } else {
<span class="nc" id="L29095">                    smokeLevel = Math.max(smokeLevel, SmokeCloud.SMOKE_LIGHT);</span>
                    // light smoke fills hex
<span class="nc" id="L29097">                    r = new Report(5200, Report.PUBLIC);</span>
<span class="nc" id="L29098">                    r.add(smokeCoords.getBoardNum());</span>
<span class="nc" id="L29099">                    addReport(r);</span>
                }
            }
<span class="nc" id="L29102">        }</span>
<span class="nc" id="L29103">        createSmoke(coords, smokeLevel, 0);</span>
<span class="nc" id="L29104">    }</span>

    /**
     * Scans the boards directory for map boards of the appropriate size and
     * returns them.
     *
     * @return A list of relative paths to the board files, without the '.board'
     * extension.
     */
    private List&lt;String&gt; scanForBoardsInDir(final File boardDir, final String basePath,
                                            final BoardDimensions dimensions, List&lt;String&gt; boards) {
<span class="nc bnc" id="L29115" title="All 2 branches missed.">        if (boardDir == null) {</span>
<span class="nc" id="L29116">            throw new IllegalArgumentException(&quot;must provide searchDir&quot;);</span>
<span class="nc bnc" id="L29117" title="All 2 branches missed.">        } else if (basePath == null) {</span>
<span class="nc" id="L29118">            throw new IllegalArgumentException(&quot;must provide basePath&quot;);</span>
<span class="nc bnc" id="L29119" title="All 2 branches missed.">        } else if (dimensions == null) {</span>
<span class="nc" id="L29120">            throw new IllegalArgumentException(&quot;must provide dimensions&quot;);</span>
<span class="nc bnc" id="L29121" title="All 2 branches missed.">        } else if (boards == null) {</span>
<span class="nc" id="L29122">            throw new IllegalArgumentException(&quot;must provide boards&quot;);</span>
        }

<span class="nc" id="L29125">        String[] fileList = boardDir.list();</span>
<span class="nc bnc" id="L29126" title="All 2 branches missed.">        if (fileList != null) {</span>
<span class="nc bnc" id="L29127" title="All 2 branches missed.">            for (String filename : fileList) {</span>
<span class="nc" id="L29128">                File filePath = new MegaMekFile(boardDir, filename).getFile();</span>
<span class="nc bnc" id="L29129" title="All 2 branches missed.">                if (filePath.isDirectory()) {</span>
<span class="nc" id="L29130">                    scanForBoardsInDir(new MegaMekFile(boardDir, filename).getFile(),</span>
<span class="nc" id="L29131">                            basePath.concat(File.separator).concat(filename), dimensions, boards);</span>
                } else {
<span class="nc bnc" id="L29133" title="All 2 branches missed.">                    if (filename.endsWith(&quot;.board&quot;)) { //$NON-NLS-1$</span>
<span class="nc bnc" id="L29134" title="All 2 branches missed.">                        if (Board.boardIsSize(filePath, dimensions)) {</span>
<span class="nc" id="L29135">                            boards.add(basePath.concat(File.separator)</span>
<span class="nc" id="L29136">                                    .concat(filename.substring(0, filename.lastIndexOf(&quot;.&quot;))));</span>
                        }
                    }
                }
            }
        }
<span class="nc" id="L29142">        return boards;</span>
    }

    /**
     * Recursively scan the specified path to determine the board sizes
     * available.
     *
     * @param searchDir The directory to search below this path (may be null for all
     *                  in base path).
     * @param sizes     Where to store the discovered board sizes
     */
    private void getBoardSizesInDir(final File searchDir, TreeSet&lt;BoardDimensions&gt; sizes) {
<span class="nc bnc" id="L29154" title="All 2 branches missed.">        if (searchDir == null) {</span>
<span class="nc" id="L29155">            throw new IllegalArgumentException(&quot;must provide searchDir&quot;);</span>
        }

<span class="nc bnc" id="L29158" title="All 2 branches missed.">        if (sizes == null) {</span>
<span class="nc" id="L29159">            throw new IllegalArgumentException(&quot;must provide sizes&quot;);</span>
        }

<span class="nc" id="L29162">        String[] file_list = searchDir.list();</span>

<span class="nc bnc" id="L29164" title="All 2 branches missed.">        if (file_list != null) {</span>
<span class="nc bnc" id="L29165" title="All 2 branches missed.">            for (String filename : file_list) {</span>
<span class="nc" id="L29166">                File query_file = new File(searchDir, filename);</span>

<span class="nc bnc" id="L29168" title="All 2 branches missed.">                if (query_file.isDirectory()) {</span>
<span class="nc" id="L29169">                    getBoardSizesInDir(query_file, sizes);</span>
                } else {
                    try {
<span class="nc bnc" id="L29172" title="All 2 branches missed.">                        if (filename.endsWith(&quot;.board&quot;)) { //$NON-NLS-1$</span>
<span class="nc" id="L29173">                            BoardDimensions size = Board.getSize(query_file);</span>
<span class="nc bnc" id="L29174" title="All 2 branches missed.">                            if (size == null) {</span>
<span class="nc" id="L29175">                                throw new Exception();</span>
                            }
<span class="nc" id="L29177">                            sizes.add(Board.getSize(query_file));</span>
                        }
<span class="nc" id="L29179">                    } catch (Exception e) {</span>
<span class="nc" id="L29180">                        MegaMek.getLogger().error(&quot;Error parsing board: &quot; + query_file.getAbsolutePath(), e);</span>
<span class="nc" id="L29181">                    }</span>
                }
            }
        }
<span class="nc" id="L29185">    }</span>

    /**
     * Get a list of the available board sizes from the boards data directory.
     *
     * @return A Set containing all the available board sizes.
     */
    private Set&lt;BoardDimensions&gt; getBoardSizes() {
<span class="nc" id="L29193">        TreeSet&lt;BoardDimensions&gt; board_sizes = new TreeSet&lt;&gt;();</span>

<span class="nc" id="L29195">        File boards_dir = Configuration.boardsDir();</span>
        // Slightly overkill sanity check...
<span class="nc bnc" id="L29197" title="All 2 branches missed.">        if (boards_dir.isDirectory()) {</span>
<span class="nc" id="L29198">            getBoardSizesInDir(boards_dir, board_sizes);</span>
        }
<span class="nc" id="L29200">        boards_dir = new File(Configuration.userdataDir(), Configuration.boardsDir().toString());</span>
<span class="nc bnc" id="L29201" title="All 2 branches missed.">        if (boards_dir.isDirectory()) {</span>
<span class="nc" id="L29202">            getBoardSizesInDir(boards_dir, board_sizes);</span>
        }

<span class="nc" id="L29205">        return board_sizes;</span>
    }

    /**
     * Scan for map boards with the specified dimensions.
     *
     * @param dimensions The desired board dimensions.
     * @return A list of path names, minus the '.board' extension, relative to
     * the boards data directory.
     */
    private ArrayList&lt;String&gt; scanForBoards(final BoardDimensions dimensions) {
<span class="nc" id="L29216">        ArrayList&lt;String&gt; boards = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L29218">        File boardDir = Configuration.boardsDir();</span>
<span class="nc" id="L29219">        boards.add(MapSettings.BOARD_GENERATED);</span>
        // just a check...
<span class="nc bnc" id="L29221" title="All 2 branches missed.">        if (!boardDir.isDirectory()) {</span>
<span class="nc" id="L29222">            return boards;</span>
        }

        // scan files
<span class="nc" id="L29226">        List&lt;String&gt; tempList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L29227">        Comparator&lt;String&gt; sortComp = StringUtil.stringComparator();</span>
<span class="nc" id="L29228">        scanForBoardsInDir(boardDir, &quot;&quot;, dimensions, tempList);</span>
        // Check boards in userData dir
<span class="nc" id="L29230">        boardDir = new File(Configuration.userdataDir(), Configuration.boardsDir().toString());</span>
<span class="nc bnc" id="L29231" title="All 2 branches missed.">        if (boardDir.isDirectory()) {</span>
<span class="nc" id="L29232">            scanForBoardsInDir(boardDir, &quot;&quot;, dimensions, tempList);</span>
        }
        // if there are any boards, add these:
<span class="nc bnc" id="L29235" title="All 2 branches missed.">        if (tempList.size() &gt; 0) {</span>
<span class="nc" id="L29236">            boards.add(MapSettings.BOARD_RANDOM);</span>
<span class="nc" id="L29237">            boards.add(MapSettings.BOARD_SURPRISE);</span>
<span class="nc" id="L29238">            tempList.sort(sortComp);</span>
<span class="nc" id="L29239">            boards.addAll(tempList);</span>
        }

<span class="nc" id="L29242">        return boards;</span>
    }

    /**
     * @return whether this game is double blind or not and we should be blind in
     * the current phase
     */
    private boolean doBlind() {
<span class="nc bnc" id="L29250" title="All 2 branches missed.">        return game.getOptions().booleanOption(OptionsConstants.ADVANCED_DOUBLE_BLIND)</span>
<span class="nc bnc" id="L29251" title="All 2 branches missed.">               &amp;&amp; game.getPhase().isDuringOrAfter(IGame.Phase.PHASE_DEPLOYMENT);</span>
    }

    private boolean suppressBlindBV() {
<span class="nc" id="L29255">        return game.getOptions().booleanOption(OptionsConstants.ADVANCED_SUPPRESS_DB_BV);</span>
    }

    /**
     * In a double-blind game, update only visible entities. Otherwise, update
     * everyone
     */
    public void entityUpdate(int nEntityID) {
<span class="nc" id="L29263">        entityUpdate(nEntityID, new Vector&lt;&gt;(), true, null);</span>
<span class="nc" id="L29264">    }</span>

    /**
     * In a double-blind game, update only visible entities. Otherwise, update
     * everyone
     *
     * @param updateVisibility Flag that determines if whoCanSee needs to be
     *                         called to update who can see the entity for
     *                         double-blind games.
     */
    public void entityUpdate(int nEntityID, Vector&lt;UnitLocation&gt; movePath, boolean updateVisibility,
                             Map&lt;EntityTargetPair, LosEffects&gt; losCache) {
<span class="nc" id="L29276">        Entity eTarget = game.getEntity(nEntityID);</span>
<span class="nc bnc" id="L29277" title="All 2 branches missed.">        if (eTarget == null) {</span>
<span class="nc bnc" id="L29278" title="All 2 branches missed.">            if (game.getOutOfGameEntity(nEntityID) != null) {</span>
<span class="nc" id="L29279">                MegaMek.getLogger().error(&quot;S: attempted to send entity update for out of game entity, id was &quot; + nEntityID);</span>
            } else {
<span class="nc" id="L29281">                MegaMek.getLogger().error(&quot;S: attempted to send entity update for null entity, id was &quot; + nEntityID);</span>
            }

<span class="nc" id="L29284">            return; // do not send the update it will crash the client</span>
        }

        // If we're doing double blind, be careful who can see it...
<span class="nc bnc" id="L29288" title="All 2 branches missed.">        if (doBlind()) {</span>
<span class="nc" id="L29289">            Vector&lt;IPlayer&gt; playersVector = game.getPlayersVector();</span>
            Vector&lt;IPlayer&gt; vCanSee;
<span class="nc bnc" id="L29291" title="All 2 branches missed.">            if (updateVisibility) {</span>
<span class="nc" id="L29292">                vCanSee = whoCanSee(eTarget, true, losCache);</span>
            } else {
<span class="nc" id="L29294">                vCanSee = eTarget.getWhoCanSee();</span>
            }

            // If this unit has ECM, players with units affected by the ECM will
            //  need to know about this entity, even if they can't see it.
            //  Otherwise, the client can't properly report things like to-hits.
<span class="nc bnc" id="L29300" title="All 4 branches missed.">            if ((eTarget.getECMRange() &gt; 0) &amp;&amp; (eTarget.getPosition() != null)) {</span>
<span class="nc" id="L29301">                int ecmRange = eTarget.getECMRange();</span>
<span class="nc" id="L29302">                Coords pos = eTarget.getPosition();</span>
<span class="nc bnc" id="L29303" title="All 2 branches missed.">                for (Entity ent : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L29304" title="All 2 branches missed.">                    if ((ent.getPosition() != null)</span>
<span class="nc bnc" id="L29305" title="All 2 branches missed.">                        &amp;&amp; (pos.distance(ent.getPosition()) &lt;= ecmRange)) {</span>
<span class="nc bnc" id="L29306" title="All 2 branches missed.">                        if (!vCanSee.contains(ent.getOwner())) {</span>
<span class="nc" id="L29307">                            vCanSee.add(ent.getOwner());</span>
                        }
                    }
<span class="nc" id="L29310">                }</span>
            }

            // send an entity update to everyone who can see
<span class="nc" id="L29314">            Packet pack = createEntityPacket(nEntityID, movePath);</span>
<span class="nc bnc" id="L29315" title="All 2 branches missed.">            for (int x = 0; x &lt; vCanSee.size(); x++) {</span>
<span class="nc" id="L29316">                IPlayer p = vCanSee.elementAt(x);</span>
<span class="nc" id="L29317">                send(p.getId(), pack);</span>
            }
            // send an entity delete to everyone else
<span class="nc" id="L29320">            pack = createRemoveEntityPacket(nEntityID,</span>
<span class="nc" id="L29321">                                            eTarget.getRemovalCondition());</span>
<span class="nc bnc" id="L29322" title="All 2 branches missed.">            for (int x = 0; x &lt; playersVector.size(); x++) {</span>
<span class="nc bnc" id="L29323" title="All 2 branches missed.">                if (!vCanSee.contains(playersVector.elementAt(x))) {</span>
<span class="nc" id="L29324">                    IPlayer p = playersVector.elementAt(x);</span>
<span class="nc" id="L29325">                    send(p.getId(), pack);</span>
                }
            }

<span class="nc" id="L29329">            entityUpdateLoadedUnits(eTarget, vCanSee, playersVector);</span>
<span class="nc" id="L29330">        } else {</span>
            // But if we're not, then everyone can see.
<span class="nc" id="L29332">            send(createEntityPacket(nEntityID, movePath));</span>
        }
<span class="nc" id="L29334">    }</span>

    /**
     * Whenever updating an Entity, we also need to update all of its loaded
     * Entity's, otherwise it could cause issues with Clients.
     *
     * @param loader        An Entity being updated that is transporting units that should
     *                      also send an update
     * @param vCanSee       The list of Players who can see the loader.
     * @param playersVector The list of all Players
     */
    private void entityUpdateLoadedUnits(Entity loader,
                                         Vector&lt;IPlayer&gt; vCanSee, Vector&lt;IPlayer&gt; playersVector) {
        Packet pack;

        // In double-blind, the client may not know about the loaded units,
        // so we need to send them.
<span class="nc bnc" id="L29351" title="All 2 branches missed.">        for (Entity eLoaded : loader.getLoadedUnits()) {</span>
            // send an entity update to everyone who can see
<span class="nc" id="L29353">            pack = createEntityPacket(eLoaded.getId(), null);</span>
<span class="nc bnc" id="L29354" title="All 2 branches missed.">            for (int x = 0; x &lt; vCanSee.size(); x++) {</span>
<span class="nc" id="L29355">                IPlayer p = vCanSee.elementAt(x);</span>
<span class="nc" id="L29356">                send(p.getId(), pack);</span>
            }
            // send an entity delete to everyone else
<span class="nc" id="L29359">            pack = createRemoveEntityPacket(eLoaded.getId(),</span>
<span class="nc" id="L29360">                                            eLoaded.getRemovalCondition());</span>
<span class="nc bnc" id="L29361" title="All 2 branches missed.">            for (int x = 0; x &lt; playersVector.size(); x++) {</span>
<span class="nc bnc" id="L29362" title="All 2 branches missed.">                if (!vCanSee.contains(playersVector.elementAt(x))) {</span>
<span class="nc" id="L29363">                    IPlayer p = playersVector.elementAt(x);</span>
<span class="nc" id="L29364">                    send(p.getId(), pack);</span>
                }
            }
<span class="nc" id="L29367">            entityUpdateLoadedUnits(eLoaded, vCanSee, playersVector);</span>
<span class="nc" id="L29368">        }</span>
<span class="nc" id="L29369">    }</span>

    /**
     * Returns a vector of which players can see this entity, always allowing
     * for sensor detections.
     */
    private Vector&lt;IPlayer&gt; whoCanSee(Entity entity) {
<span class="nc" id="L29376">        return whoCanSee(entity, true, null);</span>
    }

    /**
     * Returns a vector of which players can see the given entity, optionally
     * allowing for sensors to count.
     *
     * @param entity     The entity to check visibility for
     * @param useSensors A flag that determines whether sensors are allowed
     * @return A vector of the players who can see the entity
     */
    private Vector&lt;IPlayer&gt; whoCanSee(Entity entity, boolean useSensors,
            Map&lt;EntityTargetPair, LosEffects&gt; losCache) {
<span class="nc bnc" id="L29389" title="All 2 branches missed.">        if (losCache == null) {</span>
<span class="nc" id="L29390">            losCache = new HashMap&lt;&gt;();</span>
        }
        // Some times Null entities are sent to this
<span class="nc bnc" id="L29393" title="All 2 branches missed.">        if (entity == null) {</span>
<span class="nc" id="L29394">            return new Vector&lt;&gt;();</span>
        }

<span class="nc" id="L29397">        List&lt;ECMInfo&gt; allECMInfo = null;</span>
<span class="nc bnc" id="L29398" title="All 4 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_SENSORS) &amp;&amp; useSensors) {</span>
<span class="nc" id="L29399">            allECMInfo = ComputeECM.computeAllEntitiesECMInfo(game</span>
<span class="nc" id="L29400">                    .getEntitiesVector());</span>
        }

<span class="nc" id="L29403">        boolean bTeamVision = game.getOptions().booleanOption(OptionsConstants.ADVANCED_TEAM_VISION);</span>
<span class="nc" id="L29404">        List&lt;Entity&gt; vEntities = game.getEntitiesVector();</span>

<span class="nc" id="L29406">        Vector&lt;IPlayer&gt; vCanSee = new Vector&lt;&gt;();</span>
<span class="nc" id="L29407">        vCanSee.addElement(entity.getOwner());</span>
<span class="nc bnc" id="L29408" title="All 2 branches missed.">        if (bTeamVision) {</span>
<span class="nc" id="L29409">            addTeammates(vCanSee, entity.getOwner());</span>
        }

        // Deal with players who can see all.
<span class="nc bnc" id="L29413" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; p = game.getPlayers(); p.hasMoreElements();) {</span>
<span class="nc" id="L29414">            IPlayer player = p.nextElement();</span>

<span class="nc bnc" id="L29416" title="All 4 branches missed.">            if (player.canSeeAll() &amp;&amp; !vCanSee.contains(player)) {</span>
<span class="nc" id="L29417">                vCanSee.addElement(player);</span>
            }
<span class="nc" id="L29419">        }</span>

        // If the entity is hidden, skip; no one else will be able to see it.
<span class="nc bnc" id="L29422" title="All 2 branches missed.">        if (entity.isHidden()) {</span>
<span class="nc" id="L29423">            return vCanSee;</span>
        }
<span class="nc bnc" id="L29425" title="All 2 branches missed.">        for (Entity spotter : vEntities) {</span>
            // Certain conditions make the spotter ineligible
<span class="nc bnc" id="L29427" title="All 4 branches missed.">            if (!spotter.isActive() || spotter.isOffBoard()</span>
<span class="nc bnc" id="L29428" title="All 2 branches missed.">                    || vCanSee.contains(spotter.getOwner())) {</span>
<span class="nc" id="L29429">                continue;</span>
            }
            // See if the LosEffects is cached, and if not cache it
<span class="nc" id="L29432">            EntityTargetPair etp = new EntityTargetPair(spotter, entity);</span>
<span class="nc" id="L29433">            LosEffects los = losCache.get(etp);</span>
<span class="nc bnc" id="L29434" title="All 2 branches missed.">            if (los == null) {</span>
<span class="nc" id="L29435">                los = LosEffects.calculateLos(game, spotter.getId(), entity);</span>
<span class="nc" id="L29436">                losCache.put(etp, los);</span>
            }
<span class="nc bnc" id="L29438" title="All 2 branches missed.">            if (Compute.canSee(game, spotter, entity, useSensors, los,</span>
                    allECMInfo)) {
<span class="nc bnc" id="L29440" title="All 2 branches missed.">                if (!vCanSee.contains(spotter.getOwner())) {</span>
<span class="nc" id="L29441">                    vCanSee.addElement(spotter.getOwner());</span>
                }
<span class="nc bnc" id="L29443" title="All 2 branches missed.">                if (bTeamVision) {</span>
<span class="nc" id="L29444">                    addTeammates(vCanSee, spotter.getOwner());</span>
                }
<span class="nc" id="L29446">                addObservers(vCanSee);</span>
            }
<span class="nc" id="L29448">        }</span>
<span class="nc" id="L29449">        return vCanSee;</span>
    }

    /**
     * Determine which players can detect the given entity with sensors.
     * Because recomputing ECM and LosEffects frequently can get expensive, this
     * data can be cached and passed in.
     *
     * @param entity        The Entity being detected.
     * @param allECMInfo    Cached ECMInfo for all Entities in the game.
     * @param losCache      Cached LosEffects for particular Entity/Targetable
     *                      pairs.  Can be passed in null.
     * @return
     */
    private Vector&lt;IPlayer&gt; whoCanDetect(Entity entity,
            List&lt;ECMInfo&gt; allECMInfo,
            Map&lt;EntityTargetPair, LosEffects&gt; losCache) {
<span class="nc bnc" id="L29466" title="All 2 branches missed.">        if (losCache == null) {</span>
<span class="nc" id="L29467">            losCache = new HashMap&lt;&gt;();</span>
        }

<span class="nc" id="L29470">        boolean bTeamVision = game.getOptions().booleanOption(OptionsConstants.ADVANCED_TEAM_VISION);</span>
<span class="nc" id="L29471">        List&lt;Entity&gt; vEntities = game.getEntitiesVector();</span>

<span class="nc" id="L29473">        Vector&lt;IPlayer&gt; vCanDetect = new Vector&lt;&gt;();</span>

        // If the entity is hidden, skip; no one else will be able to detect it
<span class="nc bnc" id="L29476" title="All 4 branches missed.">        if (entity.isHidden() || entity.isOffBoard()) {</span>
<span class="nc" id="L29477">            return vCanDetect;</span>
        }

<span class="nc bnc" id="L29480" title="All 2 branches missed.">        for (Entity spotter : vEntities) {</span>
<span class="nc bnc" id="L29481" title="All 4 branches missed.">            if (!spotter.isActive() || spotter.isOffBoard()</span>
<span class="nc bnc" id="L29482" title="All 2 branches missed.">                    || vCanDetect.contains(spotter.getOwner())) {</span>
<span class="nc" id="L29483">                continue;</span>
            }
            // See if the LosEffects is cached, and if not cache it
<span class="nc" id="L29486">            EntityTargetPair etp = new EntityTargetPair(spotter, entity);</span>
<span class="nc" id="L29487">            LosEffects los = losCache.get(etp);</span>
<span class="nc bnc" id="L29488" title="All 2 branches missed.">            if (los == null) {</span>
<span class="nc" id="L29489">                los = LosEffects.calculateLos(game, spotter.getId(), entity);</span>
<span class="nc" id="L29490">                losCache.put(etp, los);</span>
            }
<span class="nc bnc" id="L29492" title="All 2 branches missed.">            if (Compute.inSensorRange(game, los, spotter, entity, allECMInfo)) {</span>
<span class="nc bnc" id="L29493" title="All 2 branches missed.">                if (!vCanDetect.contains(spotter.getOwner())) {</span>
<span class="nc" id="L29494">                    vCanDetect.addElement(spotter.getOwner());</span>
                }
<span class="nc bnc" id="L29496" title="All 2 branches missed.">                if (bTeamVision) {</span>
<span class="nc" id="L29497">                    addTeammates(vCanDetect, spotter.getOwner());</span>
                }
<span class="nc" id="L29499">                addObservers(vCanDetect);</span>
            }
<span class="nc" id="L29501">            }</span>

<span class="nc" id="L29503">        return vCanDetect;</span>
    }

    /**
     * Adds teammates of a player to the Vector. Utility function for whoCanSee.
     */
    private void addTeammates(Vector&lt;IPlayer&gt; vector, IPlayer player) {
<span class="nc" id="L29510">        Vector&lt;IPlayer&gt; playersVector = game.getPlayersVector();</span>
<span class="nc bnc" id="L29511" title="All 2 branches missed.">        for (int j = 0; j &lt; playersVector.size(); j++) {</span>
<span class="nc" id="L29512">            IPlayer p = playersVector.elementAt(j);</span>
<span class="nc bnc" id="L29513" title="All 4 branches missed.">            if (!player.isEnemyOf(p) &amp;&amp; !vector.contains(p)) {</span>
<span class="nc" id="L29514">                vector.addElement(p);</span>
            }
        }
<span class="nc" id="L29517">    }</span>

    /**
     * Adds observers to the Vector. Utility function for whoCanSee.
     */
    private void addObservers(Vector&lt;IPlayer&gt; vector) {
<span class="nc" id="L29523">        Vector&lt;IPlayer&gt; playersVector = game.getPlayersVector();</span>
<span class="nc bnc" id="L29524" title="All 2 branches missed.">        for (int j = 0; j &lt; playersVector.size(); j++) {</span>
<span class="nc" id="L29525">            IPlayer p = playersVector.elementAt(j);</span>
<span class="nc bnc" id="L29526" title="All 4 branches missed.">            if (p.isObserver() &amp;&amp; !vector.contains(p)) {</span>
<span class="nc" id="L29527">                vector.addElement(p);</span>
            }
        }
<span class="nc" id="L29530">    }</span>

    /**
     * Send the complete list of entities to the players. If double_blind is in
     * effect, enforce it by filtering the entities
     */
    private void entityAllUpdate() {
        // If double-blind is in effect, filter each players' list individually,
        // and then quit out...
<span class="nc bnc" id="L29539" title="All 2 branches missed.">        if (doBlind()) {</span>
<span class="nc" id="L29540">            Vector&lt;IPlayer&gt; playersVector = game.getPlayersVector();</span>
<span class="nc bnc" id="L29541" title="All 2 branches missed.">            for (int x = 0; x &lt; playersVector.size(); x++) {</span>
<span class="nc" id="L29542">                IPlayer p = playersVector.elementAt(x);</span>
<span class="nc" id="L29543">                send(p.getId(), createFilteredEntitiesPacket(p, null));</span>
            }
<span class="nc" id="L29545">            return;</span>
        }

        // Otherwise, send the full list.
<span class="nc" id="L29549">        send(createEntitiesPacket());</span>
<span class="nc" id="L29550">    }</span>

    /**
     * Filters an entity vector according to LOS
     */
    private List&lt;Entity&gt; filterEntities(IPlayer pViewer,
            List&lt;Entity&gt; vEntities,
            Map&lt;EntityTargetPair, LosEffects&gt; losCache) {
<span class="nc bnc" id="L29558" title="All 2 branches missed.">        if (losCache == null) {</span>
<span class="nc" id="L29559">            losCache = new HashMap&lt;&gt;();</span>
        }
<span class="nc" id="L29561">        Vector&lt;Entity&gt; vCanSee = new Vector&lt;&gt;();</span>
<span class="nc" id="L29562">        Vector&lt;Entity&gt; vMyEntities = new Vector&lt;&gt;();</span>
<span class="nc" id="L29563">        boolean bTeamVision = game.getOptions().booleanOption(OptionsConstants.ADVANCED_TEAM_VISION);</span>

        // If they can see all, return the input list
<span class="nc bnc" id="L29566" title="All 2 branches missed.">        if (pViewer.canSeeAll()) {</span>
<span class="nc" id="L29567">            return vEntities;</span>
        }

<span class="nc" id="L29570">        List&lt;ECMInfo&gt; allECMInfo = null;</span>
<span class="nc bnc" id="L29571" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_SENSORS)) {</span>
<span class="nc" id="L29572">            allECMInfo = ComputeECM.computeAllEntitiesECMInfo(game.getEntitiesVector());</span>
        }

        // If they're an observer, they can see anything seen by any enemy.
<span class="nc bnc" id="L29576" title="All 2 branches missed.">        if (pViewer.isObserver()) {</span>
<span class="nc" id="L29577">            vMyEntities.addAll(vEntities);</span>
<span class="nc bnc" id="L29578" title="All 2 branches missed.">            for (Entity a : vMyEntities) {</span>
<span class="nc bnc" id="L29579" title="All 2 branches missed.">                for (Entity b : vMyEntities) {</span>
<span class="nc bnc" id="L29580" title="All 2 branches missed.">                    if (a.isEnemyOf(b)</span>
<span class="nc bnc" id="L29581" title="All 2 branches missed.">                        &amp;&amp; Compute.canSee(game, b, a, true, null, allECMInfo)) {</span>
<span class="nc" id="L29582">                        addVisibleEntity(vCanSee, a);</span>
<span class="nc" id="L29583">                        break;</span>
                    }
<span class="nc" id="L29585">                }</span>
<span class="nc" id="L29586">            }</span>
<span class="nc" id="L29587">            return vCanSee;</span>
        }

        // If they aren't an observer and can't see all, create the list of
        // &quot;friendly&quot; units.
<span class="nc bnc" id="L29592" title="All 2 branches missed.">        for (Entity e : vEntities) {</span>
<span class="nc bnc" id="L29593" title="All 6 branches missed.">            if ((e.getOwner() == pViewer) || (bTeamVision &amp;&amp; !e.getOwner().isEnemyOf(pViewer))) {</span>
<span class="nc" id="L29594">                vMyEntities.addElement(e);</span>
            }
<span class="nc" id="L29596">        }</span>

        // Then, break down the list by whether they're friendly,
        // or whether or not any friendly unit can see them.
<span class="nc bnc" id="L29600" title="All 2 branches missed.">        for (Entity e : vEntities) {</span>
            // If it's their own unit, obviously, they can see it.
<span class="nc bnc" id="L29602" title="All 2 branches missed.">            if (vMyEntities.contains(e)) {</span>
<span class="nc" id="L29603">                addVisibleEntity(vCanSee, e);</span>
<span class="nc" id="L29604">                continue;</span>
<span class="nc bnc" id="L29605" title="All 2 branches missed.">            } else if (e.isHidden()) {</span>
                // If it's NOT friendly and is hidden, they can't see it,
                // period.
                // LOS doesn't matter.
<span class="nc" id="L29609">                continue;</span>
            }
<span class="nc bnc" id="L29611" title="All 2 branches missed.">            for (Entity spotter : vMyEntities) {</span>

                // If they're off-board, skip it; they can't see anything.
<span class="nc bnc" id="L29614" title="All 2 branches missed.">                if (spotter.isOffBoard()) {</span>
<span class="nc" id="L29615">                    continue;</span>
                }

                // See if the LosEffects is cached, and if not cache it
<span class="nc" id="L29619">                EntityTargetPair etp = new EntityTargetPair(spotter, e);</span>
<span class="nc" id="L29620">                LosEffects los = losCache.get(etp);</span>
<span class="nc bnc" id="L29621" title="All 2 branches missed.">                if (los == null) {</span>
<span class="nc" id="L29622">                    los = LosEffects.calculateLos(game, spotter.getId(), e);</span>
<span class="nc" id="L29623">                    losCache.put(etp, los);</span>
                }
                // Otherwise, if they can see the entity in question
<span class="nc bnc" id="L29626" title="All 2 branches missed.">                if (Compute.canSee(game, spotter, e, true, los, allECMInfo)) {</span>
<span class="nc" id="L29627">                    addVisibleEntity(vCanSee, e);</span>
<span class="nc" id="L29628">                    break;</span>
                }

                // If this unit has ECM, players with units affected by the ECM
                //  will need to know about this entity, even if they can't see
                //  it.  Otherwise, the client can't properly report things
                //  like to-hits.
<span class="nc bnc" id="L29635" title="All 4 branches missed.">                if ((e.getECMRange() &gt; 0) &amp;&amp; (e.getPosition() != null) &amp;&amp;</span>
<span class="nc bnc" id="L29636" title="All 2 branches missed.">                    (spotter.getPosition() != null)) {</span>
<span class="nc" id="L29637">                    int ecmRange = e.getECMRange();</span>
<span class="nc" id="L29638">                    Coords pos = e.getPosition();</span>
<span class="nc bnc" id="L29639" title="All 2 branches missed.">                    if (pos.distance(spotter.getPosition()) &lt;= ecmRange) {</span>
<span class="nc" id="L29640">                        addVisibleEntity(vCanSee, e);</span>
                    }
                }
<span class="nc" id="L29643">            }</span>
<span class="nc" id="L29644">        }</span>

<span class="nc" id="L29646">        return vCanSee;</span>
    }

    /**
     * Recursive method to add an &lt;code&gt;Entity&lt;/code&gt; and all of its transported
     * units to the list of units visible to a particular player. It is
     * important to ensure that if a unit is in the list of visible units then
     * all of its transported units (and their transported units, and so on) are
     * also considered visible, otherwise it can lead to issues. This method
     * also ensures that no duplicate Entities are added.
     *
     * @param vCanSee A collection of units that can be see
     * @param e       An Entity that is seen and needs to be added to the collection
     *                of seen entities. All of
     */
    private void addVisibleEntity(Vector&lt;Entity&gt; vCanSee, Entity e) {
<span class="nc bnc" id="L29662" title="All 2 branches missed.">        if (!vCanSee.contains(e)) {</span>
<span class="nc" id="L29663">            vCanSee.add(e);</span>
        }
<span class="nc bnc" id="L29665" title="All 2 branches missed.">        for (Entity transported : e.getLoadedUnits()) {</span>
<span class="nc" id="L29666">            addVisibleEntity(vCanSee, transported);</span>
<span class="nc" id="L29667">        }</span>
<span class="nc" id="L29668">    }</span>

    /**
     * Filter a report vector for double blind.
     *
     * @param originalReportVector the original &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt;
     * @param p                    the &lt;code&gt;Player&lt;/code&gt; who should see stuff only visible to
     *                             him
     * @return the &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt; with stuff only Player p can see
     */
    private Vector&lt;Report&gt; filterReportVector(Vector&lt;Report&gt; originalReportVector, IPlayer p) {
        // If no double blind, no filtering to do
<span class="nc bnc" id="L29680" title="All 2 branches missed.">        if (!doBlind()) {</span>
<span class="nc" id="L29681">            return new Vector&lt;&gt;(originalReportVector);</span>
        }
        // But if it is, then filter everything properly.
<span class="nc" id="L29684">        Vector&lt;Report&gt; filteredReportVector = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L29685" title="All 2 branches missed.">        for (Report r : originalReportVector) {</span>
<span class="nc" id="L29686">            Report filteredReport = filterReport(r, p, false);</span>
<span class="nc bnc" id="L29687" title="All 2 branches missed.">            if (filteredReport != null) {</span>
<span class="nc" id="L29688">                filteredReportVector.addElement(filteredReport);</span>
            }
<span class="nc" id="L29690">        }</span>
<span class="nc" id="L29691">        return filteredReportVector;</span>
    }

    /**
     * Filter a single report so that the correct double-blind obscuration takes
     * place. To mark a message as &quot;this should be visible to anyone seeing this
     * entity&quot; set r.subject to the entity id to mark a message as &quot;only visible
     * to the player&quot; set r.player to that player's id and set r.type to
     * Report.PLAYER to mark a message as visible to all, set r.type to
     * Report.PUBLIC
     *
     * @param r         the Report to filter
     * @param p         the Player that we are going to send the filtered report to
     * @param omitCheck boolean indicating that this report happened in the past, so we
     *                  no longer have access to the Player
     * @return a new Report, which has possibly been obscured
     */
    private Report filterReport(Report r, IPlayer p, boolean omitCheck) {
<span class="nc bnc" id="L29709" title="All 6 branches missed.">        if ((r.subject == Entity.NONE) &amp;&amp; (r.type != Report.PLAYER) &amp;&amp; (r.type != Report.PUBLIC)) {</span>
            // Reports that don't have a subject should be public.
<span class="nc" id="L29711">            MegaMek.getLogger().error(&quot;Attempting to filter a Report object that is not public yet &quot;</span>
                            + &quot;but has no subject.\n\t\tmessageId: &quot; + r.messageId);
<span class="nc" id="L29713">            return r;</span>
        }
<span class="nc bnc" id="L29715" title="All 6 branches missed.">        if ((r.type == Report.PUBLIC) || ((p == null) &amp;&amp; !omitCheck)) {</span>
<span class="nc" id="L29716">            return r;</span>
        }
<span class="nc" id="L29718">        Entity entity = game.getEntity(r.subject);</span>
<span class="nc bnc" id="L29719" title="All 2 branches missed.">        if (entity == null) {</span>
<span class="nc" id="L29720">            entity = game.getOutOfGameEntity(r.subject);</span>
        }
<span class="nc" id="L29722">        IPlayer owner = null;</span>
<span class="nc bnc" id="L29723" title="All 2 branches missed.">        if (entity != null) {</span>
<span class="nc" id="L29724">            owner = entity.getOwner();</span>
            // off board (Artillery) units get treated as public messages
<span class="nc bnc" id="L29726" title="All 2 branches missed.">            if (entity.isOffBoard()) {</span>
<span class="nc" id="L29727">                return r;</span>
            }
        }

<span class="nc bnc" id="L29731" title="All 8 branches missed.">        if ((r.type != Report.PLAYER) &amp;&amp; !omitCheck</span>
            &amp;&amp; ((entity == null) || (owner == null))) {
<span class="nc" id="L29733">            MegaMek.getLogger().error(&quot;Attempting to filter a report object that is not public but has a subject (&quot;</span>
                            + entity + &quot;) with owner (&quot; + owner + &quot;).\n\tmessageId: &quot; + r.messageId);
<span class="nc" id="L29735">            return r;</span>
        }

<span class="nc bnc" id="L29738" title="All 4 branches missed.">        boolean shouldObscure = omitCheck</span>
<span class="nc bnc" id="L29739" title="All 4 branches missed.">                                || ((entity != null) &amp;&amp; !entity.hasSeenEntity(p))</span>
<span class="nc bnc" id="L29740" title="All 2 branches missed.">                                || ((r.type == Report.PLAYER) &amp;&amp; (p.getId() != r.player));</span>
        // If suppressing double blind messages, don't send this report at all.
<span class="nc" id="L29742">        if (game.getOptions()</span>
<span class="nc bnc" id="L29743" title="All 4 branches missed.">                .booleanOption(OptionsConstants.ADVANCED_SUPRESS_ALL_DB_MESSAGES)</span>
            &amp;&amp; shouldObscure) {
            // Mark the original report to indicate it was filtered
<span class="nc bnc" id="L29746" title="All 2 branches missed.">            if (p != null) {</span>
<span class="nc" id="L29747">                r.addObscuredRecipient(p.getName());</span>
            }
<span class="nc" id="L29749">            return null;</span>
        }
<span class="nc" id="L29751">        Report copy = new Report(r);</span>
        // Otherwise, obscure data in the report
<span class="nc bnc" id="L29753" title="All 2 branches missed.">        for (int j = 0; j &lt; copy.dataCount(); j++) {</span>
<span class="nc bnc" id="L29754" title="All 2 branches missed.">            if (shouldObscure) {</span>
                // This report should be obscured
<span class="nc bnc" id="L29756" title="All 2 branches missed.">                if (r.isValueObscured(j)) {</span>
<span class="nc" id="L29757">                    copy.hideData(j);</span>
                    // Mark the original report to indicate which players
                    // received an obscured version of it.
<span class="nc bnc" id="L29760" title="All 2 branches missed.">                    if (p != null) {</span>
<span class="nc" id="L29761">                        r.addObscuredRecipient(p.getName());</span>
                    }
                }
            }
        }
<span class="nc" id="L29766">        return copy;</span>
    }

    /**
     *
     * @return a vector which has as its keys the round number and as its
     *         elements vectors that contain all the reports for the specified player
     *         that round. The reports returned this way are properly filtered for
     *         double blind.
     */
    private Vector&lt;Vector&lt;Report&gt;&gt; filterPastReports(
            Vector&lt;Vector&lt;Report&gt;&gt; pastReports, IPlayer p) {
        // Only actually bother with the filtering if double-blind is in effect.
<span class="nc bnc" id="L29779" title="All 2 branches missed.">        if (!doBlind()) {</span>
<span class="nc" id="L29780">            return pastReports;</span>
        }
        // Perform filtering
<span class="nc" id="L29783">        Vector&lt;Vector&lt;Report&gt;&gt; filteredReports = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L29784" title="All 2 branches missed.">        for (Vector&lt;Report&gt; roundReports : pastReports) {</span>
<span class="nc" id="L29785">            Vector&lt;Report&gt; filteredRoundReports = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L29786" title="All 2 branches missed.">            for (Report r : roundReports) {</span>
<span class="nc bnc" id="L29787" title="All 2 branches missed.">                if (r.isObscuredRecipient(p.getName())) {</span>
<span class="nc" id="L29788">                    r = filterReport(r, null, true);</span>
                }
<span class="nc bnc" id="L29790" title="All 2 branches missed.">                if (r != null) {</span>
<span class="nc" id="L29791">                    filteredRoundReports.addElement(r);</span>
                }
<span class="nc" id="L29793">            }</span>
<span class="nc" id="L29794">            filteredReports.addElement(filteredRoundReports);</span>
<span class="nc" id="L29795">        }</span>
<span class="nc" id="L29796">        return filteredReports;</span>
    }

    /**
     * Updates entities graphical &quot;visibility indications&quot; which are used in
     * double-blind games.
     *
     * @param losCache  It can be expensive to have to recompute LoSEffects
     *                  again and again, so in some cases where this may happen,
     *                  the LosEffects are cached.   This can safely be null.
     */
    private void updateVisibilityIndicator(Map&lt;EntityTargetPair, LosEffects&gt; losCache) {
<span class="nc bnc" id="L29808" title="All 2 branches missed.">        if (losCache == null) {</span>
<span class="nc" id="L29809">            losCache = new HashMap&lt;&gt;();</span>
        }
<span class="nc" id="L29811">        List&lt;ECMInfo&gt; allECMInfo = null;</span>
<span class="nc bnc" id="L29812" title="All 2 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVANCED_TACOPS_SENSORS)) {</span>
<span class="nc" id="L29813">            allECMInfo = ComputeECM.computeAllEntitiesECMInfo(game</span>
<span class="nc" id="L29814">                    .getEntitiesVector());</span>
        }

<span class="nc" id="L29817">        List&lt;Entity&gt; vAllEntities = game.getEntitiesVector();</span>
<span class="nc bnc" id="L29818" title="All 2 branches missed.">        for (Entity e : vAllEntities) {</span>
<span class="nc" id="L29819">            Vector&lt;IPlayer&gt; whoCouldSee = new Vector&lt;&gt;(e.getWhoCanSee());</span>
<span class="nc" id="L29820">            Vector&lt;IPlayer&gt; whoCouldDetect = new Vector&lt;&gt;(e.getWhoCanDetect());</span>
<span class="nc" id="L29821">            e.setVisibleToEnemy(false);</span>
<span class="nc" id="L29822">            e.setDetectedByEnemy(false);</span>
<span class="nc" id="L29823">            e.clearSeenBy();</span>
<span class="nc" id="L29824">            e.clearDetectedBy();</span>
<span class="nc" id="L29825">            Vector&lt;IPlayer&gt; vCanSee = whoCanSee(e, false, losCache);</span>
            // Who can See this unit?
<span class="nc bnc" id="L29827" title="All 2 branches missed.">            for (IPlayer p : vCanSee) {</span>
<span class="nc bnc" id="L29828" title="All 4 branches missed.">                if (e.getOwner().isEnemyOf(p) &amp;&amp; !p.isObserver()) {</span>
<span class="nc" id="L29829">                    e.setVisibleToEnemy(true);</span>
<span class="nc" id="L29830">                    e.setEverSeenByEnemy(true);</span>
                    // If we can see it, it's detected
<span class="nc" id="L29832">                    e.setDetectedByEnemy(true);</span>
                }
<span class="nc" id="L29834">                e.addBeenSeenBy(p);</span>
<span class="nc" id="L29835">            }</span>
            // Who can Detect this unit?
<span class="nc" id="L29837">            Vector&lt;IPlayer&gt; vCanDetect = whoCanDetect(e, allECMInfo, losCache);</span>
<span class="nc bnc" id="L29838" title="All 2 branches missed.">            for (IPlayer p : vCanDetect) {</span>
<span class="nc bnc" id="L29839" title="All 4 branches missed.">                if (e.getOwner().isEnemyOf(p) &amp;&amp; !p.isObserver()) {</span>
<span class="nc" id="L29840">                    e.setDetectedByEnemy(true);</span>
                }
<span class="nc" id="L29842">                e.addBeenDetectedBy(p);</span>
<span class="nc" id="L29843">            }</span>

            // If a client can now see/detect this entity, but couldn't before,
            // then the client needs to be updated with the Entity
<span class="nc" id="L29847">            boolean hasClientWithoutEntity = false;</span>
<span class="nc bnc" id="L29848" title="All 2 branches missed.">            for (IPlayer p : vCanSee) {</span>
<span class="nc bnc" id="L29849" title="All 4 branches missed.">                if (!whoCouldSee.contains(p) &amp;&amp; !whoCouldDetect.contains(p)) {</span>
<span class="nc" id="L29850">                    hasClientWithoutEntity = true;</span>
<span class="nc" id="L29851">                    break;</span>
                }
<span class="nc" id="L29853">            }</span>
<span class="nc bnc" id="L29854" title="All 2 branches missed.">            if (!hasClientWithoutEntity) {</span>
<span class="nc bnc" id="L29855" title="All 2 branches missed.">                for (IPlayer p : vCanDetect) {</span>
<span class="nc bnc" id="L29856" title="All 4 branches missed.">                    if (!whoCouldSee.contains(p) &amp;&amp; !whoCouldDetect.contains(p)) {</span>
<span class="nc" id="L29857">                        hasClientWithoutEntity = true;</span>
<span class="nc" id="L29858">                        break;</span>
                    }
<span class="nc" id="L29860">                }</span>
            }
<span class="nc bnc" id="L29862" title="All 2 branches missed.">            if (hasClientWithoutEntity) {</span>
<span class="nc" id="L29863">                entityUpdate(e.getId(), new Vector&lt;&gt;(), false, losCache);</span>
            } else {
<span class="nc" id="L29865">                sendVisibilityIndicator(e);</span>
            }
<span class="nc" id="L29867">        }</span>
<span class="nc" id="L29868">    }</span>

    /**
     * Checks if an entity added by the client is valid and if so, adds it to
     * the list
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityAdd(Packet c, int connIndex) {
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L29879">        final List&lt;Entity&gt; entities = (List&lt;Entity&gt;) c.getObject(0);</span>
<span class="nc" id="L29880">        List&lt;Integer&gt; entityIds = new ArrayList&lt;&gt;(entities.size());</span>
        // Map client-received to server-given IDs: 
<span class="nc" id="L29882">        Map&lt;Integer, Integer&gt; idMap = new HashMap&lt;&gt;();</span>

<span class="nc bnc" id="L29884" title="All 2 branches missed.">        for (final Entity entity : entities) {</span>

            // Verify the entity's design
<span class="nc bnc" id="L29887" title="All 2 branches missed.">            if (Server.entityVerifier == null) {</span>
<span class="nc" id="L29888">                Server.entityVerifier = EntityVerifier.getInstance(new MegaMekFile(</span>
<span class="nc" id="L29889">                        Configuration.unitsDir(), EntityVerifier.CONFIG_FILENAME).getFile());</span>
            }

            // Create a TestEntity instance for supported unit types
<span class="nc" id="L29893">            TestEntity testEntity = null;</span>
<span class="nc" id="L29894">            entity.restore();</span>
<span class="nc bnc" id="L29895" title="All 2 branches missed.">            if (entity instanceof Mech) {</span>
<span class="nc" id="L29896">                testEntity = new TestMech((Mech) entity, entityVerifier.mechOption, null);</span>
<span class="nc bnc" id="L29897" title="All 2 branches missed.">            } else if ((entity.getEntityType() == Entity.ETYPE_TANK)</span>
<span class="nc bnc" id="L29898" title="All 2 branches missed.">                       &amp;&amp; (entity.getEntityType() != Entity.ETYPE_GUN_EMPLACEMENT)) {</span>
<span class="nc bnc" id="L29899" title="All 2 branches missed.">                if (entity.isSupportVehicle()) {</span>
<span class="nc" id="L29900">                    testEntity = new TestSupportVehicle(entity, entityVerifier.tankOption, null);</span>
                } else {
<span class="nc" id="L29902">                    testEntity = new TestTank((Tank) entity, entityVerifier.tankOption, null);</span>
                }
<span class="nc bnc" id="L29904" title="All 2 branches missed.">            } else if ((entity.getEntityType() == Entity.ETYPE_AERO)</span>
<span class="nc bnc" id="L29905" title="All 2 branches missed.">                       &amp;&amp; (entity.getEntityType() != Entity.ETYPE_DROPSHIP)</span>
<span class="nc bnc" id="L29906" title="All 2 branches missed.">                       &amp;&amp; (entity.getEntityType() != Entity.ETYPE_SMALL_CRAFT)</span>
<span class="nc bnc" id="L29907" title="All 2 branches missed.">                       &amp;&amp; (entity.getEntityType() != Entity.ETYPE_FIGHTER_SQUADRON)</span>
<span class="nc bnc" id="L29908" title="All 2 branches missed.">                       &amp;&amp; (entity.getEntityType() != Entity.ETYPE_JUMPSHIP)</span>
<span class="nc bnc" id="L29909" title="All 2 branches missed.">                       &amp;&amp; (entity.getEntityType() != Entity.ETYPE_SPACE_STATION)) {</span>
<span class="nc" id="L29910">                testEntity = new TestAero((Aero) entity, entityVerifier.aeroOption, null);</span>
<span class="nc bnc" id="L29911" title="All 2 branches missed.">            } else if (entity instanceof BattleArmor) {</span>
<span class="nc" id="L29912">                testEntity = new TestBattleArmor((BattleArmor) entity, entityVerifier.baOption, null);</span>
            }

<span class="nc bnc" id="L29915" title="All 2 branches missed.">            if (testEntity != null) {</span>
<span class="nc" id="L29916">                StringBuffer sb = new StringBuffer();</span>
<span class="nc bnc" id="L29917" title="All 2 branches missed.">                if (testEntity.correctEntity(sb, TechConstants.getGameTechLevel(game, entity.isClan()))) {</span>
<span class="nc" id="L29918">                    entity.setDesignValid(true);</span>
                } else {
<span class="nc" id="L29920">                    MegaMek.getLogger().error(sb.toString());</span>
<span class="nc bnc" id="L29921" title="All 2 branches missed.">                    if (game.getOptions().booleanOption(OptionsConstants.ALLOWED_ALLOW_ILLEGAL_UNITS)) {</span>
<span class="nc" id="L29922">                        entity.setDesignValid(false);</span>
                    } else {
<span class="nc" id="L29924">                        IPlayer cheater = game.getPlayer(connIndex);</span>
<span class="nc" id="L29925">                        sendServerChat(&quot;Player &quot; + cheater.getName()</span>
                                       + &quot; attempted to add an illegal unit design (&quot;
<span class="nc" id="L29927">                                       + entity.getShortNameRaw()</span>
                                       + &quot;), the unit was rejected.&quot;);
<span class="nc" id="L29929">                        return;</span>
                    }
                }
            }

            // If we're adding a ProtoMech, calculate it's unit number.
<span class="nc bnc" id="L29935" title="All 2 branches missed.">            if (entity instanceof Protomech) {</span>
                // How many ProtoMechs does the player already have?
<span class="nc" id="L29937">                int numPlayerProtos = game</span>
<span class="nc" id="L29938">                        .getSelectedEntityCount(new EntitySelector() {</span>
<span class="nc" id="L29939">                            private final int ownerId = entity.getOwnerId();</span>

                            public boolean accept(Entity entity) {
<span class="nc bnc" id="L29942" title="All 2 branches missed.">                                return (entity instanceof Protomech)</span>
<span class="nc bnc" id="L29943" title="All 2 branches missed.">                                        &amp;&amp; (ownerId == entity.getOwnerId());</span>
                            }
                        });

                // According to page 54 of the BMRr, ProtoMechs must be
                // deployed in full Points of five, unless circumstances have
                // reduced the number to less than that.
<span class="nc" id="L29950">                entity.setUnitNumber((short) (numPlayerProtos / 5));</span>
            } // End added-ProtoMech

            // Only assign an entity ID when the client hasn't.
<span class="nc bnc" id="L29954" title="All 2 branches missed.">            if (Entity.NONE == entity.getId()) {</span>
<span class="nc" id="L29955">                entity.setId(getFreeEntityId());</span>
            }

<span class="nc" id="L29958">            int clientSideId = entity.getId();</span>
<span class="nc" id="L29959">            game.addEntity(entity);</span>
            
            // Remember which received ID corresponds to which actual ID
<span class="nc" id="L29962">            idMap.put(clientSideId, entity.getId());</span>

            // Now we relink C3/NC3/C3i to our guys! Yes, this is hackish... but, we
            // do what we must. Its just too bad we have to loop over the entire entities array..
<span class="nc bnc" id="L29966" title="All 6 branches missed.">            if (entity.hasC3() || entity.hasC3i() || entity.hasNavalC3()) {</span>
<span class="nc" id="L29967">                boolean C3iSet = false;</span>

<span class="nc bnc" id="L29969" title="All 2 branches missed.">                for (Entity e : game.getEntitiesVector()) {</span>

                    // C3 Checks
<span class="nc bnc" id="L29972" title="All 2 branches missed.">                    if (entity.hasC3()) {</span>
<span class="nc bnc" id="L29973" title="All 2 branches missed.">                        if ((entity.getC3MasterIsUUIDAsString() != null)</span>
<span class="nc bnc" id="L29974" title="All 2 branches missed.">                                &amp;&amp; entity.getC3MasterIsUUIDAsString().equals(e.getC3UUIDAsString())) {</span>
<span class="nc" id="L29975">                            entity.setC3Master(e, false);</span>
<span class="nc" id="L29976">                            entity.setC3MasterIsUUIDAsString(null);</span>
<span class="nc bnc" id="L29977" title="All 2 branches missed.">                        } else if ((e.getC3MasterIsUUIDAsString() != null)</span>
<span class="nc bnc" id="L29978" title="All 2 branches missed.">                                &amp;&amp; e.getC3MasterIsUUIDAsString().equals(entity.getC3UUIDAsString())) {</span>
<span class="nc" id="L29979">                            e.setC3Master(entity, false);</span>
<span class="nc" id="L29980">                            e.setC3MasterIsUUIDAsString(null);</span>
                            // Taharqa: we need to update the other entity for
                            // the
                            // client
                            // or it won't show up right. I am not sure if I
                            // like
                            // the idea of updating other entities in this
                            // method,
                            // but it
                            // will work for now.
<span class="nc bnc" id="L29990" title="All 2 branches missed.">                            if (!entities.contains(e)) {</span>
<span class="nc" id="L29991">                                entityUpdate(e.getId());</span>
                            }
                        }
                    }

                    // C3i Checks
<span class="nc bnc" id="L29997" title="All 4 branches missed.">                    if (entity.hasC3i() &amp;&amp; !C3iSet) {</span>
<span class="nc" id="L29998">                        entity.setC3NetIdSelf();</span>
<span class="nc" id="L29999">                        int pos = 0;</span>
<span class="nc bnc" id="L30000" title="All 2 branches missed.">                        while (pos &lt; Entity.MAX_C3i_NODES) {</span>
                            // We've found a network, join it.
<span class="nc bnc" id="L30002" title="All 2 branches missed.">                            if ((entity.getC3iNextUUIDAsString(pos) != null)</span>
<span class="nc bnc" id="L30003" title="All 2 branches missed.">                                    &amp;&amp; (e.getC3UUIDAsString() != null)</span>
<span class="nc" id="L30004">                                    &amp;&amp; entity.getC3iNextUUIDAsString(pos)</span>
<span class="nc bnc" id="L30005" title="All 2 branches missed.">                                    .equals(e.getC3UUIDAsString())) {</span>
<span class="nc" id="L30006">                                entity.setC3NetId(e);</span>
<span class="nc" id="L30007">                                C3iSet = true;</span>
<span class="nc" id="L30008">                                break;</span>
                            }

<span class="nc" id="L30011">                            pos++;</span>
                        }
                    }

                    // NC3 Checks
<span class="nc bnc" id="L30016" title="All 4 branches missed.">                    if (entity.hasNavalC3() &amp;&amp; !C3iSet) {</span>
<span class="nc" id="L30017">                        entity.setC3NetIdSelf();</span>
<span class="nc" id="L30018">                        int pos = 0;</span>
<span class="nc bnc" id="L30019" title="All 2 branches missed.">                        while (pos &lt; Entity.MAX_C3i_NODES) {</span>
                            // We've found a network, join it.
<span class="nc bnc" id="L30021" title="All 2 branches missed.">                            if ((entity.getNC3NextUUIDAsString(pos) != null)</span>
<span class="nc bnc" id="L30022" title="All 2 branches missed.">                                    &amp;&amp; (e.getC3UUIDAsString() != null)</span>
<span class="nc" id="L30023">                                    &amp;&amp; entity.getNC3NextUUIDAsString(pos)</span>
<span class="nc bnc" id="L30024" title="All 2 branches missed.">                                    .equals(e.getC3UUIDAsString())) {</span>
<span class="nc" id="L30025">                                entity.setC3NetId(e);</span>
<span class="nc" id="L30026">                                C3iSet = true;</span>
<span class="nc" id="L30027">                                break;</span>
                            }

<span class="nc" id="L30030">                            pos++;</span>
                        }
                    }
<span class="nc" id="L30033">                }</span>
            }
            // Give the unit a spotlight, if it has the spotlight quirk
<span class="nc bnc" id="L30036" title="All 2 branches missed.">            entity.setExternalSpotlight(entity.hasExternaSpotlight()</span>
<span class="nc bnc" id="L30037" title="All 2 branches missed.">                    || entity.hasQuirk(OptionsConstants.QUIRK_POS_SEARCHLIGHT));</span>
<span class="nc" id="L30038">            entityIds.add(entity.getId());</span>

<span class="nc bnc" id="L30040" title="All 2 branches missed.">            if (game.getPhase() != Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L30041">                entity.getOwner().increaseInitialBV(entity.calculateBattleValue(false, false));</span>
            }
<span class="nc" id="L30043">        }</span>
        
        // Cycle through the entities again and update any carried units
        // and carrier units to use the correct server-given IDs.
        // Typically necessary when loading a MUL containing transported units.
        
        // First, deal with units loaded into bays. These are saved for the carrier
        // in MULs and must be restored exactly to recreate the bay loading.
<span class="nc" id="L30051">        Set&lt;Entity&gt; transportCorrected = new HashSet&lt;&gt;();</span>
<span class="nc bnc" id="L30052" title="All 2 branches missed.">        for (final Entity carrier: entities) {</span>
<span class="nc bnc" id="L30053" title="All 2 branches missed.">            for (int carriedId: carrier.getBayLoadedUnitIds()) {</span>
                // First, see if a bay loaded unit can be found and unloaded,
                // because it might be the wrong unit
<span class="nc" id="L30056">                Entity carried = game.getEntity(carriedId);</span>
<span class="nc bnc" id="L30057" title="All 2 branches missed.">                if (carried == null) {</span>
<span class="nc" id="L30058">                    continue;</span>
                }
<span class="nc" id="L30060">                int bay = carrier.getBay(carried).getBayNumber();</span>
<span class="nc" id="L30061">                carrier.unload(carried);</span>
                // Now, load the correct unit if there is one
<span class="nc bnc" id="L30063" title="All 2 branches missed.">                if (idMap.containsKey(carriedId)) {</span>
<span class="nc" id="L30064">                    Entity newCarried = game.getEntity(idMap.get(carriedId));</span>
<span class="nc bnc" id="L30065" title="All 2 branches missed.">                    if (carrier.canLoad(newCarried, false)) {</span>
<span class="nc" id="L30066">                        carrier.load(newCarried, false, bay);</span>
<span class="nc" id="L30067">                        newCarried.setTransportId(carrier.getId());</span>
                        // Remember that the carried unit should not be treated again below
<span class="nc" id="L30069">                        transportCorrected.add(newCarried);</span>
                    }
                }
<span class="nc" id="L30072">            }</span>
<span class="nc" id="L30073">        }</span>

        // Now restore the transport settings from the entities' transporter IDs
        // With anything other than bays, MULs only show the carrier, not the carried units 
<span class="nc bnc" id="L30077" title="All 2 branches missed.">        for (final Entity entity: entities) {</span>
            // Don't correct those that are already corrected
<span class="nc bnc" id="L30079" title="All 2 branches missed.">            if (transportCorrected.contains(entity)) {</span>
<span class="nc" id="L30080">                continue;</span>
            }
            // Get the original (client side) ID of the transporter
<span class="nc" id="L30083">            int origTrsp = entity.getTransportId();</span>
            // Only act if the unit thinks it is transported
<span class="nc bnc" id="L30085" title="All 2 branches missed.">            if (origTrsp != Entity.NONE) {</span>
                // If the transporter is among the new units, go on with loading 
<span class="nc bnc" id="L30087" title="All 2 branches missed.">                if (idMap.containsKey(origTrsp)) {</span>
                    // The wrong transporter doesn't know of anything and does not need an update
<span class="nc" id="L30089">                    Entity carrier = game.getEntity(idMap.get(origTrsp)); </span>
<span class="nc bnc" id="L30090" title="All 2 branches missed.">                    if (carrier.canLoad(entity, false)) {</span>
                        // The correct transporter must be told it's carrying something and
                        // the carried unit must be told where it is embarked
<span class="nc" id="L30093">                        carrier.load(entity, false);</span>
<span class="nc" id="L30094">                        entity.setTransportId(idMap.get(origTrsp));</span>
                    } else {
                        // This seems to be an invalid carrier; update the entity accordingly
<span class="nc" id="L30097">                        entity.setTransportId(Entity.NONE);</span>
                    }
<span class="nc" id="L30099">                } else {</span>
                    // this transporter does not exist; update the entity accordingly
<span class="nc" id="L30101">                    entity.setTransportId(Entity.NONE);</span>
                }
            }
<span class="nc" id="L30104">        }</span>
        
        // Set the &quot;loaded keepers&quot; which is apparently used for deployment unloading to
        // differentiate between units loaded in the lobby and other carried units
        // When entering a game from the lobby, this list is generated again, but not when 
        // the added entities are loaded during a game. When getting loaded units from a MUL,
        // act as if they were loaded in the lobby.
<span class="nc bnc" id="L30111" title="All 2 branches missed.">        for (final Entity entity: entities) {</span>
<span class="nc bnc" id="L30112" title="All 2 branches missed.">            if (entity.getLoadedUnits().size() &gt; 0) {</span>
<span class="nc" id="L30113">                Vector&lt;Integer&gt; v = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L30114" title="All 2 branches missed.">                for (Entity en : entity.getLoadedUnits()) {</span>
<span class="nc" id="L30115">                    v.add(en.getId());</span>
<span class="nc" id="L30116">                }</span>
<span class="nc" id="L30117">                entity.setLoadedKeepers(v);</span>
            }
<span class="nc" id="L30119">        }</span>

<span class="nc" id="L30121">        send(createAddEntityPacket(entityIds));</span>
<span class="nc" id="L30122">    }</span>

    /**
     * adds a squadron to the game
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    private void receiveSquadronAdd(Packet c, int connIndex) {

<span class="nc" id="L30132">        final FighterSquadron fs = (FighterSquadron) c.getObject(0);</span>
<span class="nc" id="L30133">        final Vector&lt;Integer&gt; fighters = (Vector&lt;Integer&gt;) c.getObject(1);</span>
<span class="nc bnc" id="L30134" title="All 2 branches missed.">        if (fighters.size() &lt; 1) {</span>
<span class="nc" id="L30135">            return;</span>
        }
        // fs.setOwner(fighters.firstElement().getOwner());
        // Only assign an entity ID when the client hasn't.
<span class="nc bnc" id="L30139" title="All 2 branches missed.">        if (Entity.NONE == fs.getId()) {</span>
<span class="nc" id="L30140">            fs.setId(getFreeEntityId());</span>
        }
<span class="nc" id="L30142">        game.addEntity(fs);</span>
<span class="nc bnc" id="L30143" title="All 2 branches missed.">        for (int id : fighters) {</span>
<span class="nc" id="L30144">            Entity fighter = game.getEntity(id);</span>
<span class="nc bnc" id="L30145" title="All 2 branches missed.">            if (null != fighter) {</span>
<span class="nc" id="L30146">                fs.load(fighter, false);</span>
<span class="nc" id="L30147">                fs.autoSetMaxBombPoints();</span>
<span class="nc" id="L30148">                fighter.setTransportId(fs.getId());</span>
                // If this is the lounge, we want to configure bombs
<span class="nc bnc" id="L30150" title="All 2 branches missed.">                if (game.getPhase() == Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L30151">                    ((IBomber)fighter).setBombChoices(fs.getBombChoices());</span>
                }
<span class="nc" id="L30153">                entityUpdate(fighter.getId());</span>
            }
<span class="nc" id="L30155">        }</span>
<span class="nc" id="L30156">        send(createAddEntityPacket(fs.getId()));</span>

<span class="nc" id="L30158">    }</span>

    /**
     * Updates an entity with the info from the client. Only valid to do this
     * during the lounge phase, except for heat sink changing.
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityUpdate(Packet c, int connIndex) {
<span class="nc" id="L30167">        Entity entity = (Entity) c.getObject(0);</span>
<span class="nc" id="L30168">        Entity oldEntity = game.getEntity(entity.getId());</span>
<span class="nc bnc" id="L30169" title="All 2 branches missed.">        if ((oldEntity != null)</span>
<span class="nc bnc" id="L30170" title="All 2 branches missed.">                &amp;&amp; ((oldEntity.getOwner() == getPlayer(connIndex)) || (oldEntity</span>
<span class="nc bnc" id="L30171" title="All 2 branches missed.">                        .getOwner().getTeam() == getPlayer(connIndex).getTeam()))) {</span>
<span class="nc" id="L30172">            game.setEntity(entity.getId(), entity);</span>
<span class="nc" id="L30173">            entityUpdate(entity.getId());</span>
            // In the chat lounge, notify players of customizing of unit
<span class="nc bnc" id="L30175" title="All 2 branches missed.">            if (game.getPhase() == IGame.Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L30176">                StringBuilder message = new StringBuilder();</span>
<span class="nc bnc" id="L30177" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.BASE_REAL_BLIND_DROP)) {</span>
<span class="nc" id="L30178">                    message.append(&quot;A Unit &quot;);</span>
<span class="nc" id="L30179">                    message.append('(').append(entity.getOwner().getName()).append(')');</span>
<span class="nc bnc" id="L30180" title="All 2 branches missed.">                } else if (game.getOptions().booleanOption(OptionsConstants.BASE_BLIND_DROP)) {</span>
<span class="nc" id="L30181">                    message.append(&quot;Unit &quot;);</span>
<span class="nc bnc" id="L30182" title="All 2 branches missed.">                    if (!entity.getExternalIdAsString().equals(&quot;-1&quot;)) {</span>
<span class="nc" id="L30183">                        message.append('[')</span>
<span class="nc" id="L30184">                               .append(entity.getExternalIdAsString())</span>
<span class="nc" id="L30185">                               .append(&quot;] &quot;);</span>
                    }
<span class="nc" id="L30187">                    message.append(entity.getId()).append(&quot; (&quot;)</span>
<span class="nc" id="L30188">                           .append(entity.getOwner().getName()).append(')');</span>
                } else {
<span class="nc" id="L30190">                    message.append(&quot;Unit &quot;);</span>
<span class="nc" id="L30191">                    message.append(entity.getDisplayName());</span>
                }
<span class="nc" id="L30193">                message.append(&quot; has been customized.&quot;);</span>
<span class="nc" id="L30194">                sendServerChat(message.toString());</span>
            }
        }
<span class="nc" id="L30197">    }</span>

    /**
     * loads an entity into another one. Meant to be called from the chat lounge
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityLoad(Packet c, int connIndex) {
<span class="nc" id="L30205">        int loadeeId = (Integer) c.getObject(0);</span>
<span class="nc" id="L30206">        int loaderId = (Integer) c.getObject(1);</span>
<span class="nc" id="L30207">        int bayNumber = (Integer) c.getObject(2);</span>
<span class="nc" id="L30208">        Entity loadee = game.getEntity(loadeeId);</span>
<span class="nc" id="L30209">        Entity loader = game.getEntity(loaderId);</span>

<span class="nc bnc" id="L30211" title="All 4 branches missed.">        if ((loadee != null) &amp;&amp; (loader != null)) {</span>
<span class="nc" id="L30212">            loadUnit(loader, loadee, bayNumber);</span>
            // In the chat lounge, notify players of customizing of unit
<span class="nc bnc" id="L30214" title="All 2 branches missed.">            if (game.getPhase() == IGame.Phase.PHASE_LOUNGE) {</span>
                /*
                 * StringBuffer message = new StringBuffer();
                 * message.append(&quot;Unit &quot;); if
                 * (game.getOptions().booleanOption(OptionsConstants.BASE_BLIND_DROP) ||
                 * game.getOptions().booleanOption(OptionsConstants.BASE_REAL_BLIND_DROP)) { if
                 * (!entity.getExternalIdAsString().equals(&quot;-1&quot;)) {
                 * message.append('[') .append(entity.getExternalIdAsString())
                 * .append(&quot;] &quot;); } message.append(entity.getId()).append('(')
                 * .append(entity.getOwner().getName()).append(')'); } else {
                 * message.append(entity.getDisplayName()); }
                 * message.append(&quot; has been customized.&quot;);
                 * sendServerChat(message.toString());
                 */
                // Set this so units can be unloaded in the first movement phase
<span class="nc" id="L30229">                loadee.setLoadedThisTurn(false);</span>
            }
        }
<span class="nc" id="L30232">    }</span>

    /**
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveCustomInit(Packet c, int connIndex) {
        // In the chat lounge, notify players of customizing of unit
<span class="nc bnc" id="L30241" title="All 2 branches missed.">        if (game.getPhase() == IGame.Phase.PHASE_LOUNGE) {</span>
<span class="nc" id="L30242">            IPlayer p = (IPlayer) c.getObject(0);</span>
<span class="nc" id="L30243">            sendServerChat(&quot;&quot; + p.getName() + &quot; has customized initiative.&quot;);</span>
        }
<span class="nc" id="L30245">    }</span>

    /**
     * receive and process an entity mode change packet
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityModeChange(Packet c, int connIndex) {
<span class="nc" id="L30254">        int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30255">        int equipId = c.getIntValue(1);</span>
<span class="nc" id="L30256">        int mode = c.getIntValue(2);</span>
<span class="nc" id="L30257">        Entity e = game.getEntity(entityId);</span>
<span class="nc bnc" id="L30258" title="All 2 branches missed.">        if (e.getOwner() != getPlayer(connIndex)) {</span>
<span class="nc" id="L30259">            return;</span>
        }
<span class="nc" id="L30261">        Mounted m = e.getEquipment(equipId);</span>

<span class="nc bnc" id="L30263" title="All 2 branches missed.">        if (m == null) {</span>
<span class="nc" id="L30264">            return;</span>
        }

        try {
            // Check for BA dumping body mounted missile launchers
<span class="nc bnc" id="L30269" title="All 4 branches missed.">            if ((e instanceof BattleArmor) &amp;&amp; (!m.isMissing())</span>
<span class="nc bnc" id="L30270" title="All 2 branches missed.">                    &amp;&amp; m.isBodyMounted()</span>
<span class="nc bnc" id="L30271" title="All 2 branches missed.">                    &amp;&amp; m.getType().hasFlag(WeaponType.F_MISSILE)</span>
<span class="nc bnc" id="L30272" title="All 2 branches missed.">                    &amp;&amp; (m.getLinked() != null)</span>
<span class="nc bnc" id="L30273" title="All 4 branches missed.">                    &amp;&amp; (m.getLinked().getUsableShotsLeft() &gt; 0)</span>
                    &amp;&amp; (mode &lt;= 0)) {
<span class="nc bnc" id="L30275" title="All 2 branches missed.">                m.setPendingDump(mode == -1);</span>
            // a mode change for ammo means dumping or hot loading
<span class="nc bnc" id="L30277" title="All 2 branches missed.">            } else if ((m.getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L30278" title="All 6 branches missed.">                &amp;&amp; !m.getType().hasInstantModeSwitch() &amp;&amp; (mode &lt; 0</span>
<span class="nc bnc" id="L30279" title="All 2 branches missed.">                            || mode == 0 &amp;&amp; m.isPendingDump())) {</span>
<span class="nc bnc" id="L30280" title="All 2 branches missed.">                m.setPendingDump(mode == -1);</span>
<span class="nc bnc" id="L30281" title="All 6 branches missed.">            } else if ((m.getType() instanceof WeaponType) &amp;&amp; m.isDWPMounted()</span>
                       &amp;&amp; (mode &lt;= 0)) {
<span class="nc bnc" id="L30283" title="All 2 branches missed.">                m.setPendingDump(mode == -1);</span>
            } else {
<span class="nc bnc" id="L30285" title="All 2 branches missed.">                if (!m.setMode(mode)) {</span>
<span class="nc" id="L30286">                    String message = e.getShortName() + &quot;: &quot; + m.getName() + &quot;: &quot; + e.getLocationName(m.getLocation())</span>
                            + &quot; trying to compensate&quot;;
<span class="nc" id="L30288">                    MegaMek.getLogger().error(message);</span>
<span class="nc" id="L30289">                    sendServerChat(message);</span>
<span class="nc" id="L30290">                    e.setGameOptions();</span>

<span class="nc bnc" id="L30292" title="All 2 branches missed.">                    if (!m.setMode(mode)) {</span>
<span class="nc" id="L30293">                        message = e.getShortName() + &quot;: &quot; + m.getName() + &quot;: &quot; + e.getLocationName(m.getLocation())</span>
                                + &quot; unable to compensate&quot;;
<span class="nc" id="L30295">                        MegaMek.getLogger().error(message);</span>
<span class="nc" id="L30296">                        sendServerChat(message);</span>
                    }

                }
            }
<span class="nc" id="L30301">        } catch (Exception ex) {</span>
<span class="nc" id="L30302">            MegaMek.getLogger().error(ex);</span>
<span class="nc" id="L30303">        }</span>

<span class="nc" id="L30305">    }</span>

    /**
     * Receive and process an Entity Sensor Change Packet
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntitySensorChange(Packet c, int connIndex) {
<span class="nc" id="L30313">        int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30314">        int sensorId = c.getIntValue(1);</span>
<span class="nc" id="L30315">        Entity e = game.getEntity(entityId);</span>
<span class="nc" id="L30316">        e.setNextSensor(e.getSensors().elementAt(sensorId));</span>
<span class="nc" id="L30317">    }</span>

    /**
     * Receive and process an Entity Heat Sinks Change Packet
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntitySinksChange(Packet c, int connIndex) {
<span class="nc" id="L30325">        int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30326">        int numSinks = c.getIntValue(1);</span>
<span class="nc" id="L30327">        Entity e = game.getEntity(entityId);</span>
<span class="nc bnc" id="L30328" title="All 4 branches missed.">        if ((e instanceof Mech) &amp;&amp; (connIndex == e.getOwnerId())) {</span>
<span class="nc" id="L30329">            ((Mech)e).setActiveSinksNextRound(numSinks);</span>
        }
<span class="nc" id="L30331">    }</span>

    /**
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityActivateHidden(Packet c, int connIndex) {
<span class="nc" id="L30339">        int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30340">        IGame.Phase phase = (IGame.Phase)c.getObject(1);</span>
<span class="nc" id="L30341">        Entity e = game.getEntity(entityId);</span>
<span class="nc bnc" id="L30342" title="All 2 branches missed.">        if (connIndex != e.getOwnerId()) {</span>
<span class="nc" id="L30343">            MegaMek.getLogger().error(&quot;Player &quot; + connIndex </span>
<span class="nc" id="L30344">                    + &quot; tried to activate a hidden unit owned by Player &quot; + e.getOwnerId());</span>
<span class="nc" id="L30345">            return;</span>
        }
<span class="nc" id="L30347">        e.setHiddeActivationPhase(phase);</span>
<span class="nc" id="L30348">        entityUpdate(entityId);</span>
<span class="nc" id="L30349">    }</span>


    /**
     * receive and process an entity nova network mode change packet
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityNovaNetworkModeChange(Packet c, int connIndex) {

        try {
<span class="nc" id="L30361">            int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30362">            String networkID = c.getObject(1).toString();</span>
<span class="nc" id="L30363">            Entity e = game.getEntity(entityId);</span>
<span class="nc bnc" id="L30364" title="All 2 branches missed.">            if (e.getOwner() != getPlayer(connIndex)) {</span>
<span class="nc" id="L30365">                return;</span>
            }
            // FIXME: Greg: This can result in setting the network to link to
            // hostile units.
            // However, it should be caught by both the isMemberOfNetwork test
            // from the c3 module as well as
            // by the clients possible input.
<span class="nc" id="L30372">            e.setNewRoundNovaNetworkString(networkID);</span>
<span class="nc" id="L30373">        } catch (Exception ex) {</span>
<span class="nc" id="L30374">            ex.printStackTrace();</span>
<span class="nc" id="L30375">        }</span>

<span class="nc" id="L30377">    }</span>

    /**
     * receive and process an entity mounted facing change packet
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityMountedFacingChange(Packet c, int connIndex) {
<span class="nc" id="L30386">        int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30387">        int equipId = c.getIntValue(1);</span>
<span class="nc" id="L30388">        int facing = c.getIntValue(2);</span>
<span class="nc" id="L30389">        Entity e = game.getEntity(entityId);</span>
<span class="nc bnc" id="L30390" title="All 2 branches missed.">        if (e.getOwner() != getPlayer(connIndex)) {</span>
<span class="nc" id="L30391">            return;</span>
        }
<span class="nc" id="L30393">        Mounted m = e.getEquipment(equipId);</span>

<span class="nc bnc" id="L30395" title="All 2 branches missed.">        if (m == null) {</span>
<span class="nc" id="L30396">            return;</span>
        }
<span class="nc" id="L30398">        m.setFacing(facing);</span>
<span class="nc" id="L30399">    }</span>

    /**
     * receive and process an entity mode change packet
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityCalledShotChange(Packet c, int connIndex) {
<span class="nc" id="L30408">        int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30409">        int equipId = c.getIntValue(1);</span>
<span class="nc" id="L30410">        Entity e = game.getEntity(entityId);</span>
<span class="nc bnc" id="L30411" title="All 2 branches missed.">        if (e.getOwner() != getPlayer(connIndex)) {</span>
<span class="nc" id="L30412">            return;</span>
        }
<span class="nc" id="L30414">        Mounted m = e.getEquipment(equipId);</span>

<span class="nc bnc" id="L30416" title="All 2 branches missed.">        if (m == null) {</span>
<span class="nc" id="L30417">            return;</span>
        }
<span class="nc" id="L30419">        m.getCalledShot().switchCalledShot();</span>
<span class="nc" id="L30420">    }</span>

    /**
     * receive and process an entity system mode change packet
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntitySystemModeChange(Packet c, int connIndex) {
<span class="nc" id="L30429">        int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30430">        int equipId = c.getIntValue(1);</span>
<span class="nc" id="L30431">        int mode = c.getIntValue(2);</span>
<span class="nc" id="L30432">        Entity e = game.getEntity(entityId);</span>
<span class="nc bnc" id="L30433" title="All 2 branches missed.">        if (e.getOwner() != getPlayer(connIndex)) {</span>
<span class="nc" id="L30434">            return;</span>
        }
<span class="nc bnc" id="L30436" title="All 4 branches missed.">        if ((e instanceof Mech) &amp;&amp; (equipId == Mech.SYSTEM_COCKPIT)) {</span>
<span class="nc" id="L30437">            ((Mech) e).setCockpitStatus(mode);</span>
        }
<span class="nc" id="L30439">    }</span>

    /**
     * Receive a packet that contains an Entity ammo change
     *
     * @param c the packet to be processed
     * @param connIndex the id for connection that received the packet.
     */
    private void receiveEntityAmmoChange(Packet c, int connIndex) {
<span class="nc" id="L30448">        int entityId = c.getIntValue(0);</span>
<span class="nc" id="L30449">        int weaponId = c.getIntValue(1);</span>
<span class="nc" id="L30450">        int ammoId = c.getIntValue(2);</span>
<span class="nc" id="L30451">        Entity e = game.getEntity(entityId);</span>

        // Did we receive a request for a valid Entity?
<span class="nc bnc" id="L30454" title="All 2 branches missed.">        if (null == e) {</span>
<span class="nc" id="L30455">            MegaMek.getLogger().error(&quot;Could not find entity# &quot; + entityId);</span>
<span class="nc" id="L30456">            return;</span>
        }
<span class="nc" id="L30458">        IPlayer player = getPlayer(connIndex);</span>
<span class="nc bnc" id="L30459" title="All 4 branches missed.">        if ((null != player) &amp;&amp; (e.getOwner() != player)) {</span>
<span class="nc" id="L30460">            MegaMek.getLogger().error(&quot;Player &quot; + player.getName() + &quot; does not own the entity &quot; + e.getDisplayName());</span>
<span class="nc" id="L30461">            return;</span>
        }

        // Make sure that the entity has the given equipment.
<span class="nc" id="L30465">        Mounted mWeap = e.getEquipment(weaponId);</span>
<span class="nc" id="L30466">        Mounted mAmmo = e.getEquipment(ammoId);</span>
<span class="nc bnc" id="L30467" title="All 2 branches missed.">        if (null == mAmmo) {</span>
<span class="nc" id="L30468">            MegaMek.getLogger().error(&quot;Entity &quot; + e.getDisplayName() + &quot; does not have ammo #&quot; + ammoId);</span>
<span class="nc" id="L30469">            return;</span>
        }
<span class="nc bnc" id="L30471" title="All 2 branches missed.">        if (!(mAmmo.getType() instanceof AmmoType)) {</span>
<span class="nc" id="L30472">            MegaMek.getLogger().error(&quot;Item #&quot; + ammoId + &quot; of entity &quot; + e.getDisplayName()</span>
<span class="nc" id="L30473">                    + &quot; is a &quot; + mAmmo.getName() + &quot; and not ammo.&quot;);</span>
<span class="nc" id="L30474">            return;</span>
        }
<span class="nc bnc" id="L30476" title="All 2 branches missed.">        if (null == mWeap) {</span>
<span class="nc" id="L30477">            MegaMek.getLogger().error(&quot;Entity &quot; + e.getDisplayName() + &quot; does not have weapon #&quot; + weaponId);</span>
<span class="nc" id="L30478">            return;</span>
        }
<span class="nc bnc" id="L30480" title="All 2 branches missed.">        if (!(mWeap.getType() instanceof WeaponType)) {</span>
<span class="nc" id="L30481">            MegaMek.getLogger().error(&quot;Item #&quot; + weaponId + &quot; of entity &quot; + e.getDisplayName()</span>
<span class="nc" id="L30482">                    + &quot; is a &quot; + mWeap.getName() + &quot; and not a weapon.&quot;);</span>
<span class="nc" id="L30483">            return;</span>
        }
<span class="nc bnc" id="L30485" title="All 2 branches missed.">        if (((WeaponType) mWeap.getType()).getAmmoType() == AmmoType.T_NA) {</span>
<span class="nc" id="L30486">            MegaMek.getLogger().error(&quot;Item #&quot; + weaponId + &quot; of entity &quot; + e.getDisplayName()</span>
<span class="nc" id="L30487">                    + &quot; is a &quot; + mWeap.getName() + &quot; and does not use ammo.&quot;);</span>
<span class="nc" id="L30488">            return;</span>
        }
<span class="nc bnc" id="L30490" title="All 2 branches missed.">        if (mWeap.getType().hasFlag(WeaponType.F_ONESHOT)</span>
<span class="nc bnc" id="L30491" title="All 2 branches missed.">                &amp;&amp; !mWeap.getType().hasFlag(WeaponType.F_DOUBLE_ONESHOT)) {</span>
<span class="nc" id="L30492">            MegaMek.getLogger().error(&quot;Item #&quot; + weaponId + &quot; of entity &quot; + e.getDisplayName()</span>
<span class="nc" id="L30493">                    + &quot; is a &quot; + mWeap.getName() + &quot; and cannot use external ammo.&quot;);</span>
<span class="nc" id="L30494">            return;</span>
        }

        // Load the weapon.
<span class="nc" id="L30498">        e.loadWeapon(mWeap, mAmmo);</span>
<span class="nc" id="L30499">    }</span>

    /**
     * Deletes an entity owned by a certain player from the list
     */
    private void receiveEntityDelete(Packet c, int connIndex) {
        @SuppressWarnings(&quot;unchecked&quot;)
<span class="nc" id="L30506">        List&lt;Integer&gt; ids = (List&lt;Integer&gt;) c.getObject(0);</span>
<span class="nc bnc" id="L30507" title="All 2 branches missed.">        for (Integer entityId : ids) {</span>
<span class="nc" id="L30508">            final Entity entity = game.getEntity(entityId);</span>

            // Only allow players to delete their *own* entities.
<span class="nc bnc" id="L30511" title="All 4 branches missed.">            if ((entity != null) &amp;&amp; (entity.getOwner() == getPlayer(connIndex))) {</span>

                // If we're deleting a ProtoMech, recalculate unit numbers.
<span class="nc bnc" id="L30514" title="All 2 branches missed.">                if (entity instanceof Protomech) {</span>

                    // How many ProtoMechs does the player have (include this one)?
<span class="nc" id="L30517">                    int numPlayerProtos = game.getSelectedEntityCount(new EntitySelector() {</span>
<span class="nc" id="L30518">                        private final int ownerId = entity.getOwnerId();</span>

                        public boolean accept(Entity entity) {
<span class="nc bnc" id="L30521" title="All 4 branches missed.">                            return (entity instanceof Protomech) &amp;&amp; (ownerId == entity.getOwnerId());</span>
                        }
                    });

                    // According to page 54 of the BMRr, ProtoMechs must be
                    // deployed in full Points of five, unless &quot;losses&quot; have
                    // reduced the number to less than that.
<span class="nc" id="L30528">                    final char oldMax = (char) (Math.ceil(numPlayerProtos / 5.0) - 1);</span>
<span class="nc" id="L30529">                    char newMax = (char) (Math.ceil((numPlayerProtos - 1) / 5.0) - 1);</span>
<span class="nc" id="L30530">                    short deletedUnitNum = entity.getUnitNumber();</span>

                    // Do we have to update a ProtoMech from the last unit?
<span class="nc bnc" id="L30533" title="All 4 branches missed.">                    if ((oldMax != deletedUnitNum) &amp;&amp; (oldMax != newMax)) {</span>

                        // Yup. Find a ProtoMech from the last unit, and
                        // set it's unit number to the deleted entity.
<span class="nc" id="L30537">                        Iterator&lt;Entity&gt; lastUnit =</span>
<span class="nc" id="L30538">                                game.getSelectedEntities(new EntitySelector() {</span>
<span class="nc" id="L30539">                                    private final int ownerId = entity.getOwnerId();</span>

<span class="nc" id="L30541">                                    private final char lastUnitNum = oldMax;</span>

                                    public boolean accept(Entity entity) {
<span class="nc bnc" id="L30544" title="All 2 branches missed.">                                        return (entity instanceof Protomech)</span>
<span class="nc bnc" id="L30545" title="All 2 branches missed.">                                                &amp;&amp; (ownerId == entity.getOwnerId())</span>
<span class="nc bnc" id="L30546" title="All 2 branches missed.">                                                &amp;&amp; (lastUnitNum == entity.getUnitNumber());</span>
                                    }
                                });
<span class="nc" id="L30549">                        Entity lastUnitMember = lastUnit.next();</span>
<span class="nc" id="L30550">                        lastUnitMember.setUnitNumber(deletedUnitNum);</span>
<span class="nc" id="L30551">                        entityUpdate(lastUnitMember.getId());</span>
                    } // End update-unit-number
                } // End added-ProtoMech

<span class="nc bnc" id="L30555" title="All 2 branches missed.">                if (game.getPhase() != IGame.Phase.PHASE_DEPLOYMENT) {</span>
                    // if a unit is removed during deployment just keep going
                    // without adjusting the turn vector.
<span class="nc" id="L30558">                    game.removeTurnFor(entity);</span>
<span class="nc" id="L30559">                    game.removeEntity(entityId, IEntityRemovalConditions.REMOVE_NEVER_JOINED);</span>
                }
            }
<span class="nc" id="L30562">        }</span>

        // during deployment this absolutely must be called before game.removeEntity(), otherwise the game hangs
        // when a unit is removed. Cause unknown.
<span class="nc" id="L30566">        send(createRemoveEntityPacket(ids, IEntityRemovalConditions.REMOVE_NEVER_JOINED));</span>

        // Prevents deployment hanging. Only do this during deployment.
<span class="nc bnc" id="L30569" title="All 2 branches missed.">        if (game.getPhase() == IGame.Phase.PHASE_DEPLOYMENT) {</span>
<span class="nc bnc" id="L30570" title="All 2 branches missed.">            for (Integer entityId : ids) {</span>
<span class="nc" id="L30571">                final Entity entity = game.getEntity(entityId);</span>
<span class="nc" id="L30572">                game.removeEntity(entityId, IEntityRemovalConditions.REMOVE_NEVER_JOINED);</span>
<span class="nc" id="L30573">                endCurrentTurn(entity);</span>
<span class="nc" id="L30574">            }</span>
        }
<span class="nc" id="L30576">    }</span>

    /**
     * Sets a player's ready status
     */
    private void receivePlayerDone(Packet pkt, int connIndex) {
<span class="nc" id="L30582">        boolean ready = pkt.getBooleanValue(0);</span>
<span class="nc" id="L30583">        IPlayer player = getPlayer(connIndex);</span>
<span class="nc bnc" id="L30584" title="All 2 branches missed.">        if (null != player) {</span>
<span class="nc" id="L30585">            player.setDone(ready);</span>
        }
<span class="nc" id="L30587">    }</span>

    private void receiveInitiativeRerollRequest(Packet pkt, int connIndex) {
<span class="nc" id="L30590">        IPlayer player = getPlayer(connIndex);</span>
<span class="nc bnc" id="L30591" title="All 2 branches missed.">        if (IGame.Phase.PHASE_INITIATIVE_REPORT != game.getPhase()) {</span>
<span class="nc" id="L30592">            StringBuilder message = new StringBuilder();</span>
<span class="nc bnc" id="L30593" title="All 2 branches missed.">            if (null == player) {</span>
<span class="nc" id="L30594">                message.append(&quot;Player #&quot;).append(connIndex);</span>
            } else {
<span class="nc" id="L30596">                message.append(player.getName());</span>
            }
<span class="nc" id="L30598">            message.append(&quot; is not allowed to ask for a reroll at this time.&quot;);</span>
<span class="nc" id="L30599">            MegaMek.getLogger().error(message.toString());</span>
<span class="nc" id="L30600">            sendServerChat(message.toString());</span>
<span class="nc" id="L30601">            return;</span>
        }
<span class="nc bnc" id="L30603" title="All 2 branches missed.">        if (game.hasTacticalGenius(player)) {</span>
<span class="nc" id="L30604">            game.addInitiativeRerollRequest(game.getTeamForPlayer(player));</span>
        }
<span class="nc bnc" id="L30606" title="All 2 branches missed.">        if (null != player) {</span>
<span class="nc" id="L30607">            player.setDone(true);</span>
        }
<span class="nc" id="L30609">        checkReady();</span>
<span class="nc" id="L30610">    }</span>

    /**
     * Sets game options, providing that the player has specified the password
     * correctly.
     *
     * @return true if any options have been successfully changed.
     */
    private boolean receiveGameOptions(Packet packet, int connId) {
<span class="nc" id="L30619">        IPlayer player = game.getPlayer(connId);</span>
        // Check player
<span class="nc bnc" id="L30621" title="All 2 branches missed.">        if (null == player) {</span>
<span class="nc" id="L30622">            MegaMek.getLogger().error(&quot;Server does not recognize player at connection &quot; + connId);</span>
<span class="nc" id="L30623">            return false;</span>
        }

        // check password
<span class="nc bnc" id="L30627" title="All 6 branches missed.">        if ((password != null) &amp;&amp; (password.length() &gt; 0) &amp;&amp; !password.equals(packet.getObject(0))) {</span>
<span class="nc" id="L30628">            sendServerChat(connId, &quot;The password you specified to change game options is incorrect.&quot;);</span>
<span class="nc" id="L30629">            return false;</span>
        }

<span class="nc bnc" id="L30632" title="All 2 branches missed.">        if (game.getPhase().isDuringOrAfter(Phase.PHASE_DEPLOYMENT)) {</span>
<span class="nc" id="L30633">            return false;</span>
        }

<span class="nc" id="L30636">        int changed = 0;</span>

<span class="nc bnc" id="L30638" title="All 2 branches missed.">        for (Enumeration&lt;?&gt; i = ((Vector&lt;?&gt;) packet.getObject(1)).elements(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L30639">            IBasicOption option = (IBasicOption) i.nextElement();</span>
<span class="nc" id="L30640">            IOption originalOption = game.getOptions().getOption(option.getName());</span>

<span class="nc bnc" id="L30642" title="All 2 branches missed.">            if (originalOption == null) {</span>
<span class="nc" id="L30643">                continue;</span>
            }

<span class="nc" id="L30646">            String message = &quot;Player &quot; + player.getName() + &quot; changed option \&quot;&quot; +</span>
<span class="nc" id="L30647">                    originalOption.getDisplayableName() + &quot;\&quot; to &quot; + option.getValue().toString() + '.';</span>
<span class="nc" id="L30648">            sendServerChat(message);</span>
<span class="nc" id="L30649">            originalOption.setValue(option.getValue());</span>
<span class="nc" id="L30650">            changed++;</span>
<span class="nc" id="L30651">        }</span>

        // Set proper RNG
<span class="nc" id="L30654">        Compute.setRNG(game.getOptions().intOption(OptionsConstants.BASE_RNG_TYPE));</span>

<span class="nc bnc" id="L30656" title="All 2 branches missed.">        if (changed &gt; 0) {</span>
<span class="nc bnc" id="L30657" title="All 2 branches missed.">            for (Entity en : game.getEntitiesVector()) {</span>
<span class="nc" id="L30658">                en.setGameOptions();</span>
<span class="nc" id="L30659">            }</span>
<span class="nc" id="L30660">            entityAllUpdate();</span>
<span class="nc" id="L30661">            return true;</span>
        }
<span class="nc" id="L30663">        return false;</span>
    }

    /**
     * Performs the additional processing of the received options after the the
     * &lt;code&gt;receiveGameOptions&lt;code&gt; done its job; should be called after
     * &lt;code&gt;receiveGameOptions&lt;code&gt; only if the &lt;code&gt;receiveGameOptions&lt;code&gt;
     * returned &lt;code&gt;true&lt;/code&gt;
     *
     * @param packet the packet to be processed
     * @param connId the id for connection that received the packet.
     */
    private void receiveGameOptionsAux(Packet packet, int connId) {
<span class="nc bnc" id="L30676" title="All 2 branches missed.">        for (Enumeration&lt;?&gt; i = ((Vector&lt;?&gt;) packet.getObject(1)).elements(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L30677">            IBasicOption option = (IBasicOption) i.nextElement();</span>
<span class="nc" id="L30678">            IOption originalOption = game.getOptions().getOption(option.getName());</span>
<span class="nc bnc" id="L30679" title="All 2 branches missed.">            if (originalOption != null) {</span>
<span class="nc bnc" id="L30680" title="All 2 branches missed.">                if (&quot;maps_include_subdir&quot;.equals(originalOption.getName())) {</span>
<span class="nc" id="L30681">                    mapSettings.setBoardsAvailableVector(scanForBoards(new BoardDimensions(</span>
<span class="nc" id="L30682">                            mapSettings.getBoardWidth(), mapSettings.getBoardHeight())));</span>
<span class="nc" id="L30683">                    mapSettings.removeUnavailable();</span>
<span class="nc" id="L30684">                    mapSettings.setNullBoards(DEFAULT_BOARD);</span>
<span class="nc" id="L30685">                    send(createMapSettingsPacket());</span>
                }
            }
<span class="nc" id="L30688">        }</span>

<span class="nc" id="L30690">    }</span>

    /**
     * Sends out the game victory event to all connections
     */
    private void transmitGameVictoryEventToAll() {
<span class="nc bnc" id="L30696" title="All 2 branches missed.">        for (IConnection conn : connections) {</span>
<span class="nc" id="L30697">            send(conn.getId(), new Packet(Packet.COMMAND_GAME_VICTORY_EVENT));</span>
<span class="nc" id="L30698">        }</span>
<span class="nc" id="L30699">    }</span>

    /**
     * Sends out all player info to the specified connection
     */
    private void transmitAllPlayerConnects(int connId) {
<span class="nc bnc" id="L30705" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L30706">            final IPlayer player = i.nextElement();</span>

<span class="nc" id="L30708">            send(connId, createPlayerConnectPacket(player.getId()));</span>
<span class="nc" id="L30709">        }</span>
<span class="nc" id="L30710">    }</span>

    /**
     * Creates a packet informing that the player has connected
     */
    private Packet createPlayerConnectPacket(int playerId) {
<span class="nc" id="L30716">        final Object[] data = new Object[2];</span>
<span class="nc" id="L30717">        data[0] = playerId;</span>
<span class="nc" id="L30718">        data[1] = getPlayer(playerId);</span>
<span class="nc" id="L30719">        return new Packet(Packet.COMMAND_PLAYER_ADD, data);</span>
    }

    /**
     * Creates a packet containing the player info, for update
     */
    private Packet createPlayerUpdatePacket(int playerId) {
<span class="nc" id="L30726">        final Object[] data = new Object[2];</span>
<span class="nc" id="L30727">        data[0] = playerId;</span>
<span class="nc" id="L30728">        data[1] = getPlayer(playerId);</span>
<span class="nc" id="L30729">        return new Packet(Packet.COMMAND_PLAYER_UPDATE, data);</span>
    }

    /**
     * Sends out the player info updates for all players to all connections
     */
    private void transmitAllPlayerUpdates() {
<span class="nc bnc" id="L30736" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L30737">            final IPlayer player = i.nextElement();</span>
<span class="nc bnc" id="L30738" title="All 2 branches missed.">            if (null != player) {</span>
<span class="nc" id="L30739">                send(createPlayerUpdatePacket(player.getId()));</span>
            }
<span class="nc" id="L30741">        }</span>
<span class="nc" id="L30742">    }</span>

    /**
     * Sends out the player ready stats for all players to all connections
     */
    private void transmitAllPlayerDones() {
<span class="nc bnc" id="L30748" title="All 2 branches missed.">        for (Enumeration&lt;IPlayer&gt; i = game.getPlayers(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L30749">            final IPlayer player = i.nextElement();</span>

<span class="nc" id="L30751">            send(createPlayerDonePacket(player.getId()));</span>
<span class="nc" id="L30752">        }</span>
<span class="nc" id="L30753">    }</span>

    /**
     * Creates a packet containing the player ready status
     */
    private Packet createPlayerDonePacket(int playerId) {
<span class="nc" id="L30759">        Object[] data = new Object[2];</span>
<span class="nc" id="L30760">        data[0] = playerId;</span>
<span class="nc" id="L30761">        data[1] = getPlayer(playerId).isDone();</span>
<span class="nc" id="L30762">        return new Packet(Packet.COMMAND_PLAYER_READY, data);</span>
    }

    /**
     * Creates a packet containing the current turn vector
     */
    private Packet createTurnVectorPacket() {
<span class="nc" id="L30769">        return new Packet(Packet.COMMAND_SENDING_TURNS, game.getTurnVector());</span>
    }

    /**
     * Creates a packet containing the current turn index
     */
    private Packet createTurnIndexPacket(int playerId) {
<span class="nc" id="L30776">        final Object[] data = new Object[3];</span>
<span class="nc" id="L30777">        data[0] = game.getTurnIndex();</span>
<span class="nc" id="L30778">        data[1] = playerId;</span>
<span class="nc" id="L30779">        return new Packet(Packet.COMMAND_TURN, data);</span>
    }

    /**
     * Creates a packet containing the map settings
     */
    private Packet createMapSettingsPacket() {
<span class="nc" id="L30786">        return new Packet(Packet.COMMAND_SENDING_MAP_SETTINGS, mapSettings);</span>
    }

    private Packet createMapSizesPacket() {
<span class="nc" id="L30790">        Set&lt;BoardDimensions&gt; sizes = getBoardSizes();</span>
<span class="nc" id="L30791">        return new Packet(Packet.COMMAND_SENDING_AVAILABLE_MAP_SIZES, sizes);</span>
    }

    /**
     * Creates a packet containing the planetary conditions
     */
    private Packet createPlanetaryConditionsPacket() {
<span class="nc" id="L30798">        return new Packet(Packet.COMMAND_SENDING_PLANETARY_CONDITIONS,</span>
<span class="nc" id="L30799">                          game.getPlanetaryConditions());</span>
    }

    /**
     * Creates a packet containing the game settings
     */
    private Packet createGameSettingsPacket() {
<span class="nc" id="L30806">        return new Packet(Packet.COMMAND_SENDING_GAME_SETTINGS, game.getOptions());</span>
    }

    /**
     * Creates a packet containing the game board
     */
    private Packet createBoardPacket() {
<span class="nc" id="L30813">        return new Packet(Packet.COMMAND_SENDING_BOARD, game.getBoard());</span>
    }

    /**
     * Creates a packet containing a single entity, for update
     */
    private Packet createEntityPacket(int entityId, Vector&lt;UnitLocation&gt; movePath) {
<span class="nc" id="L30820">        final Entity entity = game.getEntity(entityId);</span>
<span class="nc" id="L30821">        final Object[] data = new Object[3];</span>
<span class="nc" id="L30822">        data[0] = entityId;</span>
<span class="nc" id="L30823">        data[1] = entity;</span>
<span class="nc" id="L30824">        data[2] = movePath;</span>
<span class="nc" id="L30825">        return new Packet(Packet.COMMAND_ENTITY_UPDATE, data);</span>
    }

    /**
     * Creates a packet containing a Vector of Reports
     */
    private Packet createReportPacket(IPlayer p) {
        // When the final report is created, MM sends a null player to create
        // the
        // report. This will handle that issue.
<span class="nc bnc" id="L30835" title="All 4 branches missed.">        if ((p == null) || !doBlind()) {</span>
<span class="nc" id="L30836">            return new Packet(Packet.COMMAND_SENDING_REPORTS, vPhaseReport);</span>
        }
<span class="nc" id="L30838">        return new Packet(Packet.COMMAND_SENDING_REPORTS, filterReportVector(vPhaseReport, p));</span>
    }

    /**
     * Creates a packet containing a Vector of special Reports which needs to be
     * sent during a phase that is not a report phase.
     */
    private Packet createSpecialReportPacket() {
<span class="nc" id="L30846">        return new Packet(Packet.COMMAND_SENDING_REPORTS_SPECIAL, vPhaseReport.clone());</span>
    }

    /**
     * Creates a packet containing a Vector of Reports that represent a Tactical
     * Genius re-roll request which needs to update a current phase's report.
     */
    private Packet createTacticalGeniusReportPacket() {
<span class="nc" id="L30854">        return new Packet(Packet.COMMAND_SENDING_REPORTS_TACTICAL_GENIUS, vPhaseReport.clone());</span>
    }

    /**
     * Creates a packet containing all the round reports
     */
    private Packet createAllReportsPacket(IPlayer p) {
<span class="nc" id="L30861">        return new Packet(Packet.COMMAND_SENDING_REPORTS_ALL,</span>
<span class="nc" id="L30862">                filterPastReports(game.getAllReports(), p));</span>
    }

    /**
     * Creates a packet containing all current entities
     */
    private Packet createEntitiesPacket() {
<span class="nc" id="L30869">        return new Packet(Packet.COMMAND_SENDING_ENTITIES, game.getEntitiesVector());</span>
    }

    /**
     * Creates a packet containing all current and out-of-game entities
     */
    private Packet createFullEntitiesPacket() {
<span class="nc" id="L30876">        final Object[] data = new Object[2];</span>
<span class="nc" id="L30877">        data[0] = game.getEntitiesVector();</span>
<span class="nc" id="L30878">        data[1] = game.getOutOfGameEntitiesVector();</span>
<span class="nc" id="L30879">        return new Packet(Packet.COMMAND_SENDING_ENTITIES, data);</span>
    }

    /**
     * Creates a packet containing all entities visible to the player in a blind
     * game
     */
    private Packet createFilteredEntitiesPacket(IPlayer p, Map&lt;EntityTargetPair,
            LosEffects&gt; losCache) {
<span class="nc" id="L30888">        return new Packet(Packet.COMMAND_SENDING_ENTITIES,</span>
<span class="nc" id="L30889">                filterEntities(p, game.getEntitiesVector(), losCache));</span>
    }

    /**
     * Creates a packet containing all entities, including wrecks, visible to
     * the player in a blind game
     */
    private Packet createFilteredFullEntitiesPacket(IPlayer p) {
<span class="nc" id="L30897">        final Object[] data = new Object[2];</span>
<span class="nc" id="L30898">        data[0] = filterEntities(p, game.getEntitiesVector(), null);</span>
<span class="nc" id="L30899">        data[1] = game.getOutOfGameEntitiesVector();</span>
<span class="nc" id="L30900">        return new Packet(Packet.COMMAND_SENDING_ENTITIES, data);</span>
    }

    private Packet createAddEntityPacket(int entityId) {
<span class="nc" id="L30904">        ArrayList&lt;Integer&gt; entityIds = new ArrayList&lt;&gt;(1);</span>
<span class="nc" id="L30905">        entityIds.add(entityId);</span>
<span class="nc" id="L30906">        return createAddEntityPacket(entityIds);</span>
    }

    /**
     * Creates a packet detailing the addition of an entity
     */
    private Packet createAddEntityPacket(List&lt;Integer&gt; entityIds) {
<span class="nc" id="L30913">        ArrayList&lt;Entity&gt; entities = new ArrayList&lt;&gt;(entityIds.size());</span>
<span class="nc bnc" id="L30914" title="All 2 branches missed.">        for (Integer id : entityIds) {</span>
<span class="nc" id="L30915">            entities.add(game.getEntity(id));</span>
<span class="nc" id="L30916">        }</span>
<span class="nc" id="L30917">        final Object[] data = new Object[2];</span>
<span class="nc" id="L30918">        data[0] = entityIds;</span>
<span class="nc" id="L30919">        data[1] = entities;</span>
<span class="nc" id="L30920">        return new Packet(Packet.COMMAND_ENTITY_ADD, data);</span>
    }

    /**
     * Creates a packet detailing the removal of an entity. Maintained for
     * backwards compatibility.
     *
     * @param entityId - the &lt;code&gt;int&lt;/code&gt; ID of the entity being removed.
     * @return A &lt;code&gt;Packet&lt;/code&gt; to be sent to clients.
     */
    private Packet createRemoveEntityPacket(int entityId) {
<span class="nc" id="L30931">        return createRemoveEntityPacket(entityId, IEntityRemovalConditions.REMOVE_SALVAGEABLE);</span>
    }

    /**
     * Creates a packet detailing the removal of an entity.
     *
     * @param entityId  - the &lt;code&gt;int&lt;/code&gt; ID of the entity being removed.
     * @param condition - the &lt;code&gt;int&lt;/code&gt; condition the unit was in. This value
     *                  must be one of constants in
     *                  &lt;code&gt;IEntityRemovalConditions&lt;/code&gt;, or an
     *                  &lt;code&gt;IllegalArgumentException&lt;/code&gt; will be thrown.
     * @return A &lt;code&gt;Packet&lt;/code&gt; to be sent to clients.
     */
    private Packet createRemoveEntityPacket(int entityId, int condition) {
<span class="nc" id="L30945">        List&lt;Integer&gt; ids = new ArrayList&lt;&gt;(1);</span>
<span class="nc" id="L30946">        ids.add(entityId);</span>
<span class="nc" id="L30947">        return createRemoveEntityPacket(ids, condition);</span>
    }

    /**
     * Creates a packet detailing the removal of a list of entities.
     *
     * @param entityIds - the &lt;code&gt;int&lt;/code&gt; ID of each entity being removed.
     * @param condition - the &lt;code&gt;int&lt;/code&gt; condition the units were in. This value
     *                  must be one of constants in
     *                  &lt;code&gt;IEntityRemovalConditions&lt;/code&gt;, or an
     *                  &lt;code&gt;IllegalArgumentException&lt;/code&gt; will be thrown.
     * @return A &lt;code&gt;Packet&lt;/code&gt; to be sent to clients.
     */
    private Packet createRemoveEntityPacket(List&lt;Integer&gt; entityIds, int condition) {
<span class="nc bnc" id="L30961" title="All 16 branches missed.">        if ((condition != IEntityRemovalConditions.REMOVE_UNKNOWN)</span>
                &amp;&amp; (condition != IEntityRemovalConditions.REMOVE_IN_RETREAT)
                &amp;&amp; (condition != IEntityRemovalConditions.REMOVE_PUSHED)
                &amp;&amp; (condition != IEntityRemovalConditions.REMOVE_SALVAGEABLE)
                &amp;&amp; (condition != IEntityRemovalConditions.REMOVE_EJECTED)
                &amp;&amp; (condition != IEntityRemovalConditions.REMOVE_CAPTURED)
                &amp;&amp; (condition != IEntityRemovalConditions.REMOVE_DEVASTATED)
                &amp;&amp; (condition != IEntityRemovalConditions.REMOVE_NEVER_JOINED)) {
<span class="nc" id="L30969">            throw new IllegalArgumentException(&quot;Unknown unit condition: &quot; + condition);</span>
        }
<span class="nc" id="L30971">        Object[] array = new Object[2];</span>
<span class="nc" id="L30972">        array[0] = entityIds;</span>
<span class="nc" id="L30973">        array[1] = condition;</span>
<span class="nc" id="L30974">        return new Packet(Packet.COMMAND_ENTITY_REMOVE, array);</span>
    }

    /**
     * Creates a packet indicating end of game, including detailed unit status
     */
    private Packet createEndOfGamePacket() {
<span class="nc" id="L30981">        Object[] array = new Object[3];</span>
<span class="nc" id="L30982">        array[0] = getDetailedVictoryReport();</span>
<span class="nc" id="L30983">        array[1] = game.getVictoryPlayerId();</span>
<span class="nc" id="L30984">        array[2] = game.getVictoryTeam();</span>
<span class="nc" id="L30985">        return new Packet(Packet.COMMAND_END_OF_GAME, array);</span>
    }

<span class="nc" id="L30988">    public static String ORIGIN = &quot;***Server&quot;;</span>

    public static String formatChatMessage(String origin, String message) {
<span class="nc" id="L30991">        return origin + &quot;: &quot; + message;</span>
    }

    /**
     * Transmits a chat message to all players
     */
    public void sendChat(int connId, String origin, String message) {
<span class="nc" id="L30998">        send(connId, new Packet(Packet.COMMAND_CHAT, formatChatMessage(origin, message)));</span>
<span class="nc" id="L30999">    }</span>

    /**
     * Transmits a chat message to all players
     */
    private void sendChat(String origin, String message) {
<span class="nc" id="L31005">        String chat = formatChatMessage(origin, message);</span>
<span class="nc" id="L31006">        send(new Packet(Packet.COMMAND_CHAT, chat));</span>
<span class="nc" id="L31007">    }</span>

    public void sendServerChat(int connId, String message) {
<span class="nc" id="L31010">        sendChat(connId, ORIGIN, message);</span>
<span class="nc" id="L31011">    }</span>

    public void sendServerChat(String message) {
<span class="nc" id="L31014">        sendChat(ORIGIN, message);</span>
<span class="nc" id="L31015">    }</span>

    /**
     * Creates a packet containing a hex, and the coordinates it goes at.
     */
    private Packet createHexChangePacket(Coords coords, IHex hex) {
<span class="nc" id="L31021">        final Object[] data = new Object[2];</span>
<span class="nc" id="L31022">        data[0] = coords;</span>
<span class="nc" id="L31023">        data[1] = hex;</span>
<span class="nc" id="L31024">        return new Packet(Packet.COMMAND_CHANGE_HEX, data);</span>
    }

    public void sendSmokeCloudAdded(SmokeCloud cloud) {
<span class="nc" id="L31028">        final Object[] data = new Object[1];</span>
<span class="nc" id="L31029">        data[0] = cloud;</span>
<span class="nc" id="L31030">        send(new Packet(Packet.COMMAND_ADD_SMOKE_CLOUD, data));</span>
<span class="nc" id="L31031">    }</span>

    /**
     * Sends notification to clients that the specified hex has changed.
     */
    public void sendChangedHex(Coords coords) {
<span class="nc" id="L31037">        send(createHexChangePacket(coords, game.getBoard().getHex(coords)));</span>
<span class="nc" id="L31038">    }</span>

    /**
     * Creates a packet containing a hex, and the coordinates it goes at.
     */
    private Packet createHexesChangePacket(Set&lt;Coords&gt; coords, Set&lt;IHex&gt; hex) {
<span class="nc" id="L31044">        final Object[] data = new Object[2];</span>
<span class="nc" id="L31045">        data[0] = coords;</span>
<span class="nc" id="L31046">        data[1] = hex;</span>
<span class="nc" id="L31047">        return new Packet(Packet.COMMAND_CHANGE_HEXES, data);</span>
    }

    /**
     * Sends notification to clients that the specified hex has changed.
     */
    public void sendChangedHexes(Set&lt;Coords&gt; coords) {
<span class="nc" id="L31054">        Set&lt;IHex&gt; hexes = new LinkedHashSet&lt;&gt;();</span>
<span class="nc bnc" id="L31055" title="All 2 branches missed.">        for (Coords coord : coords) {</span>
<span class="nc" id="L31056">            hexes.add(game.getBoard().getHex(coord));</span>
<span class="nc" id="L31057">        }</span>
<span class="nc" id="L31058">        send(createHexesChangePacket(coords, hexes));</span>
<span class="nc" id="L31059">    }</span>

    /**
     * Creates a packet containing a vector of mines.
     */
    private Packet createMineChangePacket(Coords coords) {
<span class="nc" id="L31065">        return new Packet(Packet.COMMAND_UPDATE_MINEFIELDS, game.getMinefields(coords));</span>
    }

    /**
     * Sends notification to clients that the specified hex has changed.
     */
    public void sendChangedMines(Coords coords) {
<span class="nc" id="L31072">        send(createMineChangePacket(coords));</span>
<span class="nc" id="L31073">    }</span>

    public void sendVisibilityIndicator(Entity e) {
<span class="nc" id="L31076">        final Object[] data = new Object[6];</span>
<span class="nc" id="L31077">        data[0] = e.getId();</span>
<span class="nc" id="L31078">        data[1] = e.isEverSeenByEnemy();</span>
<span class="nc" id="L31079">        data[2] = e.isVisibleToEnemy();</span>
<span class="nc" id="L31080">        data[3] = e.isDetectedByEnemy();</span>
<span class="nc" id="L31081">        data[4] = e.getWhoCanSee();</span>
<span class="nc" id="L31082">        data[5] = e.getWhoCanDetect();</span>
<span class="nc" id="L31083">        send(new Packet(Packet.COMMAND_ENTITY_VISIBILITY_INDICATOR, data));</span>
<span class="nc" id="L31084">    }</span>

    /**
     * Creates a packet for an attack
     */
    private Packet createAttackPacket(List&lt;?&gt; vector, int charges) {
<span class="nc" id="L31090">        final Object[] data = new Object[2];</span>
<span class="nc" id="L31091">        data[0] = vector;</span>
<span class="nc" id="L31092">        data[1] = charges;</span>
<span class="nc" id="L31093">        return new Packet(Packet.COMMAND_ENTITY_ATTACK, data);</span>
    }

    /**
     * Creates a packet for an attack
     */
    private Packet createAttackPacket(EntityAction ea, int charge) {
<span class="nc" id="L31100">        Vector&lt;EntityAction&gt; vector = new Vector&lt;&gt;(1);</span>
<span class="nc" id="L31101">        vector.addElement(ea);</span>
<span class="nc" id="L31102">        Object[] data = new Object[2];</span>
<span class="nc" id="L31103">        data[0] = vector;</span>
<span class="nc" id="L31104">        data[1] = charge;</span>
<span class="nc" id="L31105">        return new Packet(Packet.COMMAND_ENTITY_ATTACK, data);</span>
    }

    /**
     *
     */
    private Packet createSpecialHexDisplayPacket(int toPlayer) {
<span class="nc" id="L31112">        Hashtable&lt;Coords, Collection&lt;SpecialHexDisplay&gt;&gt; shdTable = game</span>
<span class="nc" id="L31113">                .getBoard().getSpecialHexDisplayTable();</span>
<span class="nc" id="L31114">        Hashtable&lt;Coords, Collection&lt;SpecialHexDisplay&gt;&gt; shdTable2 = new Hashtable&lt;&gt;();</span>
        LinkedList&lt;SpecialHexDisplay&gt; tempList;
<span class="nc" id="L31116">        IPlayer player = getPlayer(toPlayer);</span>
<span class="nc bnc" id="L31117" title="All 2 branches missed.">        if (player != null) {</span>
<span class="nc bnc" id="L31118" title="All 2 branches missed.">            for (Coords coord : shdTable.keySet()) {</span>
<span class="nc" id="L31119">                tempList = new LinkedList&lt;&gt;();</span>
<span class="nc bnc" id="L31120" title="All 2 branches missed.">                for (SpecialHexDisplay shd : shdTable.get(coord)) {</span>
<span class="nc bnc" id="L31121" title="All 2 branches missed.">                    if (!shd.isObscured(player)) {</span>
<span class="nc" id="L31122">                        tempList.add(0, shd);</span>
                    }
<span class="nc" id="L31124">                }</span>
<span class="nc bnc" id="L31125" title="All 2 branches missed.">                if (!tempList.isEmpty()) {</span>
<span class="nc" id="L31126">                    shdTable2.put(coord, tempList);</span>
                }
<span class="nc" id="L31128">            }</span>
        }
<span class="nc" id="L31130">        return new Packet(Packet.COMMAND_SENDING_SPECIAL_HEX_DISPLAY, shdTable2);</span>
    }

    private Packet createTagInfoUpdatesPacket() {
<span class="nc" id="L31134">        return new Packet(Packet.COMMAND_SENDING_TAGINFO, game.getTagInfo());</span>
    }

    /**
     * Creates a packet containing off board artillery attacks
     */
    private Packet createArtilleryPacket(IPlayer p) {
<span class="nc" id="L31141">        Vector&lt;ArtilleryAttackAction&gt; v = new Vector&lt;&gt;();</span>
<span class="nc" id="L31142">        int team = p.getTeam();</span>
<span class="nc bnc" id="L31143" title="All 2 branches missed.">        for (Enumeration&lt;AttackHandler&gt; i = game.getAttacks(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L31144">            WeaponHandler wh = (WeaponHandler) i.nextElement();</span>
<span class="nc bnc" id="L31145" title="All 2 branches missed.">            if (wh.waa instanceof ArtilleryAttackAction) {</span>
<span class="nc" id="L31146">                ArtilleryAttackAction aaa = (ArtilleryAttackAction) wh.waa;</span>
<span class="nc bnc" id="L31147" title="All 4 branches missed.">                if ((aaa.getPlayerId() == p.getId())</span>
                        || ((team != IPlayer.TEAM_NONE)
<span class="nc bnc" id="L31149" title="All 2 branches missed.">                        &amp;&amp; (team == game.getPlayer(aaa.getPlayerId()).getTeam()))</span>
<span class="nc bnc" id="L31150" title="All 2 branches missed.">                        || p.getSeeAll()) {</span>
<span class="nc" id="L31151">                    v.addElement(aaa);</span>
                }
            }
<span class="nc" id="L31154">        }</span>
<span class="nc" id="L31155">        return new Packet(Packet.COMMAND_SENDING_ARTILLERYATTACKS, v);</span>
    }

    private Packet createIlluminatedHexesPacket() {
<span class="nc" id="L31159">        HashSet&lt;Coords&gt; illuminateHexes = game.getIlluminatedPositions();</span>
<span class="nc" id="L31160">        return new Packet(Packet.COMMAND_SENDING_ILLUM_HEXES, illuminateHexes);</span>
    }

    /**
     * Creates a packet containing flares
     */
    private Packet createFlarePacket() {

<span class="nc" id="L31168">        return new Packet(Packet.COMMAND_SENDING_FLARES, game.getFlares());</span>
    }

    /**
     * Send a packet to all connected clients.
     */
    private void send(Packet packet) {
<span class="nc bnc" id="L31175" title="All 2 branches missed.">        if (connections == null) {</span>
<span class="nc" id="L31176">            return;</span>
        }
<span class="nc bnc" id="L31178" title="All 2 branches missed.">        for (Enumeration&lt;IConnection&gt; connEnum = connections.elements(); connEnum.hasMoreElements(); ) {</span>
<span class="nc" id="L31179">            IConnection conn = connEnum.nextElement();</span>
<span class="nc" id="L31180">            conn.send(packet);</span>
<span class="nc" id="L31181">        }</span>
<span class="nc" id="L31182">    }</span>

    // WOR
    public void send_Nova_Change(int Id, String net) {
<span class="nc" id="L31186">        Object[] data = {Id, net};</span>
<span class="nc" id="L31187">        Packet packet = new Packet(Packet.COMMAND_ENTITY_NOVA_NETWORK_CHANGE, data);</span>
<span class="nc" id="L31188">        send(packet);</span>
<span class="nc" id="L31189">    }</span>

    private void sendReport() {
<span class="nc" id="L31192">        sendReport(false);</span>
<span class="nc" id="L31193">    }</span>

    /**
     * Send the round report to all connected clients.
     */
    private void sendReport(boolean tacticalGeniusReport) {
<span class="nc bnc" id="L31199" title="All 2 branches missed.">        if (connections == null) {</span>
<span class="nc" id="L31200">            return;</span>
        }

<span class="nc bnc" id="L31203" title="All 2 branches missed.">        for (Enumeration&lt;IConnection&gt; connEnum = connections.elements(); connEnum.hasMoreElements(); ) {</span>
<span class="nc" id="L31204">            IConnection conn = connEnum.nextElement();</span>
<span class="nc" id="L31205">            IPlayer p = game.getPlayer(conn.getId());</span>
            Packet packet;
<span class="nc bnc" id="L31207" title="All 2 branches missed.">            if (tacticalGeniusReport) {</span>
<span class="nc" id="L31208">                packet = createTacticalGeniusReportPacket();</span>
            } else {
<span class="nc" id="L31210">                packet = createReportPacket(p);</span>
            }
<span class="nc" id="L31212">            conn.send(packet);</span>
<span class="nc" id="L31213">        }</span>
<span class="nc" id="L31214">    }</span>

    /**
     * Send a packet to a specific connection.
     */
    public void send(int connId, Packet packet) {
<span class="nc bnc" id="L31220" title="All 2 branches missed.">        if (getClient(connId) != null) {</span>
<span class="nc" id="L31221">            getClient(connId).send(packet);</span>
        }
        // What should we do if we've lost this client?
        // For now, nothing.
<span class="nc" id="L31225">    }</span>

    /**
     * Send a packet to a pending connection
     */
    private void sendToPending(int connId, Packet packet) {
<span class="nc" id="L31231">        IConnection pendingConn = getPendingConnection(connId);</span>
<span class="nc bnc" id="L31232" title="All 2 branches missed.">        if (pendingConn != null) {</span>
<span class="nc" id="L31233">            pendingConn.send(packet);</span>
        }
        // What should we do if we've lost this client?
        // For now, nothing.
<span class="nc" id="L31237">    }</span>

    /**
     * Process an in-game command
     */
    private void processCommand(int connId, String commandString) {
        String[] args;
        String commandName;
        // all tokens are read as strings; if they're numbers, string-ize 'em.
        // replaced the tokenizer with the split function.
<span class="nc" id="L31247">        args = commandString.split(&quot;\\s+&quot;);</span>

        // figure out which command this is
<span class="nc" id="L31250">        commandName = args[0].substring(1);</span>

        // process it
<span class="nc" id="L31253">        ServerCommand command = getCommand(commandName);</span>
<span class="nc bnc" id="L31254" title="All 2 branches missed.">        if (command != null) {</span>
<span class="nc" id="L31255">            command.run(connId, args);</span>
        } else {
<span class="nc" id="L31257">            sendServerChat(connId,</span>
                    &quot;Command not recognized.  Type /help for a list of commands.&quot;);
        }
<span class="nc" id="L31260">    }</span>

    // Easter eggs. Happy April Fool's Day!!
    private static final String DUNE_CALL = &quot;They tried and failed?&quot;;

    private static final String DUNE_RESPONSE = &quot;They tried and died!&quot;;

    private static final String STAR_WARS_CALL = &quot;I'd just as soon kiss a Wookiee.&quot;;

    private static final String STAR_WARS_RESPONSE = &quot;I can arrange that!&quot;;

    private static final String INVADER_ZIM_CALL = &quot;What does the G stand for?&quot;;

    private static final String INVADER_ZIM_RESPONSE = &quot;I don't know.&quot;;

    private static final String WARGAMES_CALL = &quot;Shall we play a game?&quot;;

    private static final String WARGAMES_RESPONSE = &quot;Let's play global thermonuclear war.&quot;;

    /**
     * Process a packet from a connection.
     *
     * @param connId
     *            - the &lt;code&gt;int&lt;/code&gt; ID the connection that received the
     *            packet.
     * @param packet
     *            - the &lt;code&gt;Packet&lt;/code&gt; to be processed.
     */
    protected void handle(int connId, Packet packet) {
<span class="nc" id="L31289">        IPlayer player = game.getPlayer(connId);</span>
        // Check player. Please note, the connection may be pending.
<span class="nc bnc" id="L31291" title="All 4 branches missed.">        if ((null == player) &amp;&amp; (null == getPendingConnection(connId))) {</span>
<span class="nc" id="L31292">            MegaMek.getLogger().error(&quot;Server does not recognize player at connection &quot; + connId);</span>
<span class="nc" id="L31293">            return;</span>
        }

<span class="nc bnc" id="L31296" title="All 2 branches missed.">        if (packet == null) {</span>
<span class="nc" id="L31297">            MegaMek.getLogger().error(&quot;Got null packet&quot;);</span>
<span class="nc" id="L31298">            return;</span>
        }
        // act on it
<span class="nc bnc" id="L31301" title="All 42 branches missed.">        switch (packet.getCommand()) {</span>
            case Packet.COMMAND_CLIENT_VERSIONS:
<span class="nc" id="L31303">                receivePlayerVersion(packet, connId);</span>
<span class="nc" id="L31304">                break;</span>
            case Packet.COMMAND_CLOSE_CONNECTION:
                // We have a client going down!
<span class="nc" id="L31307">                IConnection c = getConnection(connId);</span>
<span class="nc bnc" id="L31308" title="All 2 branches missed.">                if (c != null) {</span>
<span class="nc" id="L31309">                    c.close();</span>
                }
                break;
            case Packet.COMMAND_CLIENT_NAME:
<span class="nc" id="L31313">                receivePlayerName(packet, connId);</span>
<span class="nc" id="L31314">                break;</span>
            case Packet.COMMAND_PLAYER_UPDATE:
<span class="nc" id="L31316">                receivePlayerInfo(packet, connId);</span>
<span class="nc" id="L31317">                validatePlayerInfo(connId);</span>
<span class="nc" id="L31318">                send(createPlayerUpdatePacket(connId));</span>
<span class="nc" id="L31319">                break;</span>
            case Packet.COMMAND_PLAYER_READY:
<span class="nc" id="L31321">                receivePlayerDone(packet, connId);</span>
<span class="nc" id="L31322">                send(createPlayerDonePacket(connId));</span>
<span class="nc" id="L31323">                checkReady();</span>
<span class="nc" id="L31324">                break;</span>
            case Packet.COMMAND_REROLL_INITIATIVE:
<span class="nc" id="L31326">                receiveInitiativeRerollRequest(packet, connId);</span>
                // send(createPlayerDonePacket(connId));
<span class="nc" id="L31328">                break;</span>
            case Packet.COMMAND_FORWARD_INITIATIVE:
<span class="nc" id="L31330">                receiveForwardIni(connId);</span>
<span class="nc" id="L31331">                break;</span>
            case Packet.COMMAND_CHAT:
<span class="nc" id="L31333">                String chat = (String) packet.getObject(0);</span>
<span class="nc bnc" id="L31334" title="All 2 branches missed.">                if (chat.startsWith(&quot;/&quot;)) {</span>
<span class="nc" id="L31335">                    processCommand(connId, chat);</span>
<span class="nc bnc" id="L31336" title="All 2 branches missed.">                } else if (packet.getData().length &gt; 1) {</span>
<span class="nc" id="L31337">                    connId = (int) packet.getObject(1);</span>
<span class="nc bnc" id="L31338" title="All 2 branches missed.">                    if (connId == IPlayer.PLAYER_NONE) {</span>
<span class="nc" id="L31339">                        sendServerChat(chat);</span>
                    } else {
<span class="nc" id="L31341">                        sendServerChat(connId, chat);</span>
                    }
                } else {
<span class="nc" id="L31344">                    sendChat(player.getName(), chat);</span>
                }
                // Easter eggs. Happy April Fool's Day!!
<span class="nc bnc" id="L31347" title="All 2 branches missed.">                if (DUNE_CALL.equalsIgnoreCase(chat)) {</span>
<span class="nc" id="L31348">                    sendServerChat(DUNE_RESPONSE);</span>
<span class="nc bnc" id="L31349" title="All 2 branches missed.">                } else if (STAR_WARS_CALL.equalsIgnoreCase(chat)) {</span>
<span class="nc" id="L31350">                    sendServerChat(STAR_WARS_RESPONSE);</span>
<span class="nc bnc" id="L31351" title="All 2 branches missed.">                } else if (INVADER_ZIM_CALL.equalsIgnoreCase(chat)) {</span>
<span class="nc" id="L31352">                    sendServerChat(INVADER_ZIM_RESPONSE);</span>
<span class="nc bnc" id="L31353" title="All 2 branches missed.">                } else if (WARGAMES_CALL.equalsIgnoreCase(chat)) {</span>
<span class="nc" id="L31354">                    sendServerChat(WARGAMES_RESPONSE);</span>
                }
                break;
            case Packet.COMMAND_BLDG_EXPLODE:
<span class="nc" id="L31358">                DemolitionCharge charge = (DemolitionCharge)packet.getData()[0];</span>
<span class="nc bnc" id="L31359" title="All 2 branches missed.">                if (charge.playerId == connId) {</span>
<span class="nc bnc" id="L31360" title="All 2 branches missed.">                    if (!explodingCharges.contains(charge)) {</span>
<span class="nc" id="L31361">                        explodingCharges.add(charge);</span>
<span class="nc" id="L31362">                        IPlayer p = game.getPlayer(connId);</span>
<span class="nc" id="L31363">                        sendServerChat(p.getName() + &quot; has touched off explosives &quot;</span>
                                + &quot;(handled in end phase)!&quot;);
<span class="nc" id="L31365">                    }</span>
                }
                break;
            case Packet.COMMAND_ENTITY_MOVE:
<span class="nc" id="L31369">                receiveMovement(packet, connId);</span>
<span class="nc" id="L31370">                break;</span>
            case Packet.COMMAND_ENTITY_DEPLOY:
<span class="nc" id="L31372">                receiveDeployment(packet, connId);</span>
<span class="nc" id="L31373">                break;</span>
            case Packet.COMMAND_ENTITY_DEPLOY_UNLOAD:
<span class="nc" id="L31375">                receiveDeploymentUnload(packet, connId);</span>
<span class="nc" id="L31376">                break;</span>
            case Packet.COMMAND_DEPLOY_MINEFIELDS:
<span class="nc" id="L31378">                receiveDeployMinefields(packet, connId);</span>
<span class="nc" id="L31379">                break;</span>
            case Packet.COMMAND_ENTITY_ATTACK:
<span class="nc" id="L31381">                receiveAttack(packet, connId);</span>
<span class="nc" id="L31382">                break;</span>
            case Packet.COMMAND_ENTITY_GTA_HEX_SELECT:
<span class="nc" id="L31384">                receiveGroundToAirHexSelectPacket(packet, connId);</span>
<span class="nc" id="L31385">                break;</span>
            case Packet.COMMAND_ENTITY_ADD:
<span class="nc" id="L31387">                receiveEntityAdd(packet, connId);</span>
<span class="nc" id="L31388">                resetPlayersDone();</span>
<span class="nc" id="L31389">                break;</span>
            case Packet.COMMAND_ENTITY_UPDATE:
<span class="nc" id="L31391">                receiveEntityUpdate(packet, connId);</span>
<span class="nc" id="L31392">                resetPlayersDone();</span>
<span class="nc" id="L31393">                break;</span>
            case Packet.COMMAND_ENTITY_LOAD:
<span class="nc" id="L31395">                receiveEntityLoad(packet, connId);</span>
<span class="nc" id="L31396">                resetPlayersDone();</span>
<span class="nc" id="L31397">                transmitAllPlayerDones();</span>
<span class="nc" id="L31398">                break;</span>
            case Packet.COMMAND_ENTITY_MODECHANGE:
<span class="nc" id="L31400">                receiveEntityModeChange(packet, connId);</span>
<span class="nc" id="L31401">                break;</span>
            case Packet.COMMAND_ENTITY_SENSORCHANGE:
<span class="nc" id="L31403">                receiveEntitySensorChange(packet, connId);</span>
<span class="nc" id="L31404">                break;</span>
            case Packet.COMMAND_ENTITY_SINKSCHANGE:
<span class="nc" id="L31406">                receiveEntitySinksChange(packet, connId);</span>
<span class="nc" id="L31407">                break;</span>
            case Packet.COMMAND_ENTITY_ACTIVATE_HIDDEN:
<span class="nc" id="L31409">                receiveEntityActivateHidden(packet, connId);</span>
<span class="nc" id="L31410">                break;</span>
            case Packet.COMMAND_ENTITY_NOVA_NETWORK_CHANGE:
<span class="nc" id="L31412">                receiveEntityNovaNetworkModeChange(packet, connId);</span>
<span class="nc" id="L31413">                break;</span>
            case Packet.COMMAND_ENTITY_MOUNTED_FACINGCHANGE:
<span class="nc" id="L31415">                receiveEntityMountedFacingChange(packet, connId);</span>
<span class="nc" id="L31416">                break;</span>
            case Packet.COMMAND_ENTITY_CALLEDSHOTCHANGE:
<span class="nc" id="L31418">                receiveEntityCalledShotChange(packet, connId);</span>
<span class="nc" id="L31419">                break;</span>
            case Packet.COMMAND_ENTITY_SYSTEMMODECHANGE:
<span class="nc" id="L31421">                receiveEntitySystemModeChange(packet, connId);</span>
<span class="nc" id="L31422">                break;</span>
            case Packet.COMMAND_ENTITY_AMMOCHANGE:
<span class="nc" id="L31424">                receiveEntityAmmoChange(packet, connId);</span>
<span class="nc" id="L31425">                break;</span>
            case Packet.COMMAND_ENTITY_REMOVE:
<span class="nc" id="L31427">                receiveEntityDelete(packet, connId);</span>
<span class="nc" id="L31428">                resetPlayersDone();</span>
<span class="nc" id="L31429">                break;</span>
            case Packet.COMMAND_ENTITY_WORDER_UPDATE:
<span class="nc" id="L31431">                Object[] data = packet.getData();</span>
<span class="nc" id="L31432">                Entity ent = game.getEntity((Integer) data[0]);</span>
<span class="nc bnc" id="L31433" title="All 2 branches missed.">                if (ent != null) {</span>
<span class="nc" id="L31434">                    Entity.WeaponSortOrder order = (Entity.WeaponSortOrder) data[1];</span>
<span class="nc" id="L31435">                    ent.setWeaponSortOrder(order);</span>
                    // Used by the client but is set in setWeaponSortOrder
<span class="nc" id="L31437">                    ent.setWeapOrderChanged(false);</span>
<span class="nc bnc" id="L31438" title="All 2 branches missed.">                    if (order == Entity.WeaponSortOrder.CUSTOM) {</span>
                        @SuppressWarnings(&quot;unchecked&quot;)
                        // Unchecked cause of limitations in Java when casting
                        // to a collection
<span class="nc" id="L31442">                        Map&lt;Integer, Integer&gt; customWeaponOrder = (Map&lt;Integer, Integer&gt;) data[2];</span>
<span class="nc" id="L31443">                        ent.setCustomWeaponOrder(customWeaponOrder);</span>
                    }
<span class="nc" id="L31445">                }</span>
                break;
            case Packet.COMMAND_SENDING_GAME_SETTINGS:
<span class="nc bnc" id="L31448" title="All 2 branches missed.">                if (receiveGameOptions(packet, connId)) {</span>
<span class="nc" id="L31449">                    resetPlayersDone();</span>
<span class="nc" id="L31450">                    transmitAllPlayerDones();</span>
<span class="nc" id="L31451">                    send(createGameSettingsPacket());</span>
<span class="nc" id="L31452">                    receiveGameOptionsAux(packet, connId);</span>
                }
                break;
            case Packet.COMMAND_SENDING_MAP_SETTINGS:
<span class="nc bnc" id="L31456" title="All 2 branches missed.">                if (game.getPhase().isBefore(Phase.PHASE_DEPLOYMENT)) {</span>
<span class="nc" id="L31457">                    MapSettings newSettings = (MapSettings) packet.getObject(0);</span>
<span class="nc bnc" id="L31458" title="All 2 branches missed.">                    if (!mapSettings.equalMapGenParameters(newSettings)) {</span>
<span class="nc" id="L31459">                        sendServerChat(&quot;Player &quot; + player.getName() + &quot; changed map settings&quot;);</span>
                    }
<span class="nc" id="L31461">                    mapSettings = newSettings;</span>
<span class="nc" id="L31462">                    mapSettings.setBoardsAvailableVector(scanForBoards(new BoardDimensions(</span>
<span class="nc" id="L31463">                            mapSettings.getBoardWidth(), mapSettings.getBoardHeight())));</span>
<span class="nc" id="L31464">                    mapSettings.removeUnavailable();</span>
<span class="nc" id="L31465">                    mapSettings.setNullBoards(DEFAULT_BOARD);</span>
<span class="nc" id="L31466">                    mapSettings.replaceBoardWithRandom(MapSettings.BOARD_RANDOM);</span>
<span class="nc" id="L31467">                    mapSettings.removeUnavailable();</span>
                    // if still only nulls left, use BOARD_GENERATED
<span class="nc bnc" id="L31469" title="All 2 branches missed.">                    if (mapSettings.getBoardsSelected().next() == null) {</span>
<span class="nc" id="L31470">                        mapSettings.setNullBoards((MapSettings.BOARD_GENERATED));</span>
                    }
<span class="nc" id="L31472">                    resetPlayersDone();</span>
<span class="nc" id="L31473">                    transmitAllPlayerDones();</span>
<span class="nc" id="L31474">                    send(createMapSettingsPacket());</span>
<span class="nc" id="L31475">                }</span>
                break;
            case Packet.COMMAND_SENDING_MAP_DIMENSIONS:
<span class="nc bnc" id="L31478" title="All 2 branches missed.">                if (game.getPhase().isBefore(Phase.PHASE_DEPLOYMENT)) {</span>
<span class="nc" id="L31479">                    MapSettings newSettings = (MapSettings) packet.getObject(0);</span>
<span class="nc bnc" id="L31480" title="All 2 branches missed.">                    if (!mapSettings.equalMapGenParameters(newSettings)) {</span>
<span class="nc" id="L31481">                        sendServerChat(&quot;Player &quot; + player.getName() + &quot; changed map dimensions&quot;);</span>
                    }
<span class="nc" id="L31483">                    mapSettings = newSettings;</span>
<span class="nc" id="L31484">                    mapSettings.setBoardsAvailableVector(scanForBoards(new BoardDimensions(</span>
<span class="nc" id="L31485">                            mapSettings.getBoardWidth(), mapSettings.getBoardHeight())));</span>
<span class="nc" id="L31486">                    mapSettings.removeUnavailable();</span>
<span class="nc" id="L31487">                    mapSettings.setNullBoards(DEFAULT_BOARD);</span>
<span class="nc" id="L31488">                    mapSettings.replaceBoardWithRandom(MapSettings.BOARD_RANDOM);</span>
<span class="nc" id="L31489">                    mapSettings.removeUnavailable();</span>
                    // if still only nulls left, use BOARD_GENERATED
<span class="nc bnc" id="L31491" title="All 2 branches missed.">                    if (mapSettings.getBoardsSelected().next() == null) {</span>
<span class="nc" id="L31492">                        mapSettings.setNullBoards((MapSettings.BOARD_GENERATED));</span>
                    }
<span class="nc" id="L31494">                    resetPlayersDone();</span>
<span class="nc" id="L31495">                    transmitAllPlayerDones();</span>
<span class="nc" id="L31496">                    send(createMapSettingsPacket());</span>
<span class="nc" id="L31497">                }</span>
                break;
            case Packet.COMMAND_SENDING_PLANETARY_CONDITIONS:
                // MapSettings newSettings = (MapSettings) packet.getObject(0);
<span class="nc bnc" id="L31501" title="All 2 branches missed.">                if (game.getPhase().isBefore(Phase.PHASE_DEPLOYMENT)) {</span>
<span class="nc" id="L31502">                    PlanetaryConditions conditions = (PlanetaryConditions) packet.getObject(0);</span>
<span class="nc" id="L31503">                    sendServerChat(&quot;Player &quot; + player.getName() + &quot; changed planetary conditions&quot;);</span>
<span class="nc" id="L31504">                    game.setPlanetaryConditions(conditions);</span>
<span class="nc" id="L31505">                    resetPlayersDone();</span>
<span class="nc" id="L31506">                    transmitAllPlayerDones();</span>
<span class="nc" id="L31507">                    send(createPlanetaryConditionsPacket());</span>
<span class="nc" id="L31508">                }</span>
                break;
            case Packet.COMMAND_UNLOAD_STRANDED:
<span class="nc" id="L31511">                receiveUnloadStranded(packet, connId);</span>
<span class="nc" id="L31512">                break;</span>
            case Packet.COMMAND_SET_ARTYAUTOHITHEXES:
<span class="nc" id="L31514">                receiveArtyAutoHitHexes(packet, connId);</span>
<span class="nc" id="L31515">                break;</span>
            case Packet.COMMAND_CUSTOM_INITIATIVE:
<span class="nc" id="L31517">                receiveCustomInit(packet, connId);</span>
<span class="nc" id="L31518">                resetPlayersDone();</span>
<span class="nc" id="L31519">                transmitAllPlayerDones();</span>
<span class="nc" id="L31520">                break;</span>
            case Packet.COMMAND_LOAD_GAME:
                try {
<span class="nc" id="L31523">                    sendServerChat(getPlayer(connId).getName() + &quot; loaded a new game.&quot;);</span>
<span class="nc" id="L31524">                    setGame((IGame) packet.getObject(0));</span>
<span class="nc bnc" id="L31525" title="All 2 branches missed.">                    for (IConnection conn : connections) {</span>
<span class="nc" id="L31526">                        sendCurrentInfo(conn.getId());</span>
<span class="nc" id="L31527">                    }</span>
<span class="nc" id="L31528">                } catch (Exception e) {</span>
<span class="nc" id="L31529">                    MegaMek.getLogger().error(&quot;Error loading save game sent from client&quot;, e);</span>
<span class="nc" id="L31530">                }</span>
<span class="nc" id="L31531">                break;</span>
            case Packet.COMMAND_SQUADRON_ADD:
<span class="nc" id="L31533">                receiveSquadronAdd(packet, connId);</span>
<span class="nc" id="L31534">                resetPlayersDone();</span>
<span class="nc" id="L31535">                transmitAllPlayerDones();</span>
<span class="nc" id="L31536">                break;</span>
            case Packet.COMMAND_RESET_ROUND_DEPLOYMENT:
<span class="nc" id="L31538">                game.setupRoundDeployment();</span>
<span class="nc" id="L31539">                break;</span>
            case Packet.COMMAND_SPECIAL_HEX_DISPLAY_DELETE:
<span class="nc" id="L31541">                game.getBoard().removeSpecialHexDisplay((Coords) packet.getObject(0),</span>
<span class="nc" id="L31542">                        (SpecialHexDisplay) packet.getObject(1));</span>
<span class="nc" id="L31543">                sendSpecialHexDisplayPackets();</span>
<span class="nc" id="L31544">                break;</span>
            case Packet.COMMAND_SPECIAL_HEX_DISPLAY_APPEND:
<span class="nc" id="L31546">                game.getBoard().addSpecialHexDisplay((Coords) packet.getObject(0),</span>
<span class="nc" id="L31547">                        (SpecialHexDisplay) packet.getObject(1));</span>
<span class="nc" id="L31548">                sendSpecialHexDisplayPackets();</span>
                break;
        }
<span class="nc" id="L31551">    }</span>

    /**
     * Listen for incoming clients.
     */
    public void run() {
<span class="nc" id="L31557">        Thread currentThread = Thread.currentThread();</span>
<span class="nc" id="L31558">        MegaMek.getLogger().info(&quot;s: listening for clients...&quot;);</span>
<span class="nc bnc" id="L31559" title="All 2 branches missed.">        while (connector == currentThread) {</span>
            try {
<span class="nc" id="L31561">                Socket s = serverSocket.accept();</span>
<span class="nc" id="L31562">                synchronized (serverLock) {</span>
<span class="nc" id="L31563">                    int id = getFreeConnectionId();</span>
<span class="nc" id="L31564">                    MegaMek.getLogger().info(&quot;s: accepting player connection #&quot; + id + &quot;...&quot;);</span>

<span class="nc" id="L31566">                    IConnection c = ConnectionFactory.getInstance().createServerConnection(s, id);</span>
<span class="nc" id="L31567">                    c.addConnectionListener(connectionListener);</span>
<span class="nc" id="L31568">                    c.open();</span>
<span class="nc" id="L31569">                    connectionsPending.addElement(c);</span>
<span class="nc" id="L31570">                    ConnectionHandler ch = new ConnectionHandler(c);</span>
<span class="nc" id="L31571">                    Thread newConnThread = new Thread(ch, &quot;Connection &quot; + id);</span>
<span class="nc" id="L31572">                    newConnThread.start();</span>
<span class="nc" id="L31573">                    connectionHandlers.put(id, ch);</span>

<span class="nc" id="L31575">                    greeting(id);</span>
<span class="nc" id="L31576">                    ConnectionWatchdog w = new ConnectionWatchdog(this, id);</span>
<span class="nc" id="L31577">                    watchdogTimer.schedule(w, 1000, 500);</span>
<span class="nc" id="L31578">                }</span>
<span class="nc" id="L31579">            } catch (InterruptedIOException ignored) {</span>
                // ignore , just SOTimeout blowing..
<span class="nc" id="L31581">            } catch (IOException ignored) { }</span>
        }
<span class="nc" id="L31583">    }</span>

    /**
     * Makes one slot of inferno ammo, determined by certain rules, explode on a
     * mech.
     *
     * @param entity
     *            The &lt;code&gt;Entity&lt;/code&gt; that should suffer an inferno ammo
     *            explosion.
     */
    private Vector&lt;Report&gt; explodeInfernoAmmoFromHeat(Entity entity) {
<span class="nc" id="L31594">        int damage = 0;</span>
<span class="nc" id="L31595">        int rack = 0;</span>
<span class="nc" id="L31596">        int boomloc = -1;</span>
<span class="nc" id="L31597">        int boomslot = -1;</span>
<span class="nc" id="L31598">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

        // Find the most destructive Inferno ammo.
<span class="nc bnc" id="L31602" title="All 2 branches missed.">        for (int j = 0; j &lt; entity.locations(); j++) {</span>
<span class="nc bnc" id="L31603" title="All 2 branches missed.">            for (int k = 0; k &lt; entity.getNumberOfCriticals(j); k++) {</span>
<span class="nc" id="L31604">                CriticalSlot cs = entity.getCritical(j, k);</span>
                // Ignore empty, destroyed, hit, and structure slots.
<span class="nc bnc" id="L31606" title="All 6 branches missed.">                if ((cs == null) || cs.isDestroyed() || cs.isHit()</span>
<span class="nc bnc" id="L31607" title="All 2 branches missed.">                        || (cs.getType() != CriticalSlot.TYPE_EQUIPMENT)) {</span>
<span class="nc" id="L31608">                    continue;</span>
                }
                // Ignore everything but ammo or LAM bomb bay slots.
<span class="nc" id="L31611">                Mounted mounted = cs.getMount();</span>
                int newRack;
                int newDamage;
<span class="nc bnc" id="L31614" title="All 2 branches missed.">                if (mounted.getType() instanceof AmmoType) {</span>
<span class="nc" id="L31615">                    AmmoType atype = (AmmoType) mounted.getType();</span>
<span class="nc bnc" id="L31616" title="All 2 branches missed.">                    if (!atype.isExplosive(mounted)</span>
<span class="nc bnc" id="L31617" title="All 2 branches missed.">                            || ((atype.getMunitionType() != AmmoType.M_INFERNO)</span>
<span class="nc bnc" id="L31618" title="All 2 branches missed.">                            &amp;&amp; (atype.getMunitionType() != AmmoType.M_IATM_IIW))) {</span>
<span class="nc" id="L31619">                        continue;</span>
                    }
                    // ignore empty, destroyed, or missing bins
<span class="nc bnc" id="L31622" title="All 2 branches missed.">                    if (mounted.getHittableShotsLeft() == 0) {</span>
<span class="nc" id="L31623">                        continue;</span>
                    }
                    // Find the most destructive undamaged ammo.
                    // TW page 160, compare one rack's
                    // damage. Ties go to most rounds.
<span class="nc" id="L31628">                    newRack = atype.getDamagePerShot() * atype.getRackSize();</span>
<span class="nc" id="L31629">                    newDamage = mounted.getExplosionDamage();</span>
<span class="nc" id="L31630">                    Mounted mount2 = cs.getMount2();</span>
<span class="nc bnc" id="L31631" title="All 4 branches missed.">                    if ((mount2 != null) &amp;&amp; (mount2.getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L31632" title="All 2 branches missed.">                            &amp;&amp; (mount2.getHittableShotsLeft() &gt; 0)) {</span>
                        // must be for same weaponType, so rackSize stays
<span class="nc" id="L31634">                        atype = (AmmoType) mount2.getType();</span>
<span class="nc" id="L31635">                        newRack += atype.getDamagePerShot() * atype.getRackSize();</span>
<span class="nc" id="L31636">                        newDamage += mount2.getExplosionDamage();</span>
                    }
<span class="nc bnc" id="L31638" title="All 2 branches missed.">                } else if ((mounted.getType() instanceof MiscType)</span>
<span class="nc bnc" id="L31639" title="All 2 branches missed.">                        &amp;&amp; mounted.getType().hasFlag(MiscType.F_BOMB_BAY)) {</span>
<span class="nc bnc" id="L31640" title="All 2 branches missed.">                    while (mounted.getLinked() != null) {</span>
<span class="nc" id="L31641">                        mounted = mounted.getLinked();</span>
                    }
<span class="nc bnc" id="L31643" title="All 2 branches missed.">                    if (mounted.getExplosionDamage() == 0) {</span>
<span class="nc" id="L31644">                        continue;</span>
                    }
<span class="nc" id="L31646">                    newRack = 1;</span>
<span class="nc" id="L31647">                    newDamage = mounted.getExplosionDamage();</span>
                } else {
                    continue;
                }

<span class="nc bnc" id="L31652" title="All 8 branches missed.">                if (!mounted.isHit()</span>
                        &amp;&amp; ((rack &lt; newRack) || ((rack == newRack) &amp;&amp; (damage &lt; newDamage)))) {
<span class="nc" id="L31654">                    rack = newRack;</span>
<span class="nc" id="L31655">                    damage = newDamage;</span>
<span class="nc" id="L31656">                    boomloc = j;</span>
<span class="nc" id="L31657">                    boomslot = k;</span>
                }
            }
        }
        // Did we find anything to explode?
<span class="nc bnc" id="L31662" title="All 4 branches missed.">        if ((boomloc != -1) &amp;&amp; (boomslot != -1)) {</span>
<span class="nc" id="L31663">            CriticalSlot slot = entity.getCritical(boomloc, boomslot);</span>
<span class="nc" id="L31664">            slot.setHit(true);</span>
<span class="nc" id="L31665">            Mounted equip = slot.getMount();</span>
<span class="nc" id="L31666">            equip.setHit(true);</span>
            // We've allocated heatBuildup to heat in resolveHeat(),
            // so need to add to the entity's heat instead.
<span class="nc bnc" id="L31669" title="All 2 branches missed.">            if ((equip.getType() instanceof AmmoType)</span>
<span class="nc bnc" id="L31670" title="All 2 branches missed.">                    || (equip.getLinked() != null</span>
<span class="nc bnc" id="L31671" title="All 2 branches missed.">                        &amp;&amp; equip.getLinked().getType() instanceof BombType</span>
<span class="nc bnc" id="L31672" title="All 2 branches missed.">                        &amp;&amp; ((BombType)equip.getLinked().getType()).getBombType() == BombType.B_INFERNO)) {</span>
<span class="nc" id="L31673">                entity.heat += Math.min(equip.getExplosionDamage(), 30);</span>
            }
<span class="nc" id="L31675">            vDesc.addAll(explodeEquipment(entity, boomloc, boomslot));</span>
<span class="nc" id="L31676">            r = new Report(5155);</span>
<span class="nc" id="L31677">            r.indent();</span>
<span class="nc" id="L31678">            r.subject = entity.getId();</span>
<span class="nc" id="L31679">            r.add(entity.heat);</span>
<span class="nc" id="L31680">            vDesc.addElement(r);</span>
<span class="nc" id="L31681">            entity.heatBuildup = 0;</span>
<span class="nc" id="L31682">        } else { // no ammo to explode</span>
<span class="nc" id="L31683">            r = new Report(5160);</span>
<span class="nc" id="L31684">            r.indent();</span>
<span class="nc" id="L31685">            r.subject = entity.getId();</span>
<span class="nc" id="L31686">            vDesc.addElement(r);</span>
        }
<span class="nc" id="L31688">        return vDesc;</span>
    }

    /**
     * checks for unintended explosion of heavy industrial zone hex and applies
     * damage to entities occupying the hex
     */
    public void checkExplodeIndustrialZone(Coords c, Vector&lt;Report&gt; vDesc) {
        Report r;
<span class="nc" id="L31697">        IHex hex = game.getBoard().getHex(c);</span>
<span class="nc bnc" id="L31698" title="All 2 branches missed.">        if (null == hex) {</span>
<span class="nc" id="L31699">            return;</span>
        }

<span class="nc bnc" id="L31702" title="All 2 branches missed.">        if (!hex.containsTerrain(Terrains.INDUSTRIAL)) {</span>
<span class="nc" id="L31703">            return;</span>
        }

<span class="nc" id="L31706">        r = new Report(3590, Report.PUBLIC);</span>
<span class="nc" id="L31707">        r.add(c.getBoardNum());</span>
<span class="nc" id="L31708">        r.indent(2);</span>
<span class="nc" id="L31709">        int effect = Compute.d6(2);</span>
<span class="nc" id="L31710">        r.add(8);</span>
<span class="nc" id="L31711">        r.add(effect);</span>
<span class="nc bnc" id="L31712" title="All 2 branches missed.">        if (effect &gt; 7) {</span>
<span class="nc" id="L31713">            r.choose(true);</span>
<span class="nc" id="L31714">            r.newlines = 0;</span>
<span class="nc" id="L31715">            vDesc.add(r);</span>
<span class="nc" id="L31716">            boolean onFire = false;</span>
<span class="nc" id="L31717">            boolean powerLine = false;</span>
<span class="nc" id="L31718">            boolean minorExp = false;</span>
<span class="nc" id="L31719">            boolean elecExp = false;</span>
<span class="nc" id="L31720">            boolean majorExp = false;</span>
<span class="nc bnc" id="L31721" title="All 2 branches missed.">            if (effect == 8) {</span>
<span class="nc" id="L31722">                onFire = true;</span>
<span class="nc" id="L31723">                r = new Report(3600, Report.PUBLIC);</span>
<span class="nc" id="L31724">                r.newlines = 0;</span>
<span class="nc" id="L31725">                vDesc.add(r);</span>
<span class="nc bnc" id="L31726" title="All 2 branches missed.">            } else if (effect == 9) {</span>
<span class="nc" id="L31727">                powerLine = true;</span>
<span class="nc" id="L31728">                r = new Report(3605, Report.PUBLIC);</span>
<span class="nc" id="L31729">                r.newlines = 0;</span>
<span class="nc" id="L31730">                vDesc.add(r);</span>
<span class="nc bnc" id="L31731" title="All 2 branches missed.">            } else if (effect == 10) {</span>
<span class="nc" id="L31732">                minorExp = true;</span>
<span class="nc" id="L31733">                onFire = true;</span>
<span class="nc" id="L31734">                r = new Report(3610, Report.PUBLIC);</span>
<span class="nc" id="L31735">                r.newlines = 0;</span>
<span class="nc" id="L31736">                vDesc.add(r);</span>
<span class="nc bnc" id="L31737" title="All 2 branches missed.">            } else if (effect == 11) {</span>
<span class="nc" id="L31738">                elecExp = true;</span>
<span class="nc" id="L31739">                r = new Report(3615, Report.PUBLIC);</span>
<span class="nc" id="L31740">                r.newlines = 0;</span>
<span class="nc" id="L31741">                vDesc.add(r);</span>
            } else {
<span class="nc" id="L31743">                onFire = true;</span>
<span class="nc" id="L31744">                majorExp = true;</span>
<span class="nc" id="L31745">                r = new Report(3620, Report.PUBLIC);</span>
<span class="nc" id="L31746">                r.newlines = 0;</span>
<span class="nc" id="L31747">                vDesc.add(r);</span>
            }
            // apply damage here
<span class="nc bnc" id="L31750" title="All 8 branches missed.">            if (powerLine || minorExp || elecExp || majorExp) {</span>
                // cycle through the entities in the hex and apply damage
<span class="nc bnc" id="L31752" title="All 2 branches missed.">                for (Entity en : game.getEntitiesVector(c)) {</span>
<span class="nc" id="L31753">                    int damage = 3;</span>
<span class="nc bnc" id="L31754" title="All 2 branches missed.">                    if (minorExp) {</span>
<span class="nc" id="L31755">                        damage = 5;</span>
                    }
<span class="nc bnc" id="L31757" title="All 2 branches missed.">                    if (elecExp) {</span>
<span class="nc" id="L31758">                        damage = Compute.d6(1) + 3;</span>
                    }
<span class="nc bnc" id="L31760" title="All 2 branches missed.">                    if (majorExp) {</span>
<span class="nc" id="L31761">                        damage = Compute.d6(2);</span>
                    }
<span class="nc" id="L31763">                    HitData hit = en.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc bnc" id="L31764" title="All 2 branches missed.">                    if (en instanceof BattleArmor) {</span>
                        // ugly - I have to apply damage to each trooper
                        // separately
<span class="nc bnc" id="L31767" title="All 2 branches missed.">                        for (int loc = 0; loc &lt; en.locations(); loc++) {</span>
<span class="nc bnc" id="L31768" title="All 2 branches missed.">                            if ((IArmorState.ARMOR_NA != en.getInternal(loc))</span>
<span class="nc bnc" id="L31769" title="All 2 branches missed.">                                    &amp;&amp; (IArmorState.ARMOR_DESTROYED != en.getInternal(loc))</span>
<span class="nc bnc" id="L31770" title="All 2 branches missed.">                                    &amp;&amp; (IArmorState.ARMOR_DOOMED != en.getInternal(loc))) {</span>
<span class="nc" id="L31771">                                vDesc.addAll(damageEntity(en, new HitData(loc), damage));</span>
                            }
                        }
                    } else {
<span class="nc" id="L31775">                        vDesc.addAll(damageEntity(en, hit, damage));</span>
                    }
<span class="nc bnc" id="L31777" title="All 2 branches missed.">                    if (majorExp) {</span>
                        // lets pretend that the infernos came from the entity
                        // itself (should give us side_front)
<span class="nc" id="L31780">                        vDesc.addAll(deliverInfernoMissiles(en, en, Compute.d6(2)));</span>
                    }
<span class="nc" id="L31782">                }</span>
            }
<span class="nc" id="L31784">            Report.addNewline(vDesc);</span>
<span class="nc bnc" id="L31785" title="All 4 branches missed.">            if (onFire &amp;&amp; !hex.containsTerrain(Terrains.FIRE)) {</span>
<span class="nc" id="L31786">                ignite(c, Terrains.FIRE_LVL_NORMAL, vDesc);</span>
            }
<span class="nc" id="L31788">        } else {</span>
            // report no explosion
<span class="nc" id="L31790">            r.choose(false);</span>
<span class="nc" id="L31791">            vDesc.add(r);</span>
        }
<span class="nc" id="L31793">    }</span>

    /**
     * Determine the results of an entity moving through a wall of a building
     * after having moved a certain distance. This gets called when a Mech or a
     * Tank enters a building, leaves a building, or travels from one hex to
     * another inside a multi-hex building.
     *
     * @param entity
     *            - the &lt;code&gt;Entity&lt;/code&gt; that passed through a wall. Don't
     *            pass &lt;code&gt;Infantry&lt;/code&gt; units to this method.
     * @param bldg
     *            - the &lt;code&gt;Building&lt;/code&gt; the entity is passing through.
     * @param lastPos
     *            - the &lt;code&gt;Coords&lt;/code&gt; of the hex the entity is exiting.
     * @param curPos
     *            - the &lt;code&gt;Coords&lt;/code&gt; of the hex the entity is entering
     * @param distance
     *            - the &lt;code&gt;int&lt;/code&gt; number of hexes the entity has moved
     *            already this phase.
     * @param why
     *            - the &lt;code&gt;String&lt;/code&gt; explanation for this action.
     * @param backwards
     *            - the &lt;code&gt;boolean&lt;/code&gt; indicating if the entity is
     *            entering the hex backwards
     * @param entering
     *            - a &lt;code&gt;boolean&lt;/code&gt; if the entity is entering or exiting
     *            a building
     */
    private void passBuildingWall(Entity entity, Building bldg, Coords lastPos, Coords curPos,
                                  int distance, String why, boolean backwards,
                                  EntityMovementType overallMoveType, boolean entering) {
        Report r;

<span class="nc bnc" id="L31827" title="All 2 branches missed.">        if (entity instanceof Protomech) {</span>
<span class="nc" id="L31828">            Vector&lt;Report&gt; vBuildingReport = damageBuilding(bldg, 1, curPos);</span>
<span class="nc bnc" id="L31829" title="All 2 branches missed.">            for (Report report : vBuildingReport) {</span>
<span class="nc" id="L31830">                report.subject = entity.getId();</span>
<span class="nc" id="L31831">            }</span>
<span class="nc" id="L31832">            addReport(vBuildingReport);</span>
<span class="nc" id="L31833">        } else {</span>
            // Need to roll based on building type.
<span class="nc" id="L31835">            PilotingRollData psr = entity.rollMovementInBuilding(bldg, distance, why, overallMoveType);</span>

            // Did the entity make the roll?
<span class="nc bnc" id="L31838" title="All 2 branches missed.">            if (0 &lt; doSkillCheckWhileMoving(entity, entity.getElevation(), lastPos, curPos, psr, false)) {</span>

                // Divide the building's current CF by 10, round up.
<span class="nc" id="L31841">                int damage = (int) Math.floor(bldg.getDamageFromScale()</span>
<span class="nc bnc" id="L31842" title="All 2 branches missed.">                        * Math.ceil(bldg.getCurrentCF(entering ? curPos : lastPos) / 10.0));</span>

                // Infantry and Battle armor take different amounts of damage
                // then Meks and vehicles.
<span class="nc bnc" id="L31846" title="All 2 branches missed.">                if (entity instanceof Infantry) {</span>
<span class="nc" id="L31847">                    damage = bldg.getType() + 1;</span>
                }
                // It is possible that the unit takes no damage.
<span class="nc bnc" id="L31850" title="All 2 branches missed.">                if (damage == 0) {</span>
<span class="nc" id="L31851">                    r = new Report(6440);</span>
<span class="nc" id="L31852">                    r.add(entity.getDisplayName());</span>
<span class="nc" id="L31853">                    r.subject = entity.getId();</span>
<span class="nc" id="L31854">                    r.indent(2);</span>
<span class="nc" id="L31855">                    addReport(r);</span>
                } else {
                    // TW, pg. 268: if unit moves forward, damage from front,
                    // if backwards, damage from rear.
<span class="nc" id="L31859">                    int side = ToHitData.SIDE_FRONT;</span>
<span class="nc bnc" id="L31860" title="All 2 branches missed.">                    if (backwards) {</span>
<span class="nc" id="L31861">                        side = ToHitData.SIDE_REAR;</span>
                    }
<span class="nc" id="L31863">                    HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, side);</span>
<span class="nc" id="L31864">                    hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L31865">                    addReport(damageEntity(entity, hit, damage));</span>
                }
            }

            // Infantry and BA are damaged by buildings but do not damage them
<span class="nc bnc" id="L31870" title="All 2 branches missed.">            if (entity instanceof Infantry) {</span>
<span class="nc" id="L31871">                return;</span>
            }
            // Damage the building. The CF can never drop below 0.
<span class="nc" id="L31874">            int toBldg = (int) Math.floor(bldg.getDamageToScale()</span>
<span class="nc" id="L31875">                    * Math.ceil(entity.getWeight() / 10.0));</span>
<span class="nc bnc" id="L31876" title="All 2 branches missed.">            int curCF = bldg.getCurrentCF(entering ? curPos : lastPos);</span>
<span class="nc" id="L31877">            curCF -= Math.min(curCF, toBldg);</span>
<span class="nc bnc" id="L31878" title="All 2 branches missed.">            bldg.setCurrentCF(curCF, entering ? curPos : lastPos);</span>

            // Apply the correct amount of damage to infantry in the building.
            // ASSUMPTION: We inflict toBldg damage to infantry and
            // not the amount to bring building to 0 CF.
<span class="nc bnc" id="L31883" title="All 2 branches missed.">            addReport(damageInfantryIn(bldg, toBldg, entering ? curPos : lastPos));</span>
        }
<span class="nc" id="L31885">    }</span>

    /**
     * check if a building collapses because of a moving entity
     *
     * @param bldg
     *            the &lt;code&gt;Building&lt;/code&gt;
     * @param entity
     *            the &lt;code&gt;Entity&lt;/code&gt;
     * @param curPos
     *            the &lt;code&gt;Coords&lt;/code&gt; of the position of the entity
     * @return a &lt;code&gt;boolean&lt;/code&gt; value indicating if the building collapses
     */
    private boolean checkBuildingCollapseWhileMoving(Building bldg, Entity entity, Coords curPos) {
<span class="nc" id="L31899">        Coords oldPos = entity.getPosition();</span>
        // Count the moving entity in its current position, not
        // its pre-move position. Be sure to handle nulls.
<span class="nc" id="L31902">        entity.setPosition(curPos);</span>

        // Get the position map of all entities in the game.
<span class="nc" id="L31905">        Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap = game.getPositionMap();</span>

        // Check for collapse of this building due to overloading, and return.
<span class="nc" id="L31908">        boolean rv = checkForCollapse(bldg, positionMap, curPos, true, vPhaseReport);</span>

        // If the entity was not displaced and didn't fall, move it back where it was
<span class="nc bnc" id="L31911" title="All 4 branches missed.">        if (curPos.equals(entity.getPosition()) &amp;&amp; !entity.isProne()) {</span>
<span class="nc" id="L31912">            entity.setPosition(oldPos);</span>
        }
<span class="nc" id="L31914">        return rv;</span>
    }

    public Vector&lt;Report&gt; damageInfantryIn(Building bldg, int damage, Coords hexCoords) {
<span class="nc" id="L31918">        return damageInfantryIn(bldg, damage, hexCoords, WeaponType.WEAPON_NA);</span>
    }

    /**
     * Apply the correct amount of damage that passes on to any infantry unit in
     * the given building, based upon the amount of damage the building just
     * sustained. This amount is a percentage dictated by pg. 172 of TW.
     *
     * @param bldg   - the &lt;code&gt;Building&lt;/code&gt; that sustained the damage.
     * @param damage - the &lt;code&gt;int&lt;/code&gt; amount of damage.
     */
    public Vector&lt;Report&gt; damageInfantryIn(Building bldg, int damage, Coords hexCoords,
                                           int infDamageClass) {
<span class="nc" id="L31931">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>

<span class="nc bnc" id="L31933" title="All 2 branches missed.">        if (bldg == null) {</span>
<span class="nc" id="L31934">            return vDesc;</span>
        }
        // Calculate the amount of damage the infantry will sustain.
<span class="nc" id="L31937">        float percent = bldg.getDamageReductionFromOutside();</span>
        Report r;

        // Round up at .5 points of damage.
<span class="nc" id="L31941">        int toInf = Math.round(damage * percent);</span>

        // some buildings scale remaining damage
<span class="nc" id="L31944">        toInf = (int) Math.floor(bldg.getDamageToScale() * toInf);</span>

        // Walk through the entities in the game.
<span class="nc bnc" id="L31947" title="All 2 branches missed.">        for (Entity entity : game.getEntitiesVector()) {</span>
<span class="nc" id="L31948">            final Coords coords = entity.getPosition();</span>

            // If the entity is infantry in the affected hex?
<span class="nc bnc" id="L31951" title="All 6 branches missed.">            if ((entity instanceof Infantry) &amp;&amp; bldg.isIn(coords) &amp;&amp; coords.equals(hexCoords)) {</span>
                // Is the entity is inside of the building
                // (instead of just on top of it)?
<span class="nc bnc" id="L31954" title="All 2 branches missed.">                if (Compute.isInBuilding(game, entity, coords)) {</span>

                    // Report if the infantry receive no points of damage.
<span class="nc bnc" id="L31957" title="All 2 branches missed.">                    if (toInf == 0) {</span>
<span class="nc" id="L31958">                        r = new Report(6445);</span>
<span class="nc" id="L31959">                        r.indent(3);</span>
<span class="nc" id="L31960">                        r.subject = entity.getId();</span>
<span class="nc" id="L31961">                        r.add(entity.getDisplayName());</span>
<span class="nc" id="L31962">                        vDesc.addElement(r);</span>
                    } else {
                        // Yup. Damage the entity.
<span class="nc" id="L31965">                        r = new Report(6450);</span>
<span class="nc" id="L31966">                        r.indent(3);</span>
<span class="nc" id="L31967">                        r.subject = entity.getId();</span>
<span class="nc" id="L31968">                        r.add(toInf);</span>
<span class="nc" id="L31969">                        r.add(entity.getDisplayName());</span>
<span class="nc" id="L31970">                        vDesc.addElement(r);</span>
                        // need to adjust damage to conventional infantry
                        // TW page 217 says left over damage gets treated as
                        // direct fire ballistic damage
<span class="nc bnc" id="L31974" title="All 2 branches missed.">                        if (!(entity instanceof BattleArmor)) {</span>
<span class="nc" id="L31975">                            toInf = Compute.directBlowInfantryDamage(toInf, 0,</span>
                                    WeaponType.WEAPON_DIRECT_FIRE, false, false);
                        }
<span class="nc" id="L31978">                        int remaining = toInf;</span>
<span class="nc" id="L31979">                        int cluster = toInf;</span>
                        // Battle Armor units use 5 point clusters.
<span class="nc bnc" id="L31981" title="All 2 branches missed.">                        if (entity instanceof BattleArmor) {</span>
<span class="nc" id="L31982">                            cluster = 5;</span>
                        }
<span class="nc bnc" id="L31984" title="All 2 branches missed.">                        while (remaining &gt; 0) {</span>
<span class="nc" id="L31985">                            int next = Math.min(cluster, remaining);</span>
<span class="nc" id="L31986">                            HitData hit = entity.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L31987">                            vDesc.addAll((damageEntity(entity, hit, next)));</span>
<span class="nc" id="L31988">                            remaining -= next;</span>
<span class="nc" id="L31989">                        }</span>
                    }

<span class="nc" id="L31992">                    Report.addNewline(vDesc);</span>
                } // End infantry-inside-building
            } // End entity-is-infantry-in-building-hex
<span class="nc" id="L31995">        } // Handle the next entity</span>

<span class="nc" id="L31997">        return vDesc;</span>
    } // End private void damageInfantryIn( Building, int )

    /**
     * Determine if the given building should collapse. If so, inflict the
     * appropriate amount of damage on each entity in the building and update
     * the clients. If the building does not collapse, determine if any entities
     * crash through its floor into its basement. Again, apply appropriate
     * damage.
     *
     * @param bldg
     *            - the &lt;code&gt;Building&lt;/code&gt; being checked. This value should
     *            not be &lt;code&gt;null&lt;/code&gt;.
     * @param positionMap
     *            - a &lt;code&gt;Hashtable&lt;/code&gt; that maps the &lt;code&gt;Coords&lt;/code&gt;
     *            positions or each unit in the game to a &lt;code&gt;Vector&lt;/code&gt; of
     *            &lt;code&gt;Entity&lt;/code&gt;s at that position. This value should not
     *            be &lt;code&gt;null&lt;/code&gt;.
     * @param coords
     *            - the &lt;code&gt;Coords&lt;/code&gt; of the building hex to be checked
     * @return &lt;code&gt;true&lt;/code&gt; if the building collapsed.
     */
    public boolean checkForCollapse(Building bldg, Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap,
                                    Coords coords, boolean checkBecauseOfDamage,
                                    Vector&lt;Report&gt; vPhaseReport) {

        // If the input is meaningless, do nothing and throw no exception.
<span class="nc bnc" id="L32024" title="All 8 branches missed.">        if ((bldg == null) || (positionMap == null) || positionMap.isEmpty()</span>
<span class="nc bnc" id="L32025" title="All 4 branches missed.">                || (coords == null) || !bldg.isIn(coords) || !bldg.hasCFIn(coords)) {</span>
<span class="nc" id="L32026">            return false;</span>
        }

        // Get the building's current CF.
<span class="nc" id="L32030">        int currentCF = bldg.getCurrentCF(coords);</span>

        // Track all units that fall into the building's basement by Coords.
<span class="nc" id="L32033">        Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; basementMap = new Hashtable&lt;&gt;();</span>

        // look for a collapse.
<span class="nc" id="L32036">        boolean collapse = false;</span>

<span class="nc" id="L32038">        boolean basementCollapse = false;</span>

<span class="nc" id="L32040">        boolean topFloorCollapse = false;</span>

<span class="nc bnc" id="L32042" title="All 4 branches missed.">        if (checkBecauseOfDamage &amp;&amp; (currentCF &lt;= 0)) {</span>
<span class="nc" id="L32043">            collapse = true;</span>
        }

        // Get the Vector of Entities at these coordinates.
<span class="nc" id="L32047">        final Vector&lt;Entity&gt; vector = positionMap.get(coords);</span>

        // Are there any Entities at these coords?
<span class="nc bnc" id="L32050" title="All 2 branches missed.">        if (vector != null) {</span>
            // How many levels does this building have in this hex?
<span class="nc" id="L32052">            final IHex curHex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L32053">            final int numFloors = Math.max(0, curHex.terrainLevel(Terrains.BLDG_ELEV));</span>
<span class="nc" id="L32054">            final int bridgeEl = curHex.terrainLevel(Terrains.BRIDGE_ELEV);</span>
<span class="nc" id="L32055">            int numLoads = numFloors;</span>
<span class="nc bnc" id="L32056" title="All 2 branches missed.">            if (bridgeEl != ITerrain.LEVEL_NONE) {</span>
<span class="nc" id="L32057">                numLoads++;</span>
            }
<span class="nc bnc" id="L32059" title="All 2 branches missed.">            if (numLoads &lt; 1) {</span>
<span class="nc" id="L32060">                MegaMek.getLogger().error(&quot;Check for collapse: hex &quot; + coords.toString() </span>
                        + &quot; has no bridge or building&quot;);
<span class="nc" id="L32062">                return false;</span>
            }

            // Track the load of each floor (and of the roof) separately.
            // Track all units that fall into the basement in this hex.
            // track all floors, ground at index 0, the first floor is at
            // index 1, the second is at index 1, etc., and the roof is
            // at index (numFloors).
            // if bridge is present, bridge will be numFloors+1
<span class="nc" id="L32071">            double[] loads = new double[numLoads + 1];</span>
            // WiGEs flying over the building are also tracked, but can only collapse the top floor
            // and only count 25% of their tonnage.
<span class="nc" id="L32074">            double wigeLoad = 0;</span>
            // track all units that might fall into the basement
<span class="nc" id="L32076">            Vector&lt;Entity&gt; basement = new Vector&lt;&gt;();</span>

<span class="nc" id="L32078">            boolean recheckLoop = true;</span>
<span class="nc bnc" id="L32079" title="All 4 branches missed.">            for (int i = 0; (i &lt; 2) &amp;&amp; recheckLoop; i++) {</span>
<span class="nc" id="L32080">                recheckLoop = false;</span>
<span class="nc" id="L32081">                Arrays.fill(loads, 0);</span>

                // Walk through the entities in this position.
<span class="nc" id="L32084">                Enumeration&lt;Entity&gt; entities = vector.elements();</span>
<span class="nc bnc" id="L32085" title="All 4 branches missed.">                while (!collapse &amp;&amp; entities.hasMoreElements()) {</span>
<span class="nc" id="L32086">                    final Entity entity = entities.nextElement();</span>
                    // WiGEs can collapse the top floor of a building by flying over it.
<span class="nc" id="L32088">                    final int entityElev = entity.getElevation();</span>
<span class="nc bnc" id="L32089" title="All 4 branches missed.">                    final boolean wigeFlyover = entity.getMovementMode() == EntityMovementMode.WIGE</span>
                            &amp;&amp; entityElev == numFloors + 1;

<span class="nc bnc" id="L32092" title="All 4 branches missed.">                    if (entityElev != bridgeEl &amp;&amp; !wigeFlyover) {</span>
                        // Ignore entities not *inside* the building
<span class="nc bnc" id="L32094" title="All 2 branches missed.">                        if (entityElev &gt; numFloors) {</span>
<span class="nc" id="L32095">                            continue;</span>
                        }
                    }
                    
                    // if we're under a bridge, we can't collapse the bridge
<span class="nc bnc" id="L32100" title="All 2 branches missed.">                    if (entityElev &lt; bridgeEl) {</span>
<span class="nc" id="L32101">                        continue;</span>
                    }

<span class="nc bnc" id="L32104" title="All 2 branches missed.">                    if ((entity.getMovementMode() == EntityMovementMode.HYDROFOIL)</span>
<span class="nc bnc" id="L32105" title="All 2 branches missed.">                            || (entity.getMovementMode() == EntityMovementMode.NAVAL)</span>
<span class="nc bnc" id="L32106" title="All 2 branches missed.">                            || (entity.getMovementMode() == EntityMovementMode.SUBMARINE)</span>
<span class="nc bnc" id="L32107" title="All 2 branches missed.">                            || (entity.getMovementMode() == EntityMovementMode.INF_UMU)</span>
<span class="nc bnc" id="L32108" title="All 2 branches missed.">                            || entity.hasWorkingMisc(MiscType.F_FULLY_AMPHIBIOUS)) {</span>
<span class="nc" id="L32109">                        continue; // under the bridge even at same level</span>
                    }

<span class="nc bnc" id="L32112" title="All 2 branches missed.">                    if (entityElev == 0) {</span>
<span class="nc" id="L32113">                        basement.add(entity);</span>
                    }

                    // units already in the basement
<span class="nc bnc" id="L32117" title="All 2 branches missed.">                    if (entityElev &lt; 0) {</span>
<span class="nc" id="L32118">                        continue;</span>
                    }

                    // Add the weight to the correct floor.
<span class="nc" id="L32122">                    double load = entity.getWeight();</span>
<span class="nc" id="L32123">                    int floor = entityElev;</span>
<span class="nc bnc" id="L32124" title="All 2 branches missed.">                    if (floor == bridgeEl) {</span>
<span class="nc" id="L32125">                        floor = numLoads;</span>
                    }
                    // Entities on the roof fall to the previous top floor/new roof
<span class="nc bnc" id="L32128" title="All 4 branches missed.">                    if (topFloorCollapse &amp;&amp; floor == numFloors) {</span>
<span class="nc" id="L32129">                        floor--;</span>
                    }

<span class="nc bnc" id="L32132" title="All 2 branches missed.">                    if (wigeFlyover) {</span>
<span class="nc" id="L32133">                        wigeLoad += load;</span>
<span class="nc bnc" id="L32134" title="All 2 branches missed.">                        if (wigeLoad &gt; currentCF * 4) {</span>
<span class="nc" id="L32135">                            topFloorCollapse = true;</span>
<span class="nc" id="L32136">                            loads[numFloors - 1] += loads[numFloors];</span>
<span class="nc" id="L32137">                            loads[numFloors] = 0;</span>
                        }
                    } else {
<span class="nc" id="L32140">                        loads[floor] += load;</span>
<span class="nc bnc" id="L32141" title="All 2 branches missed.">                        if (loads[floor] &gt; currentCF) {</span>
                            // If the load on any floor but the ground floor
                            // exceeds the building's current CF it collapses.
<span class="nc bnc" id="L32144" title="All 2 branches missed.">                            if (floor != 0) {</span>
<span class="nc" id="L32145">                                collapse = true;</span>
<span class="nc bnc" id="L32146" title="All 2 branches missed.">                            } else if (!bldg.getBasementCollapsed(coords)) {</span>
<span class="nc" id="L32147">                                basementCollapse = true;</span>
                            }
                        }
                    } // End increase-load
<span class="nc" id="L32151">                } // Handle the next entity.</span>

                // Track all entities that fell into the basement.
<span class="nc bnc" id="L32154" title="All 2 branches missed.">                if (basementCollapse) {</span>
<span class="nc" id="L32155">                    basementMap.put(coords, basement);</span>
                }

                // did anyone fall into the basement?
<span class="nc bnc" id="L32159" title="All 6 branches missed.">                if (!basementMap.isEmpty() &amp;&amp; (bldg.getBasement(coords) != BasementType.NONE) &amp;&amp; !collapse) {</span>
<span class="nc" id="L32160">                    collapseBasement(bldg, basementMap, coords, vPhaseReport);</span>
<span class="nc bnc" id="L32161" title="All 2 branches missed.">                    if (currentCF == 0) {</span>
<span class="nc" id="L32162">                        collapse = true;</span>
<span class="nc" id="L32163">                        recheckLoop = false;</span>
                    } else {
<span class="nc" id="L32165">                        recheckLoop = true; // basement collapse might cause a further collapse</span>
                    }
                } else {
<span class="nc" id="L32168">                    recheckLoop = false; // don't check again, we didn't change the CF</span>
                }
<span class="nc bnc" id="L32170" title="All 2 branches missed.">                if (collapse) {</span>
<span class="nc" id="L32171">                    recheckLoop = false;</span>
                    // recheck if the basement collapsed since the basement falls
                    // might trigger a greater collapse.
                }
            } // End have-entities-here
        }

        // Collapse the building if the flag is set.
<span class="nc bnc" id="L32179" title="All 2 branches missed.">        if (collapse) {</span>
<span class="nc" id="L32180">            Report r = new Report(2375, Report.PUBLIC);</span>
<span class="nc" id="L32181">            r.add(bldg.getName());</span>
<span class="nc" id="L32182">            vPhaseReport.add(r);</span>

<span class="nc" id="L32184">            collapseBuilding(bldg, positionMap, coords, false, vPhaseReport);</span>
<span class="nc bnc" id="L32185" title="All 2 branches missed.">        } else if (topFloorCollapse) {</span>
<span class="nc" id="L32186">                Report r = new Report(2376, Report.PUBLIC);</span>
<span class="nc" id="L32187">                r.add(bldg.getName());</span>
<span class="nc" id="L32188">                vPhaseReport.add(r);</span>

<span class="nc" id="L32190">                collapseBuilding(bldg, positionMap, coords, false, true, vPhaseReport);</span>
        }

        // Return true if the building collapsed.
<span class="nc bnc" id="L32194" title="All 4 branches missed.">        return collapse || topFloorCollapse;</span>

    } // End private boolean checkForCollapse( Building, Hashtable )

    public void collapseBuilding(Building bldg, Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap,
                                 Coords coords, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L32200">        collapseBuilding(bldg, positionMap, coords, true, false, vPhaseReport);</span>
<span class="nc" id="L32201">    }</span>

    public void collapseBuilding(Building bldg, Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap,
                                 Coords coords, boolean collapseAll, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L32205">        collapseBuilding(bldg, positionMap, coords, collapseAll, false, vPhaseReport);</span>
<span class="nc" id="L32206">    }</span>

    /**
     * Collapse a building basement. Inflict the appropriate amount of damage on
     * all entities that fell to the basement. Update all clients.
     *
     * @param bldg
     *            - the &lt;code&gt;Building&lt;/code&gt; that has collapsed.
     * @param positionMap
     *            - a &lt;code&gt;Hashtable&lt;/code&gt; that maps the &lt;code&gt;Coords&lt;/code&gt;
     *            positions or each unit in the game to a &lt;code&gt;Vector&lt;/code&gt; of
     *            &lt;code&gt;Entity&lt;/code&gt;s at that position. This value should not
     *            be &lt;code&gt;null&lt;/code&gt;.
     * @param coords
     *            - The &lt;code&gt;Coords&gt;&lt;/code&gt; of the building basement hex that
     *            has collapsed
     */
    public void collapseBasement(Building bldg, Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap,
                                 Coords coords, Vector&lt;Report&gt; vPhaseReport) {
<span class="nc bnc" id="L32225" title="All 2 branches missed.">        if (!bldg.hasCFIn(coords)) {</span>
<span class="nc" id="L32226">            return;</span>
        }
        int runningCFTotal;
<span class="nc" id="L32229">        runningCFTotal = bldg.getCurrentCF(coords);</span>

        // Get the Vector of Entities at these coordinates.
<span class="nc" id="L32232">        final Vector&lt;Entity&gt; entities = positionMap.get(coords);</span>

<span class="nc bnc" id="L32234" title="All 2 branches missed.">        if (bldg.getBasement(coords) == BasementType.NONE) {</span>
<span class="nc" id="L32235">            return;</span>
        } else {
<span class="nc" id="L32237">            bldg.collapseBasement(coords, game.getBoard(), vPhaseReport);</span>
        }

        // Are there any Entities at these coords?
<span class="nc bnc" id="L32241" title="All 2 branches missed.">        if (entities != null) {</span>

            // Sort in elevation order
<span class="nc" id="L32244">            entities.sort((a, b) -&gt; {</span>
<span class="nc bnc" id="L32245" title="All 2 branches missed.">                if (a.getElevation() &gt; b.getElevation()) {</span>
<span class="nc" id="L32246">                    return -1;</span>
<span class="nc bnc" id="L32247" title="All 2 branches missed.">                } else if (a.getElevation() &gt; b.getElevation()) {</span>
<span class="nc" id="L32248">                    return 1;</span>
                }
<span class="nc" id="L32250">                return 0;</span>
            });
            // Walk through the entities in this position.
<span class="nc bnc" id="L32253" title="All 2 branches missed.">            for (Entity entity : entities) {</span>

                // int floor = entity.getElevation();

<span class="nc" id="L32257">                int cfDamage = (int) Math.ceil(Math.round(entity.getWeight() / 10.0));</span>

                // all entities should fall
                // ASSUMPTION: PSR to avoid pilot damage
<span class="nc" id="L32261">                PilotingRollData psr = entity.getBasePilotingRoll();</span>
<span class="nc" id="L32262">                entity.addPilotingModifierForTerrain(psr, coords);</span>

                // fall into basement
<span class="nc bnc" id="L32265" title="All 2 branches missed.">                if ((bldg.getBasement(coords) == BasementType.TWO_DEEP_HEAD)</span>
<span class="nc bnc" id="L32266" title="All 2 branches missed.">                        || (bldg.getBasement(coords) == BasementType.TWO_DEEP_FEET)) {</span>
<span class="nc" id="L32267">                    MegaMek.getLogger().error(entity.getDisplayName() + &quot; is falling 2 floors into &quot; + coords.toString());</span>
                    // Damage is determined by the depth of the basement, so a
                    //  fall of 0 elevation is correct in this case
<span class="nc" id="L32270">                    vPhaseReport.addAll(doEntityFall(entity, coords, 0,</span>
<span class="nc" id="L32271">                            Compute.d6(), psr, true, false));</span>
<span class="nc" id="L32272">                    runningCFTotal -= cfDamage * 2;</span>
<span class="nc bnc" id="L32273" title="All 2 branches missed.">                } else if ((bldg.getBasement(coords) != BasementType.NONE)</span>
<span class="nc bnc" id="L32274" title="All 2 branches missed.">                           &amp;&amp; (bldg.getBasement(coords) != BasementType.ONE_DEEP_NORMALINFONLY)) {</span>
<span class="nc" id="L32275">                    MegaMek.getLogger().error(entity.getDisplayName() + &quot; is falling 1 floor into &quot; + coords.toString());</span>
                    // Damage is determined by the depth of the basement, so a
                    //  fall of 0 elevation is correct in this case
<span class="nc" id="L32278">                    vPhaseReport.addAll(doEntityFall(entity, coords, 0,</span>
<span class="nc" id="L32279">                            Compute.d6(), psr, true, false));</span>
<span class="nc" id="L32280">                    runningCFTotal -= cfDamage;</span>
                } else {
<span class="nc" id="L32282">                    MegaMek.getLogger().error(entity.getDisplayName() + &quot; is not falling into &quot; + coords.toString());</span>
                }

                // Update this entity.
                // ASSUMPTION: this is the correct thing to do.
<span class="nc" id="L32287">                entityUpdate(entity.getId());</span>

<span class="nc" id="L32289">            } // Handle the next entity.</span>

        } // End have-entities-here.

        // Update the building
<span class="nc bnc" id="L32294" title="All 2 branches missed.">        if (runningCFTotal &lt; 0) {</span>
<span class="nc" id="L32295">            bldg.setCurrentCF(0, coords);</span>
<span class="nc" id="L32296">            bldg.setPhaseCF(0, coords);</span>
        } else {
<span class="nc" id="L32298">            bldg.setCurrentCF(runningCFTotal, coords);</span>
<span class="nc" id="L32299">            bldg.setPhaseCF(runningCFTotal, coords);</span>
        }
<span class="nc" id="L32301">        sendChangedHex(coords);</span>
<span class="nc" id="L32302">        Vector&lt;Building&gt; buildings = new Vector&lt;&gt;();</span>
<span class="nc" id="L32303">        buildings.add(bldg);</span>
<span class="nc" id="L32304">        sendChangedBuildings(buildings);</span>
<span class="nc" id="L32305">    }</span>

    /**
     * Collapse a building hex. Inflict the appropriate amount of damage on all
     * entities in the building. Update all clients.
     *
     * @param bldg
     *            - the &lt;code&gt;Building&lt;/code&gt; that has collapsed.
     * @param positionMap
     *            - a &lt;code&gt;Hashtable&lt;/code&gt; that maps the &lt;code&gt;Coords&lt;/code&gt;
     *            positions or each unit in the game to a &lt;code&gt;Vector&lt;/code&gt; of
     *            &lt;code&gt;Entity&lt;/code&gt;s at that position. This value should not
     *            be &lt;code&gt;null&lt;/code&gt;.
     * @param coords
     *            - The &lt;code&gt;Coords&gt;&lt;/code&gt; of the building hex that has
     *            collapsed
     * @param collapseAll
     *            - A &lt;code&gt;boolean&lt;/code&gt; indicating whether or not this
     *            collapse of a hex should be able to collapse the whole
     *            building
     * @param topFloor
     *            - A &lt;code&gt;boolean&lt;/code&gt; indicating that only the top floor collapses
     *              (from a WiGE flying over the top).
     *
     */
    public void collapseBuilding(Building bldg,
            Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap, Coords coords,
            boolean collapseAll, boolean topFloor, Vector&lt;Report&gt; vPhaseReport) {
        // sometimes, buildings that reach CF 0 decide against collapsing
        // but we want them to go away anyway, as a building with CF 0 cannot stand
<span class="nc bnc" id="L32335" title="All 2 branches missed.">        final int phaseCF = bldg.hasCFIn(coords) ? bldg.getPhaseCF(coords) : 0;</span>

        // Loop through the hexes in the building, and apply
        // damage to all entities inside or on top of the building.
        Report r;
        
        // Get the Vector of Entities at these coordinates.
<span class="nc" id="L32342">        final Vector&lt;Entity&gt; vector = positionMap.get(coords);</span>

        // Are there any Entities at these coords?
<span class="nc bnc" id="L32345" title="All 2 branches missed.">        if (vector != null) {</span>

            // How many levels does this building have in this hex?
<span class="nc" id="L32348">            final IHex curHex = game.getBoard().getHex(coords);</span>
<span class="nc" id="L32349">            final int bridgeEl = curHex.terrainLevel(Terrains.BRIDGE_ELEV);</span>
<span class="nc" id="L32350">            final int numFloors = Math.max(bridgeEl,</span>
<span class="nc" id="L32351">                    curHex.terrainLevel(Terrains.BLDG_ELEV));</span>

            // Now collapse the building in this hex, so entities fall to
            // the ground
<span class="nc bnc" id="L32355" title="All 4 branches missed.">            if (topFloor &amp;&amp; numFloors &gt; 1) {</span>
<span class="nc" id="L32356">                curHex.removeTerrain(Terrains.BLDG_ELEV);</span>
<span class="nc" id="L32357">                curHex.addTerrain(Terrains.getTerrainFactory().createTerrain(Terrains.BLDG_ELEV, numFloors - 1));</span>
<span class="nc" id="L32358">                sendChangedHex(coords);</span>
            } else {
<span class="nc" id="L32360">                bldg.setCurrentCF(0, coords);</span>
<span class="nc" id="L32361">                bldg.setPhaseCF(0, coords);</span>
<span class="nc" id="L32362">                send(createCollapseBuildingPacket(coords));</span>
<span class="nc" id="L32363">                game.getBoard().collapseBuilding(coords);</span>
            }

            // Sort in elevation order
<span class="nc" id="L32367">            vector.sort((a, b) -&gt; {</span>
<span class="nc bnc" id="L32368" title="All 2 branches missed.">                if (a.getElevation() &gt; b.getElevation()) {</span>
<span class="nc" id="L32369">                    return -1;</span>
<span class="nc bnc" id="L32370" title="All 2 branches missed.">                } else if (a.getElevation() &gt; b.getElevation()) {</span>
<span class="nc" id="L32371">                    return 1;</span>
                }
<span class="nc" id="L32373">                return 0;</span>
            });
            // Walk through the entities in this position.
<span class="nc" id="L32376">            Enumeration&lt;Entity&gt; entities = vector.elements();</span>
<span class="nc bnc" id="L32377" title="All 2 branches missed.">            while (entities.hasMoreElements()) {</span>
<span class="nc" id="L32378">                final Entity entity = entities.nextElement();</span>
                // all gun emplacements are simply destroyed
<span class="nc bnc" id="L32380" title="All 2 branches missed.">                if (entity instanceof GunEmplacement) {</span>
<span class="nc" id="L32381">                    vPhaseReport.addAll(destroyEntity(entity, &quot;building collapse&quot;));</span>
<span class="nc" id="L32382">                    addNewLines();</span>
<span class="nc" id="L32383">                    continue;</span>
                }

<span class="nc" id="L32386">                int floor = entity.getElevation();</span>
                // If only the top floor collapses, we only care about units on the top level
                // or on the roof.
<span class="nc bnc" id="L32389" title="All 4 branches missed.">                if (topFloor &amp;&amp; floor &lt; numFloors - 1) {</span>
<span class="nc" id="L32390">                    continue;</span>
                }
                // units trapped in a basement under a collapsing building are
                // destroyed
<span class="nc bnc" id="L32394" title="All 2 branches missed.">                if (floor &lt; 0) {</span>
<span class="nc" id="L32395">                    vPhaseReport.addAll(destroyEntity(entity,</span>
                            &quot;Crushed under building rubble&quot;, false, false));
                }

                // Ignore units above the building / bridge.
<span class="nc bnc" id="L32400" title="All 2 branches missed.">                if (floor &gt; numFloors) {</span>
<span class="nc" id="L32401">                    continue;</span>
                }

                // Treat units on the roof like
                // they were in the top floor.
<span class="nc bnc" id="L32406" title="All 2 branches missed.">                if (floor == numFloors) {</span>
<span class="nc" id="L32407">                    floor--;</span>
                }

                // Calculate collapse damage for this entity.
<span class="nc" id="L32411">                int damage = (int) Math.floor(bldg.getDamageFromScale()</span>
<span class="nc" id="L32412">                        * Math.ceil((phaseCF * (numFloors - floor)) / 10.0));</span>

                // Infantry suffer more damage.
<span class="nc bnc" id="L32415" title="All 2 branches missed.">                if (entity instanceof Infantry) {</span>
<span class="nc bnc" id="L32416" title="All 4 branches missed.">                    if ((entity instanceof BattleArmor) || ((Infantry) entity).isMechanized()) {</span>
<span class="nc" id="L32417">                        damage *= 2;</span>
                    } else {
<span class="nc" id="L32419">                        damage *= 3;</span>
                    }
                }

                // Apply collapse damage the entity.
<span class="nc" id="L32424">                r = new Report(6455);</span>
<span class="nc" id="L32425">                r.indent();</span>
<span class="nc" id="L32426">                r.subject = entity.getId();</span>
<span class="nc" id="L32427">                r.add(entity.getDisplayName());</span>
<span class="nc" id="L32428">                r.add(damage);</span>
<span class="nc" id="L32429">                vPhaseReport.add(r);</span>
<span class="nc" id="L32430">                int remaining = damage;</span>
<span class="nc" id="L32431">                int cluster = damage;</span>
<span class="nc bnc" id="L32432" title="All 6 branches missed.">                if ((entity instanceof BattleArmor) || (entity instanceof Mech)</span>
                        || (entity instanceof Tank)) {
<span class="nc" id="L32434">                    cluster = 5;</span>
                }
<span class="nc bnc" id="L32436" title="All 2 branches missed.">                while (remaining &gt; 0) {</span>
<span class="nc" id="L32437">                    int next = Math.min(cluster, remaining);</span>
                    int table;
<span class="nc bnc" id="L32439" title="All 2 branches missed.">                    if (entity instanceof Protomech) {</span>
<span class="nc" id="L32440">                        table = ToHitData.HIT_SPECIAL_PROTO;</span>
<span class="nc bnc" id="L32441" title="All 2 branches missed.">                    } else if (entity.getElevation() == numFloors) {</span>
<span class="nc" id="L32442">                        table = ToHitData.HIT_NORMAL;</span>
                    } else {
<span class="nc" id="L32444">                        table = ToHitData.HIT_PUNCH;</span>
                    }
<span class="nc" id="L32446">                    HitData hit = entity.rollHitLocation(table, ToHitData.SIDE_FRONT);</span>
<span class="nc" id="L32447">                    hit.setGeneralDamageType(HitData.DAMAGE_PHYSICAL);</span>
<span class="nc" id="L32448">                    vPhaseReport.addAll(damageEntity(entity, hit, next));</span>
<span class="nc" id="L32449">                    remaining -= next;</span>
<span class="nc" id="L32450">                }</span>
<span class="nc" id="L32451">                vPhaseReport.add(new Report(1210, Report.PUBLIC));</span>

                // all entities should fall
<span class="nc" id="L32454">                floor = entity.getElevation();</span>
<span class="nc bnc" id="L32455" title="All 4 branches missed.">                if ((floor &gt; 0) || (floor == bridgeEl)) {</span>
                    // ASSUMPTION: PSR to avoid pilot damage
                    // should use mods for entity damage and
                    // 20+ points of collapse damage (if any).
<span class="nc" id="L32459">                    PilotingRollData psr = entity.getBasePilotingRoll();</span>
<span class="nc" id="L32460">                    entity.addPilotingModifierForTerrain(psr, coords);</span>
<span class="nc bnc" id="L32461" title="All 2 branches missed.">                    if (damage &gt;= 20) {</span>
<span class="nc" id="L32462">                        psr.addModifier(1, &quot;20+ damage&quot;);</span>
                    }
<span class="nc" id="L32464">                    vPhaseReport.addAll(doEntityFallsInto(entity, coords, psr,</span>
                            true));
                }
                // Update this entity.
                // ASSUMPTION: this is the correct thing to do.
<span class="nc" id="L32469">                entityUpdate(entity.getId());</span>

<span class="nc" id="L32471">            } // Handle the next entity.</span>

<span class="nc" id="L32473">        } // End have-entities-here.</span>

        else {
            // Update the building.
<span class="nc" id="L32477">            bldg.setCurrentCF(0, coords);</span>
<span class="nc" id="L32478">            bldg.setPhaseCF(0, coords);</span>
<span class="nc" id="L32479">            send(createCollapseBuildingPacket(coords));</span>
<span class="nc" id="L32480">            game.getBoard().collapseBuilding(coords);</span>
        }
        // if more than half of the hexes are gone, collapse all
<span class="nc bnc" id="L32483" title="All 2 branches missed.">        if (bldg.getCollapsedHexCount() &gt; (bldg.getOriginalHexCount() / 2)) {</span>
<span class="nc" id="L32484">            for (Enumeration&lt;Coords&gt; coordsEnum = bldg.getCoords(); coordsEnum</span>
<span class="nc bnc" id="L32485" title="All 2 branches missed.">                    .hasMoreElements();) {</span>
<span class="nc" id="L32486">                coords = coordsEnum.nextElement();</span>
<span class="nc" id="L32487">                collapseBuilding(bldg, game.getPositionMap(), coords, false,</span>
                        vPhaseReport);
            }
        }

<span class="nc" id="L32492">    } // End private void collapseBuilding( Building )</span>

    /**
     * Tell the clients to replace the given building with rubble hexes.
     *
     * @param coords - the &lt;code&gt;Coords&lt;/code&gt; that has collapsed.
     * @return a &lt;code&gt;Packet&lt;/code&gt; for the command.
     */
    private Packet createCollapseBuildingPacket(Coords coords) {
<span class="nc" id="L32501">        Vector&lt;Coords&gt; coordsV = new Vector&lt;&gt;();</span>
<span class="nc" id="L32502">        coordsV.addElement(coords);</span>
<span class="nc" id="L32503">        return createCollapseBuildingPacket(coordsV);</span>
    }

    /**
     * Tell the clients to replace the given building hexes with rubble hexes.
     *
     * @param coords - a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Coords&lt;/code&gt;s that has
     *               collapsed.
     * @return a &lt;code&gt;Packet&lt;/code&gt; for the command.
     */
    private Packet createCollapseBuildingPacket(Vector&lt;Coords&gt; coords) {
<span class="nc" id="L32514">        return new Packet(Packet.COMMAND_BLDG_COLLAPSE, coords);</span>
    }

    /**
     * Tell the clients to update the CFs of the given buildings.
     *
     * @param buildings - a &lt;code&gt;Vector&lt;/code&gt; of &lt;code&gt;Building&lt;/code&gt;s that need to
     *                  be updated.
     * @return a &lt;code&gt;Packet&lt;/code&gt; for the command.
     */
    private Packet createUpdateBuildingPacket(Vector&lt;Building&gt; buildings) {
<span class="nc" id="L32525">        return new Packet(Packet.COMMAND_BLDG_UPDATE, buildings);</span>
    }

    /**
     * Apply this phase's damage to all buildings. Buildings may collapse due to
     * damage.
     */
    private void applyBuildingDamage() {

        // Walk through the buildings in the game.
        // Build the collapse and update vectors as you go.
        // N.B. never, NEVER, collapse buildings while you are walking through
        // the Enumeration from megamek.common.Board#getBuildings.
<span class="nc" id="L32538">        Map&lt;Building, Vector&lt;Coords&gt;&gt; collapse = new HashMap&lt;&gt;();</span>
<span class="nc" id="L32539">        Map&lt;Building, Vector&lt;Coords&gt;&gt; update = new HashMap&lt;&gt;();</span>
<span class="nc" id="L32540">        Enumeration&lt;Building&gt; buildings = game.getBoard().getBuildings();</span>
<span class="nc bnc" id="L32541" title="All 2 branches missed.">        while (buildings.hasMoreElements()) {</span>
<span class="nc" id="L32542">            Building bldg = buildings.nextElement();</span>
<span class="nc" id="L32543">            Vector&lt;Coords&gt; collapseCoords = new Vector&lt;&gt;();</span>
<span class="nc" id="L32544">            Vector&lt;Coords&gt; updateCoords = new Vector&lt;&gt;();</span>
<span class="nc" id="L32545">            Enumeration&lt;Coords&gt; buildingCoords = bldg.getCoords();</span>
<span class="nc bnc" id="L32546" title="All 2 branches missed.">            while (buildingCoords.hasMoreElements()) {</span>
<span class="nc" id="L32547">                Coords coords = buildingCoords.nextElement();</span>
                // If the CF is zero, the building should fall.
<span class="nc bnc" id="L32549" title="All 2 branches missed.">                if (bldg.getCurrentCF(coords) == 0) {</span>
<span class="nc" id="L32550">                    collapseCoords.addElement(coords);</span>
                }
                // If the building took damage this round, update it.
<span class="nc bnc" id="L32553" title="All 2 branches missed.">                else if (bldg.getPhaseCF(coords) != bldg.getCurrentCF(coords)) {</span>
<span class="nc" id="L32554">                    bldg.setPhaseCF(bldg.getCurrentCF(coords), coords);</span>
<span class="nc" id="L32555">                    updateCoords.addElement(coords);</span>
                }
<span class="nc" id="L32557">            }</span>
<span class="nc" id="L32558">            collapse.put(bldg, collapseCoords);</span>
<span class="nc" id="L32559">            update.put(bldg, updateCoords);</span>
<span class="nc" id="L32560">        } // Handle the next building</span>

        // If we have any buildings to collapse, collapse them now.
<span class="nc bnc" id="L32563" title="All 2 branches missed.">        if (!collapse.isEmpty()) {</span>

            // Get the position map of all entities in the game.
<span class="nc" id="L32566">            Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap = game</span>
<span class="nc" id="L32567">                    .getPositionMap();</span>

            // Walk through the hexes that have collapsed.
<span class="nc bnc" id="L32570" title="All 2 branches missed.">            for (Building bldg : collapse.keySet()) {</span>
<span class="nc" id="L32571">                Vector&lt;Coords&gt; coordsVector = collapse.get(bldg);</span>
<span class="nc bnc" id="L32572" title="All 2 branches missed.">                for (Coords coords : coordsVector) {</span>
<span class="nc" id="L32573">                    Report r = new Report(6460, Report.PUBLIC);</span>
<span class="nc" id="L32574">                    r.add(bldg.getName());</span>
<span class="nc" id="L32575">                    addReport(r);</span>
<span class="nc" id="L32576">                    collapseBuilding(bldg, positionMap, coords, vPhaseReport);</span>
<span class="nc" id="L32577">                }</span>
<span class="nc" id="L32578">            }</span>
        }

        // check for buildings which should collapse due to being overloaded now
        // CF is reduced
<span class="nc bnc" id="L32583" title="All 2 branches missed.">        if (!update.isEmpty()) {</span>
<span class="nc" id="L32584">            Hashtable&lt;Coords, Vector&lt;Entity&gt;&gt; positionMap = game.getPositionMap();</span>
<span class="nc bnc" id="L32585" title="All 2 branches missed.">            for (Building bldg : update.keySet()) {</span>
<span class="nc" id="L32586">                Vector&lt;Coords&gt; updateCoords = update.get(bldg);</span>
<span class="nc" id="L32587">                Vector&lt;Coords&gt; coordsToRemove = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L32588" title="All 2 branches missed.">                for (Coords coords : updateCoords) {</span>
<span class="nc bnc" id="L32589" title="All 2 branches missed.">                    if (checkForCollapse(bldg, positionMap, coords, false,</span>
                                         vPhaseReport)) {
<span class="nc" id="L32591">                        coordsToRemove.add(coords);</span>
                    }
<span class="nc" id="L32593">                }</span>
<span class="nc" id="L32594">                updateCoords.removeAll(coordsToRemove);</span>
<span class="nc" id="L32595">                update.put(bldg, updateCoords);</span>
<span class="nc" id="L32596">            }</span>
        }

        // If we have any buildings to update, send the message.
<span class="nc bnc" id="L32600" title="All 2 branches missed.">        if (!update.isEmpty()) {</span>
<span class="nc" id="L32601">            sendChangedBuildings(new Vector&lt;&gt;(update.keySet()));</span>
        }
<span class="nc" id="L32603">    }</span>

    /**
     * Apply the given amount of damage to the building. Please note, this
     * method does &lt;b&gt;not&lt;/b&gt; apply any damage to units inside the building,
     * update the clients, or check for the building's collapse.
     * &lt;p/&gt;
     * A default message will be used to describe why the building took the
     * damage.
     *
     * @param bldg   - the &lt;code&gt;Building&lt;/code&gt; that has been damaged. This value
     *               should not be &lt;code&gt;null&lt;/code&gt;, but no exception will occur.
     * @param damage - the &lt;code&gt;int&lt;/code&gt; amount of damage.
     * @param coords - the &lt;code&gt;Coords&lt;/code&gt; of the building hex to be damaged
     * @return a &lt;code&gt;Report&lt;/code&gt; to be shown to the players.
     */
    public Vector&lt;Report&gt; damageBuilding(Building bldg, int damage,
                                         Coords coords) {
<span class="nc" id="L32621">        final String defaultWhy = &quot; absorbs &quot;;</span>
<span class="nc" id="L32622">        return damageBuilding(bldg, damage, defaultWhy, coords);</span>
    }

    /**
     * Apply the given amount of damage to the building. Please note, this
     * method does &lt;b&gt;not&lt;/b&gt; apply any damage to units inside the building,
     * update the clients, or check for the building's collapse.
     *
     * @param bldg   - the &lt;code&gt;Building&lt;/code&gt; that has been damaged. This value
     *               should not be &lt;code&gt;null&lt;/code&gt;, but no exception will occur.
     * @param damage - the &lt;code&gt;int&lt;/code&gt; amount of damage.
     * @param why    - the &lt;code&gt;String&lt;/code&gt; message that describes why the
     *               building took the damage.
     * @param coords - the &lt;code&gt;Coords&lt;/code&gt; of the building hex to be damaged
     * @return a &lt;code&gt;Report&lt;/code&gt; to be shown to the players.
     */
    public Vector&lt;Report&gt; damageBuilding(Building bldg, int damage, String why, Coords coords) {
<span class="nc" id="L32639">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L32640">        Report r = new Report(1210, Report.PUBLIC);</span>

        // Do nothing if no building or no damage was passed.
<span class="nc bnc" id="L32643" title="All 4 branches missed.">        if ((bldg != null) &amp;&amp; (damage &gt; 0)) {</span>
<span class="nc" id="L32644">            r.messageId = 3435;</span>
<span class="nc" id="L32645">            r.add(bldg.toString());</span>
<span class="nc" id="L32646">            r.add(why);</span>
<span class="nc" id="L32647">            r.add(damage);</span>
<span class="nc" id="L32648">            vPhaseReport.add(r);</span>
<span class="nc" id="L32649">            int curArmor = bldg.getArmor(coords);</span>
<span class="nc bnc" id="L32650" title="All 2 branches missed.">            if (curArmor &gt;= damage) {</span>
<span class="nc" id="L32651">                curArmor -= Math.min(curArmor, damage);</span>
<span class="nc" id="L32652">                bldg.setArmor(curArmor, coords);</span>
<span class="nc" id="L32653">                r = new Report(3436, Report.PUBLIC);</span>
<span class="nc" id="L32654">                r.indent(0);</span>
<span class="nc" id="L32655">                r.add(damage);</span>
<span class="nc" id="L32656">                r.add(curArmor);</span>
<span class="nc" id="L32657">                vPhaseReport.add(r);</span>
            } else {
<span class="nc" id="L32659">                r.add(damage);</span>
<span class="nc bnc" id="L32660" title="All 2 branches missed.">                if (curArmor &gt; 0) {</span>
<span class="nc" id="L32661">                    bldg.setArmor(0, coords);</span>
<span class="nc" id="L32662">                    damage = damage - curArmor;</span>
<span class="nc" id="L32663">                    r = new Report(3436, Report.PUBLIC);</span>
<span class="nc" id="L32664">                    r.indent(0);</span>
<span class="nc" id="L32665">                    r.add(curArmor);</span>
<span class="nc" id="L32666">                    r.add(0);</span>
<span class="nc" id="L32667">                    vPhaseReport.add(r);</span>
                }
<span class="nc" id="L32669">                damage = (int) Math.floor(bldg.getDamageToScale() * damage);</span>
<span class="nc bnc" id="L32670" title="All 2 branches missed.">                if (bldg.getDamageToScale() &lt; 1.0) {</span>
<span class="nc" id="L32671">                    r = new Report(3437, Report.PUBLIC);</span>
<span class="nc" id="L32672">                    r.indent(0);</span>
<span class="nc" id="L32673">                    r.add(damage);</span>
<span class="nc" id="L32674">                    vPhaseReport.add(r);</span>
                }
<span class="nc bnc" id="L32676" title="All 2 branches missed.">                if (bldg.getDamageToScale() &gt; 1.0) {</span>
<span class="nc" id="L32677">                    r = new Report(3438, Report.PUBLIC);</span>
<span class="nc" id="L32678">                    r.indent(0);</span>
<span class="nc" id="L32679">                    r.add(damage);</span>
<span class="nc" id="L32680">                    vPhaseReport.add(r);</span>
                }
<span class="nc" id="L32682">                int curCF = bldg.getCurrentCF(coords);</span>
<span class="nc" id="L32683">                final int startingCF = curCF;</span>
<span class="nc" id="L32684">                curCF -= Math.min(curCF, damage);</span>
<span class="nc" id="L32685">                bldg.setCurrentCF(curCF, coords);</span>

<span class="nc" id="L32687">                r = new Report(6436, Report.PUBLIC);</span>
<span class="nc" id="L32688">                r.indent(1);</span>
<span class="nc bnc" id="L32689" title="All 2 branches missed.">                String fontColorOpen = curCF &lt;= 0 ? &quot;&lt;font color='C00000'&gt;&quot; : &quot;&quot;;</span>
<span class="nc bnc" id="L32690" title="All 2 branches missed.">                String fontColorClose = curCF &lt;= 0 ? &quot;&lt;/font&gt;&quot; : &quot;&quot;;</span>
<span class="nc" id="L32691">                r.add(String.format(&quot;%s%s%s&quot;, fontColorOpen, curCF, fontColorClose));</span>
<span class="nc" id="L32692">                vPhaseReport.add(r);</span>

<span class="nc" id="L32694">                final int damageThresh = (int) Math.ceil(bldg.getPhaseCF(coords) / 10.0);</span>

                // If the CF is zero, the building should fall.
<span class="nc bnc" id="L32697" title="All 4 branches missed.">                if ((curCF == 0) &amp;&amp; (startingCF != 0)) {</span>
<span class="nc bnc" id="L32698" title="All 2 branches missed.">                    if (bldg instanceof FuelTank) {</span>
                        // If this is a fuel tank, we'll give it its own
                        // message.
<span class="nc" id="L32701">                        r = new Report(3441);</span>
<span class="nc" id="L32702">                        r.type = Report.PUBLIC;</span>
<span class="nc" id="L32703">                        r.indent(0);</span>
<span class="nc" id="L32704">                        vPhaseReport.add(r);</span>
                        // ...But we ALSO need to blow up everything nearby.
                        // Bwahahahahaha...
<span class="nc" id="L32707">                        r = new Report(3560);</span>
<span class="nc" id="L32708">                        r.type = Report.PUBLIC;</span>
<span class="nc" id="L32709">                        r.newlines = 1;</span>
<span class="nc" id="L32710">                        vPhaseReport.add(r);</span>
<span class="nc" id="L32711">                        Vector&lt;Report&gt; vRep = new Vector&lt;&gt;();</span>
<span class="nc" id="L32712">                        doExplosion(((FuelTank) bldg).getMagnitude(), 10,</span>
<span class="nc" id="L32713">                                false, bldg.getCoords().nextElement(), true,</span>
                                vRep, null, -1);
<span class="nc" id="L32715">                        Report.indentAll(vRep, 2);</span>
<span class="nc" id="L32716">                        vPhaseReport.addAll(vRep);</span>
<span class="nc" id="L32717">                        return vPhaseReport;</span>
                    }
<span class="nc bnc" id="L32719" title="All 2 branches missed.">                    if (bldg.getType() == Building.WALL) {</span>
<span class="nc" id="L32720">                        r = new Report(3442);</span>
<span class="nc" id="L32721">                        r.type = Report.PUBLIC;</span>
<span class="nc" id="L32722">                        r.indent(0);</span>
<span class="nc" id="L32723">                        vPhaseReport.add(r);</span>
                    } else {
<span class="nc" id="L32725">                        r = new Report(3440);</span>
<span class="nc" id="L32726">                        r.type = Report.PUBLIC;</span>
<span class="nc" id="L32727">                        r.indent(0);</span>
<span class="nc" id="L32728">                        vPhaseReport.add(r);</span>
                    }
<span class="nc bnc" id="L32730" title="All 4 branches missed.">                } else if ((curCF &lt; startingCF) &amp;&amp; (damage &gt; damageThresh)) {</span>
                    // need to check for crits
                    // don't bother unless we have some gun emplacements
<span class="nc" id="L32733">                    Vector&lt;GunEmplacement&gt; guns = game</span>
<span class="nc" id="L32734">                            .getGunEmplacements(coords);</span>
<span class="nc bnc" id="L32735" title="All 2 branches missed.">                    if (guns.size() &gt; 0) {</span>
<span class="nc" id="L32736">                        vPhaseReport.addAll(criticalGunEmplacement(guns, bldg,</span>
                                coords));
                    }
                }
            }
        }
<span class="nc" id="L32742">        Report.indentAll(vPhaseReport, 2);</span>
<span class="nc" id="L32743">        return vPhaseReport;</span>
    }

    private Vector&lt;Report&gt; criticalGunEmplacement(Vector&lt;GunEmplacement&gt; guns, Building bldg,
                                                  Coords coords) {
<span class="nc" id="L32748">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L32750">        r = new Report(3800);</span>
<span class="nc" id="L32751">        r.type = Report.PUBLIC;</span>
<span class="nc" id="L32752">        r.indent(0);</span>
<span class="nc" id="L32753">        vDesc.add(r);</span>

<span class="nc" id="L32755">        int critRoll = Compute.d6(2);</span>
<span class="nc bnc" id="L32756" title="All 2 branches missed.">        if (critRoll &lt; 6) {</span>
<span class="nc" id="L32757">            r = new Report(3805);</span>
<span class="nc" id="L32758">            r.type = Report.PUBLIC;</span>
<span class="nc" id="L32759">            r.indent(1);</span>
<span class="nc" id="L32760">            vDesc.add(r);</span>
<span class="nc bnc" id="L32761" title="All 2 branches missed.">        } else if (critRoll == 6) {</span>
            // weapon malfunction
            // lets just randomly determine which weapon gets hit
<span class="nc" id="L32764">            Vector&lt;Mounted&gt; wpns = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L32765" title="All 2 branches missed.">            for (GunEmplacement gun : guns) {</span>
<span class="nc bnc" id="L32766" title="All 2 branches missed.">                for (Mounted wpn : gun.getWeaponList()) {</span>
<span class="nc bnc" id="L32767" title="All 4 branches missed.">                    if (!wpn.isHit() &amp;&amp; !wpn.isJammed()</span>
<span class="nc bnc" id="L32768" title="All 2 branches missed.">                        &amp;&amp; !wpn.jammedThisPhase()) {</span>
<span class="nc" id="L32769">                        wpns.add(wpn);</span>
                    }
<span class="nc" id="L32771">                }</span>
<span class="nc" id="L32772">            }</span>
<span class="nc bnc" id="L32773" title="All 2 branches missed.">            if (wpns.size() &gt; 0) {</span>
<span class="nc" id="L32774">                Mounted weapon = wpns.elementAt(Compute.randomInt(wpns.size()));</span>
<span class="nc" id="L32775">                weapon.setJammed(true);</span>
<span class="nc" id="L32776">                ((GunEmplacement) weapon.getEntity()).addJammedWeapon(weapon);</span>
<span class="nc" id="L32777">                r = new Report(3845);</span>
<span class="nc" id="L32778">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32779">                r.indent(1);</span>
<span class="nc" id="L32780">                r.add(weapon.getDesc());</span>
<span class="nc" id="L32781">            } else {</span>
<span class="nc" id="L32782">                r = new Report(3846);</span>
<span class="nc" id="L32783">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32784">                r.indent(1);</span>
            }
<span class="nc" id="L32786">            vDesc.add(r);</span>
<span class="nc bnc" id="L32787" title="All 2 branches missed.">        } else if (critRoll == 7) {</span>
            // gunners stunned
<span class="nc bnc" id="L32789" title="All 2 branches missed.">            for (GunEmplacement gun : guns) {</span>
<span class="nc" id="L32790">                gun.stunCrew();</span>
<span class="nc" id="L32791">                r = new Report(3810);</span>
<span class="nc" id="L32792">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32793">                r.indent(1);</span>
<span class="nc" id="L32794">                vDesc.add(r);</span>
<span class="nc" id="L32795">            }</span>
<span class="nc bnc" id="L32796" title="All 2 branches missed.">        } else if (critRoll == 8) {</span>
            // weapon destroyed
            // lets just randomly determine which weapon gets hit
<span class="nc" id="L32799">            Vector&lt;Mounted&gt; wpns = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L32800" title="All 2 branches missed.">            for (GunEmplacement gun : guns) {</span>
<span class="nc bnc" id="L32801" title="All 2 branches missed.">                for (Mounted wpn : gun.getWeaponList()) {</span>
<span class="nc bnc" id="L32802" title="All 2 branches missed.">                    if (!wpn.isHit()) {</span>
<span class="nc" id="L32803">                        wpns.add(wpn);</span>
                    }
<span class="nc" id="L32805">                }</span>
<span class="nc" id="L32806">            }</span>
<span class="nc bnc" id="L32807" title="All 2 branches missed.">            if (wpns.size() &gt; 0) {</span>
<span class="nc" id="L32808">                Mounted weapon = wpns.elementAt(Compute.randomInt(wpns.size()));</span>
<span class="nc" id="L32809">                weapon.setHit(true);</span>
<span class="nc" id="L32810">                r = new Report(3840);</span>
<span class="nc" id="L32811">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32812">                r.indent(1);</span>
<span class="nc" id="L32813">                r.add(weapon.getDesc());</span>
<span class="nc" id="L32814">            } else {</span>
<span class="nc" id="L32815">                r = new Report(3841);</span>
<span class="nc" id="L32816">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32817">                r.indent(1);</span>
            }
<span class="nc" id="L32819">            vDesc.add(r);</span>
<span class="nc bnc" id="L32820" title="All 2 branches missed.">        } else if (critRoll == 9) {</span>
            // gunners killed
<span class="nc" id="L32822">            r = new Report(3815);</span>
<span class="nc" id="L32823">            r.type = Report.PUBLIC;</span>
<span class="nc" id="L32824">            r.indent(1);</span>
<span class="nc" id="L32825">            vDesc.add(r);</span>
<span class="nc bnc" id="L32826" title="All 2 branches missed.">            for (GunEmplacement gun : guns) {</span>
<span class="nc" id="L32827">                gun.getCrew().setDoomed(true);</span>
<span class="nc" id="L32828">            }</span>
<span class="nc bnc" id="L32829" title="All 2 branches missed.">        } else if (critRoll == 10) {</span>
<span class="nc bnc" id="L32830" title="All 2 branches missed.">            if (Compute.d6() &gt; 3) {</span>
                // turret lock
<span class="nc" id="L32832">                r = new Report(3820);</span>
<span class="nc" id="L32833">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32834">                r.indent(1);</span>
<span class="nc" id="L32835">                vDesc.add(r);</span>
<span class="nc bnc" id="L32836" title="All 2 branches missed.">                for (GunEmplacement gun : guns) {</span>
<span class="nc" id="L32837">                    gun.lockTurret(gun.getLocTurret());</span>
<span class="nc" id="L32838">                }</span>
            } else {
                // turret jam
<span class="nc" id="L32841">                r = new Report(3825);</span>
<span class="nc" id="L32842">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32843">                r.indent(1);</span>
<span class="nc" id="L32844">                vDesc.add(r);</span>
<span class="nc bnc" id="L32845" title="All 2 branches missed.">                for (GunEmplacement gun : guns) {</span>
<span class="nc bnc" id="L32846" title="All 2 branches missed.">                    if (gun.isTurretEverJammed(gun.getLocTurret())) {</span>
<span class="nc" id="L32847">                        gun.lockTurret(gun.getLocTurret());</span>
                    } else {
<span class="nc" id="L32849">                        gun.jamTurret(gun.getLocTurret());</span>
                    }
<span class="nc" id="L32851">                }</span>
            }
<span class="nc bnc" id="L32853" title="All 2 branches missed.">        } else if (critRoll == 11) {</span>
<span class="nc" id="L32854">            r = new Report(3830);</span>
<span class="nc" id="L32855">            r.type = Report.PUBLIC;</span>
<span class="nc" id="L32856">            r.indent(1);</span>
<span class="nc" id="L32857">            r.add(bldg.getName());</span>
<span class="nc" id="L32858">            int boom = 0;</span>
<span class="nc bnc" id="L32859" title="All 2 branches missed.">            for (GunEmplacement gun : guns) {</span>
<span class="nc bnc" id="L32860" title="All 2 branches missed.">                for (Mounted ammo : gun.getAmmo()) {</span>
<span class="nc" id="L32861">                    ammo.setHit(true);</span>
<span class="nc bnc" id="L32862" title="All 2 branches missed.">                    if (ammo.getType().isExplosive(ammo)) {</span>
<span class="nc" id="L32863">                        boom += ammo.getHittableShotsLeft()</span>
<span class="nc" id="L32864">                                * ((AmmoType) ammo.getType())</span>
<span class="nc" id="L32865">                                .getDamagePerShot()</span>
<span class="nc" id="L32866">                                * ((AmmoType) ammo.getType()).getRackSize();</span>
                    }
<span class="nc" id="L32868">                }</span>
<span class="nc" id="L32869">            }</span>
<span class="nc" id="L32870">            boom = (int) Math.floor(bldg.getDamageToScale() * boom);</span>
            
<span class="nc bnc" id="L32872" title="All 2 branches missed.">            if (boom == 0) {</span>
<span class="nc" id="L32873">                Report rNoAmmo = new Report(3831);</span>
<span class="nc" id="L32874">                rNoAmmo.type = Report.PUBLIC;</span>
<span class="nc" id="L32875">                rNoAmmo.indent(1);</span>
<span class="nc" id="L32876">                vDesc.add(rNoAmmo);</span>
<span class="nc" id="L32877">                return vDesc;</span>
            }
            
<span class="nc" id="L32880">            r.add(boom);</span>
<span class="nc" id="L32881">            int curCF = bldg.getCurrentCF(coords);</span>
<span class="nc" id="L32882">            curCF -= Math.min(curCF, boom);</span>
<span class="nc" id="L32883">            bldg.setCurrentCF(curCF, coords);</span>
<span class="nc" id="L32884">            r.add(bldg.getCurrentCF(coords));</span>
<span class="nc" id="L32885">            vDesc.add(r);</span>
            // If the CF is zero, the building should fall.
<span class="nc bnc" id="L32887" title="All 4 branches missed.">            if ((curCF == 0) &amp;&amp; (bldg.getPhaseCF(coords) != 0)) {</span>
                
                // when a building collapses due to an ammo explosion, we can consider
                // that turret annihilated for the purposes of salvage.
<span class="nc bnc" id="L32891" title="All 2 branches missed.">                for (GunEmplacement gun : guns) {</span>
<span class="nc" id="L32892">                    vDesc.addAll(destroyEntity(gun, &quot;ammo explosion&quot;, false, false));</span>
<span class="nc" id="L32893">                }</span>
                
<span class="nc bnc" id="L32895" title="All 2 branches missed.">                if (bldg instanceof FuelTank) {</span>
                    // If this is a fuel tank, we'll give it its own
                    // message.
<span class="nc" id="L32898">                    r = new Report(3441);</span>
<span class="nc" id="L32899">                    r.type = Report.PUBLIC;</span>
<span class="nc" id="L32900">                    r.indent(0);</span>
<span class="nc" id="L32901">                    vDesc.add(r);</span>
                    // ...But we ALSO need to blow up everything nearby.
                    // Bwahahahahaha...
<span class="nc" id="L32904">                    r = new Report(3560);</span>
<span class="nc" id="L32905">                    r.type = Report.PUBLIC;</span>
<span class="nc" id="L32906">                    r.newlines = 1;</span>
<span class="nc" id="L32907">                    vDesc.add(r);</span>
<span class="nc" id="L32908">                    Vector&lt;Report&gt; vRep = new Vector&lt;&gt;();</span>
<span class="nc" id="L32909">                    doExplosion(((FuelTank) bldg).getMagnitude(), 10, false,</span>
<span class="nc" id="L32910">                                bldg.getCoords().nextElement(), true, vRep, null,</span>
                                -1);
<span class="nc" id="L32912">                    Report.indentAll(vRep, 2);</span>
<span class="nc" id="L32913">                    vDesc.addAll(vRep);</span>
<span class="nc" id="L32914">                    return vPhaseReport;</span>
                }
<span class="nc bnc" id="L32916" title="All 2 branches missed.">                if (bldg.getType() == Building.WALL) {</span>
<span class="nc" id="L32917">                    r = new Report(3442);</span>
                } else {
<span class="nc" id="L32919">                    r = new Report(3440);</span>
                }
<span class="nc" id="L32921">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32922">                r.indent(0);</span>
<span class="nc" id="L32923">                vDesc.add(r);</span>
            }
<span class="nc bnc" id="L32925" title="All 2 branches missed.">        } else if (critRoll == 12) {</span>
            // non-weapon equipment is hit
<span class="nc" id="L32927">            Vector&lt;Mounted&gt; equipmentList = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L32928" title="All 2 branches missed.">            for (GunEmplacement gun : guns) {</span>
<span class="nc bnc" id="L32929" title="All 2 branches missed.">                for (Mounted equipment : gun.getMisc()) {</span>
<span class="nc bnc" id="L32930" title="All 2 branches missed.">                    if (!equipment.isHit()) {</span>
<span class="nc" id="L32931">                        equipmentList.add(equipment);</span>
                    }
<span class="nc" id="L32933">                }</span>
<span class="nc" id="L32934">            }</span>
            
<span class="nc bnc" id="L32936" title="All 2 branches missed.">            if (equipmentList.size() &gt; 0) {</span>
<span class="nc" id="L32937">                Mounted equipment = equipmentList.elementAt(Compute.randomInt(equipmentList.size()));</span>
<span class="nc" id="L32938">                equipment.setHit(true);</span>
<span class="nc" id="L32939">                r = new Report(3840);</span>
<span class="nc" id="L32940">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32941">                r.indent(1);</span>
<span class="nc" id="L32942">                r.add(equipment.getDesc());</span>
<span class="nc" id="L32943">            } else {</span>
<span class="nc" id="L32944">                r = new Report(3835);</span>
<span class="nc" id="L32945">                r.type = Report.PUBLIC;</span>
<span class="nc" id="L32946">                r.indent(1);</span>
            }
<span class="nc" id="L32948">            vDesc.add(r);</span>
        }

<span class="nc" id="L32951">        return vDesc;</span>
    }

    public void sendChangedBuildings(Vector&lt;Building&gt; buildings) {
<span class="nc" id="L32955">        send(createUpdateBuildingPacket(buildings));</span>
<span class="nc" id="L32956">    }</span>

    /**
     * Receives an packet to unload entity is stranded on immobile transports,
     * and queue all valid requests for execution. If all players that have
     * stranded entities have answered, executes the pending requests and end
     * the current turn.
     */
    private void receiveUnloadStranded(Packet packet, int connId) {
        GameTurn.UnloadStrandedTurn turn;
<span class="nc" id="L32966">        final IPlayer player = game.getPlayer(connId);</span>
<span class="nc" id="L32967">        int[] entityIds = (int[]) packet.getObject(0);</span>
        Vector&lt;IPlayer&gt; declared;
        IPlayer other;
        Enumeration&lt;EntityAction&gt; pending;
        UnloadStrandedAction action;
        Entity entity;

        // Is this the right phase?
<span class="nc bnc" id="L32975" title="All 2 branches missed.">        if (game.getPhase() != IGame.Phase.PHASE_MOVEMENT) {</span>
<span class="nc" id="L32976">            MegaMek.getLogger().error(&quot;Server got unload stranded packet in wrong phase&quot;);</span>
<span class="nc" id="L32977">            return;</span>
        }

        // Are we in an &quot;unload stranded entities&quot; turn?
<span class="nc bnc" id="L32981" title="All 2 branches missed.">        if (game.getTurn() instanceof GameTurn.UnloadStrandedTurn) {</span>
<span class="nc" id="L32982">            turn = (GameTurn.UnloadStrandedTurn) game.getTurn();</span>
        } else {
<span class="nc" id="L32984">            MegaMek.getLogger().error(&quot;Server got unload stranded packet out of sequence&quot;);</span>
<span class="nc" id="L32985">            sendServerChat(player.getName() + &quot; should not be sending 'unload stranded entity' packets at this time.&quot;);</span>
<span class="nc" id="L32986">            return;</span>
        }

        // Can this player act right now?
<span class="nc bnc" id="L32990" title="All 2 branches missed.">        if (!turn.isValid(connId, game)) {</span>
<span class="nc" id="L32991">            MegaMek.getLogger().error(&quot;Server got unload stranded packet from invalid player&quot;);</span>
<span class="nc" id="L32992">            sendServerChat(player.getName() + &quot; should not be sending 'unload stranded entity' packets.&quot;);</span>
<span class="nc" id="L32993">            return;</span>
        }

        // Did the player already send an 'unload' request?
        // N.B. we're also building the list of players who
        // have declared their &quot;unload stranded&quot; actions.
<span class="nc" id="L32999">        declared = new Vector&lt;&gt;();</span>
<span class="nc" id="L33000">        pending = game.getActions();</span>
<span class="nc bnc" id="L33001" title="All 2 branches missed.">        while (pending.hasMoreElements()) {</span>
<span class="nc" id="L33002">            action = (UnloadStrandedAction) pending.nextElement();</span>
<span class="nc bnc" id="L33003" title="All 2 branches missed.">            if (action.getPlayerId() == connId) {</span>
<span class="nc" id="L33004">                MegaMek.getLogger().error(&quot;Server got multiple unload stranded packets from player&quot;);</span>
<span class="nc" id="L33005">                sendServerChat(player.getName() + &quot; should not send multiple 'unload stranded entity' packets.&quot;);</span>
<span class="nc" id="L33006">                return;</span>
            }
            // This player is not from the current connection.
            // Record this player to determine if this turn is done.
<span class="nc" id="L33010">            other = game.getPlayer(action.getPlayerId());</span>
<span class="nc bnc" id="L33011" title="All 2 branches missed.">            if (!declared.contains(other)) {</span>
<span class="nc" id="L33012">                declared.addElement(other);</span>
            }
        } // Handle the next &quot;unload stranded&quot; action.

        // Make sure the player selected at least *one* valid entity ID.
<span class="nc" id="L33017">        boolean foundValid = false;</span>
<span class="nc bnc" id="L33018" title="All 4 branches missed.">        for (int index = 0; (null != entityIds) &amp;&amp; (index &lt; entityIds.length); index++) {</span>
<span class="nc" id="L33019">            entity = game.getEntity(entityIds[index]);</span>
<span class="nc bnc" id="L33020" title="All 2 branches missed.">            if (!game.getTurn().isValid(connId, entity, game)) {</span>
<span class="nc" id="L33021">                MegaMek.getLogger().error(&quot;Server got unload stranded packet for invalid entity&quot;);</span>
<span class="nc" id="L33022">                StringBuilder message = new StringBuilder();</span>
<span class="nc" id="L33023">                message.append(player.getName()).append(&quot; can not unload stranded entity &quot;);</span>
<span class="nc bnc" id="L33024" title="All 2 branches missed.">                if (null == entity) {</span>
<span class="nc" id="L33025">                    message.append('#').append(entityIds[index]);</span>
                } else {
<span class="nc" id="L33027">                    message.append(entity.getDisplayName());</span>
                }
<span class="nc" id="L33029">                message.append(&quot; at this time.&quot;);</span>
<span class="nc" id="L33030">                sendServerChat(message.toString());</span>
<span class="nc" id="L33031">            } else {</span>
<span class="nc" id="L33032">                foundValid = true;</span>
<span class="nc" id="L33033">                game.addAction(new UnloadStrandedAction(connId, entityIds[index]));</span>
            }
        }

        // Did the player choose not to unload any valid stranded entity?
<span class="nc bnc" id="L33038" title="All 2 branches missed.">        if (!foundValid) {</span>
<span class="nc" id="L33039">            game.addAction(new UnloadStrandedAction(connId, Entity.NONE));</span>
        }

        // Either way, the connection's player has now declared.
<span class="nc" id="L33043">        declared.addElement(player);</span>

        // Are all players who are unloading entities done? Walk
        // through the turn's stranded entities, and look to see
        // if their player has finished their turn.
<span class="nc" id="L33048">        entityIds = turn.getEntityIds();</span>
<span class="nc bnc" id="L33049" title="All 2 branches missed.">        for (int entityId : entityIds) {</span>
<span class="nc" id="L33050">            entity = game.getEntity(entityId);</span>
<span class="nc" id="L33051">            other = entity.getOwner();</span>
<span class="nc bnc" id="L33052" title="All 2 branches missed.">            if (!declared.contains(other)) {</span>
                // At least one player still needs to declare.
<span class="nc" id="L33054">                return;</span>
            }
        }

        // All players have declared whether they're unloading stranded units.
        // Walk the list of pending actions and unload the entities.
<span class="nc" id="L33060">        pending = game.getActions();</span>
<span class="nc bnc" id="L33061" title="All 2 branches missed.">        while (pending.hasMoreElements()) {</span>
<span class="nc" id="L33062">            action = (UnloadStrandedAction) pending.nextElement();</span>

            // Some players don't want to unload any stranded units.
<span class="nc bnc" id="L33065" title="All 2 branches missed.">            if (Entity.NONE != action.getEntityId()) {</span>
<span class="nc" id="L33066">                entity = game.getEntity(action.getEntityId());</span>
<span class="nc bnc" id="L33067" title="All 2 branches missed.">                if (null == entity) {</span>
                    // After all this, we couldn't find the entity!!!
<span class="nc" id="L33069">                    MegaMek.getLogger().error(&quot;Server could not find stranded entity #&quot;</span>
<span class="nc" id="L33070">                            + action.getEntityId() + &quot; to unload!!!&quot;);</span>
                } else {
                    // Unload the entity. Get the unit's transporter.
<span class="nc" id="L33073">                    Entity transporter = game</span>
<span class="nc" id="L33074">                            .getEntity(entity.getTransportId());</span>
<span class="nc" id="L33075">                    unloadUnit(transporter, entity, transporter.getPosition(),</span>
<span class="nc" id="L33076">                               transporter.getFacing(), transporter.getElevation());</span>
<span class="nc" id="L33077">                }</span>
            }

        } // Handle the next pending unload action

        // Clear the list of pending units and move to the next turn.
<span class="nc" id="L33083">        game.resetActions();</span>
<span class="nc" id="L33084">        changeToNextTurn(connId);</span>
<span class="nc" id="L33085">    }</span>

    /**
     * For all current artillery attacks in the air from this entity with this
     * weapon, clear the list of spotters. Needed because firing another round
     * before first lands voids spotting.
     *
     * @param entityID the &lt;code&gt;int&lt;/code&gt; id of the entity
     * @param weaponID the &lt;code&gt;int&lt;/code&gt; id of the weapon
     */
    private void clearArtillerySpotters(int entityID, int weaponID) {
<span class="nc bnc" id="L33096" title="All 2 branches missed.">        for (Enumeration&lt;AttackHandler&gt; i = game.getAttacks(); i.hasMoreElements(); ) {</span>
<span class="nc" id="L33097">            WeaponHandler wh = (WeaponHandler) i.nextElement();</span>
<span class="nc bnc" id="L33098" title="All 2 branches missed.">            if ((wh.waa instanceof ArtilleryAttackAction)</span>
<span class="nc bnc" id="L33099" title="All 2 branches missed.">                &amp;&amp; (wh.waa.getEntityId() == entityID)</span>
<span class="nc bnc" id="L33100" title="All 2 branches missed.">                &amp;&amp; (wh.waa.getWeaponId() == weaponID)) {</span>
<span class="nc" id="L33101">                ArtilleryAttackAction aaa = (ArtilleryAttackAction) wh.waa;</span>
<span class="nc" id="L33102">                aaa.setSpotterIds(null);</span>
            }
<span class="nc" id="L33104">        }</span>
<span class="nc" id="L33105">    }</span>

    /**
     * Credits a Kill for an entity, if the target got killed.
     *
     * @param target   The &lt;code&gt;Entity&lt;/code&gt; that got killed.
     * @param attacker The &lt;code&gt;Entity&lt;/code&gt; that did the killing.
     */
    public void creditKill(Entity target, Entity attacker) {
        // Kills should be credited for each individual fighter, instead of the
        // squadron
<span class="nc bnc" id="L33116" title="All 2 branches missed.">        if (target instanceof FighterSquadron) {</span>
<span class="nc" id="L33117">            return;</span>
        }
        // If a squadron scores a kill, assign it randomly to one of the member fighters
<span class="nc bnc" id="L33120" title="All 2 branches missed.">        if (attacker instanceof FighterSquadron) {</span>
<span class="nc" id="L33121">            Entity killer = attacker.getLoadedUnits().get(Compute.randomInt(attacker.getLoadedUnits().size()));</span>
<span class="nc bnc" id="L33122" title="All 2 branches missed.">            if (killer != null) {</span>
<span class="nc" id="L33123">                attacker = killer;</span>
            }
        }
<span class="nc bnc" id="L33126" title="All 4 branches missed.">        if ((target.isDoomed() || target.getCrew().isDoomed())</span>
<span class="nc bnc" id="L33127" title="All 4 branches missed.">            &amp;&amp; !target.getGaveKillCredit() &amp;&amp; (attacker != null)) {</span>
<span class="nc" id="L33128">            attacker.addKill(target);</span>
        }
<span class="nc" id="L33130">    }</span>

    /**
     * pre-treats a physical attack
     *
     * @param aaa The &lt;code&gt;AbstractAttackAction&lt;/code&gt; of the physical attack
     *            to pre-treat
     * @return The &lt;code&gt;PhysicalResult&lt;/code&gt; of that action, including
     * possible damage.
     */
    private PhysicalResult preTreatPhysicalAttack(AbstractAttackAction aaa) {
<span class="nc" id="L33141">        final Entity ae = game.getEntity(aaa.getEntityId());</span>
<span class="nc" id="L33142">        int damage = 0;</span>
<span class="nc" id="L33143">        PhysicalResult pr = new PhysicalResult();</span>
<span class="nc" id="L33144">        ToHitData toHit = new ToHitData();</span>
<span class="nc" id="L33145">        pr.roll = Compute.d6(2);</span>
<span class="nc" id="L33146">        pr.aaa = aaa;</span>
<span class="nc bnc" id="L33147" title="All 2 branches missed.">        if (aaa instanceof BrushOffAttackAction) {</span>
<span class="nc" id="L33148">            BrushOffAttackAction baa = (BrushOffAttackAction) aaa;</span>
<span class="nc" id="L33149">            int arm = baa.getArm();</span>
<span class="nc" id="L33150">            baa.setArm(BrushOffAttackAction.LEFT);</span>
<span class="nc" id="L33151">            toHit = BrushOffAttackAction.toHit(game, aaa.getEntityId(),</span>
<span class="nc" id="L33152">                    aaa.getTarget(game), BrushOffAttackAction.LEFT);</span>
<span class="nc" id="L33153">            baa.setArm(BrushOffAttackAction.RIGHT);</span>
<span class="nc" id="L33154">            pr.toHitRight = BrushOffAttackAction.toHit(game, aaa.getEntityId(),</span>
<span class="nc" id="L33155">                    aaa.getTarget(game), BrushOffAttackAction.RIGHT);</span>
<span class="nc" id="L33156">            damage = BrushOffAttackAction.getDamageFor(ae, BrushOffAttackAction.LEFT);</span>
<span class="nc" id="L33157">            pr.damageRight = BrushOffAttackAction.getDamageFor(ae, BrushOffAttackAction.RIGHT);</span>
<span class="nc" id="L33158">            baa.setArm(arm);</span>
<span class="nc" id="L33159">            pr.rollRight = Compute.d6(2);</span>
<span class="nc bnc" id="L33160" title="All 2 branches missed.">        } else if (aaa instanceof ChargeAttackAction) {</span>
<span class="nc" id="L33161">            ChargeAttackAction caa = (ChargeAttackAction) aaa;</span>
<span class="nc" id="L33162">            toHit = caa.toHit(game);</span>
<span class="nc bnc" id="L33163" title="All 2 branches missed.">            if (caa.getTarget(game) instanceof Entity) {</span>
<span class="nc" id="L33164">                Entity target = (Entity) caa.getTarget(game);</span>
<span class="nc" id="L33165">                damage = ChargeAttackAction.getDamageFor(ae, target,</span>
<span class="nc" id="L33166">                        game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_CHARGE_DAMAGE),</span>
<span class="nc" id="L33167">                        toHit.getMoS());</span>
<span class="nc" id="L33168">            } else {</span>
<span class="nc" id="L33169">                damage = ChargeAttackAction.getDamageFor(ae);</span>
            }
<span class="nc bnc" id="L33171" title="All 2 branches missed.">        } else if (aaa instanceof AirmechRamAttackAction) {</span>
<span class="nc" id="L33172">            AirmechRamAttackAction raa = (AirmechRamAttackAction) aaa;</span>
<span class="nc" id="L33173">            toHit = raa.toHit(game);</span>
<span class="nc" id="L33174">            damage = AirmechRamAttackAction.getDamageFor(ae);</span>
<span class="nc bnc" id="L33175" title="All 2 branches missed.">        } else if (aaa instanceof ClubAttackAction) {</span>
<span class="nc" id="L33176">            ClubAttackAction caa = (ClubAttackAction) aaa;</span>
<span class="nc" id="L33177">            toHit = caa.toHit(game);</span>
<span class="nc" id="L33178">            damage = ClubAttackAction.getDamageFor(ae, caa.getClub(),</span>
<span class="nc bnc" id="L33179" title="All 2 branches missed.">                    (caa.getTarget(game) instanceof Infantry)</span>
<span class="nc bnc" id="L33180" title="All 2 branches missed.">                    &amp;&amp; !(caa.getTarget(game) instanceof BattleArmor),</span>
<span class="nc" id="L33181">                    caa.isZweihandering());</span>
<span class="nc bnc" id="L33182" title="All 2 branches missed.">            if (caa.getTargetType() == Targetable.TYPE_BUILDING) {</span>
<span class="nc" id="L33183">                EquipmentType clubType = caa.getClub().getType();</span>
<span class="nc bnc" id="L33184" title="All 2 branches missed.">                if (clubType.hasSubType(MiscType.S_BACKHOE)</span>
<span class="nc bnc" id="L33185" title="All 2 branches missed.">                        || clubType.hasSubType(MiscType.S_CHAINSAW)</span>
<span class="nc bnc" id="L33186" title="All 2 branches missed.">                        || clubType.hasSubType(MiscType.S_MINING_DRILL)</span>
<span class="nc bnc" id="L33187" title="All 2 branches missed.">                        || clubType.hasSubType(MiscType.S_PILE_DRIVER)) {</span>
<span class="nc" id="L33188">                    damage += Compute.d6(1);</span>
<span class="nc bnc" id="L33189" title="All 2 branches missed.">                } else if (clubType.hasSubType(MiscType.S_DUAL_SAW)) {</span>
<span class="nc" id="L33190">                    damage += Compute.d6(2);</span>
<span class="nc bnc" id="L33191" title="All 2 branches missed.">                } else if (clubType.hasSubType(MiscType.S_ROCK_CUTTER)) {</span>
<span class="nc" id="L33192">                    damage += Compute.d6(3);</span>
                }
<span class="nc bnc" id="L33194" title="All 2 branches missed.">                else if (clubType.hasSubType(MiscType.S_WRECKING_BALL)) {</span>
<span class="nc" id="L33195">                    damage += Compute.d6(4);</span>
                }
            }
<span class="nc bnc" id="L33198" title="All 2 branches missed.">        } else if (aaa instanceof DfaAttackAction) {</span>
<span class="nc" id="L33199">            DfaAttackAction daa = (DfaAttackAction) aaa;</span>
<span class="nc" id="L33200">            toHit = daa.toHit(game);</span>
<span class="nc" id="L33201">            damage = DfaAttackAction.getDamageFor(ae,</span>
<span class="nc bnc" id="L33202" title="All 2 branches missed.">                    (daa.getTarget(game) instanceof Infantry)</span>
<span class="nc bnc" id="L33203" title="All 2 branches missed.">                    &amp;&amp; !(daa.getTarget(game) instanceof BattleArmor));</span>
<span class="nc bnc" id="L33204" title="All 2 branches missed.">        } else if (aaa instanceof KickAttackAction) {</span>
<span class="nc" id="L33205">            KickAttackAction kaa = (KickAttackAction) aaa;</span>
<span class="nc" id="L33206">            toHit = kaa.toHit(game);</span>
<span class="nc" id="L33207">            damage = KickAttackAction.getDamageFor(ae, kaa.getLeg(),</span>
<span class="nc bnc" id="L33208" title="All 2 branches missed.">                    (kaa.getTarget(game) instanceof Infantry)</span>
<span class="nc bnc" id="L33209" title="All 2 branches missed.">                    &amp;&amp; !(kaa.getTarget(game) instanceof BattleArmor));</span>
<span class="nc bnc" id="L33210" title="All 2 branches missed.">        } else if (aaa instanceof ProtomechPhysicalAttackAction) {</span>
<span class="nc" id="L33211">            ProtomechPhysicalAttackAction paa = (ProtomechPhysicalAttackAction) aaa;</span>
<span class="nc" id="L33212">            toHit = paa.toHit(game);</span>
<span class="nc" id="L33213">            damage = ProtomechPhysicalAttackAction.getDamageFor(ae, paa.getTarget(game));</span>
<span class="nc bnc" id="L33214" title="All 2 branches missed.">        } else if (aaa instanceof PunchAttackAction) {</span>
<span class="nc" id="L33215">            PunchAttackAction paa = (PunchAttackAction) aaa;</span>
<span class="nc" id="L33216">            int arm = paa.getArm();</span>
            int damageRight;
<span class="nc" id="L33218">            paa.setArm(PunchAttackAction.LEFT);</span>
<span class="nc" id="L33219">            toHit = paa.toHit(game);</span>
<span class="nc" id="L33220">            paa.setArm(PunchAttackAction.RIGHT);</span>
<span class="nc" id="L33221">            ToHitData toHitRight = paa.toHit(game);</span>
<span class="nc" id="L33222">            damage = PunchAttackAction.getDamageFor(ae, PunchAttackAction.LEFT,</span>
<span class="nc bnc" id="L33223" title="All 2 branches missed.">                    (paa.getTarget(game) instanceof Infantry)</span>
<span class="nc bnc" id="L33224" title="All 2 branches missed.">                    &amp;&amp; !(paa.getTarget(game) instanceof BattleArmor),</span>
<span class="nc" id="L33225">                    paa.isZweihandering());</span>
<span class="nc" id="L33226">            damageRight = PunchAttackAction.getDamageFor(ae, PunchAttackAction.RIGHT,</span>
<span class="nc bnc" id="L33227" title="All 2 branches missed.">                    (paa.getTarget(game) instanceof Infantry)</span>
<span class="nc bnc" id="L33228" title="All 2 branches missed.">                    &amp;&amp; !(paa.getTarget(game) instanceof BattleArmor),</span>
<span class="nc" id="L33229">                    paa.isZweihandering());</span>
<span class="nc" id="L33230">            paa.setArm(arm);</span>
            // If we're punching while prone (at a Tank,
            // duh), then we can only use one arm.
<span class="nc bnc" id="L33233" title="All 2 branches missed.">            if (ae.isProne()) {</span>
<span class="nc" id="L33234">                double oddsLeft = Compute.oddsAbove(toHit.getValue(),</span>
<span class="nc" id="L33235">                        ae.hasAbility(OptionsConstants.PILOT_APTITUDE_PILOTING));</span>
<span class="nc" id="L33236">                double oddsRight = Compute.oddsAbove(toHitRight.getValue(),</span>
<span class="nc" id="L33237">                        ae.hasAbility(OptionsConstants.PILOT_APTITUDE_PILOTING));</span>
                // Use the best attack.
<span class="nc bnc" id="L33239" title="All 2 branches missed.">                if ((oddsLeft * damage) &gt; (oddsRight * damageRight)) {</span>
<span class="nc" id="L33240">                    paa.setArm(PunchAttackAction.LEFT);</span>
                } else {
<span class="nc" id="L33242">                    paa.setArm(PunchAttackAction.RIGHT);</span>
                }
            }
<span class="nc" id="L33245">            pr.damageRight = damageRight;</span>
<span class="nc" id="L33246">            pr.toHitRight = toHitRight;</span>
<span class="nc" id="L33247">            pr.rollRight = Compute.d6(2);</span>
<span class="nc bnc" id="L33248" title="All 2 branches missed.">        } else if (aaa instanceof PushAttackAction) {</span>
<span class="nc" id="L33249">            PushAttackAction paa = (PushAttackAction) aaa;</span>
<span class="nc" id="L33250">            toHit = paa.toHit(game);</span>
<span class="nc bnc" id="L33251" title="All 2 branches missed.">        } else if (aaa instanceof TripAttackAction) {</span>
<span class="nc" id="L33252">            TripAttackAction paa = (TripAttackAction) aaa;</span>
<span class="nc" id="L33253">            toHit = paa.toHit(game);</span>
<span class="nc bnc" id="L33254" title="All 2 branches missed.">        } else if (aaa instanceof LayExplosivesAttackAction) {</span>
<span class="nc" id="L33255">            LayExplosivesAttackAction leaa = (LayExplosivesAttackAction) aaa;</span>
<span class="nc" id="L33256">            toHit = leaa.toHit(game);</span>
<span class="nc" id="L33257">            damage = LayExplosivesAttackAction.getDamageFor(ae);</span>
<span class="nc bnc" id="L33258" title="All 2 branches missed.">        } else if (aaa instanceof ThrashAttackAction) {</span>
<span class="nc" id="L33259">            ThrashAttackAction taa = (ThrashAttackAction) aaa;</span>
<span class="nc" id="L33260">            toHit = taa.toHit(game);</span>
<span class="nc" id="L33261">            damage = ThrashAttackAction.getDamageFor(ae);</span>
<span class="nc bnc" id="L33262" title="All 2 branches missed.">        } else if (aaa instanceof JumpJetAttackAction) {</span>
<span class="nc" id="L33263">            JumpJetAttackAction jaa = (JumpJetAttackAction) aaa;</span>
<span class="nc" id="L33264">            toHit = jaa.toHit(game);</span>
<span class="nc bnc" id="L33265" title="All 2 branches missed.">            if (jaa.getLeg() == JumpJetAttackAction.BOTH) {</span>
<span class="nc" id="L33266">                damage = JumpJetAttackAction.getDamageFor(ae, JumpJetAttackAction.LEFT);</span>
<span class="nc" id="L33267">                pr.damageRight = JumpJetAttackAction.getDamageFor(ae, JumpJetAttackAction.LEFT);</span>
            } else {
<span class="nc" id="L33269">                damage = JumpJetAttackAction.getDamageFor(ae, jaa.getLeg());</span>
<span class="nc" id="L33270">                pr.damageRight = 0;</span>
            }
<span class="nc" id="L33272">            ae.heatBuildup += (damage + pr.damageRight) / 3;</span>
<span class="nc bnc" id="L33273" title="All 2 branches missed.">        } else if (aaa instanceof GrappleAttackAction) {</span>
<span class="nc" id="L33274">            GrappleAttackAction taa = (GrappleAttackAction) aaa;</span>
<span class="nc" id="L33275">            toHit = taa.toHit(game);</span>
<span class="nc bnc" id="L33276" title="All 2 branches missed.">        } else if (aaa instanceof BreakGrappleAttackAction) {</span>
<span class="nc" id="L33277">            BreakGrappleAttackAction taa = (BreakGrappleAttackAction) aaa;</span>
<span class="nc" id="L33278">            toHit = taa.toHit(game);</span>
<span class="nc bnc" id="L33279" title="All 2 branches missed.">        } else if (aaa instanceof RamAttackAction) {</span>
<span class="nc" id="L33280">            RamAttackAction raa = (RamAttackAction) aaa;</span>
<span class="nc" id="L33281">            toHit = raa.toHit(game);</span>
<span class="nc" id="L33282">            damage = RamAttackAction.getDamageFor((IAero) ae, (Entity) aaa.getTarget(game));</span>
<span class="nc bnc" id="L33283" title="All 2 branches missed.">        } else if (aaa instanceof TeleMissileAttackAction) {</span>
<span class="nc" id="L33284">            TeleMissileAttackAction taa = (TeleMissileAttackAction) aaa;</span>
<span class="nc" id="L33285">            assignTeleMissileAMS(taa);</span>
<span class="nc" id="L33286">            taa.calcCounterAV(game, taa.getTarget(game));</span>
<span class="nc" id="L33287">            toHit = taa.toHit(game);</span>
<span class="nc" id="L33288">            damage = TeleMissileAttackAction.getDamageFor(ae);</span>
<span class="nc bnc" id="L33289" title="All 2 branches missed.">        } else if (aaa instanceof BAVibroClawAttackAction) {</span>
<span class="nc" id="L33290">            BAVibroClawAttackAction bvca = (BAVibroClawAttackAction) aaa;</span>
<span class="nc" id="L33291">            toHit = bvca.toHit(game);</span>
<span class="nc" id="L33292">            damage = BAVibroClawAttackAction.getDamageFor(ae);</span>
        }
<span class="nc" id="L33294">        pr.toHit = toHit;</span>
<span class="nc" id="L33295">        pr.damage = damage;</span>
<span class="nc" id="L33296">        return pr;</span>
    }

    /**
     * Resolve a Physical Attack
     *
     * @param pr  The &lt;code&gt;PhysicalResult&lt;/code&gt; of the physical attack
     * @param cen The &lt;code&gt;int&lt;/code&gt; Entity Id of the entity whose physical
     *            attack was last resolved
     */
    private void resolvePhysicalAttack(PhysicalResult pr, int cen) {
<span class="nc" id="L33307">        AbstractAttackAction aaa = pr.aaa;</span>
<span class="nc bnc" id="L33308" title="All 2 branches missed.">        if (aaa instanceof PunchAttackAction) {</span>
<span class="nc" id="L33309">            PunchAttackAction paa = (PunchAttackAction) aaa;</span>
<span class="nc bnc" id="L33310" title="All 2 branches missed.">            if (paa.getArm() == PunchAttackAction.BOTH) {</span>
<span class="nc" id="L33311">                paa.setArm(PunchAttackAction.LEFT);</span>
<span class="nc" id="L33312">                pr.aaa = paa;</span>
<span class="nc" id="L33313">                resolvePunchAttack(pr, cen);</span>
<span class="nc" id="L33314">                cen = paa.getEntityId();</span>
<span class="nc" id="L33315">                paa.setArm(PunchAttackAction.RIGHT);</span>
<span class="nc" id="L33316">                pr.aaa = paa;</span>
<span class="nc" id="L33317">                resolvePunchAttack(pr, cen);</span>
            } else {
<span class="nc" id="L33319">                resolvePunchAttack(pr, cen);</span>
<span class="nc" id="L33320">                cen = paa.getEntityId();</span>
            }
<span class="nc bnc" id="L33322" title="All 2 branches missed.">        } else if (aaa instanceof KickAttackAction) {</span>
<span class="nc" id="L33323">            resolveKickAttack(pr, cen);</span>
<span class="nc" id="L33324">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33325" title="All 2 branches missed.">        } else if (aaa instanceof BrushOffAttackAction) {</span>
<span class="nc" id="L33326">            BrushOffAttackAction baa = (BrushOffAttackAction) aaa;</span>
<span class="nc bnc" id="L33327" title="All 2 branches missed.">            if (baa.getArm() == BrushOffAttackAction.BOTH) {</span>
<span class="nc" id="L33328">                baa.setArm(BrushOffAttackAction.LEFT);</span>
<span class="nc" id="L33329">                pr.aaa = baa;</span>
<span class="nc" id="L33330">                resolveBrushOffAttack(pr, cen);</span>
<span class="nc" id="L33331">                cen = baa.getEntityId();</span>
<span class="nc" id="L33332">                baa.setArm(BrushOffAttackAction.RIGHT);</span>
<span class="nc" id="L33333">                pr.aaa = baa;</span>
<span class="nc" id="L33334">                resolveBrushOffAttack(pr, cen);</span>
            } else {
<span class="nc" id="L33336">                resolveBrushOffAttack(pr, cen);</span>
<span class="nc" id="L33337">                cen = baa.getEntityId();</span>
            }
<span class="nc bnc" id="L33339" title="All 2 branches missed.">        } else if (aaa instanceof ThrashAttackAction) {</span>
<span class="nc" id="L33340">            resolveThrashAttack(pr, cen);</span>
<span class="nc" id="L33341">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33342" title="All 2 branches missed.">        } else if (aaa instanceof ProtomechPhysicalAttackAction) {</span>
<span class="nc" id="L33343">            resolveProtoAttack(pr, cen);</span>
<span class="nc" id="L33344">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33345" title="All 2 branches missed.">        } else if (aaa instanceof ClubAttackAction) {</span>
<span class="nc" id="L33346">            resolveClubAttack(pr, cen);</span>
<span class="nc" id="L33347">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33348" title="All 2 branches missed.">        } else if (aaa instanceof PushAttackAction) {</span>
<span class="nc" id="L33349">            resolvePushAttack(pr, cen);</span>
<span class="nc" id="L33350">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33351" title="All 2 branches missed.">        } else if (aaa instanceof ChargeAttackAction) {</span>
<span class="nc" id="L33352">            resolveChargeAttack(pr, cen);</span>
<span class="nc" id="L33353">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33354" title="All 2 branches missed.">        } else if (aaa instanceof AirmechRamAttackAction) {</span>
<span class="nc" id="L33355">            resolveAirmechRamAttack(pr, cen);</span>
<span class="nc" id="L33356">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33357" title="All 2 branches missed.">        } else if (aaa instanceof DfaAttackAction) {</span>
<span class="nc" id="L33358">            resolveDfaAttack(pr, cen);</span>
<span class="nc" id="L33359">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33360" title="All 2 branches missed.">        } else if (aaa instanceof LayExplosivesAttackAction) {</span>
<span class="nc" id="L33361">            resolveLayExplosivesAttack(pr);</span>
<span class="nc" id="L33362">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33363" title="All 2 branches missed.">        } else if (aaa instanceof TripAttackAction) {</span>
<span class="nc" id="L33364">            resolveTripAttack(pr, cen);</span>
<span class="nc" id="L33365">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33366" title="All 2 branches missed.">        } else if (aaa instanceof JumpJetAttackAction) {</span>
<span class="nc" id="L33367">            resolveJumpJetAttack(pr, cen);</span>
<span class="nc" id="L33368">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33369" title="All 2 branches missed.">        } else if (aaa instanceof GrappleAttackAction) {</span>
<span class="nc" id="L33370">            resolveGrappleAttack(pr, cen);</span>
<span class="nc" id="L33371">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33372" title="All 2 branches missed.">        } else if (aaa instanceof BreakGrappleAttackAction) {</span>
<span class="nc" id="L33373">            resolveBreakGrappleAttack(pr, cen);</span>
<span class="nc" id="L33374">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33375" title="All 2 branches missed.">        } else if (aaa instanceof RamAttackAction) {</span>
<span class="nc" id="L33376">            resolveRamAttack(pr, cen);</span>
<span class="nc" id="L33377">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33378" title="All 2 branches missed.">        } else if (aaa instanceof TeleMissileAttackAction) {</span>
<span class="nc" id="L33379">            resolveTeleMissileAttack(pr, cen);</span>
<span class="nc" id="L33380">            cen = aaa.getEntityId();</span>
<span class="nc bnc" id="L33381" title="All 2 branches missed.">        } else if (aaa instanceof BAVibroClawAttackAction) {</span>
<span class="nc" id="L33382">            resolveBAVibroClawAttack(pr, cen);</span>
<span class="nc" id="L33383">            cen = aaa.getEntityId();</span>
        } else {
<span class="nc" id="L33385">            MegaMek.getLogger().error(&quot;Unknown attack action declared.&quot;);</span>
        }
        // Not all targets are Entities.
<span class="nc" id="L33388">        Targetable target = game.getTarget(aaa.getTargetType(), aaa.getTargetId());</span>
<span class="nc bnc" id="L33389" title="All 2 branches missed.">        if (target instanceof Entity) {</span>
<span class="nc" id="L33390">            Entity targetEntity = (Entity) target;</span>
<span class="nc" id="L33391">            targetEntity.setStruck(true);</span>
<span class="nc" id="L33392">            targetEntity.addAttackedByThisTurn(target.getTargetId());</span>
<span class="nc" id="L33393">            creditKill(targetEntity, game.getEntity(cen));</span>
        }
<span class="nc" id="L33395">    }</span>

    /**
     * Add any extreme gravity PSRs the entity gets due to its movement
     *
     * @param entity
     *            The &lt;code&gt;Entity&lt;/code&gt; to check.
     * @param step
     *            The last &lt;code&gt;MoveStep&lt;/code&gt; of this entity
     * @param moveType
     *            The movement type for the MovePath the supplied MoveStep comes
     *            from. This generally comes from the last step in the move
     *            path.
     * @param curPos
     *            The current &lt;code&gt;Coords&lt;/code&gt; of this entity
     * @param cachedMaxMPExpenditure
     *            Server checks run/jump MP at start of move, as appropriate,
     *            caches to avoid mid-move change in MP causing erroneous grav
     *            check
     */
    private void checkExtremeGravityMovement(Entity entity, MoveStep step,
                                             EntityMovementType moveType, Coords curPos,
                                             int cachedMaxMPExpenditure) {
        PilotingRollData rollTarget;
<span class="nc bnc" id="L33419" title="All 2 branches missed.">        if (game.getPlanetaryConditions().getGravity() != 1) {</span>
<span class="nc bnc" id="L33420" title="All 4 branches missed.">            if ((entity instanceof Mech) || (entity instanceof Tank)) {</span>
<span class="nc bnc" id="L33421" title="All 12 branches missed.">                if ((moveType == EntityMovementType.MOVE_WALK)</span>
                        || (moveType == EntityMovementType.MOVE_VTOL_WALK)
                        || (moveType == EntityMovementType.MOVE_RUN)
                        || (moveType == EntityMovementType.MOVE_SPRINT)
                        || (moveType == EntityMovementType.MOVE_VTOL_RUN)
                        || (moveType == EntityMovementType.MOVE_VTOL_SPRINT)) {
<span class="nc" id="L33427">                    int limit = cachedMaxMPExpenditure;</span>
<span class="nc bnc" id="L33428" title="All 4 branches missed.">                    if (step.isOnlyPavement() &amp;&amp; entity.isEligibleForPavementBonus()) {</span>
<span class="nc" id="L33429">                        limit++;</span>
                    }
<span class="nc bnc" id="L33431" title="All 2 branches missed.">                    if (step.getMpUsed() &gt; limit) {</span>
                        // We moved too fast, let's make PSR to see if we get
                        // damage
<span class="nc" id="L33434">                        game.addExtremeGravityPSR(entity.checkMovedTooFast(</span>
                                step, moveType));
                    }
<span class="nc bnc" id="L33437" title="All 2 branches missed.">                } else if (moveType == EntityMovementType.MOVE_JUMP) {</span>
<span class="nc" id="L33438">                    MegaMek.getLogger().debug(&quot;Gravity move check jump: &quot; </span>
<span class="nc" id="L33439">                            + step.getMpUsed() + &quot;/&quot; + cachedMaxMPExpenditure);</span>
<span class="nc" id="L33440">                    int origWalkMP = entity.getWalkMP(false, false);</span>
<span class="nc" id="L33441">                    int gravWalkMP = entity.getWalkMP();</span>
<span class="nc bnc" id="L33442" title="All 2 branches missed.">                    if (step.getMpUsed() &gt; cachedMaxMPExpenditure) {</span>
                        // Jumped too far, make PSR to see if we get damaged
<span class="nc" id="L33444">                        game.addExtremeGravityPSR(entity.checkMovedTooFast(</span>
                                step, moveType));
<span class="nc bnc" id="L33446" title="All 4 branches missed.">                    } else if ((game.getPlanetaryConditions().getGravity() &gt; 1)</span>
                            &amp;&amp; ((origWalkMP - gravWalkMP) &gt; 0)) {
                        // jumping in high g is bad for your legs
                        // Damage dealt = 1 pt for each MP lost due to gravity
                        // Ignore this if no damage would be dealt
<span class="nc" id="L33451">                        rollTarget = entity.getBasePilotingRoll(moveType);</span>
<span class="nc" id="L33452">                        entity.addPilotingModifierForTerrain(rollTarget, step);</span>
<span class="nc" id="L33453">                        int gravMod = game.getPlanetaryConditions()</span>
<span class="nc" id="L33454">                                .getGravityPilotPenalty();</span>
<span class="nc bnc" id="L33455" title="All 4 branches missed.">                        if ((gravMod != 0) &amp;&amp; !game.getBoard().inSpace()) {</span>
<span class="nc" id="L33456">                            rollTarget.addModifier(gravMod, game</span>
<span class="nc" id="L33457">                                    .getPlanetaryConditions().getGravity()</span>
                                    + &quot;G gravity&quot;);
                        }
<span class="nc" id="L33460">                        rollTarget.append(new PilotingRollData(entity.getId(),</span>
                                0, &quot;jumped in high gravity&quot;));
<span class="nc" id="L33462">                        game.addExtremeGravityPSR(rollTarget);</span>
                    }
                }
            }
        }
<span class="nc" id="L33467">    }</span>

    /**
     * Damage the inner structure of a mech's leg / a tank's front. This only
     * happens when the Entity fails an extreme Gravity PSR.
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; to damage.
     * @param damage The &lt;code&gt;int&lt;/code&gt; amount of damage.
     */
    private Vector&lt;Report&gt; doExtremeGravityDamage(Entity entity, int damage) {
<span class="nc" id="L33477">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
        HitData hit;
<span class="nc bnc" id="L33479" title="All 2 branches missed.">        if (entity instanceof BipedMech) {</span>
<span class="nc bnc" id="L33480" title="All 2 branches missed.">            for (int i = 6; i &lt;= 7; i++) {</span>
<span class="nc" id="L33481">                hit = new HitData(i);</span>
<span class="nc" id="L33482">                vPhaseReport.addAll(damageEntity(entity, hit, damage, false,</span>
                        DamageType.NONE, true));
            }
        }
<span class="nc bnc" id="L33486" title="All 2 branches missed.">        if (entity instanceof QuadMech) {</span>
<span class="nc bnc" id="L33487" title="All 2 branches missed.">            for (int i = 4; i &lt;= 7; i++) {</span>
<span class="nc" id="L33488">                hit = new HitData(i);</span>
<span class="nc" id="L33489">                vPhaseReport.addAll(damageEntity(entity, hit, damage, false,</span>
                        DamageType.NONE, true));
            }
<span class="nc bnc" id="L33492" title="All 2 branches missed.">        } else if (entity instanceof Tank) {</span>
<span class="nc" id="L33493">            hit = new HitData(Tank.LOC_FRONT);</span>
<span class="nc" id="L33494">            vPhaseReport.addAll(damageEntity(entity, hit, damage, false,</span>
                    DamageType.NONE, true));
<span class="nc" id="L33496">            vPhaseReport.addAll(vehicleMotiveDamage((Tank)entity, 0));</span>
        }
<span class="nc" id="L33498">        return vPhaseReport;</span>
    }

    /**
     * Eject an Entity.
     *
     * @param entity    The &lt;code&gt;Entity&lt;/code&gt; to eject.
     * @param autoEject The &lt;code&gt;boolean&lt;/code&gt; state of the entity's auto- ejection
     *                  system
     * @return a &lt;code&gt;Vector&lt;/code&gt; of report objects for the game log.
     */
    public Vector&lt;Report&gt; ejectEntity(Entity entity, boolean autoEject) {
<span class="nc" id="L33510">        return ejectEntity(entity, autoEject, false);</span>
    }

    /**
     * Eject an Entity.
     *
     * @param entity            The &lt;code&gt;Entity&lt;/code&gt; to eject.
     * @param autoEject         The &lt;code&gt;boolean&lt;/code&gt; state of the entity's auto- ejection
     *                          system
     * @param skin_of_the_teeth Perform a skin of the teeth ejection
     * @return a &lt;code&gt;Vector&lt;/code&gt; of report objects for the game log.
     */
    public Vector&lt;Report&gt; ejectEntity(Entity entity, boolean autoEject,
                                      boolean skin_of_the_teeth) {
<span class="nc" id="L33524">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

        // An entity can only eject it's crew once.
<span class="nc bnc" id="L33528" title="All 2 branches missed.">        if (entity.getCrew().isEjected()) {</span>
<span class="nc" id="L33529">            return vDesc;</span>
        }

        // If the crew are already dead, don't bother
<span class="nc bnc" id="L33533" title="All 2 branches missed.">        if (entity.isCarcass()) {</span>
<span class="nc" id="L33534">            return vDesc;</span>
        }

        // Mek and fighter pilots may get hurt during ejection,
        // and run around the board afterwards.
<span class="nc bnc" id="L33539" title="All 4 branches missed.">        if (entity instanceof Mech || entity.isFighter()) {</span>
<span class="nc" id="L33540">            int facing = entity.getFacing();</span>
<span class="nc bnc" id="L33541" title="All 2 branches missed.">            Coords targetCoords = (null != entity.getPosition())</span>
<span class="nc" id="L33542">                ? entity.getPosition().translated((facing + 3) % 6) : null;</span>
<span class="nc bnc" id="L33543" title="All 4 branches missed.">            if (entity.isSpaceborne() &amp;&amp; entity.getPosition() != null) {</span>
                //Pilots in space should eject into the fighter's hex, not behind it
<span class="nc" id="L33545">                targetCoords = entity.getPosition();</span>
            }

<span class="nc bnc" id="L33548" title="All 2 branches missed.">            if (autoEject) {</span>
<span class="nc" id="L33549">                r = new Report(6395);</span>
<span class="nc" id="L33550">                r.subject = entity.getId();</span>
<span class="nc" id="L33551">                r.addDesc(entity);</span>
<span class="nc" id="L33552">                r.indent(2);</span>
<span class="nc" id="L33553">                vDesc.addElement(r);</span>
            }

            // okay, print the info
<span class="nc" id="L33557">            PilotingRollData rollTarget = getEjectModifiers(game, entity,</span>
<span class="nc" id="L33558">                    entity.getCrew().getCurrentPilotIndex(), autoEject);</span>
<span class="nc" id="L33559">            r = new Report(2180);</span>
<span class="nc" id="L33560">            r.subject = entity.getId();</span>
<span class="nc" id="L33561">            r.addDesc(entity);</span>
<span class="nc" id="L33562">            r.add(rollTarget.getLastPlainDesc(), true);</span>
<span class="nc" id="L33563">            r.indent();</span>
<span class="nc" id="L33564">            vDesc.addElement(r);</span>
<span class="nc bnc" id="L33565" title="All 2 branches missed.">            for (int crewPos = 0; crewPos &lt; entity.getCrew().getSlotCount(); crewPos++) {</span>
<span class="nc bnc" id="L33566" title="All 2 branches missed.">                if (entity.getCrew().isMissing(crewPos)) {</span>
<span class="nc" id="L33567">                    continue;</span>
                }
<span class="nc" id="L33569">                rollTarget = getEjectModifiers(game, entity, crewPos,</span>
                        autoEject);
                // roll
<span class="nc" id="L33572">                final int diceRoll = entity.getCrew().rollPilotingSkill();</span>
<span class="nc bnc" id="L33573" title="All 2 branches missed.">                if (entity.getCrew().getSlotCount() &gt; 1) {</span>
<span class="nc" id="L33574">                    r = new Report(2193);</span>
<span class="nc" id="L33575">                    r.add(entity.getCrew().getNameAndRole(crewPos));</span>
                } else {
<span class="nc" id="L33577">                    r = new Report(2190);</span>
                }
<span class="nc" id="L33579">                r.subject = entity.getId();</span>
<span class="nc" id="L33580">                r.add(rollTarget.getValueAsString());</span>
<span class="nc" id="L33581">                r.add(rollTarget.getDesc());</span>
<span class="nc" id="L33582">                r.add(diceRoll);</span>
<span class="nc" id="L33583">                r.indent();</span>
<span class="nc bnc" id="L33584" title="All 2 branches missed.">                if (diceRoll &lt; rollTarget.getValue()) {</span>
<span class="nc" id="L33585">                    r.choose(false);</span>
<span class="nc" id="L33586">                    vDesc.addElement(r);</span>
<span class="nc" id="L33587">                    Report.addNewline(vDesc);</span>
<span class="nc bnc" id="L33588" title="All 2 branches missed.">                    if ((rollTarget.getValue() - diceRoll) &gt; 1) {</span>
                        // Pilots take damage based on ejection roll MoF
<span class="nc" id="L33590">                        int damage = (rollTarget.getValue() - diceRoll);</span>
<span class="nc bnc" id="L33591" title="All 2 branches missed.">                        if (entity instanceof Mech) {</span>
                            // MechWarriors only take 1 damage per 2 points of MoF
<span class="nc" id="L33593">                            damage /= 2;</span>
                        }
<span class="nc bnc" id="L33595" title="All 2 branches missed.">                        if (entity.hasQuirk(OptionsConstants.QUIRK_NEG_DIFFICULT_EJECT)) {</span>
<span class="nc" id="L33596">                            damage++;</span>
                        }
<span class="nc" id="L33598">                        vDesc.addAll(damageCrew(entity, damage, crewPos));</span>
                    }

                    // If this is a skin of the teeth ejection...
<span class="nc bnc" id="L33602" title="All 4 branches missed.">                    if (skin_of_the_teeth &amp;&amp; (entity.getCrew().getHits(crewPos) &lt; 6)) {</span>
<span class="nc" id="L33603">                        Report.addNewline(vDesc);</span>
<span class="nc" id="L33604">                        vDesc.addAll(damageCrew(entity, 6 - entity.getCrew()</span>
<span class="nc" id="L33605">                                                                .getHits(crewPos)));</span>
                    }
                } else {
<span class="nc" id="L33608">                    r.choose(true);</span>
<span class="nc" id="L33609">                    vDesc.addElement(r);</span>
                }
            }
            // create the MechWarrior in any case, for campaign tracking
<span class="nc" id="L33613">            MechWarrior pilot = new MechWarrior(entity);</span>
<span class="nc" id="L33614">            pilot.setDeployed(true);</span>
<span class="nc" id="L33615">            pilot.setId(getFreeEntityId());</span>
<span class="nc" id="L33616">            pilot.setLanded(false);</span>
<span class="nc bnc" id="L33617" title="All 2 branches missed.">            if (entity.isSpaceborne()) {</span>
                //In space, ejected pilots retain the heading and velocity of the unit they eject from
<span class="nc" id="L33619">                pilot.setVectors(entity.getVectors());</span>
<span class="nc" id="L33620">                pilot.setFacing(entity.getFacing());</span>
<span class="nc" id="L33621">                pilot.setCurrentVelocity(entity.getVelocity());</span>
                //If the pilot ejects, he should no longer be accelerating
<span class="nc" id="L33623">                pilot.setNextVelocity(entity.getVelocity());</span>
<span class="nc bnc" id="L33624" title="All 2 branches missed.">            } else if (entity.isAirborne()) {</span>
<span class="nc" id="L33625">                pilot.setAltitude(entity.getAltitude());</span>
            }
            //Pilot flight suits are vacuum-rated. MechWarriors wear shorts...
<span class="nc" id="L33628">            pilot.setSpaceSuit(entity.isAero());</span>
<span class="nc" id="L33629">            game.addEntity(pilot);</span>
<span class="nc" id="L33630">            send(createAddEntityPacket(pilot.getId()));</span>
            // make him not get a move this turn
<span class="nc" id="L33632">            pilot.setDone(true);</span>
<span class="nc" id="L33633">            int living = 0;</span>
<span class="nc bnc" id="L33634" title="All 2 branches missed.">            for (int i = 0; i &lt; entity.getCrew().getSlotCount(); i++) {</span>
<span class="nc bnc" id="L33635" title="All 4 branches missed.">                if (!entity.getCrew().isDead(i) &amp;&amp; entity.getCrew().getHits(i) &lt; Crew.DEATH) {</span>
<span class="nc" id="L33636">                    living++;</span>
                }
            }
<span class="nc" id="L33639">            pilot.setInternal(living, MechWarrior.LOC_INFANTRY);</span>
<span class="nc bnc" id="L33640" title="All 4 branches missed.">            if (entity.getCrew().isDead() || entity.getCrew().getHits() &gt;= Crew.DEATH) {</span>
<span class="nc" id="L33641">                pilot.setDoomed(true);</span>
            }

<span class="nc bnc" id="L33644" title="All 2 branches missed.">            if (entity.getCrew().isDoomed()) {</span>
<span class="nc" id="L33645">                vDesc.addAll(destroyEntity(pilot, &quot;deadly ejection&quot;, false,</span>
                                           false));
            } else {
                // Add the pilot as an infantry unit on the battlefield.
<span class="nc bnc" id="L33649" title="All 2 branches missed.">                if (game.getBoard().contains(targetCoords)) {</span>
<span class="nc" id="L33650">                    pilot.setPosition(targetCoords);</span>
                    // report safe ejection
<span class="nc" id="L33652">                    r = new Report(6400);</span>
<span class="nc" id="L33653">                    r.subject = entity.getId();</span>
<span class="nc" id="L33654">                    r.indent(3);</span>
<span class="nc" id="L33655">                    vDesc.addElement(r);</span>
                    // Update the entity
<span class="nc" id="L33657">                    entityUpdate(pilot.getId());</span>
                    // check if the pilot lands in a minefield
<span class="nc bnc" id="L33659" title="All 2 branches missed.">                    if (!entity.isAirborne()) {</span>
<span class="nc" id="L33660">                        vDesc.addAll(doEntityDisplacementMinefieldCheck(pilot,</span>
<span class="nc" id="L33661">                                entity.getPosition(), targetCoords,</span>
<span class="nc" id="L33662">                                entity.getElevation()));</span>
                    }
                } else {
                    // ejects safely
<span class="nc" id="L33666">                    r = new Report(6410);</span>
<span class="nc" id="L33667">                    r.subject = entity.getId();</span>
<span class="nc" id="L33668">                    r.indent(3);</span>
<span class="nc" id="L33669">                    vDesc.addElement(r);</span>
<span class="nc" id="L33670">                    game.removeEntity(pilot.getId(),</span>
                                      IEntityRemovalConditions.REMOVE_IN_RETREAT);
<span class="nc" id="L33672">                    send(createRemoveEntityPacket(pilot.getId(),</span>
                                                  IEntityRemovalConditions.REMOVE_IN_RETREAT));
                    // }
                }
<span class="nc bnc" id="L33676" title="All 2 branches missed.">                if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_EJECTED_PILOTS_FLEE)</span>
                        // Don't create a pilot entity on low-atmospheric maps
<span class="nc bnc" id="L33678" title="All 2 branches missed.">                        || game.getBoard().inAtmosphere()) {</span>
<span class="nc" id="L33679">                    game.removeEntity(pilot.getId(),</span>
                                      IEntityRemovalConditions.REMOVE_IN_RETREAT);
<span class="nc" id="L33681">                    send(createRemoveEntityPacket(pilot.getId(),</span>
                                                  IEntityRemovalConditions.REMOVE_IN_RETREAT));
                }

                // If this is a skin of the teeth ejection...
<span class="nc bnc" id="L33686" title="All 4 branches missed.">                if (skin_of_the_teeth &amp;&amp; (pilot.getCrew().getHits() &lt; 5)) {</span>
<span class="nc" id="L33687">                    Report.addNewline(vDesc);</span>
<span class="nc" id="L33688">                    vDesc.addAll(damageCrew(pilot, 5 - pilot.getCrew()</span>
<span class="nc" id="L33689">                                                            .getHits()));</span>
                }
            } // Crew safely ejects.

            // ejection damages the cockpit
            // kind of irrelevant in stand-alone games, but important for MekHQ
<span class="nc bnc" id="L33695" title="All 2 branches missed.">            if (entity instanceof Mech) {</span>
<span class="nc" id="L33696">                Mech mech = (Mech) entity;</span>
                // in case of mechs with 'full head ejection', the head is treated as blown off
<span class="nc bnc" id="L33698" title="All 2 branches missed.">                if (mech.hasFullHeadEject()) {</span>
<span class="nc" id="L33699">                    entity.destroyLocation(Mech.LOC_HEAD, true);</span>
                } else {
<span class="nc bnc" id="L33701" title="All 2 branches missed.">                    for (CriticalSlot slot : (mech.getCockpit())) {</span>
<span class="nc" id="L33702">                        slot.setDestroyed(true);</span>
<span class="nc" id="L33703">                    }</span>
                }
            }            
<span class="nc" id="L33706">        } // End entity-is-Mek or fighter</span>
<span class="nc bnc" id="L33707" title="All 4 branches missed.">        else if (game.getBoard().contains(entity.getPosition())</span>
                 &amp;&amp; (entity instanceof Tank)) {
<span class="nc" id="L33709">            EjectedCrew crew = new EjectedCrew(entity);</span>
            // Need to set game manually; since game.addEntity not called yet
            // Don't want to do this yet, as Entity may not be added
<span class="nc" id="L33712">            crew.setGame(game);</span>
<span class="nc" id="L33713">            crew.setDeployed(true);</span>
<span class="nc" id="L33714">            crew.setId(getFreeEntityId());</span>
            // Make them not get a move this turn
<span class="nc" id="L33716">            crew.setDone(true);</span>
            // Place on board
            // Vehicles don't have ejection systems, so crew must abandon into
            // a legal hex
<span class="nc" id="L33720">            Coords legalPosition = null;</span>
<span class="nc bnc" id="L33721" title="All 2 branches missed.">            if (!crew.isLocationProhibited(entity.getPosition())) {</span>
<span class="nc" id="L33722">                legalPosition = entity.getPosition();</span>
            } else {
<span class="nc bnc" id="L33724" title="All 4 branches missed.">                for (int dir = 0; (dir &lt; 6) &amp;&amp; (legalPosition == null); dir++) {</span>
<span class="nc" id="L33725">                    Coords adjCoords = entity.getPosition().translated(dir);</span>
<span class="nc bnc" id="L33726" title="All 2 branches missed.">                    if (!crew.isLocationProhibited(adjCoords)) {</span>
<span class="nc" id="L33727">                        legalPosition = adjCoords;</span>
                    }
                }
            }
            // Cannot abandon if there is no legal hex. This shouldn't have been allowed
<span class="nc bnc" id="L33732" title="All 2 branches missed.">            if (legalPosition == null) {</span>
<span class="nc" id="L33733">                MegaMek.getLogger().error(&quot;Vehicle crews cannot abandon if there is no legal hex!&quot;);</span>
<span class="nc" id="L33734">                return vDesc;</span>
            }
<span class="nc" id="L33736">            crew.setPosition(legalPosition);</span>
            // Add Entity to game
<span class="nc" id="L33738">            game.addEntity(crew);</span>
            // Tell clients about new entity
<span class="nc" id="L33740">            send(createAddEntityPacket(crew.getId()));</span>
            // Sent entity info to clients
<span class="nc" id="L33742">            entityUpdate(crew.getId());</span>
            // Check if the crew lands in a minefield
<span class="nc" id="L33744">            vDesc.addAll(doEntityDisplacementMinefieldCheck(crew,</span>
<span class="nc" id="L33745">                    entity.getPosition(), entity.getPosition(),</span>
<span class="nc" id="L33746">                    entity.getElevation()));</span>
<span class="nc bnc" id="L33747" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_EJECTED_PILOTS_FLEE)) {</span>
<span class="nc" id="L33748">                game.removeEntity(crew.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT);</span>
<span class="nc" id="L33749">                send(createRemoveEntityPacket(crew.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT));</span>
            }
        } //End ground vehicles

        // Mark the entity's crew as &quot;ejected&quot;.
<span class="nc" id="L33754">        entity.getCrew().setEjected(true);</span>
<span class="nc bnc" id="L33755" title="All 2 branches missed.">        if (entity instanceof VTOL) {</span>
<span class="nc" id="L33756">            vDesc.addAll(crashVTOLorWiGE((VTOL) entity));</span>
        }
<span class="nc" id="L33758">        vDesc.addAll(destroyEntity(entity, &quot;ejection&quot;, true, true));</span>

        // only remove the unit that ejected manually
<span class="nc bnc" id="L33761" title="All 2 branches missed.">        if (!autoEject) {</span>
<span class="nc" id="L33762">            game.removeEntity(entity.getId(),</span>
                    IEntityRemovalConditions.REMOVE_EJECTED);
<span class="nc" id="L33764">            send(createRemoveEntityPacket(entity.getId(),</span>
                    IEntityRemovalConditions.REMOVE_EJECTED));
        }
<span class="nc" id="L33767">        return vDesc;</span>
    }
    
    /**
     * Abandon a spacecraft (large or small).
     *
     * @param entity  The &lt;code&gt;Aero&lt;/code&gt; to eject.
     * @param inSpace Is this ship spaceborne?
     * @param airborne Is this ship in atmospheric flight?
     * @param pos The coords of this ejection. Needed when abandoning a grounded ship
     * @return a &lt;code&gt;Vector&lt;/code&gt; of report objects for the gamelog.
     */
    public Vector&lt;Report&gt; ejectSpacecraft(Aero entity, boolean inSpace, boolean airborne, Coords pos) {
<span class="nc" id="L33780">        Vector&lt;Report&gt; vDesc = new Vector&lt;Report&gt;();</span>
        Report r;

        // An entity can only eject it's crew once.
<span class="nc bnc" id="L33784" title="All 2 branches missed.">        if (entity.getCrew().isEjected()) {</span>
<span class="nc" id="L33785">            return vDesc;</span>
        }

        // If the crew are already dead, don't bother
<span class="nc bnc" id="L33789" title="All 2 branches missed.">        if (entity.isCarcass()) {</span>
<span class="nc" id="L33790">            return vDesc;</span>
        }

        // Try to launch some escape pods and lifeboats, if any are left
<span class="nc bnc" id="L33794" title="All 8 branches missed.">        if ((inSpace &amp;&amp; (entity.getPodsLeft() &gt; 0 || entity.getLifeBoatsLeft() &gt; 0))</span>
<span class="nc bnc" id="L33795" title="All 2 branches missed.">                || (airborne &amp;&amp; entity.getPodsLeft() &gt; 0)) {</span>
            // Report the ejection
<span class="nc" id="L33797">            PilotingRollData rollTarget = getEjectModifiers(game, entity,</span>
<span class="nc" id="L33798">                    entity.getCrew().getCurrentPilotIndex(), false);</span>
<span class="nc" id="L33799">            r = new Report(2180);</span>
<span class="nc" id="L33800">            r.subject = entity.getId();</span>
<span class="nc" id="L33801">            r.addDesc(entity);</span>
<span class="nc" id="L33802">            r.add(rollTarget.getLastPlainDesc(), true);</span>
<span class="nc" id="L33803">            r.indent();</span>
<span class="nc" id="L33804">            vDesc.addElement(r);</span>
<span class="nc" id="L33805">            int roll = Compute.d6(2);</span>
<span class="nc" id="L33806">            int MOS = (roll - Math.max(2, rollTarget.getValue()));</span>
            //Report the roll
<span class="nc" id="L33808">            r = new Report(2190);</span>
<span class="nc" id="L33809">            r.subject = entity.getId();</span>
<span class="nc" id="L33810">            r.add(rollTarget.getValueAsString());</span>
<span class="nc" id="L33811">            r.add(rollTarget.getDesc());</span>
<span class="nc" id="L33812">            r.add(roll);</span>
<span class="nc" id="L33813">            r.indent();</span>
<span class="nc bnc" id="L33814" title="All 2 branches missed.">            r.choose(roll &gt;= rollTarget.getValue());</span>
<span class="nc" id="L33815">            vDesc.addElement(r);</span>
            //Per SO p27, you get a certain number of escape pods away per turn per 100k tons of ship
<span class="nc" id="L33817">            int escapeMultiplier = (int) (entity.getWeight() / 100000);</span>
            //Set up the maximum number that CAN launch
<span class="nc" id="L33819">            int toLaunch = 0;</span>
<span class="nc bnc" id="L33820" title="All 2 branches missed.">            if (roll &lt; rollTarget.getValue()) {</span>
<span class="nc" id="L33821">                toLaunch = 1;</span>
            } else {
<span class="nc" id="L33823">                toLaunch = (1 + MOS) * Math.max(1, escapeMultiplier);</span>
            }
            //And now modify it based on what the unit actually has TO launch
<span class="nc" id="L33826">            int launchCounter = toLaunch;</span>
<span class="nc" id="L33827">            int totalLaunched = 0;</span>
<span class="nc" id="L33828">            boolean isPod = false;</span>
<span class="nc bnc" id="L33829" title="All 2 branches missed.">            while (launchCounter &gt; 0) {</span>
<span class="nc" id="L33830">                int launched = 0;</span>
<span class="nc bnc" id="L33831" title="All 6 branches missed.">                if (entity.getPodsLeft() &gt; 0 &amp;&amp; (airborne || entity.getPodsLeft() &gt;= entity.getLifeBoatsLeft())) {</span>
                    //Entity has more escape pods than lifeboats (or equal numbers)
<span class="nc" id="L33833">                    launched = Math.min(launchCounter, entity.getPodsLeft());</span>
<span class="nc" id="L33834">                    entity.setLaunchedEscapePods(entity.getLaunchedEscapePods() + launched);</span>
<span class="nc" id="L33835">                    totalLaunched += launched;</span>
<span class="nc" id="L33836">                    launchCounter -= launched;</span>
<span class="nc" id="L33837">                    isPod = true;</span>
<span class="nc bnc" id="L33838" title="All 6 branches missed.">                } else if (inSpace &amp;&amp; entity.getLifeBoatsLeft() &gt; 0 &amp;&amp; (entity.getLifeBoatsLeft() &gt; entity.getPodsLeft())) {</span>
                    //Entity has more lifeboats left
<span class="nc" id="L33840">                    launched = Math.min(launchCounter, entity.getLifeBoatsLeft());</span>
<span class="nc" id="L33841">                    entity.setLaunchedLifeBoats(entity.getLaunchedLifeBoats() + launched);</span>
<span class="nc" id="L33842">                    totalLaunched += launched;</span>
<span class="nc" id="L33843">                    launchCounter -= launched;</span>
                } else {
                    //We've run out of both. End the loop
                    break;
                }
<span class="nc" id="L33848">            }</span>
<span class="nc" id="L33849">            int nEscaped = Math.min((entity.getCrew().getCurrentSize() + entity.getNPassenger()), (totalLaunched * 6));</span>
            //Report how many pods launched and how many escaped
<span class="nc bnc" id="L33851" title="All 2 branches missed.">            if (totalLaunched &gt; 0) {</span>
<span class="nc" id="L33852">                r = new Report(6401);</span>
<span class="nc" id="L33853">                r.subject = entity.getId();</span>
<span class="nc" id="L33854">                r.indent();</span>
<span class="nc" id="L33855">                r.add(totalLaunched);</span>
<span class="nc" id="L33856">                r.add(nEscaped);</span>
<span class="nc" id="L33857">                vDesc.addElement(r);</span>
            }
<span class="nc" id="L33859">            EscapePods pods = new EscapePods(entity,totalLaunched,isPod);</span>
<span class="nc" id="L33860">            entity.addEscapeCraft(pods.getExternalIdAsString());</span>
            //Update the personnel numbers
            
            //If there are passengers aboard, get them out first
<span class="nc bnc" id="L33864" title="All 2 branches missed.">            if (entity.getNPassenger() &gt; 0) {</span>
<span class="nc" id="L33865">                int change = Math.min(entity.getNPassenger(), nEscaped);</span>
<span class="nc" id="L33866">                entity.setNPassenger(Math.max(entity.getNPassenger() - nEscaped, 0));</span>
<span class="nc" id="L33867">                pods.addPassengers(entity.getExternalIdAsString(), change);</span>
<span class="nc" id="L33868">                nEscaped -= change;</span>
            }
            //Now get the crew out with such space as is left
<span class="nc bnc" id="L33871" title="All 2 branches missed.">            if (nEscaped &gt; 0) {</span>
<span class="nc" id="L33872">                entity.setNCrew(entity.getNCrew() - nEscaped);</span>
<span class="nc" id="L33873">                entity.getCrew().setCurrentSize(Math.max(0, entity.getCrew().getCurrentSize() - nEscaped));</span>
<span class="nc" id="L33874">                pods.addNOtherCrew(entity.getExternalIdAsString(), nEscaped);</span>
                //*Damage* the host ship's crew to account for the people that left
<span class="nc" id="L33876">                vDesc.addAll(damageCrew(entity,entity.getCrew().calculateHits()));</span>
<span class="nc bnc" id="L33877" title="All 2 branches missed.">                if (entity.getCrew().getHits() &gt;= Crew.DEATH) {</span>
                    //Then we've finished ejecting
<span class="nc" id="L33879">                    entity.getCrew().setEjected(true);</span>
                }
            }
            // Need to set game manually; since game.addEntity not called yet
            // Don't want to do this yet, as Entity may not be added
<span class="nc" id="L33884">            pods.setPosition(entity.getPosition());</span>
<span class="nc" id="L33885">            pods.setGame(game);</span>
<span class="nc" id="L33886">            pods.setDeployed(true);</span>
<span class="nc" id="L33887">            pods.setId(getFreeEntityId());</span>
            //Escape craft retain the heading and velocity of the unit they eject from
<span class="nc" id="L33889">            pods.setVectors(entity.getVectors());</span>
<span class="nc" id="L33890">            pods.setFacing(entity.getFacing());</span>
<span class="nc" id="L33891">            pods.setCurrentVelocity(entity.getCurrentVelocity());</span>
            //If the crew ejects, they should no longer be accelerating
<span class="nc" id="L33893">            pods.setNextVelocity(entity.getVelocity());</span>
<span class="nc bnc" id="L33894" title="All 2 branches missed.">            if (entity.isAirborne()) {</span>
<span class="nc" id="L33895">                pods.setAltitude(entity.getAltitude());</span>
            }
            // Add Entity to game
<span class="nc" id="L33898">            game.addEntity(pods);</span>
            // No movement this turn
<span class="nc" id="L33900">            pods.setDone(true);</span>
            // Tell clients about new entity
<span class="nc" id="L33902">            send(createAddEntityPacket(pods.getId()));</span>
            // Sent entity info to clients
<span class="nc" id="L33904">            entityUpdate(pods.getId());</span>
<span class="nc bnc" id="L33905" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_EJECTED_PILOTS_FLEE)) {</span>
<span class="nc" id="L33906">                game.removeEntity(pods.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT);</span>
<span class="nc" id="L33907">                send(createRemoveEntityPacket(pods.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT));</span>
            }
<span class="nc" id="L33909">        } // End Escape Pod/Lifeboat Ejection</span>
        else {
<span class="nc bnc" id="L33911" title="All 2 branches missed.">            if (airborne) {</span>
                // Can't abandon in atmosphere with no escape pods
<span class="nc" id="L33913">                r = new Report(6402);</span>
<span class="nc" id="L33914">                r.subject = entity.getId();</span>
<span class="nc" id="L33915">                r.addDesc(entity);</span>
<span class="nc" id="L33916">                r.indent();</span>
<span class="nc" id="L33917">                vDesc.addElement(r);</span>
<span class="nc" id="L33918">                return vDesc;</span>
            }
            
            // Eject up to 50 spacesuited crewmen out the nearest airlock!
            // This only works in space or on the ground
<span class="nc" id="L33923">            int nEscaped = Math.min(entity.getNPassenger() + entity.getCrew().getCurrentSize(), 50);</span>
<span class="nc" id="L33924">            EjectedCrew crew = new EjectedCrew(entity, nEscaped);</span>
<span class="nc" id="L33925">            entity.addEscapeCraft(crew.getExternalIdAsString());</span>
            
            //Report the escape
<span class="nc" id="L33928">            r = new Report(6403);</span>
<span class="nc" id="L33929">            r.subject = entity.getId();</span>
<span class="nc" id="L33930">            r.addDesc(entity);</span>
<span class="nc" id="L33931">            r.add(nEscaped);</span>
<span class="nc" id="L33932">            r.indent();</span>
<span class="nc" id="L33933">            vDesc.addElement(r);</span>

            //If there are passengers aboard, get them out first
<span class="nc bnc" id="L33936" title="All 2 branches missed.">            if (entity.getNPassenger() &gt; 0) {</span>
<span class="nc" id="L33937">                int change = Math.min(entity.getNPassenger(), nEscaped);</span>
<span class="nc" id="L33938">                entity.setNPassenger(Math.max(entity.getNPassenger() - nEscaped, 0));</span>
<span class="nc" id="L33939">                crew.addPassengers(entity.getExternalIdAsString(), change);</span>
<span class="nc" id="L33940">                nEscaped -= change;</span>
            }
            //Now get the crew out with such airlock space as is left
<span class="nc bnc" id="L33943" title="All 2 branches missed.">            if (nEscaped &gt; 0) {</span>
<span class="nc" id="L33944">                entity.setNCrew(entity.getNCrew() - nEscaped);</span>
<span class="nc" id="L33945">                entity.getCrew().setCurrentSize(Math.max(0, entity.getCrew().getCurrentSize() - nEscaped));</span>
<span class="nc" id="L33946">                crew.addNOtherCrew(entity.getExternalIdAsString(), nEscaped);</span>
                //*Damage* the host ship's crew to account for the people that left
<span class="nc" id="L33948">                vDesc.addAll(damageCrew(entity,entity.getCrew().calculateHits()));</span>
<span class="nc bnc" id="L33949" title="All 2 branches missed.">                if (entity.getCrew().getHits() &gt;= Crew.DEATH) {</span>
                    //Then we've finished ejecting
<span class="nc" id="L33951">                    entity.getCrew().setEjected(true);</span>
                }
            }
            
            // Need to set game manually; since game.addEntity not called yet
            // Don't want to do this yet, as Entity may not be added
<span class="nc" id="L33957">            crew.setGame(game);</span>
<span class="nc" id="L33958">            crew.setDeployed(true);</span>
<span class="nc" id="L33959">            crew.setId(getFreeEntityId());</span>
<span class="nc bnc" id="L33960" title="All 2 branches missed.">            if (inSpace) {</span>
                //In space, ejected pilots retain the heading and velocity of the unit they eject from
<span class="nc" id="L33962">                crew.setVectors(entity.getVectors());</span>
<span class="nc" id="L33963">                crew.setFacing(entity.getFacing());</span>
<span class="nc" id="L33964">                crew.setCurrentVelocity(entity.getVelocity());</span>
                //If the crew ejects, they should no longer be accelerating
<span class="nc" id="L33966">                crew.setNextVelocity(entity.getVelocity());</span>
                // We're going to be nice and assume a ship has enough spacesuits for everyone aboard...
<span class="nc" id="L33968">                crew.setSpaceSuit(true);</span>
<span class="nc" id="L33969">                crew.setPosition(entity.getPosition());</span>
            } else {
                // On the ground, crew must abandon into a legal hex
<span class="nc" id="L33972">                Coords legalPosition = null;</span>
                //Small Craft can just abandon into the hex they occupy
<span class="nc bnc" id="L33974" title="All 4 branches missed.">                if (!entity.isLargeCraft() &amp;&amp; !crew.isLocationProhibited(entity.getPosition())) {</span>
<span class="nc" id="L33975">                    legalPosition = entity.getPosition();</span>
                } else {
                    //Use the passed in coords. We already calculated whether they're legal or not
<span class="nc" id="L33978">                    legalPosition = pos;</span>
                }
                // Cannot abandon if there is no legal hex.  This shoudln't have
                // been allowed
<span class="nc bnc" id="L33982" title="All 2 branches missed.">                if (legalPosition == null) {</span>
<span class="nc" id="L33983">                    MegaMek.getLogger().error(&quot;Spacecraft crews cannot abandon if there is no legal hex!&quot;);</span>
<span class="nc" id="L33984">                    return vDesc;</span>
                }
<span class="nc" id="L33986">                crew.setPosition(legalPosition);</span>
            }
            // Add Entity to game
<span class="nc" id="L33989">            game.addEntity(crew);</span>
            // No movement this turn
<span class="nc" id="L33991">            crew.setDone(true);</span>
            // Tell clients about new entity
<span class="nc" id="L33993">            send(createAddEntityPacket(crew.getId()));</span>
            // Sent entity info to clients
<span class="nc" id="L33995">            entityUpdate(crew.getId());</span>
            // Check if the crew lands in a minefield
<span class="nc" id="L33997">            vDesc.addAll(doEntityDisplacementMinefieldCheck(crew,</span>
<span class="nc" id="L33998">                    entity.getPosition(), entity.getPosition(),</span>
<span class="nc" id="L33999">                    entity.getElevation()));</span>
<span class="nc bnc" id="L34000" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_EJECTED_PILOTS_FLEE)) {</span>
<span class="nc" id="L34001">                game.removeEntity(crew.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT);</span>
<span class="nc" id="L34002">                send(createRemoveEntityPacket(crew.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT));</span>
            }
        }
        // If we get here, end movement and return the report
<span class="nc" id="L34006">        entity.setDone(true);</span>
<span class="nc" id="L34007">        entityUpdate(entity.getId());</span>
<span class="nc" id="L34008">        return vDesc;</span>
    }

    public static PilotingRollData getEjectModifiers(IGame game,
            Entity entity, int crewPos, boolean autoEject) {
<span class="nc" id="L34013">        int facing = entity.getFacing();</span>
<span class="nc bnc" id="L34014" title="All 2 branches missed.">        if (entity.isPartOfFighterSquadron()) {</span>
            // Because the components of a squadron have no position and will pass the next test
<span class="nc" id="L34016">            Entity squadron = game.getEntity(entity.getTransportId());</span>
<span class="nc" id="L34017">            return getEjectModifiers(game, entity, crewPos, autoEject, squadron.getPosition(),</span>
                    &quot;ejecting&quot;);
        }
<span class="nc bnc" id="L34020" title="All 2 branches missed.">        if(null == entity.getPosition()) {</span>
            // Off-board unit?
<span class="nc" id="L34022">            return new PilotingRollData(entity.getId(), entity.getCrew().getPiloting(), &quot;ejecting&quot;);</span>
        }
<span class="nc" id="L34024">        Coords targetCoords = entity.getPosition().translated((facing + 3) % 6);</span>
<span class="nc" id="L34025">        return getEjectModifiers(game, entity, crewPos, autoEject, targetCoords,</span>
                &quot;ejecting&quot;);
    }

    public static PilotingRollData getEjectModifiers(IGame game, Entity entity, int crewPos,
            boolean autoEject, Coords targetCoords, String desc) {
<span class="nc" id="L34031">        PilotingRollData rollTarget = new PilotingRollData(entity.getId(),</span>
<span class="nc" id="L34032">                entity.getCrew().getPiloting(crewPos), desc);</span>
        // Per SO p26, fighters can eject as per TO rules on 196 with some exceptions
<span class="nc bnc" id="L34034" title="All 2 branches missed.">        if (entity.isProne()) {</span>
<span class="nc" id="L34035">            rollTarget.addModifier(5, &quot;Mech is prone&quot;);</span>
        }
<span class="nc bnc" id="L34037" title="All 2 branches missed.">        if (entity.getCrew().isUnconscious(crewPos)) {</span>
<span class="nc" id="L34038">            rollTarget.addModifier(3, &quot;pilot unconscious&quot;);</span>
        }
<span class="nc bnc" id="L34040" title="All 2 branches missed.">        if (autoEject) {</span>
<span class="nc" id="L34041">            rollTarget.addModifier(1, &quot;automatic ejection&quot;);</span>
        }
        // Per SO p27, Large Craft roll too, to see how many escape pods launch successfully
<span class="nc bnc" id="L34044" title="All 4 branches missed.">        if ((entity.isAero() &amp;&amp; ((IAero)entity).isOutControl())</span>
<span class="nc bnc" id="L34045" title="All 4 branches missed.">                || (entity.isPartOfFighterSquadron() &amp;&amp; ((IAero)game.getEntity(entity.getTransportId())).isOutControl())) {</span>
<span class="nc" id="L34046">            rollTarget.addModifier(5, &quot;Out of Control&quot;);</span>
        }
        // A decreased large craft crew makes it harder to eject large numbers of pods
<span class="nc bnc" id="L34049" title="All 4 branches missed.">        if (entity.isLargeCraft() &amp;&amp; entity.getCrew().getHits() &gt; 0) {</span>
<span class="nc" id="L34050">            rollTarget.addModifier(entity.getCrew().getHits(), &quot;Crew hits&quot;);</span>
        }
<span class="nc bnc" id="L34052" title="All 2 branches missed.">        if ((entity instanceof Mech)</span>
<span class="nc" id="L34053">                &amp;&amp; (entity.getInternal(Mech.LOC_HEAD) &lt; entity</span>
<span class="nc bnc" id="L34054" title="All 2 branches missed.">                        .getOInternal(Mech.LOC_HEAD))) {</span>
<span class="nc" id="L34055">            rollTarget.addModifier(</span>
<span class="nc" id="L34056">                    entity.getOInternal(Mech.LOC_HEAD)</span>
<span class="nc" id="L34057">                            - entity.getInternal(Mech.LOC_HEAD),</span>
                    &quot;Head Internal Structure Damage&quot;);
        }
<span class="nc" id="L34060">        IHex targetHex = game.getBoard().getHex(targetCoords);</span>
        //Terrain modifiers should only apply if the unit is on the ground...
<span class="nc bnc" id="L34062" title="All 4 branches missed.">        if (!entity.isSpaceborne() &amp;&amp; !entity.isAirborne()) {</span>
<span class="nc bnc" id="L34063" title="All 2 branches missed.">            if (targetHex != null) {</span>
<span class="nc bnc" id="L34064" title="All 2 branches missed.">                if ((targetHex.terrainLevel(Terrains.WATER) &gt; 0)</span>
<span class="nc bnc" id="L34065" title="All 2 branches missed.">                        &amp;&amp; !targetHex.containsTerrain(Terrains.ICE)) {</span>
<span class="nc" id="L34066">                    rollTarget.addModifier(-1, &quot;landing in water&quot;);</span>
<span class="nc bnc" id="L34067" title="All 2 branches missed.">                } else if (targetHex.containsTerrain(Terrains.ROUGH)) {</span>
<span class="nc" id="L34068">                    rollTarget.addModifier(0, &quot;landing in rough&quot;);</span>
<span class="nc bnc" id="L34069" title="All 2 branches missed.">                } else if (targetHex.containsTerrain(Terrains.RUBBLE)) {</span>
<span class="nc" id="L34070">                    rollTarget.addModifier(0, &quot;landing in rubble&quot;);</span>
<span class="nc bnc" id="L34071" title="All 2 branches missed.">                } else if (targetHex.terrainLevel(Terrains.WOODS) == 1) {</span>
<span class="nc" id="L34072">                    rollTarget.addModifier(2, &quot;landing in light woods&quot;);</span>
<span class="nc bnc" id="L34073" title="All 2 branches missed.">                } else if (targetHex.terrainLevel(Terrains.WOODS) == 2) {</span>
<span class="nc" id="L34074">                    rollTarget.addModifier(3, &quot;landing in heavy woods&quot;);</span>
<span class="nc bnc" id="L34075" title="All 2 branches missed.">                } else if (targetHex.terrainLevel(Terrains.WOODS) == 3) {</span>
<span class="nc" id="L34076">                    rollTarget.addModifier(4, &quot;landing in ultra heavy woods&quot;);</span>
<span class="nc bnc" id="L34077" title="All 2 branches missed.">                } else if (targetHex.terrainLevel(Terrains.JUNGLE) == 1) {</span>
<span class="nc" id="L34078">                    rollTarget.addModifier(3, &quot;landing in light jungle&quot;);</span>
<span class="nc bnc" id="L34079" title="All 2 branches missed.">                } else if (targetHex.terrainLevel(Terrains.JUNGLE) == 2) {</span>
<span class="nc" id="L34080">                    rollTarget.addModifier(5, &quot;landing in heavy jungle&quot;);</span>
<span class="nc bnc" id="L34081" title="All 2 branches missed.">                } else if (targetHex.terrainLevel(Terrains.JUNGLE) == 3) {</span>
<span class="nc" id="L34082">                    rollTarget.addModifier(7, &quot;landing in ultra heavy jungle&quot;);</span>
<span class="nc bnc" id="L34083" title="All 2 branches missed.">                } else if (targetHex.terrainLevel(Terrains.BLDG_ELEV) &gt; 0) {</span>
<span class="nc" id="L34084">                    rollTarget.addModifier(</span>
<span class="nc" id="L34085">                            targetHex.terrainLevel(Terrains.BLDG_ELEV),</span>
                            &quot;landing in a building&quot;);
                } else {
<span class="nc" id="L34088">                    rollTarget.addModifier(-2, &quot;landing in clear terrain&quot;);</span>
                }
            } else {
<span class="nc" id="L34091">                rollTarget.addModifier(-2, &quot;landing off the board&quot;);</span>
            }
        }
<span class="nc bnc" id="L34094" title="All 2 branches missed.">        if (!entity.isSpaceborne()) {</span>
            //At present, the UI lets you set these atmospheric conditions for a space battle, but it shouldn't
            //That's a fix for another day, probably when I get around to space terrain and 'weather'
<span class="nc bnc" id="L34097" title="All 2 branches missed.">            if (game.getPlanetaryConditions().getGravity() == 0) {</span>
<span class="nc" id="L34098">                rollTarget.addModifier(3, &quot;Zero-G&quot;);</span>
<span class="nc bnc" id="L34099" title="All 2 branches missed.">            } else if (game.getPlanetaryConditions().getGravity() &lt; .8) {</span>
<span class="nc" id="L34100">                rollTarget.addModifier(2, &quot;Low-G&quot;);</span>
<span class="nc bnc" id="L34101" title="All 2 branches missed.">            } else if (game.getPlanetaryConditions().getGravity() &gt; 1.2) {</span>
<span class="nc" id="L34102">                rollTarget.addModifier(2, &quot;High-G&quot;);</span>
            }
        
            //Vacuum shouldn't apply to ASF ejection since they're designed for it, but the rules don't specify
            //High and low pressures make more sense to apply to all
<span class="nc bnc" id="L34107" title="All 2 branches missed.">            if (game.getPlanetaryConditions().getAtmosphere() == PlanetaryConditions.ATMO_VACUUM) {</span>
<span class="nc" id="L34108">                rollTarget.addModifier(3, &quot;Vacuum&quot;);</span>
<span class="nc bnc" id="L34109" title="All 2 branches missed.">            } else if (game.getPlanetaryConditions().getAtmosphere() == PlanetaryConditions.ATMO_VHIGH) {</span>
<span class="nc" id="L34110">                rollTarget.addModifier(2, &quot;Very High Atmosphere Pressure&quot;);</span>
<span class="nc bnc" id="L34111" title="All 2 branches missed.">            } else if (game.getPlanetaryConditions().getAtmosphere() == PlanetaryConditions.ATMO_TRACE) {</span>
<span class="nc" id="L34112">                rollTarget.addModifier(2, &quot;Trace atmosphere&quot;);</span>
            }
        }

<span class="nc bnc" id="L34116" title="All 2 branches missed.">        if ((game.getPlanetaryConditions().getWeather() == PlanetaryConditions.WE_HEAVY_SNOW)</span>
<span class="nc bnc" id="L34117" title="All 2 branches missed.">                || (game.getPlanetaryConditions().getWeather() == PlanetaryConditions.WE_ICE_STORM)</span>
<span class="nc bnc" id="L34118" title="All 2 branches missed.">                || (game.getPlanetaryConditions().getWeather() == PlanetaryConditions.WE_DOWNPOUR)</span>
<span class="nc bnc" id="L34119" title="All 2 branches missed.">                || (game.getPlanetaryConditions().getWindStrength() == PlanetaryConditions.WI_STRONG_GALE)) {</span>
<span class="nc" id="L34120">            rollTarget.addModifier(2, &quot;Bad Weather&quot;);</span>
        }

<span class="nc bnc" id="L34123" title="All 2 branches missed.">        if ((game.getPlanetaryConditions().getWindStrength() &gt;= PlanetaryConditions.WI_STORM)</span>
<span class="nc bnc" id="L34124" title="All 2 branches missed.">                || (game.getPlanetaryConditions().getWeather() == PlanetaryConditions.WE_BLIZZARD)</span>
<span class="nc bnc" id="L34125" title="All 2 branches missed.">                || ((game.getPlanetaryConditions().getWeather() == PlanetaryConditions.WE_HEAVY_SNOW) &amp;&amp; (game</span>
<span class="nc bnc" id="L34126" title="All 2 branches missed.">                        .getPlanetaryConditions().getWindStrength() == PlanetaryConditions.WI_STRONG_GALE))) {</span>
<span class="nc" id="L34127">            rollTarget.addModifier(3, &quot;Really Bad Weather&quot;);</span>
        }
<span class="nc" id="L34129">        return rollTarget;</span>
    }

    /**
     * Creates a new Ballistic Infantry unit at the end of the movement phase
     */
    public void resolveCallSupport() {
<span class="nc bnc" id="L34136" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L34137" title="All 4 branches missed.">            if ((e instanceof Infantry) &amp;&amp; ((Infantry) e).getIsCallingSupport()) {</span>

                // Now lets create a new foot platoon
<span class="nc" id="L34140">                Infantry guerrilla = new Infantry();</span>
<span class="nc" id="L34141">                guerrilla.setChassis(&quot;Insurgents&quot;);</span>
<span class="nc" id="L34142">                guerrilla.setModel(&quot;(Rifle)&quot;);</span>
<span class="nc" id="L34143">                guerrilla.setSquadN(4);</span>
<span class="nc" id="L34144">                guerrilla.setSquadSize(7);</span>
<span class="nc" id="L34145">                guerrilla.autoSetInternal();</span>
<span class="nc" id="L34146">                guerrilla.getCrew().setGunnery(5, 0);</span>
                try {
<span class="nc" id="L34148">                    guerrilla.addEquipment(EquipmentType.get(EquipmentTypeLookup.INFANTRY_ASSAULT_RIFLE),</span>
                            Infantry.LOC_INFANTRY);
<span class="nc" id="L34150">                    guerrilla.setPrimaryWeapon((InfantryWeapon) InfantryWeapon</span>
<span class="nc" id="L34151">                            .get(EquipmentTypeLookup.INFANTRY_ASSAULT_RIFLE));</span>
<span class="nc" id="L34152">                } catch (Exception ex) {</span>
<span class="nc" id="L34153">                    ex.printStackTrace();</span>
<span class="nc" id="L34154">                }</span>
<span class="nc" id="L34155">                guerrilla.setDeployed(true);</span>
<span class="nc" id="L34156">                guerrilla.setDone(true);</span>
<span class="nc" id="L34157">                guerrilla.setId(getFreeEntityId());</span>
<span class="nc" id="L34158">                guerrilla.setOwner(e.getOwner());</span>
<span class="nc" id="L34159">                game.addEntity(guerrilla);</span>

                // Add the infantry unit on the battlefield. Should spawn within 3 hexes
                // First get coords then loop over some targets
<span class="nc" id="L34163">                Coords tmpCoords = e.getPosition();</span>
<span class="nc" id="L34164">                Coords targetCoords = null;</span>
<span class="nc bnc" id="L34165" title="All 2 branches missed.">                while (!game.getBoard().contains(targetCoords)) {</span>
<span class="nc" id="L34166">                    targetCoords = Compute.scatter(tmpCoords, (Compute.d6(1) / 2));</span>
<span class="nc bnc" id="L34167" title="All 2 branches missed.">                    if (game.getBoard().contains(targetCoords)) {</span>
<span class="nc" id="L34168">                        guerrilla.setPosition(targetCoords);</span>
<span class="nc" id="L34169">                        break;</span>
                    }
                }
<span class="nc" id="L34172">                send(createAddEntityPacket(guerrilla.getId()));</span>
<span class="nc" id="L34173">                ((Infantry) e).setIsCallingSupport(false);</span>
                /*
                // Update the entity
                entityUpdate(guerrilla.getId());
                Report r = new Report(5535, Report.PUBLIC);
                r.subject = e.getId();
                r.addDesc(e);
                addReport(r);*/
            }
<span class="nc" id="L34182">        }</span>
<span class="nc" id="L34183">    }</span>

    /**
     * Abandon an Entity.
     *
     * @param entity The &lt;code&gt;Entity&lt;/code&gt; to abandon.
     * @return a &lt;code&gt;Vector&lt;/code&gt; of report objects for the game log.
     */
    public Vector&lt;Report&gt; abandonEntity(Entity entity) {
<span class="nc" id="L34192">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;

        // An entity can only eject it's crew once.
<span class="nc bnc" id="L34196" title="All 2 branches missed.">        if (entity.getCrew().isEjected()) {</span>
<span class="nc" id="L34197">            return vDesc;</span>
        }

<span class="nc bnc" id="L34200" title="All 4 branches missed.">        if (entity.getCrew().isDoomed() || entity.getCrew().isDead()) {</span>
<span class="nc" id="L34201">            return vDesc;</span>
        }

<span class="nc" id="L34204">        Coords targetCoords = entity.getPosition();</span>

<span class="nc bnc" id="L34206" title="All 6 branches missed.">        if (entity instanceof Mech || (entity.isAero() &amp;&amp; !entity.isAirborne())) {</span>
            // okay, print the info
<span class="nc" id="L34208">            r = new Report(2027);</span>
<span class="nc" id="L34209">            r.subject = entity.getId();</span>
<span class="nc" id="L34210">            r.add(entity.getCrew().getName());</span>
<span class="nc" id="L34211">            r.addDesc(entity);</span>
<span class="nc" id="L34212">            r.indent(3);</span>
<span class="nc" id="L34213">            vDesc.addElement(r);</span>
            // Don't make ill-equipped pilots abandon into vacuum
<span class="nc bnc" id="L34215" title="All 4 branches missed.">            if (game.getPlanetaryConditions().isVacuum() &amp;&amp; !entity.isAero()) {</span>
<span class="nc" id="L34216">                return vDesc;</span>
            }

            // create the MechWarrior in any case, for campaign tracking
<span class="nc" id="L34220">            MechWarrior pilot = new MechWarrior(entity);</span>
<span class="nc" id="L34221">            pilot.getCrew().setUnconscious(entity.getCrew().isUnconscious());</span>
<span class="nc" id="L34222">            pilot.setDeployed(true);</span>
<span class="nc" id="L34223">            pilot.setId(getFreeEntityId());</span>
            //Pilot flight suits are vacuum-rated. MechWarriors wear shorts...
<span class="nc" id="L34225">            pilot.setSpaceSuit(entity.isAero());</span>
<span class="nc bnc" id="L34226" title="All 2 branches missed.">            if (entity.isSpaceborne()) {</span>
                //In space, ejected pilots retain the heading and velocity of the unit they eject from
<span class="nc" id="L34228">                pilot.setVectors(entity.getVectors());</span>
<span class="nc" id="L34229">                pilot.setFacing(entity.getFacing());</span>
<span class="nc" id="L34230">                pilot.setCurrentVelocity(entity.getVelocity());</span>
                //If the pilot ejects, he should no longer be accelerating
<span class="nc" id="L34232">                pilot.setNextVelocity(entity.getVelocity());</span>
            }
<span class="nc" id="L34234">            game.addEntity(pilot);</span>
<span class="nc" id="L34235">            send(createAddEntityPacket(pilot.getId()));</span>
            // make him not get a move this turn
<span class="nc" id="L34237">            pilot.setDone(true);</span>
            // Add the pilot as an infantry unit on the battlefield.
<span class="nc bnc" id="L34239" title="All 2 branches missed.">            if (game.getBoard().contains(targetCoords)) {</span>
<span class="nc" id="L34240">                pilot.setPosition(targetCoords);</span>
            }
<span class="nc" id="L34242">            pilot.setCommander(entity.isCommander());</span>
            // Update the entity
<span class="nc" id="L34244">            entityUpdate(pilot.getId());</span>
            // check if the pilot lands in a minefield
<span class="nc" id="L34246">            vDesc.addAll(doEntityDisplacementMinefieldCheck(pilot, entity.getPosition(),</span>
<span class="nc" id="L34247">                    targetCoords, entity.getElevation()));</span>
<span class="nc bnc" id="L34248" title="All 2 branches missed.">            if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_EJECTED_PILOTS_FLEE)) {</span>
<span class="nc" id="L34249">                game.removeEntity(pilot.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT);</span>
<span class="nc" id="L34250">                send(createRemoveEntityPacket(pilot.getId(),</span>
                        IEntityRemovalConditions.REMOVE_IN_RETREAT));
            }
<span class="nc" id="L34253">        } // End entity-is-Mek or Aero</span>
<span class="nc bnc" id="L34254" title="All 4 branches missed.">        else if (game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_VEHICLES_CAN_EJECT)</span>
                 &amp;&amp; (entity instanceof Tank)) {
            // Don't make them abandon into vacuum
<span class="nc bnc" id="L34257" title="All 2 branches missed.">            if (game.getPlanetaryConditions().isVacuum()) {</span>
<span class="nc" id="L34258">                return vDesc;</span>
            }
<span class="nc" id="L34260">            EjectedCrew crew = new EjectedCrew(entity);</span>
<span class="nc" id="L34261">            crew.setDeployed(true);</span>
<span class="nc" id="L34262">            crew.setId(getFreeEntityId());</span>
<span class="nc" id="L34263">            game.addEntity(crew);</span>
<span class="nc" id="L34264">            send(createAddEntityPacket(crew.getId()));</span>
            // Make them not get a move this turn
<span class="nc" id="L34266">            crew.setDone(true);</span>
            // Place on board
<span class="nc bnc" id="L34268" title="All 2 branches missed.">            if(game.getBoard().contains(entity.getPosition())) {</span>
<span class="nc" id="L34269">                crew.setPosition(entity.getPosition());</span>
            }
            // Update the entity
<span class="nc" id="L34272">            entityUpdate(crew.getId());</span>
            // Check if the crew lands in a minefield
<span class="nc" id="L34274">            vDesc.addAll(doEntityDisplacementMinefieldCheck(crew, entity.getPosition(),</span>
<span class="nc" id="L34275">                    entity.getPosition(), entity.getElevation()));</span>
<span class="nc bnc" id="L34276" title="All 2 branches missed.">            if(game.getOptions().booleanOption(OptionsConstants.ADVGRNDMOV_EJECTED_PILOTS_FLEE)) {</span>
<span class="nc" id="L34277">                game.removeEntity(crew.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT);</span>
<span class="nc" id="L34278">                send(createRemoveEntityPacket(crew.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT));</span>
            }
        }

        // Mark the entity's crew as &quot;ejected&quot;.
<span class="nc" id="L34283">        entity.getCrew().setEjected(true);</span>

<span class="nc" id="L34285">        return vDesc;</span>
    }

    /**
     * Checks if ejected MechWarriors are eligible to be picked up, and if so,
     * captures them or picks them up
     */
    private void resolveMechWarriorPickUp() {
        Report r;

        // fetch all mechWarriors that are not picked up
<span class="nc" id="L34296">        Iterator&lt;Entity&gt; mechWarriors = game.getSelectedEntities(entity -&gt; {</span>
<span class="nc bnc" id="L34297" title="All 2 branches missed.">                    if (entity instanceof MechWarrior) {</span>
<span class="nc" id="L34298">                        MechWarrior mw = (MechWarrior) entity;</span>
<span class="nc bnc" id="L34299" title="All 2 branches missed.">                        return (mw.getPickedUpById() == Entity.NONE)</span>
<span class="nc bnc" id="L34300" title="All 2 branches missed.">                                &amp;&amp; !mw.isDoomed()</span>
<span class="nc bnc" id="L34301" title="All 2 branches missed.">                                &amp;&amp; (mw.getTransportId() == Entity.NONE);</span>
                    }
<span class="nc" id="L34303">                    return false;</span>
                });
        // loop through them, check if they are in a hex occupied by another
        // unit
<span class="nc bnc" id="L34307" title="All 2 branches missed.">        while (mechWarriors.hasNext()) {</span>
<span class="nc" id="L34308">            boolean pickedUp = false;</span>
<span class="nc" id="L34309">            MechWarrior e = (MechWarrior) mechWarriors.next();</span>
            // Check for owner entities first...
<span class="nc bnc" id="L34311" title="All 2 branches missed.">            for (Entity pe : game.getEntitiesVector(e.getPosition())) {</span>
<span class="nc bnc" id="L34312" title="All 6 branches missed.">                if (pe.isDoomed() || pe.isShutDown() || pe.getCrew().isUnconscious()</span>
<span class="nc bnc" id="L34313" title="All 4 branches missed.">                        || (pe.isAirborne() &amp;&amp; !pe.isSpaceborne())</span>
<span class="nc bnc" id="L34314" title="All 2 branches missed.">                        || (pe.getElevation() != e.getElevation())</span>
<span class="nc bnc" id="L34315" title="All 2 branches missed.">                        || (pe.getOwnerId() != e.getOwnerId())</span>
<span class="nc bnc" id="L34316" title="All 2 branches missed.">                        || (pe.getId() == e.getId())) {</span>
<span class="nc" id="L34317">                    continue;</span>
                }
<span class="nc bnc" id="L34319" title="All 2 branches missed.">                if (pe instanceof MechWarrior) {</span>
                    // MWs have a beer together
<span class="nc" id="L34321">                    r = new Report(6415, Report.PUBLIC);</span>
<span class="nc" id="L34322">                    r.add(pe.getDisplayName());</span>
<span class="nc" id="L34323">                    addReport(r);</span>
<span class="nc" id="L34324">                    continue;</span>
                }
                // Pick up the unit.
<span class="nc" id="L34327">                pe.pickUp(e);</span>
                // The picked unit is being carried by the loader.
<span class="nc" id="L34329">                e.setPickedUpById(pe.getId());</span>
<span class="nc" id="L34330">                e.setPickedUpByExternalId(pe.getExternalIdAsString());</span>
<span class="nc" id="L34331">                pickedUp = true;</span>
<span class="nc" id="L34332">                r = new Report(6420, Report.PUBLIC);</span>
<span class="nc" id="L34333">                r.add(e.getDisplayName());</span>
<span class="nc" id="L34334">                r.addDesc(pe);</span>
<span class="nc" id="L34335">                addReport(r);</span>
<span class="nc" id="L34336">                break;</span>
            }
            // Check for allied entities next...
<span class="nc bnc" id="L34339" title="All 2 branches missed.">            if (!pickedUp) {</span>
<span class="nc bnc" id="L34340" title="All 2 branches missed.">                for (Entity pe : game.getEntitiesVector(e.getPosition())) {</span>
<span class="nc bnc" id="L34341" title="All 6 branches missed.">                    if (pe.isDoomed() || pe.isShutDown() || pe.getCrew().isUnconscious()</span>
<span class="nc bnc" id="L34342" title="All 4 branches missed.">                            || (pe.isAirborne() &amp;&amp; !pe.isSpaceborne())</span>
<span class="nc bnc" id="L34343" title="All 2 branches missed.">                            || (pe.getElevation() != e.getElevation())</span>
<span class="nc bnc" id="L34344" title="All 4 branches missed.">                            || (pe.getOwnerId() == e.getOwnerId()) || (pe.getId() == e.getId())</span>
<span class="nc bnc" id="L34345" title="All 2 branches missed.">                            || (pe.getOwner().getTeam() == IPlayer.TEAM_NONE)</span>
<span class="nc bnc" id="L34346" title="All 2 branches missed.">                            || (pe.getOwner().getTeam() != e.getOwner().getTeam())) {</span>
<span class="nc" id="L34347">                        continue;</span>
                    }
<span class="nc bnc" id="L34349" title="All 2 branches missed.">                    if (pe instanceof MechWarrior) {</span>
                        // MWs have a beer together
<span class="nc" id="L34351">                        r = new Report(6415, Report.PUBLIC);</span>
<span class="nc" id="L34352">                        r.add(pe.getDisplayName());</span>
<span class="nc" id="L34353">                        addReport(r);</span>
<span class="nc" id="L34354">                        continue;</span>
                    }
                    // Pick up the unit.
<span class="nc" id="L34357">                    pe.pickUp(e);</span>
                    // The picked unit is being carried by the loader.
<span class="nc" id="L34359">                    e.setPickedUpById(pe.getId());</span>
<span class="nc" id="L34360">                    e.setPickedUpByExternalId(pe.getExternalIdAsString());</span>
<span class="nc" id="L34361">                    pickedUp = true;</span>
<span class="nc" id="L34362">                    r = new Report(6420, Report.PUBLIC);</span>
<span class="nc" id="L34363">                    r.add(e.getDisplayName());</span>
<span class="nc" id="L34364">                    r.addDesc(pe);</span>
<span class="nc" id="L34365">                    addReport(r);</span>
<span class="nc" id="L34366">                    break;</span>
                }
            }
            // Now check for anyone else...
<span class="nc bnc" id="L34370" title="All 2 branches missed.">            if (!pickedUp) {</span>
<span class="nc" id="L34371">                Iterator&lt;Entity&gt; pickupEnemyEntities = game.getEnemyEntities(e.getPosition(), e);</span>
<span class="nc bnc" id="L34372" title="All 2 branches missed.">                while (pickupEnemyEntities.hasNext()) {</span>
<span class="nc" id="L34373">                    Entity pe = pickupEnemyEntities.next();</span>
<span class="nc bnc" id="L34374" title="All 6 branches missed.">                    if (pe.isDoomed() || pe.isShutDown() || pe.getCrew().isUnconscious()</span>
<span class="nc bnc" id="L34375" title="All 4 branches missed.">                            || pe.isAirborne() || (pe.getElevation() != e.getElevation())) {</span>
<span class="nc" id="L34376">                        continue;</span>
                    }
<span class="nc bnc" id="L34378" title="All 2 branches missed.">                    if (pe instanceof MechWarrior) {</span>
                        // MWs have a beer together
<span class="nc" id="L34380">                        r = new Report(6415, Report.PUBLIC);</span>
<span class="nc" id="L34381">                        r.add(pe.getDisplayName());</span>
<span class="nc" id="L34382">                        addReport(r);</span>
<span class="nc" id="L34383">                        continue;</span>
                    }
                    // Capture the unit.
<span class="nc" id="L34386">                    pe.pickUp(e);</span>
                    // The captured unit is being carried by the loader.
<span class="nc" id="L34388">                    e.setCaptured(true);</span>
<span class="nc" id="L34389">                    e.setPickedUpById(pe.getId());</span>
<span class="nc" id="L34390">                    e.setPickedUpByExternalId(pe.getExternalIdAsString());</span>
<span class="nc" id="L34391">                    pickedUp = true;</span>
<span class="nc" id="L34392">                    r = new Report(6420, Report.PUBLIC);</span>
<span class="nc" id="L34393">                    r.add(e.getDisplayName());</span>
<span class="nc" id="L34394">                    r.addDesc(pe);</span>
<span class="nc" id="L34395">                    addReport(r);</span>
<span class="nc" id="L34396">                    break;</span>
                }
            }
<span class="nc bnc" id="L34399" title="All 2 branches missed.">            if (pickedUp) {</span>
                // Remove the picked-up unit from the screen.
<span class="nc" id="L34401">                e.setPosition(null);</span>
                // Update the loaded unit.
<span class="nc" id="L34403">                entityUpdate(e.getId());</span>
            }
<span class="nc" id="L34405">        }</span>
<span class="nc" id="L34406">    }</span>

    /**
     * destroy all wheeled and tracked Tanks that got displaced into water
     */
    private void resolveSinkVees() {
<span class="nc" id="L34412">        Iterator&lt;Entity&gt; sinkableTanks = game.getSelectedEntities(entity -&gt; {</span>
<span class="nc bnc" id="L34413" title="All 6 branches missed.">                    if (entity.isOffBoard() || (entity.getPosition() == null)</span>
                            || !(entity instanceof Tank)) {
<span class="nc" id="L34415">                        return false;</span>
                    }
<span class="nc" id="L34417">                    final IHex hex = game.getBoard().getHex(entity.getPosition());</span>
<span class="nc bnc" id="L34418" title="All 2 branches missed.">                    final boolean onBridge = (hex.terrainLevel(Terrains.BRIDGE) &gt; 0)</span>
<span class="nc bnc" id="L34419" title="All 2 branches missed.">                            &amp;&amp; (entity.getElevation() == hex.terrainLevel(Terrains.BRIDGE_ELEV));</span>
<span class="nc bnc" id="L34420" title="All 2 branches missed.">                    return ((entity.getMovementMode() == EntityMovementMode.TRACKED)</span>
<span class="nc bnc" id="L34421" title="All 2 branches missed.">                            || (entity.getMovementMode() == EntityMovementMode.WHEELED)</span>
<span class="nc bnc" id="L34422" title="All 2 branches missed.">                            || ((entity.getMovementMode() == EntityMovementMode.HOVER)))</span>
<span class="nc bnc" id="L34423" title="All 6 branches missed.">                            &amp;&amp; entity.isImmobile() &amp;&amp; (hex.terrainLevel(Terrains.WATER) &gt; 0)</span>
<span class="nc bnc" id="L34424" title="All 2 branches missed.">                            &amp;&amp; !onBridge &amp;&amp; !(entity.hasWorkingMisc(MiscType.F_FULLY_AMPHIBIOUS))</span>
<span class="nc bnc" id="L34425" title="All 2 branches missed.">                            &amp;&amp; !(entity.hasWorkingMisc(MiscType.F_FLOTATION_HULL));</span>
                });
<span class="nc bnc" id="L34427" title="All 2 branches missed.">        while (sinkableTanks.hasNext()) {</span>
<span class="nc" id="L34428">            Entity e = sinkableTanks.next();</span>
<span class="nc" id="L34429">            addReport(destroyEntity(e, &quot;a watery grave&quot;, false));</span>
<span class="nc" id="L34430">        }</span>
<span class="nc" id="L34431">    }</span>

    /**
     * let all Entities make their &quot;break-free-of-swamp-stickyness&quot; PSR
     */
    private void doTryUnstuck() {
<span class="nc bnc" id="L34437" title="All 2 branches missed.">        if (game.getPhase() != IGame.Phase.PHASE_MOVEMENT) {</span>
<span class="nc" id="L34438">            return;</span>
        }

        Report r;

<span class="nc" id="L34443">        Iterator&lt;Entity&gt; stuckEntities = game.getSelectedEntities(Entity::isStuck);</span>
        PilotingRollData rollTarget;
<span class="nc bnc" id="L34445" title="All 2 branches missed.">        while (stuckEntities.hasNext()) {</span>
<span class="nc" id="L34446">            Entity entity = stuckEntities.next();</span>
<span class="nc bnc" id="L34447" title="All 2 branches missed.">            if (entity.getPosition() == null) {</span>
<span class="nc bnc" id="L34448" title="All 2 branches missed.">                if (entity.isDeployed()) {</span>
<span class="nc" id="L34449">                    MegaMek.getLogger().info(&quot;Entity #&quot; + entity.getId() + &quot; does not know its position.&quot;);</span>
                } else { // If the Entity isn't deployed, then something goofy
                    // happened.  We'll just unstuck the Entity
<span class="nc" id="L34452">                    entity.setStuck(false);</span>
<span class="nc" id="L34453">                    MegaMek.getLogger().info(&quot;Entity #&quot; + entity.getId() + &quot; was stuck in a swamp, but not deployed. Stuck state reset&quot;);</span>
                }
<span class="nc" id="L34455">                continue;</span>
            }
<span class="nc" id="L34457">            rollTarget = entity.getBasePilotingRoll();</span>
<span class="nc" id="L34458">            entity.addPilotingModifierForTerrain(rollTarget);</span>
            // apart from swamp &amp; liquid magma, -1 modifier
<span class="nc" id="L34460">            IHex hex = game.getBoard().getHex(entity.getPosition());</span>
<span class="nc" id="L34461">            hex.getUnstuckModifier(entity.getElevation(), rollTarget);</span>
            // okay, print the info
<span class="nc" id="L34463">            r = new Report(2340);</span>
<span class="nc" id="L34464">            r.addDesc(entity);</span>
<span class="nc" id="L34465">            addReport(r);</span>

            // roll
<span class="nc" id="L34468">            final int diceRoll = entity.getCrew().rollPilotingSkill();</span>
<span class="nc" id="L34469">            r = new Report(2190);</span>
<span class="nc" id="L34470">            r.subject = entity.getId();</span>
<span class="nc" id="L34471">            r.add(rollTarget.getValueAsString());</span>
<span class="nc" id="L34472">            r.add(rollTarget.getDesc());</span>
<span class="nc" id="L34473">            r.add(diceRoll);</span>
<span class="nc bnc" id="L34474" title="All 2 branches missed.">            if (diceRoll &lt; rollTarget.getValue()) {</span>
<span class="nc" id="L34475">                r.choose(false);</span>
            } else {
<span class="nc" id="L34477">                r.choose(true);</span>
<span class="nc" id="L34478">                entity.setStuck(false);</span>
<span class="nc" id="L34479">                entity.setCanUnstickByJumping(false);</span>
<span class="nc" id="L34480">                entity.setElevation(0);</span>
<span class="nc" id="L34481">                entityUpdate(entity.getId());</span>
            }
<span class="nc" id="L34483">            addReport(r);</span>
<span class="nc" id="L34484">        }</span>
<span class="nc" id="L34485">    }</span>

    /**
     * Remove all iNarc pods from all vehicles that did not move and shoot this
     * round NOTE: this is not quite what the rules say, the player should be
     * able to choose whether or not to remove all iNarc Pods that are attached.
     */
    private void resolveVeeINarcPodRemoval() {
<span class="nc" id="L34493">        Iterator&lt;Entity&gt; vees = game.getSelectedEntities(</span>
<span class="nc bnc" id="L34494" title="All 4 branches missed.">                entity -&gt; (entity instanceof Tank) &amp;&amp; (entity.mpUsed == 0));</span>
        boolean canSwipePods;
<span class="nc bnc" id="L34496" title="All 2 branches missed.">        while (vees.hasNext()) {</span>
<span class="nc" id="L34497">            canSwipePods = true;</span>
<span class="nc" id="L34498">            Entity entity = vees.next();</span>
<span class="nc bnc" id="L34499" title="All 2 branches missed.">            for (int i = 0; i &lt;= 5; i++) {</span>
<span class="nc bnc" id="L34500" title="All 2 branches missed.">                if (entity.weaponFiredFrom(i)) {</span>
<span class="nc" id="L34501">                    canSwipePods = false;</span>
                }
            }
<span class="nc bnc" id="L34504" title="All 2 branches missed.">            if (((Tank) entity).getStunnedTurns() &gt; 0) {</span>
<span class="nc" id="L34505">                canSwipePods = false;</span>
            }
<span class="nc bnc" id="L34507" title="All 4 branches missed.">            if (canSwipePods &amp;&amp; entity.hasINarcPodsAttached()</span>
<span class="nc bnc" id="L34508" title="All 2 branches missed.">                &amp;&amp; entity.getCrew().isActive()) {</span>
<span class="nc" id="L34509">                entity.removeAllINarcPods();</span>
<span class="nc" id="L34510">                Report r = new Report(2345);</span>
<span class="nc" id="L34511">                r.addDesc(entity);</span>
<span class="nc" id="L34512">                addReport(r);</span>
            }
<span class="nc" id="L34514">        }</span>
<span class="nc" id="L34515">    }</span>

    /*
     * //See note above where knownDeadEntities variable is declared private
     * void deadEntitiesCleanup() { Entity en = null; for(Enumeration k =
     * game.getGraveyardEntities(); k.hasMoreElements(); en = (Entity)
     * k.nextElement()) { if (en != null) { if (!knownDeadEntities.contains(en))
     * { knownDeadEntities.add(en); } } } }
     */

    /**
     * remove Ice in the hex that's at the passed coords, and let entities fall
     * into water below it, if there is water
     *
     * @param c the &lt;code&gt;Coords&lt;/code&gt; of the hex where ice should be removed
     * @return a &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt; for the phase report
     */
    private Vector&lt;Report&gt; resolveIceBroken(Coords c) {
<span class="nc" id="L34533">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L34534">        IHex hex = game.getBoard().getHex(c);</span>
<span class="nc" id="L34535">        hex.removeTerrain(Terrains.ICE);</span>
<span class="nc" id="L34536">        sendChangedHex(c);</span>
        // if there is water below the ice
<span class="nc bnc" id="L34538" title="All 2 branches missed.">        if (hex.terrainLevel(Terrains.WATER) &gt; 0) {</span>
            // drop entities on the surface into the water
<span class="nc bnc" id="L34540" title="All 2 branches missed.">            for (Entity e : game.getEntitiesVector(c)) {</span>
                // If the unit is on the surface, and is no longer allowed in
                // the hex
<span class="nc bnc" id="L34543" title="All 2 branches missed.">                boolean isHoverOrWiGE = (e.getMovementMode() == EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L34544" title="All 2 branches missed.">                        || (e.getMovementMode() == EntityMovementMode.WIGE);</span>
<span class="nc bnc" id="L34545" title="All 2 branches missed.">                if ((e.getElevation() == 0)</span>
<span class="nc bnc" id="L34546" title="All 4 branches missed.">                        &amp;&amp; !(hex.containsTerrain(Terrains.BLDG_ELEV, 0))</span>
<span class="nc bnc" id="L34547" title="All 2 branches missed.">                        &amp;&amp; !(isHoverOrWiGE &amp;&amp; (e.getRunMP() &gt;= 0))</span>
<span class="nc bnc" id="L34548" title="All 2 branches missed.">                        &amp;&amp; (e.getMovementMode() != EntityMovementMode.INF_UMU)</span>
<span class="nc bnc" id="L34549" title="All 4 branches missed.">                        &amp;&amp; !e.hasUMU()</span>
<span class="nc bnc" id="L34550" title="All 2 branches missed.">                        &amp;&amp; !(e instanceof QuadVee &amp;&amp; e.getConversionMode() == QuadVee.CONV_MODE_VEHICLE)) {</span>
<span class="nc" id="L34551">                    vPhaseReport.addAll(doEntityFallsInto(e, c,</span>
                            new PilotingRollData(TargetRoll.AUTOMATIC_FAIL),
                            true));
                }
<span class="nc" id="L34555">            }</span>
        }
<span class="nc" id="L34557">        return vPhaseReport;</span>
    }

    /**
     * melt any snow or ice in a hex, including checking for the effects of
     * breaking through ice
     */
    private Vector&lt;Report&gt; meltIceAndSnow(Coords c, int entityId) {
<span class="nc" id="L34565">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L34567">        IHex hex = game.getBoard().getHex(c);</span>
<span class="nc" id="L34568">        r = new Report(3069);</span>
<span class="nc" id="L34569">        r.indent(2);</span>
<span class="nc" id="L34570">        r.subject = entityId;</span>
<span class="nc" id="L34571">        vDesc.add(r);</span>
<span class="nc bnc" id="L34572" title="All 2 branches missed.">        if (hex.containsTerrain(Terrains.SNOW)) {</span>
<span class="nc" id="L34573">            hex.removeTerrain(Terrains.SNOW);</span>
<span class="nc" id="L34574">            sendChangedHex(c);</span>
        }
<span class="nc bnc" id="L34576" title="All 2 branches missed.">        if (hex.containsTerrain(Terrains.ICE)) {</span>
<span class="nc" id="L34577">            vDesc.addAll(resolveIceBroken(c));</span>
        }
        // if we were not in water, then add mud
<span class="nc bnc" id="L34580" title="All 2 branches missed.">        if (!hex.containsTerrain(Terrains.MUD)</span>
<span class="nc bnc" id="L34581" title="All 2 branches missed.">            &amp;&amp; !hex.containsTerrain(Terrains.WATER)) {</span>
<span class="nc" id="L34582">            hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                    Terrains.MUD, 1));
<span class="nc" id="L34584">            sendChangedHex(c);</span>
        }
<span class="nc" id="L34586">        return vDesc;</span>
    }

    /**
     * check to see if a swamp hex becomes quicksand
     */
    private Vector&lt;Report&gt; checkQuickSand(Coords c) {
<span class="nc" id="L34593">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc" id="L34595">        IHex hex = game.getBoard().getHex(c);</span>
<span class="nc bnc" id="L34596" title="All 2 branches missed.">        if (hex.terrainLevel(Terrains.SWAMP) == 1) {</span>
<span class="nc bnc" id="L34597" title="All 2 branches missed.">            if (Compute.d6(2) == 12) {</span>
                // better find a rope
<span class="nc" id="L34599">                hex.removeTerrain(Terrains.SWAMP);</span>
<span class="nc" id="L34600">                hex.addTerrain(Terrains.getTerrainFactory().createTerrain(Terrains.SWAMP, 2));</span>
<span class="nc" id="L34601">                sendChangedHex(c);</span>
<span class="nc" id="L34602">                r = new Report(2440);</span>
<span class="nc" id="L34603">                r.indent(1);</span>
<span class="nc" id="L34604">                vDesc.add(r);</span>
            }
        }
<span class="nc" id="L34607">        return vDesc;</span>
    }

    /**
     * check for vehicle fire, according to the MaxTech rules
     *
     * @param tank    the &lt;code&gt;Tank&lt;/code&gt; to be checked
     * @param inferno a &lt;code&gt;boolean&lt;/code&gt; parameter whether or not this check is
     *                because of inferno fire
     */
    public Vector&lt;Report&gt; checkForVehicleFire(Tank tank, boolean inferno) {
<span class="nc" id="L34618">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L34619">        int boomRoll = Compute.d6(2);</span>
<span class="nc" id="L34620">        int penalty = 0;</span>
<span class="nc bnc" id="L34621" title="All 3 branches missed.">        switch (tank.getMovementMode()) {</span>
            case HOVER:
<span class="nc" id="L34623">                penalty = 4;</span>
<span class="nc" id="L34624">                break;</span>
            case VTOL:
            case WHEELED:
<span class="nc" id="L34627">                penalty = 2;</span>
<span class="nc" id="L34628">                break;</span>
            default:
                break;
        }
<span class="nc bnc" id="L34632" title="All 2 branches missed.">        if (inferno) {</span>
<span class="nc" id="L34633">            boomRoll = 12;</span>
        }
<span class="nc" id="L34635">        Report r = new Report(5250);</span>
<span class="nc" id="L34636">        r.subject = tank.getId();</span>
<span class="nc" id="L34637">        r.addDesc(tank);</span>
<span class="nc" id="L34638">        r.add(8 - penalty);</span>
<span class="nc" id="L34639">        r.add(boomRoll);</span>
<span class="nc bnc" id="L34640" title="All 2 branches missed.">        if ((boomRoll + penalty) &lt; 8) {</span>
            // phew!
<span class="nc" id="L34642">            r.choose(true);</span>
<span class="nc" id="L34643">            vPhaseReport.add(r);</span>
        } else {
            // eek
<span class="nc bnc" id="L34646" title="All 2 branches missed.">            if (!inferno) {</span>
<span class="nc" id="L34647">                r.choose(false);</span>
<span class="nc" id="L34648">                vPhaseReport.add(r);</span>
            }
<span class="nc bnc" id="L34650" title="All 2 branches missed.">            if ((boomRoll + penalty) &lt; 10) {</span>
<span class="nc" id="L34651">                addReport(vehicleMotiveDamage(tank, penalty - 1));</span>
            } else {
<span class="nc" id="L34653">                vPhaseReport.addAll(resolveVehicleFire(tank, false));</span>
<span class="nc bnc" id="L34654" title="All 2 branches missed.">                if ((boomRoll + penalty) &gt;= 12) {</span>
<span class="nc" id="L34655">                    r = new Report(5255);</span>
<span class="nc" id="L34656">                    r.subject = tank.getId();</span>
<span class="nc" id="L34657">                    r.indent(3);</span>
<span class="nc" id="L34658">                    vPhaseReport.add(r);</span>
<span class="nc" id="L34659">                    tank.setOnFire(inferno);</span>
                }
            }
        }
<span class="nc" id="L34663">        return vPhaseReport;</span>
    }

    private Vector&lt;Report&gt; resolveVehicleFire(Tank tank, boolean existingStatus) {
<span class="nc" id="L34667">        Vector&lt;Report&gt; vPhaseReport = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L34668" title="All 4 branches missed.">        if (existingStatus &amp;&amp; !tank.isOnFire()) {</span>
<span class="nc" id="L34669">            return vPhaseReport;</span>
        }
<span class="nc bnc" id="L34671" title="All 2 branches missed.">        for (int i = 0; i &lt; tank.locations(); i++) {</span>
<span class="nc bnc" id="L34672" title="All 6 branches missed.">            if ((i == Tank.LOC_BODY) || ((tank instanceof VTOL) &amp;&amp; (i == VTOL.LOC_ROTOR))) {</span>
<span class="nc" id="L34673">                continue;</span>
            }
<span class="nc bnc" id="L34675" title="All 4 branches missed.">            if (existingStatus &amp;&amp; !tank.isLocationBurning(i)) {</span>
<span class="nc" id="L34676">                continue;</span>
            }
<span class="nc" id="L34678">            HitData hit = new HitData(i);</span>
<span class="nc" id="L34679">            int damage = Compute.d6(1);</span>
<span class="nc" id="L34680">            vPhaseReport.addAll(damageEntity(tank, hit, damage));</span>
<span class="nc bnc" id="L34681" title="All 4 branches missed.">            if ((damage == 1) &amp;&amp; existingStatus) {</span>
<span class="nc" id="L34682">                tank.extinguishLocation(i);</span>
            }
        }
<span class="nc" id="L34685">        return vPhaseReport;</span>
    }

    public Vector&lt;Report&gt; vehicleMotiveDamage(Tank te, int modifier) {
<span class="nc" id="L34689">        return vehicleMotiveDamage(te, modifier, false, -1, false);</span>
    }

    private Vector&lt;Report&gt; vehicleMotiveDamage(Tank te, int modifier, boolean noRoll,
                                               int damageType) {
<span class="nc" id="L34694">        return vehicleMotiveDamage(te, modifier, noRoll, damageType, false);</span>
    }

    /**
     * do vehicle movement damage
     *
     * @param te         the Tank to damage
     * @param modifier   the modifier to the roll
     * @param noRoll     don't roll, immediately deal damage
     * @param damageType the type to deal (1 = minor, 2 = moderate, 3 = heavy
     * @param jumpDamage is this a movement damage roll from using vehicular JJs
     * @return a &lt;code&gt;Vector&lt;Report&gt;&lt;/code&gt; containing what to add to the turn log
     */
    private Vector&lt;Report&gt; vehicleMotiveDamage(Tank te, int modifier, boolean noRoll,
                                               int damageType, boolean jumpDamage) {
<span class="nc" id="L34709">        Vector&lt;Report&gt; vDesc = new Vector&lt;&gt;();</span>
        Report r;
<span class="nc bnc" id="L34711" title="All 6 branches missed.">        switch (te.getMovementMode()) {</span>
            case HOVER:
            case HYDROFOIL:
<span class="nc bnc" id="L34714" title="All 2 branches missed.">                if (jumpDamage) {</span>
<span class="nc" id="L34715">                    modifier -= 1;</span>
                } else {
<span class="nc" id="L34717">                    modifier += 3;</span>
                }
<span class="nc" id="L34719">                break;</span>
            case WHEELED:
<span class="nc bnc" id="L34721" title="All 2 branches missed.">                if (jumpDamage) {</span>
<span class="nc" id="L34722">                    modifier += 1;</span>
                } else {
<span class="nc" id="L34724">                    modifier += 2;</span>
                }
<span class="nc" id="L34726">                break;</span>
            case WIGE:
<span class="nc bnc" id="L34728" title="All 2 branches missed.">                if (jumpDamage) {</span>
<span class="nc" id="L34729">                    modifier -= 2;</span>
                } else {
<span class="nc" id="L34731">                    modifier += 4;</span>
                }
<span class="nc" id="L34733">                break;</span>
            case TRACKED:
<span class="nc bnc" id="L34735" title="All 2 branches missed.">                if (jumpDamage) {</span>
<span class="nc" id="L34736">                    modifier += 2;</span>
                }
                break;
            case VTOL:
                // VTOL don't roll, auto -1 MP as long as the rotor location
                // still exists (otherwise don't bother reporting).
<span class="nc bnc" id="L34742" title="All 4 branches missed.">                if (!(te.isLocationBad(VTOL.LOC_ROTOR) || te.isLocationDoomed(VTOL.LOC_ROTOR))) {</span>
<span class="nc" id="L34743">                    te.setMotiveDamage(te.getMotiveDamage() + 1);</span>
<span class="nc bnc" id="L34744" title="All 2 branches missed.">                    if (te.getOriginalWalkMP() &gt; te.getMotiveDamage()) {</span>
<span class="nc" id="L34745">                        r = new Report(6660);</span>
<span class="nc" id="L34746">                        r.indent(3);</span>
<span class="nc" id="L34747">                        r.subject = te.getId();</span>
<span class="nc" id="L34748">                        vDesc.add(r);</span>
                    } else {
<span class="nc" id="L34750">                        r = new Report(6670);</span>
<span class="nc" id="L34751">                        r.subject = te.getId();</span>
<span class="nc" id="L34752">                        vDesc.add(r);</span>
<span class="nc" id="L34753">                        te.immobilize();</span>
                        // Being reduced to 0 MP by rotor damage forces a
                        // landing
                        // like an engine hit...
<span class="nc bnc" id="L34757" title="All 2 branches missed.">                        if (te.isAirborneVTOLorWIGE()</span>
                            // ...but don't bother to resolve that if we're
                            // already otherwise destroyed.
<span class="nc bnc" id="L34760" title="All 4 branches missed.">                            &amp;&amp; !(te.isDestroyed() || te.isDoomed())) {</span>
<span class="nc" id="L34761">                            vDesc.addAll(forceLandVTOLorWiGE(te));</span>
                        }
                    }
                }
                // This completes our handling of VTOLs; the rest of the method
                // doesn't need to worry about them anymore.
<span class="nc" id="L34767">                return vDesc;</span>
            default:
                break;
        }
        // Apply vehicle effectiveness...except for jumps.
<span class="nc bnc" id="L34772" title="All 4 branches missed.">        if (game.getOptions().booleanOption(OptionsConstants.ADVCOMBAT_TACOPS_VEHICLE_EFFECTIVE)</span>
                &amp;&amp; !jumpDamage) {
<span class="nc" id="L34774">            modifier = Math.max(modifier - 1, 0);</span>
        }

<span class="nc bnc" id="L34777" title="All 2 branches missed.">        if (te.hasWorkingMisc(MiscType.F_ARMORED_MOTIVE_SYSTEM)) {</span>
<span class="nc" id="L34778">            modifier -= 2;</span>
        }
<span class="nc" id="L34780">        int roll = Compute.d6(2) + modifier;</span>
<span class="nc" id="L34781">        r = new Report(6306);</span>
<span class="nc" id="L34782">        r.subject = te.getId();</span>
<span class="nc" id="L34783">        r.newlines = 0;</span>
<span class="nc" id="L34784">        r.indent(3);</span>
<span class="nc" id="L34785">        vDesc.add(r);</span>
<span class="nc bnc" id="L34786" title="All 2 branches missed.">        if (!noRoll) {</span>
<span class="nc" id="L34787">            r = new Report(6310);</span>
<span class="nc" id="L34788">            r.subject = te.getId();</span>
<span class="nc" id="L34789">            r.add(roll);</span>
<span class="nc" id="L34790">            r.newlines = 0;</span>
<span class="nc" id="L34791">            vDesc.add(r);</span>
<span class="nc" id="L34792">            r = new Report(3340);</span>
<span class="nc" id="L34793">            r.add(modifier);</span>
<span class="nc" id="L34794">            r.subject = te.getId();</span>
<span class="nc" id="L34795">            vDesc.add(r);</span>
        }

<span class="nc bnc" id="L34798" title="All 8 branches missed.">        if ((noRoll &amp;&amp; (damageType == 0)) || (!noRoll &amp;&amp; (roll &lt;= 5))) {</span>
            // no effect
<span class="nc" id="L34800">            r = new Report(6005);</span>
<span class="nc" id="L34801">            r.subject = te.getId();</span>
<span class="nc" id="L34802">            r.indent(3);</span>
<span class="nc" id="L34803">            vDesc.add(r);</span>
<span class="nc bnc" id="L34804" title="All 8 branches missed.">        } else if ((noRoll &amp;&amp; (damageType == 1)) || (!noRoll &amp;&amp; (roll &lt;= 7))) {</span>
            // minor damage
<span class="nc" id="L34806">            r = new Report(6470);</span>
<span class="nc" id="L34807">            r.subject = te.getId();</span>
<span class="nc" id="L34808">            r.indent(3);</span>
<span class="nc" id="L34809">            vDesc.add(r);</span>
<span class="nc" id="L34810">            te.addMovementDamage(1);</span>
<span class="nc bnc" id="L34811" title="All 8 branches missed.">        } else if ((noRoll &amp;&amp; (damageType == 2)) || (!noRoll &amp;&amp; (roll &lt;= 9))) {</span>
            // moderate damage
<span class="nc" id="L34813">            r = new Report(6471);</span>
<span class="nc" id="L34814">            r.subject = te.getId();</span>
<span class="nc" id="L34815">            r.indent(3);</span>
<span class="nc" id="L34816">            vDesc.add(r);</span>
<span class="nc" id="L34817">            te.addMovementDamage(2);</span>
<span class="nc bnc" id="L34818" title="All 8 branches missed.">        } else if ((noRoll &amp;&amp; (damageType == 3)) || (!noRoll &amp;&amp; (roll &lt;= 11))) {</span>
            // heavy damage
<span class="nc" id="L34820">            r = new Report(6472);</span>
<span class="nc" id="L34821">            r.subject = te.getId();</span>
<span class="nc" id="L34822">            r.indent(3);</span>
<span class="nc" id="L34823">            vDesc.add(r);</span>
<span class="nc" id="L34824">            te.addMovementDamage(3);</span>
        } else {
<span class="nc" id="L34826">            r = new Report(6473);</span>
<span class="nc" id="L34827">            r.subject = te.getId();</span>
<span class="nc" id="L34828">            r.indent(3);</span>
<span class="nc" id="L34829">            vDesc.add(r);</span>
<span class="nc" id="L34830">            te.addMovementDamage(4);</span>
        }
        // These checks should perhaps be moved to Tank.applyDamage(), but I'm
        // unsure how to *report* any outcomes from there. Note that these treat
        // being reduced to 0 MP and being actually immobilized as the same thing,
        // which for these particular purposes may or may not be the intent of
        // the rules in all cases.
        // Immobile hovercraft on water sink...
<span class="nc bnc" id="L34838" title="All 2 branches missed.">        if (((te.getMovementMode() == EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L34839" title="All 4 branches missed.">                || ((te.getMovementMode() == EntityMovementMode.WIGE) &amp;&amp; (te.getElevation() == 0)))</span>
<span class="nc bnc" id="L34840" title="All 4 branches missed.">                &amp;&amp; (te.isMovementHitPending() || (te.getWalkMP() &lt;= 0))</span>
                // HACK: Have to check for *pending* hit here and below.
<span class="nc bnc" id="L34842" title="All 2 branches missed.">                &amp;&amp; (game.getBoard().getHex(te.getPosition()).terrainLevel(Terrains.WATER) &gt; 0)</span>
<span class="nc bnc" id="L34843" title="All 2 branches missed.">                &amp;&amp; !game.getBoard().getHex(te.getPosition()).containsTerrain(Terrains.ICE)) {</span>
<span class="nc" id="L34844">            vDesc.addAll(destroyEntity(te, &quot;a watery grave&quot;, false));</span>
        }
        // ...while immobile WiGEs crash.
<span class="nc bnc" id="L34847" title="All 4 branches missed.">        if (((te.getMovementMode() == EntityMovementMode.WIGE) &amp;&amp; (te.isAirborneVTOLorWIGE()))</span>
<span class="nc bnc" id="L34848" title="All 4 branches missed.">                &amp;&amp; (te.isMovementHitPending() || (te.getWalkMP() &lt;= 0))) {</span>
            // report problem: add tab
<span class="nc" id="L34850">            vDesc.addAll(crashVTOLorWiGE(te));</span>
        }
<span class="nc" id="L34852">        return vDesc;</span>
    }

    /**
     * Add a whole lotta Reports to the players report queues as well as the
     * Master report queue vPhaseReport.
     */
    private void addReport(Vector&lt;Report&gt; reports) {
<span class="nc" id="L34860">        vPhaseReport.addAll(reports);</span>
<span class="nc" id="L34861">    }</span>

    /**
     * Add a whole lotta Reports to the players report queues as well as the
     * Master report queue vPhaseReport, indenting each report by the passed
     * value.
     */
    private void addReport(Vector&lt;Report&gt; reports, int indents) {
<span class="nc bnc" id="L34869" title="All 2 branches missed.">        for (Report r : reports) {</span>
<span class="nc" id="L34870">            r.indent(indents);</span>
<span class="nc" id="L34871">            vPhaseReport.add(r);</span>
<span class="nc" id="L34872">        }</span>
<span class="nc" id="L34873">    }</span>

    /**
     * Add a single report to the report queue of all players and the master
     * vPhaseReport queue
     */
    private void addReport(Report report) {
<span class="nc" id="L34880">        vPhaseReport.addElement(report);</span>
<span class="nc" id="L34881">    }</span>

    /**
     * New Round has started clear everyone's report queue
     */
    private void clearReports() {
<span class="nc" id="L34887">        vPhaseReport.removeAllElements();</span>
<span class="nc" id="L34888">    }</span>

    /**
     * make sure all the new lines that were added to the old vPhaseReport get
     * added to all of the players filters
     */
    private void addNewLines() {
<span class="nc" id="L34895">        Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L34896">    }</span>

    /**
     * resolve the landing of an assault drop
     *
     * @param entity the &lt;code&gt;Entity&lt;/code&gt; for which to resolve it
     */
    public void doAssaultDrop(Entity entity) {
        //resolve according to SO p.22

<span class="nc" id="L34906">        Report r = new Report(2380);</span>

        // whatever else happens, this entity is on the ground now
<span class="nc" id="L34909">        entity.setAltitude(0);</span>

        PilotingRollData psr;
        // LAMs that convert to fighter mode on the landing turn are processed as crashes
<span class="nc bnc" id="L34913" title="All 2 branches missed.">        if ((entity instanceof LandAirMech)</span>
<span class="nc bnc" id="L34914" title="All 2 branches missed.">                &amp;&amp; (entity.getConversionMode() == LandAirMech.CONV_MODE_FIGHTER)) {</span>
<span class="nc" id="L34915">            addReport(processCrash(entity, 0, entity.getPosition()));</span>
<span class="nc" id="L34916">            return;</span>
        }
<span class="nc bnc" id="L34918" title="All 4 branches missed.">        if ((entity instanceof Protomech) || (entity instanceof BattleArmor)) {</span>
<span class="nc" id="L34919">            psr = new PilotingRollData(entity.getId(), 5, &quot;landing assault drop&quot;);</span>
<span class="nc bnc" id="L34920" title="All 2 branches missed.">        } else if (entity instanceof Infantry) {</span>
<span class="nc" id="L34921">            psr = new PilotingRollData(entity.getId(), 4, &quot;landing assault drop&quot;);</span>
        } else {
<span class="nc" id="L34923">            psr = entity.getBasePilotingRoll();</span>
        }
<span class="nc" id="L34925">        int roll = Compute.d6(2);</span>
        // check for a safe landing
<span class="nc" id="L34927">        addNewLines();</span>
<span class="nc" id="L34928">        r.subject = entity.getId();</span>
<span class="nc" id="L34929">        r.add(entity.getDisplayName(), true);</span>
<span class="nc" id="L34930">        r.add(psr.getValueAsString());</span>
<span class="nc" id="L34931">        r.add(roll);</span>
<span class="nc" id="L34932">        r.newlines = 1;</span>
<span class="nc bnc" id="L34933" title="All 2 branches missed.">        r.choose(roll &gt;= psr.getValue());</span>
<span class="nc" id="L34934">        addReport(r);</span>

        // if we are on an atmospheric map or the entity is off the map for some reason
<span class="nc bnc" id="L34937" title="All 4 branches missed.">        if (game.getBoard().inAtmosphere() || entity.getPosition() == null) {</span>
            // then just remove the entity
            // TODO : for this and when the unit scatters off the board, we should really still
            // TODO : apply damage before we remove, but this causes all kinds of problems for
            // TODO : doEntityFallsInto and related methods which expect a coord on the board
            // TODO : - need to make those more robust
<span class="nc" id="L34943">            r = new Report(2388);</span>
<span class="nc" id="L34944">            addReport(r);</span>
<span class="nc" id="L34945">            r.subject = entity.getId();</span>
<span class="nc" id="L34946">            r.add(entity.getDisplayName(), true);</span>
<span class="nc" id="L34947">            game.removeEntity(entity.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT);</span>
<span class="nc" id="L34948">            return;</span>
        }

<span class="nc bnc" id="L34951" title="All 2 branches missed.">        if (roll &lt; psr.getValue()) {</span>
<span class="nc" id="L34952">            int fallHeight = psr.getValue() - roll;</span>

            // if you fail by more than 7, you automatically fail
<span class="nc bnc" id="L34955" title="All 2 branches missed.">            if (fallHeight &gt; 7) {</span>
<span class="nc" id="L34956">                addReport(destroyEntity(entity, &quot;failed assault drop&quot;, false, false));</span>
<span class="nc" id="L34957">                entityUpdate(entity.getId());</span>
<span class="nc" id="L34958">                return;</span>
            }

            // determine where we really land
<span class="nc" id="L34962">            Coords c = Compute.scatterAssaultDrop(entity.getPosition(), fallHeight);</span>
<span class="nc" id="L34963">            int distance = entity.getPosition().distance(c);</span>
<span class="nc" id="L34964">            r = new Report(2385);</span>
<span class="nc" id="L34965">            r.subject = entity.getId();</span>
<span class="nc" id="L34966">            r.add(distance);</span>
<span class="nc" id="L34967">            r.indent();</span>
<span class="nc" id="L34968">            r.newlines = 0;</span>
<span class="nc" id="L34969">            addReport(r);</span>
<span class="nc bnc" id="L34970" title="All 2 branches missed.">            if (!game.getBoard().contains(c)) {</span>
<span class="nc" id="L34971">                r = new Report(2386);</span>
<span class="nc" id="L34972">                addReport(r);</span>
<span class="nc" id="L34973">                game.removeEntity(entity.getId(), IEntityRemovalConditions.REMOVE_IN_RETREAT);</span>
<span class="nc" id="L34974">                return;</span>
            } else {
<span class="nc" id="L34976">                r = new Report(2387);</span>
<span class="nc" id="L34977">                r.add(c.getBoardNum());</span>
<span class="nc" id="L34978">                addReport(r);</span>
            }
<span class="nc" id="L34980">            entity.setPosition(c);</span>

            // do fall damage from accidental fall
            //set elevation to fall height above ground or building roof
<span class="nc" id="L34984">            IHex hex = game.getBoard().getHex(entity.getPosition());</span>
<span class="nc bnc" id="L34985" title="All 2 branches missed.">            int bldgElev = hex.containsTerrain(Terrains.BLDG_ELEV)</span>
<span class="nc" id="L34986">                    ? hex.terrainLevel(Terrains.BLDG_ELEV) : 0;</span>
<span class="nc" id="L34987">            entity.setElevation(fallHeight + bldgElev);</span>
<span class="nc bnc" id="L34988" title="All 4 branches missed.">            if ((entity instanceof Infantry) &amp;&amp; !(entity instanceof BattleArmor)) {</span>
<span class="nc" id="L34989">                HitData hit = new HitData(Infantry.LOC_INFANTRY);</span>
<span class="nc" id="L34990">                addReport(damageEntity(entity, hit, 1));</span>
                // LAMs that convert to fighter mode on the landing turn are processed as crashes regardless of roll
<span class="nc" id="L34992">            } else {</span>
<span class="nc" id="L34993">                addReport(doEntityFallsInto(entity, c, psr, true));</span>
            }
<span class="nc" id="L34995">        } else {</span>
            // set entity to expected elevation
<span class="nc" id="L34997">            IHex hex = game.getBoard().getHex(entity.getPosition());</span>
<span class="nc bnc" id="L34998" title="All 2 branches missed.">            int bldgElev = hex.containsTerrain(Terrains.BLDG_ELEV)</span>
<span class="nc" id="L34999">                    ? hex.terrainLevel(Terrains.BLDG_ELEV) : 0;</span>
<span class="nc" id="L35000">            entity.setElevation(bldgElev);</span>

<span class="nc" id="L35002">            Building bldg = game.getBoard().getBuildingAt(entity.getPosition());</span>
<span class="nc bnc" id="L35003" title="All 2 branches missed.">            if (bldg != null) {</span>
                // whoops we step on the roof
<span class="nc" id="L35005">                checkBuildingCollapseWhileMoving(bldg, entity, entity.getPosition());</span>
            }

            // finally, check for any stacking violations
<span class="nc" id="L35009">            Entity violated = Compute.stackingViolation(game, entity, entity.getPosition(), null);</span>
<span class="nc bnc" id="L35010" title="All 2 branches missed.">            if (violated != null) {</span>
                // StratOps explicitly says that this is not treated as an accident
                // fall from above
                // so we just need to displace the violating unit
                // check to see if the violating unit is a DropShip and if so, then
                // displace the unit dropping instead
<span class="nc bnc" id="L35016" title="All 2 branches missed.">                if (violated instanceof Dropship) {</span>
<span class="nc" id="L35017">                    violated = entity;</span>
                }
<span class="nc" id="L35019">                Coords targetDest = Compute.getValidDisplacement(game, violated.getId(),</span>
<span class="nc" id="L35020">                        violated.getPosition(), Compute.d6() - 1);</span>
<span class="nc bnc" id="L35021" title="All 2 branches missed.">                if (null != targetDest) {</span>
<span class="nc" id="L35022">                    doEntityDisplacement(violated, violated.getPosition(), targetDest, null);</span>
<span class="nc" id="L35023">                    entityUpdate(violated.getId());</span>
                } else {
                    // ack! automatic death! Tanks
                    // suffer an ammo/power plant hit.
                    // TODO : a Mech suffers a Head Blown Off crit.
<span class="nc" id="L35028">                    vPhaseReport.addAll(destroyEntity(entity, &quot;impossible displacement&quot;,</span>
                            entity instanceof Mech, entity instanceof Mech));
                }
            }
        }
<span class="nc" id="L35033">    }</span>

    /**
     * resolve assault drops for all entities
     */
    void doAllAssaultDrops() {
<span class="nc bnc" id="L35039" title="All 2 branches missed.">        for (Entity e : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L35040" title="All 2 branches missed.">            if (e.isAssaultDropInProgress()) {</span>
<span class="nc" id="L35041">                doAssaultDrop(e);</span>
<span class="nc" id="L35042">                e.setLandedAssaultDrop();</span>
            }
<span class="nc" id="L35044">        }</span>
<span class="nc" id="L35045">    }</span>

    /**
     * do damage from magma
     *
     * @param en       the affected &lt;code&gt;Entity&lt;/code&gt;
     * @param eruption &lt;code&gt;boolean&lt;/code&gt; indicating whether or not this is because
     *                 of an eruption
     */
    void doMagmaDamage(Entity en, boolean eruption) {
<span class="nc bnc" id="L35055" title="All 4 branches missed.">        if ((((en.getMovementMode() == EntityMovementMode.VTOL) &amp;&amp; (en.getElevation() &gt; 0))</span>
<span class="nc bnc" id="L35056" title="All 2 branches missed.">                || (en.getMovementMode() == EntityMovementMode.HOVER)</span>
<span class="nc bnc" id="L35057" title="All 2 branches missed.">                || ((en.getMovementMode() == EntityMovementMode.WIGE)</span>
<span class="nc bnc" id="L35058" title="All 6 branches missed.">                &amp;&amp; (en.getOriginalWalkMP() &gt; 0) &amp;&amp; !eruption)) &amp;&amp; !en.isImmobile()) {</span>
<span class="nc" id="L35059">            return;</span>
        }
        Report r;
<span class="nc" id="L35062">        boolean isMech = en instanceof Mech;</span>
<span class="nc bnc" id="L35063" title="All 2 branches missed.">        if (isMech) {</span>
<span class="nc" id="L35064">            r = new Report(2405);</span>
        } else {
<span class="nc" id="L35066">            r = new Report(2400);</span>
        }
<span class="nc" id="L35068">        r.addDesc(en);</span>
<span class="nc" id="L35069">        r.subject = en.getId();</span>
<span class="nc" id="L35070">        addReport(r);</span>
<span class="nc bnc" id="L35071" title="All 2 branches missed.">        if (isMech) {</span>
            HitData h;
<span class="nc bnc" id="L35073" title="All 2 branches missed.">            for (int i = 0; i &lt; en.locations(); i++) {</span>
<span class="nc bnc" id="L35074" title="All 6 branches missed.">                if (eruption || en.locationIsLeg(i) || en.isProne()) {</span>
<span class="nc" id="L35075">                    h = new HitData(i);</span>
<span class="nc" id="L35076">                    addReport(damageEntity(en, h, Compute.d6(2)));</span>
                }
            }
        } else {
<span class="nc" id="L35080">            addReport(destroyEntity(en, &quot;fell into magma&quot;, false, false));</span>
        }
<span class="nc" id="L35082">        addNewLines();</span>
<span class="nc" id="L35083">    }</span>

    /**
     * sink any entities in quicksand in the current hex
     */
    public void doSinkEntity(Entity en) {
        Report r;
<span class="nc" id="L35090">        r = new Report(2445);</span>
<span class="nc" id="L35091">        r.addDesc(en);</span>
<span class="nc" id="L35092">        r.subject = en.getId();</span>
<span class="nc" id="L35093">        addReport(r);</span>
<span class="nc" id="L35094">        en.setElevation(en.getElevation() - 1);</span>
        // if this means the entity is below the ground, then bye-bye!
<span class="nc bnc" id="L35096" title="All 2 branches missed.">        if (Math.abs(en.getElevation()) &gt; en.getHeight()) {</span>
<span class="nc" id="L35097">            addReport(destroyEntity(en, &quot;quicksand&quot;));</span>
        }
<span class="nc" id="L35099">    }</span>

    /**
     * deal area saturation damage to an individual hex
     *
     * @param coords         The hex being hit
     * @param attackSource   The location the attack came from. For hit table resolution
     * @param damage         Amount of damage to deal to each entity
     * @param ammo           The ammo type being used
     * @param subjectId      Subject for reports
     * @param killer         Who should be credited with kills
     * @param exclude        Entity that should take no damage (used for homing splash)
     * @param flak           Flak, hits flying units only, instead of flyers being immune
     * @param altitude       Absolute altitude for flak attack
     * @param vPhaseReport   The Vector of Reports for the phase report
     * @param asfFlak        Is this flak against ASF?
     * @param alreadyHit     a vector of unit ids for units that have already been hit that
     *                       will be ignored
     * @param variableDamage if true, treat damage as the number of six-sided dice to roll
     */
    public Vector&lt;Integer&gt; artilleryDamageHex(Coords coords,
            Coords attackSource, int damage, AmmoType ammo, int subjectId,
            Entity killer, Entity exclude, boolean flak, int altitude,
            Vector&lt;Report&gt; vPhaseReport, boolean asfFlak,
            Vector&lt;Integer&gt; alreadyHit, boolean variableDamage) {

<span class="nc" id="L35125">        IHex hex = game.getBoard().getHex(coords);</span>
<span class="nc bnc" id="L35126" title="All 2 branches missed.">        if (hex == null) {</span>
<span class="nc" id="L35127">            return alreadyHit; // not on board.</span>
        }

        Report r;

        // Non-flak artillery damages terrain
<span class="nc bnc" id="L35133" title="All 2 branches missed.">        if (!flak) {</span>
            // Report that damage applied to terrain, if there's TF to damage
<span class="nc" id="L35135">            IHex h = game.getBoard().getHex(coords);</span>
<span class="nc bnc" id="L35136" title="All 4 branches missed.">            if ((h != null) &amp;&amp; h.hasTerrainfactor()) {</span>
<span class="nc" id="L35137">                r = new Report(3384);</span>
<span class="nc" id="L35138">                r.indent(2);</span>
<span class="nc" id="L35139">                r.subject = subjectId;</span>
<span class="nc" id="L35140">                r.add(coords.getBoardNum());</span>
<span class="nc" id="L35141">                r.add(damage * 2);</span>
<span class="nc" id="L35142">                vPhaseReport.addElement(r);</span>
            }
            // Update hex and report any changes
<span class="nc" id="L35145">            Vector&lt;Report&gt; newReports = tryClearHex(coords, damage * 2, subjectId);</span>
<span class="nc bnc" id="L35146" title="All 2 branches missed.">            for (Report nr : newReports) {</span>
<span class="nc" id="L35147">                nr.indent(3);</span>
<span class="nc" id="L35148">            }</span>
<span class="nc" id="L35149">            vPhaseReport.addAll(newReports);</span>
        }
        
<span class="nc bnc" id="L35152" title="All 2 branches missed.">        boolean isFuelAirBomb = </span>
                ammo != null &amp;&amp;
<span class="nc bnc" id="L35154" title="All 2 branches missed.">                (BombType.getBombTypeFromInternalName(ammo.getInternalName()) == BombType.B_FAE_SMALL ||</span>
<span class="nc bnc" id="L35155" title="All 2 branches missed.">                BombType.getBombTypeFromInternalName(ammo.getInternalName()) == BombType.B_FAE_LARGE);</span>
        
<span class="nc" id="L35157">        Building bldg = game.getBoard().getBuildingAt(coords);</span>
<span class="nc" id="L35158">        int bldgAbsorbs = 0;</span>
<span class="nc bnc" id="L35159" title="All 4 branches missed.">        if ((bldg != null)</span>
<span class="nc bnc" id="L35160" title="All 2 branches missed.">                &amp;&amp; !(flak &amp;&amp; (((altitude &gt; hex.terrainLevel(Terrains.BLDG_ELEV))</span>
<span class="nc bnc" id="L35161" title="All 2 branches missed.">                || (altitude &gt; hex.terrainLevel(Terrains.BRIDGE_ELEV)))))) {</span>
<span class="nc" id="L35162">            bldgAbsorbs = bldg.getAbsorbtion(coords);</span>
<span class="nc bnc" id="L35163" title="All 4 branches missed.">            if (!((ammo != null) &amp;&amp; (ammo.getMunitionType() == AmmoType.M_FLECHETTE))) {</span>
<span class="nc" id="L35164">                int actualDamage = damage;</span>
                
<span class="nc bnc" id="L35166" title="All 2 branches missed.">                if(isFuelAirBomb) {</span>
                    // light buildings take 1.5x damage from fuel-air bombs
<span class="nc bnc" id="L35168" title="All 2 branches missed.">                    if(bldg.getType() == Building.LIGHT) {</span>
<span class="nc" id="L35169">                        actualDamage = (int) Math.ceil(actualDamage * 1.5);</span>
                        
<span class="nc" id="L35171">                        r = new Report(9991);</span>
<span class="nc" id="L35172">                        r.indent(1);</span>
<span class="nc" id="L35173">                        r.subject = killer.getId();</span>
<span class="nc" id="L35174">                        r.newlines = 1;</span>
<span class="nc" id="L35175">                        vPhaseReport.addElement(r);</span>
                    } 

                    // armored and &quot;castle brian&quot; buildings take .5 damage from fuel-air bombs
                    // but I have no idea how to determine if a building is a castle or a brian
                    // note that being armored and being &quot;light&quot; are not mutually exclusive
<span class="nc bnc" id="L35181" title="All 2 branches missed.">                    if(bldg.getArmor(coords) &gt; 0) {</span>
<span class="nc" id="L35182">                        actualDamage = (int) Math.floor(actualDamage * .5);</span>
                        
<span class="nc" id="L35184">                        r = new Report(9992);</span>
<span class="nc" id="L35185">                        r.indent(1);</span>
<span class="nc" id="L35186">                        r.subject = killer.getId();</span>
<span class="nc" id="L35187">                        r.newlines = 1;</span>
<span class="nc" id="L35188">                        vPhaseReport.addElement(r);</span>
                    }
                }             
                
                
                // damage the building
<span class="nc" id="L35194">                Vector&lt;Report&gt; buildingReport = damageBuilding(bldg, actualDamage, coords);</span>
<span class="nc bnc" id="L35195" title="All 2 branches missed.">                for (Report report : buildingReport) {</span>
<span class="nc" id="L35196">                    report.subject = subjectId;</span>
<span class="nc" id="L35197">                }</span>
<span class="nc" id="L35198">                vPhaseReport.addAll(buildingReport);</span>
            }
        }

<span class="nc bnc" id="L35202" title="All 4 branches missed.">        if (flak &amp;&amp; ((altitude &lt;= 0)</span>
<span class="nc bnc" id="L35203" title="All 2 branches missed.">                || (altitude &lt;= hex.terrainLevel(Terrains.BLDG_ELEV))</span>
<span class="nc bnc" id="L35204" title="All 2 branches missed.">                || (altitude == hex.terrainLevel(Terrains.BRIDGE_ELEV)))) {</span>
            // Flak in this hex would only hit landed units
<span class="nc" id="L35206">            return alreadyHit;</span>
        }

        // get units in hex
<span class="nc bnc" id="L35210" title="All 2 branches missed.">        for (Entity entity : game.getEntitiesVector(coords)) {  </span>
            // Check: is entity excluded?
<span class="nc bnc" id="L35212" title="All 4 branches missed.">            if ((entity == exclude) || alreadyHit.contains(entity.getId())) {</span>
<span class="nc" id="L35213">                continue;</span>
            } else {
<span class="nc" id="L35215">                alreadyHit.add(entity.getId());</span>
            }
            
<span class="nc" id="L35218">            AreaEffectHelper.artilleryDamageEntity(entity, damage, bldg, bldgAbsorbs, </span>
                    variableDamage, asfFlak, flak, altitude,
                    attackSource, ammo, coords, isFuelAirBomb,
                    killer, hex, subjectId, vPhaseReport, this);
<span class="nc" id="L35222">        }</span>

<span class="nc" id="L35224">        return alreadyHit;</span>
    }

    /**
     * deal area saturation damage to the map, used for artillery
     *
     * @param centre       The hex on which damage is centred
     * @param attackSource The position the attack came from
     * @param ammo         The ammo type doing the damage
     * @param subjectId    Subject for reports
     * @param killer       Who should be credited with kills
     * @param flak         Flak, hits flying units only, instead of flyers being immune
     * @param altitude     Absolute altitude for flak attack
     * @param mineClear    Does this clear mines?
     * @param vPhaseReport The Vector of Reports for the phase report
     * @param asfFlak      Is this flak against ASF?
     * @param attackingBA  How many BA suits are in the squad if this is a BA Tube arty
     *                     attack, -1 otherwise
     */
    public void artilleryDamageArea(Coords centre, Coords attackSource,
            AmmoType ammo, int subjectId, Entity killer, boolean flak,
            int altitude, boolean mineClear, Vector&lt;Report&gt; vPhaseReport,
            boolean asfFlak, int attackingBA) {
<span class="nc" id="L35247">        DamageFalloff damageFalloff = AreaEffectHelper.calculateDamageFallOff(ammo, attackingBA, mineClear);</span>
        
<span class="nc" id="L35249">        int damage = damageFalloff.damage;</span>
<span class="nc" id="L35250">        int falloff = damageFalloff.falloff;</span>
<span class="nc bnc" id="L35251" title="All 2 branches missed.">        if(damageFalloff.clusterMunitionsFlag) {</span>
<span class="nc" id="L35252">            attackSource = centre;</span>
        }
        
<span class="nc" id="L35255">        artilleryDamageArea(centre, attackSource, ammo, subjectId, killer,</span>
                damage, falloff, flak, altitude, vPhaseReport, asfFlak);
<span class="nc" id="L35257">    }</span>

    /**
     * Deals area-saturation damage to an area of the board. Used for artillery,
     * bombs, or anything else with linear decrease in damage
     *
     * @param centre
     *            The hex on which damage is centred
     * @param attackSource
     *            The position the attack came from
     * @param ammo
     *            The ammo type doing the damage
     * @param subjectId
     *            Subject for reports
     * @param killer
     *            Who should be credited with kills
     * @param damage
     *            Damage at ground zero
     * @param falloff
     *            Reduction in damage for each hex of distance
     * @param flak
     *            Flak, hits flying units only, instead of flyers being immune
     * @param altitude
     *            Absolute altitude for flak attack
     * @param vPhaseReport
     *            The Vector of Reports for the phase report
     * @param asfFlak
     *            Is this flak against ASF?
     */
    public void artilleryDamageArea(Coords centre, Coords attackSource, AmmoType ammo, int subjectId,
                                    Entity killer, int damage, int falloff, boolean flak, int altitude,
                                    Vector&lt;Report&gt; vPhaseReport, boolean asfFlak) {
<span class="nc" id="L35289">        Vector&lt;Integer&gt; alreadyHit = new Vector&lt;&gt;();</span>
<span class="nc bnc" id="L35290" title="All 2 branches missed.">        for (int ring = 0; damage &gt; 0; ring++, damage -= falloff) {</span>
<span class="nc" id="L35291">            List&lt;Coords&gt; hexes = centre.allAtDistance(ring);</span>
<span class="nc bnc" id="L35292" title="All 2 branches missed.">            for (Coords c : hexes) {</span>
<span class="nc" id="L35293">                alreadyHit = artilleryDamageHex(c, attackSource, damage, ammo,</span>
                        subjectId, killer, null, flak, altitude, vPhaseReport,
                        asfFlak, alreadyHit, false);
<span class="nc" id="L35296">            }</span>
<span class="nc" id="L35297">            attackSource = centre; // all splash comes from ground zero</span>
        }
<span class="nc" id="L35299">    }</span>

    public void deliverBombDamage(Coords centre, int type, int subjectId, Entity killer,
                                  Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L35303">        int range = 0;</span>
<span class="nc" id="L35304">        int damage = 10;</span>
<span class="nc bnc" id="L35305" title="All 2 branches missed.">        if (type == BombType.B_CLUSTER) {</span>
<span class="nc" id="L35306">            range = 1;</span>
<span class="nc" id="L35307">            damage = 5;</span>
        }
<span class="nc" id="L35309">        Vector&lt;Integer&gt; alreadyHit = new Vector&lt;&gt;();</span>

<span class="nc" id="L35311">        alreadyHit = artilleryDamageHex(centre, centre, damage, null,</span>
                subjectId, killer, null, false, 0, vPhaseReport, false,
                alreadyHit, false);
<span class="nc bnc" id="L35314" title="All 2 branches missed.">        if (range &gt; 0) {</span>
<span class="nc" id="L35315">            List&lt;Coords&gt; hexes = centre.allAtDistance(range);</span>
<span class="nc bnc" id="L35316" title="All 2 branches missed.">            for (Coords c : hexes) {</span>
<span class="nc" id="L35317">                alreadyHit = artilleryDamageHex(c, centre, damage, null,</span>
                        subjectId, killer, null, false, 0, vPhaseReport, false,
                        alreadyHit, false);
<span class="nc" id="L35320">            }</span>
        }
<span class="nc" id="L35322">    }</span>

    /**
     * deliver inferno bomb
     *
     * @param coords    the &lt;code&gt;Coords&lt;/code&gt; where to deliver
     * @param ae        the attacking &lt;code&gt;entity&lt;code&gt;
     * @param subjectId the &lt;code&gt;int&lt;/code&gt; id of the target
     */
    public void deliverBombInferno(Coords coords, Entity ae, int subjectId,
                                   Vector&lt;Report&gt; vPhaseReport) {
<span class="nc" id="L35333">        IHex h = game.getBoard().getHex(coords);</span>
        Report r;
        // Unless there is a fire in the hex already, start one.
<span class="nc bnc" id="L35336" title="All 2 branches missed.">        if (h.terrainLevel(Terrains.FIRE) &lt; Terrains.FIRE_LVL_INFERNO_BOMB) {</span>
<span class="nc" id="L35337">            ignite(coords, Terrains.FIRE_LVL_INFERNO_BOMB, vPhaseReport);</span>
        }
        // possibly melt ice and snow
<span class="nc bnc" id="L35340" title="All 4 branches missed.">        if (h.containsTerrain(Terrains.ICE) || h.containsTerrain(Terrains.SNOW)) {</span>
<span class="nc" id="L35341">            vPhaseReport.addAll(meltIceAndSnow(coords, subjectId));</span>
        }
<span class="nc bnc" id="L35343" title="All 2 branches missed.">        for (Entity entity : game.getEntitiesVector(coords)) {</span>
<span class="nc bnc" id="L35344" title="All 4 branches missed.">            if (entity.isAirborne() || entity.isAirborneVTOLorWIGE()) {</span>
<span class="nc" id="L35345">                continue;</span>
            }
            // TacOps, p. 359 - treat as if hit by 5 inferno missiles
<span class="nc" id="L35348">            r = new Report(6696);</span>
<span class="nc" id="L35349">            r.indent(3);</span>
<span class="nc" id="L35350">            r.add(entity.getDisplayName());</span>
<span class="nc" id="L35351">            r.subject = entity.getId();</span>
<span class="nc" id="L35352">            r.newlines = 0;</span>
<span class="nc" id="L35353">            vPhaseReport.add(r);</span>
<span class="nc bnc" id="L35354" title="All 2 branches missed.">            if (entity instanceof Tank) {</span>
<span class="nc" id="L35355">                Report.addNewline(vPhaseReport);</span>
            }
<span class="nc" id="L35357">            Vector&lt;Report&gt; vDamageReport = deliverInfernoMissiles(ae, entity, 5);</span>
<span class="nc" id="L35358">            Report.indentAll(vDamageReport, 2);</span>
<span class="nc" id="L35359">            vPhaseReport.addAll(vDamageReport);</span>
<span class="nc" id="L35360">        }</span>
<span class="nc" id="L35361">    }</span>

    /**
     * Resolve any Infantry units which are fortifying hexes
     */
    void resolveFortify() {
        Report r;
<span class="nc bnc" id="L35368" title="All 2 branches missed.">        for (Entity ent : game.getEntitiesVector()) {</span>
<span class="nc bnc" id="L35369" title="All 2 branches missed.">            if (ent instanceof Infantry) {</span>
<span class="nc" id="L35370">                Infantry inf = (Infantry) ent;</span>
<span class="nc" id="L35371">                int dig = inf.getDugIn();</span>
<span class="nc bnc" id="L35372" title="All 2 branches missed.">                if (dig == Infantry.DUG_IN_WORKING) {</span>
<span class="nc" id="L35373">                    r = new Report(5300);</span>
<span class="nc" id="L35374">                    r.addDesc(inf);</span>
<span class="nc" id="L35375">                    r.subject = inf.getId();</span>
<span class="nc" id="L35376">                    addReport(r);</span>
<span class="nc bnc" id="L35377" title="All 2 branches missed.">                } else if (dig == Infantry.DUG_IN_FORTIFYING2) {</span>
<span class="nc" id="L35378">                    Coords c = inf.getPosition();</span>
<span class="nc" id="L35379">                    r = new Report(5305);</span>
<span class="nc" id="L35380">                    r.addDesc(inf);</span>
<span class="nc" id="L35381">                    r.add(c.getBoardNum());</span>
<span class="nc" id="L35382">                    r.subject = inf.getId();</span>
<span class="nc" id="L35383">                    addReport(r);</span>
                    // fortification complete - add to map
<span class="nc" id="L35385">                    IHex hex = game.getBoard().getHex(c);</span>
<span class="nc" id="L35386">                    hex.addTerrain(Terrains.getTerrainFactory().createTerrain(</span>
                            Terrains.FORTIFIED, 1));
<span class="nc" id="L35388">                    sendChangedHex(c);</span>
                    // Clear the dig in for any units in same hex, since they
                    // get it for free by fort
<span class="nc bnc" id="L35391" title="All 2 branches missed.">                    for (Entity ent2 : game.getEntitiesVector(c)) {</span>
<span class="nc bnc" id="L35392" title="All 2 branches missed.">                        if (ent2 instanceof Infantry) {</span>
<span class="nc" id="L35393">                            Infantry inf2 = (Infantry) ent;</span>
<span class="nc" id="L35394">                            inf2.setDugIn(Infantry.DUG_IN_NONE);</span>
                        }
<span class="nc" id="L35396">                    }</span>
                }
            }
<span class="nc" id="L35399">        }</span>
<span class="nc" id="L35400">    }</span>

    /**
     * Check if spikes get broken in the given location
     *
     * @param e   The {@link Entity} to check
     * @param loc The location index
     * @return    A report showing the results of the roll
     */
    private Report checkBreakSpikes(Entity e, int loc) {
<span class="nc" id="L35410">        int roll = Compute.d6(2);</span>
        Report r;
<span class="nc bnc" id="L35412" title="All 2 branches missed.">        if (roll &lt; 9) {</span>
<span class="nc" id="L35413">            r = new Report(4445);</span>
<span class="nc" id="L35414">            r.indent(2);</span>
<span class="nc" id="L35415">            r.add(roll);</span>
<span class="nc" id="L35416">            r.subject = e.getId();</span>
        } else {
<span class="nc" id="L35418">            r = new Report(4440);</span>
<span class="nc" id="L35419">            r.indent(2);</span>
<span class="nc" id="L35420">            r.add(roll);</span>
<span class="nc" id="L35421">            r.subject = e.getId();</span>
<span class="nc bnc" id="L35422" title="All 2 branches missed.">            for (Mounted m : e.getMisc()) {</span>
<span class="nc bnc" id="L35423" title="All 2 branches missed.">                if (m.getType().hasFlag(MiscType.F_SPIKES)</span>
<span class="nc bnc" id="L35424" title="All 2 branches missed.">                        &amp;&amp; (m.getLocation() == loc)) {</span>
<span class="nc" id="L35425">                    m.setHit(true);</span>
                }
<span class="nc" id="L35427">            }</span>
        }
<span class="nc" id="L35429">        return r;</span>
    }

    /**
     * @return a &lt;code&gt;String&lt;/code&gt; representing the hostname
     */
    public String getHost() {
        try {
<span class="nc" id="L35437">            return InetAddress.getLocalHost().getHostName();</span>
<span class="nc" id="L35438">        } catch (UnknownHostException e) {</span>
<span class="nc" id="L35439">            e.printStackTrace();</span>
<span class="nc" id="L35440">            return &quot;&quot;;</span>
        }
    }

    /**
     * @return the &lt;code&gt;int&lt;/code&gt; this server is listening on
     */
    public int getPort() {
<span class="nc" id="L35448">        return serverSocket.getLocalPort();</span>
    }

    /**
     * Loops through all the attacks the game has. Checks if they care about
     * current phase, if so, runs them, and removes them if they don't want to
     * stay. TODO : Refactor the new entity announcement out of here.
     */
    private void handleAttacks() {
<span class="nc" id="L35457">        handleAttacks(false);</span>
<span class="nc" id="L35458">    }</span>

    private void handleAttacks(boolean pointblankShot) {
        Report r;
<span class="nc" id="L35462">        int lastAttackerId = -1;</span>
        Vector&lt;AttackHandler&gt; currentAttacks, keptAttacks;
<span class="nc" id="L35464">        currentAttacks = game.getAttacksVector();</span>
<span class="nc" id="L35465">        keptAttacks = new Vector&lt;&gt;();</span>
<span class="nc" id="L35466">        Vector&lt;Report&gt; handleAttackReports = new Vector&lt;&gt;();</span>
        // first, do any TAGs, so homing arty will have TAG
<span class="nc bnc" id="L35468" title="All 2 branches missed.">        for (AttackHandler ah : currentAttacks) {</span>
<span class="nc bnc" id="L35469" title="All 2 branches missed.">            if (!(ah instanceof TAGHandler)) {</span>
<span class="nc" id="L35470">                continue;</span>
            }
<span class="nc bnc" id="L35472" title="All 2 branches missed.">            if (ah.cares(game.getPhase())) {</span>
<span class="nc" id="L35473">                int aId = ah.getAttackerId();</span>
<span class="nc bnc" id="L35474" title="All 4 branches missed.">                if ((aId != lastAttackerId) &amp;&amp; !ah.announcedEntityFiring()) {</span>
                    // report who is firing
<span class="nc bnc" id="L35476" title="All 2 branches missed.">                    if (pointblankShot) {</span>
<span class="nc" id="L35477">                        r = new Report(3102);</span>
                    } else {
<span class="nc" id="L35479">                        r = new Report(3100);</span>
                    }
<span class="nc" id="L35481">                    r.subject = aId;</span>
<span class="nc" id="L35482">                    Entity ae = game.getEntity(aId);</span>
<span class="nc" id="L35483">                    r.addDesc(ae);</span>
<span class="nc" id="L35484">                    handleAttackReports.addElement(r);</span>
<span class="nc" id="L35485">                    ah.setAnnouncedEntityFiring(true);</span>
<span class="nc" id="L35486">                    lastAttackerId = aId;</span>
                }
<span class="nc" id="L35488">                boolean keep = ah.handle(game.getPhase(), handleAttackReports);</span>
<span class="nc bnc" id="L35489" title="All 2 branches missed.">                if (keep) {</span>
<span class="nc" id="L35490">                    keptAttacks.add(ah);</span>
                }
<span class="nc" id="L35492">                Report.addNewline(handleAttackReports);</span>
            }
<span class="nc" id="L35494">        }</span>
        // now resolve everything but TAG
<span class="nc bnc" id="L35496" title="All 2 branches missed.">        for (AttackHandler ah : currentAttacks) {</span>
<span class="nc bnc" id="L35497" title="All 2 branches missed.">            if (ah instanceof TAGHandler) {</span>
<span class="nc" id="L35498">                continue;</span>
            }
<span class="nc bnc" id="L35500" title="All 2 branches missed.">            if (ah.cares(game.getPhase())) {</span>
<span class="nc" id="L35501">                int aId = ah.getAttackerId();</span>
<span class="nc bnc" id="L35502" title="All 4 branches missed.">                if ((aId != lastAttackerId) &amp;&amp; !ah.announcedEntityFiring()) {</span>
                    // if this is a new attacker then resolve any
                    // standard-to-cap damage
                    // from previous
<span class="nc" id="L35506">                    handleAttackReports.addAll(checkFatalThresholds(aId,</span>
                            lastAttackerId));
                    // report who is firing
<span class="nc bnc" id="L35509" title="All 2 branches missed.">                    if (pointblankShot) {</span>
<span class="nc" id="L35510">                        r = new Report(3102);</span>
<span class="nc bnc" id="L35511" title="All 2 branches missed.">                    } else if (ah.isStrafing()) {</span>
<span class="nc" id="L35512">                        r = new Report(3101);</span>
                    } else {
<span class="nc" id="L35514">                        r = new Report(3100);</span>
                    }
<span class="nc" id="L35516">                    r.subject = aId;</span>
<span class="nc" id="L35517">                    Entity ae = game.getEntity(aId);</span>
                    // for arty, attacker may be dead, or fled, so check out-of-
                    // game entities
<span class="nc bnc" id="L35520" title="All 2 branches missed.">                    if (ae == null) {</span>
<span class="nc" id="L35521">                        ae = game.getOutOfGameEntity(aId);</span>
                    }
<span class="nc" id="L35523">                    r.addDesc(ae);</span>
<span class="nc" id="L35524">                    handleAttackReports.addElement(r);</span>
<span class="nc" id="L35525">                    ah.setAnnouncedEntityFiring(true);</span>
<span class="nc" id="L35526">                    lastAttackerId = aId;</span>
                }
<span class="nc" id="L35528">                boolean keep = ah.handle(game.getPhase(), handleAttackReports);</span>
<span class="nc bnc" id="L35529" title="All 2 branches missed.">                if (keep) {</span>
<span class="nc" id="L35530">                    keptAttacks.add(ah);</span>
                }
<span class="nc" id="L35532">                Report.addNewline(handleAttackReports);</span>
<span class="nc" id="L35533">            } else {</span>
<span class="nc" id="L35534">                keptAttacks.add(ah);</span>
            }
<span class="nc" id="L35536">        }</span>
        // resolve standard to capital one more time
<span class="nc" id="L35538">        handleAttackReports.addAll(checkFatalThresholds(lastAttackerId,</span>
                lastAttackerId));
<span class="nc bnc" id="L35540" title="All 2 branches missed.">        if (handleAttackReports.size() &gt; 0) {</span>
<span class="nc" id="L35541">            Report.addNewline(handleAttackReports);</span>
        }
<span class="nc" id="L35543">        addReport(handleAttackReports);</span>
        // HACK, but anything else seems to run into weird problems.
<span class="nc" id="L35545">        game.setAttacksVector(keptAttacks);</span>
<span class="nc" id="L35546">    }</span>

    /**
     * @return the current server instance
     */
    public static Server getServerInstance() {
<span class="nc" id="L35552">        return serverInstance;</span>
    }

    /**
     * create a &lt;code&gt;SmokeCloud&lt;/code&gt; object and add it to the server list
     *
     * @param coords   the location to create the smoke
     * @param level    1=Light 2=Heavy Smoke 3:light LI smoke 4: Heavy LI smoke
     * @param duration How long the smoke will last.
     */
    public void createSmoke(Coords coords, int level, int duration) {
<span class="nc" id="L35563">        SmokeCloud cloud = new SmokeCloud(coords, level, duration);</span>
<span class="nc" id="L35564">        game.addSmokeCloud(cloud);</span>
<span class="nc" id="L35565">        sendSmokeCloudAdded(cloud);</span>
<span class="nc" id="L35566">    }</span>

    /**
     * create a &lt;code&gt;SmokeCloud&lt;/code&gt; object and add it to the server list
     *
     * @param coords   the location to create the smoke
     * @param level    1=Light 2=Heavy Smoke 3:light LI smoke 4: Heavy LI smoke
     * @param duration duration How long the smoke will last.
     */
    public void createSmoke(ArrayList&lt;Coords&gt; coords, int level, int duration) {
<span class="nc" id="L35576">        SmokeCloud cloud = new SmokeCloud(coords, level, duration);</span>
<span class="nc" id="L35577">        game.addSmokeCloud(cloud);</span>
<span class="nc" id="L35578">        sendSmokeCloudAdded(cloud);</span>
<span class="nc" id="L35579">    }</span>

    /**
     * Update the map with a new set of coords.
     *
     * @param newCoords the location to move the smoke to
     */
    public void updateSmoke(SmokeCloud cloud, ArrayList&lt;Coords&gt; newCoords) {
<span class="nc" id="L35587">        removeSmokeTerrain(cloud);</span>
<span class="nc" id="L35588">        cloud.getCoordsList().clear();</span>
<span class="nc" id="L35589">        cloud.getCoordsList().addAll(newCoords);</span>
<span class="nc" id="L35590">    }</span>

    /**
     * remove a cloud from the map
     *
     * @param cloud the location to remove the smoke from
     */
    public void removeSmokeTerrain(SmokeCloud cloud) {
<span class="nc bnc" id="L35598" title="All 2 branches missed.">        for (Coords coords : cloud.getCoordsList()) {</span>
<span class="nc" id="L35599">            IHex nextHex = game.getBoard().getHex(coords);</span>
<span class="nc bnc" id="L35600" title="All 4 branches missed.">            if ((nextHex != null) &amp;&amp; nextHex.containsTerrain(Terrains.SMOKE)) {</span>
<span class="nc" id="L35601">                nextHex.removeTerrain(Terrains.SMOKE);</span>
<span class="nc" id="L35602">                sendChangedHex(coords);</span>
            }
<span class="nc" id="L35604">        }</span>
<span class="nc" id="L35605">    }</span>

    public List&lt;SmokeCloud&gt; getSmokeCloudList() {
<span class="nc" id="L35608">        return game.getSmokeCloudList();</span>
    }

    /**
     * Check to see if blowing sand caused damage to airborne VTOL/WIGEs
     */
    private Vector&lt;Report&gt; resolveBlowingSandDamage() {
<span class="nc" id="L35615">        Vector&lt;Report&gt; vFullReport = new Vector&lt;&gt;();</span>
<span class="nc" id="L35616">        vFullReport.add(new Report(5002, Report.PUBLIC));</span>
<span class="nc" id="L35617">        int damage_bonus = Math.max(0, game.getPlanetaryConditions().getWindStrength()</span>
                - PlanetaryConditions.WI_MOD_GALE);
        // cycle through each team and damage 1d6 airborne VTOL/WiGE
<span class="nc bnc" id="L35620" title="All 2 branches missed.">        for (Enumeration&lt;Team&gt; loop = game.getTeams(); loop.hasMoreElements(); ) {</span>
<span class="nc" id="L35621">            Team team = loop.nextElement();</span>
<span class="nc" id="L35622">            Vector&lt;Integer&gt; airborne = team.getAirborneVTOL();</span>
<span class="nc bnc" id="L35623" title="All 2 branches missed.">            if (airborne.size() &gt; 0) {</span>
                // how many units are affected
<span class="nc" id="L35625">                int unitsAffected = Math.min(Compute.d6(), airborne.size());</span>
<span class="nc bnc" id="L35626" title="All 4 branches missed.">                while ((unitsAffected &gt; 0) &amp;&amp; (airborne.size() &gt; 0)) {</span>
<span class="nc" id="L35627">                    int loc = Compute.randomInt(airborne.size());</span>
<span class="nc" id="L35628">                    Entity en = game.getEntity(airborne.get(loc));</span>
<span class="nc" id="L35629">                    int damage = Math.max(1, Compute.d6() / 2) + damage_bonus;</span>
<span class="nc bnc" id="L35630" title="All 2 branches missed.">                    while (damage &gt; 0) {</span>
<span class="nc" id="L35631">                        HitData hit = en.rollHitLocation(ToHitData.HIT_NORMAL, ToHitData.SIDE_RANDOM);</span>
<span class="nc" id="L35632">                        vFullReport.addAll(damageEntity(en, hit, 1));</span>
<span class="nc" id="L35633">                        damage--;</span>
<span class="nc" id="L35634">                    }</span>
<span class="nc" id="L35635">                    unitsAffected--;</span>
<span class="nc" id="L35636">                    airborne.remove(loc);</span>
<span class="nc" id="L35637">                }</span>
            }
<span class="nc" id="L35639">        }</span>
<span class="nc" id="L35640">        Report.addNewline(vPhaseReport);</span>
<span class="nc" id="L35641">        return vFullReport;</span>
    }

    /**
     * let an entity lay a mine
     *
     * @param entity the &lt;code&gt;Entity&lt;/code&gt; that should lay a mine
     * @param mineId an &lt;code&gt;int&lt;/code&gt; pointing to the mine
     */
    private void layMine(Entity entity, int mineId, Coords coords) {
<span class="nc" id="L35651">        Mounted mine = entity.getEquipment(mineId);</span>
        Report r;
<span class="nc bnc" id="L35653" title="All 2 branches missed.">        if (!mine.isMissing()) {</span>
<span class="nc" id="L35654">            int reportId = 0;</span>
<span class="nc bnc" id="L35655" title="All 5 branches missed.">            switch (mine.getMineType()) {</span>
                case Mounted.MINE_CONVENTIONAL:
<span class="nc" id="L35657">                    deliverThunderMinefield(coords, entity.getOwnerId(), 10,</span>
<span class="nc" id="L35658">                            entity.getId());</span>
<span class="nc" id="L35659">                    reportId = 3500;</span>
<span class="nc" id="L35660">                    break;</span>
                case Mounted.MINE_VIBRABOMB:
<span class="nc" id="L35662">                    deliverThunderVibraMinefield(coords, entity.getOwnerId(), 10,</span>
<span class="nc" id="L35663">                            mine.getVibraSetting(), entity.getId());</span>
<span class="nc" id="L35664">                    reportId = 3505;</span>
<span class="nc" id="L35665">                    break;</span>
                case Mounted.MINE_ACTIVE:
<span class="nc" id="L35667">                    deliverThunderActiveMinefield(coords, entity.getOwnerId(), 10,</span>
<span class="nc" id="L35668">                            entity.getId());</span>
<span class="nc" id="L35669">                    reportId = 3510;</span>
<span class="nc" id="L35670">                    break;</span>
                case Mounted.MINE_INFERNO:
<span class="nc" id="L35672">                    deliverThunderInfernoMinefield(coords, entity.getOwnerId(), 10,</span>
<span class="nc" id="L35673">                            entity.getId());</span>
<span class="nc" id="L35674">                    reportId = 3515;</span>
                    break;
                // TODO : command-detonated mines
                // case 2:
            }
<span class="nc" id="L35679">            mine.setShotsLeft(mine.getUsableShotsLeft() - 1);</span>
<span class="nc bnc" id="L35680" title="All 2 branches missed.">            if (mine.getUsableShotsLeft() &lt;= 0) {</span>
<span class="nc" id="L35681">                mine.setMissing(true);</span>
            }
<span class="nc" id="L35683">            r = new Report(reportId);</span>
<span class="nc" id="L35684">            r.subject = entity.getId();</span>
<span class="nc" id="L35685">            r.addDesc(entity);</span>
<span class="nc" id="L35686">            r.add(coords.getBoardNum());</span>
<span class="nc" id="L35687">            addReport(r);</span>
<span class="nc" id="L35688">            entity.setLayingMines(true);</span>
        }
<span class="nc" id="L35690">    }</span>

    public void reportRoll(Roll roll) {
<span class="nc" id="L35693">        Report r = new Report(1230);</span>
<span class="nc" id="L35694">        r.add(roll.getReport());</span>
<span class="nc" id="L35695">        addReport(r);</span>
<span class="nc" id="L35696">    }</span>

    private void registerWithServerBrowser(boolean register, String urlString) {
        try {
<span class="nc" id="L35700">            URL url = new URL(urlString);</span>
<span class="nc" id="L35701">            HttpURLConnection conn = (HttpURLConnection) url.openConnection();</span>
<span class="nc" id="L35702">            conn.setDoOutput(true);</span>
<span class="nc" id="L35703">            conn.setRequestProperty(&quot;Content-Type&quot;, &quot;application/x-www-form-urlencoded&quot;);</span>
<span class="nc" id="L35704">            DataOutputStream printout = new DataOutputStream(</span>
<span class="nc" id="L35705">                    conn.getOutputStream());</span>
            String content;
<span class="nc" id="L35707">            content = &quot;port=&quot;</span>
<span class="nc" id="L35708">                      + URLEncoder.encode(</span>
<span class="nc" id="L35709">                              Integer.toString(serverSocket.getLocalPort()), &quot;UTF-8&quot;);</span>
<span class="nc bnc" id="L35710" title="All 2 branches missed.">            if (register) {</span>
<span class="nc bnc" id="L35711" title="All 2 branches missed.">                for (IConnection iconn : connections) {</span>
<span class="nc" id="L35712">                    content += &quot;&amp;players[]=&quot; + (getPlayer(iconn.getId()).getName());</span>
<span class="nc" id="L35713">                }</span>
<span class="nc bnc" id="L35714" title="All 2 branches missed.">                if ((game.getPhase() != Phase.PHASE_LOUNGE)</span>
<span class="nc bnc" id="L35715" title="All 2 branches missed.">                        &amp;&amp; (game.getPhase() != Phase.PHASE_UNKNOWN)) {</span>
<span class="nc" id="L35716">                    content += &quot;&amp;close=yes&quot;;</span>
                }
<span class="nc" id="L35718">                content += &quot;&amp;version=&quot; + MegaMek.VERSION;</span>
<span class="nc bnc" id="L35719" title="All 2 branches missed.">                if (isPassworded()) {</span>
<span class="nc" id="L35720">                    content += &quot;&amp;pw=yes&quot;;</span>
                }
            } else {
<span class="nc" id="L35723">                content += &quot;&amp;delete=yes&quot;;</span>
            }
<span class="nc bnc" id="L35725" title="All 2 branches missed.">            if (serverAccessKey != null) {</span>
<span class="nc" id="L35726">                content += &quot;&amp;key=&quot; + serverAccessKey;</span>
            }
<span class="nc" id="L35728">            printout.writeBytes(content);</span>
<span class="nc" id="L35729">            printout.flush();</span>
<span class="nc" id="L35730">            BufferedReader rd = new BufferedReader(new InputStreamReader(conn.getInputStream()));</span>
            String line;
<span class="nc bnc" id="L35732" title="All 2 branches missed.">            if (conn.getResponseCode() == 200) {</span>
<span class="nc bnc" id="L35733" title="All 2 branches missed.">                while ((line = rd.readLine()) != null) {</span>
<span class="nc bnc" id="L35734" title="All 2 branches missed.">                    if (serverAccessKey == null) {</span>
<span class="nc" id="L35735">                        serverAccessKey = line;</span>
                    }
                }
            }
<span class="nc" id="L35739">            rd.close();</span>
<span class="nc" id="L35740">            printout.close();</span>
<span class="nc" id="L35741">        } catch (Exception ignored) {</span>
<span class="nc" id="L35742">        }</span>
<span class="nc" id="L35743">    }</span>

    public Set&lt;Coords&gt; getHexUpdateSet() {
<span class="nc" id="L35746">        return hexUpdateSet;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>