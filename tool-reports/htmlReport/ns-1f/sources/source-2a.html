


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > Dropship</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">megamek.common</a>
</div>

<h1>Coverage Summary for Class: Dropship (megamek.common)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Branch, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">Dropship</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/56)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/544)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    0%
  </span>
  <span class="absValue">
    (0/1151)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;/*
&nbsp; * MegaAero - Copyright (C) 2007 Jay Lawson This program is free software; you
&nbsp; * can redistribute it and/or modify it under the terms of the GNU General
&nbsp; * Public License as published by the Free Software Foundation; either version 2
&nbsp; * of the License, or (at your option) any later version.
&nbsp; *
&nbsp; * This program is distributed in the hope that it will be useful, but WITHOUT
&nbsp; * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
&nbsp; * FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
&nbsp; * details.
&nbsp; */
&nbsp;/*
&nbsp; * Created on Jun 17, 2007
&nbsp; */
&nbsp;package megamek.common;
&nbsp;
&nbsp;import java.text.NumberFormat;
&nbsp;import java.util.ArrayList;
&nbsp;import java.util.HashMap;
&nbsp;import java.util.HashSet;
&nbsp;import java.util.Map;
&nbsp;import java.util.TreeMap;
&nbsp;import java.util.Vector;
&nbsp;
&nbsp;import megamek.common.options.OptionsConstants;
&nbsp;import megamek.common.weapons.bayweapons.BayWeapon;
&nbsp;
&nbsp;/**
&nbsp; * @author Jay Lawson
&nbsp; */
<b class="nc">&nbsp;public class Dropship extends SmallCraft {</b>
&nbsp;
&nbsp;    /**
&nbsp;     *
&nbsp;     */
&nbsp;    private static final long serialVersionUID = 1528728632696989565L;
&nbsp;    
&nbsp;    
&nbsp;    //ASEW Missile Effects, per location
&nbsp;    //Values correspond to Locations: NOS,Left,Right,AFT
<b class="nc">&nbsp;    private int asewAffectedTurns[] = {0,0,0,0};</b>
&nbsp;    
&nbsp;    /*
&nbsp;     * Sets the number of rounds a specified firing arc is affected by an ASEW missile
&nbsp;     * @param arc - integer representing the desired firing arc
&nbsp;     * @param turns - integer specifying the number of end phases that the effects last through
&nbsp;     * Technically, about 1.5 turns elapse per the rules for ASEW missiles in TO
&nbsp;     */
&nbsp;    public void setASEWAffected(int arc, int turns) {
<b class="nc">&nbsp;        if (arc &lt; asewAffectedTurns.length) {</b>
<b class="nc">&nbsp;            asewAffectedTurns[arc] = turns;</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    /*
&nbsp;     * Returns the number of rounds a specified firing arc is affected by an ASEW missile
&nbsp;     * @param arc - integer representing the desired firing arc
&nbsp;     */
&nbsp;    public int getASEWAffected(int arc) {
<b class="nc">&nbsp;        if (arc &lt; asewAffectedTurns.length) {</b>
<b class="nc">&nbsp;            return asewAffectedTurns[arc];            </b>
&nbsp;        }
<b class="nc">&nbsp;        return 0;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Primitive Dropships may be constructed with no docking collar, or with a pre-boom collar. 
&nbsp;     * 
&nbsp;     */
&nbsp;    public static final int COLLAR_STANDARD  = 0;
&nbsp;    public static final int COLLAR_PROTOTYPE = 1;
&nbsp;    public static final int COLLAR_NO_BOOM   = 2;
&nbsp;    
<b class="nc">&nbsp;    private static final String[] COLLAR_NAMES = {</b>
&nbsp;            &quot;KF-Boom&quot;, &quot;Prototype KF-Boom&quot;, &quot;No Boom&quot;
&nbsp;    };
&nbsp;    
&nbsp;    //Likewise, you can have a prototype or standard K-F Boom
&nbsp;    public static final int BOOM_STANDARD  = 0;
&nbsp;    public static final int BOOM_PROTOTYPE = 1;
&nbsp;    
&nbsp;    // what needs to go here?
&nbsp;    // loading and unloading of units?
<b class="nc">&nbsp;    private boolean dockCollarDamaged = false;</b>
<b class="nc">&nbsp;    private boolean kfBoomDamaged = false;</b>
<b class="nc">&nbsp;    private int collarType = COLLAR_STANDARD;</b>
<b class="nc">&nbsp;    private int boomType = BOOM_STANDARD;</b>
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean tracksHeat() {
&nbsp;        // While large craft perform heat calculations, they are not considered heat-tracking units
&nbsp;        // because they cannot generate more heat than they can dissipate in the same turn.
<b class="nc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public int getUnitType() {
<b class="nc">&nbsp;        return UnitType.DROPSHIP;</b>
&nbsp;    }
&nbsp;
&nbsp;    public CrewType defaultCrewType() {
<b class="nc">&nbsp;        return CrewType.VESSEL;</b>
&nbsp;    }
&nbsp;
&nbsp;    //Docking Collar Stuff
&nbsp;    public boolean isDockCollarDamaged() {
<b class="nc">&nbsp;        return dockCollarDamaged;</b>
&nbsp;    }
&nbsp;    
&nbsp;    public int getCollarType() {
<b class="nc">&nbsp;        return collarType;</b>
&nbsp;    }
&nbsp;    
&nbsp;    public void setCollarType(int collarType) {
<b class="nc">&nbsp;        this.collarType = collarType;</b>
&nbsp;    }
&nbsp;    
&nbsp;    public String getCollarName() {
<b class="nc">&nbsp;        return COLLAR_NAMES[collarType];</b>
&nbsp;    }
&nbsp;    
&nbsp;    public static String getCollarName(int type) {
<b class="nc">&nbsp;        return COLLAR_NAMES[type];</b>
&nbsp;    }
&nbsp;    
&nbsp;    public static TechAdvancement getCollarTA() {
<b class="nc">&nbsp;        return new TechAdvancement(TECH_BASE_ALL).setAdvancement(2458, 2470, 2500)</b>
<b class="nc">&nbsp;                .setPrototypeFactions(F_TH).setProductionFactions(F_TH).setTechRating(RATING_C)</b>
<b class="nc">&nbsp;                .setAvailability(RATING_C, RATING_C, RATING_C, RATING_C)</b>
<b class="nc">&nbsp;                .setStaticTechLevel(SimpleTechLevel.STANDARD);</b>
&nbsp;    }
&nbsp;    
&nbsp;    //KF Boom Stuff
&nbsp;    public boolean isKFBoomDamaged() {
<b class="nc">&nbsp;        return kfBoomDamaged;</b>
&nbsp;    }
&nbsp;    
&nbsp;    public int getBoomType() {
<b class="nc">&nbsp;        return boomType;</b>
&nbsp;    }
&nbsp;    
&nbsp;    public void setBoomType(int boomType) {
<b class="nc">&nbsp;        this.boomType = boomType;</b>
&nbsp;    }
&nbsp;
&nbsp;    public String getCritDamageString() {
<b class="nc">&nbsp;        StringBuilder toReturn = new StringBuilder(super.getCritDamageString());</b>
<b class="nc">&nbsp;        boolean first = toReturn.length() == 0;</b>
<b class="nc">&nbsp;        if (isDockCollarDamaged()) {</b>
<b class="nc">&nbsp;            if (!first) {</b>
<b class="nc">&nbsp;                toReturn.append(&quot;, &quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;            toReturn.append(Messages.getString(&quot;Dropship.collarDamageString&quot;));</b>
<b class="nc">&nbsp;            first = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (isKFBoomDamaged()) {</b>
<b class="nc">&nbsp;            if (!first) {</b>
<b class="nc">&nbsp;                toReturn.append(&quot;, &quot;);</b>
&nbsp;            }
<b class="nc">&nbsp;            toReturn.append(Messages.getString(&quot;Dropship.kfBoomDamageString&quot;));</b>
<b class="nc">&nbsp;            first = false;</b>
&nbsp;        }
<b class="nc">&nbsp;        return toReturn.toString();</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean isLocationProhibited(Coords c, int currElevation) {
<b class="nc">&nbsp;        IHex hex = game.getBoard().getHex(c);</b>
<b class="nc">&nbsp;        if (isAirborne()) {</b>
<b class="nc">&nbsp;            if (hex.containsTerrain(Terrains.IMPASSABLE)) {</b>
<b class="nc">&nbsp;                return true;</b>
&nbsp;            }
<b class="nc">&nbsp;            return false;</b>
&nbsp;        }
&nbsp;        // Check prohibited terrain
&nbsp;        // treat grounded Dropships like wheeled tanks,
&nbsp;        // plus buildings are prohibited
<b class="nc">&nbsp;        boolean isProhibited = hexContainsProhibitedTerrain(hex);</b>
&nbsp;
<b class="nc">&nbsp;        HashMap&lt;Integer, Integer&gt; elevations = new HashMap&lt;Integer, Integer&gt;();</b>
<b class="nc">&nbsp;        elevations.put(hex.getLevel(), 1);</b>
<b class="nc">&nbsp;        for (int dir = 0; dir &lt; 6; dir++) {</b>
<b class="nc">&nbsp;            Coords secondaryCoord = c.translated(dir);</b>
<b class="nc">&nbsp;            IHex secondaryHex = game.getBoard().getHex(secondaryCoord);</b>
<b class="nc">&nbsp;            if (secondaryHex == null) {</b>
&nbsp;                // Don&#39;t allow landed dropships to hang off the board
<b class="nc">&nbsp;                isProhibited = true;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                isProhibited |= hexContainsProhibitedTerrain(secondaryHex);</b>
&nbsp;
<b class="nc">&nbsp;                int elev = secondaryHex.getLevel();</b>
<b class="nc">&nbsp;                if (elevations.containsKey(elev)) {</b>
<b class="nc">&nbsp;                    elevations.put(elev, elevations.get(elev) + 1);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    elevations.put(elev, 1);</b>
&nbsp;                }
&nbsp;            }
&nbsp;        }
&nbsp;        /*
&nbsp;         * As of 8/2013 there aren&#39;t clear restrictions for landed dropships. We
&nbsp;         * are going to assume that Dropships need to be on fairly level
&nbsp;         * terrain. This means, it can only be on at most 2 different elevations
&nbsp;         * that are at most 1 elevation apart. Additionally, at least half of
&nbsp;         * the dropships hexes round down must be on one elevation
&nbsp;         */
&nbsp;        // Whole DS is on one elevation
<b class="nc">&nbsp;        if (elevations.size() == 1) {</b>
<b class="nc">&nbsp;            return isProhibited;</b>
&nbsp;        }
&nbsp;        // DS on more than 2 different elevations
&nbsp;        // or not on an elevation, what?
<b class="nc">&nbsp;        if ((elevations.size() &gt; 2) || (elevations.size() == 0)) {</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        Object elevs[] = elevations.keySet().toArray();</b>
<b class="nc">&nbsp;        int elev1 = (Integer) elevs[0];</b>
<b class="nc">&nbsp;        int elev2 = (Integer) elevs[1];</b>
<b class="nc">&nbsp;        int elevDifference = Math.abs(elev1 - elev2);</b>
<b class="nc">&nbsp;        int elevMinCount = 2;</b>
&nbsp;        // Check elevation difference and make sure that the counts of different
&nbsp;        // elevations will allow for a legal deployment to exist
<b class="nc">&nbsp;        if ((elevDifference &gt; 1) || (elevations.get(elevs[0]) &lt; elevMinCount)</b>
<b class="nc">&nbsp;                || (elevations.get(elevs[1]) &lt; elevMinCount)) {</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
&nbsp;
&nbsp;        // It&#39;s still possible we have a legal deployment, we now have to check
&nbsp;        // the arrangement of hexes
&nbsp;        // The way this is done is we start at the hex directly above the
&nbsp;        // central hex and then move around clockwise and compare the two hexes
&nbsp;        // to see if they share an elevation. We need to have a number of these
&nbsp;        // adjacencies equal to the number of secondary elevation hexes - 1.
<b class="nc">&nbsp;        int numAdjacencies = 0;</b>
<b class="nc">&nbsp;        int centralElev = hex.getLevel();</b>
<b class="nc">&nbsp;        int secondElev = centralElev;</b>
<b class="nc">&nbsp;        IHex currHex = game.getBoard().getHex(c.translated(5));</b>
&nbsp;        // Ensure we aren&#39;t trying to deploy off the board
<b class="nc">&nbsp;        if (currHex == null) {</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
<b class="nc">&nbsp;        for (int dir = 0; dir &lt; 6; dir++) {</b>
<b class="nc">&nbsp;            if (currHex.getLevel() != centralElev) {</b>
<b class="nc">&nbsp;                secondElev = currHex.getLevel();</b>
&nbsp;            }
<b class="nc">&nbsp;            IHex nextHex = game.getBoard().getHex(c.translated(dir));</b>
&nbsp;            // Ensure we aren&#39;t trying to deploy off the board
<b class="nc">&nbsp;            if (nextHex == null) {</b>
<b class="nc">&nbsp;                return true;</b>
&nbsp;            }
<b class="nc">&nbsp;            if ((currHex.getLevel() != centralElev) &amp;&amp; (currHex.getLevel() == nextHex.getLevel())) {</b>
<b class="nc">&nbsp;                numAdjacencies++;</b>
&nbsp;            }
<b class="nc">&nbsp;            currHex = nextHex;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (numAdjacencies &lt; (elevations.get(secondElev) - 1)) {</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        return isProhibited;</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Worker function that checks if a given hex contains terrain onto which a grounded dropship
&nbsp;     * cannot deploy. 
&nbsp;     */
&nbsp;    private boolean hexContainsProhibitedTerrain(IHex hex) {
<b class="nc">&nbsp;        return hex.containsTerrain(Terrains.WOODS) || hex.containsTerrain(Terrains.ROUGH)</b>
<b class="nc">&nbsp;                || ((hex.terrainLevel(Terrains.WATER) &gt; 0) &amp;&amp; !hex.containsTerrain(Terrains.ICE))</b>
<b class="nc">&nbsp;                || hex.containsTerrain(Terrains.RUBBLE) || hex.containsTerrain(Terrains.MAGMA)</b>
<b class="nc">&nbsp;                || hex.containsTerrain(Terrains.JUNGLE) || (hex.terrainLevel(Terrains.SNOW) &gt; 1)</b>
<b class="nc">&nbsp;                || (hex.terrainLevel(Terrains.GEYSER) == 2) </b>
<b class="nc">&nbsp;                || hex.containsTerrain(Terrains.BUILDING) || hex.containsTerrain(Terrains.IMPASSABLE) </b>
<b class="nc">&nbsp;                || hex.containsTerrain(Terrains.BRIDGE);</b>
&nbsp;                
&nbsp;    }
&nbsp;
&nbsp;    public void setDamageDockCollar(boolean b) {
<b class="nc">&nbsp;        dockCollarDamaged = b;</b>
&nbsp;    }
&nbsp;    
&nbsp;    public void setDamageKFBoom(boolean b) {
<b class="nc">&nbsp;        kfBoomDamaged = b;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public double getFuelPointsPerTon() {
&nbsp;        double ppt;
<b class="nc">&nbsp;        if (getWeight() &lt; 400) {</b>
<b class="nc">&nbsp;            ppt = 80;</b>
<b class="nc">&nbsp;        } else if (getWeight() &lt; 800) {</b>
<b class="nc">&nbsp;            ppt = 70;</b>
<b class="nc">&nbsp;        } else if (getWeight() &lt; 1200) {</b>
<b class="nc">&nbsp;            ppt = 60;</b>
<b class="nc">&nbsp;        } else if (getWeight() &lt; 1900) {</b>
<b class="nc">&nbsp;            ppt = 50;</b>
<b class="nc">&nbsp;        } else if (getWeight() &lt; 3000) {</b>
<b class="nc">&nbsp;            ppt = 40;</b>
<b class="nc">&nbsp;        } else if (getWeight() &lt; 20000) {</b>
<b class="nc">&nbsp;            ppt = 30;</b>
<b class="nc">&nbsp;        } else if (getWeight() &lt; 40000) {</b>
<b class="nc">&nbsp;            ppt = 20;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            ppt = 10;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (isPrimitive()) {</b>
<b class="nc">&nbsp;            return ppt / primitiveFuelFactor();</b>
&nbsp;        }
<b class="nc">&nbsp;        return ppt;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public double getStrategicFuelUse() {
<b class="nc">&nbsp;        double fuelUse = 1.84; // default for military designs and civilian &lt; 1000</b>
<b class="nc">&nbsp;        if ((getDesignType() == CIVILIAN) || isPrimitive()) {</b>
<b class="nc">&nbsp;            if (getWeight() &gt;= 70000) {</b>
<b class="nc">&nbsp;                fuelUse = 8.83;</b>
<b class="nc">&nbsp;            } else if (getWeight() &gt;= 50000) {</b>
<b class="nc">&nbsp;                fuelUse = 8.37;</b>
<b class="nc">&nbsp;            } else if (getWeight() &gt;= 40000) {</b>
<b class="nc">&nbsp;                fuelUse = 7.71;</b>
<b class="nc">&nbsp;            } else if (getWeight() &gt;= 30000) {</b>
<b class="nc">&nbsp;                fuelUse = 6.52;</b>
<b class="nc">&nbsp;            } else if (getWeight() &gt;= 20000) {</b>
<b class="nc">&nbsp;                fuelUse = 5.19;</b>
<b class="nc">&nbsp;            } else if (getWeight() &gt;= 9000) {</b>
<b class="nc">&nbsp;                fuelUse = 4.22;</b>
<b class="nc">&nbsp;            } else if (getWeight() &gt;= 4000) {</b>
<b class="nc">&nbsp;                fuelUse = 2.82;</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        if (isPrimitive()) {</b>
<b class="nc">&nbsp;            return fuelUse * primitiveFuelFactor();</b>
&nbsp;        }
<b class="nc">&nbsp;        return fuelUse;</b>
&nbsp;    }
&nbsp;    
&nbsp;    @Override
&nbsp;    public double primitiveFuelFactor() {
<b class="nc">&nbsp;        int year = getOriginalBuildYear();</b>
<b class="nc">&nbsp;        if (year &gt;= 2500) {</b>
<b class="nc">&nbsp;            return 1.0;</b>
<b class="nc">&nbsp;        } else if (year &gt;= 2400) {</b>
<b class="nc">&nbsp;            return 1.1;</b>
<b class="nc">&nbsp;        } else if (year &gt;= 2351) {</b>
<b class="nc">&nbsp;            return 1.3;</b>
<b class="nc">&nbsp;        } else if (year &gt;= 2251) {</b>
<b class="nc">&nbsp;            return 1.4;</b>
<b class="nc">&nbsp;        } else if (year &gt;= 2201) {</b>
<b class="nc">&nbsp;            return 1.6;</b>
<b class="nc">&nbsp;        } else if (year &gt;= 2151) {</b>
<b class="nc">&nbsp;            return 1.8;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return 2.0;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
<b class="nc">&nbsp;    protected static final TechAdvancement TA_DROPSHIP = new TechAdvancement(TECH_BASE_ALL)</b>
<b class="nc">&nbsp;            .setAdvancement(DATE_NONE, 2470, 2490).setISApproximate(false, true, false)</b>
<b class="nc">&nbsp;            .setProductionFactions(F_TH).setTechRating(RATING_D)</b>
<b class="nc">&nbsp;            .setAvailability(RATING_D, RATING_E, RATING_D, RATING_D)</b>
<b class="nc">&nbsp;            .setStaticTechLevel(SimpleTechLevel.STANDARD);</b>
<b class="nc">&nbsp;    protected static final TechAdvancement TA_DROPSHIP_PRIMITIVE = new TechAdvancement(TECH_BASE_IS)</b>
<b class="nc">&nbsp;            .setISAdvancement(DATE_ES, 2200, DATE_NONE, 2500)</b>
<b class="nc">&nbsp;            .setISApproximate(false, true, false, false)</b>
<b class="nc">&nbsp;            .setProductionFactions(F_TA).setTechRating(RATING_D)</b>
<b class="nc">&nbsp;            .setAvailability(RATING_D, RATING_X, RATING_X, RATING_X)</b>
<b class="nc">&nbsp;            .setStaticTechLevel(SimpleTechLevel.STANDARD);</b>
&nbsp;    
&nbsp;    @Override
&nbsp;    public TechAdvancement getConstructionTechAdvancement() {
<b class="nc">&nbsp;        return isPrimitive()? TA_DROPSHIP_PRIMITIVE : TA_DROPSHIP;</b>
&nbsp;    }
&nbsp;    
&nbsp;    @Override
&nbsp;    protected void addSystemTechAdvancement(CompositeTechLevel ctl) {
<b class="nc">&nbsp;        super.addSystemTechAdvancement(ctl);</b>
<b class="nc">&nbsp;        if (collarType != COLLAR_NO_BOOM) {</b>
<b class="nc">&nbsp;            ctl.addComponent(getCollarTA());</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    @Override
&nbsp;    public double getCost(boolean ignoreAmmo) {
<b class="nc">&nbsp;        double[] costs = new double[20];</b>
<b class="nc">&nbsp;        int costIdx = 0;</b>
<b class="nc">&nbsp;        double cost = 0;</b>
&nbsp;
&nbsp;        // Control Systems
&nbsp;        // Bridge
<b class="nc">&nbsp;        costs[costIdx++] += 200000 + (10 * weight);</b>
&nbsp;        // Computer
<b class="nc">&nbsp;        costs[costIdx++] += 200000;</b>
&nbsp;        // Life Support
<b class="nc">&nbsp;        costs[costIdx++] += 5000 * (getNCrew() + getNPassenger());</b>
&nbsp;        // Sensors
<b class="nc">&nbsp;        costs[costIdx++] += 80000;</b>
&nbsp;        // Fire Control Computer
<b class="nc">&nbsp;        costs[costIdx++] += 100000;</b>
&nbsp;        // Gunnery Control Systems
<b class="nc">&nbsp;        costs[costIdx++] += 10000 * getArcswGuns();</b>
&nbsp;
&nbsp;        // Structural Integrity
<b class="nc">&nbsp;        costs[costIdx++] += 100000 * getSI();</b>
&nbsp;
&nbsp;        // Additional Flight Systems
&nbsp;        // Attitude Thruster
<b class="nc">&nbsp;        costs[costIdx++] += 25000;</b>
&nbsp;        // Landing Gear
<b class="nc">&nbsp;        costs[costIdx++] += 10 * getWeight();</b>
&nbsp;        // Docking Collar
<b class="nc">&nbsp;        if (collarType == COLLAR_STANDARD) {</b>
<b class="nc">&nbsp;            costs[costIdx++] += 10000;</b>
<b class="nc">&nbsp;        } else if (collarType == COLLAR_PROTOTYPE) {</b>
<b class="nc">&nbsp;            costs[costIdx++] += 1010000;</b>
&nbsp;        }
&nbsp;
&nbsp;        // Engine
<b class="nc">&nbsp;        double engineMultiplier = 0.065;</b>
<b class="nc">&nbsp;        if (isClan()) {</b>
<b class="nc">&nbsp;            engineMultiplier = 0.061;</b>
&nbsp;        }
<b class="nc">&nbsp;        double engineWeight = getOriginalWalkMP() * weight * engineMultiplier;</b>
<b class="nc">&nbsp;        costs[costIdx++] += engineWeight * 1000;</b>
&nbsp;        // Drive Unit
<b class="nc">&nbsp;        costs[costIdx++] += (500 * getOriginalWalkMP() * weight) / 100.0;</b>
&nbsp;
&nbsp;        // Fuel Tanks
<b class="nc">&nbsp;        costs[costIdx++] += (200 * getFuel()) / getFuelPointsPerTon() * 1.02;</b>
&nbsp;
&nbsp;        // Armor
<b class="nc">&nbsp;        costs[costIdx++] += getArmorWeight() * EquipmentType.getArmorCost(armorType[0]);</b>
&nbsp;
&nbsp;        // Heat Sinks
<b class="nc">&nbsp;        int sinkCost = 2000 + (4000 * getHeatType());// == HEAT_DOUBLE ? 6000:</b>
&nbsp;        // 2000;
<b class="nc">&nbsp;        costs[costIdx++] += sinkCost * getHeatSinks();</b>
&nbsp;
&nbsp;        // Weapons and Equipment
<b class="nc">&nbsp;        costs[costIdx++] += getWeaponsAndEquipmentCost(ignoreAmmo);</b>
&nbsp;
&nbsp;        // Transport Bays
<b class="nc">&nbsp;        int baydoors = 0;</b>
<b class="nc">&nbsp;        long bayCost = 0;</b>
<b class="nc">&nbsp;        long quartersCost = 0;</b>
&nbsp;        // Passenger and crew quarters and infantry bays are considered part of the structure
&nbsp;        // and don&#39;t add to the cost
<b class="nc">&nbsp;        for (Bay next : getTransportBays()) {</b>
<b class="nc">&nbsp;            baydoors += next.getDoors();</b>
<b class="nc">&nbsp;            if (!next.isQuarters() &amp;&amp; !(next instanceof InfantryBay) &amp;&amp; !(next instanceof BattleArmorBay)) {</b>
<b class="nc">&nbsp;                bayCost += next.getCost();</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;
<b class="nc">&nbsp;        costs[costIdx++] += bayCost + (baydoors * 1000L);</b>
<b class="nc">&nbsp;        costs[costIdx++] = quartersCost;</b>
&nbsp;
&nbsp;        // Life Boats and Escape Pods
<b class="nc">&nbsp;        costs[costIdx++] += 5000 * (getLifeBoats() + getEscapePods());</b>
&nbsp;
&nbsp;        // TODO Decouple cost calculation from addCostDetails and eliminate duplicate code in getPriceMultiplier
<b class="nc">&nbsp;        double weightMultiplier = 36.0;</b>
<b class="nc">&nbsp;        if (isSpheroid()) {</b>
<b class="nc">&nbsp;            weightMultiplier = 28.0;</b>
&nbsp;        }
&nbsp;
&nbsp;        // Sum Costs
<b class="nc">&nbsp;        for (int i = 0; i &lt; costIdx; i++) {</b>
<b class="nc">&nbsp;            cost += costs[i];</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        costs[costIdx++] = -weightMultiplier; // Negative indicates multiplier</b>
<b class="nc">&nbsp;        cost = Math.round(cost * weightMultiplier);</b>
<b class="nc">&nbsp;        addCostDetails(cost, costs);</b>
<b class="nc">&nbsp;        return cost;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public double getPriceMultiplier() {
<b class="nc">&nbsp;        return isSpheroid() ? 28.0 : 36.0;</b>
&nbsp;    }
&nbsp;
&nbsp;    private void addCostDetails(double cost, double[] costs) {
<b class="nc">&nbsp;        bvText = new StringBuffer();</b>
<b class="nc">&nbsp;        String[] left = { &quot;Bridge&quot;, &quot;Computer&quot;, &quot;Life Support&quot;, &quot;Sensors&quot;, &quot;FCS&quot;, &quot;Gunnery Control Systems&quot;,</b>
&nbsp;                &quot;Structural Integrity&quot;, &quot;Attitude Thruster&quot;, &quot;Landing Gear&quot;, &quot;Docking Collar&quot;,
&nbsp;                &quot;Engine&quot;, &quot;Drive Unit&quot;, &quot;Fuel Tanks&quot;, &quot;Armor&quot;, &quot;Heat Sinks&quot;, &quot;Weapons/Equipment&quot;, &quot;Bays&quot;,
&nbsp;                &quot;Quarters&quot;, &quot;Life Boats/Escape Pods&quot;, &quot;Weight Multiplier&quot; };
&nbsp;
<b class="nc">&nbsp;        NumberFormat commafy = NumberFormat.getInstance();</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(&quot;&lt;HTML&gt;&lt;BODY&gt;&lt;CENTER&gt;&lt;b&gt;Cost Calculations For &quot;);</b>
<b class="nc">&nbsp;        bvText.append(getChassis());</b>
<b class="nc">&nbsp;        bvText.append(&quot; &quot;);</b>
<b class="nc">&nbsp;        bvText.append(getModel());</b>
<b class="nc">&nbsp;        bvText.append(&quot;&lt;/b&gt;&lt;/CENTER&gt;&quot;);</b>
<b class="nc">&nbsp;        bvText.append(nl);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(startTable);</b>
&nbsp;        // find the maximum length of the columns.
<b class="nc">&nbsp;        for (int l = 0; l &lt; left.length; l++) {</b>
&nbsp;
<b class="nc">&nbsp;            if (l == 14) {</b>
<b class="nc">&nbsp;                getWeaponsAndEquipmentCost(true);</b>
&nbsp;            } else {
<b class="nc">&nbsp;                bvText.append(startRow);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(left[l]);</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
&nbsp;
<b class="nc">&nbsp;                if (costs[l] == 0) {</b>
<b class="nc">&nbsp;                    bvText.append(&quot;N/A&quot;);</b>
<b class="nc">&nbsp;                } else if (costs[l] &lt; 0) {</b>
<b class="nc">&nbsp;                    bvText.append(&quot;x &quot;);</b>
<b class="nc">&nbsp;                    bvText.append(commafy.format(-costs[l]));</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    bvText.append(commafy.format(costs[l]));</b>
&nbsp;
&nbsp;                }
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(endRow);</b>
&nbsp;            }
&nbsp;        }
<b class="nc">&nbsp;        bvText.append(startRow);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(&quot;-------------&quot;);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(endRow);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(startRow);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(&quot;Total Cost:&quot;);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(commafy.format(cost));</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(endRow);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(endTable);</b>
<b class="nc">&nbsp;        bvText.append(&quot;&lt;/BODY&gt;&lt;/HTML&gt;&quot;);</b>
&nbsp;    }
&nbsp;
&nbsp;    private String getArcName(int loc) {
<b class="nc">&nbsp;        if (loc &lt; locations()) {</b>
<b class="nc">&nbsp;            return getLocationName(loc);</b>
&nbsp;        }
<b class="nc">&nbsp;        return getLocationName(loc - 3) + &quot; (R)&quot;;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public int calculateBattleValue(boolean ignoreC3, boolean ignorePilot) {
<b class="nc">&nbsp;        if (useManualBV) {</b>
<b class="nc">&nbsp;            return manualBV;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        bvText = new StringBuffer(&quot;&lt;HTML&gt;&lt;BODY&gt;&lt;CENTER&gt;&lt;b&gt;Battle Value Calculations For &quot;);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(getChassis());</b>
<b class="nc">&nbsp;        bvText.append(&quot; &quot;);</b>
<b class="nc">&nbsp;        bvText.append(getModel());</b>
<b class="nc">&nbsp;        bvText.append(&quot;&lt;/b&gt;&lt;/CENTER&gt;&quot;);</b>
<b class="nc">&nbsp;        bvText.append(nl);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(&quot;&lt;b&gt;Defensive Battle Rating Calculation:&lt;/b&gt;&quot;);</b>
<b class="nc">&nbsp;        bvText.append(nl);</b>
&nbsp;
<b class="nc">&nbsp;        double dbv = 0; // defensive battle value</b>
<b class="nc">&nbsp;        double obv = 0; // offensive bv</b>
&nbsp;
<b class="nc">&nbsp;        int modularArmor = 0;</b>
<b class="nc">&nbsp;        for (Mounted mounted : getEquipment()) {</b>
<b class="nc">&nbsp;            if ((mounted.getType() instanceof MiscType) &amp;&amp; mounted.getType().hasFlag(MiscType.F_MODULAR_ARMOR)) {</b>
<b class="nc">&nbsp;                modularArmor += mounted.getBaseDamageCapacity() - mounted.getDamageTaken();</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;
&nbsp;        // no use for armor mods right now but in case we need one later
<b class="nc">&nbsp;        double armorMod = 1.0;</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(startTable);</b>
<b class="nc">&nbsp;        bvText.append(startRow);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(&quot;Total Armor Factor x 2.5 x&quot;);</b>
<b class="nc">&nbsp;        bvText.append(armorMod);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
&nbsp;
<b class="nc">&nbsp;        dbv += (getTotalArmor() + modularArmor);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(dbv);</b>
<b class="nc">&nbsp;        bvText.append(&quot; x 2.5 x &quot;);</b>
<b class="nc">&nbsp;        bvText.append(armorMod);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(&quot;= &quot;);</b>
&nbsp;
<b class="nc">&nbsp;        dbv *= 2.5 * armorMod;</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(dbv);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(endRow);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(startRow);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(&quot;Total SI x 2&quot;);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
&nbsp;
<b class="nc">&nbsp;        double dbvSI = getSI() * 2.0;</b>
<b class="nc">&nbsp;        dbv += dbvSI;</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(getSI());</b>
<b class="nc">&nbsp;        bvText.append(&quot; x 2&quot;);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(&quot;= &quot;);</b>
<b class="nc">&nbsp;        bvText.append(dbvSI);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(endRow);</b>
&nbsp;
&nbsp;        // add defensive equipment
<b class="nc">&nbsp;        double amsBV = 0;</b>
<b class="nc">&nbsp;        double amsAmmoBV = 0;</b>
<b class="nc">&nbsp;        double screenBV = 0;</b>
<b class="nc">&nbsp;        double screenAmmoBV = 0;</b>
<b class="nc">&nbsp;        double defEqBV = 0;</b>
<b class="nc">&nbsp;        for (Mounted mounted : getEquipment()) {</b>
<b class="nc">&nbsp;            EquipmentType etype = mounted.getType();</b>
&nbsp;
&nbsp;            // don&#39;t count destroyed equipment
<b class="nc">&nbsp;            if (mounted.isDestroyed()) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (etype instanceof BayWeapon) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (((etype instanceof WeaponType) &amp;&amp; (etype.hasFlag(WeaponType.F_AMS)))) {</b>
<b class="nc">&nbsp;                amsBV += etype.getBV(this);</b>
<b class="nc">&nbsp;                bvText.append(startRow);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(etype.getName());</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(&quot;+&quot;);</b>
<b class="nc">&nbsp;                bvText.append(etype.getBV(this));</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(endRow);</b>
<b class="nc">&nbsp;            } else if ((etype instanceof AmmoType) &amp;&amp; (((AmmoType) etype).getAmmoType() == AmmoType.T_AMS)) {</b>
&nbsp;                // we need to deal with cases where ammo is loaded in multi-ton
&nbsp;                // increments
&nbsp;                // (on dropships and jumpships) - lets take the ratio of shots
&nbsp;                // to shots left
<b class="nc">&nbsp;                double ratio = mounted.getUsableShotsLeft() / ((AmmoType) etype).getShots();</b>
&nbsp;
&nbsp;                // if the ratio is less than one, we will treat as a full ton
&nbsp;                // since
&nbsp;                // we don&#39;t make that adjustment elsewhere
<b class="nc">&nbsp;                if (ratio &lt; 1.0) {</b>
<b class="nc">&nbsp;                    ratio = 1.0;</b>
&nbsp;                }
<b class="nc">&nbsp;                amsAmmoBV += ratio * etype.getBV(this);</b>
<b class="nc">&nbsp;                bvText.append(startRow);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(etype.getName());</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(&quot;+&quot;);</b>
<b class="nc">&nbsp;                bvText.append(ratio * etype.getBV(this));</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(endRow);</b>
<b class="nc">&nbsp;            } else if ((etype instanceof AmmoType)</b>
<b class="nc">&nbsp;                    &amp;&amp; (((AmmoType) etype).getAmmoType() == AmmoType.T_SCREEN_LAUNCHER)) {</b>
&nbsp;                // we need to deal with cases where ammo is loaded in multi-ton
&nbsp;                // increments
&nbsp;                // (on dropships and jumpships) - lets take the ratio of shots
&nbsp;                // to shots left
<b class="nc">&nbsp;                double ratio = mounted.getUsableShotsLeft() / ((AmmoType) etype).getShots();</b>
&nbsp;
&nbsp;                // if the ratio is less than one, we will treat as a full ton
&nbsp;                // since
&nbsp;                // we don&#39;t make that adjustment elsewhere
<b class="nc">&nbsp;                if (ratio &lt; 1.0) {</b>
<b class="nc">&nbsp;                    ratio = 1.0;</b>
&nbsp;                }
<b class="nc">&nbsp;                screenAmmoBV += ratio * etype.getBV(this);</b>
<b class="nc">&nbsp;                bvText.append(startRow);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(etype.getName());</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(&quot;+&quot;);</b>
<b class="nc">&nbsp;                bvText.append(ratio * etype.getBV(this));</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(endRow);</b>
<b class="nc">&nbsp;            } else if ((etype instanceof WeaponType)</b>
<b class="nc">&nbsp;                    &amp;&amp; (((WeaponType) etype).getAtClass() == WeaponType.CLASS_SCREEN)) {</b>
<b class="nc">&nbsp;                screenBV += etype.getBV(this);</b>
<b class="nc">&nbsp;                bvText.append(startRow);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(etype.getName());</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(&quot;+&quot;);</b>
<b class="nc">&nbsp;                bvText.append(etype.getBV(this));</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(endRow);</b>
<b class="nc">&nbsp;            } else if ((etype instanceof MiscType)</b>
<b class="nc">&nbsp;                    &amp;&amp; (etype.hasFlag(MiscType.F_ECM) || etype.hasFlag(MiscType.F_BAP))) {</b>
<b class="nc">&nbsp;                defEqBV += etype.getBV(this);</b>
<b class="nc">&nbsp;                bvText.append(startRow);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(mounted.getName());</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(&quot;+&quot;);</b>
<b class="nc">&nbsp;                bvText.append(etype.getBV(this));</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(endRow);</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        if (amsBV &gt; 0) {</b>
<b class="nc">&nbsp;            bvText.append(startRow);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(&quot;Total AMS BV:&quot;);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(amsBV);</b>
<b class="nc">&nbsp;            dbv += amsBV;</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(endRow);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (screenBV &gt; 0) {</b>
<b class="nc">&nbsp;            bvText.append(startRow);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(&quot;Total Screen BV:&quot;);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(screenBV);</b>
<b class="nc">&nbsp;            dbv += screenBV;</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(endRow);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (amsAmmoBV &gt; 0) {</b>
<b class="nc">&nbsp;            bvText.append(startRow);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(&quot;Total AMS Ammo BV (to a maximum of AMS BV):&quot;);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(Math.min(amsBV, amsAmmoBV));</b>
<b class="nc">&nbsp;            dbv += Math.min(amsBV, amsAmmoBV);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(endRow);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (screenAmmoBV &gt; 0) {</b>
<b class="nc">&nbsp;            bvText.append(startRow);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(&quot;Total Screen Ammo BV (to a maximum of Screen BV):&quot;);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(Math.min(screenBV, screenAmmoBV));</b>
<b class="nc">&nbsp;            dbv += Math.min(screenBV, screenAmmoBV);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(endRow);</b>
&nbsp;        }
<b class="nc">&nbsp;        if (defEqBV &gt; 0) {</b>
<b class="nc">&nbsp;            bvText.append(startRow);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(&quot;Total misc defensive equipment BV:&quot;);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(defEqBV);</b>
<b class="nc">&nbsp;            dbv += defEqBV;</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(endRow);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        bvText.append(startRow);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(&quot;-------------&quot;);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(endRow);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(startRow);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(dbv);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(endRow);</b>
&nbsp;
&nbsp;        // unit type multiplier
<b class="nc">&nbsp;        bvText.append(startRow);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(&quot;Multiply by Unit type Modifier&quot;);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(getBVTypeModifier());</b>
<b class="nc">&nbsp;        dbv *= getBVTypeModifier();</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(&quot;x&quot; + getBVTypeModifier());</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(endRow);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(startRow);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(&quot;-------------&quot;);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(endRow);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(startRow);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(dbv);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(endRow);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(startRow);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(&quot;&lt;b&gt;Offensive Battle Rating Calculation:&lt;/b&gt;&quot;);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(endRow);</b>
&nbsp;
&nbsp;        // calculate heat efficiency
<b class="nc">&nbsp;        int aeroHeatEfficiency = getHeatCapacity();</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(startRow);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(&quot;Base Heat Efficiency &quot;);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(aeroHeatEfficiency);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(endRow);</b>
&nbsp;
&nbsp;        // get arc BV and heat
&nbsp;        // I am going to redo how I do this to cycle through locations, so I can
&nbsp;        // spit it out
&nbsp;        // to bvText. It will require a little trickery for rear LS/RS since
&nbsp;        // those technically are not
&nbsp;        // locations
<b class="nc">&nbsp;        double[] arcBVs = new double[locations() + 2];</b>
<b class="nc">&nbsp;        double[] arcHeats = new double[locations() + 2];</b>
<b class="nc">&nbsp;        double[] ammoBVs = new double[locations() + 2];</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(startRow);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(&quot;Arc BV and Heat&quot;);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(endRow);</b>
&nbsp;
&nbsp;        // cycle through locations
<b class="nc">&nbsp;        for (int loc = 0; loc &lt; (locations() + 2); loc++) {</b>
<b class="nc">&nbsp;            int l = loc;</b>
<b class="nc">&nbsp;            boolean isRear = (loc &gt;= locations());</b>
<b class="nc">&nbsp;            String rear = &quot;&quot;;</b>
<b class="nc">&nbsp;            if (isRear) {</b>
<b class="nc">&nbsp;                l = l - 3;</b>
<b class="nc">&nbsp;                rear = &quot; (R)&quot;;</b>
&nbsp;            }
<b class="nc">&nbsp;            this.getLocationName(l);</b>
&nbsp;
<b class="nc">&nbsp;            bvText.append(startRow);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(&quot;&lt;i&gt;&quot; + getLocationName(l) + rear + &quot;&lt;/i&gt;&quot;);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(&quot;&lt;i&gt;BV&lt;/i&gt;&quot;);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(&quot;&lt;i&gt;Heat&lt;/i&gt;&quot;);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(endRow);</b>
<b class="nc">&nbsp;            double arcBV = 0.0;</b>
<b class="nc">&nbsp;            double arcHeat = 0.0;</b>
<b class="nc">&nbsp;            double arcAmmoBV = 0.0;</b>
<b class="nc">&nbsp;            TreeMap&lt;String, Double&gt; weaponsForExcessiveAmmo = new TreeMap&lt;String, Double&gt;();</b>
<b class="nc">&nbsp;            for (Mounted mounted : getTotalWeaponList()) {</b>
<b class="nc">&nbsp;                if (mounted.getLocation() != l) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
<b class="nc">&nbsp;                if (mounted.isRearMounted() != isRear) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;                // only count non-damaged equipment
<b class="nc">&nbsp;                if (mounted.isMissing() || mounted.isHit() || mounted.isDestroyed() || mounted.isBreached()) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
<b class="nc">&nbsp;                WeaponType wtype = (WeaponType) mounted.getType();</b>
<b class="nc">&nbsp;                double weaponHeat = wtype.getHeat();</b>
<b class="nc">&nbsp;                double dBV = wtype.getBV(this);</b>
&nbsp;                // skip bays
<b class="nc">&nbsp;                if (wtype instanceof BayWeapon) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;                // don&#39;t count defensive weapons
<b class="nc">&nbsp;                if (wtype.hasFlag(WeaponType.F_AMS)) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;                // don&#39;t count screen launchers, they are defensive
<b class="nc">&nbsp;                if (wtype.getAtClass() == WeaponType.CLASS_SCREEN) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;                // double heat for ultras
<b class="nc">&nbsp;                if ((wtype.getAmmoType() == AmmoType.T_AC_ULTRA) || (wtype.getAmmoType() == AmmoType.T_AC_ULTRA_THB)) {</b>
<b class="nc">&nbsp;                    weaponHeat *= 2;</b>
&nbsp;                }
&nbsp;                // Six times heat for RAC
<b class="nc">&nbsp;                if (wtype.getAmmoType() == AmmoType.T_AC_ROTARY) {</b>
<b class="nc">&nbsp;                    weaponHeat *= 6;</b>
&nbsp;                }
&nbsp;                // calc MG Array here:
<b class="nc">&nbsp;                if (wtype.hasFlag(WeaponType.F_MGA)) {</b>
<b class="nc">&nbsp;                    double mgBV = 0;</b>
<b class="nc">&nbsp;                    for (int eqNum : mounted.getBayWeapons()) {</b>
<b class="nc">&nbsp;                        Mounted mg = getEquipment(eqNum);</b>
<b class="nc">&nbsp;                        if ((mg != null) &amp;&amp; (!mg.isDestroyed())) {</b>
<b class="nc">&nbsp;                            mgBV += mg.getType().getBV(this);</b>
&nbsp;                        }
<b class="nc">&nbsp;                    }</b>
<b class="nc">&nbsp;                    dBV = mgBV * 0.67;</b>
&nbsp;                }
&nbsp;                // and we&#39;ll add the tcomp here too
<b class="nc">&nbsp;                if (wtype.hasFlag(WeaponType.F_DIRECT_FIRE)) {</b>
<b class="nc">&nbsp;                    if (hasTargComp()) {</b>
<b class="nc">&nbsp;                        dBV *= 1.25;</b>
&nbsp;                    }
&nbsp;                }
&nbsp;                // artemis bumps up the value
<b class="nc">&nbsp;                if (mounted.getLinkedBy() != null) {</b>
<b class="nc">&nbsp;                    Mounted mLinker = mounted.getLinkedBy();</b>
<b class="nc">&nbsp;                    if ((mLinker.getType() instanceof MiscType) &amp;&amp; mLinker.getType().hasFlag(MiscType.F_ARTEMIS)) {</b>
<b class="nc">&nbsp;                        dBV *= 1.2;</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if ((mLinker.getType() instanceof MiscType) &amp;&amp; mLinker.getType().hasFlag(MiscType.F_ARTEMIS_PROTO)) {</b>
<b class="nc">&nbsp;                        dBV *= 1.1;</b>
&nbsp;                    }
&nbsp;                    
<b class="nc">&nbsp;                    if ((mLinker.getType() instanceof MiscType) &amp;&amp; mLinker.getType().hasFlag(MiscType.F_ARTEMIS_V)) {</b>
<b class="nc">&nbsp;                        dBV *= 1.3;</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if ((mLinker.getType() instanceof MiscType) &amp;&amp; mLinker.getType().hasFlag(MiscType.F_APOLLO)) {</b>
<b class="nc">&nbsp;                        dBV *= 1.15;</b>
&nbsp;                    }
<b class="nc">&nbsp;                    if ((mLinker.getType() instanceof MiscType)</b>
<b class="nc">&nbsp;                            &amp;&amp; mLinker.getType().hasFlag(MiscType.F_RISC_LASER_PULSE_MODULE)) {</b>
<b class="nc">&nbsp;                        dBV *= 1.15;</b>
&nbsp;                    }
&nbsp;                }
&nbsp;                // add up BV of ammo-using weapons for each type of weapon,
&nbsp;                // to compare with ammo BV later for excessive ammo BV rule
<b class="nc">&nbsp;                if (!((wtype.hasFlag(WeaponType.F_ENERGY) &amp;&amp; !(wtype.getAmmoType() == AmmoType.T_PLASMA))</b>
<b class="nc">&nbsp;                        || wtype.hasFlag(WeaponType.F_ONESHOT) || wtype.hasFlag(WeaponType.F_INFANTRY)</b>
<b class="nc">&nbsp;                        || (wtype.getAmmoType() == AmmoType.T_NA))) {</b>
<b class="nc">&nbsp;                    String key = wtype.getAmmoType() + &quot;:&quot; + wtype.getRackSize();</b>
<b class="nc">&nbsp;                    if (!weaponsForExcessiveAmmo.containsKey(key)) {</b>
<b class="nc">&nbsp;                        weaponsForExcessiveAmmo.put(key, wtype.getBV(this));</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        weaponsForExcessiveAmmo.put(key, wtype.getBV(this) + weaponsForExcessiveAmmo.get(key));</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                bvText.append(startRow);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(wtype.getName());</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(&quot;+&quot; + dBV);</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(&quot;+&quot; + weaponHeat);</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(endRow);</b>
<b class="nc">&nbsp;                arcBV += dBV;</b>
<b class="nc">&nbsp;                arcHeat += weaponHeat;</b>
<b class="nc">&nbsp;            }</b>
&nbsp;            // now ammo
<b class="nc">&nbsp;            Map&lt;String, Double&gt; ammo = new HashMap&lt;String, Double&gt;();</b>
<b class="nc">&nbsp;            ArrayList&lt;String&gt; keys = new ArrayList&lt;String&gt;();</b>
<b class="nc">&nbsp;            for (Mounted mounted : getAmmo()) {</b>
<b class="nc">&nbsp;                if (mounted.getLocation() != l) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
<b class="nc">&nbsp;                if (mounted.isRearMounted() != isRear) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
<b class="nc">&nbsp;                AmmoType atype = (AmmoType) mounted.getType();</b>
&nbsp;                // we need to deal with cases where ammo is loaded in multi-ton
&nbsp;                // increments
&nbsp;                // (on dropships and jumpships) - lets take the ratio of shots
&nbsp;                // to
&nbsp;                // shots left
<b class="nc">&nbsp;                double ratio = mounted.getUsableShotsLeft() / atype.getShots();</b>
&nbsp;
&nbsp;                // if the ratio is less than one, we will treat as a full ton
&nbsp;                // since
&nbsp;                // we don&#39;t make that adjustment elsewhere
<b class="nc">&nbsp;                if (ratio &lt; 1.0) {</b>
<b class="nc">&nbsp;                    ratio = 1.0;</b>
&nbsp;                }
&nbsp;
&nbsp;                // don&#39;t count depleted ammo
<b class="nc">&nbsp;                if (mounted.getUsableShotsLeft() == 0) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;
&nbsp;                // don&#39;t count AMS, it&#39;s defensive
<b class="nc">&nbsp;                if (atype.getAmmoType() == AmmoType.T_AMS) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;                // don&#39;t count screen launchers, they are defensive
<b class="nc">&nbsp;                if (atype.getAmmoType() == AmmoType.T_SCREEN_LAUNCHER) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
&nbsp;
&nbsp;                // don&#39;t count oneshot ammo, it&#39;s considered part of the
&nbsp;                // launcher.
<b class="nc">&nbsp;                if (mounted.getLocation() == Entity.LOC_NONE) {</b>
&nbsp;                    // assumption: ammo without a location is for a oneshot
&nbsp;                    // weapon
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
<b class="nc">&nbsp;                double abv = ratio * atype.getBV(this);</b>
<b class="nc">&nbsp;                String key = atype.getAmmoType() + &quot;:&quot; + atype.getRackSize();</b>
<b class="nc">&nbsp;                String key2 = atype.getName() + &quot;;&quot; + key;</b>
&nbsp;                // MML needs special casing so they don&#39;t count double
<b class="nc">&nbsp;                if (atype.getAmmoType() == AmmoType.T_MML) {</b>
<b class="nc">&nbsp;                    key2 = &quot;MML &quot; + atype.getRackSize() + &quot; Ammo;&quot; + key;</b>
&nbsp;                }
&nbsp;                // same for the different AR10 ammos
<b class="nc">&nbsp;                if (atype.getAmmoType() == AmmoType.T_AR10) {</b>
<b class="nc">&nbsp;                    key2 = &quot;AR10 Ammo;&quot; + key;</b>
&nbsp;                }
<b class="nc">&nbsp;                if (!keys.contains(key2)) {</b>
<b class="nc">&nbsp;                    keys.add(key2);</b>
&nbsp;                }
<b class="nc">&nbsp;                if (!ammo.containsKey(key)) {</b>
<b class="nc">&nbsp;                    ammo.put(key, abv);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    ammo.put(key, abv + ammo.get(key));</b>
&nbsp;                }
<b class="nc">&nbsp;            }</b>
&nbsp;            // now cycle through ammo hash and deal with excessive ammo issues
<b class="nc">&nbsp;            for (String fullkey : keys) {</b>
<b class="nc">&nbsp;                String[] k = fullkey.split(&quot;;&quot;);</b>
<b class="nc">&nbsp;                String key = k[1];</b>
<b class="nc">&nbsp;                bvText.append(startRow);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(k[0]);</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                if (weaponsForExcessiveAmmo.get(key) != null) {</b>
<b class="nc">&nbsp;                    if (ammo.get(key) &gt; weaponsForExcessiveAmmo.get(key)) {</b>
<b class="nc">&nbsp;                        bvText.append(&quot;+&quot; + weaponsForExcessiveAmmo.get(key) + &quot;*&quot;);</b>
<b class="nc">&nbsp;                        arcAmmoBV += weaponsForExcessiveAmmo.get(key);</b>
&nbsp;                    } else {
<b class="nc">&nbsp;                        bvText.append(&quot;+&quot; + ammo.get(key));</b>
<b class="nc">&nbsp;                        arcAmmoBV += ammo.get(key);</b>
&nbsp;                    }
&nbsp;                }
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(&quot;&quot;);</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(endRow);</b>
<b class="nc">&nbsp;            }</b>
<b class="nc">&nbsp;            bvText.append(startRow);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(&quot;&lt;b&gt;&quot; + getLocationName(l) + rear + &quot; Weapon Totals&lt;/b&gt;&quot;);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(&quot;&lt;b&gt;&quot; + arcBV + &quot;&lt;/b&gt;&quot;);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(&quot;&lt;b&gt;&quot; + arcHeat + &quot;&lt;/b&gt;&quot;);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(endRow);</b>
<b class="nc">&nbsp;            bvText.append(startRow);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(&quot;&lt;b&gt;&quot; + getLocationName(l) + rear + &quot; Ammo Totals&lt;/b&gt;&quot;);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(&quot;&lt;b&gt;&quot; + arcAmmoBV + &quot;&lt;/b&gt;&quot;);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(&quot;&quot;);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(endRow);</b>
<b class="nc">&nbsp;            bvText.append(startRow);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(&quot;&lt;b&gt;&quot; + getLocationName(l) + rear + &quot; Totals&lt;/b&gt;&quot;);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            double tempBV = arcBV + arcAmmoBV;</b>
<b class="nc">&nbsp;            bvText.append(&quot;&lt;b&gt;&quot; + tempBV + &quot;&lt;/b&gt;&quot;);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(&quot;&quot;);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(endRow);</b>
<b class="nc">&nbsp;            arcBVs[loc] = arcBV;</b>
<b class="nc">&nbsp;            arcHeats[loc] = arcHeat;</b>
<b class="nc">&nbsp;            ammoBVs[loc] = arcAmmoBV;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        double weaponBV = 0.0;</b>
&nbsp;        // ok, now lets loop through the arcs and find the highest value BV arc
<b class="nc">&nbsp;        int highArc = Integer.MIN_VALUE;</b>
<b class="nc">&nbsp;        int adjArcH = Integer.MIN_VALUE;</b>
<b class="nc">&nbsp;        int adjArcL = Integer.MIN_VALUE;</b>
<b class="nc">&nbsp;        double adjArcHMult = 1.0;</b>
<b class="nc">&nbsp;        double adjArcLMult = 0.5;</b>
<b class="nc">&nbsp;        double highBV = 0.0;</b>
<b class="nc">&nbsp;        double heatUsed = 0.0;</b>
<b class="nc">&nbsp;        for (int loc = 0; loc &lt; arcBVs.length; loc++) {</b>
<b class="nc">&nbsp;            if (arcBVs[loc] &gt; highBV) {</b>
<b class="nc">&nbsp;                highArc = loc;</b>
<b class="nc">&nbsp;                highBV = arcBVs[loc];</b>
&nbsp;            }
&nbsp;        }
&nbsp;        // now lets identify the adjacent arcs
<b class="nc">&nbsp;        if (highArc &gt; Integer.MIN_VALUE) {</b>
<b class="nc">&nbsp;            heatUsed += arcHeats[highArc];</b>
&nbsp;            // now get the BV and heat for the two adjacent arcs
<b class="nc">&nbsp;            int adjArcCW = getAdjacentLocCW(highArc);</b>
<b class="nc">&nbsp;            int adjArcCCW = getAdjacentLocCCW(highArc);</b>
<b class="nc">&nbsp;            double adjArcCWBV = 0.0;</b>
<b class="nc">&nbsp;            double adjArcCWHeat = 0.0;</b>
<b class="nc">&nbsp;            if (adjArcCW &gt; Integer.MIN_VALUE) {</b>
<b class="nc">&nbsp;                adjArcCWBV = arcBVs[adjArcCW];</b>
<b class="nc">&nbsp;                adjArcCWHeat = arcHeats[adjArcCW];</b>
&nbsp;            }
<b class="nc">&nbsp;            double adjArcCCWBV = 0.0;</b>
<b class="nc">&nbsp;            double adjArcCCWHeat = 0.0;</b>
<b class="nc">&nbsp;            if (adjArcCCW &gt; Integer.MIN_VALUE) {</b>
<b class="nc">&nbsp;                adjArcCCWBV = arcBVs[adjArcCCW];</b>
<b class="nc">&nbsp;                adjArcCCWHeat = arcHeats[adjArcCCW];</b>
&nbsp;            }
<b class="nc">&nbsp;            if (adjArcCWBV &gt; adjArcCCWBV) {</b>
<b class="nc">&nbsp;                adjArcH = adjArcCW;</b>
<b class="nc">&nbsp;                if ((heatUsed + adjArcCWHeat) &gt; aeroHeatEfficiency) {</b>
<b class="nc">&nbsp;                    adjArcHMult = 0.5;</b>
&nbsp;                }
<b class="nc">&nbsp;                heatUsed += adjArcCWHeat;</b>
<b class="nc">&nbsp;                adjArcL = adjArcCCW;</b>
<b class="nc">&nbsp;                if ((heatUsed + adjArcCCWHeat) &gt; aeroHeatEfficiency) {</b>
<b class="nc">&nbsp;                    adjArcLMult = 0.25;</b>
&nbsp;                }
<b class="nc">&nbsp;                heatUsed += adjArcCCWHeat;</b>
&nbsp;            } else {
<b class="nc">&nbsp;                adjArcH = adjArcCCW;</b>
<b class="nc">&nbsp;                if ((heatUsed + adjArcCCWHeat) &gt; aeroHeatEfficiency) {</b>
<b class="nc">&nbsp;                    adjArcHMult = 0.5;</b>
&nbsp;                }
<b class="nc">&nbsp;                heatUsed += adjArcCCWHeat;</b>
<b class="nc">&nbsp;                adjArcL = adjArcCW;</b>
<b class="nc">&nbsp;                if ((heatUsed + adjArcCWHeat) &gt; aeroHeatEfficiency) {</b>
<b class="nc">&nbsp;                    adjArcLMult = 0.25;</b>
&nbsp;                }
<b class="nc">&nbsp;                heatUsed += adjArcCWHeat;</b>
&nbsp;            }
&nbsp;        }
&nbsp;
&nbsp;        // ok now add in ammo to arc bvs
<b class="nc">&nbsp;        for (int i = 0; i &lt; arcBVs.length; i++) {</b>
<b class="nc">&nbsp;            arcBVs[i] = arcBVs[i] + ammoBVs[i];</b>
&nbsp;        }
&nbsp;
&nbsp;        // ok now lets go in and add the arcs
<b class="nc">&nbsp;        double totalHeat = 0.0;</b>
<b class="nc">&nbsp;        if (highArc &gt; Integer.MIN_VALUE) {</b>
&nbsp;            // ok now add the BV from this arc and reset to zero
<b class="nc">&nbsp;            bvText.append(startRow);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(&quot;Highest BV Arc (&quot; + getArcName(highArc) + &quot;)&quot; + arcBVs[highArc] + &quot;*1.0&quot;);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(&quot;+&quot; + arcBVs[highArc]);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(endRow);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            totalHeat = arcHeats[highArc];</b>
<b class="nc">&nbsp;            bvText.append(&quot;Total Heat: &quot; + totalHeat);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(endRow);</b>
<b class="nc">&nbsp;            weaponBV += arcBVs[highArc];</b>
<b class="nc">&nbsp;            arcBVs[highArc] = 0.0;</b>
<b class="nc">&nbsp;            if (adjArcH &gt; Integer.MIN_VALUE) {</b>
<b class="nc">&nbsp;                bvText.append(startRow);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(</b>
<b class="nc">&nbsp;                        &quot;Adjacent High BV Arc (&quot; + getArcName(adjArcH) + &quot;) &quot; + arcBVs[adjArcH] + &quot;*&quot; + adjArcHMult);</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(&quot;+&quot; + (arcBVs[adjArcH] * adjArcHMult));</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(endRow);</b>
<b class="nc">&nbsp;                bvText.append(startRow);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                totalHeat += arcHeats[adjArcH];</b>
<b class="nc">&nbsp;                String over = &quot;&quot;;</b>
<b class="nc">&nbsp;                if (totalHeat &gt; aeroHeatEfficiency) {</b>
<b class="nc">&nbsp;                    over = &quot; (Greater than heat efficiency)&quot;;</b>
&nbsp;                }
<b class="nc">&nbsp;                bvText.append(&quot;Total Heat: &quot; + totalHeat + over);</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(endRow);</b>
<b class="nc">&nbsp;                weaponBV += adjArcHMult * arcBVs[adjArcH];</b>
<b class="nc">&nbsp;                arcBVs[adjArcH] = 0.0;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (adjArcL &gt; Integer.MIN_VALUE) {</b>
<b class="nc">&nbsp;                bvText.append(startRow);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(</b>
<b class="nc">&nbsp;                        &quot;Adjacent Low BV Arc (&quot; + getArcName(adjArcL) + &quot;) &quot; + arcBVs[adjArcL] + &quot;*&quot; + adjArcLMult);</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(&quot;+&quot; + (adjArcLMult * arcBVs[adjArcL]));</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(endRow);</b>
<b class="nc">&nbsp;                bvText.append(startRow);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                totalHeat += arcHeats[adjArcL];</b>
<b class="nc">&nbsp;                String over = &quot;&quot;;</b>
<b class="nc">&nbsp;                if (totalHeat &gt; aeroHeatEfficiency) {</b>
<b class="nc">&nbsp;                    over = &quot; (Greater than heat efficiency)&quot;;</b>
&nbsp;                }
<b class="nc">&nbsp;                bvText.append(&quot;Total Heat: &quot; + totalHeat + over);</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(endRow);</b>
<b class="nc">&nbsp;                weaponBV += adjArcLMult * arcBVs[adjArcL];</b>
<b class="nc">&nbsp;                arcBVs[adjArcL] = 0.0;</b>
&nbsp;            }
&nbsp;            // ok now we can cycle through the rest and add 25%
<b class="nc">&nbsp;            bvText.append(startRow);</b>
<b class="nc">&nbsp;            bvText.append(startColumn);</b>
<b class="nc">&nbsp;            bvText.append(&quot;Remaining Arcs&quot;);</b>
<b class="nc">&nbsp;            bvText.append(endColumn);</b>
<b class="nc">&nbsp;            bvText.append(endRow);</b>
<b class="nc">&nbsp;            for (int loc = 0; loc &lt; arcBVs.length; loc++) {</b>
<b class="nc">&nbsp;                if (arcBVs[loc] &lt;= 0) {</b>
<b class="nc">&nbsp;                    continue;</b>
&nbsp;                }
<b class="nc">&nbsp;                bvText.append(startRow);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(getArcName(loc) + &quot; &quot; + arcBVs[loc] + &quot;*0.25&quot;);</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(&quot;+&quot; + (0.25 * arcBVs[loc]));</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(endRow);</b>
<b class="nc">&nbsp;                weaponBV += (0.25 * arcBVs[loc]);</b>
&nbsp;            }
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        bvText.append(&quot;Total Weapons BV Adjusted For Heat:&quot;);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(weaponBV);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(endRow);</b>
&nbsp;
&nbsp;        // add offensive misc. equipment BV
<b class="nc">&nbsp;        double oEquipmentBV = 0;</b>
<b class="nc">&nbsp;        for (Mounted mounted : getMisc()) {</b>
<b class="nc">&nbsp;            MiscType mtype = (MiscType) mounted.getType();</b>
&nbsp;
&nbsp;            // don&#39;t count destroyed equipment
<b class="nc">&nbsp;            if (mounted.isDestroyed()) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
&nbsp;
<b class="nc">&nbsp;            if (mtype.hasFlag(MiscType.F_TARGCOMP)) {</b>
<b class="nc">&nbsp;                continue;</b>
&nbsp;            }
<b class="nc">&nbsp;            double bv = mtype.getBV(this);</b>
<b class="nc">&nbsp;            if (bv &gt; 0) {</b>
<b class="nc">&nbsp;                bvText.append(startRow);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
&nbsp;
<b class="nc">&nbsp;                bvText.append(mounted.getName());</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(startColumn);</b>
<b class="nc">&nbsp;                bvText.append(bv);</b>
<b class="nc">&nbsp;                bvText.append(endColumn);</b>
<b class="nc">&nbsp;                bvText.append(endRow);</b>
&nbsp;            }
<b class="nc">&nbsp;            oEquipmentBV += bv;</b>
<b class="nc">&nbsp;        }</b>
<b class="nc">&nbsp;        bvText.append(startRow);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(&quot;Total Misc Offensive Equipment BV: &quot;);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(oEquipmentBV);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(endRow);</b>
<b class="nc">&nbsp;        weaponBV += oEquipmentBV;</b>
&nbsp;
&nbsp;        // adjust
&nbsp;
&nbsp;        // adjust further for speed factor
<b class="nc">&nbsp;        double speedFactor = Math.pow(1 + (((double) getRunMP() - 5) / 10), 1.2);</b>
<b class="nc">&nbsp;        speedFactor = Math.round(speedFactor * 100) / 100.0;</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(startRow);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(&quot;Final Speed Factor: &quot;);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(speedFactor);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(endRow);</b>
&nbsp;
<b class="nc">&nbsp;        obv = weaponBV * speedFactor;</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(startRow);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(&quot;Weapons BV * Speed Factor &quot;);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(weaponBV);</b>
<b class="nc">&nbsp;        bvText.append(&quot; * &quot;);</b>
<b class="nc">&nbsp;        bvText.append(speedFactor);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(&quot; = &quot;);</b>
<b class="nc">&nbsp;        bvText.append(obv);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(endRow);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(startRow);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
&nbsp;
<b class="nc">&nbsp;        if (useGeometricMeanBV()) {</b>
<b class="nc">&nbsp;            bvText.append(&quot;2 * sqrt(Offensive BV * Defensive BV&quot;);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            bvText.append(&quot;Offensive BV + Defensive BV&quot;);</b>
&nbsp;        }
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
&nbsp;
&nbsp;        double finalBV;
<b class="nc">&nbsp;        if (useGeometricMeanBV()) {</b>
<b class="nc">&nbsp;            finalBV = 2 * Math.sqrt(obv * dbv);</b>
<b class="nc">&nbsp;            if (finalBV == 0) {</b>
<b class="nc">&nbsp;                finalBV = dbv + obv;</b>
&nbsp;            }
<b class="nc">&nbsp;            bvText.append(&quot;2 * sqrt(&quot;);</b>
<b class="nc">&nbsp;            bvText.append(obv);</b>
<b class="nc">&nbsp;            bvText.append(&quot; + &quot;);</b>
<b class="nc">&nbsp;            bvText.append(dbv);</b>
<b class="nc">&nbsp;            bvText.append(&quot;)&quot;);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            finalBV = dbv + obv;</b>
<b class="nc">&nbsp;            bvText.append(dbv);</b>
<b class="nc">&nbsp;            bvText.append(&quot; + &quot;);</b>
<b class="nc">&nbsp;            bvText.append(obv);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(&quot; = &quot;);</b>
<b class="nc">&nbsp;        bvText.append(finalBV);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(endRow);</b>
&nbsp;
<b class="nc">&nbsp;        finalBV = Math.round(finalBV);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(startRow);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(&quot;-------------&quot;);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(endRow);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(startRow);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(&quot;Final BV&quot;);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(startColumn);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(finalBV);</b>
<b class="nc">&nbsp;        bvText.append(endColumn);</b>
<b class="nc">&nbsp;        bvText.append(endRow);</b>
&nbsp;
<b class="nc">&nbsp;        bvText.append(endTable);</b>
<b class="nc">&nbsp;        bvText.append(&quot;&lt;/BODY&gt;&lt;/HTML&gt;&quot;);</b>
&nbsp;
&nbsp;        // we get extra bv from some stuff
<b class="nc">&nbsp;        double xbv = 0.0;</b>
&nbsp;
&nbsp;        // extra from c3 networks. a valid network requires at least 2 members
&nbsp;        // some hackery and magic numbers here. could be better
&nbsp;        // also, each &#39;has&#39; loops through all equipment. inefficient to do it 3
&nbsp;        // times
<b class="nc">&nbsp;        if (!ignoreC3 &amp;&amp; (game != null)) {</b>
<b class="nc">&nbsp;            xbv += getExtraC3BV((int) Math.round(finalBV));</b>
&nbsp;        }
<b class="nc">&nbsp;        finalBV += xbv;</b>
&nbsp;
&nbsp;        // and then factor in pilot
<b class="nc">&nbsp;        double pilotFactor = 1;</b>
<b class="nc">&nbsp;        if (!ignorePilot) {</b>
<b class="nc">&nbsp;            pilotFactor = getCrew().getBVSkillMultiplier(game);</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        int retVal = (int) Math.round((finalBV) * pilotFactor);</b>
&nbsp;
<b class="nc">&nbsp;        return retVal;</b>
&nbsp;
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * need to check bay location before loading ammo
&nbsp;     */
&nbsp;    @Override
&nbsp;    public boolean loadWeapon(Mounted mounted, Mounted mountedAmmo) {
<b class="nc">&nbsp;        boolean success = false;</b>
<b class="nc">&nbsp;        WeaponType wtype = (WeaponType) mounted.getType();</b>
<b class="nc">&nbsp;        AmmoType atype = (AmmoType) mountedAmmo.getType();</b>
&nbsp;
<b class="nc">&nbsp;        if (mounted.getLocation() != mountedAmmo.getLocation()) {</b>
<b class="nc">&nbsp;            return success;</b>
&nbsp;        }
&nbsp;
&nbsp;        // for large craft, ammo must be in the same bay
<b class="nc">&nbsp;        Mounted bay = whichBay(getEquipmentNum(mounted));</b>
<b class="nc">&nbsp;        if ((bay != null) &amp;&amp; !bay.ammoInBay(getEquipmentNum(mountedAmmo))) {</b>
<b class="nc">&nbsp;            return success;</b>
&nbsp;        }
&nbsp;
<b class="nc">&nbsp;        if (mountedAmmo.isAmmoUsable() &amp;&amp; !wtype.hasFlag(WeaponType.F_ONESHOT)</b>
<b class="nc">&nbsp;                &amp;&amp; (atype.getAmmoType() == wtype.getAmmoType()) &amp;&amp; (atype.getRackSize() == wtype.getRackSize())) {</b>
<b class="nc">&nbsp;            mounted.setLinked(mountedAmmo);</b>
<b class="nc">&nbsp;            success = true;</b>
&nbsp;        }
<b class="nc">&nbsp;        return success;</b>
&nbsp;    }
&nbsp;
&nbsp;    /*
&nbsp;     * (non-Javadoc)
&nbsp;     *
&nbsp;     * @see megamek.common.Entity#getIniBonus()
&nbsp;     */
&nbsp;    @Override
&nbsp;    public int getHQIniBonus() {
&nbsp;        // large craft are considered to have &gt; 7 tons comm equipment
&nbsp;        // hence they get +2 ini bonus as a mobile hq
<b class="nc">&nbsp;        return 2;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * find the adjacent firing arc on this vessel clockwise
&nbsp;     */
&nbsp;    public int getAdjacentArcCW(int arc) {
<b class="nc">&nbsp;        switch (arc) {</b>
&nbsp;        case Compute.ARC_NOSE:
<b class="nc">&nbsp;            if (isSpheroid()) {</b>
<b class="nc">&nbsp;                return Compute.ARC_RIGHTSIDE_SPHERE;</b>
&nbsp;            }
<b class="nc">&nbsp;            return Compute.ARC_RWING;</b>
&nbsp;        case Compute.ARC_LWING:
<b class="nc">&nbsp;            return Compute.ARC_NOSE;</b>
&nbsp;        case Compute.ARC_RWING:
<b class="nc">&nbsp;            return Compute.ARC_RWINGA;</b>
&nbsp;        case Compute.ARC_LWINGA:
<b class="nc">&nbsp;            return Compute.ARC_LWING;</b>
&nbsp;        case Compute.ARC_RWINGA:
<b class="nc">&nbsp;            return Compute.ARC_AFT;</b>
&nbsp;        case Compute.ARC_LEFTSIDE_SPHERE:
<b class="nc">&nbsp;            return Compute.ARC_NOSE;</b>
&nbsp;        case Compute.ARC_RIGHTSIDE_SPHERE:
<b class="nc">&nbsp;            return Compute.ARC_RIGHTSIDEA_SPHERE;</b>
&nbsp;        case Compute.ARC_LEFTSIDEA_SPHERE:
<b class="nc">&nbsp;            return Compute.ARC_LEFTSIDE_SPHERE;</b>
&nbsp;        case Compute.ARC_RIGHTSIDEA_SPHERE:
<b class="nc">&nbsp;            return Compute.ARC_AFT;</b>
&nbsp;        case Compute.ARC_AFT:
<b class="nc">&nbsp;            if (isSpheroid()) {</b>
<b class="nc">&nbsp;                return Compute.ARC_LEFTSIDEA_SPHERE;</b>
&nbsp;            }
<b class="nc">&nbsp;            return Compute.ARC_LWINGA;</b>
&nbsp;        default:
<b class="nc">&nbsp;            return Integer.MIN_VALUE;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * find the adjacent firing arc on this vessel counter-clockwise
&nbsp;     */
&nbsp;    public int getAdjacentArcCCW(int arc) {
<b class="nc">&nbsp;        switch (arc) {</b>
&nbsp;        case Compute.ARC_NOSE:
<b class="nc">&nbsp;            if (isSpheroid()) {</b>
<b class="nc">&nbsp;                return Compute.ARC_LEFTSIDE_SPHERE;</b>
&nbsp;            }
<b class="nc">&nbsp;            return Compute.ARC_LWING;</b>
&nbsp;        case Compute.ARC_LWING:
<b class="nc">&nbsp;            return Compute.ARC_LWINGA;</b>
&nbsp;        case Compute.ARC_RWING:
<b class="nc">&nbsp;            return Compute.ARC_NOSE;</b>
&nbsp;        case Compute.ARC_LWINGA:
<b class="nc">&nbsp;            return Compute.ARC_AFT;</b>
&nbsp;        case Compute.ARC_RWINGA:
<b class="nc">&nbsp;            return Compute.ARC_RWING;</b>
&nbsp;        case Compute.ARC_LEFTSIDE_SPHERE:
<b class="nc">&nbsp;            return Compute.ARC_LEFTSIDEA_SPHERE;</b>
&nbsp;        case Compute.ARC_RIGHTSIDE_SPHERE:
<b class="nc">&nbsp;            return Compute.ARC_NOSE;</b>
&nbsp;        case Compute.ARC_LEFTSIDEA_SPHERE:
<b class="nc">&nbsp;            return Compute.ARC_AFT;</b>
&nbsp;        case Compute.ARC_RIGHTSIDEA_SPHERE:
<b class="nc">&nbsp;            return Compute.ARC_RWING;</b>
&nbsp;        case Compute.ARC_AFT:
<b class="nc">&nbsp;            if (isSpheroid()) {</b>
<b class="nc">&nbsp;                return Compute.ARC_RIGHTSIDEA_SPHERE;</b>
&nbsp;            }
<b class="nc">&nbsp;            return Compute.ARC_RWINGA;</b>
&nbsp;        default:
<b class="nc">&nbsp;            return Integer.MIN_VALUE;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * find the adjacent firing arc location on this vessel clockwise
&nbsp;     */
&nbsp;    public int getAdjacentLocCW(int loc) {
<b class="nc">&nbsp;        switch (loc) {</b>
&nbsp;        case LOC_NOSE:
<b class="nc">&nbsp;            return LOC_RWING;</b>
&nbsp;        case LOC_LWING:
<b class="nc">&nbsp;            return LOC_NOSE;</b>
&nbsp;        case LOC_RWING:
<b class="nc">&nbsp;            return (LOC_RWING + 3);</b>
&nbsp;        case LOC_AFT:
<b class="nc">&nbsp;            return (LOC_LWING + 3);</b>
&nbsp;        case 4:
<b class="nc">&nbsp;            return LOC_LWING;</b>
&nbsp;        case 5:
<b class="nc">&nbsp;            return LOC_AFT;</b>
&nbsp;        default:
<b class="nc">&nbsp;            return Integer.MIN_VALUE;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * find the adjacent firing arc on this vessel counter-clockwise
&nbsp;     */
&nbsp;    public int getAdjacentLocCCW(int loc) {
<b class="nc">&nbsp;        switch (loc) {</b>
&nbsp;        case LOC_NOSE:
<b class="nc">&nbsp;            return LOC_LWING;</b>
&nbsp;        case LOC_LWING:
<b class="nc">&nbsp;            return (LOC_LWING + 3);</b>
&nbsp;        case LOC_RWING:
<b class="nc">&nbsp;            return LOC_NOSE;</b>
&nbsp;        case LOC_AFT:
<b class="nc">&nbsp;            return (LOC_RWING + 3);</b>
&nbsp;        case 4:
<b class="nc">&nbsp;            return LOC_AFT;</b>
&nbsp;        case 5:
<b class="nc">&nbsp;            return LOC_RWING;</b>
&nbsp;        default:
<b class="nc">&nbsp;            return Integer.MIN_VALUE;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * find the adjacent firing arc location on this vessel clockwise
&nbsp;     */
&nbsp;    public int getOppositeLoc(int loc) {
<b class="nc">&nbsp;        switch (loc) {</b>
&nbsp;        case LOC_NOSE:
<b class="nc">&nbsp;            return LOC_AFT;</b>
&nbsp;        case LOC_LWING:
<b class="nc">&nbsp;            return (LOC_RWING + 3);</b>
&nbsp;        case LOC_RWING:
<b class="nc">&nbsp;            return (LOC_LWING + 3);</b>
&nbsp;        case LOC_AFT:
<b class="nc">&nbsp;            return LOC_NOSE;</b>
&nbsp;        case 4:
<b class="nc">&nbsp;            return LOC_RWING;</b>
&nbsp;        case 5:
<b class="nc">&nbsp;            return LOC_LWING;</b>
&nbsp;        default:
<b class="nc">&nbsp;            return Integer.MIN_VALUE;</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * All military dropships automatically have ECM if in space
&nbsp;     */
&nbsp;    @Override
&nbsp;    public boolean hasActiveECM() {
<b class="nc">&nbsp;        if (!game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ECM)</b>
<b class="nc">&nbsp;                || !game.getBoard().inSpace()) {</b>
<b class="nc">&nbsp;            return super.hasActiveECM();</b>
&nbsp;        }
<b class="nc">&nbsp;        return getECMRange() &gt; Entity.NONE;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * What&#39;s the range of the ECM equipment?
&nbsp;     *
&nbsp;     * @return the &lt;code&gt;int&lt;/code&gt; range of this unit&#39;s ECM. This value will be
&nbsp;     *         &lt;code&gt;Entity.NONE&lt;/code&gt; if no ECM is active.
&nbsp;     */
&nbsp;    @Override
&nbsp;    public int getECMRange() {
<b class="nc">&nbsp;        if (!game.getOptions().booleanOption(OptionsConstants.ADVAERORULES_STRATOPS_ECM)</b>
<b class="nc">&nbsp;                || !game.getBoard().inSpace()) {</b>
<b class="nc">&nbsp;            return super.getECMRange();</b>
&nbsp;        }
<b class="nc">&nbsp;        if (!isMilitary()) {</b>
<b class="nc">&nbsp;            return Entity.NONE;</b>
&nbsp;        }
<b class="nc">&nbsp;        int range = 1;</b>
&nbsp;        // the range might be affected by sensor/FCS damage
<b class="nc">&nbsp;        range = range - getFCSHits() - getSensorHits();</b>
<b class="nc">&nbsp;        return range;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Return the height of this dropship above the terrain.
&nbsp;     */
&nbsp;    @Override
&nbsp;    public int height() {
<b class="nc">&nbsp;        if (isAirborne()) {</b>
<b class="nc">&nbsp;            return 0;</b>
&nbsp;        }
<b class="nc">&nbsp;        if (isSpheroid()) {</b>
<b class="nc">&nbsp;            return 9;</b>
&nbsp;        }
<b class="nc">&nbsp;        return 4;</b>
&nbsp;    }
&nbsp;
&nbsp;    /*
&nbsp;     * (non-Javadoc)
&nbsp;     *
&nbsp;     * @see megamek.common.Entity#setPosition(megamek.common.Coords)
&nbsp;     */
&nbsp;    @Override
&nbsp;
&nbsp;    public void setPosition(Coords position) {
<b class="nc">&nbsp;        HashSet&lt;Coords&gt; oldPositions = getOccupiedCoords();</b>
<b class="nc">&nbsp;        super.setPosition(position, false);</b>
<b class="nc">&nbsp;        if ((getAltitude() == 0) &amp;&amp; (null != game) &amp;&amp; !game.getBoard().inSpace() &amp;&amp; (position != null)) {</b>
<b class="nc">&nbsp;            secondaryPositions.put(0, position);</b>
<b class="nc">&nbsp;            secondaryPositions.put(1, position.translated(getFacing()));</b>
<b class="nc">&nbsp;            secondaryPositions.put(2, position.translated((getFacing() + 1) % 6));</b>
<b class="nc">&nbsp;            secondaryPositions.put(3, position.translated((getFacing() + 2) % 6));</b>
<b class="nc">&nbsp;            secondaryPositions.put(4, position.translated((getFacing() + 3) % 6));</b>
<b class="nc">&nbsp;            secondaryPositions.put(5, position.translated((getFacing() + 4) % 6));</b>
<b class="nc">&nbsp;            secondaryPositions.put(6, position.translated((getFacing() + 5) % 6));</b>
&nbsp;        }
<b class="nc">&nbsp;        if (game != null) {</b>
<b class="nc">&nbsp;            game.updateEntityPositionLookup(this, oldPositions);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public void setAltitude(int altitude) {
<b class="nc">&nbsp;        super.setAltitude(altitude);</b>
<b class="nc">&nbsp;        if ((getAltitude() == 0) &amp;&amp; (game != null) &amp;&amp; !game.getBoard().inSpace() &amp;&amp; (getPosition() != null)) {</b>
<b class="nc">&nbsp;            secondaryPositions.put(0, getPosition());</b>
<b class="nc">&nbsp;            secondaryPositions.put(1, getPosition().translated(getFacing()));</b>
<b class="nc">&nbsp;            secondaryPositions.put(2, getPosition().translated((getFacing() + 1) % 6));</b>
<b class="nc">&nbsp;            secondaryPositions.put(3, getPosition().translated((getFacing() + 2) % 6));</b>
<b class="nc">&nbsp;            secondaryPositions.put(4, getPosition().translated((getFacing() + 3) % 6));</b>
<b class="nc">&nbsp;            secondaryPositions.put(5, getPosition().translated((getFacing() + 4) % 6));</b>
<b class="nc">&nbsp;            secondaryPositions.put(6, getPosition().translated((getFacing() + 5) % 6));</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /*
&nbsp;     * (non-Javadoc)
&nbsp;     *
&nbsp;     * @see megamek.common.Entity#setFacing(int)
&nbsp;     */
&nbsp;    @Override
&nbsp;    public void setFacing(int facing) {
<b class="nc">&nbsp;        super.setFacing(facing);</b>
<b class="nc">&nbsp;        setPosition(getPosition());</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public int getLandingLength() {
<b class="nc">&nbsp;        return 15;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String hasRoomForVerticalLanding() {
&nbsp;        // dropships can land just about anywhere they want, unless it is off
&nbsp;        // the map
<b class="nc">&nbsp;        Vector&lt;Coords&gt; positions = new Vector&lt;Coords&gt;();</b>
<b class="nc">&nbsp;        positions.add(getPosition());</b>
<b class="nc">&nbsp;        for (int i = 0; i &lt; 6; i++) {</b>
<b class="nc">&nbsp;            positions.add(getPosition().translated(i));</b>
&nbsp;        }
<b class="nc">&nbsp;        for (Coords pos : positions) {</b>
<b class="nc">&nbsp;            IHex hex = game.getBoard().getHex(getPosition());</b>
<b class="nc">&nbsp;            hex = game.getBoard().getHex(pos);</b>
&nbsp;            // if the hex is null, then we are offboard. Don&#39;t let units
&nbsp;            // land offboard.
<b class="nc">&nbsp;            if (null == hex) {</b>
<b class="nc">&nbsp;                return &quot;landing area not on the map&quot;;</b>
&nbsp;            }
<b class="nc">&nbsp;            if (hex.containsTerrain(Terrains.WATER)) {</b>
<b class="nc">&nbsp;                return &quot;cannot land on water&quot;;</b>
&nbsp;            }
<b class="nc">&nbsp;        }</b>
&nbsp;        // TODO: what about other terrain (like jungles)?
<b class="nc">&nbsp;        return null;</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public boolean usesWeaponBays() {
<b class="nc">&nbsp;        if (null == game) {</b>
<b class="nc">&nbsp;            return true;</b>
&nbsp;        }
<b class="nc">&nbsp;        return (isAirborne() || isSpaceborne() || game.getPhase() == IGame.Phase.PHASE_LOUNGE);</b>
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public HitData rollHitLocation(int table, int side) {
<b class="nc">&nbsp;        if ((table == ToHitData.HIT_KICK) || (table == ToHitData.HIT_PUNCH)) {</b>
&nbsp;            // we don&#39;t really have any good rules on how to apply this,
&nbsp;            // I have a rules question posted about it:
&nbsp;            // http://bg.battletech.com/forums/index.php/topic,24077.new.html#new
&nbsp;            // in the meantime lets make up our own hit table (fun!)
<b class="nc">&nbsp;            int roll = Compute.d6(2);</b>
<b class="nc">&nbsp;            if (side == ToHitData.SIDE_LEFT) {</b>
&nbsp;                // normal left-side hits
<b class="nc">&nbsp;                switch (roll) {</b>
&nbsp;                case 2:
<b class="nc">&nbsp;                    setPotCrit(CRIT_GEAR);</b>
<b class="nc">&nbsp;                    return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</b>
&nbsp;                case 3:
<b class="nc">&nbsp;                    setPotCrit(CRIT_LIFE_SUPPORT);</b>
<b class="nc">&nbsp;                    return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</b>
&nbsp;                case 4:
<b class="nc">&nbsp;                    setPotCrit(CRIT_DOCK_COLLAR);</b>
<b class="nc">&nbsp;                    return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</b>
&nbsp;                case 5:
<b class="nc">&nbsp;                    setPotCrit(CRIT_LEFT_THRUSTER);</b>
<b class="nc">&nbsp;                    return new HitData(LOC_LWING, false, HitData.EFFECT_NONE);</b>
&nbsp;                case 6:
<b class="nc">&nbsp;                    setPotCrit(CRIT_CARGO);</b>
<b class="nc">&nbsp;                    return new HitData(LOC_LWING, false, HitData.EFFECT_NONE);</b>
&nbsp;                case 7:
<b class="nc">&nbsp;                    setPotCrit(CRIT_WEAPON);</b>
<b class="nc">&nbsp;                    return new HitData(LOC_LWING, false, HitData.EFFECT_NONE);</b>
&nbsp;                case 8:
<b class="nc">&nbsp;                    setPotCrit(CRIT_DOOR);</b>
<b class="nc">&nbsp;                    return new HitData(LOC_LWING, false, HitData.EFFECT_NONE);</b>
&nbsp;                case 9:
<b class="nc">&nbsp;                    setPotCrit(CRIT_LEFT_THRUSTER);</b>
<b class="nc">&nbsp;                    return new HitData(LOC_LWING, false, HitData.EFFECT_NONE);</b>
&nbsp;                case 10:
<b class="nc">&nbsp;                    setPotCrit(CRIT_AVIONICS);</b>
<b class="nc">&nbsp;                    return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</b>
&nbsp;                case 11:
<b class="nc">&nbsp;                    setPotCrit(CRIT_ENGINE);</b>
<b class="nc">&nbsp;                    return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</b>
&nbsp;                case 12:
<b class="nc">&nbsp;                    setPotCrit(CRIT_WEAPON);</b>
<b class="nc">&nbsp;                    return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</b>
&nbsp;                }
&nbsp;            } else {
<b class="nc">&nbsp;                switch (roll) {</b>
&nbsp;                case 2:
<b class="nc">&nbsp;                    setPotCrit(CRIT_GEAR);</b>
<b class="nc">&nbsp;                    return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</b>
&nbsp;                case 3:
<b class="nc">&nbsp;                    setPotCrit(CRIT_LIFE_SUPPORT);</b>
<b class="nc">&nbsp;                    return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</b>
&nbsp;                case 4:
<b class="nc">&nbsp;                    setPotCrit(CRIT_DOCK_COLLAR);</b>
<b class="nc">&nbsp;                    return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</b>
&nbsp;                case 5:
<b class="nc">&nbsp;                    setPotCrit(CRIT_RIGHT_THRUSTER);</b>
<b class="nc">&nbsp;                    return new HitData(LOC_RWING, false, HitData.EFFECT_NONE);</b>
&nbsp;                case 6:
<b class="nc">&nbsp;                    setPotCrit(CRIT_CARGO);</b>
<b class="nc">&nbsp;                    return new HitData(LOC_RWING, false, HitData.EFFECT_NONE);</b>
&nbsp;                case 7:
<b class="nc">&nbsp;                    setPotCrit(CRIT_WEAPON);</b>
<b class="nc">&nbsp;                    return new HitData(LOC_RWING, false, HitData.EFFECT_NONE);</b>
&nbsp;                case 8:
<b class="nc">&nbsp;                    setPotCrit(CRIT_DOOR);</b>
<b class="nc">&nbsp;                    return new HitData(LOC_RWING, false, HitData.EFFECT_NONE);</b>
&nbsp;                case 9:
<b class="nc">&nbsp;                    setPotCrit(CRIT_RIGHT_THRUSTER);</b>
<b class="nc">&nbsp;                    return new HitData(LOC_RWING, false, HitData.EFFECT_NONE);</b>
&nbsp;                case 10:
<b class="nc">&nbsp;                    setPotCrit(CRIT_AVIONICS);</b>
<b class="nc">&nbsp;                    return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</b>
&nbsp;                case 11:
<b class="nc">&nbsp;                    setPotCrit(CRIT_ENGINE);</b>
<b class="nc">&nbsp;                    return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</b>
&nbsp;                case 12:
<b class="nc">&nbsp;                    setPotCrit(CRIT_WEAPON);</b>
<b class="nc">&nbsp;                    return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</b>
&nbsp;                }
&nbsp;            }
<b class="nc">&nbsp;            return new HitData(LOC_AFT, false, HitData.EFFECT_NONE);</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return super.rollHitLocation(table, side);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public String getLocationAbbr(int loc) {
<b class="nc">&nbsp;        if (loc == Entity.LOC_NONE) {</b>
<b class="nc">&nbsp;            return &quot;System Wide&quot;;</b>
&nbsp;        } else {
<b class="nc">&nbsp;            return super.getLocationAbbr(loc);</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    @Override
&nbsp;    public long getEntityType() {
<b class="nc">&nbsp;        return Entity.ETYPE_AERO | Entity.ETYPE_SMALL_CRAFT | Entity.ETYPE_DROPSHIP;</b>
&nbsp;    }
&nbsp;    
&nbsp;    @Override
&nbsp;    public void addBattleForceSpecialAbilities(Map&lt;BattleForceSPA,Integer&gt; specialAbilities) {
<b class="nc">&nbsp;        super.addBattleForceSpecialAbilities(specialAbilities);</b>
<b class="nc">&nbsp;        if (getNCrew() &gt;= 30) {</b>
<b class="nc">&nbsp;            specialAbilities.put(BattleForceSPA.CRW, (int)Math.round(getNCrew() / 60.0));</b>
&nbsp;        }
&nbsp;    }
&nbsp;    
&nbsp;    @Override
&nbsp;    public boolean canChangeSecondaryFacing() {
&nbsp;        // flying dropships can execute the &quot;ECHO&quot; maneuver (stratops 113), aka a torso twist, 
&nbsp;        // if they have the MP for it
<b class="nc">&nbsp;        return isAirborne() &amp;&amp; !isEvading() &amp;&amp; (mpUsed &lt;= getRunMP() - 2);</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Can this dropship &quot;torso twist&quot; in the given direction?
&nbsp;     */
&nbsp;    @Override
&nbsp;    public boolean isValidSecondaryFacing(int dir) {
<b class="nc">&nbsp;        int rotate = dir - getFacing();</b>
<b class="nc">&nbsp;        if (canChangeSecondaryFacing()) {</b>
<b class="nc">&nbsp;            return (rotate == 0) || (rotate == 1) || (rotate == -1)</b>
&nbsp;                    || (rotate == -5) || (rotate == 5);
&nbsp;        }
<b class="nc">&nbsp;        return rotate == 0;</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Return the nearest valid direction to &quot;torso twist&quot; in
&nbsp;     */
&nbsp;    @Override
&nbsp;    public int clipSecondaryFacing(int dir) {
<b class="nc">&nbsp;        if (isValidSecondaryFacing(dir)) {</b>
<b class="nc">&nbsp;            return dir;</b>
&nbsp;        }
&nbsp;        
&nbsp;        // can&#39;t twist without enough MP
<b class="nc">&nbsp;        if (!canChangeSecondaryFacing()) {</b>
<b class="nc">&nbsp;            return getFacing();</b>
&nbsp;        }
&nbsp;        
&nbsp;        // otherwise, twist once in the appropriate direction
<b class="nc">&nbsp;        final int rotate = (dir + (6 - getFacing())) % 6;</b>
&nbsp;        
<b class="nc">&nbsp;        return rotate &gt;= 3 ? (getFacing() + 5) % 6 : (getFacing() + 1) % 6;</b>
&nbsp;    }
&nbsp;    
&nbsp;    @Override
&nbsp;    public void newRound(int roundNumber) {
<b class="nc">&nbsp;        super.newRound(roundNumber);</b>
&nbsp;        
<b class="nc">&nbsp;        if (getGame().useVectorMove()) {</b>
<b class="nc">&nbsp;            setFacing(getSecondaryFacing());</b>
&nbsp;        }
&nbsp;        
<b class="nc">&nbsp;        setSecondaryFacing(getFacing());</b>
&nbsp;    }
&nbsp;    
&nbsp;    /**
&nbsp;     * Utility function that handles situations where a facing change
&nbsp;     * has some kind of permanent effect on the entity.
&nbsp;     */
&nbsp;    @Override
&nbsp;    public void postProcessFacingChange() {
<b class="nc">&nbsp;        mpUsed += 2;</b>
&nbsp;    }
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-04-13 20:57</div>
</div>
</body>
</html>
